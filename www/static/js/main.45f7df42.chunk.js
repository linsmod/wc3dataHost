(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{133:function(e,t,i){e.exports=i.p+"static/media/ArchiveLoader.2fdd1a3c.wasm"},134:function(e,t,i){(function(t,s,a){var r=(()=>{var e="undefined"!=typeof document?document.currentScript&&document.currentScript.src:void 0;return e||(e=t),function(t={}){var r,n,o,l,h,c=t,d=new Promise((e,t)=>{r=e,n=t}),u="object"==typeof window,m="function"==typeof importScripts,f="object"==typeof s&&"object"==typeof s.versions&&"string"==typeof s.versions.node,p=Object.assign({},c),g="./this.program",w=(e,t)=>{throw t},v="";if(f){var y=i(189),b=i(190);v=a+"/",o=((e,t)=>(e=j(e)?new URL(e):b.normalize(e),y.readFileSync(e,t?void 0:"utf8"))),h=(e=>{var t=o(e,!0);return t.buffer||(t=new Uint8Array(t)),t}),l=((e,t,i,s=!0)=>{e=j(e)?new URL(e):b.normalize(e),y.readFile(e,s?void 0:"utf8",(e,a)=>{e?i(e):t(s?a.buffer:a)})}),!c.thisProgram&&s.argv.length>1&&(g=s.argv[1].replace(/\\/g,"/")),s.argv.slice(2),w=((e,t)=>{throw s.exitCode=e,t})}else(u||m)&&(m?v=self.location.href:"undefined"!=typeof document&&document.currentScript&&(v=document.currentScript.src),e&&(v=e),v=v.startsWith("blob:")?"":v.substr(0,v.replace(/[?#].*/,"").lastIndexOf("/")+1),o=(e=>{var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(null),t.responseText}),m&&(h=(e=>{var t=new XMLHttpRequest;return t.open("GET",e,!1),t.responseType="arraybuffer",t.send(null),new Uint8Array(t.response)})),l=((e,t,i)=>{if(j(e)){var s=new XMLHttpRequest;return s.open("GET",e,!0),s.responseType="arraybuffer",s.onload=(()=>{200==s.status||0==s.status&&s.response?t(s.response):i()}),s.onerror=i,void s.send(null)}fetch(e,{credentials:"same-origin"}).then(e=>e.ok?e.arrayBuffer():Promise.reject(new Error(e.status+" : "+e.url))).then(t,i)}));var A,E,x=c.print||console.log.bind(console),T=c.printErr||console.error.bind(console);Object.assign(c,p),p=null,c.arguments&&c.arguments,c.thisProgram&&(g=c.thisProgram),c.quit&&(w=c.quit),c.wasmBinary&&(A=c.wasmBinary);var S,_,I,R=!1;function C(){var e=E.buffer;c.HEAP8=S=new Int8Array(e),c.HEAP16=new Int16Array(e),c.HEAPU8=_=new Uint8Array(e),c.HEAPU16=new Uint16Array(e),c.HEAP32=new Int32Array(e),c.HEAPU32=I=new Uint32Array(e),c.HEAPF32=new Float32Array(e),c.HEAPF64=new Float64Array(e)}var B=[],F=[],L=[];function D(e){L.unshift(e)}var M=0,U=null,P=null;function k(e){c.onAbort&&c.onAbort(e),T(e="Aborted("+e+")"),R=!0,1,e+=". Build with -sASSERTIONS for more info.";var t=new WebAssembly.RuntimeError(e);throw n(t),t}var N,O=e=>e.startsWith("data:application/octet-stream;base64,"),j=e=>e.startsWith("file://");function V(){var e,t="ArchiveLoader.wasm";return O(t)?t:(e=t,c.locateFile?c.locateFile(e,v):v+e)}function G(e){if(e==N&&A)return new Uint8Array(A);if(h)return h(e);throw"both async and sync fetching of the wasm failed"}function H(e,t,i){return function(e){return A?Promise.resolve().then(()=>G(e)):new Promise((t,i)=>{l(e,e=>t(new Uint8Array(e)),s=>{try{t(G(e))}catch(a){i(a)}})})}(e).then(e=>WebAssembly.instantiate(e,t)).then(i,e=>{T(`failed to asynchronously prepare wasm: ${e}`),k(e)})}function K(e){this.name="ExitStatus",this.message=`Program terminated with exit(${e})`,this.status=e}var q=e=>{for(;e.length>0;)e.shift()(c)},W=c.noExitRuntime||!0,X=e=>me(e),z=()=>fe(),Y="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0,J=(e,t,i)=>{for(var s=t+i,a=t;e[a]&&!(a>=s);)++a;if(a-t>16&&e.buffer&&Y)return Y.decode(e.subarray(t,a));for(var r="";t<a;){var n=e[t++];if(128&n){var o=63&e[t++];if(192!=(224&n)){var l=63&e[t++];if((n=224==(240&n)?(15&n)<<12|o<<6|l:(7&n)<<18|o<<12|l<<6|63&e[t++])<65536)r+=String.fromCharCode(n);else{var h=n-65536;r+=String.fromCharCode(55296|h>>10,56320|1023&h)}}else r+=String.fromCharCode((31&n)<<6|o)}else r+=String.fromCharCode(n)}return r},Z=(e,t)=>e?J(_,e,t):"";class ${constructor(e){this.excPtr=e,this.ptr=e-24}set_type(e){I[this.ptr+4>>2]=e}get_type(){return I[this.ptr+4>>2]}set_destructor(e){I[this.ptr+8>>2]=e}get_destructor(){return I[this.ptr+8>>2]}set_caught(e){e=e?1:0,S[this.ptr+12]=e}get_caught(){return 0!=S[this.ptr+12]}set_rethrown(e){e=e?1:0,S[this.ptr+13]=e}get_rethrown(){return 0!=S[this.ptr+13]}init(e,t){this.set_adjusted_ptr(0),this.set_type(e),this.set_destructor(t)}set_adjusted_ptr(e){I[this.ptr+16>>2]=e}get_adjusted_ptr(){return I[this.ptr+16>>2]}get_exception_ptr(){if(pe(this.get_type()))return I[this.excPtr>>2];var e=this.get_adjusted_ptr();return 0!==e?e:this.excPtr}}var Q=e=>{var t=(e-E.buffer.byteLength+65535)/65536;try{return E.grow(t),C(),1}catch(i){}},ee={},te=()=>{if(!te.strings){var e={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:("object"==typeof navigator&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:g||"./this.program"};for(var t in ee)void 0===ee[t]?delete e[t]:e[t]=ee[t];var i=[];for(var t in e)i.push(`${t}=${e[t]}`);te.strings=i}return te.strings},ie=e=>{e,W||(c.onExit&&c.onExit(e),R=!0),w(e,new K(e))},se=(e,t)=>t+2097152>>>0<4194305-!!e?(e>>>0)+4294967296*t:NaN;var ae,re,ne=[null,[],[]],oe=(e,t)=>{var i=ne[e];0===t||10===t?((1===e?x:T)(J(i,0)),i.length=0):i.push(t)},le=[],he=e=>{var t=le[e];return t||(e>=le.length&&(le.length=e+1),le[e]=t=ae.get(e)),t},ce={d:(e,t,i,s)=>{k(`Assertion failed: ${Z(e)}, at: `+[t?Z(t):"unknown filename",i,s?Z(s):"unknown function"])},k:(e,t,i)=>{throw new $(e).init(t,i),0,e},o:()=>{k("")},u:(e,t,i)=>_.copyWithin(e,t,t+i),p:()=>{throw 1/0},q:e=>{var t=_.length;if((e>>>=0)>2147483648)return!1;for(var i=(e,t)=>e+(t-e%t)%t,s=1;s<=4;s*=2){var a=t*(1+.2/s);a=Math.min(a,e+100663296);var r=Math.min(2147483648,i(Math.max(e,a),65536));if(Q(r))return!0}return!1},s:(e,t)=>{var i=0;return te().forEach((s,a)=>{var r=t+i;I[e+4*a>>2]=r,((e,t)=>{for(var i=0;i<e.length;++i)S[t++]=e.charCodeAt(i);S[t]=0})(s,r),i+=s.length+1}),0},t:(e,t)=>{var i=te();I[e>>2]=i.length;var s=0;return i.forEach(e=>s+=e.length+1),I[t>>2]=s,0},v:(e,t)=>{e,ie(e)},r:e=>52,l:function(e,t,i,s,a){return se(t,i),70},j:(e,t,i,s)=>{for(var a=0,r=0;r<i;r++){var n=I[t>>2],o=I[t+4>>2];t+=8;for(var l=0;l<o;l++)oe(e,_[n+l]);a+=o}return I[s>>2]=a,0},a:function(e,t){var i=z();try{return he(e)(t)}catch(s){if(X(i),s!==s+0)throw s;ue(1,0)}},b:function(e,t,i){var s=z();try{return he(e)(t,i)}catch(a){if(X(s),a!==a+0)throw a;ue(1,0)}},e:function(e,t,i,s){var a=z();try{return he(e)(t,i,s)}catch(r){if(X(a),r!==r+0)throw r;ue(1,0)}},g:function(e,t,i,s,a){var r=z();try{return he(e)(t,i,s,a)}catch(n){if(X(r),n!==n+0)throw n;ue(1,0)}},c:function(e,t,i,s,a,r){var n=z();try{return he(e)(t,i,s,a,r)}catch(o){if(X(n),o!==o+0)throw o;ue(1,0)}},m:function(e,t){var i=z();try{return ge(e,t)}catch(s){if(X(i),s!==s+0)throw s;ue(1,0)}},f:function(e,t){var i=z();try{he(e)(t)}catch(s){if(X(i),s!==s+0)throw s;ue(1,0)}},w:function(e,t,i){var s=z();try{he(e)(t,i)}catch(a){if(X(s),a!==a+0)throw a;ue(1,0)}},i:function(e,t,i,s){var a=z();try{he(e)(t,i,s)}catch(r){if(X(a),r!==r+0)throw r;ue(1,0)}},n:function(e,t,i,s,a){var r=z();try{we(e,t,i,s,a)}catch(n){if(X(r),n!==n+0)throw n;ue(1,0)}},h:function(e,t){window.postResult(_.slice(e,e+t))}},de=function(){var e,t,i,s,a={a:ce};function r(e,t){var i;return de=e.exports,E=de.x,C(),ae=de.z,i=de.y,F.unshift(i),function(e){if(M--,c.monitorRunDependencies&&c.monitorRunDependencies(M),0==M&&(null!==U&&(clearInterval(U),U=null),P)){var t=P;P=null,t()}}(),de}if(M++,c.monitorRunDependencies&&c.monitorRunDependencies(M),c.instantiateWasm)try{return c.instantiateWasm(a,r)}catch(o){T(`Module.instantiateWasm callback failed with error: ${o}`),n(o)}return N||(N=V()),(e=A,t=N,i=a,s=function(e){r(e.instance)},e||"function"!=typeof WebAssembly.instantiateStreaming||O(t)||j(t)||f||"function"!=typeof fetch?H(t,i,s):fetch(t,{credentials:"same-origin"}).then(e=>WebAssembly.instantiateStreaming(e,i).then(s,function(e){return T(`wasm streaming compile failed: ${e}`),T("falling back to ArrayBuffer instantiation"),H(t,i,s)}))).catch(n),{}}(),ue=(c._malloc=(e=>(c._malloc=de.A)(e)),c._free=(e=>(c._free=de.B)(e)),c._openArchive=((e,t)=>(c._openArchive=de.C)(e,t)),c._hasFile=((e,t)=>(c._hasFile=de.D)(e,t)),c._loadFile=((e,t,i)=>(c._loadFile=de.E)(e,t,i)),c._loadImage=((e,t)=>(c._loadImage=de.F)(e,t)),c._loadJASS=(e=>(c._loadJASS=de.G)(e)),(e,t)=>(ue=de.H)(e,t)),me=e=>(me=de.I)(e),fe=()=>(fe=de.J)(),pe=e=>(pe=de.K)(e),ge=c.dynCall_ji=((e,t)=>(ge=c.dynCall_ji=de.L)(e,t)),we=c.dynCall_viji=((e,t,i,s,a)=>(we=c.dynCall_viji=de.M)(e,t,i,s,a));function ve(){function e(){re||(re=!0,c.calledRun=!0,R||(!0,q(F),r(c),c.onRuntimeInitialized&&c.onRuntimeInitialized(),function(){if(c.postRun)for("function"==typeof c.postRun&&(c.postRun=[c.postRun]);c.postRun.length;)D(c.postRun.shift());q(L)}()))}M>0||(!function(){if(c.preRun)for("function"==typeof c.preRun&&(c.preRun=[c.preRun]);c.preRun.length;)e=c.preRun.shift(),B.unshift(e);var e;q(B)}(),M>0||(c.setStatus?(c.setStatus("Running..."),setTimeout(function(){setTimeout(function(){c.setStatus("")},1),e()},1)):e()))}if(P=function e(){re||ve(),re||(P=e)},c.preInit)for("function"==typeof c.preInit&&(c.preInit=[c.preInit]);c.preInit.length>0;)c.preInit.pop()();return ve(),c.ready=new Promise(function(e,t){delete c.then,c.onAbort=function(e){t(e)},D(function(){e(c)})}),d}})();e.exports=r}).call(this,"/index.js",i(123),"/")},135:function(e,t,i){e.exports=function(){return new Worker(i.p+"604ee34ce8efa1c49074.worker.js")}},142:function(e,t,i){e.exports=i(249)},147:function(e,t,i){},171:function(e,t,i){},195:function(e,t,i){},196:function(e,t,i){},233:function(e,t,i){},234:function(e,t,i){},239:function(e,t,i){},241:function(e,t,i){},242:function(e,t,i){},247:function(e,t,i){},249:function(e,t,i){"use strict";i.r(t);var s=i(0),a=i.n(s),r=i(15),n=i.n(r),o=(i(147),i(148),i(23)),l=i(19),h=i(262),c=i(131),d=i(261),u=i(259),m=i(76),f=i(32),p=i(1),g=i.n(p);class w extends a.a.Component{render(){const{children:e,path:t,exact:i,strict:s,activeClassName:r,className:n,activeStyle:l,style:h,isActive:c,...d}=this.props,u=a.a.Children.only(e);return a.a.createElement(o.d,{path:t,exact:i,strict:s,children:e=>{let{location:t,match:i}=e;const s=!!(c?c(i,t):i);return a.a.cloneElement(u,{...d,className:[n,u.props.className,s?r:null].join(" ").trim(),style:s?{...h,...l}:h})}})}}w.contextTypes={router:g.a.shape({history:g.a.shape({push:g.a.func.isRequired,replace:g.a.func.isRequired,createHref:g.a.func.isRequired}).isRequired}).isRequired},w.defaultProps={exact:!1,strict:!1,activeClassName:"active"};function v(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return t.filter(e=>null!=e).reduce((e,t)=>null===e?t:function(){for(var i=arguments.length,s=new Array(i),a=0;a<i;a++)s[a]=arguments[a];e.apply(this,s),t.apply(this,s)},null)}i(250);var y=i(7),b=i.n(y);var A=i(22),E=i.n(A);i(171);class x extends a.a.Component{constructor(e,t){super(e,t),this.onGlobalKeyDown=(e=>{switch(e.which){case E.a.codes.f:e.ctrlKey&&(this.show(),e.preventDefault());break;case E.a.codes.f3:this.show(),e.shiftKey?this.findPrev():this.findNext(),this._input&&(this._input.focus(),this._input.select()),e.preventDefault()}}),this.hide=(()=>{this.setState({results:this.props.onSearch("",0)}),this.setState({show:!1})}),this.findNext=(()=>{this._input&&this.setState({results:this.props.onSearch(this._input.value,1)})}),this.findPrev=(()=>{this._input&&this.setState({results:this.props.onSearch(this._input.value,-1)})}),this.onKeyDown=(e=>{switch(e.which){case E.a.codes.esc:this.hide();break;case E.a.codes.enter:this.findNext()}}),this.onChange=(e=>{this.setState({results:this.props.onSearch(e.target.value,0)})}),this.state={results:null,show:!1}}componentDidMount(){document.addEventListener("keydown",this.onGlobalKeyDown)}componentWillUnmount(){document.removeEventListener("keydown",this.onGlobalKeyDown)}show(){this.setState({show:!0}),this._input&&(this._input.focus(),this._input.select())}componentDidUpdate(e,t){this.state.show&&!t.show&&this._input&&(this._input.select(),this._input.focus())}render(){const{show:e,results:t}=this.state,i=t&&t.count;return a.a.createElement("div",{className:b()("SearchBox",{"search-hidden":!e}),onKeyDown:this.onKeyDown},a.a.createElement("input",{type:"text",ref:e=>this._input=e,onChange:this.onChange}),!!t&&a.a.createElement("span",{className:"count"},t.pos+1+"/"+t.count),a.a.createElement("span",{className:"separator"}),a.a.createElement("button",{disabled:!i,onClick:this.findPrev,title:"Previous"},a.a.createElement(c.a,{glyph:"chevron-up"})),a.a.createElement("button",{disabled:!i,onClick:this.findNext,title:"Next"},a.a.createElement(c.a,{glyph:"chevron-down"})),a.a.createElement("button",{onClick:this.hide,title:"Close find bar"},a.a.createElement(c.a,{glyph:"remove"})))}}function T(e,t,i,s){var r;const n=Object.keys(e);return(r=class extends a.a.Component{constructor(e,t){super(e,t);const i={};n.forEach(e=>i[e]={}),this.state=i}setStateChecked(){this.unmounted||this.setState(...arguments)}updateRequests(t,i){n.forEach(s=>{const a="function"===typeof e[s]?e[s](t,i):e[s];this.state[s].request!==a&&(a.then?this.setState({[s]:{request:a}},()=>{a.then(e=>this.setStateChecked(t=>{if(t[s].request===a)return{[s]:{request:a,result:e}}}),e=>this.setStateChecked(t=>{if(t[s].request===a)return{[s]:{request:a,error:e}}}))}):this.setState({[s]:{request:a,result:a}}))})}componentDidMount(){this.updateRequests(this.props,this.context)}componentDidUpdate(){this.updateRequests(this.props,this.context)}componentWillUnmount(){this.unmounted=!0}shouldComponentUpdate(e,t){return n.some(e=>"error"in t[e])||n.every(e=>"result"in t[e])}render(){const e={},r={},o={...this.props};let l=!0,h=!1;return n.forEach(t=>{delete o[t];const i=this.state[t];"result"in i?e[t]=i.result:"error"in i?(r[t]=i.error,h=!0):l=!1}),h?s?a.a.createElement(s,Object.assign({},o,r)):null:l?a.a.createElement(t,Object.assign({},o,e)):i?a.a.createElement(i,o):null}}).displayName="WithAsync(".concat(t.displayName||t.name||"Component",")"),r}class S{constructor(){this.cache={},this.counter=0,this.subs=[]}subscribe(e){this.subs.push(e),e(this.counter)}unsubscribe(e){this.subs=this.subs.filter(t=>t!==e)}_start(){this.counter+=1,this.subs.forEach(e=>e(this.counter))}_stop(){this.counter-=1,this.subs.forEach(e=>e(this.counter))}fetch(e,t){const i=(t=t||{}).type||"json";let s="".concat(e,"$").concat(i);if(t.info&&(s+="$info"),!t.refresh&&this.cache[s])return this.cache[s];const a=this.cache[s]=fetch(e).then(e=>{if(e.ok){if("binary"===i)return e.arrayBuffer();if("text"===i)return e.text();if(!t.info){let i=e.json();return t.process&&(i=i.then(e=>t.process(e))),i}return e.text().then(t=>({compressed:parseInt(e.headers.get("Content-Length"),10),uncompressed:t.length,json:JSON.parse(t)}))}return e.json().then(e=>Promise.reject(e))});return t.global&&(this._start(),a.then(()=>this._stop(),()=>this._stop())),a}refresh(e,t){return this.fetch(e,{...t,refresh:!0})}}var _=i(264);class I extends a.a.Component{componentDidMount(){this.props.setActive(!0)}componentWillUnmount(){this.props.setActive(!1)}render(){const{setActive:e,children:t,...i}=this.props,s=a.a.Children.only(t);return a.a.cloneElement(s,i)}}class R extends a.a.Component{constructor(){super(...arguments),this.state={active:!1},this.setActive=(e=>this.setState({active:e}))}render(){const{children:e,overlay:t,...i}=this.props,s=a.a.Children.only(e);return a.a.createElement(_.a,Object.assign({overlay:a.a.createElement(I,{setActive:this.setActive},t)},i),a.a.cloneElement(s,{active:this.state.active}))}}const C="$history";class B extends a.a.Component{constructor(){super(...arguments),this.onScroll=(e=>{this.scrollTimeout&&clearTimeout(this.scrollTimeout),this.scrollTimeout=setTimeout(()=>{delete this.scrollTimeout;const t=this.props[C];t.replace(t.location.pathname+t.location.hash,{scrollTop:e})},500)})}componentDidMount(){const e=this.props[C].location.state;e&&null!=e.scrollTop&&this.props.callback(e.scrollTop),this.props.onRef&&this.props.onRef(this)}componentWillUnmount(){this.props.onRef&&this.props.onRef(null)}render(){return null}}const F=e=>a.a.createElement(o.d,{render:t=>{let{history:i}=t;return a.a.createElement(B,Object.assign({},e,{[C]:i}))}});function L(e,t){const i=URL.createObjectURL(e),s=document.createElement("a");s.setAttribute("href",i),s.setAttribute("download",t),s.style.display="none",document.body.appendChild(s),s.click(),setTimeout(()=>{document.body.removeChild(s),URL.revokeObjectURL(i)})}let D=null;function M(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(!D){D=new Uint32Array(1280);let e=1048577;for(let t=0;t<256;t++)for(let i=t;i<1280;i+=256){const t=(65535&(e=(125*e+3)%2796203))<<16,s=65535&(e=(125*e+3)%2796203);D[i]=t|s}}let i=2146271213,s=4008636142;for(let a=0;a<e.length;++a){let r=e.charCodeAt(a);r>=97&&r<=122&&(r-=32),47===r&&(r=92),s=r+(i=D[256*t+r]^i+s)+33*s+3|0}return i}function U(e,t){let i;t&&(i=e.match(/^(.*)\.(?:blp|dds|gif|jpg|jpeg|png|tga)$/i))&&(e=i[1]);let s=0;(i=e.match(/^([A-Z])\.w3mod:(.*)$/))&&(s=i[1].charCodeAt(0)-64,e=i[2]);const a=new Uint32Array(2);if(a[0]=M(e,1),a[1]=M(e,2),s){let e=a[0];a[0]+=s,a[0]<e&&(a[1]+=1)}return a}function P(e){return e[1].toString(16).padStart(8,"0")+e[0].toString(16).padStart(8,"0")}function k(e){const t=new Uint32Array(2);return t[0]=parseInt(e.substr(8,8),16),t[1]=parseInt(e.substr(0,8),16),isNaN(t[0])||isNaN(t[1])?null:t}function N(e,t){return!e===!t&&(!e||e[0]===t[0]&&e[1]===t[1])}var O=i(133),j=i.n(O),V=i(134),G=i.n(V),H=i(27),K=i.n(H);class q{constructor(e){this.images_={},this.wasm=e}fileId(e){return"string"===typeof e?U(e):null!=e&&"number"===typeof e[0]?e:null}hasFile(e){const t=this.fileId(e);return null!=t&&0!==this.wasm._hasFile(t[0],t[1])}loadBinary(e){const t=this.fileId(e);if(null==t)return null;let i=null;window.postResult=(e=>i=e);const s=this.wasm._loadFile(t[0],t[1],1);return delete window.postResult,i?{data:i,flags:s}:null}loadFile(e){const t=this.fileId(e);if(null==t)return null;let i=null;return window.postResult=(e=>i=e),this.wasm._loadFile(t[0],t[1]),delete window.postResult,i?(new K.a.TextDecoder).decode(i):null}loadImage(e){const t=this.fileId(e);if(null==t)return null;const i=P(t);if(this.images_[i])return this.images_[i];let s=null;if(window.postResult=(e=>s=e),this.wasm._loadImage(t[0],t[1]),delete window.postResult,!s)return null;const a=new Blob([s],{type:"image/png"});return this.images_[i]=URL.createObjectURL(a)}loadJASS(e){e=e||{};const t=this.wasm._malloc(10),i=this.wasm.HEAPU8;i[t+0]=e.indent||0,i[t+1]=e.restoreInt||0,i[t+2]=e.restoreId||0,i[t+3]=e.insertLines||0,i[t+4]=e.restoreStrings||0,i[t+5]=e.renameGlobals||0,i[t+6]=e.renameFunctions||0,i[t+7]=e.renameLocals||0,i[t+8]=e.inlineFunctions||0,i[t+9]=e.getObjectName||0;let s=null;if(window.postResult=(e=>s=e),this.wasm._loadJASS(t),delete window.postResult,this.wasm._free(t),!s)return null;const a=[],r=new K.a.TextDecoder;let n=0;for(let o=0;o<s.length;++o)0===s[o]&&(a.push(r.decode(s.subarray(n,o))),n=o+1);return a}}function W(e){return 827873863!==new Uint32Array(e.buffer||e,0,1)[0]?Promise.reject("Outdated archive format. Try parsing the map again."):G()({locateFile:e=>"ArchiveLoader.wasm"===e?j.a:e}).then(t=>{const i=new Uint8Array(e),s=t._malloc(i.length);return t.HEAPU8.set(i,s),t._openArchive(s,i.length),t._free(s),new q(t)})}var X=i(135),z=i.n(X);const Y=(e,t,i,s)=>new Promise((a,r)=>{e.addEventListener("message",t=>{if(t.data.progress)s&&s(t.data.progress);else if(t.data.result)e.terminate(),a(t.data.result);else{let i=t.data.error;(i instanceof ArrayBuffer||ArrayBuffer.isView(i))&&(i=(new K.a.TextDecoder).decode(i)),e.terminate(),r(i)}}),e.postMessage({meta:t,map:i})});class J{constructor(){this.worker=new z.a,this.onProgress=(()=>void 0)}async parse(e,t){return e=await e,this.onProgress(0),await Y(this.worker,e,t,this.onProgress)}terminate(){this.worker.terminate()}}let Z=null,$=null;function Q(e){Z=e,e&&$&&(e.setNotification($.message,$.type),$=null)}function ee(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info";Z?Z.setNotification(e,t):$={message:e,type:t}}var te=i(100),ie=i.n(te);const se=e=>(Object.values(e.objects).forEach(e=>{const t={};Object.keys(e.data).forEach(i=>t[i.toLowerCase()]=e.data[i]),e.data=t}),e),ae=e=>new Promise((t,i)=>{const s=new FileReader;s.onload=(()=>t(s.result)),s.onerror=(()=>i(s.error)),s.onabort=(()=>i()),s.readAsArrayBuffer(e)});class re{constructor(e,t,i){this.cache=e,this.id=t,this.name=i,this.core=!0}objects(){return this.cache.fetch("/api/".concat(this.id,".json"),{global:!0,process:se})}listFile(){return this.cache.fetch("/api/rootlist.txt",{global:!0,type:"text"})}hasFile(){return!1}file(){return null}binary(){return null}image(e){return this.cache.image(e)}jass(){return null}icon(e){return this.cache.icon(e)}iconByName(e){return this.cache.iconByName(e)}}const ne=(e,t)=>"string"===typeof e?U(e,t):null!=e&&"number"===typeof e[0]?e:null;class oe{constructor(e,t,i,s){this.files_={},this.images_={},this.cache=e,this.archive=t,this.id=i,this.name=s.replace(/\|(c[0-9a-fA-F]{6,8}|r)/g,""),this.isMap=!0}objects(){if(this.objects_)return this.objects_;const e=this.archive.loadFile("objects.json");if(!e){const e=Math.max(...Object.keys(this.cache.versions)),t=this.cache.data(e);return this.objects_=t?t.then(e=>e.objects()):Promise.resolve(null)}return this.objects_=Promise.resolve(e?se(JSON.parse(e)):null)}listFile(){return this.file("listfile.txt")}hasFile(e){return this.archive.hasFile(ne(e))}file(e){return this.files_.hasOwnProperty(e)?this.files_[e]:this.files_[e]=this.archive.loadFile(e)}binary(e){return this.archive.loadBinary(e)}jass(e){return this.archive.loadJASS(e)}image(e,t){return this.archive.loadImage(e)||this.cache.image(e,t)}icon(e){const t=this.archive.loadImage(e);return t?{backgroundImage:"url(".concat(t,")"),backgroundSize:"100%"}:this.cache.icon(e)}iconByName(e){return this.icon(U(e))}}class le extends S{constructor(e){super(),this.baseData_={},this.mapNames_={},this.mapData_={},this.maps={},this.root=e;try{this.dataStore=new ie.a("mapData"),this.nameStore=new ie.a("mapNames")}catch(i){this.dataStore=null,this.nameStore=null}const t=[this.fetch("/api/images.dat",{type:"binary"}),this.fetch("/api/versions.json")];this.nameStore&&t.push(this.nameStore.json()),this.ready=Promise.all(t).then(e=>{let[t,i,s]=e;this.icons_=new Map;const a=new Uint32Array(t);for(let r=0;r<a.length;r+=2){const e=P(a.subarray(r,r+2));this.icons_.set(e,r/2+256e3)}this.versions=i.versions,s&&(this.maps=s,this.root.forceUpdate()),i.custom&&(this.custom={},this.customDesc={},Object.entries(i.custom).forEach(e=>{let[t,i]=e;this.maps[t]=i.name,this.custom[t]=i.data,this.customDesc[t]=i.desc}))})}metaRaw(){return this.fetch("/api/meta.gzx",{type:"binary",global:!0})}meta(){return this.meta_?this.meta_:this.meta_=this.metaRaw().then(e=>W(e))}isLocal(e){return!(!this.maps[e]||this.custom[e])}data(e){return this.maps[e]?this.mapData_[e]?this.mapData_[e]:this.custom&&this.custom[e]?this.mapData_[e]=this.fetch("/api/".concat(this.custom[e]),{type:"binary",global:!0}).then(e=>W(e)).then(t=>new oe(this,t,e,this.maps[e])):this.mapData_[e]=this.dataStore.get(e).then(e=>ae(e)).then(e=>W(e)).then(t=>new oe(this,t,e,this.maps[e])).catch(e=>Promise.reject(ee(e.toString(),"danger"))):this.versions[e]?this.baseData_[e]?this.baseData_[e]:this.baseData_[e]=Promise.resolve(new re(this,e,this.versions[e])):null}hasData(e){return!(!this.maps[e]&&!this.versions[e])}icon(e){const t=this.icons_.get(P(e));if(t){const e=t%16,i=(t/16|0)%16;return{backgroundImage:"url(/api/icons".concat(t/256|0,".png)"),backgroundPosition:"-".concat(16*e,"px -").concat(16*i,"px")}}return null}iconByName(e){return this.icon(U(e))}image(e,t){const i=P(ne(e,!0));let s="/api/images/".concat(i);return t&&(s+="?tileset=".concat(t)),s}binary(e,t){const i=P(ne(e,!0));let s="/api/files/".concat(i);return t&&(s+="?tileset=".concat(t)),s}loadMap(e){this.abortMap();const t=this.metaRaw();ae(e).then(i=>{this.parser=new J,this.parser.onProgress=(e=>this.root.onMapProgress(e)),this.root.beginMapLoad(e.name),this.parser.parse(t,i).then(t=>{delete this.parser;let i=1;for(;this.maps.hasOwnProperty("map".concat(i));)i+=1;i="map".concat(i),this.dataStore&&Promise.all([this.nameStore.set(i,e.name),this.dataStore.set(i,new Blob([t],{type:"application/octet-stream"}))]).catch(()=>{this.nameStore.remove(i),this.dataStore.remove(i)}),this.maps={...this.maps,[i]:e.name},this.mapData_[i]=W(t).then(t=>new oe(this,t,i,e.name)).catch(e=>Promise.reject(ee(e.toString(),"danger"))),this.root.finishMapLoad(i)}).catch(e=>{delete this.parser,this.root.failMapLoad("string"===typeof e&&e),console.error(e)})})}abortMap(){this.parser&&(this.parser.terminate(),delete this.parser)}unloadMap(e){this.maps[e]&&window.confirm("Are you sure you want to unload ".concat(this.maps[e],"?"))&&(this.maps={...this.maps},delete this.maps[e],delete this.mapData_[e],this.dataStore&&(this.dataStore.remove(e),this.nameStore.remove(e)),this.root.forceUpdate())}}le.Context=a.a.createContext(null),le.DataContext=a.a.createContext(null),le.MapsContext=a.a.createContext({});const he=a.a.createContext(null);class ce extends a.a.PureComponent{constructor(){super(...arguments),this.children=[]}componentDidMount(){this.context&&(this.context.children.push(this),this.context.updateTitle())}componentDidUpdate(){this.updateTitle()}componentWillUnmount(){if(this.context){let e=this.context.children.indexOf(this);e>=0&&(this.context.children.splice(e,1),e>=this.context.children.length&&this.context.updateTitle())}}updateTitle(){let e=this;for(;e.context;)e=e.context;document.title=e.getTitle()}getTitle(e){let{title:t,combiner:i}=this.props;return e&&(t=i(e,t)),this.children.length&&(t=this.children[this.children.length-1].getTitle(t)),t}render(){const{children:e}=this.props;return e?a.a.createElement(he.Provider,{value:this},e):null}}ce.contextType=he,ce.defaultProps={combiner:(e,t)=>"".concat(e," - ").concat(t)};class de extends a.a.Component{constructor(e){super(e);const t={};if(window.localStorage){const e=window.localStorage.getItem("options");if(e)try{Object.assign(t,JSON.parse(e))}catch(i){}}t.update=((e,t)=>this.setState({[e]:t})),this.state=t}componentDidUpdate(){if(window.localStorage){const e={...this.state};delete e.update,window.localStorage.setItem("options",JSON.stringify(e))}}render(){return a.a.createElement(de.Context.Provider,{value:this.state},this.props.children)}}de.Context=a.a.createContext({});i(195);var ue=i(260),me=i(251),fe=i(252),pe=i(253),ge=(i(196),{unit:"Units",item:"Items",destructible:"Destructibles",doodad:"Doodads",ability:"Abilities",buff:"Buffs/Effects",upgrade:"Upgrades"});const we=e=>{let{match:{params:{build:t,type:i}}}=e;return a.a.createElement(ue.a,{eventKey:"objects",title:ge[i]||"Objects",active:null!=ge[i],id:"objects-menu"},Object.keys(ge).map(e=>a.a.createElement(f.LinkContainer,{key:e,to:"/".concat(t,"/").concat(e)},a.a.createElement(me.a,{eventKey:"objects.".concat(e)},a.a.createElement("span",{className:"ObjectIcon ".concat(e)}),ge[e]))))},ve=()=>a.a.createElement(o.d,{path:"/:build/:type?",component:we});var ye=()=>a.a.createElement(le.DataContext.Consumer,null,e=>a.a.createElement(a.a.Fragment,null,a.a.createElement("ul",{className:"DataMenu"},a.a.createElement(f.LinkContainer,{className:"title",to:"/".concat(e.id),exact:!0},a.a.createElement(pe.a,{eventKey:"build"},e.name)),a.a.createElement(f.LinkContainer,{to:"/".concat(e.id,"/files")},a.a.createElement(pe.a,{eventKey:"files"},"Files")),(!e.isMap||e.hasFile("objects.json"))&&a.a.createElement(a.a.Fragment,null,a.a.createElement("li",{className:"sep"}," | "),a.a.createElement(ve,null)),!!e.isMap&&a.a.createElement(a.a.Fragment,null,a.a.createElement("li",{className:"sep"}," | "),a.a.createElement(f.LinkContainer,{to:"/".concat(e.id,"/map")},a.a.createElement(pe.a,{eventKey:"map"},"Map"))),(e.hasFile("war3map.j")||e.hasFile("Scripts\\war3map.j"))&&a.a.createElement(a.a.Fragment,null,a.a.createElement("li",{className:"sep"}," | "),a.a.createElement(f.LinkContainer,{to:"/".concat(e.id,"/script")},a.a.createElement(pe.a,{eventKey:"script"},"Script"))))));const be=a.a.createContext(!1),Ae=(a.a.createContext(!0),a.a.createContext(0)),Ee=a.a.createContext(""),xe=a.a.createContext(""),Te=a.a.createContext(void 0),Se=e=>{let{object:t}=e;return a.a.createElement(le.DataContext.Consumer,null,e=>{if(!t||null==t.icon)return null;const i=e.icon(t.icon);return a.a.createElement("span",{className:"Icon",style:i})})};function _e(e,t){if(t>=e.length)return-1;let i=!1;for(++t;t<e.length;++t)if('"'===e[t]&&(i=!i),","===e[t]&&!i)return t;return t}const Ie={atdb:"Attack Dice Bonus - Base",atdm:"Attack Dice Bonus - Increment",levb:"Ability Level Bonus - Base",levm:"Ability Level Bonus - Increment",levc:"Ability Affected",hpxb:"Hit Point Bonus - Base",hpxm:"Hit Point Bonus - Increment",mnxb:"Mana Point Bonus - Base",mnxm:"Mana Point Bonus - Increment",mvxb:"Movement Speed Bonus - Base",mvxm:"Movement Speed Bonus - Increment",mnrb:"Mana Regeneration Bonus (%) - Base",mnrm:"Mana Regeneration Bonus (%) - Increment",hpob:"Hit Point Bonus (%) - Base",hpom:"Hit Point Bonus (%) - Increment",manb:"Mana Point Bonus (%) - Base",manm:"Mana Point Bonus (%) - Increment",movb:"Movement Speed Bonus (%) - Base",movm:"Movement Speed Bonus (%) - Increment",atxb:"Attack Damage Bonus - Base",atxm:"Attack Damage Bonus - Increment",lumb:"Lumber Harvest Bonus - Base",lumm:"Lumber Harvest Bonus - Increment",atrb:"Attack Range Bonus - Base",atrm:"Attack Range Bonus - Increment",atsb:"Attack Speed Bonus (%) - Base",atsm:"Attack Speed Bonus (%) - Increment",spib:"Spike Damage - Base",spim:"Spike Damage - Increment",hprb:"Hit Point Regeneration Bonus (%) - Base",hprm:"Hit Point Regeneration Bonus (%) - Increment",sigb:"Sight Range Bonus - Base",sigm:"Sight Range Bonus - Increment",atcb:"Attack Target Count Bonus - Base",atcm:"Attack Target Count Bonus - Increment",adlb:"Attack Damage Loss Bonus - Base",adlm:"Attack Damage Loss Bonus - Increment",minb:"Gold Harvest Bonus - Base",minm:"Gold Harvest Bonus - Increment",raib:"Raise Dead Duration Bonus - Base",raim:"Raise Dead Duration Bonus - Increment",entb:"Gold Harvest Bonus (Entangle) - Base",entm:"Gold Harvest Bonus (Entangle) - Increment",enwb:"Attacks to Enable",audb:"Aura Data Bonus - Base",audm:"Aura Data Bonus - Increment",asdb:"Attack Spill Distance Bonus - Base",asdm:"Attack Spill Distance Bonus - Increment",asrb:"Attack Spill Radius Bonus - Base",asrm:"Attack Spill Radius Bonus - Increment",roob:"Attacks to Enable (Rooted)",urob:"Attacks to Enable (Uprooted)",uart:"New Defense Type",utma:"New Availability",ttma:"Unit Type Affected"},Re={A:"Ashenvale",B:"Barrens",K:"Black Citadel",Y:"Cityscape",X:"Dalaran",J:"Dalaran Ruins",D:"Dungeon",C:"Felwood",I:"Icecrown Glacier",F:"Lordaeron Fall",L:"Lordaeron Summer",W:"Lordaeron Winter",N:"Northrend",O:"Outland",Z:"Sunken Ruins",G:"Underground",V:"Village",Q:"Village Fall","*":"All"},Ce={D:"Trees/Destructibles",P:"Pathing Blockers",B:"Bridges/Ramps"},Be={O:"Props",S:"Structures",W:"Water",C:"Cliff/Terrain",E:"Environment",Z:"Cinematic"},Fe={HERO:"Any Hero",TALT:"Any Altar",TWN1:"Any Tier 1 Hall",TWN2:"Any Tier 2 Hall",TWN3:"Any Tier 3 Hall",TWN4:"Any Tier 4 Hall",TWN5:"Any Tier 5 Hall",TWN6:"Any Tier 6 Hall",TWN7:"Any Tier 7 Hall",TWN8:"Any Tier 8 Hall",TWN9:"Any Tier 9 Hall"};function Le(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1;const s=e.data[t.toLowerCase()]||"";if(i<0){const e=_e(s,-1);return e>=2&&e>=s.length&&'"'===s[0]&&'"'===s[e-1]?s.substr(1,e-2):s}{let e=-1,t=0,a=0;for(;(e=_e(s,e))>=0;){if(t===i)return e-a>=2&&'"'===s[a]&&'"'===s[e-1]?s.substr(a+1,e-a-2):s.substr(a,e-a);a=e+1,t++}return""}}function De(e,t,i,s){const a="item"===e.type?"unit":e.type,r=t.meta[a]||[],n=t=>(t=t.toLowerCase(),e.data[t]&&parseInt(e.data[t],10)||0);let o=0,l=0;switch(e.type){case"unit":o=n("isbldg")?4:e.id.match(/^[A-Z]/)?2:1;break;case"item":o=8;break;case"ability":l=n("levels"),e.data.code&&s("code",i?"code":"Ability Code",e.data.code,{type:"abilCode"});break;case"doodad":l=n("numVar");break;case"upgrade":l=n("maxlevel")}const h=new Map;r.forEach(t=>h.set(t,(t=>{if("upgrade"!==e.type)return t.display;const i=t.field.match(/^(base|mod|code)(\d)$/);if(!i)return t.display;const s=(e.data["effect".concat(i[2])]||"").match(/^r([a-z][a-z][a-z])$/);if(!s)return null;const a=Ie[s[1]+i[1][0]];return a?t.display.replace("%s",a):null})(t))),r.filter(e=>h.get(e)).sort((e,i)=>(16&e.flags)!==(16&i.flags)?(16&e.flags)-(16&i.flags):e.category!==i.category?t.categories[e.category].localeCompare(t.categories[i.category]):h.get(e).localeCompare(h.get(i))).forEach(a=>{if((a.flags&o)!==o)return;if(a.specific&&a.specific.indexOf("ability"===e.type?e.data.code:e.id)<0)return;if(16&a.flags&&!l)return;let r=a.field;if(a.data&&(r+=String.fromCharCode(65+a.data-1)),16&a.flags)for(let n=0;n<l;++n){let o=r;a.index<0&&(32&a.flags?n>0&&(o+=n):o+=n+1);const l=a.index<0?Le(e,o,-1):Le(e,r,n);s("".concat(r).concat(n),i?o:"Level ".concat(n+1," - ").concat(t.categories[a.category]," - ").concat(h.get(a)),l,a)}else{const n=Le(e,r,a.index);s("".concat(r).concat(a.index),i?r:"".concat(t.categories[a.category]," - ").concat(h.get(a)),n,a)}})}const Me={};Me.unit=[{name:e=>e.base?"Custom Units":"Standard Units",order:["Standard Units","Custom Units"]},{name:e=>{switch(e.data.race){case"human":return"Human";case"orc":return"Orc";case"undead":return"Undead";case"nightelf":return"Night Elf";case"naga":return"Neutral - Naga";default:return parseInt(e.data.hostilepal,10)?"Neutral Hostile":"Neutral Passive"}},order:["Human","Orc","Undead","Night Elf","Neutral - Naga","Neutral Hostile","Neutral Passive"]},{name:e=>parseInt(e.data.campaign,10)?"Campaign":"Melee",order:["Melee","Campaign"]},{name:e=>parseInt(e.data.special,10)?"Special":parseInt(e.data.isbldg,10)?"Buildings":e.id.match(/^[A-Z]/)?"Heroes":"Units",order:["Units","Buildings","Heroes","Special"]}],Me.item=[{name:e=>e.base?"Custom Items":"Standard Items",order:["Standard Items","Custom Items"]},{name:e=>{switch(e.data.class){case"PowerUp":return"Power Up";default:return e.data.class}},order:["Permanent","Charged","Power Up","Artifact","Purchasable","Campaign","Miscellaneous"]}],Me.destructible=[{name:e=>e.base?"Custom Destructibles":"Standard Destructibles",order:["Standard Destructibles","Custom Destructibles"]},{name:e=>{switch(e.data.category){case"D":return"Trees/Destructibles";case"P":return"Pathing Blockers";case"B":return"Bridges/Ramps";default:return"Others"}},order:["Trees/Destructibles","Pathing Blockers","Bridges/Ramps","Others"]}],Me.doodad=[{name:e=>e.base?"Custom Doodads":"Standard Doodads",order:["Standard Doodads","Custom Doodads"]},{name:e=>{switch(e.data.category){case"O":return"Props";case"S":return"Structures";case"W":return"Water";case"C":return"Cliff/Terrain";case"E":return"Environment";case"Z":return"Cinematic";default:return"Others"}},order:["Props","Structures","Water","Cliff/Terrain","Environment","Cinematic","Others"]}],Me.ability=[{name:e=>e.base?"Custom Abilities":"Standard Abilities",order:["Standard Abilities","Custom Abilities"]},{name:e=>{switch(e.data.race){case"human":return"Human";case"orc":return"Orc";case"undead":return"Undead";case"nightelf":return"Night Elf";case"creeps":return"Neutral Hostile";case"naga":case"demon":return"Neutral Passive";default:return"Special"}},order:["Human","Orc","Undead","Night Elf","Neutral Hostile","Neutral Passive","Special"]},{name:e=>parseInt(e.data.hero,10)?"Heroes":parseInt(e.data.item,10)?"Items":"Units",order:["Units","Heroes","Items"]}],Me.buff=[{name:e=>e.base?"Custom Buffs/Effects":"Standard Buffs/Effects",order:["Standard Buffs/Effects","Custom Buffs/Effects"]},{name:e=>{switch(e.data.race){case"human":return"Human";case"orc":return"Orc";case"undead":return"Undead";case"nightelf":return"Night Elf";default:return"Special"}},order:["Human","Orc","Undead","Night Elf","Special"]},{name:e=>parseInt(e.data.isEffect,10)?"Effect":"Buff",order:["Buff","Effect"]}],Me.upgrade=[{name:e=>e.base?"Custom Upgrades":"Standard Upgrades",order:["Standard Upgrades","Custom Upgrades"]},{name:e=>{switch(e.data.race){case"human":return"Human";case"orc":return"Orc";case"undead":return"Undead";case"nightelf":return"Night Elf";default:return"Special"}},order:["Human","Orc","Undead","Night Elf","Special"]}];var Ue=i(30),Pe=i.n(Ue),ke=i(263),Ne=i(21),Oe=i(254),je=i(255),Ve=i(256);class Ge{constructor(e,t,i){this.type=e,this.json=t,this.names=i,this.json?this.outJs={}:this.outLines=[]}onObject(e){this.json?(this.curJs={},this.outJs[e]=this.curJs):this.outLines.push("[".concat(e,"]"))}onValue(e,t){this.json?this.curJs[e]=t:this.outLines.push("".concat(e,"=").concat(t))}translateSub(e,t,i){let s=t.type;if("lightningList"===s&&(s="lightningEffect"),i.types[s])return e&&"_"!==e?i.types[s][e]||"value":"None";switch(s){case"bool":return parseInt(e,10)?"True":"False";case"string":return"_"===e?"":e;case"char":return e;case"int":return parseInt(e,10)||0;case"real":case"unreal":return(parseFloat(e)||0).toFixed(t.stringExt||2);case"destructableCategory":return Ce[e]||e;case"tilesetList":return Re[e]||e;case"doodadCategory":return Be[e]||e;case"techList":if(Fe[e])return Fe[e];case"buffCode":case"buffList":case"effectCode":case"effectList":case"unitCode":case"unitList":case"abilCode":case"abilityList":case"heroAbilityList":case"itemCode":case"itemList":case"upgradeCode":case"upgradeList":if("_"===e)return"";const a=i.objects.find(t=>t.id===e);return a?a.name:e;default:return"_"!==e&&e||"None"}}translate(e,t,i){if(t.type.indexOf("List")>=0)return"_"===e||""===e?"":e.split(",").map(e=>this.translateSub(e,t,i)).join(", ");if(t.type.indexOf("Flags")>=0){const s=parseInt(e,10);return[...Array(31)].map((e,t)=>t).filter(e=>0!==(1<<e&s)).map(e=>this.translateSub(e,t,i)).join(", ")}return"string"===t.type?"_"===e?"":e:this.translateSub(e,t,i)}processObject(e,t){this.onObject(e.id),this.names<2?De(e,t,1===this.names,(e,i,s,a)=>{0===this.names&&(s=this.translate(s,a,t)),this.onValue(i,s)}):Object.keys(e.data).sort().forEach(t=>this.onValue(t,e.data[t]))}process(e){e.objects.forEach(t=>{"all"!==this.type&&this.type!==t.type||this.processObject(t,e)})}processSingle(e){const t="all"===this.type?e.objects[0]:e.objects.find(e=>e.type===this.type);t&&this.processObject(t,e)}get output(){return 0===this.json?this.outLines.join("\r\n"):1===this.json?JSON.stringify(this.outJs).replace(/\n/g,"\r\n"):JSON.stringify(this.outJs,null,2).replace(/\n/g,"\r\n")}get preview(){let e;return 0===this.json?e=this.outLines.join("\n"):1===this.json?e=JSON.stringify(this.outJs):2===this.json&&(e=JSON.stringify(this.outJs,null,2)),e.slice(0,1e3)}}class He extends a.a.PureComponent{constructor(){super(...arguments),this.state={},this.setOption=((e,t)=>{const i={...this.options};i[e]=t,this.context.update("dataDownload",i)}),this.setType=(e=>this.setOption("type",e.target.value)),this.onDownload=(()=>{const{type:e,json:t,names:i}=this.options,s=new Ge(e,t,i);s.process(this.props.data);const a=(new K.a.TextEncoder).encode(s.output);L(new Blob([a],{type:"text/plain"}),e+".txt"),this.props.onHide()})}get options(){return this.context.dataDownload||He.defaultState}componentDidUpdate(){this.props.show!==this.state.show&&this.setState({show:this.props.show},()=>this.setOption("type",this.props.show))}render(){const{show:e,onHide:t}=this.props,{type:i,json:s,names:r}=this.options,n=new Ge(i,s,r);return n.processSingle(this.props.data),a.a.createElement(d.a,{show:!!e,onHide:t},a.a.createElement(d.a.Header,{closeButton:!0},a.a.createElement(d.a.Title,null,"Download data")),a.a.createElement(d.a.Body,null,a.a.createElement("form",null,a.a.createElement(Oe.a,{controlId:"formType"},a.a.createElement(je.a,null,"Object type"),a.a.createElement(ke.a,{componentClass:"select",value:i,onChange:this.setType},Object.keys(ge).map(e=>a.a.createElement("option",{key:e,value:e},ge[e])),a.a.createElement("option",{value:"all"},"All (Combined)"))),a.a.createElement(Oe.a,null,a.a.createElement(Ve.a,{name:"json",inline:!0,checked:0===s,onChange:()=>this.setOption("json",0)},"Text")," ",a.a.createElement(Ve.a,{name:"json",inline:!0,checked:1===s,onChange:()=>this.setOption("json",1)},"JSON"),a.a.createElement(Ve.a,{name:"json",inline:!0,checked:2===s,onChange:()=>this.setOption("json",2)},"Indented JSON")),a.a.createElement(Oe.a,null,a.a.createElement(Ve.a,{name:"names",inline:!0,checked:0===r,onChange:()=>this.setOption("names",0)},"Editor names")," ",a.a.createElement(Ve.a,{name:"names",inline:!0,checked:1===r,onChange:()=>this.setOption("names",1)},"Code names"),a.a.createElement(Ve.a,{name:"names",inline:!0,checked:2===r,onChange:()=>this.setOption("names",2)},"Raw data"))),a.a.createElement("div",{className:"dataPreview"},n.preview)),a.a.createElement(d.a.Footer,null,a.a.createElement(m.a,{bsStyle:"info",onClick:this.onDownload},"Download"),a.a.createElement(m.a,{onClick:t},"Cancel")))}}He.contextType=de.Context,He.defaultState={type:"all",json:0,names:0};i(233);const Ke=e=>{let{object:t}=e;return a.a.createElement(be.Consumer,null,e=>e?t.base?"".concat(t.id,":").concat(t.base," (").concat(t.name,")"):"".concat(t.id," (").concat(t.name,")"):t.name)},qe=e=>{let{object:t}=e;return a.a.createElement(Ae.Consumer,null,e=>a.a.createElement(Ee.Consumer,null,i=>a.a.createElement(xe.Consumer,null,s=>a.a.createElement(l.Link,{to:"/".concat(e,"/").concat(i,"/").concat(t.id),className:b()("ObjectLink",{selected:s===t.id,searched:t.searched})},a.a.createElement(Se,{object:t}),a.a.createElement("span",{className:"ObjectName"},a.a.createElement(Ke,{object:t}))))))};class We{constructor(e,t){this.height=1,this.object=e,this.object.parent=this,this.object.upVisit=(e=>{e(this.object),this.object.parent.upVisit(e)}),this.parent=t}upVisit(e){e(this),this.parent.upVisit(e)}downVisit(e){e(this),e(this.object)}render(){return a.a.createElement(qe,{object:this.object})}renderLine(e){return this.render()}}class Xe{constructor(e,t,i,s){if(this.toggle=(()=>{this.expanded?this.collapse():this.expand()}),this.parent=i,this.level=i?i.level+1:0,this.count=e.length,this._title=s,s&&(this.title="".concat(s," (").concat(this.count,")")),t&&t.length){this.filter=t[0];const s={};e.forEach(e=>{const i=t[0].name(e);s[i]=s[i]||[],s[i].push(e)});const a=t.slice(1);this.childrenByName={},this.children=t[0].order.filter(e=>!i||s[e]).map(e=>this.childrenByName[e]=new Xe(s[e]||[],a,this,e))}else this.children=e.map(e=>new We(e,this)).sort((e,t)=>e.object.name.localeCompare(t.object.name));this.openHeight=i?1:0,this.children.forEach(e=>{e.top=this.openHeight,this.openHeight+=e.height}),i?this.level>1?this.expanded=!1:this.expanded=this.count>0:this.expanded=!0}upVisit(e){e(this),this.parent&&this.parent.upVisit(e)}downVisit(e){e(this),this.children.forEach(t=>t.downVisit(e))}modHeight(e,t){let i=t?this.children.indexOf(t):-1;if(i>=0)for(;++i<this.children.length;)this.children[i].top+=e;this.openHeight+=e,this.parent&&this.expanded?this.parent.modHeight(e,this):this.onResize&&this.onResize(this.height)}get height(){return this.expanded?this.openHeight:1}expandItem(e){if(this.filter){const t=this.filter.name(e),i=this.childrenByName[t];if(i)return i.expand(),i.expandItem(e)+i.top}else{const t=this.children.find(t=>t.object===e);if(t)return t.top}return 0}expand(){!this.expanded&&this.count>0&&(this.expanded=!0,this.parent&&this.parent.modHeight(this.openHeight-1,this))}collapse(){this.expanded&&this.parent&&(this.expanded=!1,this.parent.modHeight(1-this.openHeight,this))}render(){let e=0;return this.downVisit(t=>e+="ObjectItem"==t.__proto__.constructor.name&&t.searched?1:0),e&&(this.title="".concat(this._title," (").concat(e,"/").concat(this.count,")")),this.parent?a.a.createElement("div",{className:b()("ObjectGroup",{expanded:this.expanded,searched:this.searched})},a.a.createElement("span",{className:"toggle",onClick:this.toggle}),a.a.createElement("span",{onDoubleClick:this.toggle},a.a.createElement("span",{className:"Icon"}),a.a.createElement("span",{className:"title"},this.title))):null}firstLevelChild(e){if(this.expanded){let t=0,i=this.children.length-1;for(;t<i;){const s=t+i+1>>1;this.children[s].top>e?i=s-1:t=s}return this.children[t]}return null}renderLine(e){if(this.parent&&!e)return this.render();if(this.expanded){let t=0,i=this.children.length-1;for(;t<i;){const s=t+i+1>>1;this.children[s].top>e?i=s-1:t=s}const s=e-this.children[t].top,r=this.children[t].renderLine(s);let n=null;return t<this.children.length-1?n=0===s?"tLine":"line":0===s&&(n="halfLine"),this.parent?a.a.createElement("div",{className:b()("indent",n)},r):r}}}class ze extends a.a.PureComponent{constructor(){super(...arguments),this.state={search:"",searchResults:null},this.onSearchKeyDown=(e=>{27===e.which&&(this.setState({search:"",searchResults:null}),this._list&&this._list.forceUpdateGrid())}),this.onSearch=(e=>{const{data:t,type:i}=this.props,s=e.target.value.trim();console.log(s);let a=0;if(this.group.downVisit(e=>{e.searched=!1}),s){const e=new RegExp("\\b"+s.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&"),"i"),r=t=>t.type===i&&(!(!this.context||!t.id.match(e))||(!!t.name.match(e)||(!(!t.data.propernames||!t.data.propernames.match(e))||-1!=t.name.indexOf(s))));t.objects.forEach(e=>{const t=r(e);t&&e.upVisit(e=>{e.searched=e.searched|t,e.searched&&a++})})}this._list&&this._list.forceUpdateGrid(),this.setState({search:e.target.value,searchResults:a})}),this.onResize=(()=>{this.forceUpdate()}),this.rowRenderer=(e=>{let{index:t,...i}=e;const{key:s,style:r}=i,n=this.group.firstLevelChild(t);return a.a.createElement("div",{className:b()("TreeRow",{searched:n&&n.searched}),key:s,style:r},this.group.renderLine(t))}),this.onDownload=(()=>{this.setState({showDownload:this.props.type})}),this.onCloseDownload=(()=>{this.setState({showDownload:!1})})}render(){const{data:e,type:t,id:i,className:s,...r}=this.props,{search:n,searchResults:o,showDownload:l}=this.state;if(!this.group||this.group._data!==e||this.group._type!==t){const i=Me[t];if(!i)return null;this.group=new Xe(e.objects.filter(e=>e.type===t),i),this.group._data=e,this.group._type=t,this.group.onResize=this.onResize,setTimeout(()=>{this._list&&this._list.forceUpdateGrid()})}if(!o&&this.group._id!==i){const s=e.objects.find(e=>e.type===t&&e.id===i);if(s){this.group.onResize=null;const e=this.group.expandItem(s);this.group.onResize=this.onResize,this.group._id=i,setTimeout(()=>{this._list&&this._list.scrollToRow(e)})}}return a.a.createElement(Pe.a,Object.assign({className:b()(s,"ObjectList")},r),a.a.createElement(He,{data:e,show:l,onHide:this.onCloseDownload}),a.a.createElement("div",{className:"search-box"},a.a.createElement(ke.a,{type:"text",value:n,placeholder:"Search",onKeyDown:this.onSearchKeyDown,onChange:this.onSearch}),a.a.createElement(m.a,{active:!!l,onClick:this.onDownload,bsSize:"small"},a.a.createElement(c.a,{glyph:"download-alt"})),a.a.createElement(be.Consumer,null,e=>a.a.createElement(Te.Consumer,null,t=>a.a.createElement(m.a,{active:e,onClick:t,bsSize:"small"},a.a.createElement(c.a,{glyph:"cog"}))))),a.a.createElement("div",{className:"ObjectListItems"},a.a.createElement(Ne.a,null,e=>{let{width:t,height:i}=e;return a.a.createElement(Ne.c,{className:"ObjectLines",ref:e=>this._list=e,width:t,height:i,rowCount:this.group.height,rowHeight:18,rowRenderer:this.rowRenderer})})))}}ze.contextType=be;var Ye=i(257);function Je(e,t){return i=>a.a.createElement("span",{style:{color:t},key:i},e)}function Ze(e,t){const i=[];let s=null,r=i;e=e.split("\n").join("|n");const n=/<(\w+),(\w+)(,%)?>|\|([rn])|\|c[0-9a-zA-Z]{2}([0-9a-zA-Z]{6})/gi;let o,l=0;for(;o=n.exec(e);){if(o.index>l&&r.push(e.substring(l,o.index)),o[1]){const e=t&&t.objects.find(e=>e.id===o[1]),i=o[2].toLowerCase();e&&e.data[i]?r.push(parseFloat(e.data[i])*(o[3]?100:1)):r.push(o[0])}else"n"===o[4]||"N"===o[4]?r.push(a.a.createElement("br",{key:r.length})):("r"===o[4]||"R"===o[4]||o[5])&&(s&&(i.push(s(i.length)),r=i,s=null),o[5]&&(s=Je(r=[],"#"+o[5])));l=o.index+o[0].length}return l<e.length&&r.push(e.substring(l)),s&&i.push(s(i.length)),i}const $e=e=>{let{objectId:t}=e;const[i,r]=Object(s.useState)(null);return Object(s.useEffect)(()=>{t&&async function(){r(t)}()},[t]),i?a.a.createElement("div",null,a.a.createElement(Ye.a.Title,null,i.name),a.a.createElement(Ye.a.Content,null,i.description||"No description available.",i.icon&&a.a.createElement("img",{src:le.image(i.icon),alt:"".concat(i.name," Icon"),className:"object-icon"}))):a.a.createElement(Ye.a.Title,null,"Loading...")};var Qe=e=>{let{objectId:t,children:i}=e;return a.a.createElement(_.a,{overlay:a.a.createElement(Ye.a,{id:"objectId"},a.a.createElement($e,{objectId:t}))},"string"===typeof i?a.a.createElement("span",null,i):i)};class et{constructor(e){this.properties=new Map,this.sections=new Map,e&&this.load(e)}load(e){let t=this.properties,i=this.sections;for(let s of e.split(/\r\n?|\n/))if(s.length&&!s.startsWith("//")&&!s.startsWith(";")){let e=s.match(/^\[(.+?)\]/);if(e){let s=e[1].trim().toLowerCase();(t=i.get(s))||(t=new Map,i.set(s,t))}else(e=s.match(/^(.+?)=(.*?)$/))&&t.set(e[1].toLowerCase(),e[2])}}save(){let e=[];for(let[t,i]of this.properties)e.push("".concat(t,"=").concat(i));for(let[t,i]of this.sections){e.push("[".concat(t,"]"));for(let[t,s]of i)e.push("".concat(t,"=").concat(s))}return e.join("\r\n")}getSection(e){return this.sections.get(e.toLowerCase())}}var tt={IniFile:et};class it{constructor(e){this.rows=[],e&&this.load(e)}load(e){if(!e.startsWith("ID"))throw new Error("WrongMagicNumber");let t=this.rows,i=0,s=0;for(let a of e.split("\n"))if("B"!==a[0])for(let e of a.split(";")){let a,r=e[0],n=e.substring(1).trim();"X"===r?i=parseInt(n,10)-1:"Y"===r?s=parseInt(n,10)-1:"K"===r?(t[s]||(t[s]=[]),a='"'===n[0]?n.substring(1,n.length-1):"TRUE"===n||"FALSE"!==n&&parseFloat(n),t[s][i]=a):"A"===r&&(this.comments||(this.comments=[]),this.comments[s]||(this.comments[s]=[]),this.comments[s][i]=n)}this.cols=this.rows.reduce((e,t)=>Math.max(e,t.length),0)}}var st={SlkFile:it};let at=new ArrayBuffer(8),rt=new Int8Array(at),nt=new Int16Array(at),ot=new Int32Array(at),lt=new Uint8Array(at),ht=new Uint16Array(at),ct=new Uint32Array(at),dt=new Float32Array(at),ut=new Float64Array(at);function mt(e){return lt[0]=e,rt[0]}function ft(e,t){return lt[0]=e,lt[1]=t,nt[0]}function pt(e,t){return lt[0]=e,lt[1]=t,ht[0]}function gt(e,t,i){return lt[0]=e,lt[1]=t,lt[2]=i,lt[3]=0,ct[0]}function wt(e,t,i,s){return lt[0]=e,lt[1]=t,lt[2]=i,lt[3]=s,ct[0]}function vt(e,t,i,s){return lt[0]=e,lt[1]=t,lt[2]=i,lt[3]=s,dt[0]}function yt(e,t,i,s,a,r,n,o){return lt[0]=e,lt[1]=t,lt[2]=i,lt[3]=s,lt[4]=a,lt[5]=r,lt[6]=n,lt[7]=o,ut[0]}function bt(e){return lt[0]=e,rt[0]}function At(e,t){return nt[0]=t,e[0]=lt[0],e[1]=lt[1],e}function Et(e,t){return ot[0]=t,e[0]=lt[0],e[1]=lt[1],e[2]=lt[2],e[3]=lt[3],e}function xt(e,t){return ht[0]=t,e[0]=lt[0],e[1]=lt[1],e}function Tt(e,t){return ct[0]=t,e[0]=lt[0],e[1]=lt[1],e[2]=lt[2],e[3]=lt[3],e}function St(e,t){return dt[0]=t,e[0]=lt[0],e[1]=lt[1],e[2]=lt[2],e[3]=lt[3],e}function _t(e,t){return ut[0]=t,e[0]=lt[0],e[1]=lt[1],e[2]=lt[2],e[3]=lt[3],e[4]=lt[4],e[5]=lt[5],e[6]=lt[6],e[7]=lt[7],e}let It=new Uint8Array(8);class Rt{constructor(e,t,i){if(ArrayBuffer.isView(e)&&(t=(e=e.buffer).byteOffset,i=e.byteLength),!(e instanceof ArrayBuffer))throw new TypeError("BinaryStream: expected ArrayBuffer or ArrayBufferView, got ".concat(e));this.buffer=e,this.uint8array=new Uint8Array(e,t,i),this.index=0,this.byteLength=e.byteLength}substream(e){return new Rt(this.buffer,this.index,e)}remaining(){return this.byteLength-this.index}skip(e){this.index+=e}seek(e){this.index=e}tell(){return this.index}peek(e,t){let i=this.uint8array,s=this.index,a=[];if(s+e>i.length)throw new RangeError("BinaryStream: read outside of range");for(let r=0;r<e;r++){let e=i[s+r];(t||e>0)&&a.push(e)}return String.fromCharCode(...a)}read(e,t){e=e||this.remaining();let i=this.peek(e,t);return this.index+=e,i}peekUntilNull(){let e=this.uint8array,t=this.index,i=e[t],s=0;for(;0!==i&&t+s<e.length;)i=e[t+(s+=1)];return String.fromCharCode(...e.subarray(t,t+s))}readUntilNull(){let e=this.peekUntilNull();return this.index+=e.length+1,e}peekCharArray(e){let t=this.uint8array,i=this.index,s=[];if(i+e>t.length)throw new RangeError("BinaryStream: read outside of range");for(let a=0;a<e;a++)s[a]=String.fromCharCode(t[i+a]);return s}readCharArray(e){let t=this.peekCharArray(e);return this.index+=e,t}readInt8(){let e=this.index,t=this.uint8array;if(e+1>t.length)throw new RangeError("BinaryStream: read outside of range");let i=mt(t[e]);return this.index+=1,i}readInt16(){let e=this.index,t=this.uint8array;if(e+2>t.length)throw new RangeError("BinaryStream: read outside of range");let i=ft(t[e],t[e+1]);return this.index+=2,i}readInt32(){let e=this.index,t=this.uint8array;if(e+4>t.length)throw new RangeError("BinaryStream: read outside of range");let i=(s=t[e],a=t[e+1],r=t[e+2],n=t[e+3],lt[0]=s,lt[1]=a,lt[2]=r,lt[3]=n,ot[0]);var s,a,r,n;return this.index+=4,i}readUint8(){if(this.index+1>this.uint8array.length)throw new RangeError("BinaryStream: read outside of range");let e=this.uint8array[this.index];return this.index+=1,e}readUint16(){let e=this.index,t=this.uint8array;if(e+2>t.length)throw new RangeError("BinaryStream: read outside of range");let i=pt(t[e],t[e+1]);return this.index+=2,i}readUint32(){let e=this.index,t=this.uint8array;if(e+4>t.length)throw new RangeError("BinaryStream: read outside of range");let i=wt(t[e],t[e+1],t[e+2],t[e+3]);return this.index+=4,i}readFloat32(){let e=this.index,t=this.uint8array;if(e+4>t.length)throw new RangeError("BinaryStream: read outside of range");let i=vt(t[e],t[e+1],t[e+2],t[e+3]);return this.index+=4,i}readFloat64(){let e=this.index,t=this.uint8array;if(e+8>t.length)throw new RangeError("BinaryStream: read outside of range");let i=yt(t[e],t[e+1],t[e+2],t[e+3],t[e+4],t[e+5],t[e+6],t[e+7]);return this.index+=8,i}readInt8Array(e){ArrayBuffer.isView(e)||(e=new Int8Array(e));let t=this.index,i=this.uint8array;if(t+e.byteLength>i.length)throw new RangeError("BinaryStream: read outside of range");for(let s=0,a=e.length;s<a;s++)e[s]=mt(i[t+s]);return this.index+=e.byteLength,e}readInt16Array(e){ArrayBuffer.isView(e)||(e=new Int16Array(e));let t=this.index,i=this.uint8array;if(t+e.byteLength>i.length)throw new RangeError("BinaryStream: read outside of range");for(let s=0,a=e.length;s<a;s++){let a=t+2*s;e[s]=ft(i[a],i[a+1])}return this.index+=e.byteLength,e}readInt32Array(e){ArrayBuffer.isView(e)||(e=new Int32Array(e));let t=this.index,i=this.uint8array;if(t+e.byteLength>i.length)throw new RangeError("BinaryStream: read outside of range");for(let s=0,a=e.length;s<a;s++){let a=t+4*s;e[s]=ft(i[a],i[a+1],i[a+2],i[a+3])}return this.index+=e.byteLength,e}readUint8Array(e){ArrayBuffer.isView(e)||(e=new Uint8Array(e));let t=this.index,i=this.uint8array;if(t+e.byteLength>i.length)throw new RangeError("BinaryStream: read outside of range");for(let s=0,a=e.length;s<a;s++)e[s]=i[t+s];return this.index+=e.byteLength,e}readUint16Array(e){ArrayBuffer.isView(e)||(e=new Uint16Array(e));let t=this.index,i=this.uint8array;if(t+e.byteLength>i.length)throw new RangeError("BinaryStream: read outside of range");for(let s=0,a=e.length;s<a;s++){let a=t+2*s;e[s]=pt(i[a],i[a+1])}return this.index+=e.byteLength,e}readUint32Array(e){ArrayBuffer.isView(e)||(e=new Uint32Array(e));let t=this.index,i=this.uint8array;if(t+e.byteLength>i.length)throw new RangeError("BinaryStream: read outside of range");for(let s=0,a=e.length;s<a;s++){let a=t+4*s;e[s]=wt(i[a],i[a+1],i[a+2],i[a+3])}return this.index+=e.byteLength,e}readFloat32Array(e){ArrayBuffer.isView(e)||(e=new Float32Array(e));let t=this.index,i=this.uint8array;if(t+e.byteLength>i.length)throw new RangeError("BinaryStream: read outside of range");for(let s=0,a=e.length;s<a;s++){let a=t+4*s;e[s]=vt(i[a],i[a+1],i[a+2],i[a+3])}return this.index+=e.byteLength,e}readFloat64Array(e){ArrayBuffer.isView(e)||(e=new Float64Array(e));let t=this.index,i=this.uint8array;if(t+e.byteLength>i.length)throw new RangeError("BinaryStream: read outside of range");for(let s=0,a=e.length;s<a;s++){let a=t+8*s;e[s]=yt(i[a],i[a+1],i[a+2],i[a+3],i[a+4],i[a+5],i[a+6],i[a+7])}return this.index+=e.byteLength,e}readTypedArray(e){let t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),i=this.index,s=this.uint8array;if(i+t.length>s.length)throw new RangeError("BinaryStream: read outside of range");for(let a=0,r=t.length;a<r;a++)t[a]=s[i+a];this.index+=t.length}write(e){let t=this.index,i=this.uint8array,s=e.length;for(let a=0;a<s;a++)i[t+a]=e.charCodeAt(a);this.index+=s}writeInt8(e){this.uint8array[this.index]=bt(e),this.index+=1}writeInt16(e){let t=this.index,i=this.uint8array;At(It,e),i[t]=It[0],i[t+1]=It[1],this.index+=2}writeInt32(e){let t=this.index,i=this.uint8array;Et(It,e),i[t]=It[0],i[t+1]=It[1],i[t+2]=It[2],i[t+3]=It[3],this.index+=4}writeUint8(e){this.uint8array[this.index]=e,this.index+=1}writeUint16(e){let t=this.index,i=this.uint8array;xt(It,e),i[t]=It[0],i[t+1]=It[1],this.index+=2}writeUint32(e){let t=this.index,i=this.uint8array;Tt(It,e),i[t]=It[0],i[t+1]=It[1],i[t+2]=It[2],i[t+3]=It[3],this.index+=4}writeFloat32(e){let t=this.index,i=this.uint8array;St(It,e),i[t]=It[0],i[t+1]=It[1],i[t+2]=It[2],i[t+3]=It[3],this.index+=4}writeFloat64(e){let t=this.index,i=this.uint8array;_t(It,e),i[t]=It[0],i[t+1]=It[1],i[t+2]=It[2],i[t+3]=It[3],i[t+4]=It[4],i[t+5]=It[5],i[t+6]=It[6],i[t+7]=It[7],this.index+=8}writeInt8Array(e){let t=this.index,i=this.uint8array;for(let s=0,a=e.length;s<a;s++)i[t+s]=bt(e[s]);this.index+=e.byteLength}writeInt16Array(e){let t=this.index,i=this.uint8array;for(let s=0,a=e.length;s<a;s++){let a=t+2*s;At(It,e[s]),i[a]=It[0],i[a+1]=It[1]}this.index+=e.byteLength}writeInt32Array(e){let t=this.index,i=this.uint8array;for(let s=0,a=e.length;s<a;s++){let a=t+4*s;Et(It,e[s]),i[a]=It[0],i[a+1]=It[1],i[a+2]=It[2],i[a+3]=It[3]}this.index+=e.byteLength}writeUint8Array(e){let t=this.index,i=this.uint8array;for(let s=0,a=e.length;s<a;s++)i[t+s]=e[s];this.index+=e.byteLength}writeUint16Array(e){let t=this.index,i=this.uint8array;for(let s=0,a=e.length;s<a;s++){let a=t+2*s;xt(It,e[s]),i[a]=It[0],i[a+1]=It[1]}this.index+=e.byteLength}writeUint32Array(e){let t=this.index,i=this.uint8array;for(let s=0,a=e.length;s<a;s++){let a=t+4*s;Tt(It,e[s]),i[a]=It[0],i[a+1]=It[1],i[a+2]=It[2],i[a+3]=It[3]}this.index+=e.byteLength}writeFloat32Array(e){let t=this.index,i=this.uint8array;for(let s=0,a=e.length;s<a;s++){let a=t+4*s;St(It,e[s]),i[a]=It[0],i[a+1]=It[1],i[a+2]=It[2],i[a+3]=It[3]}this.index+=e.byteLength}writeFloat64Array(e){let t=this.index,i=this.uint8array;for(let s=0,a=e.length;s<a;s++){let a=t+8*s;_t(It,e[s]),i[a]=It[0],i[a+1]=It[1],i[a+2]=It[2],i[a+3]=It[3],i[a+4]=It[4],i[a+5]=It[5],i[a+6]=It[6],i[a+7]=It[7]}this.index+=e.byteLength}writeTypedArray(e){let t=new Uint8Array(e.buffer),i=this.index,s=this.uint8array;for(let a=0,r=t.length;a<r;a++)s[i+a]=t[a]}}class Ct{constructor(){this.id="\0\0\0\0",this.chance=0}load(e){this.id=e.read(4,!0),this.chance=e.readInt32()}save(e){e.write(this.id),e.writeInt32(this.chance)}}class Bt{constructor(){this.items=[]}load(e){for(let t=0,i=e.readUint32();t<i;t++){let t=new Ct;t.load(e),this.items.push(t)}}save(e){e.writeUint32(this.items.length);for(let t of this.items)t.save(e)}getByteLength(){return 4+8*this.items.length}}class Ft{constructor(){this.id="\0\0\0\0",this.variation=0,this.location=new Float32Array(3),this.angle=0,this.scale=new Float32Array([1,1,1]),this.flags=0,this.life=0,this.itemTable=-1,this.itemSets=[],this.editorId=0,this.u1=new Uint8Array(8)}load(e,t){if(this.id=e.read(4,!0),this.variation=e.readInt32(),this.location=e.readFloat32Array(3),this.angle=e.readFloat32(),this.scale=e.readFloat32Array(3),this.flags=e.readUint8(),this.life=e.readUint8(),t>7){this.itemTable=e.readUint32();for(let t=0,i=e.readUint32();t<i;t++){let t=new Bt;t.load(e),this.itemSets.push(t)}}this.editorId=e.readInt32()}save(e,t){if(e.write(this.id),e.writeInt32(this.variation),e.writeFloat32Array(this.location),e.writeFloat32(this.angle),e.writeFloat32Array(this.scale),e.writeUint8(this.flags),e.writeUint8(this.life),t>7){e.writeUint32(this.itemTable),e.writeUint32(this.itemSets.length);for(let t of this.itemSets)t.save(e)}e.writeInt32(this.editorId)}getByteLength(e){let t=42;if(e>7){t+=8;for(let e of this.itemSets)t+=e.getByteLength()}return t}}class Lt{constructor(){this.id="\0\0\0\0",this.variation=0,this.location=new Uint32Array(2)}load(e,t){this.id=e.read(4,!0),this.variation=e.readUint32(),this.location=e.readUint32Array(2)}save(e,t){e.write(this.id),e.writeUint32(this.variation),e.writeUint32Array(this.location)}}class Dt{constructor(e){this.version=0,this.u1=new Uint8Array(4),this.doodads=[],this.u2=new Uint8Array(4),this.terrainDoodads=[],e&&this.load(e)}load(e){let t=new Rt(e);if("W3do"!==t.read(4))return!1;this.version=t.readInt32(),this.u1=t.readUint8Array(4);for(let i=0,s=t.readInt32();i<s;i++){let e=new Ft;e.load(t,this.version),this.doodads.push(e)}this.u2=t.readUint8Array(4);for(let i=0,s=t.readInt32();i<s;i++){let e=new Lt;e.load(t,this.version),this.terrainDoodads.push(e)}return!0}save(){let e=new ArrayBuffer(this.getByteLength()),t=new Rt(e);t.write("W3do"),t.writeInt32(this.version),t.writeUint8Array(this.u1),t.writeUint32(this.doodads.length);for(let i of this.doodads)i.save(t,this.version);t.writeUint8Array(this.u2),t.writeUint32(this.terrainDoodads.length);for(let i of this.terrainDoodads)i.save(t,this.version);return e}getByteLength(){let e=24+16*this.terrainDoodads.length;for(let t of this.doodads)e+=t.getByteLength(this.version);return e}}class Mt{constructor(){this.isCustom=0,this.name=""}load(e){this.isCustom=e.readUint8(),this.name=e.readUntilNull()}save(e){e.writeUint8(this.isCustom),e.write("".concat(this.name,"\0"))}getByteLength(){return 2+this.name.length}}class Ut{constructor(e){this.version=1,this.entries=new Map,e&&this.load(e)}load(e){let t=new Rt(e);this.version=t.readUint32();for(let i=0,s=t.readUint32();i<s;i++){let e=new Mt;e.load(t),e.isCustom?this.entries.set(e.name,e):this.entries.set("war3mapimported\\".concat(e.name),e)}}save(){let e=new ArrayBuffer(this.getByteLength()),t=new Rt(e);t.writeUint32(this.version),t.writeUint32(this.entries.size);for(let i of this.entries.values())i.save(t);return e}getByteLength(){let e=8;for(let t of this.entries.values())e+=t.getByteLength();return e}set(e){if(!this.entries.has(e)){let t=new Mt;return t.isCustom=10,t.path=e,this.entries.set(e,t),!0}return!1}has(e){return this.entries.has(e)}delete(e){return this.entries.delete(e)}rename(e,t){let i=this.entries.get(e);return!!i&&(i.isCustom=10,i.path=t,!0)}}class Pt{constructor(){this.id="\0\0\0\0",this.variableType=0,this.levelOrVariation=0,this.dataPointer=0,this.value=0,this.u1=0}load(e,t){if(this.id=e.read(4,!0),this.variableType=e.readInt32(),t&&(this.levelOrVariation=e.readInt32(),this.dataPointer=e.readInt32()),0===this.variableType)this.value=e.readInt32();else if(1===this.variableType||2===this.variableType)this.value=e.readFloat32();else{if(3!==this.variableType)throw new Error("Modification: unknown variable type ".concat(this.variableType));this.value=e.readUntilNull()}this.u1=e.readInt32()}save(e,t){if(e.write(this.id),e.writeInt32(this.variableType),t&&(e.writeInt32(this.levelOrVariation),e.writeInt32(this.dataPointer)),0===this.variableType)e.writeInt32(this.value);else if(1===this.variableType||2===this.variableType)e.writeFloat32(this.value);else{if(3!==this.variableType)throw new Error("Modification: unknown variable type ".concat(this.variableType));e.write("".concat(this.value,"\0"))}e.writeInt32(this.u1)}getByteLength(e){let t=12;return e&&(t+=8),3===this.variableType?t+=1+this.value.length:t+=4,t}}class kt{constructor(){this.oldId="\0\0\0\0",this.newId="\0\0\0\0",this.modifications=[]}load(e,t){this.oldId=e.read(4,!0),this.newId=e.read(4,!0);for(let i=0,s=e.readUint32();i<s;i++){let s=new Pt;s.load(e,t),this.modifications[i]=s}}save(e,t){this.oldId?e.write(this.oldId):e.writeUint32(0),this.newId?e.write(this.newId):e.writeUint32(0),e.writeUint32(this.modifications.length);for(let i of this.modifications)i.save(e,t)}getByteLength(e){let t=12;for(let i of this.modifications)t+=i.getByteLength(e);return t}}class Nt{constructor(){this.objects=[]}load(e,t){for(let i=0,s=e.readUint32();i<s;i++){let s=new kt;s.load(e,t),this.objects[i]=s}}save(e,t){e.writeUint32(this.objects.length);for(let i of this.objects)i.save(e,t)}getByteLength(e){let t=4;for(let i of this.objects)t+=i.getByteLength(e);return t}}class Ot{constructor(e){this.version=0,this.originalTable=new Nt,this.customTable=new Nt,e&&this.load(e)}load(e){let t=new Rt(e);this.version=t.readInt32(),this.originalTable.load(t,!0),this.customTable.load(t,!0)}save(){let e=new ArrayBuffer(this.getByteLength()),t=new Rt(e);return t.writeInt32(this.version),this.originalTable.save(t,!0),this.customTable.save(t,!0),e}getByteLength(){return 4+this.originalTable.getByteLength(!0)+this.customTable.getByteLength(!0)}}class jt{constructor(){this.groundHeight=0,this.waterHeight=0,this.mapEdge=0,this.ramp=0,this.blight=0,this.water=0,this.boundary=0,this.groundTexture=0,this.cliffVariation=0,this.groundVariation=0,this.cliffTexture=0,this.layerHeight=0}load(e){this.groundHeight=(e.readInt16()-8192)/512;let t=e.readInt16();this.waterHeight=((16383&t)-8192)/512,this.mapEdge=16384&t;let i=e.readUint8();this.ramp=16&i,this.blight=32&i,this.water=64&i,this.boundary=128&i,this.groundTexture=15&i;let s=e.readUint8();this.cliffVariation=(224&s)>>>5,this.groundVariation=31&s;let a=e.readUint8();this.cliffTexture=(240&a)>>>4,this.layerHeight=15&a}save(e){e.writeInt16(512*this.groundHeight+8192),e.writeInt16(512*this.waterHeight+8192+this.mapEdge<<14),e.writeUint8(this.ramp<<4|this.blight<<5|this.water<<6|this.boundary<<7|this.groundTexture),e.writeUint8(this.cliffVariation<<5|this.groundVariation),e.writeUint8((this.cliffTexture<<4)+this.layerHeight)}}class Vt{constructor(e){this.version=0,this.tileset="A",this.haveCustomTileset=0,this.groundTilesets=[],this.cliffTilesets=[],this.mapSize=new Int32Array(2),this.centerOffset=new Float32Array(2),this.corners=[],e instanceof ArrayBuffer&&this.load(e)}load(e){let t=new Rt(e);if("W3E!"!==t.read(4))return!1;this.version=t.readInt32(),this.tileset=t.read(1),this.haveCustomTileset=t.readInt32();for(let a=0,r=t.readInt32();a<r;a++)this.groundTilesets[a]=t.read(4);for(let a=0,r=t.readInt32();a<r;a++)this.cliffTilesets[a]=t.read(4);this.mapSize=t.readInt32Array(2),this.centerOffset=t.readFloat32Array(2);let[i,s]=this.mapSize;for(let a=0;a<s;a++){this.corners[a]=[];for(let e=0;e<i;e++){let i=new jt;i.load(t),this.corners[a][e]=i}}return!0}save(){let e=new ArrayBuffer(this.getByteLength()),t=new Rt(e);t.write("W3E!"),t.writeInt32(this.version),t.write(this.tileset),t.writeInt32(this.haveCustomTileset),t.writeUint32(this.groundTilesets.length);for(let i of this.groundTilesets)t.write(i);t.writeUint32(this.cliffTilesets.length);for(let i of this.cliffTilesets)t.write(i);t.writeInt32Array(this.mapSize),t.writeFloat32Array(this.centerOffset);for(let i of this.corners)for(let e of i)e.save(t);return e}getByteLength(){return 37+4*this.groundTilesets.length+4*this.cliffTilesets.length+this.mapSize[0]*this.mapSize[1]*7}}class Gt{constructor(){this.id=0,this.type=0,this.race=0,this.isFixedStartPosition=0,this.name="",this.startLocation=new Float32Array(2),this.allyLowPriorities=0,this.allyHighPriorities=0}load(e){this.id=e.readInt32(),this.type=e.readInt32(),this.race=e.readInt32(),this.isFixedStartPosition=e.readInt32(),this.name=e.readUntilNull(),this.startLocation=e.readFloat32Array(2),this.allyLowPriorities=e.readUint32(),this.allyHighPriorities=e.readUint32()}save(e){e.writeInt32(this.id),e.writeInt32(this.type),e.writeInt32(this.race),e.writeInt32(this.isFixedStartPosition),e.write("".concat(this.name,"\0")),e.writeFloat32Array(this.startLocation),e.writeUint32(this.allyLowPriorities),e.writeUint32(this.allyHighPriorities)}getByteLength(){return 33+this.name.length}}class Ht{constructor(){this.flags=0,this.playerMasks=0,this.name=""}load(e){this.flags=e.readUint32(),this.playerMasks=e.readUint32(),this.name=e.readUntilNull()}save(e){e.writeUint32(this.flags),e.writeUint32(this.playerMasks),e.write("".concat(this.name,"\0"))}getByteLength(){return 9+this.name.length}}class Kt{constructor(){this.playerFlags=0,this.id="\0\0\0\0",this.levelAffected=0,this.availability=0}load(e){this.playerFlags=e.readUint32(),this.id=e.read(4,!0),this.levelAffected=e.readInt32(),this.availability=e.readInt32()}save(e){e.writeUint32(this.playerFlags),e.write(this.id),e.writeInt32(this.levelAffected),e.writeInt32(this.availability)}}class qt{constructor(){this.playerFlags=0,this.id="\0\0\0\0"}load(e){this.playerFlags=e.readUint32(),this.id=e.read(4,!0)}save(e){e.writeUint32(this.playerFlags),e.write(this.id)}}class Wt{constructor(){this.chance=0,this.ids=[]}load(e,t){this.chance=e.readInt32();for(let i=0;i<t;i++)this.ids[i]=e.read(4,!0)}save(e){e.writeInt32(this.chance);for(let t of this.ids)e.write(t)}}class Xt{constructor(){this.id=0,this.name="",this.positions=0,this.columnTypes=new Int32Array(1),this.units=[]}load(e){this.id=e.readInt32(),this.name=e.readUntilNull(),this.positions=e.readInt32(),this.columnTypes=e.readInt32Array(this.positions);for(let t=0,i=e.readUint32();t<i;t++){let i=new Wt;i.load(e,this.positions),this.units[t]=i}}save(e){e.writeInt32(this.id),e.write("".concat(this.name,"\0")),e.writeInt32(this.positions),e.writeInt32Array(this.columnTypes),e.writeUint32(this.units.length);for(let t of this.units)t.save(e)}getByteLength(){return 13+this.name.length+this.columnTypes.byteLength+this.units.length*(4+4*this.positions)}}class zt{constructor(){this.chance=0,this.id="\0\0\0\0"}load(e){this.chance=e.readInt32(),this.id=e.read(4,!0)}save(e){e.writeInt32(this.chance),e.write(this.id)}}class Yt{constructor(){this.items=[]}load(e){for(let t=0,i=e.readUint32();t<i;t++){let i=new zt;i.load(e),this.items[t]=i}}save(e){e.writeUint32(this.items.length);for(let t of this.items)t.save(e)}getByteLength(){return 4+8*this.items.length}}class Jt{constructor(){this.id=0,this.name="",this.sets=[]}load(e){this.id=e.readInt32(),this.name=e.readUntilNull();for(let t=0,i=e.readUint32();t<i;t++){let i=new Yt;i.load(e),this.sets[t]=i}}save(e){e.writeInt32(this.id),e.write("".concat(this.name,"\0")),e.writeUint32(this.sets.length);for(let t of this.sets)t.save(e)}getByteLength(){let e=9+this.name.length;for(let t of this.sets)e+=t.getByteLength();return e}}class Zt{constructor(e){this.version=0,this.saves=0,this.editorVersion=0,this.name="",this.author="",this.description="",this.recommendedPlayers="",this.cameraBounds=new Float32Array(8),this.cameraBoundsComplements=new Int32Array(4),this.playableSize=new Int32Array(2),this.flags=0,this.tileset="\0",this.campaignBackground=0,this.loadingScreenModel="",this.loadingScreenText="",this.loadingScreenTitle="",this.loadingScreenSubtitle="",this.loadingScreen=0,this.prologueScreenModel="",this.prologueScreenText="",this.prologueScreenTitle="",this.prologueScreenSubtitle="",this.useTerrainFog=0,this.fogHeight=new Float32Array(2),this.fogDensity=0,this.fogColor=new Uint8Array(4),this.globalWeather=0,this.soundEnvironment="",this.lightEnvironmentTileset="\0",this.waterVertexColor=new Uint8Array(4),this.players=[],this.forces=[],this.upgradeAvailabilityChanges=[],this.techAvailabilityChanges=[],this.randomUnitTables=[],this.randomItemTables=[],e&&this.load(e)}load(e){let t=new Rt(e);this.version=t.readInt32(),this.saves=t.readInt32(),this.editorVersion=t.readInt32(),this.version>=27&&(this.gameVersionMajor=t.readInt32(),this.gameVersionMinor=t.readInt32(),this.gameVersionPatch=t.readInt32(),this.gameVersionBuild=t.readInt32()),this.name=t.readUntilNull(),this.author=t.readUntilNull(),this.description=t.readUntilNull(),this.recommendedPlayers=t.readUntilNull(),this.cameraBounds=t.readFloat32Array(8),this.cameraBoundsComplements=t.readInt32Array(4),this.playableSize=t.readInt32Array(2),this.flags=t.readUint32(),this.tileset=t.read(1),this.campaignBackground=t.readInt32(),this.version>24&&(this.loadingScreenModel=t.readUntilNull()),this.loadingScreenText=t.readUntilNull(),this.loadingScreenTitle=t.readUntilNull(),this.loadingScreenSubtitle=t.readUntilNull(),this.loadingScreen=t.readInt32(),this.version>24&&(this.prologueScreenModel=t.readUntilNull()),this.prologueScreenText=t.readUntilNull(),this.prologueScreenTitle=t.readUntilNull(),this.prologueScreenSubtitle=t.readUntilNull(),this.version>24&&(this.useTerrainFog=t.readInt32(),this.fogHeight=t.readFloat32Array(2),this.fogDensity=t.readFloat32(),this.fogColor=t.readUint8Array(4),this.globalWeather=t.readInt32(),this.soundEnvironment=t.readUntilNull(),this.lightEnvironmentTileset=t.read(1,!0),this.waterVertexColor=t.readUint8Array(4)),this.version>=27&&(this.lua=t.readInt32());for(let i=0,s=t.readInt32();i<s;i++){let e=new Gt;e.load(t),this.players[i]=e}for(let i=0,s=t.readInt32();i<s;i++){let e=new Ht;e.load(t),this.forces[i]=e}if(t.index!=t.byteLength-1){for(let e=0,i=t.readInt32();e<i;e++){let i=new Kt;i.load(t),this.upgradeAvailabilityChanges[e]=i}if(!(t.index>=t.byteLength-1)){for(let e=0,i=t.readInt32();e<i;e++){let i=new qt;i.load(t),this.techAvailabilityChanges[e]=i}for(let e=0,i=t.readInt32();e<i;e++){let i=new Xt;i.load(t),this.randomUnitTables[e]=i}if(this.version>24)for(let e=0,i=t.readInt32();e<i;e++){let i=new Jt;i.load(t),this.randomItemTables[e]=i}}}}save(){let e=new ArrayBuffer(this.getByteLength()),t=new Rt(e);t.writeInt32(this.version),t.writeInt32(this.saves),t.writeInt32(this.editorVersion),t.write("".concat(this.name,"\0")),t.write("".concat(this.author,"\0")),t.write("".concat(this.description,"\0")),t.write("".concat(this.recommendedPlayers,"\0")),t.writeFloat32Array(this.cameraBounds),t.writeInt32Array(this.cameraBoundsComplements),t.writeInt32Array(this.playableSize),t.writeUint32(this.flags),t.write(this.tileset),t.writeInt32(this.campaignBackground),this.version>24&&t.write("".concat(this.loadingScreenModel,"\0")),t.write("".concat(this.loadingScreenText,"\0")),t.write("".concat(this.loadingScreenTitle,"\0")),t.write("".concat(this.loadingScreenSubtitle,"\0")),t.writeInt32(this.loadingScreen),this.version>24&&t.write("".concat(this.prologueScreenModel,"\0")),t.write("".concat(this.prologueScreenText,"\0")),t.write("".concat(this.prologueScreenTitle,"\0")),t.write("".concat(this.prologueScreenSubtitle,"\0")),this.version>24&&(t.writeInt32(this.useTerrainFog),t.writeFloat32Array(this.fogHeight),t.writeFloat32(this.fogDensity),t.writeUint8Array(this.fogColor),t.writeInt32(this.globalWeather),t.write("".concat(this.soundEnvironment,"\0")),t.write(this.lightEnvironmentTileset),t.writeUint8Array(this.waterVertexColor)),t.writeUint32(this.players.length);for(let i of this.players)i.save(t);t.writeUint32(this.forces.length);for(let i of this.forces)i.save(t);t.writeUint32(this.upgradeAvailabilityChanges.length);for(let i of this.upgradeAvailabilityChanges)i.save(t);t.writeUint32(this.techAvailabilityChanges.length);for(let i of this.techAvailabilityChanges)i.save(t);t.writeUint32(this.randomUnitTables.length);for(let i of this.randomUnitTables)i.save(t);if(this.version>24){t.writeUint32(this.randomItemTables.length);for(let e of this.randomItemTables)e.save(t)}return e}getByteLength(){let e=111+this.name.length+this.author.length+this.description.length+this.recommendedPlayers.length+this.loadingScreenText.length+this.loadingScreenTitle.length+this.loadingScreenSubtitle.length+this.prologueScreenText.length+this.prologueScreenTitle.length+this.prologueScreenSubtitle.length;for(let t of this.players)e+=t.getByteLength();for(let t of this.forces)e+=t.getByteLength();e+=16*this.upgradeAvailabilityChanges.length,e+=8*this.techAvailabilityChanges.length;for(let t of this.randomUnitTables)e+=t.getByteLength();if(this.version>24){e+=36+this.loadingScreenModel.length+this.prologueScreenModel.length+this.soundEnvironment.length;for(let t of this.randomItemTables)e+=t.getByteLength()}return e}}class $t{constructor(e){this.version=0,this.originalTable=new Nt,this.customTable=new Nt,e&&this.load(e)}load(e){let t=new Rt(e);this.version=t.readInt32(),this.originalTable.load(t,!1),this.customTable.load(t,!1)}save(){let e=new ArrayBuffer(this.getByteLength()),t=new Rt(e);return t.writeInt32(this.version),this.originalTable.save(t,!1),this.customTable.save(t,!1),e}getByteLength(){return 4+this.originalTable.getByteLength(!1)+this.customTable.getByteLength(!1)}}class Qt{constructor(){this.text=""}load(e){let t=e.readInt32();t&&(this.text=e.read(t-1),e.skip(1))}save(e){this.text.length?(e.writeInt32(this.text.length+1),e.write("".concat(this.text,"\0"))):e.writeInt32(0)}getByteLength(){let e=4;return this.text.length&&(e+=this.text.length+1),e}}class ei{constructor(e){this.version=0,this.comment="",this.trigger=null,this.triggers=[],e&&this.load(e)}load(e){let t=new Rt(e);if(this.version=t.readInt32(),1===this.version){this.comment=t.readUntilNull();let e=new Qt;e.load(t),this.trigger=e}for(let i=0,s=t.readUint32();i<s;i++){let e=new Qt;e.load(t),this.triggers[i]=e}}save(){let e=new ArrayBuffer(this.getByteLength()),t=new Rt(e);t.writeInt32(this.version),1===this.version&&(t.write("".concat(this.comment,"\0")),this.trigger.save(t)),t.writeUint32(this.triggers.length);for(let i of this.triggers)i.save(t);return e}getByteLength(){let e=8;1===this.version&&(e+=this.comment.length+1+this.trigger.getByteLength());for(let t of this.triggers)e+=t.getByteLength();return e}}class ti{constructor(){this.id=0,this.name="",this.isComment=0}load(e,t){this.id=e.readInt32(),this.name=e.readUntilNull(),7===t&&(this.isComment=e.readInt32())}save(e,t){e.writeInt32(this.id),e.write("".concat(this.name,"\0")),7===t&&e.writeInt32(this.isComment)}getByteLength(e){let t=5+this.name.length;return 7===e&&(t+=4),t}}class ii{constructor(){this.name="",this.type="",this.u1=0,this.isArray=0,this.arraySize=0,this.isInitialized=0,this.initialValue=""}load(e,t){this.name=e.readUntilNull(),this.type=e.readUntilNull(),this.u1=e.readInt32(),this.isArray=e.readInt32(),7===t&&(this.arraySize=e.readInt32()),this.isInitialized=e.readInt32(),this.initialValue=e.readUntilNull()}save(e,t){e.write("".concat(this.name,"\0")),e.write("".concat(this.type,"\0")),e.writeInt32(this.u1),e.writeInt32(this.isArray),7===t&&e.writeInt32(this.arraySize),e.writeInt32(this.isInitialized),e.write("".concat(this.initialValue,"\0"))}getByteLength(e){let t=15+this.name.length+this.type.length+this.initialValue.length;return 7===e&&(t+=4),t}}class si{constructor(){this.type=0,this.name="",this.beginParameters=0,this.parameters=[]}load(e,t,i){if(this.type=e.readInt32(),this.name=e.readUntilNull(),this.beginParameters=e.readInt32(),this.beginParameters){for(let s=0,a=i.getFunction(this.type,this.name).args.length;s<a;s++){let a=new ai;a.load(e,t,i),this.parameters[s]=a}}}save(e,t){e.writeInt32(this.type),e.write("".concat(this.name,"\0")),e.writeInt32(this.beginParameters);for(let i of this.parameters)i.save(e,t)}getByteLength(e){let t=9+this.name.length;if(this.parameters.length)for(let i of this.parameters)t+=i.getByteLength(e);return t}}class ai{constructor(){this.type=0,this.value="",this.subParameters=null,this.u1=0,this.isArray=0,this.arrayIndex=null}load(e,t,i){if(this.type=e.readInt32(),this.value=e.readUntilNull(),e.readInt32()){let s=new si;s.load(e,t,i),this.subParameters=s}if((4===t&&2===this.type||7===t&&this.subParameters)&&(this.u1=e.readInt32()),(4===t&&2!==this.type||7===t)&&(this.isArray=e.readInt32()),this.isArray){let s=new ai;s.load(e,t,i),this.arrayIndex=s}}save(e,t){e.writeInt32(this.type),e.write("".concat(this.value,"\0")),this.subParameters?(e.writeInt32(1),this.subParameters.save(e,t)):e.writeInt32(0),(4===t&&2===this.type||7===t&&this.subParameters)&&e.writeInt32(this.u1),(4===t&&2!==this.type||7===t)&&e.writeInt32(this.isArray),this.isArray&&this.arrayIndex.save(e,t)}getByteLength(e){let t=9+this.value.length;return this.subParameters&&(t+=this.subParameters.getByteLength(e)),(4===e&&2===this.type||7===e&&this.subParameters)&&(t+=4),(4===e&&2!==this.type||7===e)&&(t+=4),this.isArray&&(t+=this.arrayIndex.getByteLength(e)),t}}class ri{constructor(){this.type=-1,this.group=-1,this.name="",this.isEnabled=0,this.parameters=[],this.ecas=[]}load(e,t,i,s){this.type=e.readInt32(),i&&(this.group=e.readUint32()),this.name=e.readUntilNull(),this.isEnabled=e.readInt32();for(let a=0,r=s.getFunction(this.type,this.name).args.length;a<r;a++){let i=new ai;i.load(e,t,s),this.parameters[a]=i}if(7===t)for(let a=0,r=e.readUint32();a<r;a++){let i=new ri;i.load(e,t,!0,s),this.ecas[a]=i}}save(e,t){e.writeInt32(this.type),-1!==this.group&&e.writeInt32(this.group),e.write("".concat(this.name,"\0")),e.writeInt32(this.isEnabled);for(let i of this.parameters)i.save(e,t);if(7===t){e.writeUint32(this.ecas.length);for(let i of this.ecas)i.save(e,t)}}getByteLength(e){let t=9+this.name.length;-1!==this.group&&(t+=4);for(let i of this.parameters)t+=i.getByteLength(e);if(7===e){t+=4;for(let i of this.ecas)t+=i.getByteLength(e)}return t}}class ni{constructor(){this.name="",this.description="",this.isComment=0,this.isEnabled=0,this.isCustom=0,this.isInitiallyOff=0,this.runOnInitialization=0,this.category=0,this.ecas=[]}load(e,t,i){this.name=e.readUntilNull(),this.description=e.readUntilNull(),7===t&&(this.isComment=e.readInt32()),this.isEnabled=e.readInt32(),this.isCustomText=e.readInt32(),this.isInitiallyOff=e.readInt32(),this.runOnInitialization=e.readInt32(),this.category=e.readInt32();for(let s=0,a=e.readUint32();s<a;s++){let a=new ri;a.load(e,t,!1,i),this.ecas[s]=a}}save(e,t){e.write("".concat(this.name,"\0")),e.write("".concat(this.description,"\0")),7===t&&e.writeInt32(this.isComment),e.writeInt32(this.isEnabled),e.writeInt32(this.isCustomText),e.writeInt32(this.isInitiallyOff),e.writeInt32(this.runOnInitialization),e.writeInt32(this.category),e.writeUint32(this.ecas.length);for(let i of this.ecas)i.save(e,t)}getByteLength(e){let t=26+this.name.length+this.description.length;7===e&&(t+=4);for(let i of this.ecas)t+=i.getByteLength(e);return t}}class oi{constructor(e,t){this.version=0,this.categories=[],this.u1=0,this.variables=[],this.triggers=[],e&&this.load(e,t)}load(e,t){let i=new Rt(e);if("WTG!"!==i.read(4))throw new Error("Not a WTG file");this.version=i.readInt32();for(let s=0,a=i.readUint32();s<a;s++){let e=new ti;e.load(i,this.version),this.categories[s]=e}this.u1=i.readInt32();for(let s=0,a=i.readUint32();s<a;s++){let e=new ii;e.load(i,this.version),this.variables[s]=e}for(let s=0,a=i.readUint32();s<a;s++){let e=new ni;e.load(i,this.version,t),this.triggers[s]=e}}save(){let e=new ArrayBuffer(this.getByteLength()),t=new Rt(e);t.write("WTG!"),t.writeInt32(this.version),t.writeUint32(this.categories.length);for(let i of this.categories)i.save(t,this.version);t.writeInt32(this.u1),t.writeUint32(this.variables.length);for(let i of this.variables)i.save(t,this.version);t.writeUint32(this.triggers.length);for(let i of this.triggers)i.save(t,this.version);return e}getByteLength(){let e=24;for(let t of this.categories)e+=t.getByteLength(this.version);for(let t of this.variables)e+=t.getByteLength(this.version);for(let t of this.triggers)e+=t.getByteLength(this.version);return e}}class li{constructor(e){if(this.buffer=e||"",this.index=0,this.ident=0,this.fractionDigits=6,this.decoder=new TextDecoder("utf-8"),this.buffer instanceof ArrayBuffer){let t=new DataView(e);this.length=e.byteLength/4,this.accessPosition=(e=>t.getUint8(e))}else this.length=e.length,this.accessPosition=(t=>e[t])}readUntil(e,t){this.index=t;let i="",s=[];for(;this.index<this.length;){let t=this.accessPosition(this.index++),a=String.fromCharCode(t);if(a==e)return this.decoder.decode(new Uint8Array(s));i+=a,s.push(t)}return this.decoder.decode(new Uint8Array(s))}read(){let e=this.length,t=!1,i=!1,s="";for(;this.index<e;){let e=this.accessPosition(this.index++);if(e=String.fromCharCode(e),t)"\n"===e&&(t=!1);else if(i){if('"'===e)return s;s+=e}else if(" "===e||","===e||"\t"===e||"\n"===e||":"===e||"\r"===e){if(s.length)return s}else{if("{"===e||"}"===e)return s.length?(this.index--,s):e;if("/"===e&&"/"===this.accessPosition(this.index)){if(s.length)return this.index--,s;t=!0}else if('"'===e){if(s.length)return this.index--,s;i=!0}else s+=e}}}peek(){let e=this.index,t=this.read();return this.index=e,t}readInt(){return parseInt(this.read())}readFloat(){return parseFloat(this.read())}readKeyframe(e){1===e.length?e instanceof Float32Array?e[0]=this.readFloat():e[0]=this.readInt():this.readTypedArray(e)}readIntArray(e){this.read();for(let t=0,i=e.length;t<i;t++)e[t]=this.readInt();return this.read(),e}readFloatArray(e){this.read();for(let t=0,i=e.length;t<i;t++)e[t]=this.readFloat();return this.read(),e}readTypedArray(e){e instanceof Float32Array?this.readFloatArray(e):this.readIntArray(e)}readColor(e){this.read(),e[2]=this.readFloat(),e[1]=this.readFloat(),e[0]=this.readFloat(),this.read()}readVectorArray(e,t){this.read();for(let i=0,s=e.length/t;i<s;i++){this.read();for(let s=0;s<t;s++)e[i*t+s]=this.readFloat();this.read()}return this.read(),e}*readBlock(){this.read();let e=this.read();for(;"}"!==e;)yield e,e=this.read()}writeColor(e,t){this.writeLine("".concat(e," { ").concat(t[2],", ").concat(t[1],", ").concat(t[0]," },"))}writeFlag(e){this.writeLine("".concat(e,","))}writeAttrib(e,t){this.writeLine("".concat(e," ").concat(t,","))}writeFloatAttrib(e,t){this.writeLine("".concat(e," ").concat(this.formatFloat(t),","))}writeStringAttrib(e,t){this.writeLine("".concat(e,' "').concat(t,'",'))}writeArrayAttrib(e,t){this.writeLine("".concat(e," { ").concat(t.join(", ")," },"))}writeFloatArrayAttrib(e,t){this.writeLine("".concat(e," { ").concat(this.formatFloatArray(t)," },"))}writeTypedArrayAttrib(e,t){t instanceof Float32Array?this.writeFloatArrayAttrib(e,t):this.writeArrayAttrib(e,t)}writeKeyframe(e,t){1===t.length?t instanceof Float32Array?this.writeFloatAttrib(e,t[0]):this.writeAttrib(e,t[0]):this.writeTypedArrayAttrib(e,t)}writeArray(e){this.writeLine("{ ".concat(e.join(", ")," },"))}writeFloatArray(e){this.writeLine("{ ".concat(this.formatFloatArray(e)," },"))}writeVectorArray(e,t,i){this.startBlock(e,t.length/i);for(let s=0,a=t.length;s<a;s+=i)this.writeFloatArray(t.subarray(s,s+i));this.endBlock()}write(e){this.buffer+=e}writeLine(e){this.buffer+="".concat("\t".repeat(this.ident)).concat(e,"\n")}startBlock(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];t.length?this.writeLine("".concat(t.join(" ")," {")):this.writeLine("{"),this.ident+=1}startObjectBlock(e,t){this.writeLine("".concat(e,' "').concat(t,'" {')),this.ident+=1}endBlock(){this.ident-=1,this.writeLine("}")}endBlockComma(){this.ident-=1,this.writeLine("},")}indent(){this.ident+=1}unindent(){this.ident-=1}formatFloat(e){let t=e.toString(),i=e.toFixed(this.fractionDigits);return t.length>i.length?i:t}formatFloatArray(e){let t=[];for(let i=0,s=e.length;i<s;i++)t[i]=this.formatFloat(e[i]);return t.join(", ")}}class hi{constructor(e){this.stringMap=new Map,e&&this.load(e)}load(e){let t,i=new li(e);for(i.index+=3;t=i.read();)if("STRING"===t){let e=i.readInt();i.read();let t=i.readUntil("}",i.index).trim();this.stringMap.set(e,t)}}save(){let e="\xef\xbb\xbf";for(let[t,i]of this.stringMap)e+="STRING ".concat(t,"\n{\n").concat(i,"\n}\n");return e}}class ci{constructor(){this.id="\0\0\0\0",this.chance=0}load(e){this.id=e.read(4,!0),this.chance=e.readInt32()}save(e){e.write(this.id),e.writeInt32(this.chance)}}class di{constructor(){this.items=[]}load(e){for(let t=0,i=e.readInt32();t<i;t++){let i=new ci;i.load(e),this.items[t]=i}}save(e){e.writeInt32(this.items.length);for(let t of this.items)t.save(e)}getByteLength(){return 4+8*this.items.length}}class ui{constructor(){this.slot=0,this.id="\0\0\0\0"}load(e){this.slot=e.readInt32(),this.id=e.read(4,!0)}save(e){e.writeInt32(this.slot),e.write(this.id)}}class mi{constructor(){this.id="\0\0\0\0",this.activeForAutocast=0,this.heroLevel=1}load(e){this.id=e.read(4,!0),this.activeForAutocast=e.readInt32(),this.heroLevel=e.readInt32()}save(e){e.write(this.id),e.writeInt32(this.activeForAutocast),e.writeInt32(this.heroLevel)}}class fi{constructor(){this.id="\0\0\0\0",this.chance=0}load(e){this.id=e.read(4,!0),this.chance=e.readInt32()}save(e){e.write(this.id),e.writeInt32(this.chance)}}class pi{constructor(){this.id="\0\0\0\0",this.variation=0,this.location=new Float32Array(3),this.angle=0,this.scale=new Float32Array([1,1,1]),this.flags=0,this.player=0,this.unknown=0,this.hitpoints=-1,this.mana=-1,this.droppedItemTable=-1,this.droppedItemSets=[],this.goldAmount=0,this.targetAcquisition=0,this.heroLevel=0,this.heroStrength=0,this.heroAgility=0,this.heroIntelligence=0,this.itemsInInventory=[],this.modifiedAbilities=[],this.randomFlag=0,this.level=new Uint8Array(3),this.itemClass=0,this.unitGroup=0,this.positionInGroup=0,this.randomUnitTables=[],this.customTeamColor=0,this.waygate=0,this.creationNumber=0}load(e,t){this.id=e.read(4,!0),this.variation=e.readInt32(),this.location=e.readFloat32Array(3),this.angle=e.readFloat32(),this.scale=e.readFloat32Array(3),this.flags=e.readUint8(),this.player=e.readInt32(),this.unknown=e.readUint16(),this.hitpoints=e.readInt32(),this.mana=e.readInt32(),t>7&&(this.droppedItemTable=e.readInt32());for(let i=0,s=e.readInt32();i<s;i++){let t=new di;t.load(e),this.droppedItemSets[i]=t}this.goldAmount=e.readInt32(),this.targetAcquisition=e.readFloat32(),this.heroLevel=e.readInt32(),t>7&&(this.heroStrength=e.readInt32(),this.heroAgility=e.readInt32(),this.heroIntelligence=e.readInt32());for(let i=0,s=e.readInt32();i<s;i++){let t=new ui;t.load(e),this.itemsInInventory[i]=t}for(let i=0,s=e.readInt32();i<s;i++){let t=new mi;t.load(e),this.modifiedAbilities[i]=t}if(this.randomFlag=e.readInt32(),0===this.randomFlag)this.level=e.readUint8Array(3),this.itemClass=e.readUint8();else if(1===this.randomFlag)this.unitGroup=e.readUint32(),this.positionInGroup=e.readUint32();else if(2===this.randomFlag)for(let i=0,s=e.readInt32();i<s;i++){let t=new fi;t.load(e),this.randomUnitTables[i]=t}this.customTeamColor=e.readInt32(),this.waygate=e.readInt32(),this.creationNumber=e.readInt32()}save(e,t){e.write(this.id),e.writeInt32(this.variation),e.writeFloat32Array(this.location),e.writeFloat32(this.angle),e.writeFloat32Array(this.scale),e.writeUint8(this.flags),e.writeInt32(this.player),e.writeUint16(this.unknown),e.writeInt32(this.hitpoints),e.writeInt32(this.mana),t>7&&e.writeInt32(this.droppedItemTable),e.writeInt32(this.droppedItemSets.length);for(let i of this.droppedItemSets)i.save(e);e.writeInt32(this.goldAmount),e.writeFloat32(this.targetAcquisition),e.writeInt32(this.heroLevel),t>7&&(e.writeInt32(this.heroStrength),e.writeInt32(this.heroAgility),e.writeInt32(this.heroIntelligence)),e.writeInt32(this.itemsInInventory.length);for(let i of this.itemsInInventory)i.save(e);e.writeInt32(this.modifiedAbilities.length);for(let i of this.modifiedAbilities)i.save(e);if(e.writeInt32(this.randomFlag),0===this.randomFlag)e.writeUint8Array(this.level),e.writeUint8(this.itemClass);else if(1===this.randomFlag)e.writeUint32(this.unitGroup),e.writeUint32(this.positionInGroup);else if(2===this.randomFlag){e.writeInt32(this.randomUnitTables.length);for(let t of this.randomUnitTables)t.save(e)}e.writeInt32(this.customTeamColor),e.writeInt32(this.waygate),e.writeInt32(this.creationNumber)}getByteLength(e){let t=91;e>7&&(t+=16);for(let i of this.droppedItemSets)t+=i.getByteLength();return t+=8*this.itemsInInventory.length,t+=12*this.modifiedAbilities.length,0===this.randomFlag?t+=4:1===this.randomFlag?t+=8:2===this.randomFlag&&(t+=4+8*this.randomUnitTables.length),t}}class gi{constructor(e){this.version=8,this.unknown=11,this.units=[],e&&this.load(e)}load(e){let t=new Rt(e);if("W3do"!==t.read(4))return!1;this.version=t.readInt32(),this.unknown=t.readUint32();for(let s=0,a=t.readInt32();s<a;s++){let e=new pi;e.load(t,this.version),this.units[s]=e}let i=new Set;return this.units.forEach(e=>{e.droppedItemSets.forEach(e=>e.items.forEach(e=>i.add(e.id)))}),console.log(i),!0}save(){let e=new ArrayBuffer(this.getByteLength()),t=new Rt(e);t.write("W3do"),t.writeInt32(this.version),t.writeUint32(this.unknown),t.writeInt32(this.units.length);for(let i of this.units)i.save(t,this.version);return e}getByteLength(){let e=16;for(let t of this.units)e+=t.getByteLength(this.version);return e}}class wi{constructor(e,t){this.unknown=0,this.name="",this.flags=0,this.maxPlayers=0,this.imports=new Ut,this.readonly=!!t,e&&this.load(e)}load(e){return this.name=e.name,this.archive={getFileNames:()=>e.listFile().split("\n").filter(e=>e.length>0),get(t){const i=e.binary(t);return i?{name:t,arrayBuffer:()=>i.data.buffer}:i}},!0}save(){if(this.readonly)return null;this.setImportsFile();let e=this.archive.save(),t=new ArrayBuffer(512+e.byteLength),i=new Uint8Array(t),s=new Rt(t);return s.write("HM3W"),s.writeUint32(this.u1),s.write("".concat(this.name,"\0")),s.writeUint32(this.flags),s.writeUint32(this.maxPlayers),i.set(new Uint8Array(e),512),t}getFileNames(){return this.archive.getFileNames()}getImportNames(){let e=[];for(let t of this.imports.entries.values()){let i=t.isCustom;10===i||13===i?e.push(t.name):e.push("war3mapImported\\".concat(t.name))}return e}setImportsFile(){return!this.readonly&&(this.imports.entries.size>0&&this.set("war3map.imp",this.imports.save()))}import(e,t){return!this.readonly&&(!!this.archive.set(e,t)&&(this.imports.set(e),!0))}set(e,t){return!this.readonly&&this.archive.set(e,t)}get(e){return this.archive.get(e)}getScript(){return(this.get("war3map.j")||this.get("scripts\\war3map.j")).text()}has(e){return this.archive.has(e)}delete(e){return!this.readonly&&(this.imports.delete(e),this.archive.delete(e))}rename(e,t){return!this.readonly&&(!!this.archive.rename(e,t)&&(this.imports.rename(e,t),!0))}readHelper(e,t){let i=this.archive.get(e);if(i){let e=i.arrayBuffer();return e?new t(e):null}}readImports(){let e=this.archive.get("war3map.imp");if(e){let t=e.arrayBuffer();t&&this.imports.load(t)}}readMapInformation(){return this.readHelper("war3map.w3i",Zt)}readEnvironment(){return this.readHelper("war3map.w3e",Vt)}readDoodads(){let e=this.archive.get("war3map.doo");if(e)return new Dt(e.arrayBuffer())}readUnits(){let e=this.archive.get("war3mapUnits.doo");if(e)return new gi(e.arrayBuffer())}readTriggers(e){let t=this.archive.get("war3map.wtg");if(t)return new oi(t.arrayBuffer(),e)}readCustomTextTriggers(){let e=this.archive.get("war3map.wct");if(e)return new ei(e.arrayBuffer())}readStringTable(){let e=this.archive.get("war3map.wts");if(e)return new hi(e.text())}readModifications(){let e={},t=["w3u","w3t","w3b","w3d","w3a","w3h","w3q"],i=[!1,!1,!1,!0,!0,!1,!0];for(let s=0,a=t.length;s<a;s++){let a=this.archive.get("war3map.".concat(t[s]));if(a){let r,n=a.arrayBuffer();r=i[s]?new Ot(n):new $t(n),e[t[s]]=r}}return e}}class vi{constructor(){this.type=0,this.location=new Int32Array(2),this.color=new Uint8Array(4)}load(e){this.type=e.readInt32(),this.location=e.readInt32Array(2),this.color=e.readUint8Array(4)}save(e){e.writeInt32(this.type),e.writeInt32Array(this.location),e.writeUint8Array(this.color)}}class yi{constructor(){this.targetLocation=new Float32Array(3),this.rotation=0,this.angleOfAttack=0,this.distance=0,this.roll=0,this.fieldOfView=0,this.farClippingPlane=0,this.nearClippingPlane=0,this.cinematicName=""}load(e){this.targetLocation=e.readFloat32Array(3),this.rotation=e.readFloat32(),this.angleOfAttack=e.readFloat32(),this.distance=e.readFloat32(),this.roll=e.readFloat32(),this.fieldOfView=e.readFloat32(),this.farClippingPlane=e.readFloat32(),this.nearClippingPlane=e.readFloat32(),this.cinematicName=e.readUntilNull()}save(e){e.writeFloat32Array(this.targetLocation),e.writeFloat32(this.rotation),e.writeFloat32(this.angleOfAttack),e.writeFloat32(this.distance),e.writeFloat32(this.roll),e.writeFloat32(this.fieldOfView),e.writeFloat32(this.farClippingPlane),e.writeFloat32(this.nearClippingPlane),e.write("".concat(this.cinematicName,"\0"))}getByteLength(){return 41+this.cinematicName.length}}class bi{constructor(){this.left=0,this.right=0,this.bottom=0,this.top=0,this.name="",this.creationNumber=0,this.weatherEffectId="\0\0\0\0",this.ambientSound="",this.color=new Uint8Array(4)}load(e){this.left=e.readFloat32(),this.right=e.readFloat32(),this.bottom=e.readFloat32(),this.top=e.readFloat32(),this.name=e.readUntilNull(),this.creationNumber=e.readUint32(),this.weatherEffectId=e.read(4,!0),this.ambientSound=e.readUntilNull(),this.color=e.readUint8Array(4)}save(e){e.writeFloat32(this.left),e.writeFloat32(this.right),e.writeFloat32(this.bottom),e.writeFloat32(this.top),e.write("".concat(this.name,"\0")),e.writeUint32(this.creationNumber),this.weatherEffectId?e.write(this.weatherEffectId):e.writeUint32(0),e.write("".concat(this.ambientSound,"\0")),e.writeUint8Array(this.color)}getByteLength(){return 30+this.name.length+this.ambientSound.length}}class Ai{constructor(){this.name="",this.file="",this.eaxEffect="",this.flags=0,this.fadeInRate=0,this.fadeOutRate=0,this.volume=0,this.pitch=0,this.u1=0,this.u2=0,this.channel=0,this.minDistance=0,this.maxDistance=0,this.distanceCutoff=0,this.u3=0,this.u4=0,this.u5=0,this.u6=0,this.u7=0,this.u8=0}load(e){this.name=e.readUntilNull(),this.file=e.readUntilNull(),this.eaxEffect=e.readUntilNull(),this.flags=e.readUint32(),this.fadeInRate=e.readInt32(),this.fadeOutRate=e.readInt32(),this.volume=e.readInt32(),this.pitch=e.readFloat32(),this.u1=e.readFloat32(),this.u2=e.readInt32(),this.channel=e.readInt32(),this.minDistance=e.readFloat32(),this.maxDistance=e.readFloat32(),this.distanceCutoff=e.readFloat32(),this.u3=e.readFloat32(),this.u4=e.readFloat32(),this.u5=e.readInt32(),this.u6=e.readFloat32(),this.u7=e.readFloat32(),this.u8=e.readFloat32()}save(e){e.write("".concat(this.name,"\0")),e.write("".concat(this.file,"\0")),e.write("".concat(this.eaxEffect,"\0")),e.writeUint32(this.flags),e.writeUint32(this.fadeInRate),e.writeUint32(this.fadeOutRate),e.writeUint32(this.volume),e.writeFloat32(this.pitch),e.writeFloat32(this.u1),e.writeInt32(this.u2),e.writeInt32(this.channel),e.writeFloat32(this.minDistance),e.writeFloat32(this.maxDistance),e.writeFloat32(this.distanceCutoff),e.writeFloat32(this.u3),e.writeFloat32(this.u4),e.writeInt32(this.u5),e.writeFloat32(this.u6),e.writeFloat32(this.u7),e.writeFloat32(this.u8)}getByteLength(){return 71+this.name.length+this.file.length+this.eaxEffect.length}}class Ei{constructor(){this.visible=0,this.chapterTitle="",this.mapTitle="",this.path=""}load(e){this.visible=e.readInt32(),this.chapterTitle=e.readUntilNull(),this.mapTitle=e.readUntilNull(),this.path=e.readUntilNull()}save(e){e.writeInt32(this.visible),e.write("".concat(this.chapterTitle,"\0")),e.write("".concat(this.mapTitle,"\0")),e.write("".concat(this.path,"\0"))}getByteLength(){return 7+this.chapterTitle.length+this.mapTitle.length+this.path.length}}class xi{constructor(){this.u1=0,this.path=""}load(e){this.u1=e.readInt8(),this.path=e.readUntilNull()}save(e){e.writeInt8(this.u1),e.write("".concat(this.path,"\0"))}getByteLength(){return 2+this.path.length}}var Ti={Map:wi,doo:{Doodad:Ft,TerrainDoodad:Lt,File:Dt},imp:{Import:Mt,File:Ut},mmp:{MinimapIcon:vi,File:class{constructor(e){this.u1=0,this.icons=[],e&&this.load(e)}load(e){let t=new Rt(e);this.u1=t.readInt32();for(let i=0,s=t.readInt32();i<s;i++){let e=new vi;e.load(t),this.icons[i]=e}}save(){let e=new ArrayBuffer(this.getByteLength()),t=new Rt(e);t.writeInt32(this.u1),t.writeUint32(this.icons.length);for(let i of this.icons)i.save(t);return e}getByteLength(){return 8+16*this.icons.length}}},shd:{File:class{constructor(e,t,i){this.shadows=new Uint8Array(0),e&&this.load(e,t,i)}load(e,t,i){this.shadows=new Uint8Array(e.slice(0,t*i*16))}save(){return this.shadows.slice().buffer}getByteLength(){return this.shadows.length}}},w3c:{Camera:yi,File:class{constructor(e){this.version=0,this.cameras=[],e&&this.load(e)}load(e){let t=new Rt(e);this.version=t.readInt32();for(let i=0,s=t.readUint32();i<s;i++){let e=new yi;e.load(t),this.cameras[i]=e}}save(){let e=new ArrayBuffer(this.getByteLength()),t=new Rt(e);t.writeInt32(this.version),t.writeUint32(this.cameras.length);for(let i of this.cameras)i.save(t);return e}getByteLength(){let e=8;for(let t of this.cameras)e+=t.getByteLength();return e}}},w3d:{File:Ot},w3e:{Corner:jt,File:Vt},w3i:{Player:Gt,Force:Ht,UpgradeAvailabilityChange:Kt,TechAvailabilityChange:qt,RandomUnitTable:Xt,RandomUnit:Wt,RandomItemTable:Jt,RandomItemSet:Yt,RandomItem:zt,File:Zt},w3o:{File:class{constructor(e){this.version=0,this.units=null,this.items=null,this.destructables=null,this.doodads=null,this.abilities=null,this.buffs=null,this.upgrades=null,e&&this.load(e)}load(e){let t=new Rt(e);this.version=t.readInt32(),t.readInt32()&&(this.units=new $t(t)),t.readInt32()&&(this.items=new $t(t)),t.readInt32()&&(this.destructables=new $t(t)),t.readInt32()&&(this.doodads=new Ot(t)),t.readInt32()&&(this.abilities=new Ot(t)),t.readInt32()&&(this.buffs=new $t(t)),t.readInt32()&&(this.upgrades=new Ot(t))}save(){let e=new ArrayBuffer(this.getByteLength()),t=new Rt(e);return t.writeInt32(this.version),this.units?(t.writeInt32(1),this.units.save(t)):t.writeInt32(0),this.items?(t.writeInt32(1),this.items.save(t)):t.writeInt32(0),this.destructables?(t.writeInt32(1),this.destructables.save(t)):t.writeInt32(0),this.doodads?(t.writeInt32(1),this.doodads.save(t)):t.writeInt32(0),this.abilities?(t.writeInt32(1),this.abilities.save(t)):t.writeInt32(0),this.buffs?(t.writeInt32(1),this.buffs.save(t)):t.writeInt32(0),this.upgrades?(t.writeInt32(1),this.upgrades.save(t)):t.writeInt32(0),e}getByteLength(){let e=32;return this.units&&(e+=this.units.getByteLength()),this.items&&(e+=this.items.getByteLength()),this.destructables&&(e+=this.destructables.getByteLength()),this.doodads&&(e+=this.doodads.getByteLength()),this.abilities&&(e+=this.abilities.getByteLength()),this.buffs&&(e+=this.buffs.getByteLength()),this.upgrades&&(e+=this.upgrades.getByteLength()),e}}},w3r:{Region:bi,File:class{constructor(e){this.version=0,this.regions=[],e&&this.load(e)}load(e){let t=new Rt(e);this.version=t.readInt32();for(let i=0,s=t.readUint32();i<s;i++)this.regions[i]=new bi(t)}save(){let e=new ArrayBuffer(this.getByteLength()),t=new Rt(e);t.writeInt32(this.version),t.writeUint32(this.regions.length);for(let i of this.regions)i.save(t);return e}getByteLength(){let e=8;for(let t of this.regions)e+=t.calcSize();return e}}},w3s:{Sound:Ai,File:class{constructor(e){this.version=0,this.sounds=[],e&&this.load(e)}load(e){let t=new Rt(e);this.version=t.readInt32();for(let i=0,s=t.readUint32();i<s;i++){let e=new Ai;e.load(t),this.sounds[i]=e}}save(){let e=new ArrayBuffer(this.calcSize()),t=new Rt(e);t.writeInt32(this.version),t.writeUint32(this.sounds.length);for(let i of this.sounds)i.save(t);return e}getByteLength(){let e=8;for(let t of this.sounds)e+=t.getByteLength();return e}}},w3u:{Modification:Pt,ModifiedObject:kt,ModificationTable:Nt,File:$t},wct:{CustomTextTrigger:Qt,File:ei},wpm:{File:class{constructor(e){this.version=0,this.size=new Int32Array(2),this.pathing=new Uint8Array(1),e&&this.load(e)}load(e){let t=new Rt(e);return"MP3W"===t.read(4)&&(this.version=t.readInt32(),this.size=t.readInt32Array(2),this.pathing=t.readUint8Array(this.size[0]*this.size[1]),!0)}save(){let e=new ArrayBuffer(this.getByteLength()),t=new Rt(e);return t.write("MP3W"),t.writeInt32(this.version),t.writeInt32Array(this.size),t.writeUint8Array(this.pathing),e}getByteLength(){return 16+this.size[0]*this.size[1]}}},wtg:{ECA:ri,Parameter:ai,SubParameters:si,Trigger:ni,TriggerCategory:ti,Variable:ii,File:oi,TriggerData:class{constructor(){this.types={},this.functions=[{},{},{},{}],this.presets={},this.externalTypes={},this.externalFunctions=[{},{},{},{}],this.externalPresets={}}addTriggerData(e,t){let i=this.types,s=this.functions,a=this.presets;t&&(i=this.externalTypes,s=this.externalFunctions,a=this.externalPresets);let r=new et;r.load(e),this.addTriggerTypes(i,r.getSection("TriggerTypes")),this.addTriggerDataFunctions(s[0],r.getSection("TriggerEvents"),1),this.addTriggerDataFunctions(s[1],r.getSection("TriggerConditions"),1),this.addTriggerDataFunctions(s[2],r.getSection("TriggerActions"),1),this.addTriggerDataFunctions(s[3],r.getSection("TriggerCalls"),3),this.addTriggerDataPresets(a,r.getSection("TriggerParams"))}addTriggerTypes(e,t){for(let[i,s]of t){let t=s.split(",");e[i]=t[4]||""}}addTriggerDataFunctions(e,t,i){for(let[s,a]of t)if("_"!==s[0]){let r=a.split(",").slice(i),n=[],o=t.get("_".concat(s,"_scriptname"))||null;for(let e of r)isNaN(e)&&"nothing"!==e&&""!==e&&n.push(e);e[s]={args:n,scriptName:o}}}addTriggerDataPresets(e,t){for(let[i,s]of t){let t=s.split(",");e[i]=t[2].replace(/"/g,"").replace(/`/g,'"')}}getBaseType(e){e=e.toLowerCase();let t=this.types[e];return void 0===t&&(t=this.externalTypes[e]),""===t||void 0===t?e:t}isBaseFunction(e,t){return t=t.toLowerCase(),!!this.functions[e][t]}getFunction(e,t){t=t.toLowerCase();let i=this.functions[e][t];if(!i&&!(i=this.externalFunctions[e][t]))throw new Error('Tried to get signature for unknown function "'.concat(t,'"'));return i}getPreset(e){e=e.toLowerCase();let t=this.presets[e];if(void 0===t&&void 0===(t=this.externalPresets[e]))throw new Error("Failed to find a preset: ".concat(e));return t}isCustomPreset(e){if(e=e.toLowerCase(),void 0!==this.presets[e])return!1;if(void 0!==this.externalPresets[e])return!0;throw new Error("Failed to find a preset: ".concat(e))}}},wts:{File:hi},unitsdoo:{DroppedItem:ci,DroppedItemSet:di,InventoryItem:ui,ModifiedAbility:mi,RandomUnit:fi,Unit:pi,File:gi},w3f:{File:class{constructor(){this.version=0,this.campaignVersion=0,this.editorVersion=0,this.name="",this.difficulty="",this.author="",this.description="",this.mode=-1,this.backgroundScreen=-1,this.backgroundScreenPath="",this.minimapImagePath="",this.ambientSound=0,this.ambientSoundPath="",this.terrainFog=0,this.fogStartZ=0,this.fogEndZ=0,this.fogDensity=0,this.fogColor=new Uint8Array(4),this.userInterface=-1,this.mapTitles=[],this.mapOrders=[]}load(e){let t=new Rt(e);this.version=t.readInt32(),this.campaignVersion=t.readInt32(),this.editorVersion=t.readInt32(),this.name=t.readUntilNull(),this.difficulty=t.readUntilNull(),this.author=t.readUntilNull(),this.description=t.readUntilNull(),this.mode=t.readInt32(),this.backgroundScreen=t.readInt32(),this.backgroundScreenPath=t.readUntilNull(),this.minimapImagePath=t.readUntilNull(),this.ambientSound=t.readInt32(),this.ambientSoundPath=t.readUntilNull(),this.terrainFog=t.readInt32(),this.fogStartZ=t.readFloat32(),this.fogEndZ=t.readFloat32(),this.fogDensity=t.readFloat32(),t.readUint8Array(this.fogColor),this.userInterface=t.readInt32();for(let i=0,s=t.readUint32();i<s;i++){let e=new Ei;e.load(t),this.mapTitles[i]=e}for(let i=0,s=t.readUint32();i<s;i++){let e=new xi;e.load(t),this.mapOrders[i]=e}}save(){let e=new ArrayBuffer(this.getByteLength()),t=new Rt(e);t.writeInt32(this.version),t.writeInt32(this.campaignVersion),t.writeInt32(this.editorVersion),t.write("".concat(this.name,"\0")),t.write("".concat(this.difficulty,"\0")),t.write("".concat(this.author,"\0")),t.write("".concat(this.description,"\0")),t.writeInt32(this.mode),t.writeInt32(this.backgroundScreen),t.write("".concat(this.backgroundScreenPath,"\0")),t.write("".concat(this.minimapImagePath,"\0")),t.writeInt32(this.ambientSound),t.write("".concat(this.ambientSoundPath,"\0")),t.writeInt32(this.terrainFog),t.writeFloat32(this.fogStartZ),t.writeFloat32(this.fogEndZ),t.writeFloat32(this.fogDensity),t.writeUint8Array(this.fogColor),t.writeInt32(this.userInterface),t.writeUint32(this.mapTitles.length);for(let i of this.mapTitles)i.save(t);t.writeUint32(this.mapOrders.length);for(let i of this.mapOrders)i.save(t);return e}getByteLength(){let e=63+this.name.length+this.difficulty.length+this.author.length+this.description.length+this.backgroundScreenPath.length+this.minimapImagePath.length+this.ambientSoundPath.length;for(let t of this.mapTitles)e+=t.getByteLength();for(let t of this.mapOrders)e+=t.getByteLength();return e}}}};class Si{constructor(){this.boundsRadius=0,this.min=new Float32Array(3),this.max=new Float32Array(3)}readMdx(e){this.boundsRadius=e.readFloat32(),e.readFloat32Array(this.min),e.readFloat32Array(this.max)}writeMdx(e){e.writeFloat32(this.boundsRadius),e.writeFloat32Array(this.min),e.writeFloat32Array(this.max)}writeMdl(e){0===this.min[0]&&0===this.min[1]&&0===this.min[2]||e.writeFloatArrayAttrib("MinimumExtent",this.min),0===this.max[0]&&0===this.max[1]&&0===this.max[2]||e.writeFloatArrayAttrib("MaximumExtent",this.max),0!==this.boundsRadius&&e.writeFloatAttrib("BoundsRadius",this.boundsRadius)}}class _i{constructor(){this.name="",this.interval=new Uint32Array(2),this.moveSpeed=0,this.flags=0,this.rarity=0,this.syncPoint=0,this.extent=new Si}readMdx(e){this.name=e.read(80),e.readUint32Array(this.interval),this.moveSpeed=e.readFloat32(),this.flags=e.readUint32(),this.rarity=e.readFloat32(),this.syncPoint=e.readUint32(),this.extent.readMdx(e)}writeMdx(e){e.write(this.name),e.skip(80-this.name.length),e.writeUint32Array(this.interval),e.writeFloat32(this.moveSpeed),e.writeUint32(this.flags),e.writeFloat32(this.rarity),e.writeUint32(this.syncPoint),this.extent.writeMdx(e)}readMdl(e){this.name=e.read();for(let t of e.readBlock())if("Interval"===t)e.readIntArray(this.interval);else if("NonLooping"===t)this.flags=1;else if("MoveSpeed"===t)this.moveSpeed=e.readFloat();else if("Rarity"===t)this.rarity=e.readFloat();else if("MinimumExtent"===t)e.readFloatArray(this.extent.min);else if("MaximumExtent"===t)e.readFloatArray(this.extent.max);else{if("BoundsRadius"!==t)throw new Error('Unknown token in Sequence: "'.concat(t,'"'));this.extent.boundsRadius=e.readFloat()}}writeMdl(e){e.startObjectBlock("Anim",this.name),e.writeArrayAttrib("Interval",this.interval),1===this.flags&&e.writeFlag("NonLooping"),0!==this.moveSpeed&&e.writeFloatAttrib("MoveSpeed",this.moveSpeed),0!==this.rarity&&e.writeFloatAttrib("Rarity",this.rarity),this.extent.writeMdl(e),e.endBlock()}}const Ii=(e,t)=>(class{constructor(){this.frame=0,this.value=new e(t),this.inTan=new e(t),this.outTan=new e(t)}readMdx(e,t){this.frame=e.readUint32(),e.readTypedArray(this.value),t>1&&(e.readTypedArray(this.inTan),e.readTypedArray(this.outTan))}writeMdx(e,t){e.writeUint32(this.frame),e.writeTypedArray(this.value),t>1&&(e.writeTypedArray(this.inTan),e.writeTypedArray(this.outTan))}readMdl(e,t){this.frame=e.readInt(),e.readKeyframe(this.value),t>1&&(e.read(),e.readKeyframe(this.inTan),e.read(),e.readKeyframe(this.outTan))}writeMdl(e,t){e.writeKeyframe("".concat(this.frame,":"),this.value),t>1&&(e.indent(),e.writeKeyframe("InTan",this.inTan),e.writeKeyframe("OutTan",this.outTan),e.unindent())}getByteLength(e){let t=this.value.byteLength,i=4+t;return e>1&&(i+=2*t),i}}),Ri=Ii(Uint32Array,1),Ci=Ii(Float32Array,1),Bi=Ii(Float32Array,3),Fi=Ii(Float32Array,4),Li=e=>(class{constructor(){this.name="",this.interpolationType=0,this.globalSequenceId=-1,this.tracks=[]}readMdx(t,i){this.name=i;const s=t.readUint32();this.interpolationType=t.readUint32(),this.globalSequenceId=t.readInt32();for(let a=0;a<s;a++){const i=new e;i.readMdx(t,this.interpolationType),this.tracks.push(i)}}writeMdx(e){e.write(this.name),e.writeUint32(this.tracks.length),e.writeUint32(this.interpolationType),e.writeInt32(this.globalSequenceId);for(const t of this.tracks)t.writeMdx(e,this.interpolationType)}readMdl(t,i){this.name=i;const s=t.readInt();t.read();const a=t.read();"DontInterp"===a?this.interpolationType=0:"Linear"===a?this.interpolationType=1:"Hermite"===a?this.interpolationType=2:"Bezier"===a&&(this.interpolationType=3),"GlobalSeqId"===t.peek()&&(t.read(),this.globalSequenceId=t.readInt());for(let r=0;r<s;r++){const i=new e;i.readMdl(t,this.interpolationType),this.tracks[r]=i}t.read()}writeMdl(e,t){let i;e.startBlock(t,this.tracks.length),0===this.interpolationType?i="DontInterp":1===this.interpolationType?i="Linear":2===this.interpolationType?i="Hermite":3===this.interpolationType&&(i="Bezier"),e.writeFlag(i),-1!==this.globalSequenceId&&e.writeAttrib("GlobalSeqId",this.globalSequenceId);for(const s of this.tracks)s.writeMdl(e,this.interpolationType);e.endBlock()}getByteLength(){let e=this.tracks,t=16;return e.length&&(t+=e[0].getByteLength(this.interpolationType)*e.length),t}}),Di=Li(Ri),Mi=Li(Ci),Ui=Li(Bi),Pi=Li(Fi);var ki={KMTF:["TextureId",Di],KMTA:["Alpha",Mi],KTAT:["Translation",Ui],KTAR:["Rotation",Pi],KTAS:["Scaling",Ui],KGAO:["Alpha",Mi],KGAC:["Color",Ui],KLAS:["AttenuationStart",Mi],KLAE:["AttenuationEnd",Mi],KLAC:["Color",Ui],KLAI:["Intensity",Mi],KLBI:["AmbientIntensity",Mi],KLBC:["AmbientColor",Ui],KLAV:["Visibility",Mi],KATV:["Visibility",Mi],KPEE:["EmissionRate",Mi],KPEG:["Gravity",Mi],KPLN:["Longitude",Mi],KPLT:["Latitude",Mi],KPEL:["LifeSpan",Mi],KPES:["Speed",Mi],KPEV:["Visibility",Mi],KP2S:["Speed",Mi],KP2R:["Variation",Mi],KP2L:["Latitude",Mi],KP2G:["Gravity",Mi],KP2E:["EmissionRate",Mi],KP2N:["Length",Mi],KP2W:["Width",Mi],KP2V:["Visibility",Mi],KRHA:["HeightAbove",Mi],KRHB:["HeightBelow",Mi],KRAL:["Alpha",Mi],KRCO:["Color",Ui],KRTX:["TextureSlot",Di],KRVS:["Visibility",Mi],KCTR:["Translation",Ui],KTTR:["Translation",Ui],KCRL:["Rotation",Di],KGTR:["Translation",Ui],KGRT:["Rotation",Pi],KGSC:["Scaling",Ui]};class Ni{constructor(){this.animations=[]}readAnimations(e,t){for(;t>0;){let i=e.read(4,!0),s=new ki[i][1];s.readMdx(e,i),t-=s.getByteLength(),this.animations.push(s)}}writeAnimations(e){for(let t of this.animations)t.writeMdx(e)}*readAnimatedBlock(e){for(let t of e.readBlock())"static"===t?yield"static ".concat(e.read()):yield t}readAnimation(e,t){let i=new ki[t][1];i.readMdl(e,t),this.animations.push(i)}writeAnimation(e,t){for(let i of this.animations)if(i.name===t)return i.writeMdl(e,ki[t][0]),!0;return!1}getByteLength(){let e=0;for(let t of this.animations)e+=t.getByteLength();return e}}let Oi={None:0,Transparent:1,Blend:2,Additive:3,AddAlpha:4,Modulate:5,Modulate2x:6},ji={0:"None",1:"Transparent",2:"Blend",3:"Additive",4:"AddAlpha",5:"Modulate",6:"Modulate2x"};class Vi extends Ni{constructor(){super(),this.filterMode=0,this.flags=0,this.textureId=-1,this.textureAnimationId=-1,this.coordId=0,this.alpha=1}readMdx(e){let t=e.readUint32();this.filterMode=e.readUint32(),this.flags=e.readUint32(),this.textureId=e.readInt32(),this.textureAnimationId=e.readInt32(),this.coordId=e.readUint32(),this.alpha=e.readFloat32(),this.readAnimations(e,t-28)}writeMdx(e){e.writeUint32(this.getByteLength()),e.writeUint32(this.filterMode),e.writeUint32(this.flags),e.writeInt32(this.textureId),e.writeInt32(this.textureAnimationId),e.writeUint32(this.coordId),e.writeFloat32(this.alpha),this.writeAnimations(e)}readMdl(e){for(let t of this.readAnimatedBlock(e))if("FilterMode"===t)this.filterMode=Oi[e.read()];else if("Unshaded"===t)this.flags|=1;else if("SphereEnvMap"===t)this.flags|=2;else if("TwoSided"===t)this.flags|=16;else if("Unfogged"===t)this.flags|=32;else if("NoDepthTest"===t)this.flags|=64;else if("NoDepthSet"===t)this.flags|=256;else if("static TextureID"===t)this.textureId=e.readInt();else if("TextureID"===t)this.readAnimation(e,"KMTF");else if("TVertexAnimId"===t)this.textureAnimationId=e.readInt();else if("CoordId"===t)this.coordId=e.readInt();else if("static Alpha"===t)this.alpha=e.readFloat();else{if("Alpha"!==t)throw new Error('Unknown token in Layer: "'.concat(t,'"'));this.readAnimation(e,"KMTA")}}writeMdl(e){e.startBlock("Layer"),e.writeAttrib("FilterMode",ji[this.filterMode]),1&this.flags&&e.writeFlag("Unshaded"),2&this.flags&&e.writeFlag("SphereEnvMap"),16&this.flags&&e.writeFlag("TwoSided"),32&this.flags&&e.writeFlag("Unfogged"),64&this.flags&&e.writeFlag("NoDepthTest"),256&this.flags&&e.writeFlag("NoDepthSet"),this.writeAnimation(e,"KMTF")||e.writeAttrib("static TextureID",this.textureId),-1!==this.textureAnimationId&&e.writeAttrib("TVertexAnimId",this.textureAnimationId),0!==this.coordId&&e.writeAttrib("CoordId",this.coordId),this.writeAnimation(e,"KMTA")||1===this.alpha||e.writeFloatAttrib("static Alpha",this.alpha),e.endBlock()}getByteLength(){return 28+super.getByteLength()}}class Gi{constructor(){this.priorityPlane=0,this.flags=0,this.layers=[]}readMdx(e){e.readUint32(),this.priorityPlane=e.readUint32(),this.flags=e.readUint32(),e.skip(4);for(let t=0,i=e.readUint32();t<i;t++){let t=new Vi;t.readMdx(e),this.layers.push(t)}}writeMdx(e){e.writeUint32(this.getByteLength()),e.writeUint32(this.priorityPlane),e.writeUint32(this.flags),e.write("LAYS"),e.writeUint32(this.layers.length);for(let t of this.layers)t.writeMdx(e)}readMdl(e){for(let t of e.readBlock())if("ConstantColor"===t)this.flags|=1;else if("SortPrimsNearZ"===t)this.flags|=8;else if("SortPrimsFarZ"===t)this.flags|=16;else if("FullResolution"===t)this.flags|=32;else if("PriorityPlane"===t)this.priorityPlane=e.readInt();else{if("Layer"!==t)throw new Error('Unknown token in Material: "'.concat(t,'"'));{let t=new Vi;t.readMdl(e),this.layers.push(t)}}}writeMdl(e){e.startBlock("Material"),1&this.flags&&e.writeFlag("ConstantColor"),8&this.flags&&e.writeFlag("SortPrimsNearZ"),16&this.flags&&e.writeFlag("SortPrimsFarZ"),32&this.flags&&e.writeFlag("FullResolution"),0!==this.priorityPlane&&e.writeAttrib("PriorityPlane",this.priorityPlane);for(let t of this.layers)t.writeMdl(e);e.endBlock()}getByteLength(){let e=20;for(let t of this.layers)e+=t.getByteLength();return e}}class Hi{constructor(){this.replaceableId=0,this.path="",this.flags=0}readMdx(e){this.replaceableId=e.readUint32(),this.path=e.read(260),this.flags=e.readUint32()}writeMdx(e){e.writeUint32(this.replaceableId),e.write(this.path),e.skip(260-this.path.length),e.writeUint32(this.flags)}readMdl(e){for(let t of e.readBlock())if("Image"===t)this.path=e.read();else if("ReplaceableId"===t)this.replaceableId=e.readInt();else if("WrapWidth"===t)this.flags|=1;else{if("WrapHeight"!==t)throw new Error('Unknown token in Texture: "'.concat(t,'"'));this.flags|=2}}writeMdl(e){e.startBlock("Bitmap"),e.writeStringAttrib("Image",this.path),0!==this.replaceableId&&e.writeAttrib("ReplaceableId",this.replaceableId),1&this.flags&&e.writeFlag("WrapWidth"),2&this.flags&&e.writeFlag("WrapHeight"),e.endBlock()}}class Ki extends Ni{readMdx(e){let t=e.readUint32();this.readAnimations(e,t-4)}writeMdx(e){e.writeUint32(this.getByteLength()),this.writeAnimations(e)}readMdl(e){for(let t of e.readBlock())if("Translation"===t)this.readAnimation(e,"KTAT");else if("Rotation"===t)this.readAnimation(e,"KTAR");else{if("Scaling"!==t)throw new Error('Unknown token in TextureAnimation: "'.concat(t,'"'));this.readAnimation(e,"KTAS")}}writeMdl(e){e.startBlock("TVertexAnim "),this.writeAnimation(e,"KTAT"),this.writeAnimation(e,"KTAR"),this.writeAnimation(e,"KTAS"),e.endBlock()}getByteLength(){return 4+super.getByteLength()}}class qi{constructor(){this.vertices=new Float32Array(0),this.normals=new Float32Array(0),this.faceTypeGroups=new Uint32Array(0),this.faceGroups=new Uint32Array(0),this.faces=new Uint16Array(0),this.vertexGroups=new Uint8Array(0),this.matrixGroups=new Uint32Array(0),this.matrixIndices=new Uint32Array(0),this.materialId=0,this.selectionGroup=0,this.selectionFlags=0,this.extent=new Si,this.sequenceExtents=[],this.uvSets=[]}readMdx(e){e.readUint32(),e.skip(4),this.vertices=e.readFloat32Array(3*e.readUint32()),e.skip(4),this.normals=e.readFloat32Array(3*e.readUint32()),e.skip(4),this.faceTypeGroups=e.readUint32Array(e.readUint32()),e.skip(4),this.faceGroups=e.readUint32Array(e.readUint32()),e.skip(4),this.faces=e.readUint16Array(e.readUint32()),e.skip(4),this.vertexGroups=e.readUint8Array(e.readUint32()),e.skip(4),this.matrixGroups=e.readUint32Array(e.readUint32()),e.skip(4),this.matrixIndices=e.readUint32Array(e.readUint32()),this.materialId=e.readUint32(),this.selectionGroup=e.readUint32(),this.selectionFlags=e.readUint32(),this.extent.readMdx(e);for(let t=0,i=e.readUint32();t<i;t++){let t=new Si;t.readMdx(e),this.sequenceExtents.push(t)}e.skip(4);for(let t=0,i=e.readUint32();t<i;t++)e.skip(4),this.uvSets.push(e.readFloat32Array(2*e.readUint32()))}writeMdx(e){e.writeUint32(this.getByteLength()),e.write("VRTX"),e.writeUint32(this.vertices.length/3),e.writeFloat32Array(this.vertices),e.write("NRMS"),e.writeUint32(this.normals.length/3),e.writeFloat32Array(this.normals),e.write("PTYP"),e.writeUint32(this.faceTypeGroups.length),e.writeUint32Array(this.faceTypeGroups),e.write("PCNT"),e.writeUint32(this.faceGroups.length),e.writeUint32Array(this.faceGroups),e.write("PVTX"),e.writeUint32(this.faces.length),e.writeUint16Array(this.faces),e.write("GNDX"),e.writeUint32(this.vertexGroups.length),e.writeUint8Array(this.vertexGroups),e.write("MTGC"),e.writeUint32(this.matrixGroups.length),e.writeUint32Array(this.matrixGroups),e.write("MATS"),e.writeUint32(this.matrixIndices.length),e.writeUint32Array(this.matrixIndices),e.writeUint32(this.materialId),e.writeUint32(this.selectionGroup),e.writeUint32(this.selectionFlags),this.extent.writeMdx(e),e.writeUint32(this.sequenceExtents.length);for(let t of this.sequenceExtents)t.writeMdx(e);e.write("UVAS"),e.writeUint32(this.uvSets.length);for(let t of this.uvSets)e.write("UVBS"),e.writeUint32(t.length/2),e.writeFloat32Array(t)}readMdl(e){for(let t of e.readBlock())if("Vertices"===t)this.vertices=e.readVectorArray(new Float32Array(3*e.readInt()),3);else if("Normals"===t)this.normals=e.readVectorArray(new Float32Array(3*e.readInt()),3);else if("TVertices"===t)this.uvSets.push(e.readVectorArray(new Float32Array(2*e.readInt()),2));else if("VertexGroup"===t){let t=[];for(let i of e.readBlock())t.push(parseInt(i));this.vertexGroups=new Uint8Array(t)}else if("Faces"===t){this.faceTypeGroups=new Uint32Array([4]),e.readInt();let t=e.readInt();e.read(),e.read(),e.read(),this.faces=e.readIntArray(new Uint16Array(t)),e.read(),e.read()}else if("Groups"===t){let t=[],i=[];e.readInt(),e.readInt();for(let s of e.readBlock()){let s=0;for(let i of e.readBlock())t.push(parseInt(i)),s+=1;i.push(s)}this.matrixIndices=new Uint32Array(t),this.matrixGroups=new Uint32Array(i)}else if("MinimumExtent"===t)e.readFloatArray(this.extent.min);else if("MaximumExtent"===t)e.readFloatArray(this.extent.max);else if("BoundsRadius"===t)this.extent.boundsRadius=e.readFloat();else if("Anim"===t){let i=new Si;for(t of e.readBlock())"MinimumExtent"===t?e.readFloatArray(i.min):"MaximumExtent"===t?e.readFloatArray(i.max):"BoundsRadius"===t&&(i.boundsRadius=e.readFloat());this.sequenceExtents.push(i)}else if("MaterialID"===t)this.materialId=e.readInt();else if("SelectionGroup"===t)this.selectionGroup=e.readInt();else{if("Unselectable"!==t)throw new Error('Unknown token in Geoset: "'.concat(t,'"'));this.selectionFlags=4}}writeMdl(e){e.startBlock("Geoset"),e.writeVectorArray("Vertices",this.vertices,3),e.writeVectorArray("Normals",this.normals,3);for(let i of this.uvSets)e.writeVectorArray("TVertices",i,2);e.startBlock("VertexGroup");for(let i=0,s=this.vertexGroups.length;i<s;i++)e.writeLine("".concat(this.vertexGroups[i],","));e.endBlock(),e.startBlock("Faces",1,this.faces.length),e.startBlock("Triangles"),e.writeLine("{ ".concat(this.faces.join(", ")," },")),e.endBlock(),e.endBlock(),e.startBlock("Groups",this.matrixGroups.length,this.matrixIndices.length);let t=0;for(let i of this.matrixGroups)e.writeArrayAttrib("Matrices",this.matrixIndices.subarray(t,t+i)),t+=i;e.endBlock(),this.extent.writeMdl(e);for(let i of this.sequenceExtents)e.startBlock("Anim"),i.writeMdl(e),e.endBlock();e.writeAttrib("MaterialID",this.materialId),e.writeAttrib("SelectionGroup",this.selectionGroup),4===this.selectionFlags&&e.writeFlag("Unselectable"),e.endBlock()}getByteLength(){let e=120+this.vertices.byteLength+this.normals.byteLength+this.faceTypeGroups.byteLength+this.faceGroups.byteLength+this.faces.byteLength+this.vertexGroups.byteLength+this.matrixGroups.byteLength+this.matrixIndices.byteLength+28*this.sequenceExtents.length;for(let t of this.uvSets)e+=8+t.byteLength;return e}}class Wi extends Ni{constructor(){super(),this.alpha=1,this.flags=0,this.color=new Float32Array([1,1,1]),this.geosetId=-1,this.animations=[]}readMdx(e){let t=e.readUint32();this.alpha=e.readFloat32(),this.flags=e.readUint32(),e.readFloat32Array(this.color),this.geosetId=e.readInt32(),this.readAnimations(e,t-28)}writeMdx(e){e.writeUint32(this.getByteLength()),e.writeFloat32(this.alpha),e.writeUint32(this.flags),e.writeFloat32Array(this.color),e.writeInt32(this.geosetId),this.writeAnimations(e)}readMdl(e){for(let t of this.readAnimatedBlock(e))if("DropShadow"===t)this.flags|=1;else if("static Alpha"===t)this.alpha=e.readFloat();else if("Alpha"===t)this.readAnimation(e,"KGAO");else if("static Color"===t)this.flags|=2,e.readColor(this.color);else if("Color"===t)this.flags|=2,this.readAnimation(e,"KGAC");else{if("GeosetId"!==t)throw new Error('Unknown token in GeosetAnimation: "'.concat(t,'"'));this.geosetId=e.readInt()}}writeMdl(e){e.startBlock("GeosetAnim"),1&this.flags&&e.writeFlag("DropShadow"),this.writeAnimation(e,"KGAO")||e.writeFloatAttrib("static Alpha",this.alpha),2&this.flags&&(this.writeAnimation(e,"KGAC")||1===this.color[0]&&1===this.color[1]&&1===this.color[2]||e.writeColor("static Color ",this.color)),e.writeAttrib("GeosetId",this.geosetId),e.endBlock()}getByteLength(){return 28+super.getByteLength()}}class Xi extends Ni{constructor(e){super(),this.name="",this.objectId=-1,this.parentId=-1,this.flags=e||0}readMdx(e){let t=e.readUint32();this.name=e.read(80),this.objectId=e.readInt32(),this.parentId=e.readInt32(),this.flags=e.readUint32(),this.readAnimations(e,t-96)}writeMdx(e){e.writeUint32(this.getGenericByteLength()),e.write(this.name),e.skip(80-this.name.length),e.writeInt32(this.objectId),e.writeInt32(this.parentId),e.writeUint32(this.flags);for(let t of this.eachAnimation(!0))t.writeMdx(e)}writeNonGenericAnimationChunks(e){for(let t of this.eachAnimation(!1))t.writeMdx(e)}*readMdl(e){this.name=e.read();for(let t of this.readAnimatedBlock(e))if("ObjectId"===t)this.objectId=e.readInt();else if("Parent"===t)this.parentId=e.readInt();else if("BillboardedLockZ"===t)this.flags|=64;else if("BillboardedLockY"===t)this.flags|=32;else if("BillboardedLockX"===t)this.flags|=16;else if("Billboarded"===t)this.flags|=8;else if("CameraAnchored"===t)this.flags|=128;else if("DontInherit"===t)for(t of e.readBlock())"Rotation"===t?this.flags|=2:"Translation"===t?this.flags|=1:"Scaling"===t&&(this.flags|=4);else"Translation"===t?this.readAnimation(e,"KGTR"):"Rotation"===t?this.readAnimation(e,"KGRT"):"Scaling"===t?this.readAnimation(e,"KGSC"):yield t}writeGenericHeader(e){e.writeAttrib("ObjectId",this.objectId),-1!==this.parentId&&e.writeAttrib("Parent",this.parentId),64&this.flags&&e.writeFlag("BillboardedLockZ"),32&this.flags&&e.writeFlag("BillboardedLockY"),16&this.flags&&e.writeFlag("BillboardedLockX"),8&this.flags&&e.writeFlag("Billboarded"),128&this.flags&&e.writeFlag("CameraAnchored"),2&this.flags&&e.writeFlag("DontInherit { Rotation }"),1&this.flags&&e.writeFlag("DontInherit { Translation }"),4&this.flags&&e.writeFlag("DontInherit { Scaling }")}writeGenericAnimations(e){this.writeAnimation(e,"KGTR"),this.writeAnimation(e,"KGRT"),this.writeAnimation(e,"KGSC")}*eachAnimation(e){for(let t of this.animations){let i=t.name,s="KGTR"===i||"KGRT"===i||"KGSC"===i;(e&&s||!e&&!s)&&(yield t)}}getGenericByteLength(){let e=96;for(let t of this.eachAnimation(!0))e+=t.getByteLength();return e}getByteLength(){return 96+super.getByteLength()}}class zi extends Xi{constructor(){super(256),this.geosetId=-1,this.geosetAnimationId=-1}readMdx(e){super.readMdx(e),this.geosetId=e.readInt32(),this.geosetAnimationId=e.readInt32()}writeMdx(e){super.writeMdx(e),e.writeInt32(this.geosetId),e.writeInt32(this.geosetAnimationId)}readMdl(e){for(let t of super.readMdl(e))if("GeosetId"===t)t=e.read(),this.geosetId="Multiple"===t?-1:parseInt(t);else{if("GeosetAnimId"!==t)throw new Error("Unknown token in Bone ".concat(this.name,': "').concat(t,'"'));t=e.read(),this.geosetAnimationId="None"===t?-1:parseInt(t)}}writeMdl(e){e.startObjectBlock("Bone",this.name),this.writeGenericHeader(e);let t=this.geosetId,i=this.geosetAnimationId;-1===t&&(t="Multiple"),-1===i&&(i="None"),e.writeAttrib("GeosetId",t),e.writeAttrib("GeosetAnimId",i),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 8+super.getByteLength()}}class Yi extends Xi{constructor(){super(512),this.type=-1,this.attenuation=new Float32Array(2),this.color=new Float32Array(3),this.intensity=0,this.ambientColor=new Float32Array(3),this.ambientIntensity=0}readMdx(e){let t=e.readUint32();super.readMdx(e),this.type=e.readUint32(),e.readFloat32Array(this.attenuation),e.readFloat32Array(this.color),this.intensity=e.readFloat32(),e.readFloat32Array(this.ambientColor),this.ambientIntensity=e.readFloat32(),this.readAnimations(e,t-this.getByteLength())}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeUint32(this.type),e.writeFloat32Array(this.attenuation),e.writeFloat32Array(this.color),e.writeFloat32(this.intensity),e.writeFloat32Array(this.ambientColor),e.writeFloat32(this.ambientIntensity),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(let t of super.readMdl(e))if("Omnidirectional"===t)this.type=0;else if("Directional"===t)this.type=1;else if("Ambient"===t)this.type=2;else if("static AttenuationStart"===t)this.attenuation[0]=e.readFloat();else if("AttenuationStart"===t)this.readAnimation(e,"KLAS");else if("static AttenuationEnd"===t)this.attenuation[1]=e.readFloat();else if("AttenuationEnd"===t)this.readAnimation(e,"KLAE");else if("static Intensity"===t)this.intensity=e.readFloat();else if("Intensity"===t)this.readAnimation(e,"KLAI");else if("static Color"===t)e.readColor(this.color);else if("Color"===t)this.readAnimation(e,"KLAC");else if("static AmbIntensity"===t)this.ambientIntensity=e.readFloat();else if("AmbIntensity"===t)this.readAnimation(e,"KLBI");else if("static AmbColor"===t)e.readColor(this.ambientColor);else if("AmbColor"===t)this.readAnimation(e,"KLBC");else{if("Visibility"!==t)throw new Error('Unknown token in Light: "'.concat(t,'"'));this.readAnimation(e,"KLAV")}}writeMdl(e){e.startObjectBlock("Light",this.name),this.writeGenericHeader(e),0===this.type?e.writeFlag("Omnidirectional"):1===this.type?e.writeFlag("Directional"):2===this.type&&e.writeFlag("Ambient"),this.writeAnimation(e,"KLAS")||e.writeFloatAttrib("static AttenuationStart",this.attenuation[0]),this.writeAnimation(e,"KLAE")||e.writeFloatAttrib("static AttenuationEnd",this.attenuation[1]),this.writeAnimation(e,"KLAI")||e.writeFloatAttrib("static Intensity",this.intensity),this.writeAnimation(e,"KLAC")||e.writeColor("static Color",this.color),this.writeAnimation(e,"KLBI")||e.writeFloatAttrib("static AmbIntensity",this.ambientIntensity),this.writeAnimation(e,"KLBC")||e.writeColor("static AmbColor",this.ambientColor),this.writeAnimation(e,"KLAV"),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 48+super.getByteLength()}}class Ji extends Xi{readMdl(e){for(let t of super.readMdl(e))throw new Error('Unknown token in Helper: "'.concat(t,'"'))}writeMdl(e){e.startObjectBlock("Helper",this.name),this.writeGenericHeader(e),this.writeGenericAnimations(e),e.endBlock()}}class Zi extends Xi{constructor(){super(2048),this.path="",this.attachmentId=0}readMdx(e){let t=e.readUint32();super.readMdx(e),this.path=e.read(260),this.attachmentId=e.readInt32(),this.readAnimations(e,t-this.getByteLength())}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.write(this.path),e.skip(260-this.path.length),e.writeInt32(this.attachmentId),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(let t of super.readMdl(e))if("AttachmentID"===t)this.attachmentId=e.readInt();else if("Path"===t)this.path=e.read();else{if("Visibility"!==t)throw new Error("Unknown token in Attachment ".concat(this.name,': "').concat(t,'"'));this.readAnimation(e,"KATV")}}writeMdl(e){e.startObjectBlock("Attachment",this.name),this.writeGenericHeader(e),e.writeAttrib("AttachmentID",this.attachmentId),this.path.length&&e.writeStringAttrib("Path",this.path),this.writeAnimation(e,"KATV"),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 268+super.getByteLength()}}class $i extends Xi{constructor(){super(4096),this.emissionRate=0,this.gravity=0,this.longitude=0,this.latitude=0,this.path="",this.lifeSpan=0,this.speed=0}readMdx(e){let t=e.readUint32();super.readMdx(e),this.emissionRate=e.readFloat32(),this.gravity=e.readFloat32(),this.longitude=e.readFloat32(),this.latitude=e.readFloat32(),this.path=e.read(260),this.lifeSpan=e.readFloat32(),this.speed=e.readFloat32(),this.readAnimations(e,t-this.getByteLength())}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeFloat32(this.emissionRate),e.writeFloat32(this.gravity),e.writeFloat32(this.longitude),e.writeFloat32(this.latitude),e.write(this.path),e.skip(260-this.path.length),e.writeFloat32(this.lifeSpan),e.writeFloat32(this.speed),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(let t of super.readMdl(e))if("EmitterUsesMDL"===t)this.flags|=32768;else if("EmitterUsesTGA"===t)this.flags|=65536;else if("static EmissionRate"===t)this.emissionRate=e.readFloat();else if("EmissionRate"===t)this.readAnimation(e,"KPEE");else if("static Gravity"===t)this.gravity=e.readFloat();else if("Gravity"===t)this.readAnimation(e,"KPEG");else if("static Longitude"===t)this.longitude=e.readFloat();else if("Longitude"===t)this.readAnimation(e,"KPLN");else if("static Latitude"===t)this.latitude=e.readFloat();else if("Latitude"===t)this.readAnimation(e,"KPLT");else if("Visibility"===t)this.readAnimation(e,"KPEV");else{if("Particle"!==t)throw new Error('Unknown token in ParticleEmitter: "'.concat(t,'"'));for(t of this.readAnimatedBlock(e))"static LifeSpan"===t?this.lifeSpan=e.readFloat():"LifeSpan"===t?this.readAnimation(e,"KPEL"):"static InitVelocity"===t?this.speed=e.readFloat():"InitVelocity"===t?this.readAnimation(e,"KPES"):"Path"===t&&(this.path=e.read())}}writeMdl(e){e.startObjectBlock("ParticleEmitter",this.name),this.writeGenericHeader(e),32768&this.flags&&e.writeFlag("EmitterUsesMDL"),65536&this.flags&&e.writeFlag("EmitterUsesTGA"),this.writeAnimation(e,"KPEE")||e.writeFloatAttrib("static EmissionRate",this.emissionRate),this.writeAnimation(e,"KPEG")||e.writeFloatAttrib("static Gravity",this.gravity),this.writeAnimation(e,"KPLN")||e.writeFloatAttrib("static Longitude",this.longitude),this.writeAnimation(e,"KPLT")||e.writeFloatAttrib("static Latitude",this.latitude),this.writeAnimation(e,"KPEV"),e.startBlock("Particle"),this.writeAnimation(e,"KPEL")||e.writeFloatAttrib("static LifeSpan",this.lifeSpan),this.writeAnimation(e,"KPES")||e.writeFloatAttrib("static InitVelocity",this.speed),(32768&this.flags||65536&this.flags)&&e.writeAttrib("Path",this.path),e.endBlock(),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 288+super.getByteLength()}}class Qi extends Xi{constructor(){super(),this.speed=0,this.variation=0,this.latitude=0,this.gravity=0,this.lifeSpan=0,this.emissionRate=0,this.length=0,this.width=0,this.filterMode=0,this.rows=0,this.columns=0,this.headOrTail=0,this.tailLength=0,this.timeMiddle=0,this.segmentColors=[new Float32Array(3),new Float32Array(3),new Float32Array(3)],this.segmentAlphas=new Uint8Array(3),this.segmentScaling=new Float32Array(3),this.headIntervals=[new Uint32Array(3),new Uint32Array(3)],this.tailIntervals=[new Uint32Array(3),new Uint32Array(3)],this.textureId=-1,this.squirt=0,this.priorityPlane=0,this.replaceableId=0}readMdx(e){const t=e.readUint32();super.readMdx(e),this.speed=e.readFloat32(),this.variation=e.readFloat32(),this.latitude=e.readFloat32(),this.gravity=e.readFloat32(),this.lifeSpan=e.readFloat32(),this.emissionRate=e.readFloat32(),this.length=e.readFloat32(),this.width=e.readFloat32(),this.filterMode=e.readUint32(),this.rows=e.readUint32(),this.columns=e.readUint32(),this.headOrTail=e.readUint32(),this.tailLength=e.readFloat32(),this.timeMiddle=e.readFloat32(),e.readFloat32Array(this.segmentColors[0]),e.readFloat32Array(this.segmentColors[1]),e.readFloat32Array(this.segmentColors[2]),e.readUint8Array(this.segmentAlphas),e.readFloat32Array(this.segmentScaling),e.readUint32Array(this.headIntervals[0]),e.readUint32Array(this.headIntervals[1]),e.readUint32Array(this.tailIntervals[0]),e.readUint32Array(this.tailIntervals[1]),this.textureId=e.readInt32(),this.squirt=e.readUint32(),this.priorityPlane=e.readInt32(),this.replaceableId=e.readUint32(),this.readAnimations(e,t-this.getByteLength())}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeFloat32(this.speed),e.writeFloat32(this.variation),e.writeFloat32(this.latitude),e.writeFloat32(this.gravity),e.writeFloat32(this.lifeSpan),e.writeFloat32(this.emissionRate),e.writeFloat32(this.length),e.writeFloat32(this.width),e.writeUint32(this.filterMode),e.writeUint32(this.rows),e.writeUint32(this.columns),e.writeUint32(this.headOrTail),e.writeFloat32(this.tailLength),e.writeFloat32(this.timeMiddle),e.writeFloat32Array(this.segmentColors[0]),e.writeFloat32Array(this.segmentColors[1]),e.writeFloat32Array(this.segmentColors[2]),e.writeUint8Array(this.segmentAlphas),e.writeFloat32Array(this.segmentScaling),e.writeUint32Array(this.headIntervals[0]),e.writeUint32Array(this.headIntervals[1]),e.writeUint32Array(this.tailIntervals[0]),e.writeUint32Array(this.tailIntervals[1]),e.writeInt32(this.textureId),e.writeUint32(this.squirt),e.writeInt32(this.priorityPlane),e.writeUint32(this.replaceableId),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(const t of super.readMdl(e))if("SortPrimsFarZ"===t)this.flags|=65536;else if("Unshaded"===t)this.flags|=32768;else if("LineEmitter"===t)this.flags|=131072;else if("Unfogged"===t)this.flags|=262144;else if("ModelSpace"===t)this.flags|=524288;else if("XYQuad"===t)this.flags|=1048576;else if("static Speed"===t)this.speed=e.readFloat();else if("Speed"===t)this.readAnimation(e,"KP2S");else if("static Variation"===t)this.variation=e.readFloat();else if("Variation"===t)this.readAnimation(e,"KP2R");else if("static Latitude"===t)this.latitude=e.readFloat();else if("Latitude"===t)this.readAnimation(e,"KP2L");else if("static Gravity"===t)this.gravity=e.readFloat();else if("Gravity"===t)this.readAnimation(e,"KP2G");else if("Visibility"===t)this.readAnimation(e,"KP2V");else if("Squirt"===t)this.squirt=1;else if("LifeSpan"===t)this.lifeSpan=e.readFloat();else if("static EmissionRate"===t)this.emissionRate=e.readFloat();else if("EmissionRate"===t)this.readAnimation(e,"KP2E");else if("static Width"===t)this.width=e.readFloat();else if("Width"===t)this.readAnimation(e,"KP2W");else if("static Length"===t)this.length=e.readFloat();else if("Length"===t)this.readAnimation(e,"KP2N");else if("Blend"===t)this.filterMode=0;else if("Additive"===t)this.filterMode=1;else if("Modulate"===t)this.filterMode=2;else if("Modulate2x"===t)this.filterMode=3;else if("AlphaKey"===t)this.filterMode=4;else if("Rows"===t)this.rows=e.readInt();else if("Columns"===t)this.columns=e.readInt();else if("Head"===t)this.headOrTail=0;else if("Tail"===t)this.headOrTail=1;else if("Both"===t)this.headOrTail=2;else if("TailLength"===t)this.tailLength=e.readFloat();else if("Time"===t)this.timeMiddle=e.readFloat();else if("SegmentColor"===t){e.read();for(let t=0;t<3;t++)e.read(),e.readColor(this.segmentColors[t]);e.read()}else if("Alpha"===t)e.readIntArray(this.segmentAlphas);else if("ParticleScaling"===t)e.readFloatArray(this.segmentScaling);else if("LifeSpanUVAnim"===t)e.readIntArray(this.headIntervals[0]);else if("DecayUVAnim"===t)e.readIntArray(this.headIntervals[1]);else if("TailUVAnim"===t)e.readIntArray(this.tailIntervals[0]);else if("TailDecayUVAnim"===t)e.readIntArray(this.tailIntervals[1]);else if("TextureID"===t)this.textureId=e.readInt();else if("ReplaceableId"===t)this.replaceableId=e.readInt();else{if("PriorityPlane"!==t)throw new Error('Unknown token in ParticleEmitter2: "'.concat(t,'"'));this.priorityPlane=e.readInt()}}writeMdl(e){e.startObjectBlock("ParticleEmitter2",this.name),this.writeGenericHeader(e),65536&this.flags&&e.writeFlag("SortPrimsFarZ"),32768&this.flags&&e.writeFlag("Unshaded"),131072&this.flags&&e.writeFlag("LineEmitter"),262144&this.flags&&e.writeFlag("Unfogged"),524288&this.flags&&e.writeFlag("ModelSpace"),1048576&this.flags&&e.writeFlag("XYQuad"),this.writeAnimation(e,"KP2S")||e.writeFloatAttrib("static Speed",this.speed),this.writeAnimation(e,"KP2R")||e.writeFloatAttrib("static Variation",this.variation),this.writeAnimation(e,"KP2L")||e.writeFloatAttrib("static Latitude",this.latitude),this.writeAnimation(e,"KP2G")||e.writeFloatAttrib("static Gravity",this.gravity),this.writeAnimation(e,"KP2V"),this.squirt&&e.writeFlag("Squirt"),e.writeFloatAttrib("LifeSpan",this.lifeSpan),this.writeAnimation(e,"KP2E")||e.writeFloatAttrib("static EmissionRate",this.emissionRate),this.writeAnimation(e,"KP2W")||e.writeFloatAttrib("static Width",this.width),this.writeAnimation(e,"KP2N")||e.writeFloatAttrib("static Length",this.length),0===this.filterMode?e.writeFlag("Blend"):1===this.filterMode?e.writeFlag("Additive"):2===this.filterMode?e.writeFlag("Modulate"):3===this.filterMode?e.writeFlag("Modulate2x"):4===this.filterMode&&e.writeFlag("AlphaKey"),e.writeAttrib("Rows",this.rows),e.writeAttrib("Columns",this.columns),0===this.headOrTail?e.writeFlag("Head"):1===this.headOrTail?e.writeFlag("Tail"):2===this.headOrTail&&e.writeFlag("Both"),e.writeFloatAttrib("TailLength",this.tailLength),e.writeFloatAttrib("Time",this.timeMiddle),e.startBlock("SegmentColor"),e.writeColor("Color",this.segmentColors[0]),e.writeColor("Color",this.segmentColors[1]),e.writeColor("Color",this.segmentColors[2]),e.endBlockComma(),e.writeArrayAttrib("Alpha",this.segmentAlphas),e.writeFloatArrayAttrib("ParticleScaling",this.segmentScaling),e.writeArrayAttrib("LifeSpanUVAnim",this.headIntervals[0]),e.writeArrayAttrib("DecayUVAnim",this.headIntervals[1]),e.writeArrayAttrib("TailUVAnim",this.tailIntervals[0]),e.writeArrayAttrib("TailDecayUVAnim",this.tailIntervals[1]),e.writeAttrib("TextureID",this.textureId),0!==this.replaceableId&&e.writeAttrib("ReplaceableId",this.replaceableId),0!==this.priorityPlane&&e.writeAttrib("PriorityPlane",this.priorityPlane),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 175+super.getByteLength()}}class es extends Xi{constructor(){super(16384),this.heightAbove=0,this.heightBelow=0,this.alpha=0,this.color=new Float32Array(3),this.lifeSpan=0,this.textureSlot=0,this.emissionRate=0,this.rows=0,this.columns=0,this.materialId=0,this.gravity=0}readMdx(e){let t=e.readUint32();super.readMdx(e),this.heightAbove=e.readFloat32(),this.heightBelow=e.readFloat32(),this.alpha=e.readFloat32(),e.readFloat32Array(this.color),this.lifeSpan=e.readFloat32(),this.textureSlot=e.readUint32(),this.emissionRate=e.readUint32(),this.rows=e.readUint32(),this.columns=e.readUint32(),this.materialId=e.readInt32(),this.gravity=e.readFloat32(),this.readAnimations(e,t-this.getByteLength())}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeFloat32(this.heightAbove),e.writeFloat32(this.heightBelow),e.writeFloat32(this.alpha),e.writeFloat32Array(this.color),e.writeFloat32(this.lifeSpan),e.writeUint32(this.textureSlot),e.writeUint32(this.emissionRate),e.writeUint32(this.rows),e.writeUint32(this.columns),e.writeInt32(this.materialId),e.writeFloat32(this.gravity),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(let t of super.readMdl(e))if("static HeightAbove"===t)this.heightAbove=e.readFloat();else if("HeightAbove"===t)this.readAnimation(e,"KRHA");else if("static HeightBelow"===t)this.heightBelow=e.readFloat();else if("HeightBelow"===t)this.readAnimation(e,"KRHB");else if("static Alpha"===t)this.alpha=e.readFloat();else if("Alpha"===t)this.readAnimation(e,"KRAL");else if("static Color"===t)e.readColor(this.color);else if("Color"===t)this.readAnimation(e,"KRCO");else if("static TextureSlot"===t)this.textureSlot=e.readInt();else if("TextureSlot"===t)this.readAnimation(e,"KRTX");else if("Visibility"===t)this.readAnimation(e,"KRVS");else if("EmissionRate"===t)this.emissionRate=e.readInt();else if("LifeSpan"===t)this.lifeSpan=e.readFloat();else if("Gravity"===t)this.gravity=e.readFloat();else if("Rows"===t)this.rows=e.readInt();else if("Columns"===t)this.columns=e.readInt();else{if("MaterialID"!==t)throw new Error('Unknown token in RibbonEmitter: "'.concat(t,'"'));this.materialId=e.readInt()}}writeMdl(e){e.startObjectBlock("RibbonEmitter",this.name),this.writeGenericHeader(e),this.writeAnimation(e,"KRHA")||e.writeFloatAttrib("static HeightAbove",this.heightAbove),this.writeAnimation(e,"KRHB")||e.writeFloatAttrib("static HeightBelow",this.heightBelow),this.writeAnimation(e,"KRAL")||e.writeFloatAttrib("static Alpha",this.alpha),this.writeAnimation(e,"KRCO")||e.writeColor("static Color",this.color),this.writeAnimation(e,"KRTX")||e.writeAttrib("static TextureSlot",this.textureSlot),this.writeAnimation(e,"KPEV"),e.writeAttrib("EmissionRate",this.emissionRate),e.writeFloatAttrib("LifeSpan",this.lifeSpan),0!==this.gravity&&e.writeFloatAttrib("Gravity",this.gravity),e.writeAttrib("Rows",this.rows),e.writeAttrib("Columns",this.columns),e.writeAttrib("MaterialID",this.materialId),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 56+super.getByteLength()}}class ts extends Ni{constructor(){super(),this.name="",this.position=new Float32Array(3),this.fieldOfView=0,this.farClippingPlane=0,this.nearClippingPlane=0,this.targetPosition=new Float32Array(3)}readMdx(e){let t=e.readUint32();this.name=e.read(80),e.readFloat32Array(this.position),this.fieldOfView=e.readFloat32(),this.farClippingPlane=e.readFloat32(),this.nearClippingPlane=e.readFloat32(),e.readFloat32Array(this.targetPosition),this.readAnimations(e,t-120)}writeMdx(e){e.writeUint32(this.getByteLength()),e.write(this.name),e.skip(80-this.name.length),e.writeFloat32Array(this.position),e.writeFloat32(this.fieldOfView),e.writeFloat32(this.farClippingPlane),e.writeFloat32(this.nearClippingPlane),e.writeFloat32Array(this.targetPosition),this.writeAnimations(e)}readMdl(e){this.name=e.read();for(let t of e.readBlock())if("Position"===t)e.readFloatArray(this.position);else if("Translation"===t)this.readAnimation(e,"KCTR");else if("Rotation"===t)this.readAnimation(e,"KCRL");else if("FieldOfView"===t)this.fieldOfView=e.readFloat();else if("FarClip"===t)this.farClippingPlane=e.readFloat();else if("NearClip"===t)this.nearClippingPlane=e.readFloat();else{if("Target"!==t)throw new Error("Unknown token in Camera ".concat(this.name,': "').concat(t,'"'));for(t of e.readBlock())if("Position"===t)e.readFloatArray(this.targetPosition);else{if("Translation"!==t)throw new Error("Unknown token in Camera ".concat(this.name,"'s Target: \"").concat(t,'"'));this.readAnimation(e,"KTTR")}}}writeMdl(e){e.startObjectBlock("Camera",this.name),e.writeFloatArrayAttrib("Position",this.position),this.writeAnimation(e,"KCTR"),this.writeAnimation(e,"KCRL"),e.writeFloatAttrib("FieldOfView",this.fieldOfView),e.writeFloatAttrib("FarClip",this.farClippingPlane),e.writeFloatAttrib("NearClip",this.nearClippingPlane),e.startBlock("Target"),e.writeFloatArrayAttrib("Position",this.targetPosition),this.writeAnimation(e,"KTTR"),e.endBlock(),e.endBlock()}getByteLength(){return 120+super.getByteLength()}}class is extends Xi{constructor(){super(1024),this.globalSequenceId=-1,this.tracks=new Uint32Array(1)}readMdx(e){super.readMdx(e),e.skip(4);let t=e.readUint32();this.globalSequenceId=e.readInt32(),this.tracks=e.readUint32Array(t)}writeMdx(e){super.writeMdx(e),e.write("KEVT"),e.writeUint32(this.tracks.length),e.writeInt32(this.globalSequenceId),e.writeUint32Array(this.tracks)}readMdl(e){for(let t of super.readMdl(e)){if("EventTrack"!==t)throw new Error('Unknown token in EventObject: "'.concat(t,'"'));this.tracks=e.readIntArray(new Uint32Array(e.readInt()))}}writeMdl(e){e.startObjectBlock("EventObject",this.name),this.writeGenericHeader(e),e.startBlock("EventTrack",this.tracks.length);for(let t of this.tracks)e.writeFlag(t);e.endBlock(),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 12+this.tracks.byteLength+super.getByteLength()}}class ss extends Xi{constructor(){super(8192),this.type=-1,this.vertices=[new Float32Array(3),new Float32Array(3)],this.boundsRadius=0}readMdx(e){super.readMdx(e),this.type=e.readUint32(),e.readFloat32Array(this.vertices[0]),2!==this.type&&e.readFloat32Array(this.vertices[1]),2!==this.type&&3!==this.type||(this.boundsRadius=e.readFloat32())}writeMdx(e){super.writeMdx(e),e.writeUint32(this.type),e.writeFloat32Array(this.vertices[0]),2!==this.type&&e.writeFloat32Array(this.vertices[1]),2!==this.type&&3!==this.type||e.writeFloat32(this.boundsRadius)}readMdl(e){for(let t of super.readMdl(e))if("Plane"===t)this.type=0;else if("Box"===t)this.type=1;else if("Sphere"===t)this.type=2;else if("Cylinder"===t)this.type=3;else if("Vertices"===t){let t=e.readInt();e.read(),e.readFloatArray(this.vertices[0]),2===t&&e.readFloatArray(this.vertices[1]),e.read()}else{if("BoundsRadius"!==t)throw new Error('Unknown token in CollisionShape: "'.concat(t,'"'));this.boundsRadius=e.readFloat()}}writeMdl(e){let t;e.startObjectBlock("CollisionShape",this.name),this.writeGenericHeader(e);let i=2,s=!1;0===this.type?t="Plane":1===this.type?t="Box":2===this.type?(t="Sphere",i=1,s=!0):3===this.type&&(t="Cylinder",s=!0),e.writeFlag(t),e.startBlock("Vertices",i),e.writeFloatArray(this.vertices[0]),2===i&&e.writeFloatArray(this.vertices[1]),e.endBlock(),s&&e.writeFloatAttrib("BoundsRadius",this.boundsRadius),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){let e=16+super.getByteLength();return 2!==this.type&&(e+=12),2!==this.type&&3!==this.type||(e+=4),e}}class as{constructor(e,t,i){this.chunk=e.readUint8Array(new Uint8Array(t)),this.tag=i}getByteLength(){return this.chunk.byteLength}}class rs{constructor(e){this.version=800,this.name="",this.animationFile="",this.extent=new Si,this.blendTime=0,this.sequences=[],this.globalSequences=[],this.materials=[],this.textures=[],this.textureAnimations=[],this.geosets=[],this.geosetAnimations=[],this.bones=[],this.lights=[],this.helpers=[],this.attachments=[],this.pivotPoints=[],this.particleEmitters=[],this.particleEmitters2=[],this.ribbonEmitters=[],this.cameras=[],this.eventObjects=[],this.collisionShapes=[],this.unknownChunks=[],e&&this.load(e)}load(e){e instanceof ArrayBuffer?this.loadMdx(e):this.loadMdl(e)}loadMdx(e){let t=new Rt(e);if("MDLX"!==t.read(4))throw new Error("WrongMagicNumber");for(;t.remaining()>0;){let e=t.read(4),i=t.readUint32();"VERS"===e?this.loadVersionChunk(t):"MODL"===e?this.loadModelChunk(t):"SEQS"===e?this.loadStaticObjects(this.sequences,_i,t,i/132):"GLBS"===e?this.loadGlobalSequenceChunk(t,i):"MTLS"===e?this.loadDynamicObjects(this.materials,Gi,t,i):"TEXS"===e?this.loadStaticObjects(this.textures,Hi,t,i/268):"TXAN"===e?this.loadDynamicObjects(this.textureAnimations,Ki,t,i):"GEOS"===e?this.loadDynamicObjects(this.geosets,qi,t,i):"GEOA"===e?this.loadDynamicObjects(this.geosetAnimations,Wi,t,i):"BONE"===e?this.loadDynamicObjects(this.bones,zi,t,i):"LITE"===e?this.loadDynamicObjects(this.lights,Yi,t,i):"HELP"===e?this.loadDynamicObjects(this.helpers,Ji,t,i):"ATCH"===e?this.loadDynamicObjects(this.attachments,Zi,t,i):"PIVT"===e?this.loadPivotPointChunk(t,i):"PREM"===e?this.loadDynamicObjects(this.particleEmitters,$i,t,i):"PRE2"===e?this.loadDynamicObjects(this.particleEmitters2,Qi,t,i):"RIBB"===e?this.loadDynamicObjects(this.ribbonEmitters,es,t,i):"CAMS"===e?this.loadDynamicObjects(this.cameras,ts,t,i):"EVTS"===e?this.loadDynamicObjects(this.eventObjects,is,t,i):"CLID"===e?this.loadDynamicObjects(this.collisionShapes,ss,t,i):this.unknownChunks.push(new as(t,i,e))}}loadVersionChunk(e){this.version=e.readUint32()}loadModelChunk(e){this.name=e.read(80),this.animationFile=e.read(260),this.extent.readMdx(e),this.blendTime=e.readUint32()}loadStaticObjects(e,t,i,s){for(let a=0;a<s;a++){let s=new t;s.readMdx(i),e.push(s)}}loadGlobalSequenceChunk(e,t){for(let i=0,s=t/4;i<s;i++)this.globalSequences.push(e.readUint32())}loadDynamicObjects(e,t,i,s){let a=0;for(;a<s;){let s=new t;s.readMdx(i),a+=s.getByteLength(),e.push(s)}}loadPivotPointChunk(e,t){for(let i=0,s=t/12;i<s;i++)this.pivotPoints.push(e.readFloat32Array(new Float32Array(3)))}saveMdx(){let e=new ArrayBuffer(this.getByteLength()),t=new Rt(e);return t.write("MDLX"),this.saveVersionChunk(t),this.saveModelChunk(t),this.saveStaticObjectChunk(t,"SEQS",this.sequences,132),this.saveGlobalSequenceChunk(t),this.saveDynamicObjectChunk(t,"MTLS",this.materials),this.saveStaticObjectChunk(t,"TEXS",this.textures,268),this.saveDynamicObjectChunk(t,"TXAN",this.textureAnimations),this.saveDynamicObjectChunk(t,"GEOS",this.geosets),this.saveDynamicObjectChunk(t,"GEOA",this.geosetAnimations),this.saveDynamicObjectChunk(t,"BONE",this.bones),this.saveDynamicObjectChunk(t,"LITE",this.lights),this.saveDynamicObjectChunk(t,"HELP",this.helpers),this.saveDynamicObjectChunk(t,"ATCH",this.attachments),this.savePivotPointChunk(t),this.saveDynamicObjectChunk(t,"PREM",this.particleEmitters),this.saveDynamicObjectChunk(t,"PRE2",this.particleEmitters2),this.saveDynamicObjectChunk(t,"RIBB",this.ribbonEmitters),this.saveDynamicObjectChunk(t,"CAMS",this.cameras),this.saveDynamicObjectChunk(t,"EVTS",this.eventObjects),this.saveDynamicObjectChunk(t,"CLID",this.collisionShapes),e}saveVersionChunk(e){e.write("VERS"),e.writeUint32(4),e.writeUint32(this.version)}saveModelChunk(e){e.write("MODL"),e.writeUint32(372),e.write(this.name),e.skip(80-this.name.length),e.write(this.animationFile),e.skip(260-this.animationFile.length),this.extent.writeMdx(e),e.writeUint32(this.blendTime)}saveStaticObjectChunk(e,t,i,s){if(i.length){e.write(t),e.writeUint32(i.length*s);for(let t of i)t.writeMdx(e)}}saveGlobalSequenceChunk(e){if(this.globalSequences.length){e.write("GLBS"),e.writeUint32(4*this.globalSequences.length);for(let t of this.globalSequences)e.writeUint32(t)}}saveDynamicObjectChunk(e,t,i){if(i.length){e.write(t),e.writeUint32(this.getObjectsByteLength(i));for(let t of i)t.writeMdx(e)}}savePivotPointChunk(e){if(this.pivotPoints.length){e.write("PIVT"),e.writeUint32(12*this.pivotPoints.length);for(let t of this.pivotPoints)e.writeFloat32Array(t)}}loadMdl(e){let t,i=new li(e);for(;t=i.read();)if("Version"===t)this.loadVersionBlock(i);else if("Model"===t)this.loadModelBlock(i);else if("Sequences"===t)this.loadNumberedObjectBlock(this.sequences,_i,"Anim",i);else if("GlobalSequences"===t)this.loadGlobalSequenceBlock(i);else if("Textures"===t)this.loadNumberedObjectBlock(this.textures,Hi,"Bitmap",i);else if("Materials"===t)this.loadNumberedObjectBlock(this.materials,Gi,"Material",i);else if("TextureAnims"===t)this.loadNumberedObjectBlock(this.textureAnimations,Ki,"TVertexAnim",i);else if("Geoset"===t)this.loadObject(this.geosets,qi,i);else if("GeosetAnim"===t)this.loadObject(this.geosetAnimations,Wi,i);else if("Bone"===t)this.loadObject(this.bones,zi,i);else if("Light"===t)this.loadObject(this.lights,Yi,i);else if("Helper"===t)this.loadObject(this.helpers,Ji,i);else if("Attachment"===t)this.loadObject(this.attachments,Zi,i);else if("PivotPoints"===t)this.loadPivotPointBlock(i);else if("ParticleEmitter"===t)this.loadObject(this.particleEmitters,$i,i);else if("ParticleEmitter2"===t)this.loadObject(this.particleEmitters2,Qi,i);else if("RibbonEmitter"===t)this.loadObject(this.ribbonEmitters,es,i);else if("Camera"===t)this.loadObject(this.cameras,ts,i);else if("EventObject"===t)this.loadObject(this.eventObjects,is,i);else{if("CollisionShape"!==t)throw new Error("Unsupported block: ".concat(t));this.loadObject(this.collisionShapes,ss,i)}}loadVersionBlock(e){for(let t of e.readBlock()){if("FormatVersion"!==t)throw new Error('Unknown token in Version: "'.concat(t,'"'));this.version=e.readInt()}}loadModelBlock(e){this.name=e.read();for(let t of e.readBlock())if(t.startsWith("Num"))e.read();else if("BlendTime"===t)this.blendTime=e.readInt();else if("MinimumExtent"===t)e.readFloatArray(this.extent.min);else if("MaximumExtent"===t)e.readFloatArray(this.extent.max);else{if("BoundsRadius"!==t)throw new Error('Unknown token in Model: "'.concat(t,'"'));this.extent.boundsRadius=e.readFloat()}}loadNumberedObjectBlock(e,t,i,s){s.read();for(let a of s.readBlock()){if(a!==i)throw new Error("Unknown token in ".concat(i,': "').concat(a,'"'));{let i=new t;i.readMdl(s),e.push(i)}}}loadGlobalSequenceBlock(e){e.read();for(let t of e.readBlock()){if("Duration"!==t)throw new Error('Unknown token in GlobalSequences: "'.concat(t,'"'));this.globalSequences.push(e.readInt())}}loadObject(e,t,i){let s=new t;s.readMdl(i),e.push(s)}loadPivotPointBlock(e){let t=e.readInt();e.read();for(let i=0;i<t;i++)this.pivotPoints.push(e.readFloatArray(new Float32Array(3)));e.read()}saveMdl(){let e=new li;return this.saveVersionBlock(e),this.saveModelBlock(e),this.saveStaticObjectsBlock(e,"Sequences",this.sequences),this.saveGlobalSequenceBlock(e),this.saveStaticObjectsBlock(e,"Textures",this.textures),this.saveStaticObjectsBlock(e,"Materials",this.materials),this.saveStaticObjectsBlock(e,"TextureAnims",this.textureAnimations),this.saveObjects(e,this.geosets),this.saveObjects(e,this.geosetAnimations),this.saveObjects(e,this.bones),this.saveObjects(e,this.lights),this.saveObjects(e,this.helpers),this.saveObjects(e,this.attachments),this.savePivotPointBlock(e),this.saveObjects(e,this.particleEmitters),this.saveObjects(e,this.particleEmitters2),this.saveObjects(e,this.ribbonEmitters),this.saveObjects(e,this.cameras),this.saveObjects(e,this.eventObjects),this.saveObjects(e,this.collisionShapes),e.buffer}saveVersionBlock(e){e.startBlock("Version"),e.writeAttrib("FormatVersion",this.version),e.endBlock()}saveModelBlock(e){e.startObjectBlock("Model",this.name),e.writeAttrib("BlendTime",this.blendTime),this.extent.writeMdl(e),e.endBlock()}saveStaticObjectsBlock(e,t,i){if(i.length){e.startBlock(t,i.length);for(let t of i)t.writeMdl(e);e.endBlock()}}saveGlobalSequenceBlock(e){if(this.globalSequences.length){e.startBlock("GlobalSequences",this.globalSequences.length);for(let t of this.globalSequences)e.writeAttrib("Duration",t);e.endBlock()}}saveObjects(e,t){for(let i of t)i.writeMdl(e)}savePivotPointBlock(e){if(this.pivotPoints.length){e.startBlock("PivotPoints",this.pivotPoints.length);for(let t of this.pivotPoints)e.writeFloatArray(t);e.endBlock()}}getByteLength(){let e=396;return e+=this.getStaticObjectsChunkByteLength(this.sequences,132),e+=this.getStaticObjectsChunkByteLength(this.globalSequences,4),e+=this.getDynamicObjectsChunkByteLength(this.materials),e+=this.getStaticObjectsChunkByteLength(this.textures,268),e+=this.getDynamicObjectsChunkByteLength(this.textureAnimations),e+=this.getDynamicObjectsChunkByteLength(this.geosets),e+=this.getDynamicObjectsChunkByteLength(this.geosetAnimations),e+=this.getDynamicObjectsChunkByteLength(this.bones),e+=this.getDynamicObjectsChunkByteLength(this.lights),e+=this.getDynamicObjectsChunkByteLength(this.helpers),e+=this.getDynamicObjectsChunkByteLength(this.attachments),e+=this.getStaticObjectsChunkByteLength(this.pivotPoints,12),e+=this.getDynamicObjectsChunkByteLength(this.particleEmitters),e+=this.getDynamicObjectsChunkByteLength(this.particleEmitters2),e+=this.getDynamicObjectsChunkByteLength(this.ribbonEmitters),e+=this.getDynamicObjectsChunkByteLength(this.cameras),e+=this.getDynamicObjectsChunkByteLength(this.eventObjects),e+=this.getDynamicObjectsChunkByteLength(this.collisionShapes),e+=8*this.unknownChunks.length+this.getDynamicObjectsChunkByteLength(this.unknownChunks)}getObjectsByteLength(e){let t=0;for(let i of e)t+=i.getByteLength();return t}getDynamicObjectsChunkByteLength(e){return e.length?8+this.getObjectsByteLength(e):0}getStaticObjectsChunkByteLength(e,t){return e.length?8+e.length*t:0}}var ns={mdlx:{Model:rs},slk:st,w3x:Ti,ini:tt},os=i(2),ls=i(39),hs=i.n(ls);function cs(e,t){return e+Math.random()*(t-e)}function ds(e,t,i){return e+i*(t-e)}function us(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}let ms=document.createElement("canvas"),fs=ms.getContext("2d"),ps=document.createElement("canvas"),gs=ps.getContext("2d");function ws(e){let t=e.width,i=e.height,s=us(t),a=us(i);return t!==s||i!==a?function(e,t,i){let s=e.width,a=e.height;return e instanceof ImageData?(ms.width=s,ms.height=a,fs.putImageData(e,0,0),ps.width=t,ps.height=i,gs.drawImage(ms,0,0,t,i),gs.getImageData(0,0,t,i)):(ms.width=t,ms.height=i,fs.drawImage(e,0,0,t,i),fs.getImageData(0,0,t,i))}(e,s,a):e}async function vs(e,t){if("image"===t)return new Promise(t=>{let i=new Image;i.onload=(()=>{t({ok:!0,data:i})}),i.onerror=(e=>{t({ok:!1,error:"ImageError",data:e})}),i.src=e});{let s,a;try{s=await fetch(e)}catch(i){return{ok:!1,error:"NetworkError",data:i}}if(!s.ok)return{ok:!1,error:"HttpError",data:s};try{"text"===t?a=await s.text():"arrayBuffer"===t?a=await s.arrayBuffer():"blob"===t&&(a=await s.blob())}catch(i){return{ok:!1,error:"DataError",data:i}}return{ok:!0,data:a}}}function ys(e){let t=0;for(let i=0,s=e.length;i<s;i++)t=31*t+e.charCodeAt(i),t&=t;return t}let bs=/:(\d+):/g;class As{constructor(e,t,i){let s=e.createShader(i);if(this.ok=!1,this.webglResource=s,this.src=t,this.shaderType=i,e.shaderSource(s,t),e.compileShader(s),e.getShaderParameter(s,e.COMPILE_STATUS))this.ok=!0;else{let i=e.getShaderInfoLog(s),a=t.split("\n");console.error("Shader unit failed to compile!"),console.error(i);let r=bs.exec(i);for(;r;){let e=parseInt(r[1]);console.error(e+": "+a[e-1]),r=bs.exec(i)}}}}class Es{constructor(e,t,i){let s=e.createProgram(),a={},r={};if(this.ok=!1,this.webglResource=s,this.shaders=[t,i],this.uniforms=a,this.attribs=r,this.attribsCount=0,e.attachShader(s,t.webglResource),e.attachShader(s,i.webglResource),e.linkProgram(s),e.getProgramParameter(s,e.LINK_STATUS)){for(let t=0,i=e.getProgramParameter(s,e.ACTIVE_UNIFORMS);t<i;t++){let i=e.getActiveUniform(s,t);if(1===i.size)a[i.name]=e.getUniformLocation(s,i.name);else{let t=i.name.substr(0,i.name.length-3);for(let r=0;r<i.size;r++){let i=t+"["+r+"]";a[i]=e.getUniformLocation(s,i)}}}for(let t=0,i=e.getProgramParameter(s,e.ACTIVE_ATTRIBUTES);t<i;t++){let i=e.getActiveAttrib(s,t);if(this.attribsCount+=i.size,1===i.size)r[i.name]=e.getAttribLocation(s,i.name);else{let t=i.name.substr(0,i.name.length-3);for(let a=0;a<i.size;a++){let i=t+"["+a+"]";r[i]=e.getAttribLocation(s,i)}}}this.ok=!0}else console.error("Shader program failed to link!"),console.error(e.getProgramInfoLog(s))}}function xs(e){let t=e.split("_"),i=t[1];for(let s=2,a=t.length;s<a;s++)i+=t[s][0].toUpperCase()+t[s].substr(1);return i}class Ts{constructor(e,t){let i=e.getContext("webgl2",t||{alpha:!1,antialias:!1});if(this.webgl2=!0,i||(i=e.getContext("webgl",t||{alpha:!1,antialias:!1}),this.webgl2=!1),i||(i=e.getContext("experimental-webgl",t||{alpha:!1,antialias:!1})),!i)throw new Error("WebGL: Failed to create a WebGL context!");let s={};for(let n of i.getSupportedExtensions())n.startsWith("MOZ_")||(s[xs(n)]=i.getExtension(n));if(!i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS))throw new Error("WebGL: No vertex shader texture support!");if(!this.webgl2&&!s.textureFloat)throw new Error("WebGL: No floating point texture support!");if(!this.webgl2&&!s.instancedArrays)throw new Error("WebGL: No instanced rendering support!");if(this.webgl2&&(s.instancedArrays={VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE:i.VERTEX_ATTRIB_ARRAY_DIVISOR,drawArraysInstancedANGLE:i.drawArraysInstanced.bind(i),drawElementsInstancedANGLE:i.drawElementsInstanced.bind(i),vertexAttribDivisorANGLE:i.vertexAttribDivisor.bind(i)}),!this.webgl2){const e=i.texImage2D;i.RED=i.ALPHA,i.RG=i.LUMINANCE_ALPHA,i.texImage2D=function(t,s,a){for(var r=arguments.length,n=new Array(r>3?r-3:0),o=3;o<r;o++)n[o-3]=arguments[o];return a=n.length>3?n[3]:n[0],e.call(i,t,s,a,...n)}}i.extensions=s,i.depthFunc(i.LEQUAL),i.enable(i.DEPTH_TEST),this.gl=i,this.extensions=s,this.shaderUnits=new Map,this.shaderPrograms=new Map,this.currentShaderProgram=null,this.floatPrecision="precision mediump float;\n",this.shaderDefines="",this.webgl2?this.shaderDefines+="#define COMP1D r\n":this.shaderDefines+="#define COMP1D a\n";let a=new ImageData(2,2);for(let n=0;n<4;n++)a.data[4*n+3]=255;let r=i.createTexture();i.bindTexture(i.TEXTURE_2D,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.REPEAT),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.REPEAT),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,a),this.emptyTexture=r}createShaderUnit(e,t){let i=ys(e),s=this.shaderUnits;return s.has(i)||s.set(i,new As(this.gl,e,t)),s.get(i)}createShaderProgram(e,t){let i=this.gl,s=this.createShaderUnit(this.shaderDefines+e,i.VERTEX_SHADER),a=this.createShaderUnit(this.floatPrecision+this.shaderDefines+t,i.FRAGMENT_SHADER),r=this.shaderPrograms;if(s.ok&&a.ok){let n=ys(e+t);r.has(n)||r.set(n,new Es(i,s,a));let o=r.get(n);if(o.ok)return o}}enableVertexAttribs(e,t){let i=this.gl;for(let s=e;s<t;s++)i.enableVertexAttribArray(s)}disableVertexAttribs(e,t){let i=this.gl;for(let s=e;s<t;s++)i.disableVertexAttribArray(s)}useShaderProgram(e){let t=this.currentShaderProgram;if(e&&e.ok&&e!==t){let i=0,s=e.attribsCount;t&&(i=t.attribsCount),this.gl.useProgram(e.webglResource),s>i?this.enableVertexAttribs(i,s):s<i&&this.disableVertexAttribs(s,i),this.currentShaderProgram=e}}bindTexture(e,t){let i=this.gl;i.activeTexture(i.TEXTURE0+t),e&&e.ok?i.bindTexture(i.TEXTURE_2D,e.webglResource):i.bindTexture(i.TEXTURE_2D,this.emptyTexture)}}class Ss extends hs.a{promise(){this.emit("loadstart",this)}resolve(){this.emit("loadend",this)}}let _s=os.vec3.fromValues(1,0,0),Is=os.vec3.fromValues(0,1,0),Rs=os.vec3.fromValues(0,0,1),Cs=os.vec3.create(),Bs=os.vec3.fromValues(1,1,1),Fs=(os.quat.fromValues(0,0,0,0),os.quat.create()),Ls=os.vec4.create();function Ds(e,t,i,s){let a=2*(t[0]-s[0])/s[2]-1,r=1-2*(t[1]-s[1])/s[3],n=2*t[2]-1;return os.vec4.set(Ls,a,r,n,1),os.vec4.transformMat4(Ls,Ls,i),os.vec3.set(e,Ls[0]/Ls[3],Ls[1]/Ls[3],Ls[2]/Ls[3]),e}function Ms(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]}function Us(e,t){let i=os.vec3.len(t);e[0]=t[0]/i,e[1]=t[1]/i,e[2]=t[2]/i,e[3]=t[3]/i}os.vec3.create();let Ps=os.vec3.create(),ks=os.vec3.create(),Ns=os.vec3.create(),Os=os.quat.create(),js=os.mat4.create();class Vs{constructor(){this.rect=os.vec4.create(),this.isPerspective=!0,this.fov=0,this.aspect=0,this.isOrtho=!1,this.leftClipPlane=0,this.rightClipPlane=0,this.bottomClipPlane=0,this.topClipPlane=0,this.nearClipPlane=0,this.farClipPlane=0,this.location=os.vec3.create(),this.rotation=os.quat.create(),this.inverseRotation=os.quat.create(),this.worldMatrix=os.mat4.create(),this.projectionMatrix=os.mat4.create(),this.worldProjectionMatrix=os.mat4.create(),this.inverseWorldMatrix=os.mat4.create(),this.inverseRotationMatrix=os.mat4.create(),this.inverseWorldProjectionMatrix=os.mat4.create(),this.directionX=os.vec3.create(),this.directionY=os.vec3.create(),this.directionZ=os.vec3.create(),this.vectors=[os.vec3.fromValues(-1,-1,0),os.vec3.fromValues(-1,1,0),os.vec3.fromValues(1,1,0),os.vec3.fromValues(1,-1,0),os.vec3.fromValues(1,0,0),os.vec3.fromValues(0,1,0),os.vec3.fromValues(0,0,1)],this.billboardedVectors=[os.vec3.create(),os.vec3.create(),os.vec3.create(),os.vec3.create(),os.vec3.create(),os.vec3.create(),os.vec3.create()],this.planes=[os.vec4.create(),os.vec4.create(),os.vec4.create(),os.vec4.create(),os.vec4.create(),os.vec4.create()],this.dirty=!0}perspective(e,t,i,s){this.isPerspective=!0,this.isOrtho=!1,this.fov=e,this.aspect=t,this.nearClipPlane=i,this.farClipPlane=s,this.dirty=!0}ortho(e,t,i,s,a,r){this.isPerspective=!1,this.isOrtho=!0,this.leftClipPlane=e,this.rightClipPlane=t,this.bottomClipPlane=i,this.topClipPlane=s,this.nearClipPlane=a,this.farClipPlane=r,this.dirty=!0}viewport(e){os.vec4.copy(this.rect,e),this.aspect=e[2]/e[3],this.dirty=!0}setLocation(e){os.vec3.copy(this.location,e),this.dirty=!0}move(e){os.vec3.add(this.location,this.location,e),this.dirty=!0}setRotation(e){os.quat.copy(this.rotation,e),this.dirty=!0}rotate(e){os.quat.mul(this.rotation,this.rotation,e),this.dirty=!0}setRotationAngles(e,t){os.quat.identity(this.rotation),this.rotateAngles(e,t)}rotateAround(e,t){this.rotate(e),os.quat.conjugate(Os,Os),os.vec3.sub(Ps,this.location,t),os.vec3.transformQuat(Ps,Ps,e),os.vec3.add(this.location,Ps,t)}setRotationAround(e,t,i){this.setRotation(e),null==i&&(i=os.vec3.len(os.vec3.sub(Ps,this.location,t))),os.quat.conjugate(Os,Os),os.vec3.copy(Ps,Rs),os.vec3.transformQuat(Ps,Ps,Os),os.vec3.scale(Ps,Ps,i),os.vec3.add(this.location,Ps,t)}setRotationAroundAngles(e,t,i,s){os.quat.identity(Os),os.quat.rotateX(Os,Os,t),os.quat.rotateZ(Os,Os,e),this.setRotationAround(Os,i,s)}face(e,t){os.mat4.lookAt(js,this.location,e,t),os.mat4.getRotation(this.rotation,js),this.dirty=!0}moveToAndFace(e,t,i){os.vec3.copy(this.location,e),this.face(t,i)}reset(){os.vec3.set(this.location,0,0,0),os.quat.identity(this.rotation),this.dirty=!0}update(){if(this.dirty){this.dirty=!1;let e=this.location,t=this.rotation,i=this.inverseRotation,s=this.worldMatrix,a=this.projectionMatrix,r=this.worldProjectionMatrix,n=this.vectors,o=this.billboardedVectors;this.isPerspective?os.mat4.perspective(a,this.fov,this.aspect,this.nearClipPlane,this.farClipPlane):os.mat4.ortho(a,this.leftClipPlane,this.rightClipPlane,this.bottomClipPlane,this.topClipPlane,this.nearClipPlane,this.farClipPlane),os.mat4.fromQuat(s,t),os.mat4.translate(s,s,os.vec3.negate(Ps,e)),os.quat.conjugate(i,t),os.mat4.mul(r,a,s),function(e,t){let i,s=t[0],a=t[4],r=t[8],n=t[12],o=t[1],l=t[5],h=t[9],c=t[13],d=t[2],u=t[6],m=t[10],f=t[14],p=t[3],g=t[7],w=t[11],v=t[15];(i=e[0])[0]=p+s,i[1]=g+a,i[2]=w+r,i[3]=v+n,(i=e[1])[0]=p-s,i[1]=g-a,i[2]=w-r,i[3]=v-n,(i=e[2])[0]=p-o,i[1]=g-l,i[2]=w-h,i[3]=v-c,(i=e[3])[0]=p+o,i[1]=g+l,i[2]=w+h,i[3]=v+c,(i=e[4])[0]=p+d,i[1]=g+u,i[2]=w+m,i[3]=v+f,(i=e[5])[0]=p-d,i[1]=g-u,i[2]=w-m,i[3]=v-f,Us(e[0],e[0]),Us(e[1],e[1]),Us(e[2],e[2]),Us(e[3],e[3]),Us(e[4],e[4]),Us(e[5],e[5])}(this.planes,r),os.mat4.invert(this.inverseWorldMatrix,s),os.vec3.transformQuat(this.directionX,_s,i),os.vec3.transformQuat(this.directionY,Is,i),os.vec3.transformQuat(this.directionZ,Rs,i),os.mat4.invert(this.inverseWorldProjectionMatrix,r);for(let l=0;l<7;l++)os.vec3.transformQuat(o[l],n[l],i)}}testSphere(e,t){for(let i of this.planes)if(Ms(i,e)<=-t)return!1;return!0}cameraToWorld(e,t){return os.vec3.transformMat4(e,t,this.inverseWorldMatrix)}worldToCamera(e,t){return os.vec3.transformMat4(e,t,this.worldMatrix)}worldToScreen(e,t){let i=this.rect;return os.vec3.transformMat4(Ps,t,this.worldProjectionMatrix),e[0]=Math.round((Ps[0]+1)/2*i[2]),e[1]=Math.round((1-Ps[1])/2*i[3]),e}screenToWorldRay(e,t){let i=Ps,s=ks,a=Ns,r=t[0],n=t[1],o=this.inverseWorldProjectionMatrix,l=this.rect;return Ds(i,os.vec3.set(a,r,n,0),o,l),Ds(s,os.vec3.set(a,r,n,1),o,l),e.set(i,0),e.set(s,3),e}}let Gs=os.vec3.create(),Hs=os.quat.create(),Ks=os.vec3.create(),qs=e=>(class extends e{constructor(){super(),this.pivot=os.vec3.create(),this.localLocation=os.vec3.create(),this.localRotation=os.quat.create(),this.localScale=os.vec3.fromValues(1,1,1),this.worldLocation=os.vec3.create(),this.worldRotation=os.quat.create(),this.worldScale=os.vec3.create(),this.inverseWorldLocation=os.vec3.create(),this.inverseWorldRotation=os.quat.create(),this.inverseWorldScale=os.vec3.create(),this.localMatrix=os.mat4.create(),this.worldMatrix=os.mat4.create(),this.parent=null,this.children=[],this.dontInheritTranslation=!1,this.dontInheritRotation=!1,this.dontInheritScaling=!0,this.visible=!0,this.wasDirty=!1,this.dirty=!0}setPivot(e){return os.vec3.copy(this.pivot,e),this.dirty=!0,this}setLocation(e){return os.vec3.copy(this.localLocation,e),this.dirty=!0,this}setRotation(e){return os.quat.copy(this.localRotation,e),this.dirty=!0,this}setScale(e){return os.vec3.copy(this.localScale,e),this.dirty=!0,this}setUniformScale(e){return os.vec3.set(this.localScale,e,e,e),this.dirty=!0,this}setTransformation(e,t,i){let s=this.localLocation,a=this.localRotation,r=this.localScale;return s[0]=e[0],s[1]=e[1],s[2]=e[2],a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],r[0]=i[0],r[1]=i[1],r[2]=i[2],this.dirty=!0,this}resetTransformation(){return os.vec3.copy(this.pivot,Cs),os.vec3.copy(this.localLocation,Cs),os.quat.copy(this.localRotation,Fs),os.vec3.copy(this.localScale,Bs),this.dirty=!0,this}movePivot(e){return os.vec3.add(this.pivot,this.pivot,e),this.dirty=!0,this}move(e){return os.vec3.add(this.localLocation,this.localLocation,e),this.dirty=!0,this}rotate(e){return os.quat.mul(this.localRotation,this.localRotation,e),this.dirty=!0,this}rotateLocal(e){return os.quat.mul(this.localRotation,e,this.localRotation),this.dirty=!0,this}scale(e){return os.vec3.mul(this.localScale,this.localScale,e),this.dirty=!0,this}uniformScale(e){return os.vec3.scale(this.localScale,this.localScale,e),this.dirty=!0,this}setParent(e){if(this.parent){let e=this.parent.children,t=e.indexOf(this);-1!==t&&e.splice(t,1)}return this.parent=e,e&&e.children.push(this),this.dirty=!0,this}recalculateTransformation(){let e=this.dirty,t=this.parent;if(this.wasDirty=this.dirty,t&&(e=e||t.wasDirty),this.wasDirty=e,e){this.dirty=!1;let e=this.localMatrix,i=this.localLocation,s=this.localRotation,a=this.localScale,r=this.worldMatrix,n=this.worldLocation,o=this.worldRotation,l=this.worldScale,h=this.inverseWorldLocation,c=this.inverseWorldRotation,d=this.inverseWorldScale;if(t){let n,h,c=t.pivot;if((n=Gs)[0]=i[0]+c[0],n[1]=i[1]+c[1],n[2]=i[2]+c[2],this.dontInheritScaling){h=Ks;let e=t.inverseWorldScale;h[0]=e[0]*a[0],h[1]=e[1]*a[1],h[2]=e[2]*a[2],l[0]=a[0],l[1]=a[1],l[2]=a[2]}else{h=a;let e=t.worldScale;l[0]=e[0]*a[0],l[1]=e[1]*a[1],l[2]=e[2]*a[2]}os.mat4.fromRotationTranslationScale(e,s,n,h),os.mat4.mul(r,t.worldMatrix,e),os.quat.mul(o,t.worldRotation,s)}else os.mat4.fromRotationTranslationScale(e,s,i,a),r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15],o[0]=s[0],o[1]=s[1],o[2]=s[2],o[3]=s[3],l[0]=a[0],l[1]=a[1],l[2]=a[2];c[0]=-o[0],c[1]=-o[1],c[2]=-o[2],c[3]=o[3],d[0]=1/l[0],d[1]=1/l[1],d[2]=1/l[2],n[0]=r[12],n[1]=r[13],n[2]=r[14],h[0]=-n[0],h[1]=-n[1],h[2]=-n[2]}}update(e){this.dirty||this.parent&&this.parent.wasDirty?(this.dirty=!0,this.wasDirty=!0,this.recalculateTransformation()):this.wasDirty=!1,this.updateObject(e),this.updateChildren(e)}updateObject(e){}updateChildren(e){let t=this.children;for(let i=0,s=t.length;i<s;i++)t[i].update(e)}});class Ws extends(qs(class{})){}class Xs extends(qs(hs.a)){}class zs{constructor(e){this.pivot=e[0],this.localLocation=e[1],this.localRotation=e[2],this.localScale=e[3],this.worldLocation=e[4],this.worldRotation=e[5],this.worldScale=e[6],this.inverseWorldLocation=e[7],this.inverseWorldRotation=e[8],this.inverseWorldScale=e[9],this.localMatrix=e[10],this.worldMatrix=e[11],this.dontInheritTranslation=!1,this.dontInheritRotation=!1,this.dontInheritScaling=!1,this.children=[],this.visible=!0,this.wasDirty=!1,this.object=null,this.localRotation[3]=1,this.localScale.fill(1),this.localMatrix[0]=1,this.localMatrix[5]=1,this.localMatrix[10]=1,this.localMatrix[15]=1,this.dirty=!0,this.billboarded=!1,this.billboardedX=!1,this.billboardedY=!1,this.billboardedZ=!1}recalculateTransformation(e){let t,i,s=this.localMatrix,a=this.localRotation,r=this.localScale,n=this.worldMatrix,o=this.worldLocation,l=this.worldRotation,h=this.worldScale,c=this.pivot,d=this.inverseWorldLocation,u=this.inverseWorldRotation,m=this.inverseWorldScale,f=this.parent;if(this.dontInheritScaling){i=Ks;let e=f.inverseWorldScale;i[0]=e[0]*r[0],i[1]=e[1]*r[1],i[2]=e[2]*r[2],h[0]=r[0],h[1]=r[1],h[2]=r[2]}else{i=r;let e=f.worldScale;h[0]=e[0]*r[0],h[1]=e[1]*r[1],h[2]=e[2]*r[2]}this.billboarded?(t=Hs,os.quat.copy(t,f.inverseWorldRotation),os.quat.mul(t,t,e.camera.inverseRotation),this.convertBasis(t)):t=a,os.mat4.fromRotationTranslationScaleOrigin(s,t,this.localLocation,i,c),os.mat4.mul(n,f.worldMatrix,s),os.quat.mul(l,f.worldRotation,t),u[0]=-l[0],u[1]=-l[1],u[2]=-l[2],u[3]=l[3],m[0]=1/h[0],m[1]=1/h[1],m[2]=1/h[2];let p=c[0],g=c[1],w=c[2];o[0]=n[0]*p+n[4]*g+n[8]*w+n[12],o[1]=n[1]*p+n[5]*g+n[9]*w+n[13],o[2]=n[2]*p+n[6]*g+n[10]*w+n[14],d[0]=-o[0],d[1]=-o[1],d[2]=-o[2]}updateChildren(e){let t=this.children;for(let i=0,s=t.length;i<s;i++)t[i].update(e)}convertBasis(e){}}const Ys=65;let Js=new Float32Array(3);class Zs{constructor(e){let t=e.canvas;this.viewer=e,this.camera=new Vs,this.instances=[],this.instanceSet=new Set,this.modelViews=[],this.modelViewSet=new Set,this.node=new Ws,this.rendered=!0,this.renderedInstances=0,this.renderedParticles=0,this.renderedBuckets=0,this.renderCalls=0,this.audioEnabled=!1,this.audioContext=null,this.node.recalculateTransformation(this),this.node.wasDirty=!1,this.camera.viewport([0,0,t.width,t.height]),this.camera.perspective(Math.PI/4,t.width/t.height,8,1e4)}async enableAudio(){return this.audioContext||(this.audioContext=new AudioContext),"suspended"!==this.audioContext.state&&await this.audioContext.resume(),this.audioEnabled="running"===this.audioContext.state,this.audioEnabled}disableAudio(){this.audioContext&&this.audioContext.suspend(),this.audioEnabled=!1}addInstance(e){let t=this.instanceSet;return!t.has(e)&&(t.add(e),this.instances.push(e),e.scene&&e.scene.removeInstance(e),e.modelView.sceneChanged(e,this),e.scene=this,e.parent||e.setParent(this.node),this.addView(e.modelView),!0)}addView(e){let t=this.modelViewSet;t.has(e)||(t.add(e),this.modelViews.push(e))}removeInstance(e){if(this.instanceSet.delete(e)){let t=this.instances;return t.splice(t.indexOf(e),1),e.modelView.sceneChanged(e,null),e.scene=null,e.parent===this.node&&e.setParent(null),this.removeView(e.modelView),!0}return!1}removeView(e){if(this.modelViewSet.delete(e)){let t=this.modelViews;t.splice(t.indexOf(e),1)}}clear(){this.instances.length=0,this.instanceSet.clear(),this.modelViews.length=0,this.modelViewSet.clear()}detach(){return!!this.viewer&&this.viewer.removeScene(this)}update(){if(this.rendered){this.node.updateChildren(this),this.renderedInstances=0,this.renderedParticles=0,this.renderedBuckets=0,this.renderCalls=0;for(let e of this.modelViews)e.update(this),this.renderedInstances+=e.renderedInstances,this.renderedParticles+=e.renderedParticles,this.renderedBuckets+=e.renderedBuckets,this.renderCalls+=e.renderCalls;if(this.audioContext){let[e,t,i]=this.camera.location;this.audioContext.listener.setPosition(-e,-t,-i)}this.camera.update()}}isVisible(e){let t=e.model.bounds;if(t){let i=t.center,s=e.worldLocation;return Js[0]=s[0]+i[0],Js[1]=s[1]+i[1],Js[2]=s[2]+i[2],this.camera.testSphere(Js,t.radius)}{let t=this.camera.worldProjectionMatrix;return os.vec3.transformMat4(Js,e.worldLocation,t),Js[0]>=-1&&Js[0]<=1&&Js[1]>=-1&&Js[1]<=1&&Js[2]>=-1&&Js[2]<=1}}renderOpaque(){if(this.rendered){this.viewport();for(let e of this.modelViews)e.renderOpaque(this)}}renderTranslucent(){if(this.rendered){this.viewport();for(let e of this.modelViews)e.renderTranslucent(this)}}viewport(){let e=this.camera.rect;this.viewer.gl.viewport(e[0],e[1],e[2],e[3])}clearEmittedObjects(){for(let e of this.instances)e.clearEmittedObjects()}}class $s extends hs.a{constructor(e){let{viewer:t,handler:i,extension:s,pathSolver:a,fetchUrl:r="",path:n}=e;super(),this.viewer=t,this.handler=i||null,this.extension=s||"",this.pathSolver=a||null,this.fetchUrl=r,this.ok=!1,this.loaded=!1,this.path=n,this.setMaxListeners(0)}loadData(e){this.loaded=!0;try{this.load(e),this.ok=!0,this.lateLoad(),this.emit("load",this),this.emit("loadend",this)}catch(t){this.error("InvalidData",t)}}load(e){}detach(){return this.viewer.unload(this)}lateLoad(){}error(e,t){this.loaded=!0,console.info("[ResLoad] Failed on ",this.path,this.fetchUrl),this.emit("loadend",this)}whenLoaded(){return new Promise((e,t)=>{this.loaded?e(this):this.once("loadend",()=>e(this))})}}class Qs extends $s{constructor(e){super(e),this.width=0,this.height=0,this.wrapS=!1,this.wrapT=!1}setParameters(e,t,i,s){const a=this.viewer.gl;a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,e),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,t),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,i),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,s)}bind(e){let t=this.viewer,i=this.viewer.gl;t.webgl.bindTexture(this,e),this.wrapS?i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.REPEAT):i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),this.wrapT?i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.REPEAT):i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE)}}class ea extends Qs{load(e){if(e instanceof HTMLImageElement||e instanceof HTMLVideoElement||e instanceof HTMLCanvasElement||e instanceof ImageData){let t=this.viewer.gl;e instanceof ImageData||(e=function(e){let t=e.width,i=e.height;return ms.width=t,ms.height=i,fs.drawImage(e,0,0),fs.getImageData(0,0,t,i)}(e)),this.originalData=e,e=ws(e);let i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),this.setParameters(t.REPEAT,t.REPEAT,t.LINEAR,t.LINEAR_MIPMAP_LINEAR),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.generateMipmap(t.TEXTURE_2D),this.imageData=e,this.width=e.width,this.height=e.height,this.webglResource=i}else e instanceof WebGLTexture&&(this.webglResource=e)}}var ta={extensions:[[".png","image"],[".jpg","image"],[".gif","image"]],Constructor:ea};class ia extends $s{constructor(e){super(e),this.data=null}load(e){this.data=e}}class sa extends hs.a{constructor(e,t){super(),this.appendParam=((e,t)=>{if(!e.startsWith("blob:")&&t)for(const i in t)t[i]&&(e+=-1==e.indexOf("?")?"?":"&",e+=i,e+="=",e+=t[i]);return e}),this.resourcesMap=new Map,this.resources=[],this.frameTime=1e3/60,this.canvas=e,this.webgl=new Ts(e,t),this.gl=this.webgl.gl,this.shaderMap=new Map,this.handlers=new Set,this.scenes=[],this.resourcesLoading=new Set,this.on("loadstart",e=>{this.resourcesLoading.add(e)}),this.on("loadend",e=>{this.resourcesLoading.delete(e),0===this.resourcesLoading.size&&setTimeout(()=>this.emit("idle"),0)}),this.noCulling=!1,this.noUpdating=!1,this.textureAtlases={},this.batchSize=8,this.renderedInstances=0,this.renderedParticles=0,this.renderedBuckets=0,this.renderedScenes=0,this.renderCalls=0,this.enableAudio=!1,this.addHandler(ta)}addHandler(e){if(e){let t=this.handlers;if(e.handler&&(e=e.handler),!t.has(e))return e.load&&!e.load(this)?(this.emit("error",this,"InvalidHandler","FailedToLoad"),!1):(t.add(e),!0)}return!1}addScene(){let e=new Zs(this);return this.scenes.push(e),e}removeScene(e){let t=this.scenes,i=t.indexOf(e);return-1!==i&&(t.splice(i,1),!0)}clear(){let e=this.scenes;for(let t=e.length;t--;)this.removeScene(e[t])}findHandler(e){for(let t of this.handlers)for(let i of t.extensions)if(e===i[0])return[t,i[1]]}load(e,t){if(e){let i,s,a="string"===typeof e?e:null;e instanceof HTMLImageElement||e instanceof HTMLVideoElement||e instanceof HTMLCanvasElement||e instanceof ImageData||e instanceof WebGLTexture?(i=".png",s=!1,t=null):[e,i,s]=t(e);let r=this.findHandler(i.toLowerCase());if(r){let n=this.resourcesMap.get(e);if(n)return n;let o=r[0];if(n=new o.Constructor({viewer:this,handler:o,extension:i,pathSolver:t,fetchUrl:s?e:"",path:a}),this.resources.push(n),this.resourcesMap.set(e,n),this.registerEvents(n),n.emit("loadstart",n),s){let t=r[1];vs(e=this.appendParam(e,{src:a}),t).then(e=>{let t=e.data;e.ok?n.loadData(t):n.error("FailedToFetch")})}else n.loadData(e);return n}return this.emit("error",this,"MissingHandler",[e,i,s]),null}}exists(e){return this.resourcesMap.has(e)}loadGeneric(e,t,i,s){let a=this.resourcesMap.get(e);if(a)return a;function r(e){i&&(e=i(e))instanceof Promise?e.then(e=>a.loadData(e)):a.loadData(e)}return a=new ia({viewer:this,handler:i,fetchUrl:e,path:s}),this.resources.push(a),this.resourcesMap.set(e,a),this.registerEvents(a),a.emit("loadstart",a),e instanceof ArrayBuffer?r(e):vs(e=this.appendParam(e,{dataType:t,src:s}),t).then(e=>{let t=e.data;e.ok?r(t):a.error("FailedToFetch")}),a}unload(e){for(let[t,i]of this.resourcesMap)if(i===e)return this.resourcesMap.delete(t),this.resources.splice(this.resources.indexOf(e),1),!0;return!1}loadShader(e,t,i){let s=this.shaderMap;return s.has(e)||s.set(e,this.webgl.createShaderProgram(t,i)),s.get(e)}loadTextureAtlas(e,t){let i=this.textureAtlases;if(!i[e]){let s={texture:new ea({viewer:this}),columns:0,rows:0},a=this.promise();this.whenLoaded(t).then(e=>{for(let i of e)if(!i.ok)return void a.resolve();let t=function(e){let t=e[0].width,i=e[0].height,s=us(Math.ceil(Math.sqrt(e.length))),a=us(Math.ceil(e.length/s));ms.width=t*s,ms.height=i*a;for(let r=0,n=e.length;r<n;r++)fs.putImageData(e[r],r%s*t,Math.floor(r/s)*i);return{imageData:fs.getImageData(0,0,ms.width,ms.height),columns:s,rows:a}}(e.map(e=>e.imageData));s.texture.loadData(t.imageData),s.columns=t.columns,s.rows=t.rows,a.resolve()}),i[e]=s}return i[e]}getTextureAtlas(e){let t=this.textureAtlases[e];return t?t.texture:null}promise(){let e=new Ss;return this.registerEvents(e),e.promise(),e}whenLoaded(e){let t=[];for(let i of e)i&&i.whenLoaded&&t.push(i.whenLoaded());return Promise.all(t)}whenAllLoaded(){return new Promise((e,t)=>{0===this.resourcesLoading.size?e(this):this.once("idle",()=>e(this))})}toBlob(){return new Promise(e=>this.canvas.toBlob(t=>e(t)))}updateAndRender(){this.update(),this.startFrame(),this.render()}update(){let e=this.scenes;this.renderedInstances=0,this.renderedParticles=0,this.renderedBuckets=0,this.renderedScenes=0,this.renderCalls=0;for(let t=0,i=e.length;t<i;t++){let i=e[t];i.rendered&&(i.update(),this.renderedInstances+=i.renderedInstances,this.renderedParticles+=i.renderedParticles,this.renderedBuckets+=i.renderedBuckets,this.renderedScenes+=1,this.renderCalls+=i.renderCalls)}}startFrame(){let e=this.gl;e.depthMask(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}render(){this.renderOpaque(),this.renderTranslucent()}renderOpaque(){for(let e of this.scenes)e.renderOpaque()}renderTranslucent(){for(let e of this.scenes)e.renderTranslucent()}registerEvents(e){var t=this;["loadstart","load","error","loadend"].map(i=>e.on(i,function(){for(var e=arguments.length,s=new Array(e),a=0;a<e;a++)s[a]=arguments[a];return t.emit(i,...s)}))}clearEmittedObjects(){for(let e of this.scenes)e.clearEmittedObjects()}}class aa{constructor(e){this.model=e,this.instanceSet=new Set,this.sceneData=new Map,this.renderedInstances=0,this.renderedParticles=0,this.renderedBuckets=0,this.renderCalls=0}getShallowCopy(){return null}applyShallowCopy(e){}equals(e){return!0}lateLoad(){for(let e of this.instanceSet)this.addSceneData(e,e.scene)}addSceneData(e,t){if(this.model.ok&&t){let i=this.sceneData,s=i.get(t);s||(s=this.createSceneData(t),i.set(t,s)),s.instances.push(e)}}addInstance(e){let t=this.instanceSet;if(!t.has(e)){let i=e.modelView;return i&&i.removeInstance(e),t.add(e),e.modelView=this,this.addSceneData(e,e.scene),!0}return!1}createSceneData(e){return{scene:e,modelView:this,baseIndex:0,instances:[],buckets:[],usedBuckets:0}}removeInstance(e){let t=this.instanceSet;if(t.delete(e)){let i=this.sceneData,s=e.scene;if(s){let t=i.get(s),a=t.instances,r=t.buckets;a.splice(a.indexOf(e),1);let n=Math.ceil(a.length/this.model.batchSize);n<r.length&&(r.length=n)}return e.modelView=null,0===t.size&&this.model.removeView(this),!0}return!1}sceneChanged(e,t){if(this.model.ok){let i=this.sceneData,s=e.scene;if(s){let t=i.get(s),a=t.instances,r=t.buckets;a.splice(a.indexOf(e),1);let n=Math.ceil(a.length/this.model.batchSize);n<r.length&&(r.length=n)}t&&this.addSceneData(e,t)}}clear(){}detach(){}update(e){if(this.model.ok){let t=this.sceneData.get(e);if(t){let e=t.instances.length,i=t.buckets;for(t.baseIndex=0,t.usedBuckets=0;t.baseIndex<e;)t.usedBuckets===i.length&&(i[t.usedBuckets]=new this.model.handler.Bucket(this)),t.baseIndex=i[t.usedBuckets].fill(t),t.usedBuckets+=1;return t}}return null}renderOpaque(e){let t=this.sceneData.get(e);t&&t.baseIndex&&this.model.renderOpaque(t)}renderTranslucent(e){let t=this.sceneData.get(e);t&&t.baseIndex&&this.model.renderTranslucent(t)}}class ra extends aa{constructor(e){super(e),this.textures=new Map}getShallowCopy(){return{textures:new Map(this.textures)}}applyShallowCopy(e){let t=this.textures;for(let[i,s]of e.textures)t.set(i,s)}equals(e){let t=this.textures,i=e.textures;if(t.length!==i.length)return!1;for(let[s,a]of i)if(t.get(s)!==a)return!1;return!0}}class na extends $s{constructor(e){super(e),this.batchSize=e.viewer.batchSize,this.instances=[],this.views=[]}addInstance(){let e=this.views,t=new this.handler.Instance(this);return this.instances.push(t),0===e.length&&this.addView(),e[0].addInstance(t),this.ok&&t.load(),t}renderOpaque(e,t,i){}renderTranslucent(e,t,i){}addView(){let e=new this.handler.View(this);return this.views.push(e),e}removeView(e){let t=this.views;t.splice(t.indexOf(e),1)}viewChanged(e,t){for(let s of this.views)if(s.equals(t))return void s.addInstance(e);let i=this.addView();i.applyShallowCopy(t),i.addInstance(e),e.scene&&e.scene.addView(i)}lateLoad(){for(let e of this.instances)e.load();for(let e of this.views)e.lateLoad()}}class oa extends na{bindTexture(e,t,i){let s=this.viewer,a=i.textures;a.has(e)&&(e=a.get(e)),e?e.bind(t):s.webgl.bindTexture(null,t)}}class la extends oa{load(e){const t=this.viewer.gl;let i=e.geometry,s=e.material,a=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,a),t.bufferData(t.ARRAY_BUFFER,i.vertices,t.STATIC_DRAW);let r=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,i.uvs,t.STATIC_DRAW);let n=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n),t.bufferData(t.ELEMENT_ARRAY_BUFFER,i.faces,t.STATIC_DRAW);let o=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,o),t.bufferData(t.ELEMENT_ARRAY_BUFFER,i.edges,t.STATIC_DRAW),this.boundingRadius=i.boundingRadius,this.vertexArray=i.vertices,this.uvArray=i.uvs,this.faceArray=i.faces,this.edgeArray=i.edges,this.vertexBuffer=a,this.uvBuffer=r,this.faceBuffer=n,this.edgeBuffer=o;let l=i.faces.BYTES_PER_ELEMENT;this.faceIndexType=1===l?t.UNSIGNED_BYTE:2===l?t.UNSIGNED_SHORT:t.UNSIGNED_INT,l=i.edges.BYTES_PER_ELEMENT,this.edgeIndexType=1===l?t.UNSIGNED_BYTE:2===l?t.UNSIGNED_SHORT:t.UNSIGNED_INT,this.texture=s.texture,this.twoSided=s.twoSided||!1,this.noDepthTest=s.noDepthSet||!1,this.noDepthSet=s.noDepthSet||!1,this.uvScale=s.uvScale||new Float32Array([1,1]),this.uvOffset=s.uvOffset||new Float32Array(2),this.vertexColor=s.vertexColor||new Float32Array([255,255,255,255]),this.edgeColor=s.edgeColor||new Float32Array([255,255,255,255]),this.renderMode=0,s.renderMode>0&&(this.renderMode=s.renderMode),this.isBGR=s.isBGR||!1,this.isBlended=s.isBlended||!1,this.isBlended?this.translucent=!0:this.opaque=!0}render(e,t,i){let s=this.viewer.webgl,a=this.viewer.gl,r=s.extensions.instancedArrays,n=this.viewer.shaderMap.get("GeoStandardShader"),o=n.uniforms,l=n.attribs;s.useShaderProgram(n),a.uniformMatrix4fv(o.u_mvp,!1,t.camera.worldProjectionMatrix),a.activeTexture(a.TEXTURE15),a.bindTexture(a.TEXTURE_2D,e.boneTexture),a.uniform1i(o.u_boneMap,15),a.uniform1f(o.u_vectorSize,e.vectorSize),a.uniform1f(o.u_rowSize,e.rowSize);let h=l.a_InstanceID;a.bindBuffer(a.ARRAY_BUFFER,e.instanceIdBuffer),a.vertexAttribPointer(h,1,a.UNSIGNED_SHORT,!1,2,0),r.vertexAttribDivisorANGLE(h,1),a.bindBuffer(a.ARRAY_BUFFER,this.vertexBuffer),a.vertexAttribPointer(l.a_position,3,a.FLOAT,!1,12,0),a.bindBuffer(a.ARRAY_BUFFER,this.uvBuffer),a.vertexAttribPointer(l.a_uv,2,a.FLOAT,!1,8,0),this.twoSided?a.disable(a.CULL_FACE):a.enable(a.CULL_FACE),this.noDepthTest?a.disable(a.DEPTH_TEST):a.enable(a.DEPTH_TEST),this.noDepthSet?a.depthMask(0):a.depthMask(1),this.isBlended?(a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA)):a.disable(a.BLEND),a.uniform1i(o.u_texture,0);let c=l.a_color;if(r.vertexAttribDivisorANGLE(c,1),0===this.renderMode||2===this.renderMode){let t=i.textures.get(null)||this.texture;s.bindTexture(t,0);let n=o.u_hasTexture;t?a.uniform1f(n,1):a.uniform1f(n,0),a.uniform1f(o.u_isEdge,0),a.uniform2fv(o.u_uvScale,this.uvScale),a.uniform2fv(o.u_uvOffset,this.uvOffset),a.uniform1f(o.u_isBGR,this.isBGR),a.uniform1f(o.u_alphaMod,this.alpha),a.bindBuffer(a.ARRAY_BUFFER,e.vertexColorBuffer),a.vertexAttribPointer(c,4,a.UNSIGNED_BYTE,!0,0,0),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.faceBuffer),r.drawElementsInstancedANGLE(a.TRIANGLES,this.faceArray.length,this.faceIndexType,0,e.count)}1!==this.renderMode&&2!==this.renderMode||(a.uniform1f(o.u_isEdge,1),a.bindBuffer(a.ARRAY_BUFFER,e.edgeColorBuffer),a.vertexAttribPointer(c,4,a.UNSIGNED_BYTE,!0,0,0),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.edgeBuffer),r.drawElementsInstancedANGLE(a.LINES,this.edgeArray.length,this.edgeIndexType,0,e.count)),r.vertexAttribDivisorANGLE(h,0),r.vertexAttribDivisorANGLE(c,0)}renderBuckets(e){let t=e.scene,i=e.buckets,s=e.modelView;for(let a=0,r=e.usedBuckets;a<r;a++)this.render(i[a],t,s)}renderOpaque(e){this.opaque&&this.renderBuckets(e)}renderTranslucent(e){this.translucent&&this.renderBuckets(e)}}class ha{constructor(e){let t=e.model,i=t.viewer.gl;this.modelView=e,this.model=t,this.count=0,this.instanceIdBuffer=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,this.instanceIdBuffer),i.bufferData(i.ARRAY_BUFFER,new Uint16Array(t.batchSize).map((e,t,i)=>t),i.STATIC_DRAW)}fill(e,t,i){return e.instances.length}}class ca extends ha{constructor(e){super(e);const t=this.model.viewer.gl;this.gl=t;let i=this.model.batchSize;this.boneArrayInstanceSize=16,this.boneArray=new Float32Array(this.boneArrayInstanceSize*i),this.boneTexture=t.createTexture(),this.boneTextureWidth=4,this.boneTextureHeight=i,this.vectorSize=1/this.boneTextureWidth,this.rowSize=1/this.boneTextureHeight,t.activeTexture(t.TEXTURE15),t.bindTexture(t.TEXTURE_2D,this.boneTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA32F,this.boneTextureWidth,this.boneTextureHeight,0,t.RGBA,t.FLOAT,this.boneArray),this.vertexColorArray=new Uint8Array(4*i),this.vertexColorBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.vertexColorBuffer),t.bufferData(t.ARRAY_BUFFER,this.vertexColorArray,t.DYNAMIC_DRAW),this.edgeColorArray=new Uint8Array(4*i),this.edgeColorBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.edgeColorBuffer),t.bufferData(t.ARRAY_BUFFER,this.edgeColorArray,t.DYNAMIC_DRAW)}fill(e){let t=e.baseIndex,i=this.model,s=i.viewer.gl,a=i.batchSize,r=this.boneArray,n=this.vertexColorArray,o=this.edgeColorArray,l=0,h=e.instances;for(let c=h.length;t<c&&l<a;t++){let e=h[t];if(e.rendered&&!e.culled){let t=e.worldMatrix,i=e.vertexColor,s=e.edgeColor,a=16*l;r[a]=t[0],r[a+1]=t[1],r[a+2]=t[2],r[a+3]=t[3],r[a+4]=t[4],r[a+5]=t[5],r[a+6]=t[6],r[a+7]=t[7],r[a+8]=t[8],r[a+9]=t[9],r[a+10]=t[10],r[a+11]=t[11],r[a+12]=t[12],r[a+13]=t[13],r[a+14]=t[14],r[a+15]=t[15],n[4*l]=i[0],n[4*l+1]=i[1],n[4*l+2]=i[2],n[4*l+3]=i[3],o[4*l]=s[0],o[4*l+1]=s[1],o[4*l+2]=s[2],o[4*l+3]=s[3],l+=1}}return this.count=l,l&&(s.activeTexture(s.TEXTURE15),s.bindTexture(s.TEXTURE_2D,this.boneTexture),s.texSubImage2D(s.TEXTURE_2D,0,0,0,this.boneTextureWidth,l,s.RGBA,s.FLOAT,r),s.bindBuffer(s.ARRAY_BUFFER,this.vertexColorBuffer),s.bufferSubData(s.ARRAY_BUFFER,0,this.vertexColorArray),s.bindBuffer(s.ARRAY_BUFFER,this.edgeColorBuffer),s.bufferSubData(s.ARRAY_BUFFER,0,this.edgeColorArray)),t}}class da extends Xs{constructor(e){super(),this.modelView=null,this.model=e,this.paused=!1,this.rendered=!0,this.culled=!1,this.noCulling=!1,this.bounds=null}show(){this.rendered=!0}hide(){this.rendered=!1}shown(){return this.rendered}hidden(){return!this.rendered}detach(){return!!this.scene&&this.scene.removeInstance(this)}load(e){}updateTimers(){}updateAnimations(){}clearEmittedObjects(){}updateObject(e){if(!this.paused&&this.model.ok&&(this.updateTimers(),this.rendered)){let t=e.isVisible(this)||this.noCulling||this.model.viewer.noCulling;this.culled=!t,t&&this.updateAnimations()}}setScene(e){return e.addInstance(this)}}class ua extends da{setTexture(e,t){let i=this.modelView.getShallowCopy();i.textures.set(e,t),this.model.viewChanged(this,i)}}class ma extends ua{constructor(e){super(e),this.vertexColor=new Uint8Array(4),this.edgeColor=new Uint8Array(4)}load(){this.setVertexColor(this.model.vertexColor),this.setEdgeColor(this.model.edgeColor)}setVertexColor(e){return this.vertexColor.set(e),this}setEdgeColor(e){return this.edgeColor.set(e),this}}var fa="\n    attribute float a_InstanceID;\n  ",pa="\n    uniform sampler2D u_boneMap;\n    uniform float u_vectorSize;\n    uniform float u_rowSize;\n\n    mat4 fetchMatrix(float column, float row) {\n      column *= u_vectorSize * 4.0;\n      row *= u_rowSize;\n      // Add in half texel to sample in the middle of the texel.\n      // Otherwise, since the sample is directly on the boundry, small floating point errors can cause the sample to get the wrong pixel.\n      // This is mostly noticable with NPOT textures, which the bone maps are.\n      column += 0.5 * u_vectorSize;\n      row += 0.5 * u_rowSize;\n\n      return mat4(texture2D(u_boneMap, vec2(column, row)),\n                  texture2D(u_boneMap, vec2(column + u_vectorSize, row)),\n                  texture2D(u_boneMap, vec2(column + u_vectorSize * 2.0, row)),\n                  texture2D(u_boneMap, vec2(column + u_vectorSize * 3.0, row)));\n    }\n  ",ga="\n    vec2 decodeFloat2(float f) {\n      vec2 v;\n\n      v[1] = floor(f / 256.0);\n      v[0] = floor(f - v[1] * 256.0);\n\n      return v;\n    }\n\n    vec3 decodeFloat3(float f) {\n      vec3 v;\n\n      v[2] = floor(f / 65536.0);\n      v[1] = floor((f - v[2] * 65536.0) / 256.0);\n      v[0] = floor(f - v[2] * 65536.0 - v[1] * 256.0);\n\n      return v;\n    }\n\n    vec4 decodeFloat4(float v) {\n      vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n      enc = fract(enc);\n      enc -= enc.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n      return enc;\n    }\n  ",wa="\n    // A 2D quaternion*vector.\n    // q is the zw components of the original quaternion.\n    vec2 quat_transform(vec2 q, vec2 v) {\n      vec2 uv = vec2(-q.x * v.y, q.x * v.x);\n      vec2 uuv = vec2(-q.x * uv.y, q.x * uv.x);\n\n      return v + 2.0 * (uv * q.y + uuv);\n    }\n\n    // A 2D quaternion*vector.\n    // q is the zw components of the original quaternion.\n    vec3 quat_transform(vec2 q, vec3 v) {\n      return vec3(quat_transform(q, v.xy), v.z);\n    }\n  ",va={vs:"\n    ".concat(fa,"\n    ").concat(pa,"\n    uniform mat4 u_mvp;\n    uniform vec2 u_uvOffset;\n    uniform vec2 u_uvScale;\n\n    attribute vec3 a_position;\n    attribute vec2 a_uv;\n    attribute vec2 a_uvScale;\n    attribute vec4 a_color;\n\n    varying vec2 v_uv;\n    varying vec4 v_color;\n\n    void main() {\n      v_uv = a_uv * u_uvScale + u_uvOffset;\n      v_color = a_color;\n\n      gl_Position = u_mvp * fetchMatrix(0.0, a_InstanceID) * vec4(a_position, 1.0);\n    }\n  "),ps:"\n    uniform sampler2D u_diffuseMap;\n    uniform float u_alphaMod;\n    uniform bool u_isEdge;\n    uniform bool u_hasTexture;\n    uniform bool u_isBGR;\n\n    varying vec2 v_uv;\n    varying vec4 v_color;\n\n    void main() {\n      gl_FragColor = v_color;\n\n      if (u_hasTexture && !u_isEdge) {\n        vec4 texel = texture2D(u_diffuseMap, v_uv);\n\n        if (u_isBGR) {\n          texel = texel.bgra;\n        }\n\n        gl_FragColor *= texel;\n      } \n    }\n  "},ya={load:e=>e.loadShader("GeoStandardShader",va.vs,va.ps).ok,extensions:[[".geo"]],Constructor:la,View:class extends ra{update(e){let t=super.update(e);if(t){let e=2===this.model.renderMode?2:1,i=t.buckets,s=0,a=0,r=0;for(let n=0,o=t.usedBuckets;n<o;n++)s+=i[n].count,a+=1,r+=e;this.renderedInstances=s,this.renderedBuckets=a,this.renderCalls=r}}},Bucket:ca,Instance:ma},ba={handler:ya,Model:la,ModelInstance:ma,Bucket:ca};const Aa=e=>(class{constructor(e,t,i,s,a){let r=e.defval;this.sd=e,this.start=t,this.end=i,this.keyframes=[],a&&s[0].frame>i&&this.keyframes.push(s[0]);for(let o=0,l=s.length;o<l;o++){let e=s[o],a=e.frame;a>=t&&a<=i&&this.keyframes.push(e)}let n=this.keyframes.length;if(0===n)this.constant=!0,this.keyframes.push({frame:t,value:r,inTan:r,outTan:r});else if(1===n)this.constant=!0;else{let e=!0,s=this.keyframes[0].value;for(let t=1,i=this.keyframes.length;t<i;t++){let i=this.keyframes[t].value;if(i.length>0){for(let t=0,a=i.length;t<a;t++)if(s[t]!==i[t]){e=!1;break}}else if(i!==s){e=!1;break}}e?this.constant=!0:(this.constant=!1,this.keyframes[0].frame!==t&&this.keyframes.unshift({frame:t,value:r,inTan:r,outTan:r}),this.keyframes[this.keyframes.length-1].frame!==i&&this.keyframes.push({frame:i,value:this.keyframes[0].value,inTan:this.keyframes[0].outTan,outTan:this.keyframes[0].inTan}))}}getValue(t,i){let s=this.keyframes,a=this.getKeyframe(i),r=s.length;if(-1===a)return t.set(s[0].value),0;if(a===r)return t.set(s[r-1].value),r-1;{let r=s[a-1],h=s[a],c=(n=(i-r.frame)/(h.frame-r.frame),o=0,l=1,Math.min(Math.max(n,o),l));return e(t,r.value,r.outTan,h.inTan,h.value,c,this.sd.interpolationType),a}var n,o,l}getKeyframe(e){if(this.constant)return-1;{let t=this.keyframes,i=t.length;if(e<this.start)return-1;if(e>=this.end)return i;for(let s=1;s<i;s++){if(t[s].frame>e)return s}}}}),Ea={KLAV:0,KATV:0,KPEV:0,KP2V:0,KRVS:0},xa={KMTF:[0],KMTA:[1],KTAT:[0,0,0],KTAR:[0,0,0,1],KTAS:[1,1,1],KGAO:[1],KGAC:[0,0,0],KLAS:[0],KLAE:[0],KLAC:[0,0,0],KLAI:[0],KLBI:[0],KLBC:[0,0,0],KLAV:[1],KATV:[1],KPEE:[0],KPEG:[0],KPLN:[0],KPLT:[0],KPEL:[0],KPES:[0],KPEV:[1],KP2S:[0],KP2R:[0],KP2L:[0],KP2G:[0],KP2E:[0],KP2N:[0],KP2W:[0],KP2V:[1],KRHA:[0],KRHB:[0],KRAL:[1],KRCO:[0,0,0],KRTX:[0],KRVS:[1],KCTR:[0,0,0],KTTR:[0,0,0],KCRL:[0],KGTR:[0,0,0],KGRT:[0,0,0,1],KGSC:[1,1,1]},Ta=e=>(class{constructor(t,i){let s=t.globalSequences,a=i.globalSequenceId,r=i.tracks,n=Ea[i.name];if(this.model=t,this.name=i.name,this.defval=xa[i.name],this.globalSequence=null,this.sequences=[],this.interpolationType=void 0!==n?n:i.interpolationType,-1!==a&&s)this.globalSequence=new e(this,0,s[a],r,!0);else for(let o of t.sequences)this.sequences.push(new e(this,...o.interval,r,!1))}getValue(e,t){return this.globalSequence?this.globalSequence.getValue(e,t.counter%this.globalSequence.end):-1!==t.sequence?this.sequences[t.sequence].getValue(e,t.frame):(e.set(this.defval),-1)}isVariant(e){return this.globalSequence?!this.globalSequence.constant:!this.sequences[e].constant}getValues(){if(this.globalSequence)return this.globalSequence.keyframes.map(e=>e.value);{let e=[];for(let t of this.sequences)e.push(...t.keyframes.map(e=>e.value));return e}}}),Sa=Ta(Aa(function(e,t,i,s,a,r,n){return 0===n?e[0]=t[0]:1===n?e[0]=ds(t[0],a[0],r):2===n?e[0]=function(e,t,i,s,a){let r=a*a;return e*(r*(2*a-3)+1)+t*(r*(a-2)+a)+i*(r*(a-1))+s*(r*(3-2*a))}(t[0],i[0],s[0],a[0],r):3===n&&(e[0]=function(e,t,i,s,a){let r=1-a,n=a*a,o=r*r;return e*(o*r)+t*(3*a*o)+i*(3*n*r)+s*(n*a)}(t[0],i[0],s[0],a[0],r)),e})),_a=Ta(Aa(function(e,t,i,s,a,r,n){return 0===n?os.vec3.copy(e,t):1===n?os.vec3.lerp(e,t,a,r):2===n?os.vec3.hermite(e,t,i,s,a,r):3===n&&os.vec3.bezier(e,t,i,s,a,r),e})),Ia=Ta(Aa(function(e,t,i,s,a,r,n){return 0===n?os.quat.copy(e,t):1===n?os.quat.slerp(e,t,a,r):2!==n&&3!==n||os.quat.sqlerp(e,t,i,s,a,r),e}));function Ra(e,t){let i;return t instanceof Di||t instanceof Mi?i=Sa:t instanceof Ui?i=_a:t instanceof Pi&&(i=Ia),new i(e,t)}class Ca{constructor(e,t){this.model=e,this.animations={};for(let i of t.animations)this.animations[i.name]=Ra(e,i)}getValues(e){let t=this.animations[e];return t?t.getValues():[]}getUintValue(e,t,i,s){let a=this.animations[t];return a?a.getValue(e,i):(e[0]=s,-1)}getFloatValue(e,t,i,s){let a=this.animations[t];return a?a.getValue(e,i):(e[0]=s,-1)}getVector3Value(e,t,i,s){let a=this.animations[t];return a?a.getValue(e,i):(os.vec3.copy(e,s),-1)}getVector4Value(e,t,i,s){let a=this.animations[t];return a?a.getValue(e,i):(os.quat.copy(e,s),-1)}isVariant(e,t){let i=this.animations[e];return!!i&&i.isVariant(t)}}class Ba extends Ca{getTranslation(e,t){return this.getVector3Value(e,"KTAT",t,Cs)}getRotation(e,t){return this.getVector4Value(e,"KTAR",t,Fs)}getScale(e,t){return this.getVector3Value(e,"KTAS",t,Bs)}isTranslationVariant(e){return this.isVariant("KTAT",e)}isRotationVariant(e){return this.isVariant("KTAR",e)}isScaleVariant(e){return this.isVariant("KTAS",e)}}function Fa(e){return e.reverse().filter((e,t,i)=>-1===i.indexOf(e,t+1)).reverse()}function La(e,t){return 0===e?[t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA]:1===e?[t.SRC_ALPHA,t.ONE]:2===e?[t.ZERO,t.SRC_COLOR]:3===e?[t.DEST_COLOR,t.SRC_COLOR]:4===e?[t.SRC_ALPHA,t.ONE]:void 0}class Da extends Ca{constructor(e,t,i,s){let a=t.filterMode,r=t.textureAnimationId,n=e.viewer.gl;super(e,t),this.index=i,this.priorityPlane=s,this.filterMode=a,this.textureId=t.textureId,this.coordId=t.coordId,this.alpha=t.alpha;let o=t.flags;if(this.unshaded=1&o,this.sphereEnvironmentMap=2&o,this.twoSided=16&o,this.unfogged=32&o,this.noDepthTest=64&o,this.noDepthSet=128&o,this.depthMaskValue=0===a||1===a?1:0,this.alphaTestValue=1===a?1:0,this.blendSrc=0,this.blendDst=0,this.blended=a>1,this.blended&&([this.blendSrc,this.blendDst]=function(e,t){return 2===e?[t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA]:3===e?[t.ONE,t.ONE]:4===e?[t.SRC_ALPHA,t.ONE]:5===e?[t.ZERO,t.SRC_COLOR]:6===e?[t.DST_COLOR,t.SRC_COLOR]:[0,0]}(a,n)),this.uvDivisor=new Float32Array([1,1]),-1!==r){let t=e.textureAnimations[r];t&&(this.textureAnimation=t)}let l={alpha:[],slot:[],translation:[],rotation:[],scale:[]},h=!1,c=!1,d=!1,u=!1;for(let m=0,f=e.sequences.length;m<f;m++){let e=this.isAlphaVariant(m),t=this.isTextureIdVariant(m),i=this.isTranslationVariant(m),s=this.isRotationVariant(m),a=this.isScaleVariant(m);l.alpha[m]=e,l.slot[m]=t,l.translation[m]=i,l.rotation[m]=s,l.scale[m]=a,h=h||t,c=c||i,d=d||s,u=u||a}if(this.variants=l,this.hasSlotAnim=h,this.hasTranslationAnim=c,this.hasRotationAnim=d,this.hasScaleAnim=u,this.animations.KMTF){let t=Fa(this.animations.KMTF.getValues());if(t.length>1){let i=ys(t.join("")),s=[];for(let r=0,n=t.length;r<n;r++)s[r]=e.textures[t[r]];let a=e.viewer.loadTextureAtlas(i,s);a.texture.whenLoaded().then(()=>{let t=a.texture;t.wrapS=!0,t.wrapT=!0,e.textures.push(t),this.textureId=e.textures.length-1,this.uvDivisor.set([a.columns,a.rows])})}}}bind(e){let t=this.model.viewer.gl;t.uniform1f(e.uniforms.u_alphaTest,this.alphaTestValue),this.blended?(t.enable(t.BLEND),t.blendFunc(this.blendSrc,this.blendDst)):t.disable(t.BLEND),this.twoSided?t.disable(t.CULL_FACE):t.enable(t.CULL_FACE),this.noDepthTest?t.disable(t.DEPTH_TEST):t.enable(t.DEPTH_TEST),this.noDepthSet?t.depthMask(0):t.depthMask(this.depthMaskValue)}getAlpha(e,t){return this.getFloatValue(e,"KMTA",t,this.alpha)}getTextureId(e,t){return this.getUintValue(e,"KMTF",t,this.textureId)}getTranslation(e,t){return this.textureAnimation?this.textureAnimation.getTranslation(e,t):(os.vec3.copy(e,Cs),-1)}getRotation(e,t){return this.textureAnimation?this.textureAnimation.getRotation(e,t):(os.quat.copy(e,Fs),-1)}getScale(e,t){return this.textureAnimation?this.textureAnimation.getScale(e,t):(os.vec3.copy(e,Bs),-1)}isAlphaVariant(e){return this.isVariant("KMTA",e)}isTextureIdVariant(e){return this.isVariant("KMTF",e)}isTranslationVariant(e){return this.textureAnimation&&this.textureAnimation.isTranslationVariant(e)}isRotationVariant(e){return this.textureAnimation&&this.textureAnimation.isRotationVariant(e)}isScaleVariant(e){return this.textureAnimation&&this.textureAnimation.isScaleVariant(e)}}class Ma extends Ca{constructor(e,t){super(e,t),this.alpha=t.alpha,this.color=[...t.color].reverse(),this.geosetId=t.geosetId}getAlpha(e,t){return this.getFloatValue(e,"KGAO",t,1)}getColor(e,t){return this.getVector3Value(e,"KGAC",t,this.color)}isAlphaVariant(e){return this.isVariant("KGAO",e)}isColorVariant(e){return this.isVariant("KGAC",e)}}class Ua{constructor(e,t,i,s){this.model=e,this.offsets=t,this.uvSetSize=i,this.elements=s}bind(e,t){let i=this.model.viewer.gl,s=this.offsets,a=e.attribs;i.vertexAttribPointer(a.a_position,3,i.FLOAT,!1,12,s[0]),i.vertexAttribPointer(a.a_normal,3,i.FLOAT,!1,12,s[1]),i.vertexAttribPointer(a.a_uv,2,i.FLOAT,!1,8,s[2]+t*this.uvSetSize),i.vertexAttribPointer(a.a_bones,4,i.UNSIGNED_BYTE,!1,4,s[3]),i.vertexAttribPointer(a.a_boneNumber,1,i.UNSIGNED_BYTE,!1,4,s[4])}render(e){let t=this.model.viewer.gl;t.extensions.instancedArrays.drawElementsInstancedANGLE(t.TRIANGLES,this.elements,t.UNSIGNED_SHORT,this.offsets[5],e)}}class Pa{constructor(e,t,i){let s,a=t.vertices,r=t.normals,n=t.uvSets,o=n[0].length,l=a.length/3,h=new Uint8Array(4*l),c=new Uint32Array(l),d=t.vertexGroups,u=t.matrixGroups,m=t.matrixIndices,f=[];if(n.length>1){s=new Float32Array(n.length*o);for(let e=0,t=n.length;e<t;e++)s.set(n[e],e*o)}else s=n[0];for(let v=0,y=u.length,b=0;v<y;v++)f.push(m.subarray(b,b+u[v])),b+=u[v];for(let v=0;v<l;v++){if(f[d[v]]){let e=f[d[v]],t=Math.min(e.length,4);for(let i=0;i<t;i++)h[4*v+i]=e[i]+1;c[v]=t}}this.index=i,this.materialId=t.materialId,this.locationArray=a,this.normalArray=r,this.uvsArray=s,this.boneIndexArray=h,this.boneNumberArray=c,this.faceArray=t.faces,this.uvSetSize=4*o;let p=e.geosetAnimations;for(let v=0,y=p.length;v<y;v++)p[v].geosetId===i&&(this.geosetAnimation=p[v]);let g={alpha:[],color:[]},w=!1;for(let v=0,y=e.sequences.length;v<y;v++){let e=this.isAlphaVariant(v),t=this.isColorVariant(v);(e||t)&&(w=!0),g.alpha[v]=e,g.color[v]=t}this.variants=g,this.hasAnim=w}getAlpha(e,t){return this.geosetAnimation?this.geosetAnimation.getAlpha(e,t):(e[0]=1,-1)}getColor(e,t){return this.geosetAnimation?this.geosetAnimation.getColor(e,t):(os.vec3.copy(e,Bs),-1)}isAlphaVariant(e){return this.geosetAnimation&&this.geosetAnimation.isAlphaVariant(e)}isColorVariant(e){return this.geosetAnimation&&this.geosetAnimation.isColorVariant(e)}}class ka{constructor(e,t,i){this.index=e,this.layer=t,this.geoset=i}}var Na={1:"TeamColor/TeamColor00",2:"TeamGlow/TeamGlow00",11:"Cliff/Cliff0",21:"",31:"LordaeronTree/LordaeronSummerTree",32:"AshenvaleTree/AshenTree",33:"BarrensTree/BarrensTree",34:"NorthrendTree/NorthTree",35:"Mushroom/MushroomTree",36:"RuinsTree/RuinsTree",37:"OutlandMushroomTree/MushroomTree"};class Oa extends Ca{constructor(e,t,i){super(e,t),this.index=i,this.name=t.name,this.objectId=t.objectId,this.parentId=t.parentId,this.pivot=e.pivotPoints[t.objectId]||os.vec3.create();let s=t.flags;this.dontInheritTranslation=1&s,this.dontInheritRotation=2&s,this.dontInheritScaling=4&s,this.billboarded=8&s,this.billboardedX=16&s,this.billboardedY=32&s,this.billboardedZ=64&s,this.cameraAnchored=128&s,this.bone=256&s,this.light=512&s,this.eventObject=1024&s,this.attachment=2048&s,this.particleEmitter=4096&s,this.collisionShape=8192&s,this.ribbonEmitter=16384&s,this.emitterUsesMdlOrUnshaded=32768&s,this.emitterUsesTgaOrSortPrimitivesFarZ=65536&s,this.lineEmitter=131072&s,this.unfogged=262144&s,this.modelSpace=524288&s,this.xYQuad=1048576&s,this.anyBillboarding=this.billboarded||this.billboardedX||this.billboardedY||this.billboardedZ,t.objectId===t.parentId&&(this.parentId=-1);let a={translation:[],rotation:[],scale:[],generic:[]};for(let r=0,n=e.sequences.length;r<n;r++){let e=this.isTranslationVariant(r),t=this.isRotationVariant(r),i=this.isScaleVariant(r);a.translation[r]=e,a.rotation[r]=t,a.scale[r]=i,a.generic[r]=e||t||i}this.variants=a}getVisibility(e,t){return e[0]=1,-1}getTranslation(e,t){return this.getVector3Value(e,"KGTR",t,Cs)}getRotation(e,t){return this.getVector4Value(e,"KGRT",t,Fs)}getScale(e,t){return this.getVector3Value(e,"KGSC",t,Bs)}isTranslationVariant(e){return this.isVariant("KGTR",e)}isRotationVariant(e){return this.isVariant("KGRT",e)}isScaleVariant(e){return this.isVariant("KGSC",e)}}class ja extends Oa{constructor(e,t,i){super(e,t,i),this.geosetAnimation=e.geosetAnimations[t.geosetAnimationId]}getVisibility(e,t){return this.geosetAnimation?this.geosetAnimation.getAlpha(e,t):(e[0]=1,-1)}}class Va extends Oa{constructor(e,t,i){super(e,t,i),this.type=t.type,this.attenuation=t.attenuation,this.color=t.color,this.intensity=t.intensity,this.ambientColor=t.ambientColor,this.ambientIntensity=t.ambientIntensity}getAttenuationStart(e,t){return this.getFloatValue(e,"KLAS",t,this.attenuation[0])}getAttenuationEnd(e,t){return this.getFloatValue(e,"KLAE",t,this.attenuation[1])}getIntensity(e,t){return this.getFloatValue(e,"KLAI",t,this.intensity)}getColor(e,t){return this.getVector3Value(e,"KLAC",t,this.color)}getAmbientIntensity(e,t){return this.getFloatValue(e,"KLBI",t,this.ambientIntensity)}getAmbientColor(e,t){return this.getVector3Value(e,"KLBC",t,this.ambientColor)}}class Ga extends Oa{}class Ha extends Oa{constructor(e,t,i){super(e,t,i);let s=t.path.replace(/\\/g,"/").toLowerCase().replace(".mdl",".mdx");this.path=s,this.attachmentId=t.attachmentId,""!==s&&-1!=s.indexOf(".mdx")&&(this.internalModel=e.viewer.load(s,e.pathSolver))}getVisibility(e,t){return this.getFloatValue(e,"KATV",t,1)}}class Ka extends Oa{constructor(e,t,i){super(e,t,i),this.internalResource=e.viewer.load(t.path.replace(/\\/g,"/").toLowerCase().replace(".mdl",".mdx"),e.pathSolver),this.speed=t.speed,this.latitude=t.latitude,this.longitude=t.longitude,this.lifeSpan=t.lifeSpan,this.gravity=t.gravity,this.emissionRate=t.emissionRate}getSpeed(e,t){return this.getFloatValue(e,"KPES",t,this.speed)}getLatitude(e,t){return this.getFloatValue(e,"KPLTV",t,this.latitude)}getLongitude(e,t){return this.getFloatValue(e,"KPLN",t,this.longitude)}getLifeSpan(e,t){return this.getFloatValue(e,"KPEL",t,this.lifeSpan)}getGravity(e,t){return this.getFloatValue(e,"KPEG",t,this.gravity)}getEmissionRate(e,t){return this.getFloatValue(e,"KPEE",t,this.emissionRate)}getVisibility(e,t){return this.getFloatValue(e,"KPEV",t,1)}}class qa extends Oa{constructor(e,t,i){super(e,t,i),this.width=t.width,this.length=t.length,this.speed=t.speed,this.latitude=t.latitude,this.gravity=t.gravity,this.emissionRate=t.emissionRate,this.squirt=t.squirt,this.lifeSpan=t.lifeSpan,this.variation=t.variation,this.tailLength=t.tailLength,this.timeMiddle=t.timeMiddle;let s=t.replaceableId;this.dimensions=[t.columns,t.rows],this.teamColored=!1,0===s?this.internalResource=e.textures[t.textureId]:1===s?(this.internalResource=e.viewer.getTextureAtlas("teamColors"),this.dimensions.fill(4),this.teamColored=!0):2===s?(this.internalResource=e.viewer.getTextureAtlas("teamGlows"),this.dimensions.fill(4),this.teamColored=!0):this.internalResource=e.viewer.load("ReplaceableTextures\\"+Na[s]+".blp",e.pathSolver),this.replaceableId=t.replaceableId;let a=t.headOrTail;this.head=0===a||2===a,this.tail=1===a||2===a,this.cellWidth=1/t.columns,this.cellHeight=1/t.rows,this.colors=[];let r=t.segmentColors,n=t.segmentAlphas;for(let o=0;o<3;o++)this.colors[o]=new Uint8Array([255*Math.min(r[o][0],1),255*Math.min(r[o][1],1),255*Math.min(r[o][2],1),n[o]]);this.scaling=t.segmentScaling,this.intervals=[...t.headIntervals,...t.tailIntervals],this.lineEmitter=131072&t.flags,this.modelSpace=524288&t.flags,this.xYQuad=1048576&t.flags,[this.blendSrc,this.blendDst]=La(t.filterMode,this.model.viewer.gl),this.priorityPlane=t.priorityPlane}getWidth(e,t){return this.getFloatValue(e,"KP2W",t,this.width)}getLength(e,t){return this.getFloatValue(e,"KP2N",t,this.length)}getSpeed(e,t){return this.getFloatValue(e,"KP2S",t,this.speed)}getLatitude(e,t){return this.getFloatValue(e,"KP2L",t,this.latitude)}getGravity(e,t){return this.getFloatValue(e,"KP2G",t,this.gravity)}getEmissionRate(e,t){return this.getFloatValue(e,"KP2E",t,this.emissionRate)}getVisibility(e,t){return this.getFloatValue(e,"KP2V",t,1)}getVariation(e,t){return this.getFloatValue(e,"KP2R",t,this.variation)}}class Wa extends Oa{constructor(e,t,i){super(e,t,i),this.layer=e.materials[t.materialId][0],this.texture=e.textures[this.layer.textureId],this.heightAbove=t.heightAbove,this.heightBelow=t.heightBelow,this.alpha=t.alpha,this.color=t.color,this.lifeSpan=t.lifeSpan,this.textureSlot=t.textureSlot,this.emissionRate=t.emissionRate,this.gravity=t.gravity,this.dimensions=[t.columns,t.rows],this.cellWidth=1/t.columns,this.cellHeight=1/t.rows}getHeightBelow(e,t){return this.getFloatValue(e,"KRHB",t,this.heightBelow)}getHeightAbove(e,t){return this.getFloatValue(e,"KRHA",t,this.heightAbove)}getTextureSlot(e,t){return this.getUintValue(e,"KRTX",t,0)}getColor(e,t){return this.getVector3Value(e,"KRCO",t,this.color)}getAlpha(e,t){return this.getFloatValue(e,"KRAL",t,this.alpha)}getVisibility(e,t){return this.getFloatValue(e,"KRVS",t,1)}}const Xa=os.vec3.create();class za extends Oa{constructor(e,t,i){super(e,t,i),this.name=t.name,this.position=t.position,this.fieldOfView=t.fieldOfView,this.farClippingPlane=t.farClippingPlane,this.nearClippingPlane=t.nearClippingPlane,this.targetPosition=t.targetPosition}getPositionTranslation(e,t){const i=this.getVector3Value(e,"KCTR",t,Xa);return os.vec3.add(e,e,this.position),i}getTargetTranslation(e,t){const i=this.getVector3Value(e,"KTTR",t,Xa);return os.vec3.add(e,e,this.targetPosition),i}getRotation(e,t){return this.getFloatValue(e,"KCRL",t,0)}}class Ya{constructor(e){this.map={},this.load(e)}load(e){if(e)if(e instanceof ArrayBuffer){const t=new TextDecoder("utf-8");let i=new Uint8Array(e);this.loadText(t.decode(i))}else this.loadText(e)}loadText(e){if(e.startsWith("ID;")){let t=new it(e).rows,i=t[0],s=this.map;for(let e=1,a=t.length;e<a;e++){let a=t[e],r=a[0];if(r){s[r=r.toLowerCase()]||(s[r]={});let e=s[r];for(let t=0,s=i.length;t<s;t++){let s=i[t];void 0===s&&(s="column".concat(t)),e[s]=a[t]}}}}else{let t=new et(e).sections,i=this.map;for(let[e,s]of t.entries()){i[e]||(i[e]={});let t=i[e];for(let[e,i]of s)t[e]=i}}}getRow(e){return this.map[e.toLowerCase()]}getProperty(e,t){return this.map[e.toLowerCase()][t]}setRow(e,t){this.map[e.toLowerCase()]=t}}let Ja=new OfflineAudioContext(1,1,48e3);let Za=e=>new Ya(e),$a=e=>(function(e){return Ja.decodeAudioData(e)})(e);class Qa extends Oa{constructor(e,t,i){super(e,t,i);let s=e.viewer,a=t.name,r=a.substring(0,3),n=a.substring(4);"FPT"===r&&(r="SPL"),this.ok=!1,this.type=r,this.id=n,this.internalResource=null,this.decodedBuffers=[],this.tracks=t.tracks,this.ok=!1,this.globalSequence=null,this.defval=os.vec2.create();let o=t.globalSequenceId;-1!==o&&(this.globalSequence=e.globalSequences[o]);let l=[],h=e.pathSolver;if("SPN"===r)l[0]=s.loadGeneric(h("Splats\\SpawnData.slk")[0],"text",Za);else if("SPL"===r)l[0]=s.loadGeneric(h("Splats\\SplatData.slk")[0],"text",Za);else if("UBR"===r)l[0]=s.loadGeneric(h("Splats\\UberSplatData.slk")[0],"text",Za);else{if("SND"!==r)return;l[0]=s.loadGeneric(h("UI\\SoundInfo\\AnimLookups.slk")[0],"text",Za),l[1]=s.loadGeneric(h("UI\\SoundInfo\\AnimSounds.slk")[0],"text",Za)}let c=s.promise();s.whenLoaded(l).then(e=>{this.load(e),c.resolve()})}load(e){if(!e[0].ok)return;let t=this.type,i=this.model,s=i.viewer,a=i.pathSolver,r=e[0].data.getRow(this.id);if(r){if("SPN"===t)this.internalResource=s.load(r.Model.replace(".mdl",".mdx"),a);else if("SPL"===t||"UBR"===t)this.internalResource=s.load("replaceabletextures/splats/"+r.file+".blp",a),this.colors=[[r.StartR,r.StartG,r.StartB,r.StartA],[r.MiddleR,r.MiddleG,r.MiddleB,r.MiddleA],[r.EndR,r.EndG,r.EndB,r.EndA]],this.scale=r.Scale,"SPL"===t?(this.dimensions=[r.Columns,r.Rows],this.intervals=[[r.UVLifespanStart,r.UVLifespanEnd,r.LifespanRepeat],[r.UVDecayStart,r.UVDecayEnd,r.DecayRepeat]],this.intervalTimes=[r.Lifespan,r.Decay],this.lifespan=r.Lifespan+r.Decay):(this.dimensions=[1,1],this.intervalTimes=[r.BirthTime,r.PauseTime,r.Decay],this.lifespan=r.BirthTime+r.PauseTime+r.Decay),[this.blendSrc,this.blendDst]=La(r.BlendMode,s.gl);else if("SND"===t&&s.enableAudio){if(!e[1].ok)return;if(r=e[1].data.getRow(r.SoundLabel)){this.distanceCutoff=r.DistanceCutoff,this.maxDistance=r.MaxDistance,this.minDistance=r.MinDistance,this.pitch=r.Pitch,this.pitchVariance=r.PitchVariance,this.volume=r.Volume;let e=r.FileNames.split(",");s.whenLoaded(e.map(e=>s.loadGeneric(a(r.DirectoryBase+e)[0],"arrayBuffer",$a))).then(e=>{for(let t of e)this.decodedBuffers.push(t.data);this.ok=!0})}}this.internalResource&&this.internalResource.whenLoaded().then(()=>this.ok=!0)}else console.warn("Unknown event object ID",t,this.id)}getValue(e,t){if(this.globalSequence){let i=this.globalSequence;return this.getValueAtTime(e,t.counter%i,0,i)}if(-1!==t.sequence){let i=this.model.sequences[t.sequence].interval;return this.getValueAtTime(e,t.frame,i[0],i[1])}{let t=this.defval;return e[0]=t[0],e[1]=t[1],e}}getValueAtTime(e,t,i,s){let a=this.tracks;if(t<i||t>s)return e[0]=0,e[1]=0,e;for(let r=a.length-1;r>-1;r--){if(a[r]<i)return e[0]=0,e[1]=r,e;if(a[r]<=t)return e[0]=1,e[1]=r,e}return e[0]=0,e[1]=0,e}}class er extends Oa{}class tr extends oa{constructor(e){super(e),this.parser=null,this.name="",this.extent=null,this.bounds=null,this.sequences=[],this.globalSequences=[],this.materials=[],this.layers=[],this.textures=[],this.textureAnimations=[],this.geosets=[],this.geosetAnimations=[],this.bones=[],this.lights=[],this.helpers=[],this.attachments=[],this.pivotPoints=[],this.particleEmitters=[],this.particleEmitters2=[],this.ribbonEmitters=[],this.cameras=[],this.eventObjects=[],this.collisionShapes=[],this.hasLayerAnims=!1,this.hasGeosetAnims=!1,this.batches=[],this.opaqueBatches=[],this.translucentBatches=[],this.genericObjects=[],this.sortedGenericObjects=[],this.hierarchy=[],this.replaceables=[]}load(e){let t=new rs;t.load(e),this.parser=t,this.name=t.name;let i=t.extent;this.bounds=function(e,t){let i=e[0],s=e[1],a=e[2],r=t[0],n=t[1],o=t[2],l=r-i,h=n-s,c=o-a;return{center:new Float32Array([(i+r)/2,(s+n)/2,(a+o)/2]),radius:Math.sqrt(l*l+h*h+c*c)/2}}(i.min,i.max),this.extent=i;for(let n of t.sequences)this.sequences.push(n);for(let n of t.globalSequences)this.globalSequences.push(n);let s=!1;for(let n of t.textures){let e=n.path,t=n.replaceableId,i=n.flags;if(0!==t&&(e="ReplaceableTextures\\".concat(Na[t],".blp"),1!==t&&2!==t||(s=!0)),!e.endsWith(".blp")&&!e.endsWith(".tga")){let t=e.indexOf(".blp");-1===t&&(t=e.indexOf(".tga")),-1!==t&&(e=e.slice(0,t+4))}this.replaceables.push(t);let a=this.viewer.load(e,this.pathSolver);a.wrapS=!!(1&i),a.wrapT=!!(2&i),this.textures.push(a)}s&&this.loadTeamTextures();for(let n of t.textureAnimations)this.textureAnimations.push(new Ba(this,n));let a=0;for(let n of t.materials){let e=[];for(let t of n.layers){let i=new Da(this,t,a++,n.priorityPlane);e.push(i),this.layers.push(i),i.hasAnim&&(this.hasLayerAnims=!0)}this.materials.push(e)}for(let n of t.geosetAnimations)this.geosetAnimations.push(new Ma(this,n));if(t.geosets.length){let e=0,i=0,s=[],a=[];for(let r of t.geosets){let t=new Pa(this,r,e++);t.hasAnim&&(this.hasGeosetAnims=!0),this.geosets.push(t);for(let e of this.materials[r.materialId]){let r=new ka(i++,e,t);e.filterMode<2?s.push(r):a.push(r)}}a.sort((e,t)=>e.layer.priorityPlane-t.layer.priorityPlane),this.opaqueBatches.push(...s),this.translucentBatches.push(...a),this.batches.push(...s,...a),this.setupGeosets()}this.pivotPoints=t.pivotPoints;let r=0;for(let n of t.bones)this.bones.push(new ja(this,n,r++));for(let n of t.lights)this.lights.push(new Va(this,n,r++));for(let n of t.helpers)this.helpers.push(new Ga(this,n,r++));for(let n of t.attachments)this.attachments.push(new Ha(this,n,r++));for(let n of t.particleEmitters)this.particleEmitters.push(new Ka(this,n,r++));for(let n of t.particleEmitters2)this.particleEmitters2.push(new qa(this,n,r++));this.particleEmitters2.sort((e,t)=>e.priorityPlane-t.priorityPlane);for(let n of t.ribbonEmitters)this.ribbonEmitters.push(new Wa(this,n,r++));for(let n of t.cameras)this.cameras.push(new za(this,n,r++));for(let n of t.eventObjects)this.eventObjects.push(new Qa(this,n,r++));for(let n of t.collisionShapes)this.collisionShapes.push(new er(this,n,r++));this.genericObjects.push(...this.bones,...this.lights,...this.helpers,...this.attachments,...this.particleEmitters,...this.particleEmitters2,...this.ribbonEmitters,...this.cameras,...this.eventObjects,...this.collisionShapes),this.setupHierarchy(-1);for(let n=0,o=this.genericObjects.length;n<o;n++)this.sortedGenericObjects[n]=this.genericObjects[this.hierarchy[n]];this.setupVariants()}loadTeamTextures(){let e=this.viewer;if(!e.getTextureAtlas("teamColors")){let t=this.pathSolver,i=[],s=[];for(let a=0;a<28;a++){let r=(""+a).padStart(2,"0");i[a]=e.load("ReplaceableTextures\\TeamColor\\TeamColor".concat(r,".blp"),t),s[a]=e.load("ReplaceableTextures\\TeamGlow\\TeamGlow".concat(r,".blp"),t)}e.loadTextureAtlas("teamColors",i),e.loadTextureAtlas("teamGlows",s)}}isVariant(e){let t=this.genericObjects;for(let i=0,s=t.length;i<s;i++)if(t[i].variants.generic[e])return!0;return!1}setupVariants(){let e=[];for(let t=0,i=this.sequences.length;t<i;t++)e[t]=this.isVariant(t);this.variants=e}setupGeosets(){let e=this.geosets;if(e.length>0){let t=this.viewer.gl,i=[],s=[],a=0,r=[],n=0;for(let h=0,c=e.length;h<c;h++){let t=e[h],o=t.locationArray,l=t.normalArray,c=t.uvsArray,d=t.boneIndexArray,u=t.boneNumberArray,m=t.faceArray,f=a,p=f+o.byteLength,g=p+l.byteLength,w=g+c.byteLength,v=w+d.byteLength;i[h]=new Ua(this,[f,p,g,w,v,n],t.uvSetSize,m.length),s.push([f,o]),s.push([p,l]),s.push([g,c]),s.push([w,d]),s.push([v,u]),r.push([n,m]),a=v+u.byteLength,n+=m.byteLength}let o=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,o),t.bufferData(t.ARRAY_BUFFER,a,t.STATIC_DRAW);for(let e=0,h=s.length;e<h;e++)t.bufferSubData(t.ARRAY_BUFFER,s[e][0],s[e][1]);let l=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,l),t.bufferData(t.ELEMENT_ARRAY_BUFFER,n,t.STATIC_DRAW);for(let e=0,h=r.length;e<h;e++)t.bufferSubData(t.ELEMENT_ARRAY_BUFFER,r[e][0],r[e][1]);this.__webglArrayBuffer=o,this.__webglElementBuffer=l,this.shallowGeosets=i}}setupHierarchy(e){for(let t=0,i=this.genericObjects.length;t<i;t++){let i=this.genericObjects[t];i.parentId===e&&(this.hierarchy.push(t),this.setupHierarchy(i.objectId))}}bind(e,t){const i=this.viewer.webgl;let s=this.viewer.gl,a=this.viewer.shaderMap.get("MdxStandardShader");i.useShaderProgram(a),this.shader=a;const r=s.extensions.instancedArrays,n=a.attribs,o=a.uniforms;s.uniformMatrix4fv(o.u_mvp,!1,t.camera.worldProjectionMatrix),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,this.__webglElementBuffer),s.uniform1i(o.u_texture,0);let l=n.a_teamColor,h=n.a_vertexColor;s.bindBuffer(s.ARRAY_BUFFER,e.colorBuffer),s.vertexAttribPointer(l,1,s.UNSIGNED_BYTE,!1,5,0),s.vertexAttribPointer(h,4,s.UNSIGNED_BYTE,!0,5,1),s.activeTexture(s.TEXTURE15),s.bindTexture(s.TEXTURE_2D,e.boneTexture),s.uniform1i(o.u_boneMap,15),s.uniform1f(o.u_vectorSize,e.vectorSize),s.uniform1f(o.u_rowSize,e.rowSize);let c=n.a_InstanceID;s.bindBuffer(s.ARRAY_BUFFER,e.instanceIdBuffer),s.vertexAttribPointer(c,1,s.UNSIGNED_SHORT,!1,0,0),r.vertexAttribDivisorANGLE(l,1),r.vertexAttribDivisorANGLE(h,1),r.vertexAttribDivisorANGLE(c,1)}unbind(){let e=this.viewer.gl,t=e.extensions.instancedArrays,i=this.shader.attribs;e.depthMask(1),e.disable(e.BLEND),e.enable(e.CULL_FACE),e.enable(e.DEPTH_TEST),t.vertexAttribDivisorANGLE(i.a_teamColor,0),t.vertexAttribDivisorANGLE(i.a_vertexColor,0),t.vertexAttribDivisorANGLE(i.a_InstanceID,0),t.vertexAttribDivisorANGLE(i.a_geosetColor,0),t.vertexAttribDivisorANGLE(i.a_layerAlpha,0),t.vertexAttribDivisorANGLE(i.uvTransRot,0),t.vertexAttribDivisorANGLE(i.uvScaleSprite,0)}renderBatch(e,t){let i,s=this.viewer.gl,a=s.extensions.instancedArrays,r=this.shader,n=this.shader.attribs,o=r.uniforms,l=t.geoset,h=t.layer,c=this.shallowGeosets[l.index],d=this.replaceables[h.textureId];h.bind(r);let u=!1;1===d?(i=this.viewer.getTextureAtlas("teamColors"),u=!0):2===d?(i=this.viewer.getTextureAtlas("teamGlows"),u=!0):i=this.textures[h.textureId],s.uniform1f(o.u_isTeamColor,u),s.uniform1f(o.u_hasSlotAnim,h.hasSlotAnim),s.uniform1f(o.u_hasTranslationAnim,h.hasTranslationAnim),s.uniform1f(o.u_hasRotationAnim,h.hasRotationAnim),s.uniform1f(o.u_hasScaleAnim,h.hasScaleAnim),s.uniform2f(o.u_uvScale,1/h.uvDivisor[0],1/h.uvDivisor[1]),this.bindTexture(i,0,e.modelView);let m=n.a_geosetColor,f=n.a_uvTransRot,p=n.a_uvScaleSprite,g=n.a_layerAlpha;a.vertexAttribDivisorANGLE(m,1),a.vertexAttribDivisorANGLE(f,1),a.vertexAttribDivisorANGLE(p,1),a.vertexAttribDivisorANGLE(g,1),s.bindBuffer(s.ARRAY_BUFFER,e.geosetColorsBuffer),s.vertexAttribPointer(m,4,s.UNSIGNED_BYTE,!0,4,this.batchSize*l.index*4),s.bindBuffer(s.ARRAY_BUFFER,e.layersBuffer),s.vertexAttribPointer(f,4,s.FLOAT,!1,28,7*this.batchSize*h.index*4),s.vertexAttribPointer(p,3,s.FLOAT,!1,28,7*this.batchSize*h.index*4+16),s.vertexAttribPointer(g,1,s.UNSIGNED_BYTE,!0,1,e.layerAlphasData.byteOffset+this.batchSize*h.index),s.bindBuffer(s.ARRAY_BUFFER,this.__webglArrayBuffer),c.bind(r,h.coordId),c.render(e.count)}renderBatches(e,t,i){if(i&&i.length){this.bind(e,t);for(let t=0,s=i.length;t<s;t++)this.renderBatch(e,i[t]);this.unbind()}}renderOpaque(e){let t=e.scene,i=e.buckets;for(let s=0,a=e.usedBuckets;s<a;s++)this.renderBatches(i[s],t,this.opaqueBatches)}renderTranslucent(e){let t=e.scene,i=e.modelView,s=e.buckets,a=e.particleEmitters2,r=e.ribbonEmitters,n=e.eventObjectEmitters;for(let o=0,l=e.usedBuckets;o<l;o++)this.renderBatches(s[o],t,this.translucentBatches);if(a.length||n.length||r.length){let e=this.viewer.webgl,s=this.viewer.gl;s.depthMask(0),s.enable(s.BLEND),s.disable(s.CULL_FACE),s.enable(s.DEPTH_TEST);let o=this.viewer.shaderMap.get("MdxParticleShader");e.useShaderProgram(o),s.uniformMatrix4fv(o.uniforms.u_mvp,!1,t.camera.worldProjectionMatrix),s.uniform1i(o.uniforms.u_texture,0),s.uniform1f(o.uniforms.u_isRibbonEmitter,!1);for(let t=0,r=a.length;t<r;t++)a[t].render(i,o);for(let t=0,a=n.length;t<a;t++)n[t].render(i,o);s.uniform1f(o.uniforms.u_isRibbonEmitter,!0);for(let t=0,a=r.length;t<a;t++)r[t].render(i,o)}}}class ir{constructor(e){this.modelObject=e,this.objects=[],this.alive=0}emitObject(e,t){let i=this.objects;this.alive===i.length&&i.push(this.createObject());let s=i[this.alive];return this.alive+=1,s.reset(e,t),s}update(){let e=this.objects;for(let t=0;t<this.alive;t++){let i=e[t];i.update(),i.health<=0&&(this.alive-=1,t!==this.alive&&(e[t]=e[this.alive],e[this.alive]=i,t-=1))}this.updateData()}fill(e){let t=e.currentEmission;if(t>=1)for(let i=0;i<t;i+=1,e.currentEmission--)this.emit(e)}updateData(){}render(e,t){}clear(e){for(let t of this.objects)e===t.emitterView.instance&&(t.health=0)}}let sr=os.quat.create(),ar=os.vec3.create(),rr=new Float32Array(1),nr=new Float32Array(1),or=new Float32Array(1),lr=new Float32Array(1);class hr{constructor(e){this.emitter=e,this.emitterView=null,this.internalInstance=e.modelObject.internalResource.addInstance(),this.velocity=os.vec3.create(),this.gravity=0}reset(e){let t=e.instance,i=t.nodes[this.emitter.modelObject.index],s=this.internalInstance,a=i.worldScale,r=this.velocity;e.getLatitude(rr),e.getLifeSpan(nr),e.getGravity(or),e.getSpeed(lr),this.emitterView=e,this.node=i,this.health=nr[0],this.gravity=or[0]*a[2],os.quat.identity(sr),os.quat.rotateZ(sr,sr,cs(-Math.PI,Math.PI)),os.quat.rotateY(sr,sr,cs(-rr[0],rr[0])),os.vec3.transformQuat(r,Rs,sr),os.vec3.transformQuat(r,r,i.worldRotation),os.vec3.scale(r,r,lr[0]),os.vec3.mul(r,r,a),t.scene.addInstance(s),s.setTransformation(i.worldLocation,os.quat.setAxisAngle(sr,Rs,cs(0,2*Math.PI)),i.worldScale),s.setSequence(0),s.show()}update(){let e=this.internalInstance,t=this.velocity,i=.001*e.model.viewer.frameTime;e.paused=!1,this.health-=i,t[2]-=this.gravity*i,e.move(os.vec3.scale(ar,t,i)),this.health<=0&&this.internalInstance.hide()}}class cr extends ir{emit(e){this.emitObject(e)}createObject(){return new hr(this)}}class dr extends ir{constructor(e){super(e),this.data=new Float32Array(0),this.buffer=e.model.viewer.gl.createBuffer(),this.bufferSize=0}emitObject(e,t){return super.emitObject(e,t)}updateData(){let e=this.objects,t=this.alive,i=t*this.elementsPerEmit;if(this.data.length<i){this.data=new Float32Array(us(i));let e=this.modelObject.model.viewer.gl;e.bindBuffer(e.ARRAY_BUFFER,this.buffer),e.bufferData(e.ARRAY_BUFFER,this.data.byteLength,e.DYNAMIC_DRAW)}let s=this.data;for(let a=0,r=0;a<t;a+=1,r+=30){let t=e[a],i=t.vertices,n=t.lta,o=t.lba,l=t.rta,h=t.rba,c=t.rgb;s[r+0]=i[0],s[r+1]=i[1],s[r+2]=i[2],s[r+3]=n,s[r+4]=c,s[r+5]=i[3],s[r+6]=i[4],s[r+7]=i[5],s[r+8]=o,s[r+9]=c,s[r+10]=i[6],s[r+11]=i[7],s[r+12]=i[8],s[r+13]=h,s[r+14]=c,s[r+15]=i[0],s[r+16]=i[1],s[r+17]=i[2],s[r+18]=n,s[r+19]=c,s[r+20]=i[6],s[r+21]=i[7],s[r+22]=i[8],s[r+23]=h,s[r+24]=c,s[r+25]=i[9],s[r+26]=i[10],s[r+27]=i[11],s[r+28]=l,s[r+29]=c}}render(e,t){let i=this.modelObject,s=this.alive;if(i.internalResource&&s>0){let a=i.model,r=a.viewer.gl;r.blendFunc(i.blendSrc,i.blendDst),r.uniform2fv(t.uniforms.u_dimensions,i.dimensions),a.bindTexture(i.internalResource,0,e),r.bindBuffer(r.ARRAY_BUFFER,this.buffer),r.bufferSubData(r.ARRAY_BUFFER,0,this.data.subarray(0,30*s)),r.vertexAttribPointer(t.attribs.a_position,3,r.FLOAT,!1,20,0),r.vertexAttribPointer(t.attribs.a_uva_rgb,2,r.FLOAT,!1,20,12),r.drawArrays(r.TRIANGLES,0,6*s)}}}let ur=os.quat.create(),mr=os.vec3.create(),fr=new Uint8Array(4),pr=new Float32Array(1),gr=new Float32Array(1),wr=new Float32Array(1),vr=new Float32Array(1),yr=new Float32Array(1),br=new Float32Array(1),Ar=(new Float32Array(9),[os.vec3.create(),os.vec3.create(),os.vec3.create(),os.vec3.create(),os.vec3.create(),os.vec3.create()]);class Er{constructor(e){this.emitter=e,this.emitterView=null,this.health=0,this.head=!0,this.location=os.vec3.create(),this.velocity=os.vec3.create(),this.gravity=0,this.nodeScale=os.vec3.create(),this.vertices=new Float32Array(12),this.lta=0,this.lba=0,this.rta=0,this.rba=0,this.rgb=0}reset(e,t){e.getWidth(pr),e.getLength(gr),e.getLatitude(wr),e.getVariation(vr),e.getSpeed(yr),e.getGravity(br);let i=this.emitter.modelObject,s=e.instance.nodes[i.index],a=s.pivot,r=s.worldScale,n=.5*pr[0],o=.5*gr[0],l=wr[0]*(Math.PI/180);let h=vr[0],c=yr[0],d=this.location,u=this.velocity;this.emitterView=e,this.node=s,this.health=i.lifeSpan,this.head=t,this.gravity=br[0]*r[2],os.vec3.copy(this.nodeScale,r),d[0]=a[0]+cs(-n,n),d[1]=a[1]+cs(-o,o),d[2]=a[2],i.modelSpace||os.vec3.transformMat4(d,d,s.worldMatrix),os.quat.identity(ur),os.quat.rotateZ(ur,ur,Math.PI/2),os.quat.rotateY(ur,ur,cs(-l,l)),i.lineEmitter||os.quat.rotateX(ur,ur,cs(-l,l)),i.modelSpace||os.quat.mul(ur,s.worldRotation,ur),os.vec3.transformQuat(u,Rs,ur),os.vec3.scale(u,u,c+cs(-h,h)),os.vec3.mul(u,u,r)}update(){let e=this.emitter.modelObject,t=.001*e.model.viewer.frameTime,i=this.location,s=mr,a=this.velocity;this.health-=t,a[2]-=this.gravity*t,os.vec3.scaleAndAdd(i,i,a,t),os.vec3.copy(s,i);let r,n,o,l=(e.lifeSpan-this.health)/e.lifeSpan,h=e.timeMiddle,c=e.intervals,d=this.head;l<h?(r=l/h,n=0,o=d?c[0]:c[2]):(r=(l-h)/(1-h),n=1,o=d?c[1]:c[3]),r=Math.min(r,1);let u,m,f,p,g=o[0],w=o[1],v=o[2],y=e.scaling,b=e.colors,A=ds(y[n],y[n+1],r),E=this.emitterView.instance;if(e.teamColored){let e=E.teamColor;f=(u=e%4)+1,p=(m=e/4|0)+1}else{let t=e.dimensions[0],i=0,s=w-g;s&&(i=g+Math.floor(s*v*r)%s),f=(u=i%t)+1,p=(m=i/t|0)+1}os.vec4.lerp(fr,b[n],b[n+1],r);let x=fr[3];this.lta=gt(f,p,x),this.lba=gt(u,p,x),this.rta=gt(f,m,x),this.rba=gt(u,m,x),this.rgb=gt(fr[0],fr[1],fr[2]),E.scene;let T,S=E.scene.camera;T=e.xYQuad?S.vectors:S.billboardedVectors;let _=this.vertices,I=this.nodeScale,R=A*I[0],C=A*I[1],B=A*I[2];if(d){e.modelSpace&&os.vec3.transformMat4(s,s,this.node.worldMatrix);let t=s[0],i=s[1],r=s[2];if(e.xYQuad){let e=Ar[4],t=Ar[5];e[0]=a[0],e[1]=a[1],e[2]=0,os.vec3.normalize(e,e),t[0]=-e[1],t[1]=e[0],t[2]=0,os.vec3.add(Ar[2],e,t),os.vec3.sub(Ar[1],t,e),os.vec3.negate(Ar[0],Ar[2]),os.vec3.negate(Ar[3],Ar[1]),T=Ar}let n=T[0],o=T[1],l=T[2],h=T[3];_[0]=t+n[0]*R,_[1]=i+n[1]*C,_[2]=r+n[2]*B,_[3]=t+o[0]*R,_[4]=i+o[1]*C,_[5]=r+o[2]*B,_[6]=t+l[0]*R,_[7]=i+l[1]*C,_[8]=r+l[2]*B,_[9]=t+h[0]*R,_[10]=i+h[1]*C,_[11]=r+h[2]*B}else{let t=e.tailLength,i=t*a[0]*1,r=t*a[1]*1,n=t*a[2]*1,o=[s[0]-i,s[1]-r,s[2]-n],l=[s[0],s[1],s[2]];e.modelSpace&&(os.vec3.transformMat4(o,o,this.node.worldMatrix),os.vec3.transformMat4(l,l,this.node.worldMatrix));let h=o[0],c=o[1],d=o[2],u=l[0],m=l[1],f=l[2],p=[u-h,m-c,f-d];os.vec3.normalize(p,p);let g=os.vec3.cross([],S.billboardedVectors[6],p);os.vec3.normalize(g,g);let w=g[0]*R,v=g[1]*C,y=g[2]*B;_[0]=h-w,_[1]=c-v,_[2]=d-y,_[6]=u+w,_[7]=m+v,_[8]=f+y,_[3]=u-w,_[4]=m-v,_[5]=f-y,_[9]=h+w,_[10]=c+v,_[11]=d+y}}}class xr extends dr{constructor(e){super(e),this.elementsPerEmit=30*(2===e.headOrTail?2:1)}emit(e){this.modelObject.head&&this.emitObject(e,!0),this.modelObject.tail&&this.emitObject(e,!1)}createObject(){return new Er(this)}}let Tr=os.vec3.create(),Sr=os.vec3.create(),_r=os.vec3.create(),Ir=new Float32Array(1),Rr=new Float32Array(1);class Cr{constructor(e){this.emitter=e,this.health=0,this.emitterView=null,this.vertices=new Float32Array(12),this.lta=0,this.lba=0,this.rta=0,this.rba=0,this.rgb=0}reset(e){let t=this.emitter,i=this.vertices;this.index=e.currentRibbon++,e.ribbonCount++,this.emitterView=e,this.health=t.modelObject.lifeSpan;let s=e.lastEmit;if(s&&s.health>0){let a=e.instance.nodes[t.modelObject.index],r=a.pivot;e.getHeightBelow(Tr),e.getHeightAbove(Sr),os.vec3.set(Tr,r[0],r[1]-Tr[0],r[2]),os.vec3.transformMat4(Tr,Tr,a.worldMatrix),os.vec3.set(Sr,r[0],r[1]+Sr[0],r[2]),os.vec3.transformMat4(Sr,Sr,a.worldMatrix);let n=s.vertices;i[0]=Sr[0],i[1]=Sr[1],i[2]=Sr[2],i[3]=Tr[0],i[4]=Tr[1],i[5]=Tr[2],i[6]=n[3],i[7]=n[4],i[8]=n[5],i[9]=n[0],i[10]=n[1],i[11]=n[2]}else i[0]=0,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=0,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=0,i[11]=0}update(){let e=this.emitterView;e.getColor(_r),e.getAlpha(Ir),e.getTextureSlot(Rr);let t=this.emitter.modelObject,i=.001*t.model.viewer.frameTime,s=t.gravity*i*i,a=this.vertices,r=Ir[0],n=Rr[0],o=1/e.ribbonCount,l=e.currentRibbon-this.index-1;if(this.health-=i,a[1]-=s,a[4]-=s,a[7]-=s,a[10]-=s,this.health<=0)e.ribbonCount--;else{let e=t.dimensions[0],i=n%e+l*o,s=n/e|0,a=i+o,h=s+1;i=255*i|0,s=255*s|0,a=255*a|0,h*=255,r=255*r|0,this.lta=gt(i,s,r),this.lba=gt(i,h,r),this.rta=gt(a,s,r),this.rba=gt(a,h,r),this.rgb=gt(255*_r[0]|0,255*_r[1]|0,255*_r[2]|0)}}}class Br extends dr{constructor(e){super(e),this.elementsPerEmit=30}emit(e){e.lastEmit=this.emitObject(e)}createObject(){return new Cr(this)}fill(e){e.currentEmission>=1&&(this.emit(e),e.currentEmission--)}render(e,t){let i=this.alive;if(i>0){let s=this.modelObject,a=s.model,r=a.viewer.gl;s.layer.bind(t),r.uniform2fv(t.uniforms.u_dimensions,s.dimensions),a.bindTexture(s.texture,0,e),r.bindBuffer(r.ARRAY_BUFFER,this.buffer),r.bufferSubData(r.ARRAY_BUFFER,0,this.data.subarray(0,30*i)),r.vertexAttribPointer(t.attribs.a_position,3,r.FLOAT,!1,20,0),r.vertexAttribPointer(t.attribs.a_uva_rgb,2,r.FLOAT,!1,20,12),r.drawArrays(r.TRIANGLES,0,6*i)}}}class Fr{constructor(e){this.emitter=e,this.emitterView=null,this.health=0,this.internalResource=e.modelObject.internalResource.addInstance()}reset(e){let t=this.internalResource,i=e.instance.nodes[this.emitter.modelObject.index];this.emitterView=e,t.setSequence(0),t.setTransformation(i.worldLocation,i.worldRotation,i.worldScale),t.show(),e.instance.scene.addInstance(t),this.health=1}update(){let e=this.internalResource;e.frame>=e.model.sequences[0].interval[1]&&(this.health=0,e.hide())}}class Lr extends ir{constructor(e){super(e),this.type="SPN"}emit(e){this.modelObject.ok&&this.emitObject(e)}createObject(){return new Fr(this)}}class Dr{constructor(e){this.emitter=e,this.emitterView=null,this.health=0,this.color=new Uint8Array(4),this.vertices=new Float32Array(12),this.lta=0,this.lba=0,this.rta=0,this.rba=0,this.rgb=0}reset(e){let t,i=this.emitter.modelObject,s=this.vertices,a=i.scale,r=e.instance.nodes[i.index].worldMatrix;this.emitterView=e,t=s.subarray(0,2),os.vec3.transformMat4(t,[-a,-a,0],r),t=s.subarray(3,5),os.vec3.transformMat4(t,[-a,a,0],r),t=s.subarray(6,8),os.vec3.transformMat4(t,[a,a,0],r),t=s.subarray(9,11),os.vec3.transformMat4(t,[a,-a,0],r),this.health=i.lifespan}update(){let e,t,i,s,a=this.emitter.modelObject,r=a.dimensions[0],n=a.intervalTimes,o=a.intervals,l=n[0],h=n[1],c=a.colors,d=this.color;this.health-=.001*a.model.viewer.frameTime;let u=a.lifespan-this.health;u<l?(e=u/l,t=o[0],i=0):(e=(u-l)/h,t=o[1],i=1),os.vec4.lerp(d,c[i],c[i+1],e);let m=(s=Math.floor(ds(t[0],t[1],e)))%r,f=Math.floor(s/r),p=m+1,g=f+1,w=d[3];this.lta=gt(p,g,w),this.lba=gt(m,g,w),this.rta=gt(p,f,w),this.rba=gt(m,f,w),this.rgb=gt(d[0],d[1],d[2])}}class Mr extends dr{constructor(e){super(e),this.type="SPL",this.elementsPerEmit=30}emit(e){this.modelObject.ok&&this.emitObject(e)}createObject(){return new Dr(this)}}class Ur{constructor(e){this.emitter=e,this.emitterView=null,this.health=0,this.color=new Uint8Array(4),this.vertices=new Float32Array(12),this.lta=0,this.lba=0,this.rta=0,this.rba=0,this.rgb=0}reset(e){let t,i=this.emitter.modelObject,s=this.vertices,a=i.scale,r=e.instance.nodes[i.index].worldMatrix;this.emitterView=e,t=s.subarray(0,2),os.vec3.transformMat4(t,[-a,-a,0],r),t=s.subarray(3,5),os.vec3.transformMat4(t,[-a,a,0],r),t=s.subarray(6,8),os.vec3.transformMat4(t,[a,a,0],r),t=s.subarray(9,11),os.vec3.transformMat4(t,[a,-a,0],r),this.health=i.lifespan}update(){let e=this.emitter.modelObject,t=e.intervalTimes,i=t[0],s=t[1],a=t[2],r=e.colors,n=this.color;this.health-=.001*e.model.viewer.frameTime;let o=e.lifespan-this.health;o<i?os.vec4.lerp(n,r[0],r[1],o/i):o<i+s?os.vec4.copy(n,e.colors[1]):os.vec4.lerp(n,r[1],r[2],(o-i-s)/a);let l=n[3];this.lta=gt(1,0,l),this.lba=gt(0,0,l),this.rta=gt(1,1,l),this.rba=gt(0,1,l),this.rgb=gt(n[0],n[1],n[2])}}class Pr extends dr{constructor(e){super(e),this.type="UBR",this.elementsPerEmit=30}emit(e){this.modelObject.ok&&this.emitObject(e)}createObject(){return new Ur(this)}}class kr{constructor(e){this.modelObject=e,this.type="SND"}emit(e){if(this.modelObject.ok){let t=this.modelObject.model.viewer,i=e.instance.scene;if(t.enableAudio&&i.audioEnabled){let t=i.audioContext,s=e.emitter,a=s.decodedBuffers,r=t.createPanner(),n=t.createBufferSource();r.setPosition(...e.instance.nodes[s.objectId].worldLocation),r.maxDistance=s.distanceCutoff,r.refDistance=s.minDistance,r.connect(t.destination),n.buffer=a[Math.random()*a.length|0],n.connect(r),n.start(0)}}}update(){}fill(e){let t=e.currentEmission;if(t>=1)for(let i=0;i<t;i+=1,e.currentEmission--)this.emit(e)}render(e,t){}clear(e){}}var Nr=class extends ha{constructor(e){super(e);let t=this.model,i=t.batchSize,s=t.viewer.gl,a=t.bones.length+1;this.boneArrayInstanceSize=16*a,this.boneArray=new Float32Array(this.boneArrayInstanceSize*i),this.boneTexture=s.createTexture(),this.boneTextureWidth=4*a,this.boneTextureHeight=i,this.vectorSize=1/this.boneTextureWidth,this.rowSize=1/this.boneTextureHeight,s.activeTexture(s.TEXTURE15),s.bindTexture(s.TEXTURE_2D,this.boneTexture),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texImage2D(s.TEXTURE_2D,0,s.RGBA32F,this.boneTextureWidth,this.boneTextureHeight,0,s.RGBA,s.FLOAT,this.boneArray),this.colorData=new Uint8Array(5*i),this.colorBuffer=s.createBuffer(),s.bindBuffer(s.ARRAY_BUFFER,this.colorBuffer),s.bufferData(s.ARRAY_BUFFER,this.colorData.byteLength,s.DYNAMIC_DRAW),t.batches.length>0&&(this.geosetColorsData=new Uint8Array(i*t.geosets.length*4),this.geosetColorsBuffer=s.createBuffer(),s.bindBuffer(s.ARRAY_BUFFER,this.geosetColorsBuffer),s.bufferData(s.ARRAY_BUFFER,this.geosetColorsData.byteLength,s.DYNAMIC_DRAW),this.layersData=new ArrayBuffer(i*t.layers.length*29),this.uvTransformsData=new Float32Array(this.layersData,0,i*t.layers.length*7),this.layerAlphasData=new Uint8Array(this.layersData,i*t.layers.length*28,i*t.layers.length),this.layersBuffer=s.createBuffer(),s.bindBuffer(s.ARRAY_BUFFER,this.layersBuffer),s.bufferData(s.ARRAY_BUFFER,this.layersData.byteLength,s.DYNAMIC_DRAW))}fill(e){let t=e.baseIndex,i=this.model,s=i.viewer.gl,a=i.batchSize,r=i.geosets.length,n=i.layers.length,o=i.bones.length,l=this.boneArray,h=this.colorData,c=this.geosetColorsData,d=this.layerAlphasData,u=this.uvTransformsData,m=0,f=e.instances,p=e.particleEmitters,g=e.particleEmitters2,w=e.ribbonEmitters,v=e.eventObjectEmitters;for(let y=f.length;t<y&&m<a;t++){let e=f[t];if(e.rendered&&!e.culled){let t=e.vertexColor,s=e.worldMatrices,f=e.geosetColors,y=e.layerAlphas,b=e.uvOffsets,A=e.uvScales,E=e.uvRots,x=16+m*(16+16*o),T=e.particleEmitters,S=e.particleEmitters2,_=e.ribbonEmitters,I=e.eventObjectEmitters,R=4*m,C=5*m,B=7*m;for(let e=0,i=16*o;e<i;e++)l[x+e]=s[e];h[C]=e.teamColor,h[C+1]=t[0],h[C+2]=t[1],h[C+3]=t[2],h[C+4]=t[3];for(let e=0;e<r;e++){let t=4*e,i=a*t+R;c[i]=f[t],c[i+1]=f[t+1],c[i+2]=f[t+2],c[i+3]=f[t+3]}if(i.batches.length>0)for(let e=0;e<n;e++){let t=4*e,i=a*e*7+B;d[a*e+m]=y[e],u[i]=b[t],u[i+1]=b[t+1],u[i+2]=E[2*e],u[i+3]=E[2*e+1],u[i+4]=A[e],u[i+5]=b[t+2],u[i+6]=b[t+3]}for(let e=0,i=p.length;e<i;e++)p[e].fill(T[e]);for(let e=0,i=g.length;e<i;e++)g[e].fill(S[e]);for(let e=0,i=w.length;e<i;e++)w[e].fill(_[e]);for(let e=0,i=v.length;e<i;e++)v[e].fill(I[e]);m+=1}}return this.count=m,m&&(s.activeTexture(s.TEXTURE15),s.bindTexture(s.TEXTURE_2D,this.boneTexture),s.texSubImage2D(s.TEXTURE_2D,0,0,0,this.boneTextureWidth,m,s.RGBA,s.FLOAT,l),s.bindBuffer(s.ARRAY_BUFFER,this.colorBuffer),s.bufferSubData(s.ARRAY_BUFFER,0,h),r&&(s.bindBuffer(s.ARRAY_BUFFER,this.geosetColorsBuffer),s.bufferSubData(s.ARRAY_BUFFER,0,c)),n&&i.batches.length>0&&(s.bindBuffer(s.ARRAY_BUFFER,this.layersBuffer),s.bufferSubData(s.ARRAY_BUFFER,0,this.layersData))),t}};class Or extends zs{convertBasis(e){os.quat.rotateY(e,e,-Math.PI/2)}}let jr=new Float32Array(1);class Vr{constructor(e,t){let i=t.internalModel.addInstance();i.setSequenceLoopMode(2),i.dontInheritScale=!1,i.hide(),i.setParent(e.nodes[t.objectId]),this.instance=e,this.attachment=t,this.internalInstance=i}update(){let e=this.internalInstance;e.model.ok&&(this.attachment.getVisibility(jr,this.instance),jr[0]>.1?(this.instance.scene.addInstance(e),e.hidden()&&(e.show(),e.setSequence(0))):e.hide())}}let Gr=new Float32Array(1);class Hr{constructor(e,t){this.instance=e,this.emitter=t,this.currentEmission=0}update(){this.instance.allowParticleSpawn&&(this.getEmissionRate(Gr),this.currentEmission+=Gr[0]*this.instance.model.viewer.frameTime*.001)}getSpeed(e){return this.emitter.getSpeed(e,this.instance)}getLatitude(e){return this.emitter.getLatitude(e,this.instance)}getLongitude(e){return this.emitter.getLongitude(e,this.instance)}getLifeSpan(e){return this.emitter.getLifeSpan(e,this.instance)}getGravity(e){return this.emitter.getGravity(e,this.instance)}getEmissionRate(e){return this.emitter.getEmissionRate(e,this.instance)}getVisibility(e){return this.emitter.getVisibility(e,this.instance)}}let Kr=new Float32Array(1);class qr{constructor(e,t){this.instance=e,this.emitter=t,this.currentEmission=0,this.lastEmissionKey=-1}update(){if(this.instance.allowParticleSpawn){let e=this.getEmissionRate(Kr);this.emitter.squirt?(e!==this.lastEmissionKey&&(this.currentEmission+=Kr[0]),this.lastEmissionKey=e):this.currentEmission+=Kr[0]*this.instance.model.viewer.frameTime*.001}}getWidth(e){return this.emitter.getWidth(e,this.instance)}getLength(e){return this.emitter.getLength(e,this.instance)}getSpeed(e){return this.emitter.getSpeed(e,this.instance)}getLatitude(e){return this.emitter.getLatitude(e,this.instance)}getGravity(e){return this.emitter.getGravity(e,this.instance)}getEmissionRate(e){return this.emitter.getEmissionRate(e,this.instance)}getVisibility(e){return this.emitter.getVisibility(e,this.instance)}getVariation(e){return this.emitter.getVariation(e,this.instance)}}class Wr{constructor(e,t){this.instance=e,this.emitter=t,this.currentEmission=0,this.lastEmit=null,this.currentRibbon=-1,this.ribbonCount=0}update(){this.instance.allowParticleSpawn&&(this.currentEmission+=this.emitter.emissionRate*this.instance.model.viewer.frameTime*.001)}getHeightBelow(e){return this.emitter.getHeightBelow(e,this.instance)}getHeightAbove(e){return this.emitter.getHeightAbove(e,this.instance)}getTextureSlot(e){return this.emitter.getTextureSlot(e,this.instance)}getColor(e){return this.emitter.getColor(e,this.instance)}getAlpha(e){return this.emitter.getAlpha(e,this.instance)}getVisibility(e){return this.emitter.getVisibility(e,this.instance)}}let Xr=os.vec2.create();class zr{constructor(e,t){this.instance=e,this.emitter=t,this.lastTrack=new Uint16Array(2),this.currentEmission=0}reset(){this.lastTrack.fill(0)}update(){if(this.instance.allowParticleSpawn){let e=this.emitter,t=this.lastTrack;e.getValue(Xr,this.instance),1!==Xr[0]||Xr[0]===t[0]&&Xr[1]===t[1]||(this.currentEmission+=1),t[0]=Xr[0],t[1]=Xr[1]}}}let Yr=new Float32Array(1),Jr=os.vec3.create(),Zr=os.quat.create(),$r=os.vec3.create(),Qr=new Float32Array(3),en=new Float32Array(1),tn=new Float32Array(1);class sn extends ua{constructor(e){super(e),this.attachments=[],this.particleEmitters=[],this.particleEmitters2=[],this.ribbonEmitters=[],this.eventObjectEmitters=[],this.nodes=[],this.sortedNodes=[],this.frame=0,this.counter=0,this.sequence=-1,this.sequenceLoopMode=0,this.teamColor=0,this.vertexColor=new Uint8Array([255,255,255,255]),this.allowParticleSpawn=!1,this.forced=!0}load(){let e=this.model,t=e.geosets.length,i=e.layers.length;this.geosetColors=new Uint8Array(4*t),this.layerAlphas=new Uint8Array(i),this.uvOffsets=new Float32Array(4*i),this.uvScales=new Float32Array(i),this.uvRots=new Float32Array(2*i);let s=function(e,t){let i=new Float32Array(e*Ys),s=[],a=0,r=3*e,n=4*e,o=16*e;t=t||zs;let l=i.subarray(a,a+r);a+=r;let h=i.subarray(a,a+r);a+=r;let c=i.subarray(a,a+n);a+=n;let d=i.subarray(a,a+r);a+=r;let u=i.subarray(a,a+r);a+=r;let m=i.subarray(a,a+n);a+=n;let f=i.subarray(a,a+r);a+=r;let p=i.subarray(a,a+r);a+=r;let g=i.subarray(a,a+n);a+=n;let w=i.subarray(a,a+r);a+=r;let v=i.subarray(a,a+o);a+=o;let y=i.subarray(a,a+o);for(let b=0;b<e;b++){let e=3*b,i=e+3,a=4*b,r=a+4,n=16*b,o=n+16;s[b]=new t([l.subarray(e,i),h.subarray(e,i),c.subarray(a,r),d.subarray(e,i),u.subarray(e,i),m.subarray(a,r),f.subarray(e,i),p.subarray(e,i),g.subarray(a,r),w.subarray(e,i),v.subarray(n,o),y.subarray(n,o)])}return{data:i,nodes:s,pivots:l,localLocations:h,localRotations:c,localScales:d,worldLocations:u,worldRotations:m,worldScales:f,inverseWorldLocations:p,invereseWorldRotations:g,inverseWorldScales:w,localMatrices:v,worldMatrices:y}}(e.genericObjects.length,Or),a=s.nodes,r=0;this.nodes.push(...a),this.worldMatrices=s.worldMatrices;for(let o of e.bones)this.initNode(a,a[r++],o);for(let o of e.lights)this.initNode(a,a[r++],o);for(let o of e.helpers)this.initNode(a,a[r++],o);for(let o of e.attachments){let e;o.internalModel&&(e=new Vr(this,o),this.attachments.push(e)),this.initNode(a,a[r++],o,e)}for(let o of e.particleEmitters){let e=new Hr(this,o);this.particleEmitters.push(e),this.initNode(a,a[r++],o,e)}for(let o of e.particleEmitters2){let e=new qr(this,o);this.particleEmitters2.push(e),this.initNode(a,a[r++],o,e)}for(let o of e.ribbonEmitters){let e=new Wr(this,o);this.ribbonEmitters.push(e),this.initNode(a,a[r++],o,e)}for(let o of e.cameras)this.initNode(a,a[r++],o);for(let o of e.eventObjects){let e=new zr(this,o);this.eventObjectEmitters.push(e),this.initNode(a,a[r++],o,e)}for(let o of e.collisionShapes)this.initNode(a,a[r++],o);let n=e.hierarchy;for(let o=0,l=a.length;o<l;o++)this.sortedNodes[o]=a[n[o]];this.setSequence(this.sequence)}clearEmittedObjects(){if(this.modelView)for(let e of this.modelView.sceneData.values()){for(let t of e.particleEmitters)t.clear(this);for(let t of e.particleEmitters2)t.clear(this);for(let t of e.ribbonEmitters)t.clear(this);for(let t of e.eventObjectEmitters)t.clear(this)}}initNode(e,t,i,s){t.pivot.set(i.pivot),t.name=i.name,t.gen=i,-1===i.parentId?t.parent=this:t.parent=e[i.parentId],i.billboarded?t.billboarded=!0:i.billboardedX?t.billboardedX=!0:i.billboardedY?t.billboardedY=!0:i.billboardedZ&&(t.billboardedZ=!0),s&&(t.object=s)}hide(){super.hide();for(let e of this.attachments)e.internalInstance.hide()}show(){super.show();for(let e of this.attachments)e.internalInstance.show()}updateTimers(){if(-1!==this.sequence){let e=this.model,t=e.sequences[this.sequence],i=t.interval,s=e.viewer.frameTime;this.frame+=s,this.counter+=s,this.allowParticleSpawn=!0,this.frame>=i[1]&&(2===this.sequenceLoopMode||0===this.sequenceLoopMode&&0===t.flags?(this.frame=i[0],this.resetEventEmitters()):(this.frame=i[1],this.counter-=s,this.allowParticleSpawn=!1),this.emit("seqend",this))}}updateNodes(e){let t=this.sortedNodes,i=this.sequence,s=this.model.sortedGenericObjects,a=this.scene;for(let r=0,n=t.length;r<n;r++){let n=s[r],o=t[r],l=o.parent;n.getVisibility(Yr,this);let h=Yr[0]>=.75,c=e||l.visible&&h;if(o.visible=c,c){let t=!1,s=n.variants,r=o.localLocation,c=o.localRotation,d=o.localScale;(e||s.generic[i])&&(t=!0,(e||s.translation[i])&&(n.getTranslation(Jr,this),r[0]=Jr[0],r[1]=Jr[1],r[2]=Jr[2]),(e||s.rotation[i])&&(n.getRotation(Zr,this),c[0]=Zr[0],c[1]=Zr[1],c[2]=Zr[2],c[3]=Zr[3]),(e||s.scale[i])&&(n.getScale($r,this),d[0]=$r[0],d[1]=$r[1],d[2]=$r[2]));let u=e||t||l.wasDirty||n.anyBillboarding;o.wasDirty=u,u&&o.recalculateTransformation(a);let m=o.object;m&&h&&m.update(),o.updateChildren(a)}}}updateBatches(e){let t=this.model,i=t.geosets,s=t.layers,a=this.geosetColors,r=this.layerAlphas,n=this.uvOffsets,o=this.uvScales,l=this.uvRots,h=this.sequence;for(let c=0,d=i.length;c<d;c++){let t=i[c],s=4*c;(e||t.variants.color[h])&&(t.getColor(Qr,this),a[s]=255*Qr[0],a[s+1]=255*Qr[1],a[s+2]=255*Qr[2]),(e||t.variants.alpha[h])&&(t.getAlpha(en,this),a[s+3]=255*en[0])}for(let c=0,d=s.length;c<d;c++){let t=s[c],i=2*c,a=4*c;if((e||t.variants.alpha[h])&&(t.getAlpha(en,this),r[c]=255*en[0]),(e||t.variants.translation[h])&&(t.getTranslation(Jr,this),n[a]=Jr[0],n[a+1]=Jr[1]),(e||t.variants.rotation[h])&&(t.getRotation(Zr,this),l[i]=Zr[2],l[i+1]=Zr[3]),(e||t.variants.scale[h])&&(t.getScale($r,this),o[c]=$r[0]),e||t.variants.slot[h]){t.getTextureId(tn,this);let e=t.uvDivisor,i=tn[0];n[a+2]=i%e[0],n[a+3]=i/e[1]|0}}}updateAnimations(){let e=this.forced;(e||-1!==this.sequence&&!this.model.viewer.noUpdating)&&(this.forced=!1,this.updateNodes(e),this.updateBatches(e))}setTeamColor(e){return this.teamColor=e,this}setVertexColor(e){return this.vertexColor.set(e),this}setSequence(e){if(this.sequence=e,this.model.ok){let t=this.model.sequences;e<0||e>t.length-1?(this.sequence=-1,this.frame=0,this.allowParticleSpawn=!1):this.frame=t[e].interval[0],this.resetEventEmitters(),this.forced=!0}return this}setSequenceLoopMode(e){return this.sequenceLoopMode=e,this}getAttachment(e){let t=this.model.attachments[e];if(t)return this.nodes[t.index]}resetEventEmitters(){for(let e of this.eventObjectEmitters)e.reset()}}var an={vs:"\n    ".concat(fa,"\n    ").concat(pa,"\n    uniform mat4 u_mvp;\n\n    attribute vec3 a_position;\n    attribute vec3 a_normal;\n    attribute vec2 a_uv;\n    attribute vec4 a_bones;\n    attribute float a_boneNumber;\n    attribute float a_teamColor;\n    attribute vec4 a_vertexColor;\n    attribute vec4 a_geosetColor;\n    attribute float a_layerAlpha;\n    attribute vec4 a_uvTransRot;\n    attribute vec3 a_uvScaleSprite;\n\n    varying vec3 v_normal;\n    varying vec2 v_uv;\n    varying float v_teamColor;\n    varying vec4 v_vertexColor;\n    varying vec4 v_geosetColor;\n    varying vec4 v_uvTransRot;\n    varying vec3 v_uvScaleSprite;\n\n    void transform(inout vec3 position, inout vec3 normal, float boneNumber, vec4 bones) {\n      // For the broken models out there, since the game supports this.\n      if (boneNumber > 0.0) {\n        mat4 b0 = fetchMatrix(bones[0], a_InstanceID);\n        mat4 b1 = fetchMatrix(bones[1], a_InstanceID);\n        mat4 b2 = fetchMatrix(bones[2], a_InstanceID);\n        mat4 b3 = fetchMatrix(bones[3], a_InstanceID);\n        vec4 p = vec4(position, 1);\n        vec4 n = vec4(normal, 0);\n\n        position = vec3(b0 * p + b1 * p + b2 * p + b3 * p) / boneNumber;\n        normal = normalize(vec3(b0 * n + b1 * n + b2 * n + b3 * n));\n      }\n    }\n\n    void main() {\n      vec2 uv = a_uv;\n      vec3 position = a_position;\n      vec3 normal = a_normal;\n\n      transform(position, normal, a_boneNumber, a_bones);\n\n      v_uv = a_uv;\n      v_uvTransRot = a_uvTransRot;\n      v_uvScaleSprite = a_uvScaleSprite;\n\n      v_normal = normal;\n      v_teamColor = a_teamColor;\n      v_vertexColor = a_vertexColor;\n\n      // Is the alpha here even correct?\n      v_geosetColor = vec4(a_geosetColor.rgb, a_layerAlpha);\n\n      // Definitely not correct, but the best I could figure so far.\n      if (a_geosetColor.a < 0.75 || a_layerAlpha < 0.1) {\n        gl_Position = vec4(0.0);\n      } else {\n        gl_Position = u_mvp * vec4(position, 1);\n      }\n    }\n  "),fs:"\n    uniform sampler2D u_texture;\n    uniform bool u_alphaTest;\n    // uniform bool u_unshaded;\n    uniform bool u_isTeamColor;\n    uniform vec2 u_uvScale;\n    uniform bool u_hasSlotAnim;\n    uniform bool u_hasTranslationAnim;\n    uniform bool u_hasRotationAnim;\n    uniform bool u_hasScaleAnim;\n\n    varying vec3 v_normal;\n    varying vec2 v_uv;\n    varying float v_teamColor;\n    varying vec4 v_vertexColor;\n    varying vec4 v_geosetColor;\n    varying vec4 v_uvTransRot;\n    varying vec3 v_uvScaleSprite;\n\n    // const vec3 lightDirection = normalize(vec3(-0.3, -0.3, 0.25));\n\n    ".concat(wa,"\n\n    void main() {\n      vec2 uv;\n\n      if (u_isTeamColor) {\n        // 4 is the amount of columns and rows in the team colors/glows texture.\n        uv = (vec2(mod((v_teamColor + 0.5), 8.0) - 0.5, floor((v_teamColor + 0.5) / 8.0)) + v_uv) / vec2(8.0, 4.0);\n      } else {\n        uv = v_uv;\n\n        // Translation animation\n        if (u_hasTranslationAnim) {\n          uv += v_uvTransRot.xy;\n        }\n\n        // Rotation animation\n        if (u_hasRotationAnim) {\n          uv = quat_transform(v_uvTransRot.zw, uv - 0.5) + 0.5;\n        }\n\n        // Scale animation\n        if (u_hasScaleAnim) {\n          uv = v_uvScaleSprite.x * (uv - 0.5) + 0.5;\n        }\n\n        // Sprite animation\n        if (u_hasSlotAnim) {\n          uv = (v_uvScaleSprite.yz + fract(uv)) * u_uvScale;\n        }\n      }\n\n      vec4 texel = texture2D(u_texture, uv).rgba;\n\n      // 1bit Alpha\n      if (u_alphaTest && texel.a < 0.75) {\n        discard;\n      }\n\n      vec4 color = texel * v_geosetColor.bgra * v_vertexColor;\n\n      // if (!u_unshaded) {\n      //   color *= clamp(dot(v_normal, lightDirection) + 0.45, 0.0, 1.0);\n      // }\n\n      gl_FragColor = color;\n    }\n  "),vsParticles:"\n    ".concat(ga,"\n    uniform mat4 u_mvp;\n    uniform vec2 u_dimensions;\n    uniform bool u_isRibbonEmitter;\n\n    attribute vec3 a_position;\n    attribute vec2 a_uva_rgb;\n\n    varying vec2 v_uv;\n    varying vec4 v_color;\n\n    void main() {\n      vec3 uva = decodeFloat3(a_uva_rgb[0]);\n      vec3 rgb = decodeFloat3(a_uva_rgb[1]);\n      vec2 uv = uva.xy;\n\n      if (u_isRibbonEmitter) {\n        uv /= 255.0;\n      }\n\n      v_uv = uv / u_dimensions;\n      v_color = vec4(rgb, uva.z) / 255.0;\n\n      gl_Position = u_mvp * vec4(a_position, 1);\n    }\n  "),fsParticles:"\n    uniform sampler2D u_texture;\n    uniform bool u_alphaTest;\n    uniform bool u_isRibbonEmitter;\n\n    varying vec2 v_uv;\n    varying vec4 v_color;\n\n    void main() {\n      vec4 texel = texture2D(u_texture, v_uv).rgba;\n\n      // 1bit Alpha, used by ribbon emitters\n      if (u_isRibbonEmitter && u_alphaTest && texel.a < 0.75) {\n        discard;\n      }\n\n      gl_FragColor = texel * v_color;\n    }\n  "},rn={load(e){e.addHandler(ta);let t=e.loadShader("MdxStandardShader",an.vs,an.fs),i=e.loadShader("MdxParticleShader",an.vsParticles,an.fsParticles);return t.ok&&i.ok},extensions:[[".mdx","arrayBuffer"],[".mdl","text"]],Constructor:tr,View:class extends ra{createSceneData(e){let t=this.model,i=super.createSceneData(e),s=[],a=[],r=[],n=[];for(let o of t.particleEmitters)s.push(new cr(o));for(let o of t.particleEmitters2)a.push(new xr(o));for(let o of t.ribbonEmitters)r.push(new Br(o));for(let o of t.eventObjects){let e=o.type;"SPN"===e?n.push(new Lr(o)):"SPL"===e?n.push(new Mr(o)):"UBR"===e?n.push(new Pr(o)):"SND"===e&&n.push(new kr(o))}return{...i,particleEmitters:s,particleEmitters2:a,ribbonEmitters:r,eventObjectEmitters:n}}update(e){let t=super.update(e);if(t){let e=this.model.batches.length,i=t.buckets,s=0,a=0,r=0,n=0;for(let o=0,l=t.usedBuckets;o<l;o++)s+=i[o].count,r+=1,n+=e;for(let o of t.particleEmitters){o.update();let e=o.alive;e&&(a+=e,n+=1)}for(let o of t.particleEmitters2){o.update();let e=o.alive;e&&(a+=e,n+=1)}for(let o of t.ribbonEmitters){o.update();let e=o.alive;e&&(a+=e,n+=1)}for(let o of t.eventObjectEmitters)if(o.update(),"SND"!==o.type){let e=o.alive;e&&(a+=e,n+=1)}this.renderedInstances=s,this.renderedParticles=a,this.renderedBuckets=r,this.renderCalls=n}}},Bucket:Nr,Instance:sn},nn={handler:rn,Model:tr,ModelInstance:sn,Bucket:Nr},on={handler:ta,Texture:ea},ln={vsGround:"\n    uniform mat4 u_mvp;\n    uniform sampler2D u_heightMap;\n    uniform sampler2D u_heightMap0;\n    uniform vec2 u_size;\n    uniform vec2 u_offset;\n    uniform float u_tilesetHeight;\n    uniform float u_tilesetCount;\n    uniform vec2 u_pixel;\n\n    attribute vec2 a_position;\n    ".concat(fa,"\n    attribute vec4 a_textures;\n    attribute vec4 a_variations;\n\n    varying vec2 v_uv[4];\n    varying vec2 v_suv;\n    varying vec3 v_normal;\n\n    vec4 getCell(float tileset, float variation) {\n      float x = variation * 0.03125;\n      float y = tileset * u_tilesetHeight;\n\n      return vec4(x, y, x + 0.03125, y + u_tilesetHeight);\n    }\n    \n    vec2 getUV(vec2 position, float tileset, float variation) {\n      vec2 uv = vec2(position.x, 1.0 - position.y);\n      vec4 cell = getCell(tileset, variation);\n      vec2 cellSize = vec2(1.0 / 32.0, 1.0 / u_tilesetCount);\n      vec2 pixelSize = vec2(2.0 / 2048.0, 2.0 / (64.0 * u_tilesetCount));\n\n      return clamp(cell.xy + uv * cellSize, cell.xy + pixelSize, cell.zw - pixelSize);\n    }\n\n    const float normalDist = 1.0;\n\n    void main() {\n      if (a_textures[0] > 0.5) {\n        v_uv[0] = getUV(a_position, a_textures[0], a_variations[0]);\n        v_uv[1] = getUV(a_position, a_textures[1], a_variations[1]);\n        v_uv[2] = getUV(a_position, a_textures[2], a_variations[2]);\n        v_uv[3] = getUV(a_position, a_textures[3], a_variations[3]);\n\n        vec2 halfPixel = vec2(0.5, 0.5) * u_pixel;\n        vec2 corner = vec2(mod(a_InstanceID, u_size.x), floor(a_InstanceID / u_size.x));\n        vec2 base = floor(corner + a_position);\n        float height = texture2D(u_heightMap, base * u_pixel + halfPixel).COMP1D;\n\n        float hL = texture2D(u_heightMap0, vec2(base - vec2(normalDist, 0.0)) * u_pixel + halfPixel).COMP1D;\n        float hR = texture2D(u_heightMap0, vec2(base + vec2(normalDist, 0.0)) * u_pixel + halfPixel).COMP1D;\n        float hD = texture2D(u_heightMap0, vec2(base - vec2(0.0, normalDist)) * u_pixel + halfPixel).COMP1D;\n        float hU = texture2D(u_heightMap0, vec2(base + vec2(0.0, normalDist)) * u_pixel + halfPixel).COMP1D;\n\n        v_normal = normalize(vec3(hL - hR, hD - hU, normalDist * 2.0));\n\n        v_suv = base / u_size;\n        gl_Position = u_mvp * vec4(base * 128.0 + u_offset, height * 128.0, 1.0);\n      } else {\n        v_uv[0] = vec2(0.0);\n        v_uv[1] = vec2(0.0);\n        v_uv[2] = vec2(0.0);\n        v_uv[3] = vec2(0.0);\n        v_suv = vec2(0.0);\n\n        v_normal = vec3(0.0);\n\n        gl_Position = vec4(0.0);\n      }\n    }\n  "),fsGround:"\n    uniform sampler2D u_tilesets;\n    uniform sampler2D u_shadowMap;\n\n    varying vec2 v_uv[4];\n    varying vec2 v_suv;\n    varying vec3 v_normal;\n\n    const vec3 lightDirection = normalize(vec3(-0.3, -0.3, 0.25));\n\n    vec4 blend(vec4 color, vec2 uv) {\n      vec4 texel = texture2D(u_tilesets, uv).rgba;\n\n      return mix(color, texel, texel.a);\n    }\n\n    void main() {\n      vec4 color = texture2D(u_tilesets, v_uv[0]).rgba;\n      color = blend(color, v_uv[1]);\n      color = blend(color, v_uv[2]);\n      color = blend(color, v_uv[3]);\n\n      float shadow = texture2D(u_shadowMap, v_suv).COMP1D;\n      color.xyz *= clamp(dot(v_normal, lightDirection) + 0.45, 0.0, 1.0);\n      color.xyz *= 1.0 - shadow;\n\n      gl_FragColor = color;\n    }\n  ",vsWater:"\n    uniform mat4 u_mvp;\n    uniform sampler2D u_heightMap;\n    uniform sampler2D u_waterHeightMap;\n    uniform vec2 u_size;\n    uniform vec2 u_pixel;\n    uniform vec2 u_offset;\n    uniform float u_offsetHeight;\n    uniform float u_tileIndex;\n    uniform vec4 u_minDeepColor;\n    uniform vec4 u_maxDeepColor;\n    uniform vec4 u_minShallowColor;\n    uniform vec4 u_maxShallowColor;\n\n    attribute vec2 a_position;\n    ".concat(fa,"\n    attribute float a_isWater;\n\n    varying vec2 v_uv;\n    varying vec2 v_position;\n    varying vec4 v_color;\n\n    const float minDepth = 10.0 / 128.0;\n    const float deepLevel = 64.0 / 128.0;\n    const float maxDepth = 72.0 / 128.0;\n\n    void main() {\n      if (a_isWater > 0.5) {\n        vec2 corner = vec2(mod(a_InstanceID, u_size.x), floor(a_InstanceID / u_size.x));\n        vec2 texPosition = (mod(corner, 2.0) + a_position) * 0.5;\n        v_uv = (vec2(mod(u_tileIndex, 16.0), floor(u_tileIndex / 16.0)) + texPosition) / vec2(16.0, 3.0);\n\n        vec2 halfPixel = vec2(0.5, 0.5) * u_pixel;\n        vec2 base = corner + a_position;\n        float height = texture2D(u_heightMap, base * u_pixel + halfPixel).COMP1D;\n        float waterHeight = texture2D(u_waterHeightMap, base * u_pixel + halfPixel).COMP1D + u_offsetHeight;\n        float value = clamp(waterHeight - height, 0.0, 1.0);\n\n        if (value <= deepLevel) {\n          value = max(0.0, value - minDepth) / (deepLevel - minDepth);\n          v_color = mix(u_minShallowColor, u_maxShallowColor, value) / 255.0;\n        } else {\n          value = clamp(value - deepLevel, 0.0, maxDepth - deepLevel) / (maxDepth - deepLevel);\n          v_color = mix(u_minDeepColor, u_maxDeepColor, value) / 255.0;\n        }\n\n        v_position = base * 128.0 + u_offset;\n        gl_Position = u_mvp * vec4(v_position, waterHeight * 128.0, 1.0);\n      } else {\n        v_uv = vec2(0.0);\n        v_color = vec4(0.0);\n\n        gl_Position = vec4(0.0);\n      }\n    }\n  "),fsWater:"\n    uniform sampler2D u_waterMap;\n\n    uniform vec4 u_mapBounds;\n\n    varying vec2 v_position;\n    varying vec2 v_uv;\n    varying vec4 v_color;\n\n    void main() {\n      vec2 d2 = min(v_position - u_mapBounds.xy, u_mapBounds.zw - v_position);\n      float d1 = clamp(min(d2.x, d2.y) / 64.0 + 1.0, 0.0, 1.0) * 0.8 + 0.2;\n      gl_FragColor = texture2D(u_waterMap, v_uv).rgba * vec4(v_color.rgb * d1, v_color.a);\n    }\n  ",vsCliffs:"\n    uniform mat4 u_mvp;\n    uniform sampler2D u_heightMap;\n    uniform vec2 u_pixel;\n    uniform vec2 u_size;\n    uniform vec2 u_centerOffset;\n\n    attribute vec3 a_position;\n    attribute vec3 a_normal;\n    attribute vec2 a_uv1;\n    attribute vec2 a_uv2;\n    attribute vec3 a_instancePosition;\n    attribute float a_instanceTexture;\n\n    varying vec3 v_normal1;\n    varying vec3 v_normal2;\n    varying float v_height;\n    varying vec2 v_uv1;\n    varying vec2 v_uv2;\n    varying vec2 v_suv;\n    varying float v_texture;\n\n    const float normalDist = 1.0;\n\n    void main() {\n      // Half of a pixel in the cliff height map.\n      vec2 halfPixel = u_pixel * 0.5;\n\n      vec3 position = vec3(a_position.y, -a_position.x, a_position.z);\n\n      // The bottom left corner of the map tile this vertex is on.\n      vec2 corner = ((a_instancePosition.xy - u_centerOffset.xy + position.xy) / 128.0);\n\n      float height = texture2D(u_heightMap, corner * u_pixel + halfPixel).COMP1D;\n\n      float hL = texture2D(u_heightMap, vec2(corner - vec2(normalDist, 0.0)) * u_pixel + halfPixel).COMP1D;\n      float hR = texture2D(u_heightMap, vec2(corner + vec2(normalDist, 0.0)) * u_pixel + halfPixel).COMP1D;\n      float hD = texture2D(u_heightMap, vec2(corner - vec2(0.0, normalDist)) * u_pixel + halfPixel).COMP1D;\n      float hU = texture2D(u_heightMap, vec2(corner + vec2(0.0, normalDist)) * u_pixel + halfPixel).COMP1D;\n\n      v_normal1 = normalize(vec3(hL - hR, hD - hU, normalDist * 2.0));\n      v_normal2 = vec3(a_normal.y, -a_normal.x, a_normal.z);\n      v_height = position.z / 128.0;\n\n      v_uv1 = a_uv1;\n      v_uv2 = a_uv2;\n      v_suv = corner / u_size;\n      v_texture = a_instanceTexture;\n\n      gl_Position = u_mvp * vec4(position + vec3(a_instancePosition.xy, a_instancePosition.z + height * 128.0), 1.0);\n    }\n  ",fsCliffs:"\n    uniform sampler2D u_texture1;\n    uniform sampler2D u_texture2;\n    uniform sampler2D u_shadowMap;\n\n    varying vec3 v_normal1;\n    varying vec3 v_normal2;\n    varying float v_height;\n    varying vec2 v_uv1;\n    varying vec2 v_uv2;\n    varying vec2 v_suv;\n    varying float v_texture;\n\n    const vec3 lightDirection = normalize(vec3(-0.3, -0.3, 0.25));\n\n    vec4 sample(int texture) {\n      if (texture == 0) {\n        return texture2D(u_texture1, v_uv1);\n      } else if (texture == 1) {\n        return texture2D(u_texture2, v_uv1);\n      } else {\n        vec4 c1 = texture2D(u_texture1, v_uv1).rgba;\n        vec4 c2 = texture2D(u_texture2, v_uv2).rgba;\n        return mix(c1, c2, c2.a);\n      }\n    }\n\n    void main() {\n      vec4 color = sample(int(v_texture+0.01)).rgba;\n\n      float height = 2.0 * (fract(v_height) - 0.5);\n      height = height * height;\n      vec3 normal = normalize(mix(v_normal2, v_normal1, height));\n\n      float shadow = texture2D(u_shadowMap, v_suv).COMP1D;\n      color.xyz *= clamp(dot(normal, lightDirection) + 0.45, 0.1, 1.0);\n      color.xyz *= 1.0 - shadow;\n\n      gl_FragColor = color;\n    }\n  ",vsUberSplat:"\n    uniform mat4 u_mvp;\n    uniform sampler2D u_heightMap;\n    uniform vec2 u_pixel;\n    uniform vec2 u_size;\n    uniform vec2 u_shadowPixel;\n    uniform vec2 u_centerOffset;\n\n    attribute vec3 a_position;\n    attribute vec2 a_uv;\n\n    varying vec2 v_uv;\n    varying vec2 v_suv;\n    varying vec3 v_normal;\n\n    const float normalDist = 0.25;\n\n    void main() {\n      vec2 halfPixel = u_pixel * 0.5;\n\n      vec2 base = (a_position.xy - u_centerOffset) / 128.0;\n      float height = texture2D(u_heightMap, base * u_pixel + halfPixel).COMP1D;\n\n      float hL = texture2D(u_heightMap, vec2(base - vec2(normalDist, 0.0)) * u_pixel + halfPixel).COMP1D;\n      float hR = texture2D(u_heightMap, vec2(base + vec2(normalDist, 0.0)) * u_pixel + halfPixel).COMP1D;\n      float hD = texture2D(u_heightMap, vec2(base - vec2(0.0, normalDist)) * u_pixel + halfPixel).COMP1D;\n      float hU = texture2D(u_heightMap, vec2(base + vec2(0.0, normalDist)) * u_pixel + halfPixel).COMP1D;\n\n      v_normal = normalize(vec3(hL - hR, hD - hU, normalDist * 2.0));\n      v_uv = a_uv;\n      v_suv = base / u_size;\n\n      gl_Position = u_mvp * vec4(a_position.xy, height * 128.0 + a_position.z, 1.0);\n    }\n  ",fsUberSplat:"\n    uniform sampler2D u_texture;\n    uniform sampler2D u_shadowMap;\n    uniform vec4 u_color;\n\n    varying vec2 v_uv;\n    varying vec2 v_suv;\n    varying vec3 v_normal;\n\n    const vec3 lightDirection = normalize(vec3(-0.3, -0.3, 0.25));\n\n    void main() {\n      if (any(bvec4(lessThan(v_uv, vec2(0.0)), greaterThan(v_uv, vec2(1.0))))) {\n        discard;\n      }\n      vec4 color = texture2D(u_texture, clamp(v_uv, 0.0, 1.0)).rgba * u_color;\n\n      float shadow = texture2D(u_shadowMap, v_suv).COMP1D;\n      color.xyz *= clamp(dot(v_normal, lightDirection) + 0.45, 0.0, 1.0);\n      color.xyz *= 1.0 - shadow;\n\n      gl_FragColor = color;\n    }\n  ",vsSimpleModel:"\n    uniform mat4 u_mvp;\n\n    attribute vec3 a_position;\n    attribute vec3 a_normal;\n    attribute vec2 a_uv;\n    attribute vec3 a_instancePosition;\n    attribute vec2 a_instanceRotation;\n    attribute float a_instanceScale;\n\n    varying vec3 v_normal;\n    varying vec2 v_uv;\n\n    ".concat(wa,"\n\n    void main() {\n      v_normal = quat_transform(a_instanceRotation, a_normal);\n      v_uv = a_uv;\n\n      gl_Position = u_mvp * vec4(quat_transform(a_instanceRotation, a_position) * a_instanceScale + a_instancePosition, 1.0);\n    }\n  "),fsSimpleModel:"\n    uniform sampler2D u_texture;\n    uniform bool u_alphaTest;\n    uniform bool u_unshaded;\n\n    varying vec3 v_normal;\n    varying vec2 v_uv;\n\n    const vec3 lightDirection = normalize(vec3(-0.3, -0.3, 0.25));\n\n    void main() {\n      vec4 color = texture2D(u_texture, v_uv).rgba;\n\n      // 1bit Alpha\n      if (u_alphaTest && color.a < 0.75) {\n        discard;\n      }\n\n      if (!u_unshaded) {\n        color *= clamp(dot(v_normal, lightDirection) + 0.45, 0.1, 1.0);\n      }\n\n      gl_FragColor = color;\n    }\n  "};const hn={AAAB:1,AAAC:1,AABA:1,AABB:2,AABC:0,AACA:1,AACB:0,AACC:1,ABAA:1,ABAB:1,ABAC:0,ABBA:2,ABBB:1,ABBC:0,ABCA:0,ABCB:0,ABCC:0,ACAA:1,ACAB:0,ACAC:1,ACBA:0,ACBB:0,ACBC:0,ACCA:1,ACCB:0,ACCC:1,BAAA:1,BAAB:1,BAAC:0,BABA:1,BABB:1,BABC:0,BACA:0,BACB:0,BACC:0,BBAA:1,BBAB:1,BBAC:0,BBBA:1,BBCA:0,BCAA:0,BCAB:0,BCAC:0,BCBA:0,BCCA:0,CAAA:1,CAAB:0,CAAC:1,CABA:0,CABB:0,CABC:0,CACA:1,CACB:0,CACC:1,CBAA:0,CBAB:0,CBAC:0,CBBA:0,CBCA:0,CCAA:1,CCAB:0,CCAC:1,CCBA:0,CCCA:1},cn={AAAB:2,AAAC:1,AABA:1,AABB:3,AABC:0,AACA:1,AACB:0,AACC:3,ABAA:1,ABAB:2,ABAC:0,ABBA:3,ABBB:0,ABBC:0,ABCA:0,ABCB:0,ABCC:0,ACAA:1,ACAB:0,ACAC:2,ACBA:0,ACBB:0,ACBC:0,ACCA:3,ACCB:0,ACCC:1,BAAA:1,BAAB:3,BAAC:0,BABA:2,BABB:0,BABC:0,BACA:0,BACB:0,BACC:0,BBAA:3,BBAB:1,BBAC:0,BBBA:1,BBCA:0,BCAA:0,BCAB:0,BCAC:0,BCBA:0,BCCA:0,CAAA:1,CAAB:0,CAAC:3,CABA:0,CABB:0,CABC:0,CACA:2,CACB:0,CACC:1,CBAA:0,CBAB:0,CBAC:0,CBBA:0,CBCA:0,CCAA:3,CCAB:0,CCAC:1,CCBA:0,CCCA:1};function dn(e,t,i){return"Cliffs"===e?Math.min(i,hn[t]):Math.min(i,cn[t])}class un{constructor(e,t,i,s,a){let r=new rs(t),n=r.geosets[0],o=n.vertices,l=n.normals,h=n.uvSets[0],c=n.uvSets[1],d=n.faces,u=o.byteLength,m=u+l.byteLength,f=m+h.byteLength,p=f+(c?c.byteLength:0);c||(f=m);let g=i.length/3;if(!s&&(this.textures=r.textures.map(e=>e.path?a.load(e.path):null),s=new Uint8Array(g),c&&r.textures.length>=2))for(let A=0;A<g;++A)s[A]=2;let w=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,w),e.bufferData(e.ARRAY_BUFFER,p,e.STATIC_DRAW),e.bufferSubData(e.ARRAY_BUFFER,0,o),e.bufferSubData(e.ARRAY_BUFFER,u,l),e.bufferSubData(e.ARRAY_BUFFER,m,h),c&&e.bufferSubData(e.ARRAY_BUFFER,f,c);let v=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,v),e.bufferData(e.ELEMENT_ARRAY_BUFFER,d,e.STATIC_DRAW);let y=4*i.length,b=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,b),e.bufferData(e.ARRAY_BUFFER,y+g,e.STATIC_DRAW),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(i)),e.bufferSubData(e.ARRAY_BUFFER,y,new Uint8Array(s)),this.vertexBuffer=w,this.faceBuffer=v,this.normalsOffset=u,this.uvsOffset=m,this.uvs2Offset=f,this.elements=d.length,this.locationAndTextureBuffer=b,this.texturesOffset=y,this.instances=g}render(e,t,i,s){if(this.textures)for(let a=0;a<this.textures.length&&a<2;++a)if(e.activeTexture(e.TEXTURE1+a),this.textures[a]){if(!this.textures[a].webglResource)return;e.bindTexture(e.TEXTURE_2D,this.textures[a].webglResource),this.disabledMips||(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),this.disabledMips=!0)}else e.bindTexture(e.TEXTURE_2D,s[a].webglResource);e.bindBuffer(e.ARRAY_BUFFER,this.locationAndTextureBuffer),e.vertexAttribPointer(i.a_instancePosition,3,e.FLOAT,!1,12,0),e.vertexAttribPointer(i.a_instanceTexture,1,e.UNSIGNED_BYTE,!1,1,this.texturesOffset),e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer),e.vertexAttribPointer(i.a_position,3,e.FLOAT,!1,12,0),e.vertexAttribPointer(i.a_normal,3,e.FLOAT,!1,12,this.normalsOffset),e.vertexAttribPointer(i.a_uv1,2,e.FLOAT,!1,8,this.uvsOffset),e.vertexAttribPointer(i.a_uv2,2,e.FLOAT,!1,8,this.uvs2Offset),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.faceBuffer),t.drawElementsInstancedANGLE(e.TRIANGLES,this.elements,e.UNSIGNED_SHORT,0,this.instances)}}class mn{constructor(e,t,i,s){this.texture=t,this.batches=[],this.color=[1,1,1,1];let a=[],r=[],n=[],o=i.length/5;for(let l=0;l<o;++l){let[t,o,h,c,d]=i.slice(5*l,5*l+5),u=Math.floor((t-s[0])/128),m=Math.ceil((h-s[0])/128),f=Math.floor((o-s[1])/128),p=Math.ceil((c-s[1])/128),g=(p-f+1)*(m-u+1);if(g>65e3)continue;let w=a.length/3,v=m-u+1;w+g>65e3&&(this.addBatch(e,a,r,n),a.length=0,r.length=0,n.length=0,w=0);for(let e=f;e<=p;++e){let i=128*e+s[1];for(let e=u;e<=m;++e){let n=128*e+s[0];a.push(n,i,d),r.push((n-t)/(h-t),1-(i-o)/(c-o))}}for(let e=0;e<p-f;++e)for(let t=0;t<m-u;++t){let i=w+e*v+t;n.push(i,i+1,i+v,i+1,i+v+1,i+v)}}n.length&&this.addBatch(e,a,r,n)}addBatch(e,t,i,s){let a=4*t.length,r=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,a+4*i.length,e.STATIC_DRAW),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(t)),e.bufferSubData(e.ARRAY_BUFFER,a,new Float32Array(i));let n=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(s),e.STATIC_DRAW),this.batches.push({uvsOffset:a,vertexBuffer:r,faceBuffer:n,elements:s.length})}render(e,t,i){e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.texture.webglResource),e.uniform4fv(t.u_color,this.color);for(let s of this.batches)e.bindBuffer(e.ARRAY_BUFFER,s.vertexBuffer),e.vertexAttribPointer(i.a_position,3,e.FLOAT,!1,12,0),e.vertexAttribPointer(i.a_uv,2,e.FLOAT,!1,8,s.uvsOffset),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s.faceBuffer),e.drawElements(e.TRIANGLES,s.elements,e.UNSIGNED_SHORT,0)}}function fn(e,t){return e.sequence.rarity<t.sequence.rarity}function pn(e,t){let i=t.toLowerCase().split(/[- ]/).map(e=>e.trim());return e.every(e=>i.includes(e))}function gn(e,t,i){let s=i?i.split(",").filter(e=>e.length).map(e=>e.toLowerCase()):[],a=function(e,t,i){let s=[];for(let a=0,r=t.length;a<r;a++){let r=t[a];r.name.split("-")[0].replace(/\d/g,"").trim().toLowerCase()===e&&pn(i,r.name)&&s.push({sequence:r,index:a})}return s}(e,t,s);if(!a.length){s.push(e);let i=t.findIndex(e=>pn(s,e.name));i>=0&&a.push({sequence:t[i],index:i})}a.sort(fn);for(var r=0,n=a.length;r<n;r++){let e=a[r].sequence.rarity;if(0===e)break;if(10*Math.random()>e)return a[r]}let o=a.length-r;return a[r+Math.floor(Math.random()*o)]}function wn(e,t){let i=gn("stand",e.model.sequences,t);i&&e.setSequence(i.index)}function vn(e,t){e.model.whenLoaded().then(i=>{wn(e,t),e.on("seqend",()=>wn(e,t))})}let yn=os.vec3.create(),bn=os.vec3.create();var An={MapViewer:class extends sa{constructor(e,t,i){super(e),this.batchSize=256,this.on("error",(e,t,i)=>console.error(e,t,i)),this.addHandler(ya),this.addHandler(rn),this.wc3PathSolver=t,this.groundShader=this.loadShader("Ground",ln.vsGround,ln.fsGround),this.waterShader=this.loadShader("Water",ln.vsWater,ln.fsWater),this.cliffShader=this.loadShader("Cliffs",ln.vsCliffs,ln.fsCliffs),this.simpleModelShader=this.loadShader("SimpleModel",ln.vsSimpleModel,ln.fsSimpleModel),this.uberSplatShader=this.loadShader("UberSplats",ln.vsUberSplat,ln.fsUberSplat),this.scene=this.addScene(),this.camera=this.scene.camera,this.units=[],this.waterIndex=0,this.waterIncreasePerFrame=0,this.anyReady=!1,this.terrainCliffsAndWaterLoaded=!1,this.terrainData=new Ya,this.cliffTypesData=new Ya,this.waterData=new Ya,this.terrainReady=!1,this.cliffsReady=!1,this.shadowsReady=!1;const s=i.objects();Promise.all([s,...["TerrainArt\\Terrain.slk","TerrainArt\\CliffTypes.slk","TerrainArt\\Water.slk"].map(e=>this.loadGeneric(t(e)[0],"text",void 0,e).whenLoaded())]).then(e=>{let[t,i,s,a]=e;this.terrainObjects=t.objects,this.terrainCliffsAndWaterLoaded=!0,this.terrainData.load(i.data),this.cliffTypesData.load(s.data),this.waterData.load(a.data),this.emit("terrainloaded")}),this.doodadsAndDestructiblesLoaded=!1,this.doodadsData=new Ya,this.doodadMetaData=new Ya,this.destructableMetaData=new Ya,this.doodads=[],this.terrainDoodads=[],this.doodadsReady=!1,this.uberSplats=[],this.uberSplatsReady=!1,s.then(e=>{this.doodadsAndDestructiblesLoaded=!0,this.doodadsData=e.objects,this.emit("doodadsloaded")}),this.unitsAndItemsLoaded=!1,this.unitsData=new Ya,this.unitMetaData=new Ya,this.uberSplatData=new Ya,this.units=[],this.unitsReady=!1,Promise.all([s,this.loadGeneric(t("Splats\\UberSplatData.slk")[0],"text",void 0,"Splats\\UberSplatData.slk").whenLoaded()]).then(e=>{let[t,i]=e;this.unitsAndItemsLoaded=!0,this.unitsData=t.objects,this.uberSplatData.load(i.data),this.emit("unitsloaded")});let a=this.gl,r=a.createTexture();a.bindTexture(a.TEXTURE_2D,r),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texImage2D(a.TEXTURE_2D,0,a.R8,4,4,0,a.RED,a.UNSIGNED_BYTE,new Uint8Array(16)),this.shadowMap=r}renderGround(){if(this.terrainReady){let e=this.gl,t=this.webgl,i=t.extensions.instancedArrays,s=this.groundShader,a=s.uniforms,r=s.attribs,{columns:n,rows:o,centerOffset:l,vertexBuffer:h,faceBuffer:c,heightMap:d,cliffHeightMap:u,instanceBuffer:m,instanceCount:f,textureBuffer:p,variationBuffer:g,heightMapSize:w}=this.terrainRenderData,v=this.tilesetTextures,y=r.a_InstanceID,b=r.a_position,A=r.a_textures,E=r.a_variations;e.disable(e.BLEND),t.useShaderProgram(s),e.uniformMatrix4fv(a.u_mvp,!1,this.camera.worldProjectionMatrix),e.uniform2fv(a.u_offset,l),e.uniform2f(a.u_size,n-1,o-1),e.uniform2fv(a.u_pixel,w),e.uniform1i(a.u_heightMap,0),e.uniform1i(a.u_tilesets,1),e.uniform1i(a.u_shadowMap,2),e.uniform1i(a.u_heightMap0,3),e.uniform1f(a.u_tilesetHeight,1/(v.length+1)),e.uniform1f(a.u_tilesetCount,v.length+1),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,d),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.tilesetsTexture),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,this.shadowMap),e.activeTexture(e.TEXTURE3),e.bindTexture(e.TEXTURE_2D,u),e.bindBuffer(e.ARRAY_BUFFER,h),e.vertexAttribPointer(b,2,e.FLOAT,!1,8,0),e.bindBuffer(e.ARRAY_BUFFER,m),e.vertexAttribPointer(y,1,e.FLOAT,!1,4,0),i.vertexAttribDivisorANGLE(y,1),e.bindBuffer(e.ARRAY_BUFFER,p),e.vertexAttribPointer(A,4,e.UNSIGNED_BYTE,!1,4,0),i.vertexAttribDivisorANGLE(A,1),e.bindBuffer(e.ARRAY_BUFFER,g),e.vertexAttribPointer(E,4,e.UNSIGNED_BYTE,!1,4,0),i.vertexAttribDivisorANGLE(E,1),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,c),i.drawElementsInstancedANGLE(e.TRIANGLES,6,e.UNSIGNED_BYTE,0,f),i.vertexAttribDivisorANGLE(A,0),i.vertexAttribDivisorANGLE(E,0),i.vertexAttribDivisorANGLE(y,0)}}renderWater(){if(this.terrainReady){let e=this.gl,t=this.webgl,i=t.extensions.instancedArrays,s=this.waterShader,a=s.uniforms,r=s.attribs,n=this.mapBounds,{columns:o,rows:l,centerOffset:h,vertexBuffer:c,faceBuffer:d,heightMap:u,instanceBuffer:m,instanceCount:f,waterHeightMap:p,waterBuffer:g,heightMapSize:w}=this.terrainRenderData,v=r.a_InstanceID,y=r.a_position,b=r.a_isWater;e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),t.useShaderProgram(s),e.uniformMatrix4fv(a.u_mvp,!1,this.camera.worldProjectionMatrix),e.uniform2fv(a.u_offset,h),e.uniform2f(a.u_size,o-1,l-1),e.uniform2fv(a.u_pixel,w),e.uniform1i(a.u_heightMap,0),e.uniform1i(a.u_waterHeightMap,1),e.uniform1i(a.u_waterMap,2),e.uniform1f(a.u_offsetHeight,this.waterHeightOffset),e.uniform1f(a.u_tileIndex,0|this.waterIndex),e.uniform4fv(a.u_maxDeepColor,this.maxDeepColor),e.uniform4fv(a.u_minDeepColor,this.minDeepColor),e.uniform4fv(a.u_maxShallowColor,this.maxShallowColor),e.uniform4f(a.u_mapBounds,128*n[0]+h[0],128*n[2]+h[1],128*(o-n[1]-1)+h[0],128*(l-n[3]-1)+h[1]),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,u),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,p),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,this.waterTexture),e.bindBuffer(e.ARRAY_BUFFER,c),e.vertexAttribPointer(y,2,e.FLOAT,!1,8,0),e.bindBuffer(e.ARRAY_BUFFER,m),e.vertexAttribPointer(v,1,e.FLOAT,!1,4,0),i.vertexAttribDivisorANGLE(v,1),e.bindBuffer(e.ARRAY_BUFFER,g),e.vertexAttribPointer(b,1,e.UNSIGNED_BYTE,!1,1,0),i.vertexAttribDivisorANGLE(b,1),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,d),i.drawElementsInstancedANGLE(e.TRIANGLES,6,e.UNSIGNED_BYTE,0,f),i.vertexAttribDivisorANGLE(b,0),i.vertexAttribDivisorANGLE(v,0)}}renderCliffs(){if(this.cliffsReady){let e=this.gl,t=e.extensions.instancedArrays,i=this.webgl,s=this.cliffShader,a=s.attribs,r=s.uniforms,{columns:n,rows:o,centerOffset:l,cliffHeightMap:h,heightMapSize:c}=this.terrainRenderData;e.disable(e.BLEND),i.useShaderProgram(s),e.uniformMatrix4fv(r.u_mvp,!1,this.camera.worldProjectionMatrix),e.uniform1i(r.u_heightMap,0),e.uniform2f(r.u_size,n-1,o-1),e.uniform2fv(r.u_pixel,c),e.uniform2fv(r.u_centerOffset,l),e.uniform1i(r.u_texture1,1),e.uniform1i(r.u_texture2,2),e.uniform1i(r.u_shadowMap,3),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,h),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.cliffTextures[0].webglResource),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),this.cliffTextures.length>1&&(e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,this.cliffTextures[1].webglResource),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR)),e.activeTexture(e.TEXTURE3),e.bindTexture(e.TEXTURE_2D,this.shadowMap),t.vertexAttribDivisorANGLE(a.a_instancePosition,1),t.vertexAttribDivisorANGLE(a.a_instanceTexture,1);for(let d of this.cliffModels)d.render(e,t,a,this.cliffTextures);t.vertexAttribDivisorANGLE(a.a_instancePosition,0),t.vertexAttribDivisorANGLE(a.a_instanceTexture,0)}}renderUberSplats(){if(this.terrainReady&&this.uberSplatsReady){let e=this.gl,t=this.webgl,i=this.uberSplatShader,s=i.attribs,a=i.uniforms,{columns:r,rows:n,centerOffset:o,heightMap:l,heightMapSize:h}=this.terrainRenderData;e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.blendEquation(e.FUNC_ADD),t.useShaderProgram(i),e.uniformMatrix4fv(a.u_mvp,!1,this.camera.worldProjectionMatrix),e.uniform1i(a.u_heightMap,0),e.uniform2f(a.u_size,r-1,n-1),e.uniform2fv(a.u_pixel,h),e.uniform2fv(a.u_centerOffset,o),e.uniform1i(a.u_texture,1),e.uniform1i(a.u_shadowMap,2),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,l),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,this.shadowMap);for(let c of this.uberSplatModels)c.render(e,a,s)}}render(){this.anyReady&&(this.gl.viewport(...this.camera.rect),this.renderGround(),this.renderCliffs(),super.renderOpaque(),this.renderUberSplats(),this.renderWater(),super.renderTranslucent())}update(){this.anyReady&&(this.waterTextures&&(this.waterIndex+=this.waterIncreasePerFrame,this.waterIndex>=this.waterTextures.length&&(this.waterIndex=0)),super.update())}async loadMap(e){this.mapMpq=new wi(e,!0);let t=this.wc3PathSolver,i=new Zt(this.mapMpq.get("war3map.w3i").arrayBuffer());this.w3i=i,this.tileset=i.tileset,this.editorVersion=i.editorVersion,this.mapBounds=i.cameraBoundsComplements,this.mapFlags=i.flags,this.emit("maploaded"),this.mapPathSolver=(e=>t(e,this.tileset));let s=new Vt(this.mapMpq.get("war3map.w3e").arrayBuffer());this.corners=s.corners,this.centerOffset=s.centerOffset,this.mapSize=s.mapSize,this.calculateRamps();const a=this.mapMpq.get("war3map.doo");if(!a)return;let r,n;this.doodads=new Dt(a.arrayBuffer()),this.emit("tilesetloaded"),this.terrainCliffsAndWaterLoaded?this.loadTerrainCliffsAndWater(s):this.once("terrainloaded",()=>this.loadTerrainCliffsAndWater(s)),this.shadows=[],this.shadowTextures={},this.doodadsAndDestructiblesLoaded?(this.loadDoodadsAndDestructibles(),r=Promise.resolve()):r=new Promise((e,t)=>{this.once("doodadsloaded",()=>{this.loadDoodadsAndDestructibles(),e()})}),this.unitsAndItemsLoaded?(this.loadUnitsAndItems(),n=Promise.resolve()):n=new Promise((e,t)=>{this.once("unitsloaded",()=>{this.loadUnitsAndItems(),e()})}),Promise.all([r,n]).then(()=>{this.initShadows()})}loadDoodadsAndDestructibles(){let e=this.scene,t=this.doodads;for(let i of t.doodads){let t=this.doodadsData.find(e=>e.id===i.id);if(!t)continue;let s=t.type,a=(t=t.data).file,r=parseInt(t.numvar||"0");a.endsWith(".mdl")&&(a=a.slice(0,-4));let n=a;a+=".mdx",r>1&&(n+=Math.min(i.variation,r-1)),n+=".mdx";let o=[255,255,255];"destructible"===s&&(o[0]=parseInt(t.colorr),o[1]=parseInt(t.colorg),o[2]=parseInt(t.colorb)),"destructible"===s&&t.shadow&&"_"!==t.shadow&&this.addShadow(t.shadow,i.location[0],i.location[1]);let l,h=this.mapMpq.get(n)||this.mapMpq.get(a);(l=h?this.load(h.name):this.load(n)).whenLoaded().then(()=>{let s=l.addInstance();if(t.texfile){const e=l.replaceables.indexOf(parseInt(t.texid||"0"));if(e>=0){let i=t.texfile;i.lastIndexOf(".")<=Math.max(i.lastIndexOf("/"),i.lastIndexOf("\\"))&&(i+=".blp"),s.setTexture(l.textures[e],this.load(i))}}s.move(i.location),s.rotateLocal(os.quat.setAxisAngle(os.quat.create(),Rs,i.angle)),s.scale(i.scale),s.setScene(e),this.inPlayableArea(i.location[0],i.location[1])||(o[0]=Math.round(51*o[0]/255),o[1]=Math.round(51*o[1]/255),o[2]=Math.round(51*o[2]/255)),s.setVertexColor(o),vn(s)})}this.doodadsReady=!0,this.anyReady=!0}loadUnitsAndItems(e){const t=this.mapMpq.get("war3mapUnits.doo");if(!t)return;let i=new gi(t.arrayBuffer()),s=this.scene,a={};for(let n of i.units){let e,t=n.location,i=n.scale,r=n.player,o="";this.editorVersion<6056&&r>=12&&(r+=12);let l=null,h=[255,255,255];if("sloc"===n.id)e="Objects\\StartLocation\\StartLocation.mdx";else{if(!(l=this.unitsData.find(e=>e.id===n.id)))continue;const s=l.type;(e=(l=l.data).file).endsWith(".mdl")&&(e=e.slice(0,-4)),i=os.vec3.clone(n.scale),os.vec3.scale(i,i,l.modelscale);let c=l.teamcolor&&parseInt(l.teamcolor);l.teamcolor&&c>=0&&(r=c),"unit"===s?(h[0]=parseInt(l.red),h[1]=parseInt(l.green),h[2]=parseInt(l.blue)):"item"===s&&(h[0]=parseInt(l.colorr),h[1]=parseInt(l.colorg),h[2]=parseInt(l.colorb));let d=l.moveheight&&parseFloat(l.moveheight);d&&((t=os.vec3.clone(n.location))[2]+=d),e+=".mdx";let u=l.ubersplat&&this.uberSplatData.getRow(l.ubersplat);if(u){let e="".concat(u.Dir,"\\").concat(u.file,".blp");a[e]||(a[e]={locations:[],opacity:1});let t=n.location[0],i=n.location[1],s=u.Scale;a[e].locations.push(t-s,i-s,t+s,i+s,1)}if(l.unitshadow&&"_"!==l.unitshadow){let e="ReplaceableTextures\\Shadows\\".concat(l.unitshadow,".blp"),t=parseFloat(l.shadowx||"0"),i=parseFloat(l.shadowy||"0"),s=parseFloat(l.shadoww||"0"),r=parseFloat(l.shadowh||"0");a[e]||(a[e]={locations:[],opacity:.5});let o=n.location[0]-t,h=n.location[1]-i;a[e].locations.push(o,h,o+s,h+r,3)}l.buildingshadow&&"_"!==l.buildingshadow&&this.addShadow(l.buildingshadow,n.location[0],n.location[1]),o=l.animprops}if(e){let a=this.load(e).addInstance();a.move(t),a.rotateLocal(os.quat.setAxisAngle(os.quat.create(),Rs,n.angle)),a.scale(i),a.setTeamColor(r),a.setScene(s),this.inPlayableArea(t[0],t[1])||(h[0]=Math.round(51*h[0]/255),h[1]=Math.round(51*h[1]/255),h[2]=Math.round(51*h[2]/255)),a.setVertexColor(h),l&&this.units.push({unit:n,instance:a,location:t,radius:36*parseFloat(l.scale||"0")}),vn(a,o)}else console.log("Unknown unit ID",n.id,n)}this.unitsReady=!0,this.anyReady=!0;let r=Object.entries(a).map(e=>{let t=e[0],{locations:i,opacity:s}=e[1];return this.load(t).whenLoaded().then(e=>{let t=new mn(this.gl,e,i,this.centerOffset);return t.color[3]=s,t})});Promise.all(r).then(e=>{this.uberSplatModels=e,this.uberSplatsReady=!0})}async loadTerrainCliffsAndWater(e){let t=e.tileset;this.tilesets=[],this.tilesetTextures=[];for(let C of e.groundTilesets){let e=this.terrainData.getRow(C);e&&(this.tilesets.push(e),this.tilesetTextures.push(this.load("".concat(e.dir,"\\").concat(e.file,".blp"))))}this.blightTextureIndex=this.tilesetTextures.length,this.tilesetTextures.push(this.load("TerrainArt\\Blight\\".concat({A:"Ashen",B:"Barrens",C:"Felwood",D:"Cave",F:"Lordf",G:"Dungeon",I:"Ice",J:"DRuins",K:"Citadel",L:"Lords",N:"North",O:"Outland",Q:"VillageFall",V:"Village",W:"Lordw",X:"Village",Y:"Village",Z:"Ruins"}[t],"_Blight.blp"))),this.cliffTilesets=[],this.cliffTextures=[];for(let C of e.cliffTilesets){let e=this.cliffTypesData.getRow(C);e&&(this.cliffTilesets.push(e),this.cliffTextures.push(this.load("".concat(e.texDir,"\\").concat(e.texFile,".blp"))))}let i=this.waterData.getRow("".concat(t,"Sha"));this.waterHeightOffset=i.height,this.waterIncreasePerFrame=i.texRate/60,this.waterTextures=[],this.maxDeepColor=new Float32Array([i.Dmax_R,i.Dmax_G,i.Dmax_B,i.Dmax_A]),this.minDeepColor=new Float32Array([i.Dmin_R,i.Dmin_G,i.Dmin_B,i.Dmin_A]),this.maxShallowColor=new Float32Array([i.Smax_R,i.Smax_G,i.Smax_B,i.Smax_A]),this.minShallowColor=new Float32Array([i.Smin_R,i.Smin_G,i.Smin_B,i.Smin_A]);for(let C=0,B=i.numTex;C<B;C++)this.waterTextures.push(this.load("".concat(i.texFile).concat(C<10?"0":"").concat(C,".blp")));await this.whenLoaded([...this.tilesetTextures,...this.waterTextures]);let s=this.gl;this.createTilesetsAndWaterTextures();let a=e.corners,[r,n]=this.mapSize,o=this.centerOffset,l=(r-1)*(n-1),h=new Float32Array(r*n),c=new Float32Array(r*n),d=new Float32Array(r*n),u=new Uint8Array(4*l),m=new Uint8Array(4*l),f=new Uint8Array(l),p=0,g={};this.columns=r-1,this.rows=n-1;let w={};for(let C of this.doodads.terrainDoodads){let e=this.terrainObjects.find(e=>e.id===C.id);e&&(w[(e=e.data).pathtex]||(w[e.pathtex]=this.load(e.pathtex)))}await this.whenLoaded(Object.values(w));for(let C of this.doodads.terrainDoodads){let e=this.terrainObjects.find(e=>e.id===C.id);if(!e)continue;let t=w[(e=e.data).pathtex];if(!t||!t.imageData)continue;let i=e.file+".mdx";g[i]||(g[i]={locations:[]});let[s,r]=C.location,n=t.originalData.width>>2,l=t.originalData.height>>2;for(let o=0;o<l;++o)for(let e=0;e<n;++e)a[r+o][s+e].rampType=-1;g[i].locations.push(128*(s+n/2)+o[0],128*(r+l/2)+o[1],128*(a[r][s].layerHeight-2))}for(let C=0;C<n;C++)for(let e=0;e<r;e++){let t=a[C][e],i=C*r+e;if(h[i]=t.groundHeight,c[i]=t.groundHeight+t.layerHeight+(t.rampAdjust||0)-2,d[i]=t.waterHeight,t.depth=t.water?this.waterHeightOffset+t.waterHeight-c[i]:0,C<n-1&&e<r-1){if(f[p]=this.isWater(e,C),t.rampType){if(t.rampType>0){let i=t.cliffTexture;15===i&&(i=1);let s=this.cliffTilesets[i].rampModelDir,r="Doodads\\Terrain\\".concat(s,"\\").concat(s).concat(t.rampName,"0.mdx"),n=t.layerHeight;n=1===t.cliffType?Math.min(n,a[C+2][e].layerHeight,a[C][e+1].layerHeight,a[C+2][e+1].layerHeight):Math.min(n,a[C+1][e].layerHeight,a[C][e+2].layerHeight,a[C+1][e+2].layerHeight),g[r]||(g[r]={locations:[],textures:[]}),g[r].locations.push(128*e+o[0],128*C+o[1],128*(n-2)),g[r].textures.push(i)}}else if(this.isCliff(e,C)){let i=t.layerHeight,s=a[C][e+1].layerHeight,r=a[C+1][e].layerHeight,n=a[C+1][e+1].layerHeight,l=Math.min(i,s,r,n),h=this.cliffFileName(i,s,r,n,l);if("AAAA"!==h){let i=t.cliffTexture;15===i&&(i=1);let s=this.cliffTilesets[i].cliffModelDir,a="Doodads\\Terrain\\".concat(s,"\\").concat(s).concat(h).concat(dn(s,h,t.cliffVariation),".mdx");g[a]||(g[a]={locations:[],textures:[]}),g[a].locations.push(128*e+o[0],128*C+o[1],128*(l-2)),g[a].textures.push(i)}}else{let i=this.cornerTexture(e,C),s=this.cornerTexture(e+1,C),a=this.cornerTexture(e,C+1),r=this.cornerTexture(e+1,C+1),n=Fa([i,s,a,r]).sort();u[4*p]=n[0]+1,m[4*p]=this.getVariation(n[0],t.groundVariation),n.shift();for(let e=0,t=n.length;e<t;e++){let t=n[e],o=0;s===t&&(o|=1),i===t&&(o|=2),r===t&&(o|=4),a===t&&(o|=8),u[4*p+1+e]=t+1,m[4*p+1+e]=o}}p+=1}}let v=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,v),s.bufferData(s.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,1,1]),s.STATIC_DRAW);let y=s.createBuffer();s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,y),s.bufferData(s.ELEMENT_ARRAY_BUFFER,new Uint8Array([0,1,2,1,3,2]),s.STATIC_DRAW);let b=s.createTexture();s.bindTexture(s.TEXTURE_2D,b),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texImage2D(s.TEXTURE_2D,0,s.R32F,r,n,0,s.RED,s.FLOAT,h);let A=s.createTexture();s.bindTexture(s.TEXTURE_2D,A),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texImage2D(s.TEXTURE_2D,0,s.R32F,r,n,0,s.RED,s.FLOAT,c);let E=s.createTexture();s.bindTexture(s.TEXTURE_2D,E),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texImage2D(s.TEXTURE_2D,0,s.R32F,r,n,0,s.RED,s.FLOAT,d);let x=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,x),s.bufferData(s.ARRAY_BUFFER,new Float32Array(l).map((e,t,i)=>t),s.STATIC_DRAW);let T=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,T),s.bufferData(s.ARRAY_BUFFER,u,s.STATIC_DRAW);let S=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,S),s.bufferData(s.ARRAY_BUFFER,m,s.STATIC_DRAW);let _=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,_),s.bufferData(s.ARRAY_BUFFER,f,s.STATIC_DRAW);let I=new Float32Array([1/r,1/n]);this.terrainRenderData={rows:n,columns:r,centerOffset:o,vertexBuffer:v,faceBuffer:y,heightMap:A,instanceBuffer:x,instanceCount:l,cornerTextures:u,textureBuffer:T,variationBuffer:S,heightMapSize:I,cliffHeightMap:b,waterHeightMap:E,waterBuffer:_},this.terrainReady=!0,this.anyReady=!0,this.createWaves();let R=Object.entries(g).map(e=>{let t=e[0],{locations:i,textures:a}=e[1];return this.loadGeneric(this.mapPathSolver(t)[0],"arrayBuffer",void 0,t).whenLoaded().then(e=>new un(s,e.data,i,a,this))});this.cliffModels=await Promise.all(R),this.cliffModels.sort((e,t)=>!e.textures>!t.textures),this.cliffsReady=!0}calculateRamps(){let e=this.corners,[t,i]=this.mapSize,s=["AAHL","AALH","ABHL","AHLA","ALHA","ALHB","BALH","BHLA","HAAL","HBAL","HLAA","HLAB","LAAH","LABH","LHAA","LHBA"];for(let a=1;a<i-1;++a)for(let i=1;i<t-1;++i){let t=e[a][i];if(!t.ramp)continue;let s=e[a-1][i-1],r=e[a][i-1],n=e[a+1][i-1],o=e[a+1][i],l=e[a+1][i+1],h=e[a][i+1],c=e[a-1][i+1],d=e[a-1][i],u=t.layerHeight;if(r.ramp&&h.ramp||o.ramp&&d.ramp){let e=0;r.ramp&&h.ramp&&(e=Math.max(e,(r.layerHeight+h.layerHeight)/2-u)),o.ramp&&d.ramp&&(e=Math.max(e,(o.layerHeight+d.layerHeight)/2-u)),s.ramp&&l.ramp&&(e=Math.max(e,((s.layerHeight+l.layerHeight)/2-u)/2)),n.ramp&&c.ramp&&(e=Math.max(e,((n.layerHeight+c.layerHeight)/2-u)/2)),t.rampAdjust=e}}for(let a=0;a<i-1;++a)for(let r=0;r<t-1;++r){let n=e[a][r],o=e[a+1][r],l=e[a][r+1],h=e[a+1][r+1];if(!n.rampType&&a<i-2){let t=e[a+2][r],i=e[a+2][r+1],c=Math.min(n.layerHeight,t.layerHeight),d=Math.min(l.layerHeight,i.layerHeight);if(o.layerHeight===c&&h.layerHeight===d){let e=Math.min(c,d);if(n.ramp===o.ramp&&n.ramp===t.ramp&&l.ramp===h.ramp&&l.ramp===i.ramp&&n.ramp!==l.ramp){let a=this.rampFileName(t,i,l,n,e);s.includes(a)&&(n.rampName=a,n.rampType=1,o.rampType=-1)}}}if(!n.rampType&&r<t-2){let t=e[a][r+2],i=e[a+1][r+2],c=Math.min(n.layerHeight,t.layerHeight),d=Math.min(o.layerHeight,i.layerHeight);if(l.layerHeight===c&&h.layerHeight===d){let e=Math.min(c,d);if(n.ramp===l.ramp&&n.ramp===t.ramp&&o.ramp===h.ramp&&o.ramp===i.ramp&&n.ramp!==o.ramp){let a=this.rampFileName(o,i,t,n,e);s.includes(a)&&(n.rampName=a,n.rampType=2,l.rampType=-1)}}}}for(let a=0;a<i-1;++a)for(let i=0;i<t-1;++i){let t=e[a][i],s=e[a+1][i],r=e[a][i+1],n=e[a+1][i+1];if(t.rampAdjust||s.rampAdjust||r.rampAdjust||n.rampAdjust)continue;let o=t.layerHeight;s.layerHeight===o&&r.layerHeight===o&&n.layerHeight===o||(t.cliff=!0)}for(let a=0;a<i-1;++a)for(let s=0;s<t-1;++s){let r,n=e[a][s];if(n.rampType&&n.rampType>0){let o=s+1,l=a+1;1===n.rampType?(r=e[a+1][s],l=a+2):(r=e[a][s+1],o=s+2);let h=Math.max(0,s-1),c=Math.max(0,a-1);o=Math.min(o,t-1),l=Math.min(l,i-1);let d=null;for(let t=c;t<=l&&null==d;++t)for(let i=h;i<=o;++i){let s=e[t][i];if(s.cliff&&!s.rampType){d=s.cliffTexture;break}}null!=d&&(n.cliffTexture=r.cliffTexture=d)}}}cliffFileName(e,t,i,s,a){return String.fromCharCode(65+i-a)+String.fromCharCode(65+s-a)+String.fromCharCode(65+t-a)+String.fromCharCode(65+e-a)}rampFileName(e,t,i,s,a){let r=e.layerHeight-a,n=t.layerHeight-a,o=i.layerHeight-a,l=s.layerHeight-a;return r>2||n>2||o>2||l>2?"":(e.ramp?"LHX":"ABC")[r]+(t.ramp?"LHX":"ABC")[n]+(i.ramp?"LHX":"ABC")[o]+(s.ramp?"LHX":"ABC")[l]}createTilesetsAndWaterTextures(){let e=this.tilesetTextures,t=e.length,i=document.createElement("canvas"),s=i.getContext("2d");i.width=2048,i.height=64*(t+1);for(let l=0;l<t;l++){let t=e[l].imageData;if(t){for(let e=0;e<16;e++){let i=e%4*64,a=64*(e/4|0);s.putImageData(t,64*e-i,64*(l+1)-a,i,a,64,64)}if(512===t.width)for(let e=0;e<16;e++){let i=256+e%4*64,a=64*(e/4|0);s.putImageData(t,1024+64*e-i,64*(l+1)-a,i,a,64,64)}}}let a=this.gl,r=a.createTexture();a.bindTexture(a.TEXTURE_2D,r),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,i),this.tilesetsTexture=r,i.height=384;let n=this.waterTextures;for(let l=0,h=n.length;l<h;l++){let e=l%16,t=l/16|0;s.putImageData(n[l].imageData,128*e,128*t)}let o=a.createTexture();a.bindTexture(a.TEXTURE_2D,o),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,i),this.waterTexture=o}getVariation(e,t){let i=this.tilesetTextures[e];return i.width>i.height?t<16?16+t:16===t?15:0:0===t?0:15}isCliff(e,t){return!!this.corners[t][e].cliff}isWater(e,t){let i=this.corners;return i[t][e].water||i[t][e+1].water||i[t+1][e].water||i[t+1][e+1].water}cliffGroundIndex(e){let t=this.cliffTilesets[e].groundTile,i=this.tilesets;for(let s=0,a=i.length;s<a;s++)if(i[s].tileID===t)return s}cornerTexture(e,t){let i=this.corners,s=this.columns,a=this.rows;for(let n=-1;n<1;n++)for(let r=-1;r<1;r++)if(e+r>0&&e+r<s-1&&t+n>0&&t+n<a-1){let s=i[t+n][e+r];if(this.isCliff(e+r,t+n)||s.rampType){let e=s.cliffTexture;return 15===e&&(e=1),this.cliffGroundIndex(e)}}let r=i[t][e];return r.blight?this.blightTextureIndex:r.groundTexture}load(e){return super.load(e,this.mapPathSolver)}applyModificationFile(e,t,i){i&&(this.applyModificationTable(e,t,i.originalTable),this.applyModificationTable(e,t,i.customTable))}applyModificationTable(e,t,i){for(let s of i.objects){let i=e.getRow(s.oldId),a=s.newId;""===s.newId||e.getRow(a)||e.setRow(s.newId,i={...i});for(let e of s.modifications){let s=t.getRow(e.id);s?i[s.field]=e.value:console.warn("Unknown modification ID",e.id)}}}groundNormal(e,t,i){let s=this.centerOffset,a=this.mapSize,r=0|(t=(t-s[0])/128),n=0|(i=(i-s[1])/128);if(r>=0&&r<a[0]-1&&n>=0&&n<a[1]-1){let s=this.corners,a=s[n][r].groundHeight,o=s[n][r+1].groundHeight,l=s[n+1][r].groundHeight,h=s[n+1][r+1].groundHeight;t-r+(i-n)<1?(os.vec3.set(yn,1,0,o-a),os.vec3.set(bn,0,1,l-a)):(os.vec3.set(yn,-1,0,h-l),os.vec3.set(bn,0,1,h-o)),os.vec3.normalize(e,os.vec3.cross(e,yn,bn))}else os.vec3.set(e,0,0,1);return e}heightAt(e,t){let i=this.centerOffset,s=this.mapSize,a=0|(e=(e-i[0])/128),r=0|(t=(t-i[1])/128);if(a>=0&&a<s[0]-1&&r>=0&&r<s[1]-1){let i=this.corners;const s=e=>e.groundHeight+e.layerHeight-2;let n,o=s(i[r][a]),l=s(i[r][a+1]),h=s(i[r+1][a]),c=s(i[r+1][a+1]),d=e-a,u=t-r;return 128*(n=d+u<1?o+(l-o)*d+(h-o)*u:c+(l-c)*(1-u)+(h-c)*(1-d))}return 0}inPlayableArea(e,t){return e=(e-this.centerOffset[0])/128,t=(t-this.centerOffset[1])/128,!(e<this.mapBounds[0])&&!(e>=this.mapSize[0]-this.mapBounds[1]-1)&&!(t<this.mapBounds[2])&&!(t>=this.mapSize[1]-this.mapBounds[3]-1)&&!this.corners[Math.floor(t)][Math.floor(e)].boundary}addShadow(e,t,i){if(!this.shadows[e]){let t="ReplaceableTextures\\Shadows\\".concat(e,".blp");this.shadows[e]=[],this.shadowTextures[e]=this.load(t)}this.shadows[e].push({x:t,y:i})}async initShadows(){await this.whenLoaded(Object.values(this.shadowTextures));let e=this.gl,t=this.centerOffset,[i,s]=this.mapSize;const a=(i=4*(i-1))*(s=4*(s-1)),r=new Uint8Array(i*s),n=this.mapMpq.get("war3map.shd");if(n){let e=n.arrayBuffer();if(e.byteLength>=a){e=new Uint8Array(e);for(let t=0;t<a;++t)r[t]=e[t]/2}}for(let[u,m]of Object.entries(this.shadowTextures)){if(!m.originalData)continue;let{data:e,width:a,height:n}=m.originalData,o=Math.round(.3*a),l=Math.round(.7*n);for(let h of this.shadows[u]){let c=Math.floor((h.x-t[0])/32)-o,d=Math.floor((h.y-t[1])/32)+l;for(let t=0;t<n;++t)if(!(d-t<0||d-t>=s))for(let s=0;s<a;++s)c+s<0||c+s>=i||e[4*(t*a+s)+3]&&(r[(d-t)*i+c+s]=128)}}let o=4*this.mapBounds[0],l=4*(this.mapSize[0]-this.mapBounds[1]-1),h=4*this.mapBounds[2],c=4*(this.mapSize[1]-this.mapBounds[3]-1);for(let u=h;u<c;++u)for(let e=o;e<l;++e)this.corners[u>>2][e>>2].boundary&&(r[u*i+e]=204);for(let u=0;u<s;++u){for(let e=0;e<o;++e)r[u*i+e]=204;for(let e=l;e<i;++e)r[u*i+e]=204}for(let u=o;u<l;++u){for(let e=0;e<h;++e)r[e*i+u]=204;for(let e=c;e<s;++e)r[e*i+u]=204}let d=e.createTexture();e.bindTexture(e.TEXTURE_2D,d),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.R8,i,s,0,e.RED,e.UNSIGNED_BYTE,r),this.shadowMap=d,this.shadowsReady=!0}createWaves(){let[e,t]=this.mapSize,i=this.corners,s=this.centerOffset,a=this.waterData.getRow("".concat(this.tileset,"Sha")),r=2048&this.mapFlags,n=4096&this.mapFlags,o="".concat(a.shoreDir,"\\").concat(a.shoreSFile,"\\").concat(a.shoreSFile,"0.mdx"),l="".concat(a.shoreDir,"\\").concat(a.shoreOCFile,"\\").concat(a.shoreOCFile,"0.mdx"),h="".concat(a.shoreDir,"\\").concat(a.shoreICFile,"\\").concat(a.shoreICFile,"0.mdx"),c=(e,t,i)=>e?-3*Math.PI/4:t?-Math.PI/4:i?Math.PI/4:3*Math.PI/4,d=(e,t,i,s)=>e&&t?-Math.PI/2:t&&i?0:i&&s?Math.PI/2:e&&s?Math.PI:null,u=new Float32Array(3),m={},f=(e,t)=>{m[e]||(m[e]=this.load(e));let i=m[e].addInstance();i.move(u),i.rotateLocal(os.quat.setAxisAngle(os.quat.create(),Rs,t)),i.setScene(this.scene),this.inPlayableArea(u[0],u[1])||i.setVertexColor([51,51,51]),vn(i)};for(let p=0;p<t-1;++p)for(let t=0;t<e-1;++t){let e=i[p][t],a=i[p][t+1],m=i[p+1][t+1],g=i[p+1][t];if(e.water||a.water||m.water||m.water){let i=e.layerHeight!==a.layerHeight||e.layerHeight!==m.layerHeight||e.layerHeight!==g.layerHeight;if(i&&!r)continue;if(!i&&!n)continue;let w=e.depth>25/128?1:0,v=a.depth>25/128?1:0,y=m.depth>25/128?1:0,b=g.depth>25/128?1:0,A=w+v+y+b;if(u[0]=128*t+s[0]+64,u[1]=128*p+s[1]+64,u[2]=128*((e.waterHeight+a.waterHeight+m.waterHeight+g.waterHeight)/4+this.waterHeightOffset)+1,1===A)f(h,c(w,v,y));else if(2===A){let e=d(w,v,y,b);null!=e&&f(o,e)}else 3===A&&f(l,c(!w,!v,!y)+Math.PI)}}}deselect(){this.selModels&&this.selModels.length&&(this.selModels.forEach(e=>{let t=this.uberSplatModels.indexOf(e);t>=0&&this.uberSplatModels.splice(t,1)}),this.selModels=[]),this.selected=[]}doSelectUnits(e){if(this.deselect(),!e.length)return;let t={};this.selected=e.filter(e=>{let{unit:i}=e,s=this.unitsData.find(e=>e.id===i.id);if(!s)return!1;s=s.data;let a=parseFloat(s.scale||"0");if(!a)return!1;let r,n=36*a;n<100&&(r="ReplaceableTextures\\Selection\\SelectionCircleSmall.blp"),t[r=n<300?"ReplaceableTextures\\Selection\\SelectionCircleMed.blp":"ReplaceableTextures\\Selection\\SelectionCircleLarge.blp"]||(t[r]=[]);let[o,l]=i.location,h=parseFloat(s.selZ||"0");return t[r].push(o-n,l-n,o+n,l+n,h+5),!0});let i=this.selModels=[];Object.entries(t).forEach(e=>{let[t,s]=e;this.load(t).whenLoaded().then(e=>{if(this.selModels!==i)return;let t=new mn(this.gl,e,s,this.centerOffset);t.color=[0,1,0,1],this.selModels.push(t),this.uberSplatModels.push(t)})})}selectUnit(e,t,i){let s=new Float32Array(6);this.camera.screenToWorldRay(s,[e,t]);let a=yn;a[0]=s[3]-s[0],a[1]=s[4]-s[1],a[2]=s[5]-s[2],os.vec3.normalize(a,a);let r=os.vec3.create(),n=os.vec3.create(),o=os.vec3.create(),l=null,h=1e6;this.units.forEach(e=>{let{instance:t,location:i,radius:c}=e;os.vec3.set(r,0,0,c/2),os.vec3.set(n,c,c,c),os.vec3.add(r,r,i),os.vec3.sub(r,r,s),os.vec3.div(r,r,n),os.vec3.div(o,a,n);let d=os.vec3.sqrLen(o),u=Math.max(0,os.vec3.dot(o,r))/d;u>h||(os.vec3.scale(o,o,u),os.vec3.sqrDist(o,r)<1&&(l=e,h=u))});let c=[];if(l)if(i){const e=(c=this.selected.slice()).indexOf(l);e>=0?c.splice(e,1):c.push(l)}else c=[l];return this.doSelectUnits(c),c}selectUnits(e,t,i,s){let a=new Float32Array(2),r=this.units.filter(r=>{let{location:n,radius:o,unit:l}=r,h=this.unitsData.find(e=>e.id===l.id);if(!h)return!1;h=h.data;let[c,d]=l.location,u=parseFloat(h.selZ||"0")+this.heightAt(c,d);return this.camera.worldToScreen(a,[c,d,u]),a[0]>=e&&a[0]<i&&a[1]>=t&&a[1]<s});return this.doSelectUnits(r),r}}},En={version:"4.5.8",parsers:ns,viewer:{glMatrix:os,ModelViewer:sa,Scene:Zs,Camera:Vs,handlers:{geo:ba,mdx:nn,imagetexture:on,w3x:An}}};const xn=os.vec3.create(),Tn=os.vec3.create(),Sn=os.vec3.create(),_n=os.vec3.create(),In=os.mat4.create(),Rn=new Float32Array(1),Cn=["Red","Blue","Teal","Purple","Yellow","Orange","Green","Pink","Gray","Light Blue","Dark Green","Brown","Maroon","Navy","Turquoise","Violet","Wheat","Peach","Mint","Lavender","Coal","Snow","Emerald","Peanut","Black"];class Bn extends a.a.PureComponent{constructor(){super(...arguments),this.state={objects:[],errors:[],current:0,teamColor:0},this.yaw=-Math.PI/2,this.pitch=-Math.PI/4,this.distance=400,this.center=os.vec3.create(),this.minDistance=8,this.maxDistance=3e3,this.onMouseDown=(e=>{document.addEventListener("mousemove",this.onMouseMove,!0),document.addEventListener("mouseup",this.onMouseUp,!0),this.dragPos={x:e.clientX,y:e.clientY},e.preventDefault()}),this.onMouseMove=(e=>{if(this.dragPos&&this.canvas){const t=e.clientX-this.dragPos.x,i=e.clientY-this.dragPos.y,s=(this.canvas.width+this.canvas.height)/2;for(this.yaw+=2*t*Math.PI/s,this.pitch+=2*i*Math.PI/s;this.yaw>Math.PI;)this.yaw-=2*Math.PI;for(;this.yaw<-Math.PI;)this.yaw+=2*Math.PI;this.pitch=Math.min(this.pitch,0),this.pitch=Math.max(this.pitch,-Math.PI),this.dragPos={x:e.clientX,y:e.clientY},this.setCamera({target:{value:-1}})}e.preventDefault()}),this.onMouseUp=(e=>{delete this.dragPos,this.removeEvents(),e.preventDefault()}),this.onMouseWheel=(e=>{e.deltaY>0?this.distance=Math.min(1.2*this.distance,this.maxDistance):this.distance=Math.max(this.distance/1.2,this.minDistance),this.setCamera({target:{value:-1}})}),this.setObject=(e=>{let t=parseInt(e.target.value,10);isNaN(t)&&(t=0),this.setState(e=>{if(t!==e.current&&e.objects[t])return this.scene.removeInstance(e.objects[e.current].instance),this.scene.addInstance(e.objects[t].instance),{current:t}})}),this.setSequence=(e=>{let t=parseInt(e.target.value,10);isNaN(t)&&(t=-1),this.setState(e=>{const i=e.objects[e.current];if(i&&i.sequence!==t){i.instance.setSequence(t);const s=e.objects.slice();return s[e.current]={...i,sequence:t},{objects:s}}})}),this.setCamera=(e=>{let t=parseInt(e.target.value,10);isNaN(t)&&(t=-1),this.setState(e=>{const i=e.objects[e.current];if(i&&i.camera!==t){const s=e.objects.slice();return s[e.current]={...i,camera:t},{objects:s}}})}),this.setTeamColor=(e=>{let t=parseInt(e.target.value,10);isNaN(t)&&(t=0),this.setState({teamColor:t},()=>{this.state.objects.forEach(e=>e.instance.setTeamColor(t))})}),this.animate=(e=>{this.frame=requestAnimationFrame(this.animate),this.scene.camera.viewport([0,0,this.canvas.width,this.canvas.height]);const t=this.state.objects[this.state.current],i=t&&t.model.cameras[t.camera];if(i){i.getPositionTranslation(xn,t.instance),i.getTargetTranslation(Tn,t.instance),i.getRotation(Rn,t.instance),os.vec3.sub(_n,Tn,xn),os.vec3.normalize(_n,_n),os.mat4.fromRotation(In,Rn[0],_n),os.vec3.set(Sn,0,0,1),os.vec3.transformMat4(Sn,Sn,In);const e=this.canvas.width/this.canvas.height,s=2*Math.atan(Math.tan(i.fieldOfView/2)/e);this.scene.camera.perspective(s,e,i.nearClippingPlane,i.farClippingPlane),this.scene.camera.moveToAndFace(xn,Tn,Sn)}else this.scene.camera.perspective(Math.PI/4,this.canvas.width/this.canvas.height,this.minDistance,this.maxDistance),this.freeCamera();this.viewer.updateAndRender()})}freeCamera(){this.scene&&this.scene.camera.setRotationAroundAngles(this.yaw,this.pitch,this.center,this.distance)}componentWillUnmount(){this.frame&&(cancelAnimationFrame(this.frame),delete this.frame),this.removeEvents()}removeEvents(){document.removeEventListener("mousemove",this.onMouseMove,!0),document.removeEventListener("mouseup",this.onMouseUp,!0)}modelLoaded(e,t){e.ok&&this.setState(i=>{const s=e.addInstance();(t=Math.min(t,i.objects.length))===i.current&&(i.objects[t]&&this.scene.removeInstance(i.objects[t].instance),this.scene.addInstance(s),e.bounds&&e.bounds.radius>.05&&(this.minDistance=Math.min(500,.2*e.bounds.radius),this.maxDistance=1e3*this.minDistance,this.distance=10*this.minDistance)),s.setTeamColor(i.teamColor),e.sequences.length>0&&s.setSequence(0),s.setSequenceLoopMode(2);const a=[...i.objects];return a.splice(t,0,{model:e,instance:s,sequence:e.sequences.length?0:-1,camera:e.cameras.length?0:-1}),{objects:a}})}componentDidMount(){if(!this.canvas)return;const e=this.canvas;this.viewer=new En.viewer.ModelViewer(e),this.viewer.gl.clearColor(.3,.3,.3,1),this.viewer.on("error",(e,t,i)=>{if("FailedToFetch"===t){if(e.isPortrait)return;this.setState(t=>{let{errors:i}=t;return{errors:[...i,"Failed to load ".concat(e.path)]}})}}),this.scene=this.viewer.addScene(),this.viewer.addHandler(En.viewer.handlers.mdx);const t=this.context,i=this.props.path?U(this.props.path):this.props.id,s=e=>{const i="string"===typeof e?e.substr(e.lastIndexOf(".")).toLowerCase():".mdx";if([".blp",".dds",".gif",".jpg",".jpeg",".png",".tga"].indexOf(i)>=0)return[t.image(e),".png",!0];{const s=t.binary(e);return s?[s.data.buffer,i,!1]:[t.cache.binary(e),i,!0]}};if(this.viewer.load(i,s).whenLoaded().then(e=>this.modelLoaded(e,0)),this.props.path){const e=this.props.path.replace(/\.mdx$/i,"_portrait.mdx"),t=this.viewer.load(e,s);t.isPortrait=!0,t.whenLoaded().then(e=>this.modelLoaded(e,1))}this.frame=requestAnimationFrame(this.animate)}render(){const{errors:e,objects:t,current:i,teamColor:s}=this.state,r=t[i];return a.a.createElement("div",{className:"FileModel"},a.a.createElement(Ne.a,null,e=>{let{width:t,height:i}=e;return a.a.createElement("canvas",{onMouseDown:this.onMouseDown,onWheel:this.onMouseWheel,ref:e=>this.canvas=e,width:Math.max(t,100),height:Math.max(i,100)})}),a.a.createElement("ul",{className:"log"},e.map((e,t)=>a.a.createElement("li",{key:t,className:"error"},e))),a.a.createElement("div",{className:"credits"},"Model viewer by ",a.a.createElement("a",{href:"https://github.com/flowtsohg/mdx-m3-viewer",target:"_blank"},"flowtsohg@github")),t.length>0&&a.a.createElement("div",{className:"controls"},t.length>1&&a.a.createElement("label",null,"Model:",a.a.createElement("select",{value:i,onChange:this.setObject},t.map((e,t)=>a.a.createElement("option",{key:t,value:t},e.model.name)))),null!=r&&a.a.createElement("label",null,"Animation:",a.a.createElement("select",{value:r.sequence,onChange:this.setSequence},a.a.createElement("option",{value:-1},"None"),r.model.sequences.map((e,t)=>a.a.createElement("option",{key:t,value:t},e.name)))),null!=r&&r.model.cameras.length>0&&a.a.createElement("label",null,"Camera:",a.a.createElement("select",{value:r.camera,onChange:this.setCamera},a.a.createElement("option",{value:-1},"Free"),r.model.cameras.map((e,t)=>a.a.createElement("option",{key:t,value:t},e.name)))),a.a.createElement("label",null,"Team Color:",a.a.createElement("select",{value:s,onChange:this.setTeamColor},Cn.map((e,t)=>a.a.createElement("option",{key:t,value:t},e))))))}}Bn.contextType=le.DataContext;class Fn extends a.a.Component{constructor(){super(...arguments),this.state={show:!1},this.show=(e=>{this.setState({show:!0}),e.preventDefault()}),this.setPopup=(e=>{this.popup=e,e?document.addEventListener("keydown",this.onKeyDown,!0):document.removeEventListener("keydown",this.onKeyDown,!0)}),this.onKeyDown=(e=>{switch(e.which){case E.a.codes.esc:this.setState({show:!1})}}),this.onMouseDown=(e=>{e.target===this.popup&&this.setState({show:!1})})}componentWillUnmount(){document.removeEventListener("keydown",this.onKeyDown,!0)}render(){let e=this.props.path;const t=this.context;if(""===e||"_"===e||"-"===e)return e;const i=e.match(/^(.*)(\.\w+)$/);i?".mdx"!==i[2]&&(e=i[1]+".mdx"):e+=".mdx";const s=P(U(e));return a.a.createElement(a.a.Fragment,null,this.state.show&&n.a.createPortal(a.a.createElement("div",{className:"ObjectModel",onMouseDown:this.onMouseDown,ref:this.setPopup},a.a.createElement("div",null,a.a.createElement(Bn,{path:e}))),document.body),a.a.createElement("a",{href:"/".concat(t.id,"/files/").concat(s),onClick:this.show},e))}}Fn.contextType=le.DataContext;const Ln=e=>{let{object:t}=e;return a.a.createElement(Ae.Consumer,null,e=>a.a.createElement(Qe,{id:t.id},a.a.createElement(l.Link,{to:"/".concat(e,"/").concat(t.type,"/").concat(t.id)},a.a.createElement(Se,{object:t}),t.name)))},Dn=e=>{let{object:t}=e;return a.a.createElement(Ae.Consumer,null,e=>a.a.createElement(Qe,{id:t.id},a.a.createElement(l.Link,{to:"/".concat(e,"/").concat(t.type,"/").concat(t.id)},t.id)))};class Mn extends a.a.PureComponent{constructor(){super(...arguments),this.state={popup:null},this.onMouseOver=(e=>{const t=e.target.getBoundingClientRect(),i=Math.max(document.documentElement.clientHeight,window.innerHeight||0);t.top+t.bottom>i?this.setState({popup:"top"}):this.setState({popup:"bottom"})}),this.onMouseOut=(()=>{this.setState({popup:null})})}render(){const{children:e,tooltip:t}=this.props,{popup:i}=this.state;return i?a.a.createElement("td",{className:b()("popupStringCell",i),onMouseEnter:this.onMouseOver,onMouseLeave:this.onMouseOut},t,e):a.a.createElement("td",{onMouseEnter:this.onMouseOver,onMouseLeave:this.onMouseOut},e)}}class Un extends a.a.PureComponent{constructor(){super(...arguments),this.state={popup:!1},this.onMouseOver=(e=>{if(e.target.scrollWidth>=e.target.offsetWidth){if(e.target.closest(".ObjectModel"))return;this.setState({popup:!0})}}),this.onMouseOut=(()=>{this.setState({popup:!1})})}render(){const{children:e}=this.props,{popup:t}=this.state;return t?a.a.createElement("td",{className:"popupCell",onMouseEnter:this.onMouseOver,onMouseLeave:this.onMouseOut},a.a.createElement("div",null,e),"#"):a.a.createElement("td",{onMouseEnter:this.onMouseOver,onMouseLeave:this.onMouseOut},e)}}const Pn=e=>{let{value:t,data:i}=e;const s=Ze(t,i);return a.a.createElement("div",null,s)};class kn extends a.a.Component{constructor(){super(...arguments),this.state={visible:!1},this.onLoad=(()=>this.setState({visible:!0}))}render(){const{path:e,cache:t,className:i,...s}=this.props,r=t.image(e);return null==r?null:a.a.createElement(Ye.a,Object.assign({id:"icon-preview"},s,{className:b()(i,{loading:!this.state.visible})}),a.a.createElement("img",{src:r,onLoad:this.onLoad,alt:"icon"}))}}const Nn=e=>{let{path:t}=e;return a.a.createElement(le.DataContext.Consumer,null,e=>{const i=e.iconByName(t);return a.a.createElement(_.a,{placement:"top",overlay:a.a.createElement(kn,{path:t,cache:e})},a.a.createElement("span",null,null!=i&&a.a.createElement("span",{className:"Icon",style:i}),t))})},On=e=>{let{value:t,meta:i,data:s}=e;i.type.indexOf("Flags");let r=i.type;if("lightningList"===r&&(r="lightningEffect"),s.types[r])return t&&"_"!==t?s.types[r][t]||"value":"None";switch(r){case"bool":return parseInt(t,10)?"True":"False";case"string":return"_"===t?"":t;case"char":return t;case"int":return parseInt(t,10)||0;case"real":case"unreal":return(parseFloat(t)||0).toFixed(i.stringExt||2);case"destructableCategory":return Ce[t]||t;case"tilesetList":return Re[t]||t;case"doodadCategory":return Be[t]||t;case"techList":if(Fe[t])return Fe[t];case"buffCode":case"buffList":case"effectCode":case"effectList":case"unitCode":case"unitList":case"abilCode":case"abilityList":case"heroAbilityList":case"itemCode":case"itemList":case"upgradeCode":case"upgradeList":if("_"===t)return"";const e=s.objects.find(e=>e.id===t);return e?a.a.createElement(Ln,{object:e}):t;case"icon":return a.a.createElement(Nn,{path:t});case"model":return a.a.createElement(Fn,{path:t});default:return"_"!==t&&t||"None"}},jn=e=>{let{value:t,meta:i,data:s}=e;switch(i.type){case"int":return parseInt(t,10)||0;case"real":case"unreal":return(parseFloat(t)||0).toFixed(i.stringExt||2);case"techList":case"buffCode":case"buffList":case"effectCode":case"effectList":case"unitCode":case"unitList":case"abilCode":case"abilityList":case"heroAbilityList":case"itemCode":case"itemList":case"upgradeCode":case"upgradeList":const e=s.objects.find(e=>e.id===t);return e?a.a.createElement(Dn,{object:e}):t;default:return t}},Vn=e=>{let{value:t,meta:i,data:s,rawNames:r}=e;const n=r?jn:On;if(i.type.indexOf("List")>=0){if("_"===t)return a.a.createElement(Un,null,r?t:"");if(""===t)return a.a.createElement(Un,null);const e=[];return t.split(",").forEach((t,o)=>{e.length&&e.push(r?",":", "),e.push(a.a.createElement(n,{value:t,meta:i,data:s,key:o}))}),a.a.createElement(Un,null,e)}if(i.type.indexOf("Flags")>=0&&!r){const e=[],o=parseInt(t,10);for(let t=0;t<31&&1<<t<=o;++t)1<<t&o&&(e.length&&e.push(r?",":", "),e.push(a.a.createElement(n,{value:t,meta:i,data:s,key:t})));return a.a.createElement(Un,null,e)}return"string"===i.type?(r||"_"!==t||(t=""),function(e,t){return e.match(/<.*>|\|[crn]/i)?a.a.createElement(Mn,{tooltip:a.a.createElement(Pn,{value:e,data:t})},e):a.a.createElement(Un,null,e)}(t,s)):a.a.createElement(Un,null,a.a.createElement(n,{value:t,meta:i,data:s}))},Gn=e=>{let{object:t,data:i,rawNames:s}=e;const r=[];return De(t,i,s,(e,t,n,o)=>{r.push(a.a.createElement("tr",{key:e},a.a.createElement(Un,null,t),a.a.createElement(Vn,{value:n,meta:o,data:i,rawNames:s})))}),a.a.createElement("tbody",null,r)},Hn=e=>a.a.createElement(be.Consumer,null,t=>a.a.createElement(Gn,Object.assign({},e,{rawNames:t})));class Kn extends a.a.Component{constructor(){super(...arguments),this.state={},this.onMouseDown=(e=>{this.setState({dragPos:e.clientX-this.props.pos}),document.addEventListener("mousemove",this.onMouseMove,!0),document.addEventListener("mouseup",this.onMouseUp,!0),e.preventDefault(),e.stopPropagation()}),this.onMouseMove=(e=>{const{dragPos:t}=this.state;1&e.buttons&&null!=t?(this.props.onChange(e.clientX-t),e.preventDefault(),e.stopPropagation()):this.onMouseUp(e)}),this.onMouseUp=(e=>{this.setState({dragPos:null}),this.removeListeners(),e.preventDefault(),e.stopPropagation()})}removeListeners(){document.removeEventListener("mousemove",this.onMouseMove,!0),document.removeEventListener("mouseup",this.onMouseUp,!0)}componentWillUnmount(){this.removeListeners()}render(){const{pos:e}=this.props;return a.a.createElement("div",{className:"drag-handle",style:{left:e},onMouseDown:this.onMouseDown})}}class qn extends a.a.Component{constructor(){super(...arguments),this.state={sliderPos:300},this.setSliderPos=(e=>(e=Math.max(50,e),this.table_&&(e=Math.min(this.table_.offsetWidth-50,e)),this.setState({sliderPos:e}),e)),this.setRef=(e=>this.table_=e)}render(){const{data:e,className:t,...i}=this.props,{sliderPos:s}=this.state,r=this.context,n=e.objects.find(e=>e.id===r);return n?a.a.createElement(Pe.a,Object.assign({className:b()(t,"ObjectData")},i),a.a.createElement(Kn,{pos:s,onChange:this.setSliderPos}),a.a.createElement(ce,{title:n.name}),a.a.createElement("div",{className:"nonscrollable"},a.a.createElement("table",null,a.a.createElement("thead",null,a.a.createElement("tr",null,a.a.createElement("th",{width:s},"Name"),a.a.createElement("th",null,"Value"))))),a.a.createElement("div",{className:"scrollable"},a.a.createElement("table",{ref:this.setRef},a.a.createElement("thead",null,a.a.createElement("tr",null,a.a.createElement("th",{width:s},"Name"),a.a.createElement("th",null,"Value"))),a.a.createElement(Hn,{object:n,data:e})))):a.a.createElement(Pe.a,Object.assign({className:b()(t,"ObjectData")},i),a.a.createElement("div",null,a.a.createElement("span",{className:"no-results"},r?"Object not found.":"Select an object from the list.")))}}qn.contextType=xe;i(234);class Wn extends a.a.Component{constructor(){super(...arguments),this.setRawNames=(()=>this.context.update("rawNames",!this.context.rawNames))}render(){const{match:{params:{build:e,type:t,id:i}},data:s}=this.props;return a.a.createElement(be.Provider,{value:!!this.context.rawNames},a.a.createElement(Te.Provider,{value:this.setRawNames},a.a.createElement(Ae.Provider,{value:e},a.a.createElement(Ee.Provider,{value:t},a.a.createElement(xe.Provider,{value:i},a.a.createElement("div",{className:"ObjectView"},a.a.createElement(Pe.a,{cols:!0},a.a.createElement(ze,{size:300,minSize:100,resizable:!0,className:"LeftPanel",data:s,type:t,id:i,key:t}),a.a.createElement(qn,{minSize:100,className:"RightPanel",data:s}))))))))}}Wn.contextType=de.Context;const Xn=T({data:(e,t)=>{let{match:i}=e;return t.objects()}},Wn,void 0,void 0);Xn.contextType=le.DataContext;const zn=()=>a.a.createElement(o.d,{path:"/:build/:type/:id?",component:Xn}),Yn=a.a.createContext(null),Jn=(e,t)=>{const i={name:"",dirs:{},files:[]};e.split("\n").filter(e=>e.length>0).forEach(e=>{const s=e.split(/[\\/:]/);let a=i;for(let t=0;t<s.length-1;++t){const e=s[t].toLowerCase();a.dirs[e]||(a.dirs[e]={name:s[t],dirs:{},files:[]}),a=a.dirs[e]}const r=e.match(/^Unknown\\([0-9A-F]{16})/),n=e.match(/\.(\w{1,3})$/);a.files.push({name:s[s.length-1],path:e,key:r?k(r[1]):U(e,t),ext:n?n[1].toLowerCase():"unknown"})});const s=[],a=(e,t)=>e.name.toLowerCase().localeCompare(t.name.toLowerCase()),r=e=>{e.dirs=Object.values(e.dirs).sort(a),e.dirs.forEach(e=>r(e)),e.files.sort(a),s.push(...e.files)};return r(i),{root:i,files:s}},Zn=e=>{let{file:t}=e;return a.a.createElement(le.DataContext.Consumer,null,e=>a.a.createElement(Yn.Consumer,null,i=>a.a.createElement(l.Link,{to:"/".concat(e.id,"/files/").concat(P(t.key)),className:b()("ObjectLink",{searched:t.searched,selected:N(i,t.key)})},a.a.createElement("span",{className:"Icon file-icon file-"+t.ext}),a.a.createElement("span",{className:"ObjectName"},t.name))))};class $n{constructor(e,t){this.height=1,this.file=e,this.file.parent=this,this.parent=t,this.file.upSearchVisit=(e=>{e(this.file),this.upSearchVisit(e)})}render(){return a.a.createElement(Zn,{file:this.file})}renderLine(e){return this.render()}upSearchVisit(e){e(this),this.parent&&this.parent.upSearchVisit(e)}downSearchVisit(e){e(this),e(this.file)}}class Qn{constructor(e,t){this.toggle=(()=>{this.expanded?this.collapse():this.expand()}),this.parent=t,this.level=t?t.level+1:0,this.title=e.name||"__ROOT__",this.count=e.files.length,this.dirs={},this.children=[],e.dirs.forEach(e=>{const t=new Qn(e,this);this.children.push(t),this.dirs[e.name.toLowerCase()]=t,this.count+=t.count}),e.files.forEach(e=>{this.children.push(new $n(e,this))}),this.openHeight=t?1:0,this.children.forEach(e=>{e.top=this.openHeight,this.openHeight+=e.height}),this.expanded=!t,this.searched=!1}upSearchVisit(e){e(this),this.parent&&this.parent.upSearchVisit(e)}downSearchVisit(e){e(this),this.children.forEach(t=>t.downSearchVisit(e))}modHeight(e,t){let i=t?this.children.indexOf(t):-1;if(i>=0)for(;++i<this.children.length;)this.children[i].top+=e;this.openHeight+=e,this.parent&&this.expanded?this.parent.modHeight(e,this):this.onResize&&this.onResize(this.height)}get height(){return this.expanded?this.openHeight:1}expandFile(e,t){if(t||(t=e.path.split(/[\\/]/)),t.length>1){const i=t[0].toLowerCase(),s=this.dirs[i];if(s)return s.expand(),s.expandFile(e,t.slice(1))+s.top}else{const t=this.children.find(t=>t.file===e);if(t)return t.top}return 0}expand(){!this.expanded&&this.count>0&&(this.expanded=!0,this.parent&&this.parent.modHeight(this.openHeight-1,this))}collapse(){this.expanded&&this.parent&&(this.expanded=!1,this.parent.modHeight(1-this.openHeight,this))}render(){return this.parent?a.a.createElement("div",{onClick:this.preSelect,className:b()("ObjectGroup",{expanded:this.expanded,searched:this.searched})},a.a.createElement("span",{className:"toggle",onClick:this.toggle}),a.a.createElement("span",{onDoubleClick:this.toggle},a.a.createElement("span",{className:"Icon"}),a.a.createElement("span",{className:"title"},this.title))):a.a.createElement("span",null,"no-parent-dir")}firstLevelNode(e){if(this.expanded){let t=0,i=this.children.length-1;for(;t<i;){const s=t+i+1>>1;this.children[s].top>e?i=s-1:t=s}return this.children[t]}return null}renderLine(e){if(this.parent&&!e)return this.render();if(this.expanded){let t=0,i=this.children.length-1;for(;t<i;){const s=t+i+1>>1;this.children[s].top>e?i=s-1:t=s}const s=this.children[t],r=e-this.children[t].top,n=this.children[t].renderLine(r);let o=null;return this.parent&&(t<this.children.length-1?o=0===r?"tLine":"line":0===r&&(o="halfLine")),a.a.createElement("div",{className:b()("indent",o,{searched:s.searched})},n)}}}class eo extends a.a.PureComponent{constructor(e){super(e),this.state={search:"",searchResults:null,searched:!1},this.onSearchKeyDown=(e=>{27===e.which&&(this.setState({search:"",searchResults:null}),this.stateChanged=!0)}),this.onSearch=(e=>{const t=e.target.value.trim();let i=[],s=!1;if(this.root.downSearchVisit(e=>e.searched=!1),""!=t&&this.files){const a=new RegExp(t.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&"),"i");this.files.forEach((e,t)=>{let i=!!e.path.match(a);e.upSearchVisit(e=>{e.searched=e.searched||i,e.searched&&(s=!0)})}),this.setState({search:e.target.value,searchResults:i,searched:s})}else this.root.downSearchVisit(e=>e.searched=!1),this.setState({search:e.target.value,searchResults:null,searched:s});this._list&&this._list.forceUpdateGrid(),this.stateChanged=!0}),this.onResize=(()=>{this.forceUpdate()}),this.rowRenderer=(e=>{let{index:t,...i}=e;const{key:s,style:r}=i,n=(this.root.children[t],this.root.firstLevelNode(t));return a.a.createElement("div",{className:b()("TreeRow",{searched:n&&n.searched}),key:s,style:r},this.root.renderLine(t))}),this.rowRendererSearch=(e=>{let{index:t,...i}=e;const{key:s,style:r}=i;return a.a.createElement("div",{className:"TreeRow",key:s},this.root.renderLine(t))});const t=Jn(e.listFile,!e.isMap);this.files=t.files,this.root=new Qn(t.root),this.root.onResize=this.onResize}render(){const{listFile:e,id:t,className:i,isMap:s,...r}=this.props,{search:n,searchResults:o,searched:l}=this.state;if(!this.root)return null;if(!o&&!N(this.root._id,t)){const e=this.files&&this.files.find(e=>N(e.key,t));if(e){this.root.onResize=null;const i=this.root.expandFile(e);this.root.onResize=this.onResize,this.root._id=t,setTimeout(()=>{this._list&&this._list.scrollToRow(i)})}}return a.a.createElement(Pe.a,Object.assign({ref:e=>this._panel=e,className:b()(i,"ObjectList")},r),a.a.createElement("div",{className:"search-box"},a.a.createElement(ke.a,{type:"text",value:n,placeholder:"Search",onKeyDown:this.onSearchKeyDown,onChange:this.onSearch})),a.a.createElement("div",{className:b()("ObjectListItems",l)},a.a.createElement(Ne.a,null,e=>{let{width:t,height:i}=e;return a.a.createElement(Ne.c,{className:"ObjectLines",ref:e=>this._list=e,width:t,height:i,rowCount:this.root.height,rowHeight:18,rowRenderer:this.rowRenderer})})))}}const to=e=>{let{id:t,listFile:i,className:s,...r}=e;return a.a.createElement(Pe.a,Object.assign({className:b()(s,"ObjectList")},r))},io=T({listFile:e=>{let{data:t}=e;return t.listFile()}},e=>{let{data:t,...i}=e;return a.a.createElement(eo,Object.assign({key:t.id,isMap:t.isMap},i))},to,to);var so=i(139);i(238);const ao=e=>{let{value:t,comment:i}=e;i=i&&i.replace("\x1b","\n");const s=null==t||""===t?"":t.toString();return a.a.createElement("div",{title:i||s},s)};class ro extends a.a.PureComponent{constructor(){super(...arguments),this.rowGetter=(e=>{let{index:t}=e;return this.props.data.rows[t]}),this.getColumnWidth=(e=>{let{index:t}=e;return 500})}renderColumns(){const{data:e}=this.props;return Array.from({length:e.cols},(t,i)=>a.a.createElement(Ne.b,{className:"col-"+i,key:i,width:this.getColumnWidth({index:i}),dataKey:String(i),cellRenderer:t=>{let{cellData:s,rowIndex:r}=t;return a.a.createElement(ao,{value:s,comment:e.comments&&e.comments[r]&&e.comments[r][i]})}}))}render(){const{data:e,style:t}=this.props;if(!e||!e.rows||!Number.isInteger(e.cols)||e.cols<=0)return null;const i=50*e.cols;return a.a.createElement("div",{className:"FileSlk"},a.a.createElement(Ne.a,null,s=>{let{width:r,height:n}=s;return a.a.createElement(Ne.d,{style:t,width:i,height:n-22,rowHeight:23,rowGetter:this.rowGetter,rowCount:e.rows.length,overscanRowCount:5},this.renderColumns())}))}}class no extends a.a.PureComponent{constructor(){super(...arguments),this.state={foo:parseInt("foo",10),bar:void 0},this.onSearch=((e,t)=>this._list?this._list.search(e,t):null),this.rowRenderer=(e=>{let{index:t,...i}=e;const{key:s,style:r}=i,n=16*t,o=this.digits,l=[...this.props.data.subarray(n,n+16)],h=".".charCodeAt(0);return a.a.createElement("div",{className:"HexRow",key:s,style:r},a.a.createElement("span",{className:"offset"},n.toString(16).padStart(o,"0")),a.a.createElement("span",{className:"hex"},l.map((e,t)=>a.a.createElement("span",{key:t},e.toString(16).padStart(2,"0"))),l.length<16&&[...Array(16-l.length)].map((e,t)=>a.a.createElement("span",{key:t,className:"padding"},"  "))),a.a.createElement("span",{className:"ascii"},String.fromCharCode(...l.map(e=>e>=32&&e<=126?e:h))))})}get digits(){const e=this.props.data.length;let t=4;for(;1<<4*t<=e;)++t;return t}render(){const{data:e}=this.props;return a.a.createElement(Ne.a,null,t=>{let{width:i,height:s}=t;return a.a.createElement(Ne.c,{className:"HexLines",width:i,height:s,rowCount:Math.ceil(e.length/16),rowHeight:19,rowRenderer:this.rowRenderer})})}}i(239);function oo(e,t){for(let i=0;i<e.childNodes.length;++i)if(e.childNodes[i]===t)return i;return-1}function lo(e,t){if(t>=e.childNodes.length)return e.textContent.length;let i=0;for(let s=0;s<t;++s)i+=e.childNodes[s].textContent.length;return i}function ho(e,t,i){let s=0;for(s=t.childNodes.length?lo(t,i):i;t&&t!==e;){const e=t.parentElement||t.parentNode;s+=lo(e,oo(e,t)),t=e}return t!==e?0:s}function co(e,t,i){const s=[];let r=0;return t.forEach(t=>{const n=Math.max(t.index-i,0),o=Math.min(t.index+t.length-i,e.length);o<=n||(n>r&&s.push(e.substring(r,n)),s.push(a.a.createElement("span",{className:t.className,key:t.index},e.substring(n,o))),r=o)}),r<e.length&&s.push(e.substring(r)),1===s.length?s[0]:s}class uo extends a.a.Component{constructor(){super(...arguments),this.state={searchText:"",searchMatches:[]},this.selection={},this.onCopy=(()=>{if(!this._node)return;const e=window.getSelection(),t=[],i=this.selection,s=this.nodeToPos2(e.anchorNode,e.anchorOffset),a=this.nodeToPos2(e.focusNode,e.focusOffset);if(i.anchorPos&&i.focusPos&&s&&a){const r=i.anchorPos.line<i.focusPos.line?i.anchorPos:i.focusPos,n=i.anchorPos.line<i.focusPos.line?i.focusPos:i.anchorPos,o=s.line<a.line?e.anchorNode:e.focusNode,l=s.line<a.line?s:a,h=s.line<a.line?e.focusNode:e.anchorNode,c=s.line<a.line?a:s,d=this.props.lines;if(r.line<l.line&&1===o.nodeType){const e=[];for(let t=r.line;t<=l.line;++t){let i=d[t];i&&(t===r.line?i=i.substr(r.offset):t===l.line&&(i=i.substr(0,l.offset)),e.push(i))}const i=e.join("\n");if(i.length){const e=document.createElement("span");e.style.position="absolute",e.style.left="-10000px",e.style.top="-10000px",e.style.fontSize="0",e.style.whiteSpace="pre",e.innerText=i,t.push(e),o.appendChild(e)}}if(n.line>c.line&&1===h.nodeType){const e=[];for(let t=c.line+1;t<=n.line;++t){let i=d[t];i&&(t===c.line?i=i.substr(c.offset):t===n.line&&(i=i.substr(0,n.offset)),e.push(i))}const i=e.join("\n");if(i.length){const e=document.createElement("span");e.style.position="absolute",e.style.left="-10000px",e.style.top="-10000px",e.style.fontSize="0",e.style.whiteSpace="pre",e.innerText=i,t.push(e),h.parentElement.insertBefore(e,h)}}}t.length&&window.setTimeout(()=>{t.forEach(e=>e.parentNode.removeChild(e))},100)}),this.onSelect=(()=>{if(this.suppressSelect||!this.selection||!this._node)return;const e=window.getSelection(),t=this.selection,i=e=>{let t=e;for(;t&&t!==this._node&&t!==this._firstLine&&t!==this._lastLine&&(!t.classList||!t.classList.contains("TextLine"));)t=t.parentElement||t.parentNode;return t!==this._firstLine&&t!==this._lastLine&&(!t.classList||!t.classList.contains("TextLine"))};if(e.anchorNode&&this._node.contains(e.anchorNode)){if(!i(e.anchorNode)){const i=this.posToNode(t.anchorPos),s=this.nodeToPos(i),a=this.nodeToPos2(e.anchorNode,e.anchorOffset);s&&a&&s.line===a.line&&s.offset===a.offset?e.setBaseAndExtent(i.node,i.offset,e.focusNode,e.focusOffset):(t.anchorPos=a,t.searchPos=a)}}else t.anchorPos=null;if(e.focusNode&&this._node.contains(e.focusNode)){if(!i(e.focusNode)){const i=this.nodeToPos(this.posToNode(t.focusPos)),s=this.nodeToPos2(e.focusNode,e.focusOffset);i&&s&&i.line===s.line&&i.offset===s.offset||(t.focusPos=s)}}else t.focusPos=null}),this.onScroll=(e=>{let{scrollTop:t}=e;const i=this.selection;i&&i.anchorPos&&i.focusPos&&(this.suppressSelect=!0,this.selectRange(i.anchorPos,i.focusPos),this.unsuppress&&clearTimeout(this.unsuppress),this.unsuppress=setTimeout(()=>{this.suppressSelect=!1,delete this.unsuppress},100))}),this.cellRangeRenderer=(e=>{const t=Object(Ne.e)(e);return t.unshift(a.a.createElement("div",{key:"first-line",className:"fake-line",ref:e=>this._firstLine=e},a.a.createElement("span",null))),t.push(a.a.createElement("div",{key:"last-line",className:"fake-line",ref:e=>this._lastLine=e},a.a.createElement("span",null))),t}),this.rowRenderer=(e=>{let{index:t,key:i,style:s}=e;const{highlightExpr:r,highlightFunc:n}=this.props;if(this.props.padding){if(0===t||t>this.props.lines.length)return null;t-=1}const o=this.state.searchRegex;let l=this.props.lines[t];const h=o&&function(e,t,i,s){let a;const r=[];for(;a=t.exec(e);)r.push({index:a.index,length:a[0].length,className:i&&i.line===s&&i.offset===a.index?"match-current":"match"});return r}(l,o,this.state.searchMatch,t);return r&&n?l=function(e,t,i,s){const r=[];let n,o=0;s||(s=((t,i)=>e.substring(t,i)));const l=e=>{null!=e&&("string"===typeof e&&r.length&&"string"===typeof r[r.length-1]?r[r.length-1]+=e:r.push(e))};for(;n=t.exec(e);){n.index>o&&l(s(o,n.index));const e=i(n);a.a.isValidElement(e)?l(a.a.cloneElement(e,{key:n.index})):l(e),o=n.index+n[0].length}return o<e.length&&l(s(o,e.length)),r}(l,r,e=>{let t=e[0];return h&&(t=co(e[0],h,e.index)),n(t,e)},(e,t)=>{let i=l.substring(e,t);return h&&(i=co(i,h,e)),i}):h&&(l=co(l,h,0)),a.a.createElement("div",{className:"TextLine",key:i,style:s},a.a.createElement("span",{className:"line","data-line-number":t+1}),l,"\n",a.a.createElement("span",{className:"eol"}))}),this.rowMeasure=(e=>{let{index:t}=e;if(this.props.padding){if(0===t||t>this.props.lines.length)return this.props.padding;t-=1}return this.props.heights[t]}),this.setScroll=(e=>{this._list?this._list.scrollToPosition(e):this._scrollTop=e}),this.setList=(e=>{this._list=e,this._node=n.a.findDOMNode(e),null!=this._scrollTop&&(this._list.scrollToPosition(this._scrollTop),delete this._scrollTop)})}componentDidMount(){document.addEventListener("copy",this.onCopy),document.addEventListener("selectionchange",this.onSelect)}componentWillUnmount(){document.removeEventListener("copy",this.onCopy),document.removeEventListener("selectionchange",this.onSelect)}search(e,t){const i=this.state.searchMatch;let s=[],a=null,r=null,n=null;if(e.trim()){if(e===this.state.searchText)s=this.state.searchMatches;else{const t=e.toLowerCase();this.props.lines.forEach((e,i)=>{let a,r=0;const n=e.toLowerCase();for(;-1!==(a=n.indexOf(t,r));)s.push({line:i,offset:a}),r=a+t.length})}let o=-1;if(-1!==t){const e=1===t&&i?{line:i.line,offset:i.offset+1}:this.selection.searchPos||{line:0,offset:0};(o=s.findIndex(t=>t.line>e.line||t.line===e.line&&t.offset>=e.offset))<0&&s.length&&(o=0)}else{const e=i?{line:i.line,offset:i.offset-1}:this.selection.searchPos||{line:0,offset:0};s.forEach((t,i)=>{t.line>e.line||t.line===e.line&&t.offset>e.offset||(o=i)}),o<0&&s.length&&(o=s.length-1)}a=s[o],r=a&&a.line,n={pos:o,count:s.length}}var o;return this._list&&this._list.forceUpdateGrid(),this.setState({searchText:e,searchMatch:a,searchRegex:e&&e.trim()?(o=e,o=o.replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&"),new RegExp("("+o+")","ig")):null,searchMatches:s},()=>{r&&this._list&&this._list.scrollToRow(r)}),n}nodeToPos2(e,t){return this.nodeToPos({node:e,offset:t})}nodeToPos(e){if(!e||!this._node)return;const{node:t,offset:i}=e;if(!this._node.contains(t))return;if(t===this._firstLine){const e=this._node.querySelectorAll(".line");if(!e.length)return;return{line:parseInt(e[0].getAttribute("data-line-number"),10)-1,offset:0}}if(t===this._lastLine){const e=this._node.querySelectorAll(".line");if(!e.length)return;return{line:parseInt(e[e.length-1].getAttribute("data-line-number"),10)-1,offset:e[e.length-1].parentElement.textContent.length-1}}let s=t;for(;s&&s!==this._node&&(!s.classList||!s.classList.contains("TextLine"));)s=s.parentElement||s.parentNode;if(!s||!s.classList||!s.classList.contains("TextLine"))return;const a=s.querySelector(".line");return a?{line:parseInt(a.getAttribute("data-line-number"),10)-1,offset:ho(s,t,i)}:void 0}posToNode2(e,t){return this.posToNode({line:e,offset:t})}posToNode(e){if(!e||!this._node)return;const{line:t,offset:i}=e;let s=this._node.querySelector('.line[data-line-number="'.concat(t+1,'"]'));if(!s){const e=this._node.querySelectorAll(".line");if(!e.length)return;return t<parseInt(e[0].getAttribute("data-line-number"),10)-1&&this._firstLine?{node:this._firstLine,offset:0}:t>parseInt(e[e.length-1].getAttribute("data-line-number"),10)-1&&this._lastLine?{node:this._lastLine,offset:0}:void 0}return function e(t,i){if(!t.childNodes.length)return{node:t,offset:Math.min(t.textContent.length,i)};for(let s=0;s<t.childNodes.length;++s){const a=t.childNodes[s].textContent.length;if(i<a||s===t.childNodes.length-1)return e(t.childNodes[s],i);i-=a}return{node:t,offset:0}}(s=s.parentElement,i)}selectRange(e,t){const i=window.getSelection(),s=this.posToNode(e),a=this.posToNode(t);i.setBaseAndExtent(s?s.node:i.anchorNode,s?s.offset:i.anchorOffset,a?a.node:i.focusNode,a?a.offset:i.focusOffset),this.selection.anchorPos=e,this.selection.searchPos=e,this.selection.focusPos=t}componentDidUpdate(){this._lines!==this.props.lines&&(this._list.recomputeRowHeights(),this._lines=this.props.lines,this.selection={})}render(){const{className:e,onScroll:t,heights:i,lines:s,highlightExpr:r,highlightFunc:n,padding:o,...l}=this.props;let h=s.length+(o?2:0);return this._heights!==i&&(this._heights=i,this._avgHeight=i.reduce((e,t)=>e+t,2*(o||0))/h),a.a.createElement(Ne.c,Object.assign({className:b()(e,"TextView"),ref:this.setList,rowCount:h,estimatedRowSize:this._avgHeight,onScroll:v(this.onScroll,t),cellRangeRenderer:this.cellRangeRenderer,rowHeight:this.rowMeasure,rowRenderer:this.rowRenderer},l))}}class mo extends a.a.PureComponent{constructor(){super(...arguments),this.onSearch=((e,t)=>this._list?this._list.search(e,t):null)}render(){const{lines:e,heights:t}=this.props;return a.a.createElement(a.a.Fragment,null,a.a.createElement(x,{onSearch:this.onSearch}),a.a.createElement(Ne.a,null,i=>{let{width:s,height:r}=i;return a.a.createElement(uo,{ref:e=>this._list=e,width:s,height:r,lines:e,heights:t,padding:6})}))}}const fo=e=>{const t=new DataView(e.buffer,e.byteOffset,e.byteLength);if(1112297521===t.getUint32(0,!1))return{format:"BLP",width:t.getUint32(12,!0),height:t.getUint32(16,!0)};if(1112297522===t.getUint32(0,!1))return{format:"BLP v2",width:t.getUint32(12,!0),height:t.getUint32(16,!0)};if(1145328416===t.getUint32(0,!1))return{format:"DDS",width:t.getUint32(16,!0),height:t.getUint32(12,!0)};if(1195984440!==t.getUint32(0,!1)||55!==e[4]&&57!==e[4]||97!==e[5])return 2303741511===t.getUint32(0,!1)&&218765834===t.getUint32(4,!1)?{format:"PNG",width:t.getUint32(16,!1),height:t.getUint32(20,!1)}:255===e[0]&&216===e[1]&&255===e[2]&&255===e[e.length-2]&&217===e[e.length-1]?{format:"JPG",width:"?",height:"?"}:{format:"TGA",width:t.getInt16(12,!0),height:t.getInt16(14,!0)};{const i=13+3*(8&e[10]);return{format:"GIF",width:t.getInt16(i+5,!0),height:t.getInt16(i+7,!0)}}};class po extends a.a.PureComponent{render(){const{data:e,image:t,name:i}=this.props,s=e&&fo(e);return a.a.createElement("div",null,null!=s&&a.a.createElement("div",null,s.width,"x",s.height," (",s.format,")"),a.a.createElement("div",null,a.a.createElement("img",{src:t,alt:i||"Extracted"})))}}class go extends a.a.PureComponent{render(){const{audio:e}=this.props;return a.a.createElement("div",null,a.a.createElement("audio",{controls:!0,controlsList:"nodownload",src:e}))}}function wo(e){const t={globals:"jkey",endglobals:"jkey",local:"jkey",type:"jkey",constant:"jkey",native:"jkey",function:"jkey",takes:"jkey",returns:"jkey",endfunction:"jkey",return:"jkey",set:"jkey",call:"jkey",if:"jkey",then:"jkey",endif:"jkey",else:"jkey",elseif:"jkey",loop:"jkey",endloop:"jkey",exitwhen:"jkey",or:"jkey",and:"jkey",not:"jkey",array:"jtyp",integer:"jtyp",real:"jtyp",string:"jtyp",boolean:"jtyp",code:"jtyp",handle:"jtyp",nothing:"jtyp",null:"jcon"},i=(e.loadFile("Scripts\\common.j")||"").split(/[\r\n]/),s=/^\s*(?:constant\s+)?(\w+)\s+(?:array\s+)?(\w+)\b/;i.forEach(e=>{const i=e.match(s);i&&("native"===i[1]?t[i[2]]="jnat":"type"===i[1]?t[i[2]]="jtyp":t[i[2]]="jcon")});const a=(e.loadFile("Scripts\\Blizzard.j")||"").split(/[\r\n]/);let r=!1,n=!1;return a.forEach(e=>{let i;r?e.match(/^\s*endfunction\b/)&&(r=!1):(i=e.match(/^\s*(globals|endglobals)\b/))?n="globals"===i[1]:n?(i=e.match(/^\s*(?:constant\s+)?\w+\s+(?:array\s+)?(\w+)\b/))&&(t[i[1]]="jcon"):(i=e.match(/^\s*(?:constant\s+)?function\s+(\w+)\b/))&&(t[i[1]]="jbjf")}),t}const vo=/([a-z_]\w*)|(0x[0-9a-z]+|\d+\.?|\d*\.\d+)|('[^'\\]*(?:\\.[^'\\]*)*')|("[^"\\]*(?:\\.[^"\\]*)*")|(\/\/.*)/gi,yo=16;const bo=T({meta:(e,t)=>t.meta()},class extends a.a.PureComponent{constructor(e){super(e),this.onSearch=((e,t)=>this._list?this._list.search(e,t):null),this.tokenFunc=((e,t)=>{let[i,s,r,n,o,l]=t;if(s){const t=this.keywords[s];return t?a.a.createElement("span",{className:t},e):e}return r?a.a.createElement("span",{className:"jnum"},e):n?a.a.createElement("span",{className:"jchr"},e):o?a.a.createElement("span",{className:"jstr"},e):l?a.a.createElement("span",{className:"jcom"},e):e}),this.keywords=wo(e.meta)}render(){const{lines:e}=this.props,t=e.map(e=>e.split("\n").length*yo);return a.a.createElement(a.a.Fragment,null,a.a.createElement(x,{onSearch:this.onSearch}),a.a.createElement(Ne.a,null,i=>{let{width:s,height:r}=i;return a.a.createElement(uo,{ref:e=>this._list=e,className:"JassColors",width:s,height:r,lines:e,heights:t,highlightExpr:vo,highlightFunc:this.tokenFunc})}))}},void 0,void 0);bo.contextType=le.Context;var Ao=bo;i(102);const Eo={"war3map.doo":Ti.doo.File,"war3map.imp":Ti.imp.File,"war3map.mmp":Ti.mmp.File,"war3map.shd":Ti.shd.File,"war3mapUnits.doo":Ti.unitsdoo.File,"war3map.w3c":Ti.w3c.File,"war3map.w3d":Ti.w3d.File,"war3map.w3e":Ti.w3e.File,"war3map.w3f":Ti.w3f.File,"war3map.w3i":Ti.w3i.File,"war3map.w3o":Ti.w3o.File,"war3map.w3r":Ti.w3r.File,"war3map.w3s":Ti.w3s.File,"war3map.w3u":Ti.w3u.File,"war3map.wct":Ti.wct.File,"war3map.wpm":Ti.wpm.File,"war3map.wtg":Ti.wtg.File,"war3map.wts":Ti.wts.File};class xo extends a.a.Component{constructor(e){super(e),this.onDownload=(()=>{L(new Blob([this.binary],{type:"application/octet-stream"}),this.getName())});const{id:t,data:i}=this.props,s={panel:"hex"},a=i&&i.archive&&i.archive.loadBinary(t);if(a){if(this.binary=a.data,this.flags=a.flags,1&this.flags){const e=(new K.a.TextDecoder).decode(this.binary),t=e.split(/\r\n?|\n/);if(this.isJass())this.jass=t,s.panel="jass";else{this.text=[];const i=2048;t.forEach(e=>{if(e.length>i)for(let t=0;t<e.length;t+=i)this.text.push(e.substr(t,i));else this.text.push(e)}),this.textHeights=this.text.map(()=>16),s.panel="text";try{this.slk=new it(e),s.panel="slk"}catch(r){}}}if(6&this.flags){const e=new Blob([this.binary],{type:4&this.flags?"audio/mpeg":"audio/wav"});this.audio=URL.createObjectURL(e),s.panel="audio"}8&this.flags&&(s.panel="model"),this.image=i.archive.loadImage(t),this.image&&(s.panel="image");const e=this.getName();if(Eo[e])try{this.data=new Eo[e](this.binary.buffer),s.panel="data"}catch(r){console.error(e,"Unable to decoding map content. ",r)}}this.state=s}makePanel(e,t){return a.a.createElement("li",{key:e,className:b()("tab-button",{active:this.state.panel===e}),onClick:()=>this.setState({panel:e})},t)}renderPane(){const{panel:e}=this.state;switch(e){case"hex":return a.a.createElement(no,{data:this.binary});case"slk":return a.a.createElement(ro,{data:this.slk});case"text":return a.a.createElement(mo,{lines:this.text,heights:this.textHeights});case"jass":return a.a.createElement(Ao,{lines:this.jass});case"audio":return a.a.createElement(go,{audio:this.audio});case"model":return a.a.createElement(Bn,{id:this.props.id});case"image":return a.a.createElement(po,{data:this.binary,image:this.image});case"data":return console.log(this.data),a.a.createElement(so.a,{expandLevel:1,data:this.data});default:return null}}getName(){let{data:e,id:t}=this.props;if(this.name)return this.name;const i=e.file("listfile.txt");if(i){const e=i.split("\n").filter(e=>e.length>0).find(e=>{const i=e.match(/^Unknown\\([0-9A-F]{16})/);return N(i?k(i[1]):U(e),t)});if(null!=e){const t=e.split(/[\\/]/);return this.name=t[t.length-1]}}return this.name=P(t)}isJass(){const e=this.getName();if(e&&e.match(/\.j$/i))return!0;const t=this.props.id;return N(U("war3map.j"),t)||N(U("Scripts/war3map.j"),t)}render(){return this.binary?a.a.createElement("div",{className:"FileData"},a.a.createElement(ce,{title:this.getName()}),a.a.createElement("ul",{className:"tab-line"},a.a.createElement("li",{key:"dl",className:"tab-xbutton",onClick:this.onDownload},"Download ",a.a.createElement(c.a,{glyph:"download-alt"})),this.makePanel("hex","Hex"),null!=this.text&&this.makePanel("text","Text"),null!=this.jass&&this.makePanel("jass","JASS"),null!=this.slk&&this.makePanel("slk","SLK"),null!=this.audio&&this.makePanel("audio","Audio"),0!==(8&this.flags)&&this.makePanel("model","Model"),null!=this.image&&this.makePanel("image","Image"),null!=this.data&&this.makePanel("data","Data")),a.a.createElement("div",{className:b()("tab-pane",this.state.panel)},this.renderPane())):null}}const To=e=>{let{type:t,value:i,comment:s}=e;return s=s&&s.replace("\x1b","\n"),null==i||""==i?a.a.createElement(t,{title:s},"\xa0"):a.a.createElement(t,{title:s},i.toString())};class So extends a.a.PureComponent{render(){const{data:e}=this.props,t=[...Array(e.cols)].map((e,t)=>t),i=[...e.rows].map((e,t)=>t);return a.a.createElement("div",{className:"FileSlk"},a.a.createElement("table",null,e.rows.length>=1&&a.a.createElement("thead",null,a.a.createElement("tr",null,t.map(t=>a.a.createElement(To,{type:"th",key:t,value:e.rows[0][t]||"",comment:e.comments&&e.comments[0]&&e.comments[0][t]})))),a.a.createElement("tbody",null,i.filter(e=>e>0).map(i=>a.a.createElement("tr",{key:i},t.map(t=>a.a.createElement(To,{type:"td",key:t,value:e.rows[i]?e.rows[i][t]:void 0,comment:e.comments&&e.comments[i]&&e.comments[i][t]})))))))}}const _o=e=>{let{image:t,name:i}=e;return a.a.createElement("div",{className:"FileData"},a.a.createElement("ul",{className:"tab-line"},a.a.createElement("li",{className:"tab-button active"},"Image")),a.a.createElement("div",{className:"tab-pane image"},a.a.createElement(po,{image:t,name:i})))};const Io=T({data:e=>{let{data:t}=e;return t}},class extends a.a.Component{constructor(e){super(e),this.onDownload=(()=>{L(new Blob([this.props.data],{type:"application/octet-stream"}),this.props.name)});const{name:t,data:i}=e,s={panel:"hex"},a=t.substr(t.lastIndexOf(".")).toLowerCase();if(".mdx"===a)this.model=!0,s.panel="model";else if(".j"===a){const e=(new K.a.TextDecoder).decode(i);this.jass=e.split(/\r\n?|\n/),s.panel="jass"}else if(".txt"===a||".slk"===a||".fdf"==a||".toc"==a){const e=(new K.a.TextDecoder).decode(i),t=e.split(/\r\n?|\n/);this.text=[];const n=2048;if(t.forEach(e=>{if(e.length>n)for(let t=0;t<e.length;t+=n)this.text.push(e.substr(t,n));else this.text.push(e)}),this.textHeights=this.text.map(()=>16),s.panel="text",".slk"===a)try{this.slk=new it(e),s.panel="slk"}catch(r){}}this.state=s}makePanel(e,t){return a.a.createElement("li",{key:e,className:b()("tab-button",{active:this.state.panel===e}),onClick:()=>this.setState({panel:e})},t)}renderPane(){const{panel:e}=this.state;switch(e){case"hex":return a.a.createElement(no,{data:this.props.data});case"text":return a.a.createElement(mo,{lines:this.text,heights:this.textHeights});case"jass":return a.a.createElement(Ao,{lines:this.jass});case"model":return a.a.createElement(Bn,{id:this.props.id});case"slk":return a.a.createElement(So,{data:this.slk});default:return null}}render(){return a.a.createElement("div",{className:"FileData"},a.a.createElement(ce,{title:this.props.name}),a.a.createElement("ul",{className:"tab-line"},a.a.createElement("li",{key:"dl",className:"tab-xbutton",onClick:this.onDownload},"Download ",a.a.createElement(c.a,{glyph:"download-alt"})),this.makePanel("hex","Hex"),null!=this.text&&this.makePanel("text","Text"),null!=this.jass&&this.makePanel("jass","JASS"),null!=this.slk&&this.makePanel("slk","SLK"),!!this.model&&this.makePanel("model","Model")),a.a.createElement("div",{className:b()("tab-pane",this.state.panel)},this.renderPane()))}},void 0,void 0);const Ro=T({listFile:e=>{let{data:t}=e;return t.listFile()}},class extends a.a.PureComponent{constructor(e){super(e);const{id:t,data:i,listFile:s}=this.props,a=s.split("\n").filter(e=>e.length>0);if(this.name=a.find(e=>{const i=e.match(/^Unknown\\([0-9A-F]{16})/);return N(i?k(i[1]):U(e,!0),t)}),null!=this.name){this.name=this.name.split(/[\\/]/).pop();const e=this.name.substr(this.name.lastIndexOf(".")).toLowerCase();[".blp",".dds",".gif",".jpg",".jpeg",".png",".tga"].indexOf(e)>=0?this.image=i.image(t):this.data=fetch(i.cache.binary(t)).then(e=>e.ok?e.arrayBuffer():Promise.reject()).then(e=>new Uint8Array(e))}}render(){const{data:e,id:t}=this.props;return this.image?a.a.createElement(_o,{image:this.image,name:this.name}):this.data?a.a.createElement(Io,{data:this.data,name:this.name,id:t}):a.a.createElement("span",{className:"message"},"File not found")}},void 0,void 0);i(241);class Co extends a.a.Component{render(){const e=this.context,t=this.props.match.params.id,i=null==t?null:k(t);return a.a.createElement(Yn.Provider,{value:i},a.a.createElement("div",{className:"FileView"},a.a.createElement(Pe.a,{cols:!0},a.a.createElement(io,{size:300,minSize:100,resizable:!0,className:"LeftPanel",data:e,id:i}),a.a.createElement(Pe.a,{className:"RightPanel",minSize:100},null==i?a.a.createElement("span",{className:"message"},"Select a file to view its contents"):e.hasFile(i)?a.a.createElement(xo,{data:e,id:i,key:t}):e.archive?a.a.createElement("span",{className:"message"},"File not found"):a.a.createElement(Ro,{data:e,id:i,key:t})))))}}Co.contextType=le.DataContext;const Bo=()=>a.a.createElement(o.d,{path:"/:build/files/:id?",component:Co});class Fo extends a.a.Component{render(){const e=this.context;let t=e.file("info.json");t&&(t=JSON.parse(t));let i=null;return e.archive&&((i=e.archive.loadImage("war3mapPreview.tga"))||(i=e.archive.loadImage("war3mapMap.blp"))),a.a.createElement("div",{className:"HomePage"},a.a.createElement("h3",null,e.core?"Warcraft III Patch ":"",e.name),null!=t&&a.a.createElement("ul",{className:"mapInfo"},a.a.createElement("li",null,a.a.createElement("b",null,"Name:")," ",a.a.createElement("span",null,Ze(t.name))),a.a.createElement("li",null,a.a.createElement("b",null,"Suggested Players:")," ",a.a.createElement("span",null,Ze(t.players))),a.a.createElement("li",null,a.a.createElement("b",null,"Description:")," ",a.a.createElement("span",null,Ze(t.description))),a.a.createElement("li",null,a.a.createElement("b",null,"Author:")," ",a.a.createElement("span",null,Ze(t.author))),a.a.createElement("li",null,null!=i&&a.a.createElement("img",{src:i,alt:"Map preview"}))))}}Fo.contextType=le.DataContext;i(242);const Lo=/([a-z_]\w*)|(0x[0-9a-z]+|\d+\.?|\d*\.\d+)|('[^'\\]*(?:\\.[^'\\]*)*')|("[^"\\]*(?:\\.[^"\\]*)*")|(\/\/.*)/gi,Do=16,Mo=e=>{let{options:t,setOption:i,...s}=e;const r=e=>a.a.createElement("input",{type:"checkbox",checked:!!t[e],onChange:t=>i(e,t.target.checked?1:0)}),n=e=>a.a.createElement("input",{type:"number",min:1,max:10,step:1,value:t[e],onChange:t=>((e,t,i)=>{const s=parseInt(i.target.value,10);isNaN(s)||e(t,s)})(i,e,t)});return a.a.createElement(Ye.a,Object.assign({id:"jass-options"},s),a.a.createElement("form",null,a.a.createElement("label",null,r("indentFlag")," Auto Indent"),!!t.indentFlag&&a.a.createElement("label",{className:"indent"},"Amount ",n("indent")),a.a.createElement("label",null,r("restoreInt")," Restore numbers"),a.a.createElement("label",null,r("restoreId")," Restore object IDs"),a.a.createElement("label",null,r("insertLines")," Insert blank lines"),a.a.createElement("label",null,r("restoreStrings")," Restore trigger strings"),a.a.createElement("label",null,r("renameFunctionsFlag")," Rename functions"),!!t.renameFunctionsFlag&&a.a.createElement("label",{className:"indent"},"Max length ",n("renameFunctions")),a.a.createElement("label",null,r("renameGlobalsFlag")," Rename globals"),!!t.renameGlobalsFlag&&a.a.createElement("label",{className:"indent"},"Max length ",n("renameGlobals")),a.a.createElement("label",null,r("renameLocalsFlag")," Rename locals"),!!t.renameLocalsFlag&&a.a.createElement("label",{className:"indent"},"Max length ",n("renameLocals")),a.a.createElement("label",null,r("inlineFunctions")," Inline one-line functions"),a.a.createElement("label",null,r("getObjectName")," Restore getObjectName strings")))};const Uo=T({objects:e=>{let{data:t}=e;return t.objects()}},class extends a.a.Component{constructor(){super(...arguments),this.state={searchResults:null,searchText:""},this.findPrev=(()=>this.search(this.state.searchText,-1)),this.findNext=(()=>this.search(this.state.searchText,1)),this.onSearchChange=(e=>this.search(e.target.value,0)),this.onSearchKeyDown=(e=>{switch(e.which){case E.a.codes.enter:this.search(this.state.searchText,1),e.preventDefault();break;case E.a.codes.esc:this.search("",0),e.preventDefault()}}),this.onKeyDown=(e=>{const{searchText:t}=this.state;switch(e.which){case E.a.codes.f3:e.shiftKey?this.search(t,-1):this.search(t,1),this._search&&(this._search.focus(),this._search.select()),e.preventDefault();break;case E.a.codes.f:e.ctrlKey&&this._search&&(this._search.focus(),this._search.select(),e.preventDefault())}}),this.tokenFunc=((e,t)=>{let[i,s,r,n,o,h]=t;const{data:c,keywords:d,objects:u}=this.props;if(s){const t=d[s];return t?a.a.createElement("span",{className:t},e):e}if(r)return a.a.createElement("span",{className:"jnum"},e);if(n){const t=n.match(/^'(.*)'$/),i=t&&u.objects.find(e=>e.id===t[1]),s=a.a.createElement("span",{className:"jchr"},e);return i?a.a.createElement(l.Link,{to:"/".concat(c.id,"/").concat(i.type,"/").concat(i.id),title:i.name},s):s}return o?a.a.createElement("span",{className:"jstr"},e):h?a.a.createElement("span",{className:"jcom"},e):e}),this.onDownload=(()=>{const e=this.props.lines.join("\n").replace("\n","\r\n"),t=(new K.a.TextEncoder).encode(e);L(new Blob([t],{type:"text/plain"}),"war3map.j")}),this.setScroll=(e=>{this._list?this._list.setScroll(e):this._scrollTop=e}),this.setList=(e=>{this._list=e,null!=this._scrollTop&&(this._list.setScroll(this._scrollTop),delete this._scrollTop)})}search(e,t){this.setState({searchText:e,searchResults:this._list?this._list.search(e,t):null})}render(){const{lines:e,heights:t,options:i,setOption:s}=this.props,{searchResults:r,searchText:n}=this.state,o=r&&r.count;return a.a.createElement("div",{className:"JassView",onKeyDown:this.onKeyDown},a.a.createElement(h.a,{fluid:!0,className:"JassHeader"},a.a.createElement(fe.a,null,a.a.createElement(pe.a,{eventKey:"source",onClick:this.onDownload},"Download ",a.a.createElement(c.a,{glyph:"download-alt"})),a.a.createElement(R,{trigger:"click",rootClose:!0,placement:"bottom",overlay:a.a.createElement(Mo,{options:i,setOption:s})},a.a.createElement(pe.a,{eventKey:"format"},"Formatting"))),a.a.createElement(h.a.Form,{pullLeft:!0},a.a.createElement(Oe.a,null,a.a.createElement("div",{className:"form-control"},a.a.createElement("input",{type:"text",placeholder:"Search",ref:e=>this._search=e,value:n,onChange:this.onSearchChange,onKeyDown:this.onSearchKeyDown}),!!r&&a.a.createElement("span",{className:"search-tag"},r.pos+1+"/"+r.count),a.a.createElement("button",{disabled:!o,onClick:this.findPrev,title:"Previous"},a.a.createElement(c.a,{glyph:"chevron-up"})),a.a.createElement("button",{disabled:!o,onClick:this.findNext,title:"Next"},a.a.createElement(c.a,{glyph:"chevron-down"})))))),a.a.createElement(F,{onRef:e=>this._saver=e,callback:this.setScroll}),a.a.createElement("div",{className:"JassSource",ref:e=>this._node=e},a.a.createElement(Ne.a,null,i=>{let{width:s,height:r}=i;return a.a.createElement(uo,{className:"JassLines",ref:this.setList,width:s,height:r,lines:e,heights:t,onScroll:this.onScroll,highlightExpr:Lo,highlightFunc:this.tokenFunc})})))}},void 0,void 0);class Po extends a.a.PureComponent{render(){const{options:e,setOption:t,meta:i}=this.props,s=this.context,{indentFlag:r,renameGlobalsFlag:n,renameFunctionsFlag:o,renameLocalsFlag:l,...h}=e;r||(h.indent=0),n||(h.renameGlobals=0),o||(h.renameFunctions=0),l||(h.renameLocals=0);const c=s.jass(h),d=c.map(e=>e.split("\n").length*Do),u=wo(i);return a.a.createElement(Uo,{keywords:u,data:s,lines:c,heights:d,options:e,setOption:t})}}Po.contextType=le.DataContext;class ko extends a.a.Component{constructor(){super(...arguments),this.setOption=((e,t)=>{const i={...this.options};i[e]=t,this.context.update("jassFormatting",i)})}get options(){return this.context.jassFormatting||ko.defaultState}render(){return a.a.createElement(Po,{meta:this.props.meta,options:this.options,setOption:this.setOption})}}ko.defaultState={indentFlag:!0,indent:2,restoreInt:1,restoreId:1,insertLines:1,restoreStrings:1,renameGlobalsFlag:!0,renameGlobals:5,renameFunctionsFlag:!0,renameFunctions:5,renameLocalsFlag:!0,renameLocals:5,inlineFunctions:1,getObjectName:1},ko.contextType=de.Context;const No=T({meta:(e,t)=>t.meta()},ko,void 0,void 0);No.contextType=le.Context;var Oo=No;os.vec3.create(),os.vec3.create(),os.vec3.create(),os.vec3.create(),os.mat4.create(),new Float32Array(1);const jo={i:"Permanent",n:"Campaign",o:"Miscellaneous",m:"Purchasable",l:"Artifact",k:"PowerUp",j:"Charged"};function Vo(e,t){const i=[];function s(e){let{items:s}=e;const a=[];s.forEach(e=>{let{id:i,chance:s}=e;return function e(i,s){const r=t.unitsData.find(e=>e.id===i);if(r&&"item"===r.type)a.push({item:r,chance:s});else{if("\0\0\0\0"===i)return;if("Q"===i[3]){const a=i.charCodeAt(1)+256*i.charCodeAt(2),r=i.charCodeAt(0),n=t.w3i.randomUnitTables.find(e=>e.id===a);n&&n.units.forEach(t=>{let{chance:i,ids:a}=t;a[r]&&e(a[r],s*i/100)})}else if("Y"===i[0]&&"I"===i[2]){const e=jo[i[1]],r="/"===i[3]?-1:parseInt(i[3]),n=t.unitsData.filter(t=>"item"===t.type&&!(r>=0&&parseInt(t.data.level)!==r)&&(!e||t.data.class===e));a.push({name:"Random ".concat(r>=0?"Level "+r:"Any Level"," ").concat(e?"PowerUp"===e?"Power Up Item":e+" Item":"Item"),chance:s,items:n})}}}(i,s)}),i.push(a)}if(e.droppedItemTable>=0){const i=t.w3i.randomItemTables.find(t=>t.id===e.droppedItemTable);i&&i.sets.forEach(e=>s(e))}return e.droppedItemSets.forEach(e=>s(e)),i}const Go=e=>{let{item:t}=e;const[i,s]=a.a.useState(!1),r=a.a.useContext(le.DataContext);return a.a.createElement("li",null,a.a.createElement(Qe,{id:t.item&&t.item.id},t.item?a.a.createElement("a",{href:"/".concat(r.id,"/").concat(t.item.type,"/").concat(t.item.id),target:"_blank"},a.a.createElement(Se,{object:t.item}),t.chance.toFixed(0),"% - ",t.item.name):a.a.createElement("span",null,a.a.createElement(Se,{object:{icon:U("ReplaceableTextures\\WorldEditUI\\Editor-Random-Item.blp")}}),t.chance.toFixed(0),"% - ",t.name,null!=t.items&&t.items.length>0&&a.a.createElement("span",{className:"listToggle",onClick:()=>s(!i)},i?"(hide list)":"(".concat(t.items.length," items)")))),null!=t.items&&i&&a.a.createElement("ul",{className:"ItemDrop"},t.items.map(e=>a.a.createElement("li",null,a.a.createElement(Qe,{id:e.id},a.a.createElement("a",{href:"/".concat(r.id,"/").concat(e.type,"/").concat(e.id),target:"_blank"},a.a.createElement(Se,{object:e})," ",e.name))))))};class Ho extends a.a.Component{constructor(){super(...arguments),this.coords={x:50,y:50},this.onMouseDown=(e=>{this.pressed={x:e.clientX,y:e.clientY},document.addEventListener("mousemove",this.onMouseMove,!0),document.addEventListener("mouseup",this.onMouseUp,!0)}),this.onMouseMove=(e=>{const t=e.clientX-this.pressed.x,i=e.clientY-this.pressed.y;this.coords.x+=t,this.coords.y+=i,this.element&&(this.element.style.left=this.coords.x+"px",this.element.style.top=this.coords.y+"px"),this.pressed={x:e.clientX,y:e.clientY}}),this.onMouseUp=(()=>{delete this.pressed,this.unregisterEvents()})}unregisterEvents(){document.removeEventListener("mousemove",this.onMouseMove,!0),document.removeEventListener("mouseup",this.onMouseUp,!0)}componentWillUnmount(){this.unregisterEvents()}render(){const{gameData:e,units:t,viewer:i,deselect:s}=this.props,r=this.context,n={left:this.coords.x,top:this.coords.y};t.length||(n.display="none");const o=e.getSection("Misc"),l=(h=o.get("grantnormalxp").split(",").map(e=>parseInt(e)),c=parseInt(o.get("grantnormalxpformulaa")),d=parseInt(o.get("grantnormalxpformulab")),u=parseInt(o.get("grantnormalxpformulac")),function e(t){return t<=0?0:t<=h.length?h[t-1]:c*e(t-1)+d*t+u});var h,c,d,u;let m=0;const f=a.a.createElement("ul",{className:"Body"},t.map(e=>{let{unit:t}=e;const s=i.unitsData.find(e=>e.id===t.id);if(!s)return null;let n=null;const o=Vo(t,i);if(o){const e=e=>a.a.createElement("ul",{className:"ItemDrop"},e.map(e=>a.a.createElement(Go,{item:e})));o.length>1?n=a.a.createElement("ul",{className:"ItemDrops"},o.map((t,i)=>a.a.createElement("li",null,a.a.createElement("span",null,"Dropped Item Set ",i+1," (Total Chance: ",t.reduce((e,t)=>{let{chance:i}=t;return e+i},0).toFixed(0),"%)"),e(t)))):o.length&&(n=e(o[0]))}let h=null;const c=parseInt(s.data.level);if(!isNaN(c)){const e=l(c);m+=e,h=a.a.createElement("span",null,"\xa0(",e," XP)")}return a.a.createElement("li",null,a.a.createElement(Qe,{id:t.id},a.a.createElement("a",{href:"/".concat(r.id,"/").concat(s.type,"/").concat(s.id),target:"_blank"},a.a.createElement(Se,{object:s}),a.a.createElement("span",{className:"name"},s.name)," ",h)),n)}));return a.a.createElement("div",{className:"Selection",style:n,ref:e=>this.element=e},a.a.createElement("div",{className:"Heading",onMouseDown:this.onMouseDown},"Selection",m>0?" (".concat(m," Total XP)"):""),f)}}Ho.contextType=le.DataContext;const Ko=T({gameData:e=>{let{gameData:t}=e;return t}},Ho);class qo extends a.a.Component{constructor(e,t){super(e,t),this.state={notifications:[],selection:[]},this.yaw=0,this.pitch=-Math.PI/4,this.distance=2e3,this.center=os.vec3.create(),this.minDistance=500,this.maxDistance=2e4,this.onContextMenu=(e=>{e.preventDefault()}),this.onMouseDown=(e=>{document.addEventListener("mousemove",this.onMouseMove,!0),document.addEventListener("mouseup",this.onMouseUp,!0),this.dragStart=this.dragPos={x:e.clientX,y:e.clientY},this.dragButton=e.ctrlKey?2:e.shiftKey?1:0,e.preventDefault()}),this.onMouseMove=(e=>{if(this.dragPos&&this.canvas){const t=e.clientX-this.dragPos.x,i=e.clientY-this.dragPos.y,s=(this.canvas.width+this.canvas.height)/2;if(2===this.dragButton){for(this.yaw+=2*t*Math.PI/s,this.pitch+=2*i*Math.PI/s;this.yaw>Math.PI;)this.yaw-=2*Math.PI;for(;this.yaw<-Math.PI;)this.yaw+=2*Math.PI;this.pitch=Math.min(this.pitch,0),this.pitch=Math.max(this.pitch,-Math.PI/2+.05)}else if(1===this.dragButton){let e=this.canvas.getBoundingClientRect(),t=Math.min(this.dragStart.x,this.dragPos.x)-e.left,i=Math.min(this.dragStart.y,this.dragPos.y)-e.top,s=Math.max(this.dragStart.x,this.dragPos.x)-e.left,a=Math.max(this.dragStart.y,this.dragPos.y)-e.top;this.viewer&&(this.dragSelection=this.viewer.selectUnits(t,i,s,a)),this.selrect&&(this.selrect.style.display="block",this.selrect.style.left="".concat(t,"px"),this.selrect.style.top="".concat(i,"px"),this.selrect.style.width="".concat(s-t,"px"),this.selrect.style.height="".concat(a-i,"px"))}else if(0===this.dragButton){const e=os.vec3.fromValues(-Math.cos(this.yaw),Math.sin(this.yaw),0),a=os.vec3.fromValues(e[1],-e[0],0),r=this.distance/s;os.vec3.scaleAndAdd(this.center,this.center,e,t*r),os.vec3.scaleAndAdd(this.center,this.center,a,i*r)}this.dragPos={x:e.clientX,y:e.clientY}}e.preventDefault()}),this.onMouseUp=(e=>{if(this.dragPos&&this.viewer){if(this.dragButton<2&&Math.abs(this.dragPos.x-this.dragStart.x)<5&&Math.abs(this.dragPos.y-this.dragStart.y)<5){let t=this.canvas.getBoundingClientRect(),i=this.viewer.selectUnit(e.clientX-t.left,e.clientY-t.top,this.dragButton);this.setState({selection:i})}delete this.dragPos}this.dragSelection&&(this.setState({selection:this.dragSelection}),delete this.dragSelection),this.selrect&&(this.selrect.style.display="none"),this.removeEvents(),e.preventDefault()}),this.onMouseWheel=(e=>{e.deltaY>0?this.distance=Math.min(1.2*this.distance,this.maxDistance):this.distance=Math.max(this.distance/1.2,this.minDistance)}),this.animate=(e=>{if(this.prevTs=e,this.frame=requestAnimationFrame(this.animate),this.scene.camera.viewport([0,0,this.canvas.width,this.canvas.height]),this.viewer.mapSize){const e=this.viewer.mapSize,t=this.viewer.centerOffset;if(this.center[0]=Math.max(t[0],Math.min(this.center[0],128*e[0]+t[0])),this.center[1]=Math.max(t[1],Math.min(this.center[1],128*e[1]+t[1])),!this.rOffsets){this.rOffsets=[];for(let e=0;e<32;++e){const e=Math.random()*Math.PI*2,t=Math.random();this.rOffsets.push([Math.cos(e)*t,Math.sin(e)*t])}}this.center[2]=0,this.rOffsets.forEach(e=>{let[t,i]=e;this.center[2]+=this.viewer.heightAt(this.center[0]+t*this.distance/4,this.center[1]+i*this.distance/4)}),this.center[2]/=this.rOffsets.length}this.scene.camera.perspective(Math.PI/4,this.canvas.width/this.canvas.height,this.minDistance/4,2*this.maxDistance),this.scene.camera.setRotationAroundAngles(this.yaw,this.pitch,this.center,this.distance),this.viewer.updateAndRender()}),this.deselect=(()=>{this.viewer&&this.viewer.deselect(),this.setState({selection:[]})});const i="Units\\MiscGame.txt";t.hasFile(i)?this.gameData=Promise.resolve(t.file(i)):this.gameData=fetch(t.cache.binary(i)).then(e=>e.text()),this.gameData=this.gameData.then(e=>new En.parsers.ini.IniFile(e))}componentWillUnmount(){this.frame&&(cancelAnimationFrame(this.frame),delete this.frame),this.removeEvents()}removeEvents(){document.removeEventListener("mousemove",this.onMouseMove,!0),document.removeEventListener("mouseup",this.onMouseUp,!0)}componentWillUnmount(){this.frame&&(cancelAnimationFrame(this.frame),delete this.frame),this.unmounted=!0}addNotification(e,t,i){this.setState(s=>{let{notifications:a}=s,r={text:e,type:t};return a=[...a,r],i>1e3?setTimeout(()=>{this.unmounted||this.setState(e=>{let{notifications:t}=e,i=t.indexOf(r);return i>=0&&(t=t.slice(),r={...r,expiring:!0},t[i]=r),{notifications:t}})},i-1e3):r.expiring=!0,setTimeout(()=>{this.unmounted||this.setState(e=>{let{notifications:t}=e,i=t.indexOf(r);return i>=0&&(t=t.slice()).splice(i,1),{notifications:t}})},i),{notifications:a}})}componentDidMount(){if(!this.canvas)return;const e=this.canvas,t=this.context;this.viewer=new En.viewer.handlers.w3x.MapViewer(e,(e,i)=>{const s="string"===typeof e?e.substr(e.lastIndexOf(".")).toLowerCase():".mdx";if([".blp",".dds",".gif",".jpg",".jpeg",".png",".tga"].indexOf(s)>=0)return[t.image(e,i),".png",!0];{const a=t.binary(e);return a?[a.data.buffer,s,!1]:[t.cache.binary(e,i),s,!0]}},t),this.viewer.gl.clearColor(0,0,0,1),this.viewer.on("error",(e,t,i)=>{"FailedToFetch"===t&&this.addNotification("Failed to load ".concat(e.path),"error",5e3)}),this.viewer.on("idle",()=>{this.addNotification("Loading complete!","success",5e3)}),this.scene=this.viewer.scene,this.viewer.loadMap(t),this.frame=requestAnimationFrame(this.animate)}render(){const{notifications:e,selection:t}=this.state;return a.a.createElement("div",{className:"ModelPage"},a.a.createElement("div",{className:"FileModel"},a.a.createElement(Ne.a,null,e=>{let{width:t,height:i}=e;return a.a.createElement("canvas",{onMouseDown:this.onMouseDown,onContextMenu:this.onContextMenu,onWheel:this.onMouseWheel,ref:e=>this.canvas=e,width:Math.max(t,100),height:Math.max(i,100)})}),a.a.createElement("div",{className:"selRect",ref:e=>this.selrect=e}),a.a.createElement("ul",{className:"log"},e.map((e,t)=>{let{text:i,type:s,expiring:r}=e;return a.a.createElement("li",{key:t,className:s+(r?" expiring":"")},i)})),a.a.createElement("div",{className:"credits"},"Model viewer by ",a.a.createElement("a",{href:"https://github.com/flowtsohg/mdx-m3-viewer",target:"_blank"},"flowtsohg@github")),a.a.createElement(Ko,{gameData:this.gameData,units:t,viewer:this.viewer,deselect:this.deselect})))}}qo.contextType=le.DataContext;var Wo=()=>a.a.createElement(le.DataContext.Consumer,null,e=>{let t=a.a.createElement(o.g,null,a.a.createElement(o.d,{path:"/:build/(".concat(Object.keys(ge).join("|"),")"),component:zn}),a.a.createElement(o.d,{path:"/:build/script",component:Oo}),a.a.createElement(o.d,{path:"/:build/map",component:qo}),a.a.createElement(o.d,{path:"/:build/files",component:Bo}),a.a.createElement(o.d,{path:"/:build",exact:!0,component:Fo}));return e.isMap?a.a.createElement(ce,{title:e.name},t):t}),Xo=i(258);i(247);const zo=e=>{let{id:t,name:i,desc:s}=e;return i=i&&i.replace(/\|(c[0-9a-fA-F]{6,8}|r)/g,""),(s=s&&s.replace(/\|(c[0-9a-fA-F]{6,8}|r)/g,""))?a.a.createElement(l.Link,{to:"/".concat(t)},i," ",a.a.createElement("span",{className:"desc"},s)):a.a.createElement(l.Link,{to:"/".concat(t)},i)};class Yo extends a.a.Component{constructor(){super(...arguments),this.state={collapsed:!0},this.toggle=(()=>{this.setState(e=>{let{collapsed:t}=e;return{collapsed:!t}})})}render(){const{level:e=0,name:t,items:i,paths:s,descs:r,Comp:n="div"}=this.props,{collapsed:o}=this.state,l=e?"h4":"h3",h={},d=[];return Object.keys(i).forEach(t=>{let a=s[t];a&&0===a.indexOf("maps/")&&((a=a.substr(5).split("~")).length>e+1?(h[a[e]]=h[a[e]]||{},h[a[e]][t]=i[t]):d.push(t))}),d.sort((e,t)=>i[e].localeCompare(i[t])),a.a.createElement(n,{className:o?"collapsed map-list":"map-list"},a.a.createElement(l,{onClick:this.toggle},a.a.createElement(c.a,{glyph:o?"chevron-right":"chevron-down"})," ",t),a.a.createElement("ul",null,Object.keys(h).sort().map(t=>a.a.createElement(Yo,{Comp:"li",key:t,level:e+1,name:t,items:h[t],paths:s,descs:r})),d.map(e=>a.a.createElement("li",{key:e},a.a.createElement(zo,{id:e,name:i[e],desc:s[e].match(/campaign/i)?r[e]:null})))))}}class Jo extends a.a.Component{constructor(){super(...arguments),this.state={message:null,messageType:"info"},this.parseFile=(e=>{const t=e.target.files;t.length>0&&this.context.loadMap(t[0])})}setNotification(e,t){this.setState({message:e,messageType:t})}componentDidMount(){Q(this)}componentWillUnmount(){Q(null)}render(){const e=this.context;return e.custom=e.custom||{},a.a.createElement("div",{className:"HomePage"},null!=this.state.message&&a.a.createElement(u.a,{bsStyle:this.state.messageType},a.a.createElement(u.a.Heading,null,a.a.createElement(u.a.Title,null,this.state.message))),a.a.createElement("h3",null,"Warcraft III Data"),a.a.createElement("ul",null,Object.entries(e.versions).sort((e,t)=>parseInt(t[0],10)-parseInt(e[0],10)).map(e=>{let[t,i]=e;return a.a.createElement("li",{key:t},a.a.createElement(l.Link,{to:"/".concat(t)},"Patch ",i))})),a.a.createElement(le.MapsContext.Consumer,null,t=>a.a.createElement(Yo,{name:"Standard Maps",items:t,paths:e.custom||{},descs:e.customDesc||{}})),a.a.createElement("h3",null,"Custom Maps"),a.a.createElement(le.MapsContext.Consumer,null,t=>a.a.createElement("ul",null,Object.entries(t).filter(t=>{let[i]=t;return!e.custom[i]||!e.custom[i].match(/^maps\//)}).sort((e,t)=>e[1].localeCompare(e[2])).map(t=>{let[i,s]=t,r=null;return e.isLocal(i)&&(r=a.a.createElement("span",{className:"unload",onClick:()=>e.unloadMap(i)},"(unload)")),a.a.createElement("li",{key:i},a.a.createElement(l.Link,{to:"/".concat(i)},s),r)}))),a.a.createElement("form",null,a.a.createElement(Oe.a,{controlId:"loadFile"},a.a.createElement(je.a,{className:"linkLike"},"Load a custom Warcraft III map"),a.a.createElement(ke.a,{style:{display:"none"},type:"file",onChange:this.parseFile,accept:".w3x,.w3m,.mpq",multiple:!1,value:""}),a.a.createElement(Xo.a,null,a.a.createElement("p",null,"Or simply drop the map file onto the page"),a.a.createElement("p",null,"The map will be parsed in your browser, and the data will be stored in browser cache. Nothing is sent to the server.")))))}}Jo.contextType=le.Context;const Zo=()=>a.a.createElement("div",{className:"Spinner"}),$o=T({data:(e,t)=>{let{id:i}=e;return t.data(i)}},e=>{let{data:t,children:i}=e;return a.a.createElement(le.DataContext.Provider,{value:t},i)},void 0,()=>a.a.createElement(o.c,{to:"/"}));$o.contextType=le.Context;class Qo extends a.a.PureComponent{constructor(){super(...arguments),this.state={loading:0,dropping:0},this.onLoading=(e=>{this.setState({loading:e})}),this.onDrop=(e=>{const t=function(e){if(e.dataTransfer.items)for(let t=0;t<e.dataTransfer.items.length;++t)if("file"===e.dataTransfer.items[t].kind)return e.dataTransfer.items[t].getAsFile();if(e.dataTransfer.files.length)return e.dataTransfer.files[0]}(e);t&&(e.preventDefault(),this.context.loadMap(t)),this.setState({dropping:0})}),this.onDragEnter=(e=>{e.preventDefault(),this.setDropping(1)}),this.onDragOver=(e=>{(function(e){if(e.dataTransfer.items)for(let t=0;t<e.dataTransfer.items.length;++t)if("file"===e.dataTransfer.items[t].kind)return!0;return!!e.dataTransfer.files.length})(e)&&e.preventDefault()}),this.onDragLeave=(e=>{this.setDropping(-1)})}get build(){return this.props.match.params.build}componentDidMount(){this.context.subscribe(this.onLoading),document.addEventListener("drop",this.onDrop,!0),document.addEventListener("dragover",this.onDragOver,!0),document.addEventListener("dragenter",this.onDragEnter,!0),document.addEventListener("dragleave",this.onDragLeave,!0)}componentWillUnmount(){this.context.unsubscribe(this.onLoading),document.removeEventListener("drop",this.onDrop,!0),document.removeEventListener("dragover",this.onDragOver,!0),document.removeEventListener("dragenter",this.onDragEnter,!0),document.removeEventListener("dragleave",this.onDragLeave,!0)}setDropping(e){this.setState(t=>{let{dropping:i}=t;return{dropping:Math.max(i+e,0)}})}render(){const e=this.build;return e&&!this.context.hasData(e)?(ee("No data for ".concat(e),"warning"),a.a.createElement(o.c,{to:"/"})):a.a.createElement(a.a.Fragment,null,this.state.dropping>0&&a.a.createElement("div",{className:"DropFrame"}),a.a.createElement(h.a,{className:"app-navbar",fluid:!0},a.a.createElement(h.a.Header,null,a.a.createElement(h.a.Brand,null,a.a.createElement(l.Link,{to:"/"},a.a.createElement("span",{className:"AppIcon"})," ",e?a.a.createElement("span",null):a.a.createElement("span",{style:{padding:"5px 10px"}},"WC3 Data"))),!!e&&a.a.createElement($o,{id:e},a.a.createElement(ye,null)))),e?a.a.createElement($o,{id:e},a.a.createElement(Wo,null)):a.a.createElement(Jo,null),this.state.loading>0&&a.a.createElement(Zo,null))}}Qo.contextType=le.Context;const el=T({ready:(e,t)=>t.ready},Qo,void 0,void 0);el.contextType=le.Context;class tl extends a.a.Component{renderStep(e,t){const{progress:i,status:s}=this.props;return i>=e||null!=s&&!1!==s?a.a.createElement("li",{className:"success"},a.a.createElement(c.a,{glyph:"ok"}),t):null!=s?a.a.createElement("li",{className:"failure"},a.a.createElement(c.a,{glyph:"remove"}),t):i===e-1?a.a.createElement("li",{className:"working"},a.a.createElement(c.a,{glyph:"ok"}),t,"..."):a.a.createElement("li",{className:"pending"},a.a.createElement(c.a,{glyph:"ok"}),t)}render(){const{name:e,status:t,error:i,onHide:s}=this.props;return a.a.createElement(d.a,{dialogClassName:"MapDialog",show:null!=e,onHide:s},a.a.createElement(d.a.Header,{closeButton:!0},a.a.createElement(d.a.Title,null,"Processing ",e)),a.a.createElement(d.a.Body,null,a.a.createElement("ul",{className:"load-progress"},this.renderStep(0,"Downloading meta data"),this.renderStep(1,"Loading objects"),this.renderStep(2,"Writing objects"),this.renderStep(3,"Identifying files"),this.renderStep(4,"Copying files"),this.renderStep(5,"Finishing")),null!=i&&a.a.createElement(u.a,{bsStyle:"danger"},a.a.createElement(u.a.Heading,null,a.a.createElement(u.a.Title,null,i)))),a.a.createElement(d.a.Footer,null,null==t&&a.a.createElement(m.a,{bsStyle:"warning",onClick:s},"Cancel"),null!=t&&!1!==t&&a.a.createElement(f.LinkContainer,{to:"/".concat(t)},a.a.createElement(m.a,{bsStyle:"info",onClick:s},"Open")),null!=t&&a.a.createElement(m.a,{bsStyle:"info",onClick:s},"Ok")))}}var il=class extends a.a.Component{constructor(){super(...arguments),this.cache=new le(this),this.state={mapLoadName:null,mapLoadProgress:-1,mapLoadStatus:null,mapLoadError:null},this.onCloseMapDialog=(()=>{this.cache.abortMap(),this.setState({mapLoadName:null,mapLoadProgress:-1,mapLoadStatus:null,mapLoadError:null})})}navigateTo(e){this.router&&this.router.history.push(e)}beginMapLoad(e){this.setState({mapLoadName:e,mapLoadProgress:-1,mapLoadStatus:null,mapLoadError:null})}onMapProgress(e){this.setState({mapLoadProgress:e})}finishMapLoad(e){this.setState({mapLoadStatus:e})}failMapLoad(e){this.setState({mapLoadStatus:!1,mapLoadError:e})}render(){const{mapLoadName:e,mapLoadProgress:t,mapLoadStatus:i,mapLoadError:s}=this.state;return a.a.createElement(l.BrowserRouter,{basename:"/",ref:e=>this.router=e},a.a.createElement(ce,{title:"WC3 Data"},a.a.createElement(de,null,a.a.createElement(le.Context.Provider,{value:this.cache},a.a.createElement(le.MapsContext.Provider,{value:this.cache.maps},a.a.createElement("div",{className:"App"},a.a.createElement(tl,{name:e,status:i,progress:t,error:s,onHide:this.onCloseMapDialog}),a.a.createElement(o.d,{path:"/:build?",component:el})))))))}};n.a.render(a.a.createElement(il,null),document.getElementById("root"))}},[[142,1,2]]]);
//# sourceMappingURL=main.45f7df42.chunk.js.map