(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{178:function(e,t,i){(function(t){const{CstParser:r,EMPTY_ALT:n,EOF:s}=i(192),{JassLexer:a,tokenVocabulary:o}=i(425);for(const e in o)Object.hasOwnProperty.call(o,e)&&(t[e]=o[e]);class l extends r{constructor(){super(o);const e=this;e.RULE("program",()=>{e.MANY(()=>{e.OR([{ALT:()=>e.SUBRULE(e.typeDefinition)},{ALT:()=>e.SUBRULE(e.nativeBlock)},{ALT:()=>e.SUBRULE(e.globalsBlock)},{ALT:()=>e.SUBRULE(e.functionBlock)}])})}),e.RULE("typeDefinition",()=>{e.CONSUME(TYPE),e.CONSUME1(ID),e.CONSUME2(EXTENDS),e.CONSUME3(ID)}),e.RULE("type",()=>{e.OR([{ALT:()=>e.CONSUME(NOTHING)},{ALT:()=>{e.CONSUME(ID),e.OPTION(()=>e.CONSUME(ARRAY))}}])}),e.RULE("globalVar",()=>{e.OPTION(()=>e.CONSUME(CONSTANT),{LABEL:"constant"}),e.SUBRULE(e.type,{LABEL:"type"}),e.CONSUME2(ID,{LABEL:"label"}),e.OPTION3(()=>{e.CONSUME(EQUALS),e.SUBRULE(e.expression)})}),e.RULE("localVars",()=>{e.CONSUME1(LOCAL),e.SUBRULE(e.type,{LABEL:"type"}),e.CONSUME2(ID,{LABEL:"label"}),e.OPTION3(()=>{e.CONSUME(EQUALS),e.SUBRULE(e.expression)})}),e.RULE("expression",()=>{const t={LABEL:"left"},i={LABEL:"op"},r={LABEL:"right"};e.OR([{ALT:()=>e.SUBRULE(e.ParentheticalExpression,t)},{ALT:()=>e.SUBRULE(e.NotExpression,t)},{ALT:()=>e.SUBRULE(e.NegateExpression,t)},{ALT:()=>e.CONSUME(IDLITERAL,t)},{ALT:()=>e.CONSUME(STRINGLITERAL,t)},{ALT:()=>e.CONSUME(HEX_CONSTANT,t)},{ALT:()=>e.CONSUME(DOLLAR_HEX_CONSTANT,t)},{ALT:()=>e.CONSUME(RAWCODE,t)},{ALT:()=>e.SUBRULE(e.jassValueOf,t)},{ALT:()=>e.SUBRULE(e.FunctionReferenceExpression,t)},{ALT:()=>e.CONSUME(INTEGER,t)},{ALT:()=>e.CONSUME(NULL,t)},{ALT:()=>e.CONSUME(FALSE,t)},{ALT:()=>e.CONSUME(TRUE,t)},{ALT:()=>e.CONSUME(REAL,t)}]),e.OPTION(()=>{e.OR2([{ALT:()=>e.CONSUME(AND,i)},{ALT:()=>e.CONSUME(OR,i)},{ALT:()=>e.CONSUME(EQUALSEQUALS,i)},{ALT:()=>e.CONSUME(LESSOREQUALS,i)},{ALT:()=>e.CONSUME(GREATEROREQUALS,i)},{ALT:()=>e.CONSUME(LESS,i)},{ALT:()=>e.CONSUME(GREATER,i)},{ALT:()=>e.CONSUME(NOTEQUALS,i)},{ALT:()=>e.CONSUME(PLUS,i)},{ALT:()=>e.CONSUME(MINUS,i)},{ALT:()=>e.CONSUME(MULT,i)},{ALT:()=>e.CONSUME(DIV,i)}]),e.SUBRULE2(e.expression,r)})}),e.RULE("StringLiteralExpression",()=>{e.CONSUME(STRINGLITERAL)}),e.RULE("HexIntegerLiteralExpression",()=>{e.CONSUME(HEX_CONSTANT)}),e.RULE("DollarHexIntegerLiteralExpression",()=>{e.CONSUME(DOLLAR_HEX_CONSTANT)}),e.RULE("FunctionReferenceExpression",()=>{e.CONSUME1(FUNCTION),e.CONSUME2(ID)}),e.RULE("jassValueOf",()=>{e.CONSUME(ID);e.OPTION(()=>{e.OR([{ALT:()=>e.SUBRULE(e.arrayAccess)},{ALT:()=>{e.CONSUME2(LPAREN),e.SUBRULE(e.argList),e.CONSUME3(RPAREN)}},{ALT:()=>{e.CONSUME(LPAREN),e.CONSUME(RPAREN)}}])})}),e.RULE("functionCallExpression",()=>{e.CONSUME1(ID),e.CONSUME2(LPAREN),e.OPTION(()=>e.SUBRULE(e.argList)),e.CONSUME3(RPAREN)}),e.RULE("arrayAccess",()=>{e.CONSUME2(LSQUAREPAREN),e.SUBRULE(e.expression),e.CONSUME3(RSQUAREPAREN)}),e.RULE("ParentheticalExpression",()=>{e.CONSUME(LPAREN);e.SUBRULE(e.expression);e.CONSUME(RPAREN)}),e.RULE("NotExpression",()=>{e.CONSUME(NOT),e.SUBRULE(e.expression)}),e.RULE("NegateExpression",()=>{e.CONSUME(MINUS),e.SUBRULE(e.expression)}),e.RULE("argList",()=>{e.SUBRULE(e.expression);e.MANY({DEF:()=>{e.CONSUME(COMMA);e.SUBRULE2(e.expression)}})}),e.RULE("statement",()=>{const t={LABEL:"statements"};e.OR([{ALT:()=>e.SUBRULE(e.callStatement,t)},{ALT:()=>e.SUBRULE(e.setStatement,t)},{ALT:()=>e.SUBRULE(e.returnStatement,t)},{ALT:()=>e.SUBRULE(e.exitWhenStatement,t)},{ALT:()=>e.SUBRULE(e.localVars,t)},{ALT:()=>e.SUBRULE(e.loopStatement,t)},{ALT:()=>e.SUBRULE(e.ifStatement,t)}])}),e.RULE("callStatement",()=>{e.CONSUME(CALL),e.SUBRULE(e.functionCallExpression)}),e.RULE("setStatement",()=>{e.CONSUME1(SET),e.CONSUME2(ID),e.OPTION(()=>e.SUBRULE(e.arrayAccess)),e.CONSUME3(EQUALS),e.SUBRULE(e.expression)}),e.RULE("returnStatement",()=>{e.CONSUME(RETURN),e.OPTION(()=>e.SUBRULE(e.expression))}),e.RULE("exitWhenStatement",()=>{e.CONSUME(EXITWHEN),e.SUBRULE(e.expression)}),e.RULE("loopStatement",()=>{e.CONSUME(LOOP),e.MANY(()=>e.SUBRULE(e.statement)),e.CONSUME(ENDLOOP)}),e.RULE("ifStatement",()=>{e.CONSUME(IF),e.SUBRULE(e.expression,{LABEL:"condition"}),e.CONSUME(THEN),e.MANY(()=>e.SUBRULE(e.statement,{LABEL:"statements"})),e.MANY2(()=>e.SUBRULE(e.elseIfStatement,{LABEL:"elseIfStatement"})),e.MANY3(()=>e.SUBRULE(e.elseStatement,{LABEL:"elseStatement"})),e.CONSUME4(ENDIF)}),e.RULE("elseIfStatement",()=>{e.CONSUME(ELSEIF),e.SUBRULE(e.expression,{LABEL:"condition"}),e.CONSUME(THEN),e.MANY(()=>e.SUBRULE(e.statement,{LABEL:"statements"}))}),e.RULE("elseStatement",()=>{e.CONSUME(ELSE),e.MANY(()=>e.SUBRULE(e.statement,{LABEL:"statements"}))}),e.RULE("param",()=>{e.OR([{ALT:()=>{e.SUBRULE(e.type),e.CONSUME(ID)}},{ALT:()=>e.CONSUME(NOTHING)}])}),e.RULE("paramList",()=>{e.SUBRULE(e.param);e.MANY({DEF:()=>{e.CONSUME(COMMA),e.SUBRULE2(e.param)}})}),e.RULE("globalsBlock",()=>{e.CONSUME(GLOBALS),e.MANY(()=>e.SUBRULE(e.globalVar,{LABEL:"globalVars"})),e.CONSUME(ENDGLOBALS)}),e.RULE("nativeBlock",()=>{e.OPTION(()=>e.CONSUME(CONSTANT)),e.CONSUME(NATIVE),e.CONSUME(ID),e.CONSUME(TAKES),e.SUBRULE(e.paramList),e.CONSUME(RETURNS),e.SUBRULE(e.type,{LABEL:"returnType"})}),e.RULE("functionBlock",()=>{e.OPTION(()=>e.CONSUME(CONSTANT)),e.CONSUME(FUNCTION),e.CONSUME(ID,{LABEL:"functionName"}),e.CONSUME(TAKES),e.SUBRULE(e.paramList),e.CONSUME(RETURNS),e.SUBRULE(e.type,{LABEL:"returnType"}),e.MANY(()=>e.SUBRULE(e.statement,"statements")),e.CONSUME(ENDFUNCTION)}),this.performSelfAnalysis()}}class h{visit(e,t){e instanceof Array?this.visitArray(e,t):this.visitObject(e,t)}visitObject(e,t){if(Object.keys(e).length)if(e.image)console.log(this.indent(t),"#"+e.tokenType.name,"'"+e.image+"'",", end at line",e.endLine+":"+e.endColumn);else{e.name&&console.log(this.indent(t),"#"+e.name);for(const i in e){const r=e[i];"name"!=i&&(Object.hasOwnProperty.call(e,i)&&(r instanceof Array?this.visitArray(r,t+1):r.__proto__&&"String"==r.__proto__.constructor.name?console.log(this.indent(t)+i,"=","'"+r+"'"):Object.keys(r).length?this.visitObject(r,t+1):console.log(this.indent(t),">","no-elements-found")))}}}visitArray(e,t){if(e instanceof Array)for(let i=0;i<e.length;i++){const r=e[i];this.visit(r,t)}}indent(e){return new Array(2*e).fill(" ").join("")}}e.exports={JassParser:l,parse:function(e,t,i){const r=new l,n=a.tokenize(e);r.input=n.tokens,r.debug=t&&"program"!=t||i,r.constVisitor=new h,r.cstPostRule=function(e){this.debug&&this.constVisitor.visit(e,0)},console.log("==== start parser program === ");const s=r[t||"program"]();if(r.errors.length>0)throw new Error(r.errors[0].message);return s}}}).call(this,i(87))},233:function(e,t,i){e.exports=i.p+"static/media/ArchiveLoader.2fdd1a3c.wasm"},234:function(e,t,i){(function(t,r,n){var s=(()=>{var e="undefined"!=typeof document?document.currentScript&&document.currentScript.src:void 0;return e||(e=t),function(t={}){var s,a,o,l,h,c=t,d=new Promise((e,t)=>{s=e,a=t}),u="object"==typeof window,m="function"==typeof importScripts,f="object"==typeof r&&"object"==typeof r.versions&&"string"==typeof r.versions.node,p=Object.assign({},c),E="./this.program",g=(e,t)=>{throw t},A="";if(f){var _=i(255),T=i(256);A=n+"/",o=((e,t)=>(e=k(e)?new URL(e):T.normalize(e),_.readFileSync(e,t?void 0:"utf8"))),h=(e=>{var t=o(e,!0);return t.buffer||(t=new Uint8Array(t)),t}),l=((e,t,i,r=!0)=>{e=k(e)?new URL(e):T.normalize(e),_.readFile(e,r?void 0:"utf8",(e,n)=>{e?i(e):t(r?n.buffer:n)})}),!c.thisProgram&&r.argv.length>1&&(E=r.argv[1].replace(/\\/g,"/")),r.argv.slice(2),g=((e,t)=>{throw r.exitCode=e,t})}else(u||m)&&(m?A=self.location.href:"undefined"!=typeof document&&document.currentScript&&(A=document.currentScript.src),e&&(A=e),A=A.startsWith("blob:")?"":A.substr(0,A.replace(/[?#].*/,"").lastIndexOf("/")+1),o=(e=>{var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(null),t.responseText}),m&&(h=(e=>{var t=new XMLHttpRequest;return t.open("GET",e,!1),t.responseType="arraybuffer",t.send(null),new Uint8Array(t.response)})),l=((e,t,i)=>{if(k(e)){var r=new XMLHttpRequest;return r.open("GET",e,!0),r.responseType="arraybuffer",r.onload=(()=>{200==r.status||0==r.status&&r.response?t(r.response):i()}),r.onerror=i,void r.send(null)}fetch(e,{credentials:"same-origin"}).then(e=>e.ok?e.arrayBuffer():Promise.reject(new Error(e.status+" : "+e.url))).then(t,i)}));var v,y,w=c.print||console.log.bind(console),S=c.printErr||console.error.bind(console);Object.assign(c,p),p=null,c.arguments&&c.arguments,c.thisProgram&&(E=c.thisProgram),c.quit&&(g=c.quit),c.wasmBinary&&(v=c.wasmBinary);var R,b,I,L=!1;function N(){var e=y.buffer;c.HEAP8=R=new Int8Array(e),c.HEAP16=new Int16Array(e),c.HEAPU8=b=new Uint8Array(e),c.HEAPU16=new Uint16Array(e),c.HEAP32=new Int32Array(e),c.HEAPU32=I=new Uint32Array(e),c.HEAPF32=new Float32Array(e),c.HEAPF64=new Float64Array(e)}var x=[],P=[],C=[];function U(e){C.unshift(e)}var O=0,D=null,M=null;function F(e){c.onAbort&&c.onAbort(e),S(e="Aborted("+e+")"),L=!0,1,e+=". Build with -sASSERTIONS for more info.";var t=new WebAssembly.RuntimeError(e);throw a(t),t}var B,V=e=>e.startsWith("data:application/octet-stream;base64,"),k=e=>e.startsWith("file://");function G(){var e,t="ArchiveLoader.wasm";return V(t)?t:(e=t,c.locateFile?c.locateFile(e,A):A+e)}function j(e){if(e==B&&v)return new Uint8Array(v);if(h)return h(e);throw"both async and sync fetching of the wasm failed"}function Y(e,t,i){return function(e){return v?Promise.resolve().then(()=>j(e)):new Promise((t,i)=>{l(e,e=>t(new Uint8Array(e)),r=>{try{t(j(e))}catch(n){i(n)}})})}(e).then(e=>WebAssembly.instantiate(e,t)).then(i,e=>{S(`failed to asynchronously prepare wasm: ${e}`),F(e)})}function H(e){this.name="ExitStatus",this.message=`Program terminated with exit(${e})`,this.status=e}var W=e=>{for(;e.length>0;)e.shift()(c)},K=c.noExitRuntime||!0,z=e=>me(e),q=()=>fe(),X="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0,J=(e,t,i)=>{for(var r=t+i,n=t;e[n]&&!(n>=r);)++n;if(n-t>16&&e.buffer&&X)return X.decode(e.subarray(t,n));for(var s="";t<n;){var a=e[t++];if(128&a){var o=63&e[t++];if(192!=(224&a)){var l=63&e[t++];if((a=224==(240&a)?(15&a)<<12|o<<6|l:(7&a)<<18|o<<12|l<<6|63&e[t++])<65536)s+=String.fromCharCode(a);else{var h=a-65536;s+=String.fromCharCode(55296|h>>10,56320|1023&h)}}else s+=String.fromCharCode((31&a)<<6|o)}else s+=String.fromCharCode(a)}return s},Q=(e,t)=>e?J(b,e,t):"";class ${constructor(e){this.excPtr=e,this.ptr=e-24}set_type(e){I[this.ptr+4>>2]=e}get_type(){return I[this.ptr+4>>2]}set_destructor(e){I[this.ptr+8>>2]=e}get_destructor(){return I[this.ptr+8>>2]}set_caught(e){e=e?1:0,R[this.ptr+12]=e}get_caught(){return 0!=R[this.ptr+12]}set_rethrown(e){e=e?1:0,R[this.ptr+13]=e}get_rethrown(){return 0!=R[this.ptr+13]}init(e,t){this.set_adjusted_ptr(0),this.set_type(e),this.set_destructor(t)}set_adjusted_ptr(e){I[this.ptr+16>>2]=e}get_adjusted_ptr(){return I[this.ptr+16>>2]}get_exception_ptr(){if(pe(this.get_type()))return I[this.excPtr>>2];var e=this.get_adjusted_ptr();return 0!==e?e:this.excPtr}}var Z=e=>{var t=(e-y.buffer.byteLength+65535)/65536;try{return y.grow(t),N(),1}catch(i){}},ee={},te=()=>{if(!te.strings){var e={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:("object"==typeof navigator&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:E||"./this.program"};for(var t in ee)void 0===ee[t]?delete e[t]:e[t]=ee[t];var i=[];for(var t in e)i.push(`${t}=${e[t]}`);te.strings=i}return te.strings},ie=e=>{e,K||(c.onExit&&c.onExit(e),L=!0),g(e,new H(e))},re=(e,t)=>t+2097152>>>0<4194305-!!e?(e>>>0)+4294967296*t:NaN;var ne,se,ae=[null,[],[]],oe=(e,t)=>{var i=ae[e];0===t||10===t?((1===e?w:S)(J(i,0)),i.length=0):i.push(t)},le=[],he=e=>{var t=le[e];return t||(e>=le.length&&(le.length=e+1),le[e]=t=ne.get(e)),t},ce={d:(e,t,i,r)=>{F(`Assertion failed: ${Q(e)}, at: `+[t?Q(t):"unknown filename",i,r?Q(r):"unknown function"])},k:(e,t,i)=>{throw new $(e).init(t,i),0,e},o:()=>{F("")},u:(e,t,i)=>b.copyWithin(e,t,t+i),p:()=>{throw 1/0},q:e=>{var t=b.length;if((e>>>=0)>2147483648)return!1;for(var i=(e,t)=>e+(t-e%t)%t,r=1;r<=4;r*=2){var n=t*(1+.2/r);n=Math.min(n,e+100663296);var s=Math.min(2147483648,i(Math.max(e,n),65536));if(Z(s))return!0}return!1},s:(e,t)=>{var i=0;return te().forEach((r,n)=>{var s=t+i;I[e+4*n>>2]=s,((e,t)=>{for(var i=0;i<e.length;++i)R[t++]=e.charCodeAt(i);R[t]=0})(r,s),i+=r.length+1}),0},t:(e,t)=>{var i=te();I[e>>2]=i.length;var r=0;return i.forEach(e=>r+=e.length+1),I[t>>2]=r,0},v:(e,t)=>{e,ie(e)},r:e=>52,l:function(e,t,i,r,n){return re(t,i),70},j:(e,t,i,r)=>{for(var n=0,s=0;s<i;s++){var a=I[t>>2],o=I[t+4>>2];t+=8;for(var l=0;l<o;l++)oe(e,b[a+l]);n+=o}return I[r>>2]=n,0},a:function(e,t){var i=q();try{return he(e)(t)}catch(r){if(z(i),r!==r+0)throw r;ue(1,0)}},b:function(e,t,i){var r=q();try{return he(e)(t,i)}catch(n){if(z(r),n!==n+0)throw n;ue(1,0)}},e:function(e,t,i,r){var n=q();try{return he(e)(t,i,r)}catch(s){if(z(n),s!==s+0)throw s;ue(1,0)}},g:function(e,t,i,r,n){var s=q();try{return he(e)(t,i,r,n)}catch(a){if(z(s),a!==a+0)throw a;ue(1,0)}},c:function(e,t,i,r,n,s){var a=q();try{return he(e)(t,i,r,n,s)}catch(o){if(z(a),o!==o+0)throw o;ue(1,0)}},m:function(e,t){var i=q();try{return Ee(e,t)}catch(r){if(z(i),r!==r+0)throw r;ue(1,0)}},f:function(e,t){var i=q();try{he(e)(t)}catch(r){if(z(i),r!==r+0)throw r;ue(1,0)}},w:function(e,t,i){var r=q();try{he(e)(t,i)}catch(n){if(z(r),n!==n+0)throw n;ue(1,0)}},i:function(e,t,i,r){var n=q();try{he(e)(t,i,r)}catch(s){if(z(n),s!==s+0)throw s;ue(1,0)}},n:function(e,t,i,r,n){var s=q();try{ge(e,t,i,r,n)}catch(a){if(z(s),a!==a+0)throw a;ue(1,0)}},h:function(e,t){window.postResult(b.slice(e,e+t))}},de=function(){var e,t,i,r,n={a:ce};function s(e,t){var i;return de=e.exports,y=de.x,N(),ne=de.z,i=de.y,P.unshift(i),function(e){if(O--,c.monitorRunDependencies&&c.monitorRunDependencies(O),0==O&&(null!==D&&(clearInterval(D),D=null),M)){var t=M;M=null,t()}}(),de}if(O++,c.monitorRunDependencies&&c.monitorRunDependencies(O),c.instantiateWasm)try{return c.instantiateWasm(n,s)}catch(o){S(`Module.instantiateWasm callback failed with error: ${o}`),a(o)}return B||(B=G()),(e=v,t=B,i=n,r=function(e){s(e.instance)},e||"function"!=typeof WebAssembly.instantiateStreaming||V(t)||k(t)||f||"function"!=typeof fetch?Y(t,i,r):fetch(t,{credentials:"same-origin"}).then(e=>WebAssembly.instantiateStreaming(e,i).then(r,function(e){return S(`wasm streaming compile failed: ${e}`),S("falling back to ArrayBuffer instantiation"),Y(t,i,r)}))).catch(a),{}}(),ue=(c._malloc=(e=>(c._malloc=de.A)(e)),c._free=(e=>(c._free=de.B)(e)),c._openArchive=((e,t)=>(c._openArchive=de.C)(e,t)),c._hasFile=((e,t)=>(c._hasFile=de.D)(e,t)),c._loadFile=((e,t,i)=>(c._loadFile=de.E)(e,t,i)),c._loadImage=((e,t)=>(c._loadImage=de.F)(e,t)),c._loadJASS=(e=>(c._loadJASS=de.G)(e)),(e,t)=>(ue=de.H)(e,t)),me=e=>(me=de.I)(e),fe=()=>(fe=de.J)(),pe=e=>(pe=de.K)(e),Ee=c.dynCall_ji=((e,t)=>(Ee=c.dynCall_ji=de.L)(e,t)),ge=c.dynCall_viji=((e,t,i,r,n)=>(ge=c.dynCall_viji=de.M)(e,t,i,r,n));function Ae(){function e(){se||(se=!0,c.calledRun=!0,L||(!0,W(P),s(c),c.onRuntimeInitialized&&c.onRuntimeInitialized(),function(){if(c.postRun)for("function"==typeof c.postRun&&(c.postRun=[c.postRun]);c.postRun.length;)U(c.postRun.shift());W(C)}()))}O>0||(!function(){if(c.preRun)for("function"==typeof c.preRun&&(c.preRun=[c.preRun]);c.preRun.length;)e=c.preRun.shift(),x.unshift(e);var e;W(x)}(),O>0||(c.setStatus?(c.setStatus("Running..."),setTimeout(function(){setTimeout(function(){c.setStatus("")},1),e()},1)):e()))}if(M=function e(){se||Ae(),se||(M=e)},c.preInit)for("function"==typeof c.preInit&&(c.preInit=[c.preInit]);c.preInit.length>0;)c.preInit.pop()();return Ae(),c.ready=new Promise(function(e,t){delete c.then,c.onAbort=function(e){t(e)},U(function(){e(c)})}),d}})();e.exports=s}).call(this,"/index.js",i(188),"/")},235:function(e,t,i){e.exports=function(){return new Worker(i.p+"604ee34ce8efa1c49074.worker.js")}},242:function(e,t,i){e.exports=i(432)},247:function(e,t,i){},254:function(e,t,i){},261:function(e,t,i){},262:function(e,t,i){},273:function(e,t,i){},425:function(e,t,i){const{createToken:r,Lexer:n}=i(192),s=[r({name:"comment",pattern:/\/\/.*/,group:n.SKIPPED}),r({name:"whitespace",pattern:/\s+/,group:n.SKIPPED}),r({name:"RAWCODE",pattern:/('''.*?''')/}),r({name:"COMMA",pattern:/,/}),r({name:"IF",pattern:/if/}),r({name:"THEN",pattern:/then/}),r({name:"ELSEIF",pattern:/elseif/}),r({name:"ELSE",pattern:/else/}),r({name:"ENDIF",pattern:/endif/}),r({name:"GLOBALS",pattern:/globals/}),r({name:"ENDGLOBALS",pattern:/endglobals/}),r({name:"FUNCTION",pattern:/function/}),r({name:"TAKES",pattern:/takes/}),r({name:"TYPE",pattern:/type/}),r({name:"ARRAY",pattern:/array/}),r({name:"NULL",pattern:/null/}),r({name:"TRUE",pattern:/true/}),r({name:"FALSE",pattern:/false/}),r({name:"CONSTANT",pattern:/constant/}),r({name:"HEX_CONSTANT",pattern:/0x(([0-9]|[a-f]|[A-F])*)/}),r({name:"DOLLAR_HEX_CONSTANT",pattern:/\$(([0-9]|[A-F])*)/}),r({name:"RETURNS",pattern:/returns/}),r({name:"RETURN",pattern:/return/}),r({name:"EXTENDS",pattern:/extends/}),r({name:"NATIVE",pattern:/native/}),r({name:"ENDFUNCTION",pattern:/endfunction/}),r({name:"AND",pattern:/and(?=[\s()])/}),r({name:"OR",pattern:/or(?=[\s()])/}),r({name:"LOCAL",pattern:/local/}),r({name:"SET",pattern:/set(?=\s)/}),r({name:"LOOP",pattern:/loop(?=\s)/}),r({name:"EXITWHEN",pattern:/exitwhen/}),r({name:"ENDLOOP",pattern:/endloop/}),r({name:"NOTHING",pattern:/nothing/}),r({name:"NOT",pattern:/not/}),r({name:"CALL",pattern:/call(?=\s)/}),r({name:"MULT",pattern:/\*/}),r({name:"DIV",pattern:/\//}),r({name:"PLUS",pattern:/\+/}),r({name:"MINUS",pattern:/-/}),r({name:"ID",pattern:/[a-zA-Z]\w*/}),r({name:"LPAREN",pattern:/\(/}),r({name:"RPAREN",pattern:/\)/}),r({name:"LSQUAREPAREN",pattern:/\[/}),r({name:"RSQUAREPAREN",pattern:/\]/}),r({name:"NOTEQUALS",pattern:/!=/}),r({name:"EQUALSEQUALS",pattern:/==/}),r({name:"LESSOREQUALS",pattern:/<=/}),r({name:"GREATEROREQUALS",pattern:/>=/}),r({name:"EQUALS",pattern:/=/}),r({name:"LESS",pattern:/</}),r({name:"GREATER",pattern:/>/}),r({name:"IDLITERAL",pattern:/'.*?'/}),r({name:"STRINGLITERAL",pattern:/"[\s\S]*?"/,line_breaks:!0}),r({name:"REAL",pattern:/[0-9]+\.[0-9]+/}),r({name:"INTEGER",pattern:/[0-9]+/}),r({name:"NL",pattern:/[\r\n]+/})],a={};s.forEach(e=>{a[e.name]=e});const o=new n(s);e.exports={JassLexer:o,tokenVocabulary:a}},426:function(e,t,i){},428:function(e,t,i){},429:function(e,t,i){},430:function(e,t,i){},431:function(e,t,i){},432:function(e,t,i){"use strict";i.r(t);var r={};i.r(r),i.d(r,"FALSE",function(){return rn}),i.d(r,"TRUE",function(){return nn}),i.d(r,"JASS_MAX_ARRAY_SIZE",function(){return sn}),i.d(r,"PLAYER_NEUTRAL_PASSIVE",function(){return an}),i.d(r,"PLAYER_NEUTRAL_AGGRESSIVE",function(){return on}),i.d(r,"PLAYER_COLOR_RED",function(){return ln}),i.d(r,"PLAYER_COLOR_BLUE",function(){return hn}),i.d(r,"PLAYER_COLOR_CYAN",function(){return cn}),i.d(r,"PLAYER_COLOR_PURPLE",function(){return dn}),i.d(r,"PLAYER_COLOR_YELLOW",function(){return un}),i.d(r,"PLAYER_COLOR_ORANGE",function(){return mn}),i.d(r,"PLAYER_COLOR_GREEN",function(){return fn}),i.d(r,"PLAYER_COLOR_PINK",function(){return pn}),i.d(r,"PLAYER_COLOR_LIGHT_GRAY",function(){return En}),i.d(r,"PLAYER_COLOR_LIGHT_BLUE",function(){return gn}),i.d(r,"PLAYER_COLOR_AQUA",function(){return An}),i.d(r,"PLAYER_COLOR_BROWN",function(){return _n}),i.d(r,"RACE_HUMAN",function(){return Tn}),i.d(r,"RACE_ORC",function(){return vn}),i.d(r,"RACE_UNDEAD",function(){return yn}),i.d(r,"RACE_NIGHTELF",function(){return wn}),i.d(r,"RACE_DEMON",function(){return Sn}),i.d(r,"RACE_OTHER",function(){return Rn}),i.d(r,"PLAYER_GAME_RESULT_VICTORY",function(){return bn}),i.d(r,"PLAYER_GAME_RESULT_DEFEAT",function(){return In}),i.d(r,"PLAYER_GAME_RESULT_TIE",function(){return Ln}),i.d(r,"PLAYER_GAME_RESULT_NEUTRAL",function(){return Nn}),i.d(r,"ALLIANCE_PASSIVE",function(){return xn}),i.d(r,"ALLIANCE_HELP_REQUEST",function(){return Pn}),i.d(r,"ALLIANCE_HELP_RESPONSE",function(){return Cn}),i.d(r,"ALLIANCE_SHARED_XP",function(){return Un}),i.d(r,"ALLIANCE_SHARED_SPELLS",function(){return On}),i.d(r,"ALLIANCE_SHARED_VISION",function(){return Dn}),i.d(r,"ALLIANCE_SHARED_CONTROL",function(){return Mn}),i.d(r,"ALLIANCE_SHARED_ADVANCED_CONTROL",function(){return Fn}),i.d(r,"ALLIANCE_RESCUABLE",function(){return Bn}),i.d(r,"ALLIANCE_SHARED_VISION_FORCED",function(){return Vn}),i.d(r,"VERSION_REIGN_OF_CHAOS",function(){return kn}),i.d(r,"VERSION_FROZEN_THRONE",function(){return Gn}),i.d(r,"ATTACK_TYPE_NORMAL",function(){return jn}),i.d(r,"ATTACK_TYPE_MELEE",function(){return Yn}),i.d(r,"ATTACK_TYPE_PIERCE",function(){return Hn}),i.d(r,"ATTACK_TYPE_SIEGE",function(){return Wn}),i.d(r,"ATTACK_TYPE_MAGIC",function(){return Kn}),i.d(r,"ATTACK_TYPE_CHAOS",function(){return zn}),i.d(r,"ATTACK_TYPE_HERO",function(){return qn}),i.d(r,"DAMAGE_TYPE_UNKNOWN",function(){return Xn}),i.d(r,"DAMAGE_TYPE_NORMAL",function(){return Jn}),i.d(r,"DAMAGE_TYPE_ENHANCED",function(){return Qn}),i.d(r,"DAMAGE_TYPE_FIRE",function(){return $n}),i.d(r,"DAMAGE_TYPE_COLD",function(){return Zn}),i.d(r,"DAMAGE_TYPE_LIGHTNING",function(){return es}),i.d(r,"DAMAGE_TYPE_POISON",function(){return ts}),i.d(r,"DAMAGE_TYPE_DISEASE",function(){return is}),i.d(r,"DAMAGE_TYPE_DIVINE",function(){return rs}),i.d(r,"DAMAGE_TYPE_MAGIC",function(){return ns}),i.d(r,"DAMAGE_TYPE_SONIC",function(){return ss}),i.d(r,"DAMAGE_TYPE_ACID",function(){return as}),i.d(r,"DAMAGE_TYPE_FORCE",function(){return os}),i.d(r,"DAMAGE_TYPE_DEATH",function(){return ls}),i.d(r,"DAMAGE_TYPE_MIND",function(){return hs}),i.d(r,"DAMAGE_TYPE_PLANT",function(){return cs}),i.d(r,"DAMAGE_TYPE_DEFENSIVE",function(){return ds}),i.d(r,"DAMAGE_TYPE_DEMOLITION",function(){return us}),i.d(r,"DAMAGE_TYPE_SLOW_POISON",function(){return ms}),i.d(r,"DAMAGE_TYPE_SPIRIT_LINK",function(){return fs}),i.d(r,"DAMAGE_TYPE_SHADOW_STRIKE",function(){return ps}),i.d(r,"DAMAGE_TYPE_UNIVERSAL",function(){return Es}),i.d(r,"WEAPON_TYPE_WHOKNOWS",function(){return gs}),i.d(r,"WEAPON_TYPE_METAL_LIGHT_CHOP",function(){return As}),i.d(r,"WEAPON_TYPE_METAL_MEDIUM_CHOP",function(){return _s}),i.d(r,"WEAPON_TYPE_METAL_HEAVY_CHOP",function(){return Ts}),i.d(r,"WEAPON_TYPE_METAL_LIGHT_SLICE",function(){return vs}),i.d(r,"WEAPON_TYPE_METAL_MEDIUM_SLICE",function(){return ys}),i.d(r,"WEAPON_TYPE_METAL_HEAVY_SLICE",function(){return ws}),i.d(r,"WEAPON_TYPE_METAL_MEDIUM_BASH",function(){return Ss}),i.d(r,"WEAPON_TYPE_METAL_HEAVY_BASH",function(){return Rs}),i.d(r,"WEAPON_TYPE_METAL_MEDIUM_STAB",function(){return bs}),i.d(r,"WEAPON_TYPE_METAL_HEAVY_STAB",function(){return Is}),i.d(r,"WEAPON_TYPE_WOOD_LIGHT_SLICE",function(){return Ls}),i.d(r,"WEAPON_TYPE_WOOD_MEDIUM_SLICE",function(){return Ns}),i.d(r,"WEAPON_TYPE_WOOD_HEAVY_SLICE",function(){return xs}),i.d(r,"WEAPON_TYPE_WOOD_LIGHT_BASH",function(){return Ps}),i.d(r,"WEAPON_TYPE_WOOD_MEDIUM_BASH",function(){return Cs}),i.d(r,"WEAPON_TYPE_WOOD_HEAVY_BASH",function(){return Us}),i.d(r,"WEAPON_TYPE_WOOD_LIGHT_STAB",function(){return Os}),i.d(r,"WEAPON_TYPE_WOOD_MEDIUM_STAB",function(){return Ds}),i.d(r,"WEAPON_TYPE_CLAW_LIGHT_SLICE",function(){return Ms}),i.d(r,"WEAPON_TYPE_CLAW_MEDIUM_SLICE",function(){return Fs}),i.d(r,"WEAPON_TYPE_CLAW_HEAVY_SLICE",function(){return Bs}),i.d(r,"WEAPON_TYPE_AXE_MEDIUM_CHOP",function(){return Vs}),i.d(r,"WEAPON_TYPE_ROCK_HEAVY_BASH",function(){return ks}),i.d(r,"PATHING_TYPE_ANY",function(){return Gs}),i.d(r,"PATHING_TYPE_WALKABILITY",function(){return js}),i.d(r,"PATHING_TYPE_FLYABILITY",function(){return Ys}),i.d(r,"PATHING_TYPE_BUILDABILITY",function(){return Hs}),i.d(r,"PATHING_TYPE_PEONHARVESTPATHING",function(){return Ws}),i.d(r,"PATHING_TYPE_BLIGHTPATHING",function(){return Ks}),i.d(r,"PATHING_TYPE_FLOATABILITY",function(){return zs}),i.d(r,"PATHING_TYPE_AMPHIBIOUSPATHING",function(){return qs}),i.d(r,"MOUSE_BUTTON_TYPE_LEFT",function(){return Xs}),i.d(r,"MOUSE_BUTTON_TYPE_MIDDLE",function(){return Js}),i.d(r,"MOUSE_BUTTON_TYPE_RIGHT",function(){return Qs}),i.d(r,"RACE_PREF_HUMAN",function(){return $s}),i.d(r,"RACE_PREF_ORC",function(){return Zs}),i.d(r,"RACE_PREF_NIGHTELF",function(){return ea}),i.d(r,"RACE_PREF_UNDEAD",function(){return ta}),i.d(r,"RACE_PREF_DEMON",function(){return ia}),i.d(r,"RACE_PREF_RANDOM",function(){return ra}),i.d(r,"RACE_PREF_USER_SELECTABLE",function(){return na}),i.d(r,"MAP_CONTROL_USER",function(){return sa}),i.d(r,"MAP_CONTROL_COMPUTER",function(){return aa}),i.d(r,"MAP_CONTROL_RESCUABLE",function(){return oa}),i.d(r,"MAP_CONTROL_NEUTRAL",function(){return la}),i.d(r,"MAP_CONTROL_CREEP",function(){return ha}),i.d(r,"MAP_CONTROL_NONE",function(){return ca}),i.d(r,"GAME_TYPE_MELEE",function(){return da}),i.d(r,"GAME_TYPE_FFA",function(){return ua}),i.d(r,"GAME_TYPE_USE_MAP_SETTINGS",function(){return ma}),i.d(r,"GAME_TYPE_BLIZ",function(){return fa}),i.d(r,"GAME_TYPE_ONE_ON_ONE",function(){return pa}),i.d(r,"GAME_TYPE_TWO_TEAM_PLAY",function(){return Ea}),i.d(r,"GAME_TYPE_THREE_TEAM_PLAY",function(){return ga}),i.d(r,"GAME_TYPE_FOUR_TEAM_PLAY",function(){return Aa}),i.d(r,"MAP_FOG_HIDE_TERRAIN",function(){return _a}),i.d(r,"MAP_FOG_MAP_EXPLORED",function(){return Ta}),i.d(r,"MAP_FOG_ALWAYS_VISIBLE",function(){return va}),i.d(r,"MAP_USE_HANDICAPS",function(){return ya}),i.d(r,"MAP_OBSERVERS",function(){return wa}),i.d(r,"MAP_OBSERVERS_ON_DEATH",function(){return Sa}),i.d(r,"MAP_FIXED_COLORS",function(){return Ra}),i.d(r,"MAP_LOCK_RESOURCE_TRADING",function(){return ba}),i.d(r,"MAP_RESOURCE_TRADING_ALLIES_ONLY",function(){return Ia}),i.d(r,"MAP_LOCK_ALLIANCE_CHANGES",function(){return La}),i.d(r,"MAP_ALLIANCE_CHANGES_HIDDEN",function(){return Na}),i.d(r,"MAP_CHEATS",function(){return xa}),i.d(r,"MAP_CHEATS_HIDDEN",function(){return Pa}),i.d(r,"MAP_LOCK_SPEED",function(){return Ca}),i.d(r,"MAP_LOCK_RANDOM_SEED",function(){return Ua}),i.d(r,"MAP_SHARED_ADVANCED_CONTROL",function(){return Oa}),i.d(r,"MAP_RANDOM_HERO",function(){return Da}),i.d(r,"MAP_RANDOM_RACES",function(){return Ma}),i.d(r,"MAP_RELOADED",function(){return Fa}),i.d(r,"MAP_PLACEMENT_RANDOM",function(){return Ba}),i.d(r,"MAP_PLACEMENT_FIXED",function(){return Va}),i.d(r,"MAP_PLACEMENT_USE_MAP_SETTINGS",function(){return ka}),i.d(r,"MAP_PLACEMENT_TEAMS_TOGETHER",function(){return Ga}),i.d(r,"MAP_LOC_PRIO_LOW",function(){return ja}),i.d(r,"MAP_LOC_PRIO_HIGH",function(){return Ya}),i.d(r,"MAP_LOC_PRIO_NOT",function(){return Ha}),i.d(r,"MAP_DENSITY_NONE",function(){return Wa}),i.d(r,"MAP_DENSITY_LIGHT",function(){return Ka}),i.d(r,"MAP_DENSITY_MEDIUM",function(){return za}),i.d(r,"MAP_DENSITY_HEAVY",function(){return qa}),i.d(r,"MAP_DIFFICULTY_EASY",function(){return Xa}),i.d(r,"MAP_DIFFICULTY_NORMAL",function(){return Ja}),i.d(r,"MAP_DIFFICULTY_HARD",function(){return Qa}),i.d(r,"MAP_DIFFICULTY_INSANE",function(){return $a}),i.d(r,"MAP_SPEED_SLOWEST",function(){return Za}),i.d(r,"MAP_SPEED_SLOW",function(){return eo}),i.d(r,"MAP_SPEED_NORMAL",function(){return to}),i.d(r,"MAP_SPEED_FAST",function(){return io}),i.d(r,"MAP_SPEED_FASTEST",function(){return ro}),i.d(r,"PLAYER_SLOT_STATE_EMPTY",function(){return no}),i.d(r,"PLAYER_SLOT_STATE_PLAYING",function(){return so}),i.d(r,"PLAYER_SLOT_STATE_LEFT",function(){return ao}),i.d(r,"SOUND_VOLUMEGROUP_UNITMOVEMENT",function(){return oo}),i.d(r,"SOUND_VOLUMEGROUP_UNITSOUNDS",function(){return lo}),i.d(r,"SOUND_VOLUMEGROUP_COMBAT",function(){return ho}),i.d(r,"SOUND_VOLUMEGROUP_SPELLS",function(){return co}),i.d(r,"SOUND_VOLUMEGROUP_UI",function(){return uo}),i.d(r,"SOUND_VOLUMEGROUP_MUSIC",function(){return mo}),i.d(r,"SOUND_VOLUMEGROUP_AMBIENTSOUNDS",function(){return fo}),i.d(r,"SOUND_VOLUMEGROUP_FIRE",function(){return po}),i.d(r,"GAME_STATE_DIVINE_INTERVENTION",function(){return Eo}),i.d(r,"GAME_STATE_DISCONNECTED",function(){return go}),i.d(r,"GAME_STATE_TIME_OF_DAY",function(){return Ao}),i.d(r,"PLAYER_STATE_GAME_RESULT",function(){return _o}),i.d(r,"PLAYER_STATE_RESOURCE_GOLD",function(){return To}),i.d(r,"PLAYER_STATE_RESOURCE_LUMBER",function(){return vo}),i.d(r,"PLAYER_STATE_RESOURCE_HERO_TOKENS",function(){return yo}),i.d(r,"PLAYER_STATE_RESOURCE_FOOD_CAP",function(){return wo}),i.d(r,"PLAYER_STATE_RESOURCE_FOOD_USED",function(){return So}),i.d(r,"PLAYER_STATE_FOOD_CAP_CEILING",function(){return Ro}),i.d(r,"PLAYER_STATE_GIVES_BOUNTY",function(){return bo}),i.d(r,"PLAYER_STATE_ALLIED_VICTORY",function(){return Io}),i.d(r,"PLAYER_STATE_PLACED",function(){return Lo}),i.d(r,"PLAYER_STATE_OBSERVER_ON_DEATH",function(){return No}),i.d(r,"PLAYER_STATE_OBSERVER",function(){return xo}),i.d(r,"PLAYER_STATE_UNFOLLOWABLE",function(){return Po}),i.d(r,"PLAYER_STATE_GOLD_UPKEEP_RATE",function(){return Co}),i.d(r,"PLAYER_STATE_LUMBER_UPKEEP_RATE",function(){return Uo}),i.d(r,"PLAYER_STATE_GOLD_GATHERED",function(){return Oo}),i.d(r,"PLAYER_STATE_LUMBER_GATHERED",function(){return Do}),i.d(r,"PLAYER_STATE_NO_CREEP_SLEEP",function(){return Mo}),i.d(r,"UNIT_STATE_LIFE",function(){return Fo}),i.d(r,"UNIT_STATE_MAX_LIFE",function(){return Bo}),i.d(r,"UNIT_STATE_MANA",function(){return Vo}),i.d(r,"UNIT_STATE_MAX_MANA",function(){return ko}),i.d(r,"AI_DIFFICULTY_NEWBIE",function(){return Go}),i.d(r,"AI_DIFFICULTY_NORMAL",function(){return jo}),i.d(r,"AI_DIFFICULTY_INSANE",function(){return Yo}),i.d(r,"PLAYER_SCORE_UNITS_TRAINED",function(){return Ho}),i.d(r,"PLAYER_SCORE_UNITS_KILLED",function(){return Wo}),i.d(r,"PLAYER_SCORE_STRUCT_BUILT",function(){return Ko}),i.d(r,"PLAYER_SCORE_STRUCT_RAZED",function(){return zo}),i.d(r,"PLAYER_SCORE_TECH_PERCENT",function(){return qo}),i.d(r,"PLAYER_SCORE_FOOD_MAXPROD",function(){return Xo}),i.d(r,"PLAYER_SCORE_FOOD_MAXUSED",function(){return Jo}),i.d(r,"PLAYER_SCORE_HEROES_KILLED",function(){return Qo}),i.d(r,"PLAYER_SCORE_ITEMS_GAINED",function(){return $o}),i.d(r,"PLAYER_SCORE_MERCS_HIRED",function(){return Zo}),i.d(r,"PLAYER_SCORE_GOLD_MINED_TOTAL",function(){return el}),i.d(r,"PLAYER_SCORE_GOLD_MINED_UPKEEP",function(){return tl}),i.d(r,"PLAYER_SCORE_GOLD_LOST_UPKEEP",function(){return il}),i.d(r,"PLAYER_SCORE_GOLD_LOST_TAX",function(){return rl}),i.d(r,"PLAYER_SCORE_GOLD_GIVEN",function(){return nl}),i.d(r,"PLAYER_SCORE_GOLD_RECEIVED",function(){return sl}),i.d(r,"PLAYER_SCORE_LUMBER_TOTAL",function(){return al}),i.d(r,"PLAYER_SCORE_LUMBER_LOST_UPKEEP",function(){return ol}),i.d(r,"PLAYER_SCORE_LUMBER_LOST_TAX",function(){return ll}),i.d(r,"PLAYER_SCORE_LUMBER_GIVEN",function(){return hl}),i.d(r,"PLAYER_SCORE_LUMBER_RECEIVED",function(){return cl}),i.d(r,"PLAYER_SCORE_UNIT_TOTAL",function(){return dl}),i.d(r,"PLAYER_SCORE_HERO_TOTAL",function(){return ul}),i.d(r,"PLAYER_SCORE_RESOURCE_TOTAL",function(){return ml}),i.d(r,"PLAYER_SCORE_TOTAL",function(){return fl}),i.d(r,"EVENT_GAME_VICTORY",function(){return pl}),i.d(r,"EVENT_GAME_END_LEVEL",function(){return El}),i.d(r,"EVENT_GAME_VARIABLE_LIMIT",function(){return gl}),i.d(r,"EVENT_GAME_STATE_LIMIT",function(){return Al}),i.d(r,"EVENT_GAME_TIMER_EXPIRED",function(){return _l}),i.d(r,"EVENT_GAME_ENTER_REGION",function(){return Tl}),i.d(r,"EVENT_GAME_LEAVE_REGION",function(){return vl}),i.d(r,"EVENT_GAME_TRACKABLE_HIT",function(){return yl}),i.d(r,"EVENT_GAME_TRACKABLE_TRACK",function(){return wl}),i.d(r,"EVENT_GAME_SHOW_SKILL",function(){return Sl}),i.d(r,"EVENT_GAME_BUILD_SUBMENU",function(){return Rl}),i.d(r,"EVENT_PLAYER_STATE_LIMIT",function(){return bl}),i.d(r,"EVENT_PLAYER_ALLIANCE_CHANGED",function(){return Il}),i.d(r,"EVENT_PLAYER_DEFEAT",function(){return Ll}),i.d(r,"EVENT_PLAYER_VICTORY",function(){return Nl}),i.d(r,"EVENT_PLAYER_LEAVE",function(){return xl}),i.d(r,"EVENT_PLAYER_CHAT",function(){return Pl}),i.d(r,"EVENT_PLAYER_END_CINEMATIC",function(){return Cl}),i.d(r,"EVENT_PLAYER_UNIT_ATTACKED",function(){return Ul}),i.d(r,"EVENT_PLAYER_UNIT_RESCUED",function(){return Ol}),i.d(r,"EVENT_PLAYER_UNIT_DEATH",function(){return Dl}),i.d(r,"EVENT_PLAYER_UNIT_DECAY",function(){return Ml}),i.d(r,"EVENT_PLAYER_UNIT_DETECTED",function(){return Fl}),i.d(r,"EVENT_PLAYER_UNIT_HIDDEN",function(){return Bl}),i.d(r,"EVENT_PLAYER_UNIT_SELECTED",function(){return Vl}),i.d(r,"EVENT_PLAYER_UNIT_DESELECTED",function(){return kl}),i.d(r,"EVENT_PLAYER_UNIT_CONSTRUCT_START",function(){return Gl}),i.d(r,"EVENT_PLAYER_UNIT_CONSTRUCT_CANCEL",function(){return jl}),i.d(r,"EVENT_PLAYER_UNIT_CONSTRUCT_FINISH",function(){return Yl}),i.d(r,"EVENT_PLAYER_UNIT_UPGRADE_START",function(){return Hl}),i.d(r,"EVENT_PLAYER_UNIT_UPGRADE_CANCEL",function(){return Wl}),i.d(r,"EVENT_PLAYER_UNIT_UPGRADE_FINISH",function(){return Kl}),i.d(r,"EVENT_PLAYER_UNIT_TRAIN_START",function(){return zl}),i.d(r,"EVENT_PLAYER_UNIT_TRAIN_CANCEL",function(){return ql}),i.d(r,"EVENT_PLAYER_UNIT_TRAIN_FINISH",function(){return Xl}),i.d(r,"EVENT_PLAYER_UNIT_RESEARCH_START",function(){return Jl}),i.d(r,"EVENT_PLAYER_UNIT_RESEARCH_CANCEL",function(){return Ql}),i.d(r,"EVENT_PLAYER_UNIT_RESEARCH_FINISH",function(){return $l}),i.d(r,"EVENT_PLAYER_UNIT_ISSUED_ORDER",function(){return Zl}),i.d(r,"EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER",function(){return eh}),i.d(r,"EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER",function(){return th}),i.d(r,"EVENT_PLAYER_UNIT_ISSUED_UNIT_ORDER",function(){return ih}),i.d(r,"EVENT_PLAYER_HERO_LEVEL",function(){return rh}),i.d(r,"EVENT_PLAYER_HERO_SKILL",function(){return nh}),i.d(r,"EVENT_PLAYER_HERO_REVIVABLE",function(){return sh}),i.d(r,"EVENT_PLAYER_HERO_REVIVE_START",function(){return ah}),i.d(r,"EVENT_PLAYER_HERO_REVIVE_CANCEL",function(){return oh}),i.d(r,"EVENT_PLAYER_HERO_REVIVE_FINISH",function(){return lh}),i.d(r,"EVENT_PLAYER_UNIT_SUMMON",function(){return hh}),i.d(r,"EVENT_PLAYER_UNIT_DROP_ITEM",function(){return ch}),i.d(r,"EVENT_PLAYER_UNIT_PICKUP_ITEM",function(){return dh}),i.d(r,"EVENT_PLAYER_UNIT_USE_ITEM",function(){return uh}),i.d(r,"EVENT_PLAYER_UNIT_LOADED",function(){return mh}),i.d(r,"EVENT_UNIT_DAMAGED",function(){return fh}),i.d(r,"EVENT_UNIT_DEATH",function(){return ph}),i.d(r,"EVENT_UNIT_DECAY",function(){return Eh}),i.d(r,"EVENT_UNIT_DETECTED",function(){return gh}),i.d(r,"EVENT_UNIT_HIDDEN",function(){return Ah}),i.d(r,"EVENT_UNIT_SELECTED",function(){return _h}),i.d(r,"EVENT_UNIT_DESELECTED",function(){return Th}),i.d(r,"EVENT_UNIT_STATE_LIMIT",function(){return vh}),i.d(r,"EVENT_UNIT_ACQUIRED_TARGET",function(){return yh}),i.d(r,"EVENT_UNIT_TARGET_IN_RANGE",function(){return wh}),i.d(r,"EVENT_UNIT_ATTACKED",function(){return Sh}),i.d(r,"EVENT_UNIT_RESCUED",function(){return Rh}),i.d(r,"EVENT_UNIT_CONSTRUCT_CANCEL",function(){return bh}),i.d(r,"EVENT_UNIT_CONSTRUCT_FINISH",function(){return Ih}),i.d(r,"EVENT_UNIT_UPGRADE_START",function(){return Lh}),i.d(r,"EVENT_UNIT_UPGRADE_CANCEL",function(){return Nh}),i.d(r,"EVENT_UNIT_UPGRADE_FINISH",function(){return xh}),i.d(r,"EVENT_UNIT_TRAIN_START",function(){return Ph}),i.d(r,"EVENT_UNIT_TRAIN_CANCEL",function(){return Ch}),i.d(r,"EVENT_UNIT_TRAIN_FINISH",function(){return Uh}),i.d(r,"EVENT_UNIT_RESEARCH_START",function(){return Oh}),i.d(r,"EVENT_UNIT_RESEARCH_CANCEL",function(){return Dh}),i.d(r,"EVENT_UNIT_RESEARCH_FINISH",function(){return Mh}),i.d(r,"EVENT_UNIT_ISSUED_ORDER",function(){return Fh}),i.d(r,"EVENT_UNIT_ISSUED_POINT_ORDER",function(){return Bh}),i.d(r,"EVENT_UNIT_ISSUED_TARGET_ORDER",function(){return Vh}),i.d(r,"EVENT_UNIT_HERO_LEVEL",function(){return kh}),i.d(r,"EVENT_UNIT_HERO_SKILL",function(){return Gh}),i.d(r,"EVENT_UNIT_HERO_REVIVABLE",function(){return jh}),i.d(r,"EVENT_UNIT_HERO_REVIVE_START",function(){return Yh}),i.d(r,"EVENT_UNIT_HERO_REVIVE_CANCEL",function(){return Hh}),i.d(r,"EVENT_UNIT_HERO_REVIVE_FINISH",function(){return Wh}),i.d(r,"EVENT_UNIT_SUMMON",function(){return Kh}),i.d(r,"EVENT_UNIT_DROP_ITEM",function(){return zh}),i.d(r,"EVENT_UNIT_PICKUP_ITEM",function(){return qh}),i.d(r,"EVENT_UNIT_USE_ITEM",function(){return Xh}),i.d(r,"EVENT_UNIT_LOADED",function(){return Jh}),i.d(r,"EVENT_WIDGET_DEATH",function(){return Qh}),i.d(r,"EVENT_DIALOG_BUTTON_CLICK",function(){return $h}),i.d(r,"EVENT_DIALOG_CLICK",function(){return Zh}),i.d(r,"EVENT_GAME_LOADED",function(){return ec}),i.d(r,"EVENT_GAME_TOURNAMENT_FINISH_SOON",function(){return tc}),i.d(r,"EVENT_GAME_TOURNAMENT_FINISH_NOW",function(){return ic}),i.d(r,"EVENT_GAME_SAVE",function(){return rc}),i.d(r,"EVENT_PLAYER_ARROW_LEFT_DOWN",function(){return nc}),i.d(r,"EVENT_PLAYER_ARROW_LEFT_UP",function(){return sc}),i.d(r,"EVENT_PLAYER_ARROW_RIGHT_DOWN",function(){return ac}),i.d(r,"EVENT_PLAYER_ARROW_RIGHT_UP",function(){return oc}),i.d(r,"EVENT_PLAYER_ARROW_DOWN_DOWN",function(){return lc}),i.d(r,"EVENT_PLAYER_ARROW_DOWN_UP",function(){return hc}),i.d(r,"EVENT_PLAYER_ARROW_UP_DOWN",function(){return cc}),i.d(r,"EVENT_PLAYER_ARROW_UP_UP",function(){return dc}),i.d(r,"EVENT_PLAYER_UNIT_SELL",function(){return uc}),i.d(r,"EVENT_PLAYER_UNIT_CHANGE_OWNER",function(){return mc}),i.d(r,"EVENT_PLAYER_UNIT_SELL_ITEM",function(){return fc}),i.d(r,"EVENT_PLAYER_UNIT_SPELL_CHANNEL",function(){return pc}),i.d(r,"EVENT_PLAYER_UNIT_SPELL_CAST",function(){return Ec}),i.d(r,"EVENT_PLAYER_UNIT_SPELL_EFFECT",function(){return gc}),i.d(r,"EVENT_PLAYER_UNIT_SPELL_FINISH",function(){return Ac}),i.d(r,"EVENT_PLAYER_UNIT_SPELL_ENDCAST",function(){return _c}),i.d(r,"EVENT_PLAYER_UNIT_PAWN_ITEM",function(){return Tc}),i.d(r,"EVENT_UNIT_SELL",function(){return vc}),i.d(r,"EVENT_UNIT_CHANGE_OWNER",function(){return yc}),i.d(r,"EVENT_UNIT_SELL_ITEM",function(){return wc}),i.d(r,"EVENT_UNIT_SPELL_CHANNEL",function(){return Sc}),i.d(r,"EVENT_UNIT_SPELL_CAST",function(){return Rc}),i.d(r,"EVENT_UNIT_SPELL_EFFECT",function(){return bc}),i.d(r,"EVENT_UNIT_SPELL_FINISH",function(){return Ic}),i.d(r,"EVENT_UNIT_SPELL_ENDCAST",function(){return Lc}),i.d(r,"EVENT_UNIT_PAWN_ITEM",function(){return Nc}),i.d(r,"LESS_THAN",function(){return xc}),i.d(r,"LESS_THAN_OR_EQUAL",function(){return Pc}),i.d(r,"EQUAL",function(){return Cc}),i.d(r,"GREATER_THAN_OR_EQUAL",function(){return Uc}),i.d(r,"GREATER_THAN",function(){return Oc}),i.d(r,"NOT_EQUAL",function(){return Dc}),i.d(r,"UNIT_TYPE_HERO",function(){return Mc}),i.d(r,"UNIT_TYPE_DEAD",function(){return Fc}),i.d(r,"UNIT_TYPE_STRUCTURE",function(){return Bc}),i.d(r,"UNIT_TYPE_FLYING",function(){return Vc}),i.d(r,"UNIT_TYPE_GROUND",function(){return kc}),i.d(r,"UNIT_TYPE_ATTACKS_FLYING",function(){return Gc}),i.d(r,"UNIT_TYPE_ATTACKS_GROUND",function(){return jc}),i.d(r,"UNIT_TYPE_MELEE_ATTACKER",function(){return Yc}),i.d(r,"UNIT_TYPE_RANGED_ATTACKER",function(){return Hc}),i.d(r,"UNIT_TYPE_GIANT",function(){return Wc}),i.d(r,"UNIT_TYPE_SUMMONED",function(){return Kc}),i.d(r,"UNIT_TYPE_STUNNED",function(){return zc}),i.d(r,"UNIT_TYPE_PLAGUED",function(){return qc}),i.d(r,"UNIT_TYPE_SNARED",function(){return Xc}),i.d(r,"UNIT_TYPE_UNDEAD",function(){return Jc}),i.d(r,"UNIT_TYPE_MECHANICAL",function(){return Qc}),i.d(r,"UNIT_TYPE_PEON",function(){return $c}),i.d(r,"UNIT_TYPE_SAPPER",function(){return Zc}),i.d(r,"UNIT_TYPE_TOWNHALL",function(){return ed}),i.d(r,"UNIT_TYPE_ANCIENT",function(){return td}),i.d(r,"UNIT_TYPE_TAUREN",function(){return id}),i.d(r,"UNIT_TYPE_POISONED",function(){return rd}),i.d(r,"UNIT_TYPE_POLYMORPHED",function(){return nd}),i.d(r,"UNIT_TYPE_SLEEPING",function(){return sd}),i.d(r,"UNIT_TYPE_RESISTANT",function(){return ad}),i.d(r,"UNIT_TYPE_ETHEREAL",function(){return od}),i.d(r,"UNIT_TYPE_MAGIC_IMMUNE",function(){return ld}),i.d(r,"ITEM_TYPE_PERMANENT",function(){return hd}),i.d(r,"ITEM_TYPE_CHARGED",function(){return cd}),i.d(r,"ITEM_TYPE_POWERUP",function(){return dd}),i.d(r,"ITEM_TYPE_ARTIFACT",function(){return ud}),i.d(r,"ITEM_TYPE_PURCHASABLE",function(){return md}),i.d(r,"ITEM_TYPE_CAMPAIGN",function(){return fd}),i.d(r,"ITEM_TYPE_MISCELLANEOUS",function(){return pd}),i.d(r,"ITEM_TYPE_UNKNOWN",function(){return Ed}),i.d(r,"ITEM_TYPE_ANY",function(){return gd}),i.d(r,"ITEM_TYPE_TOME",function(){return Ad}),i.d(r,"CAMERA_FIELD_TARGET_DISTANCE",function(){return _d}),i.d(r,"CAMERA_FIELD_FARZ",function(){return Td}),i.d(r,"CAMERA_FIELD_ANGLE_OF_ATTACK",function(){return vd}),i.d(r,"CAMERA_FIELD_FIELD_OF_VIEW",function(){return yd}),i.d(r,"CAMERA_FIELD_ROLL",function(){return wd}),i.d(r,"CAMERA_FIELD_ROTATION",function(){return Sd}),i.d(r,"CAMERA_FIELD_ZOFFSET",function(){return Rd}),i.d(r,"BLEND_MODE_NONE",function(){return bd}),i.d(r,"BLEND_MODE_DONT_CARE",function(){return Id}),i.d(r,"BLEND_MODE_KEYALPHA",function(){return Ld}),i.d(r,"BLEND_MODE_BLEND",function(){return Nd}),i.d(r,"BLEND_MODE_ADDITIVE",function(){return xd}),i.d(r,"BLEND_MODE_MODULATE",function(){return Pd}),i.d(r,"BLEND_MODE_MODULATE_2X",function(){return Cd}),i.d(r,"RARITY_FREQUENT",function(){return Ud}),i.d(r,"RARITY_RARE",function(){return Od}),i.d(r,"TEXMAP_FLAG_NONE",function(){return Dd}),i.d(r,"TEXMAP_FLAG_WRAP_U",function(){return Md}),i.d(r,"TEXMAP_FLAG_WRAP_V",function(){return Fd}),i.d(r,"TEXMAP_FLAG_WRAP_UV",function(){return Bd}),i.d(r,"FOG_OF_WAR_MASKED",function(){return Vd}),i.d(r,"FOG_OF_WAR_FOGGED",function(){return kd}),i.d(r,"FOG_OF_WAR_VISIBLE",function(){return Gd}),i.d(r,"CAMERA_MARGIN_LEFT",function(){return jd}),i.d(r,"CAMERA_MARGIN_RIGHT",function(){return Yd}),i.d(r,"CAMERA_MARGIN_TOP",function(){return Hd}),i.d(r,"CAMERA_MARGIN_BOTTOM",function(){return Wd}),i.d(r,"EFFECT_TYPE_EFFECT",function(){return Kd}),i.d(r,"EFFECT_TYPE_TARGET",function(){return zd}),i.d(r,"EFFECT_TYPE_CASTER",function(){return qd}),i.d(r,"EFFECT_TYPE_SPECIAL",function(){return Xd}),i.d(r,"EFFECT_TYPE_AREA_EFFECT",function(){return Jd}),i.d(r,"EFFECT_TYPE_MISSILE",function(){return Qd}),i.d(r,"EFFECT_TYPE_LIGHTNING",function(){return $d}),i.d(r,"SOUND_TYPE_EFFECT",function(){return Zd}),i.d(r,"SOUND_TYPE_EFFECT_LOOPED",function(){return eu}),i.d(r,"gameTypes",function(){return tu});var n=i(0),s=i.n(n),a=i(19),o=i.n(a),l=(i(247),i(248),i(20)),h=i(17),c=i(440),d=i(438),u=i(236),m=i(67),f=i(4),p=i.n(f);class E extends s.a.Component{render(){const{children:e,path:t,exact:i,strict:r,activeClassName:n,className:a,activeStyle:o,style:h,isActive:c,...d}=this.props,u=s.a.Children.only(e);return s.a.createElement(l.d,{path:t,exact:i,strict:r,children:e=>{let{location:t,match:i}=e;const r=!!(c?c(i,t):i);return s.a.cloneElement(u,{...d,className:[a,u.props.className,r?n:null].join(" ").trim(),style:r?{...h,...o}:h})}})}}E.contextTypes={router:p.a.shape({history:p.a.shape({push:p.a.func.isRequired,replace:p.a.func.isRequired,createHref:p.a.func.isRequired}).isRequired}).isRequired},E.defaultProps={exact:!1,strict:!1,activeClassName:"active"};function g(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return t.filter(e=>null!=e).reduce((e,t)=>null===e?t:function(){for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];e.apply(this,r),t.apply(this,r)},null)}i(435);var A=i(5),_=i.n(A);var T=i(42),v=i.n(T);i(254);class y extends s.a.Component{constructor(e,t){super(e,t),this.onGlobalKeyDown=(e=>{switch(e.which){case v.a.codes.f:e.ctrlKey&&(this.show(),e.preventDefault());break;case v.a.codes.f3:this.show(),e.shiftKey?this.findPrev():this.findNext(),this._input&&(this._input.focus(),this._input.select()),e.preventDefault()}}),this.hide=(()=>{this.setState({results:this.props.onSearch("",0)}),this.setState({show:!1})}),this.findNext=(()=>{this._input&&this.setState({results:this.props.onSearch(this._input.value,1)})}),this.findPrev=(()=>{this._input&&this.setState({results:this.props.onSearch(this._input.value,-1)})}),this.onKeyDown=(e=>{switch(e.which){case v.a.codes.esc:this.hide();break;case v.a.codes.enter:this.findNext()}}),this.onChange=(e=>{this.setState({results:this.props.onSearch(e.target.value,0)})}),this.state={results:null,show:!1}}componentDidMount(){document.addEventListener("keydown",this.onGlobalKeyDown)}componentWillUnmount(){document.removeEventListener("keydown",this.onGlobalKeyDown)}show(){this.setState({show:!0}),this._input&&(this._input.focus(),this._input.select())}componentDidUpdate(e,t){this.state.show&&!t.show&&this._input&&(this._input.select(),this._input.focus())}render(){const{show:e,results:t}=this.state,i=t&&t.count;return s.a.createElement("div",{className:_()("SearchBox",{"search-hidden":!e}),onKeyDown:this.onKeyDown},s.a.createElement("input",{type:"text",ref:e=>this._input=e,onChange:this.onChange}),!!t&&s.a.createElement("span",{className:"count"},t.pos+1+"/"+t.count),s.a.createElement("span",{className:"separator"}),s.a.createElement("button",{disabled:!i,onClick:this.findPrev,title:"Previous"},s.a.createElement("span",{glyph:"chevron-up"})),s.a.createElement("button",{disabled:!i,onClick:this.findNext,title:"Next"},s.a.createElement("span",{glyph:"chevron-down"})),s.a.createElement("button",{onClick:this.hide,title:"Close find bar"},s.a.createElement("span",{glyph:"remove"})))}}function w(e,t,i,r){var n;const a=Object.keys(e);return(n=class extends s.a.Component{constructor(e,t){super(e,t);const i={};a.forEach(e=>i[e]={}),this.state=i}setStateChecked(){this.unmounted||this.setState(...arguments)}updateRequests(t,i){a.forEach(r=>{const n="function"===typeof e[r]?e[r](t,i):e[r];this.state[r].request!==n&&(n.then?this.setState({[r]:{request:n}},()=>{n.then(e=>this.setStateChecked(t=>{if(t[r].request===n)return{[r]:{request:n,result:e}}}),e=>this.setStateChecked(t=>{if(t[r].request===n)return{[r]:{request:n,error:e}}}))}):this.setState({[r]:{request:n,result:n}}))})}componentDidMount(){this.updateRequests(this.props,this.context)}componentDidUpdate(){this.updateRequests(this.props,this.context)}componentWillUnmount(){this.unmounted=!0}shouldComponentUpdate(e,t){return a.some(e=>"error"in t[e])||a.every(e=>"result"in t[e])}render(){const e={},n={},o={...this.props};let l=!0,h=!1;return a.forEach(t=>{delete o[t];const i=this.state[t];"result"in i?e[t]=i.result:"error"in i?(n[t]=i.error,h=!0):l=!1}),h?r?s.a.createElement(r,Object.assign({},o,n)):null:l?s.a.createElement(t,Object.assign({},o,e)):i?s.a.createElement(i,o):null}}).displayName="WithAsync(".concat(t.displayName||t.name||"Component",")"),n}class S{constructor(){this.cache={},this.counter=0,this.subs=[]}subscribe(e){this.subs.push(e),e(this.counter)}unsubscribe(e){this.subs=this.subs.filter(t=>t!==e)}_start(){this.counter+=1,this.subs.forEach(e=>e(this.counter))}_stop(){this.counter-=1,this.subs.forEach(e=>e(this.counter))}fetch(e,t){const i=(t=t||{}).type||"json";let r="".concat(e,"$").concat(i);if(t.info&&(r+="$info"),!t.refresh&&this.cache[r])return this.cache[r];const n=this.cache[r]=fetch(e).then(e=>{if(e.ok){if("binary"===i)return e.arrayBuffer();if("text"===i)return e.text();if(!t.info){let i=e.json();return t.process&&(i=i.then(e=>t.process(e))),i}return e.text().then(t=>({compressed:parseInt(e.headers.get("Content-Length"),10),uncompressed:t.length,json:JSON.parse(t)}))}return e.json().then(e=>Promise.reject(e))});return t.global&&(this._start(),n.then(()=>this._stop(),()=>this._stop())),n}refresh(e,t){return this.fetch(e,{...t,refresh:!0})}}var R=i(441);class b extends s.a.Component{componentDidMount(){this.props.setActive(!0)}componentWillUnmount(){this.props.setActive(!1)}render(){const{setActive:e,children:t,...i}=this.props,r=s.a.Children.only(t);return s.a.cloneElement(r,i)}}class I extends s.a.Component{constructor(){super(...arguments),this.state={active:!1},this.setActive=(e=>this.setState({active:e}))}render(){const{children:e,overlay:t,...i}=this.props,r=s.a.Children.only(e);return s.a.createElement(R.a,Object.assign({overlay:s.a.createElement(b,{setActive:this.setActive},t)},i),s.a.cloneElement(r,{active:this.state.active}))}}const L="$history";class N extends s.a.Component{constructor(){super(...arguments),this.onScroll=(e=>{this.scrollTimeout&&clearTimeout(this.scrollTimeout),this.scrollTimeout=setTimeout(()=>{delete this.scrollTimeout;const t=this.props[L];t.replace(t.location.pathname+t.location.hash,{scrollTop:e})},500)})}componentDidMount(){const e=this.props[L].location.state;e&&null!=e.scrollTop&&this.props.callback(e.scrollTop),this.props.onRef&&this.props.onRef(this)}componentWillUnmount(){this.props.onRef&&this.props.onRef(null)}render(){return null}}const x=e=>s.a.createElement(l.d,{render:t=>{let{history:i}=t;return s.a.createElement(N,Object.assign({},e,{[L]:i}))}});function P(e,t){const i=URL.createObjectURL(e),r=document.createElement("a");r.setAttribute("href",i),r.setAttribute("download",t),r.style.display="none",document.body.appendChild(r),r.click(),setTimeout(()=>{document.body.removeChild(r),URL.revokeObjectURL(i)})}let C=null;function U(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(!C){C=new Uint32Array(1280);let e=1048577;for(let t=0;t<256;t++)for(let i=t;i<1280;i+=256){const t=(65535&(e=(125*e+3)%2796203))<<16,r=65535&(e=(125*e+3)%2796203);C[i]=t|r}}let i=2146271213,r=4008636142;for(let n=0;n<e.length;++n){let s=e.charCodeAt(n);s>=97&&s<=122&&(s-=32),47===s&&(s=92),r=s+(i=C[256*t+s]^i+r)+33*r+3|0}return i}function O(e,t){let i;t&&(i=e.match(/^(.*)\.(?:blp|dds|gif|jpg|jpeg|png|tga)$/i))&&(e=i[1]);let r=0;(i=e.match(/^([A-Z])\.w3mod:(.*)$/))&&(r=i[1].charCodeAt(0)-64,e=i[2]);const n=new Uint32Array(2);if(n[0]=U(e,1),n[1]=U(e,2),r){let e=n[0];n[0]+=r,n[0]<e&&(n[1]+=1)}return n}function D(e){return e[1].toString(16).padStart(8,"0")+e[0].toString(16).padStart(8,"0")}function M(e){const t=new Uint32Array(2);return t[0]=parseInt(e.substr(8,8),16),t[1]=parseInt(e.substr(0,8),16),isNaN(t[0])||isNaN(t[1])?null:t}function F(e,t){return!e===!t&&(!e||e[0]===t[0]&&e[1]===t[1])}var B=i(233),V=i.n(B),k=i(234),G=i.n(k),j=i(29),Y=i.n(j);class H{constructor(e){this.images_={},this.wasm=e}fileId(e){return"string"===typeof e?O(e):null!=e&&"number"===typeof e[0]?e:null}hasFile(e){const t=this.fileId(e);return null!=t&&0!==this.wasm._hasFile(t[0],t[1])}loadBinary(e){const t=this.fileId(e);if(null==t)return null;let i=null;window.postResult=(e=>i=e);const r=this.wasm._loadFile(t[0],t[1],1);return delete window.postResult,i?{data:i,flags:r}:null}loadFile(e){const t=this.fileId(e);if(null==t)return null;let i=null;return window.postResult=(e=>i=e),this.wasm._loadFile(t[0],t[1]),delete window.postResult,i?(new Y.a.TextDecoder).decode(i):null}loadImage(e){const t=this.fileId(e);if(null==t)return null;const i=D(t);if(this.images_[i])return this.images_[i];let r=null;if(window.postResult=(e=>r=e),this.wasm._loadImage(t[0],t[1]),delete window.postResult,!r)return null;const n=new Blob([r],{type:"image/png"});return this.images_[i]=URL.createObjectURL(n)}loadJASS(e){e=e||{};const t=this.wasm._malloc(10),i=this.wasm.HEAPU8;i[t+0]=e.indent||0,i[t+1]=e.restoreInt||0,i[t+2]=e.restoreId||0,i[t+3]=e.insertLines||0,i[t+4]=e.restoreStrings||0,i[t+5]=e.renameGlobals||0,i[t+6]=e.renameFunctions||0,i[t+7]=e.renameLocals||0,i[t+8]=e.inlineFunctions||0,i[t+9]=e.getObjectName||0;let r=null;if(window.postResult=(e=>r=e),this.wasm._loadJASS(t),delete window.postResult,this.wasm._free(t),!r)return null;const n=[],s=new Y.a.TextDecoder;let a=0;for(let o=0;o<r.length;++o)0===r[o]&&(n.push(s.decode(r.subarray(a,o))),a=o+1);return n}}function W(e){return 827873863!==new Uint32Array(e.buffer||e,0,1)[0]?Promise.reject("Outdated archive format. Try parsing the map again."):G()({locateFile:e=>"ArchiveLoader.wasm"===e?V.a:e}).then(t=>{const i=new Uint8Array(e),r=t._malloc(i.length);return t.HEAPU8.set(i,r),t._openArchive(r,i.length),t._free(r),new H(t)})}var K=i(235),z=i.n(K);const q=(e,t,i,r)=>new Promise((n,s)=>{e.addEventListener("message",t=>{if(t.data.progress)r&&r(t.data.progress);else if(t.data.result)e.terminate(),n(t.data.result);else{let i=t.data.error;(i instanceof ArrayBuffer||ArrayBuffer.isView(i))&&(i=(new Y.a.TextDecoder).decode(i)),e.terminate(),s(i)}}),e.postMessage({meta:t,map:i})});class X{constructor(){this.worker=new z.a,this.onProgress=(()=>void 0)}async parse(e,t){return e=await e,this.onProgress(0),await q(this.worker,e,t,this.onProgress)}terminate(){this.worker.terminate()}}let J=null,Q=null;function $(e){J=e,e&&Q&&(e.setNotification(Q.message,Q.type),Q=null)}function Z(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info";J?J.setNotification(e,t):Q={message:e,type:t}}var ee=i(182),te=i.n(ee);const ie=e=>(Object.values(e.objects).forEach(e=>{const t={};Object.keys(e.data).forEach(i=>t[i.toLowerCase()]=e.data[i]),e.data=t}),e),re=e=>new Promise((t,i)=>{const r=new FileReader;r.onload=(()=>t(r.result)),r.onerror=(()=>i(r.error)),r.onabort=(()=>i()),r.readAsArrayBuffer(e)});class ne{constructor(e,t,i){this.cache=e,this.id=t,this.name=i,this.core=!0}objects(){return this.cache.fetch("/api/".concat(this.id,".json"),{global:!0,process:ie})}listFile(){return this.cache.fetch("/api/rootlist.txt",{global:!0,type:"text"})}hasFile(){return!1}file(){return null}binary(){return null}image(e){return this.cache.image(e)}jass(){return null}icon(e){return this.cache.icon(e)}iconByName(e){return this.cache.iconByName(e)}}const se=(e,t)=>"string"===typeof e?O(e,t):null!=e&&"number"===typeof e[0]?e:null;class ae{constructor(e,t,i,r){this.files_={},this.images_={},this.cache=e,this.archive=t,this.id=i,this.name=r.replace(/\|(c[0-9a-fA-F]{6,8}|r)/g,""),this.isMap=!0}objects(){if(this.objects_)return this.objects_;const e=this.archive.loadFile("objects.json");if(!e){const e=Math.max(...Object.keys(this.cache.versions)),t=this.cache.data(e);return this.objects_=t?t.then(e=>e.objects()):Promise.resolve(null)}return this.objects_=Promise.resolve(e?ie(JSON.parse(e)):null)}listFile(){return this.file("listfile.txt")}hasFile(e){return this.archive.hasFile(se(e))}file(e){return this.files_.hasOwnProperty(e)?this.files_[e]:this.files_[e]=this.archive.loadFile(e)}binary(e){return this.archive.loadBinary(e)}jass(e){return this.archive.loadJASS(e)}image(e,t){return this.archive.loadImage(e)||this.cache.image(e,t)}icon(e){const t=this.archive.loadImage(e);return t?{backgroundImage:"url(".concat(t,")"),backgroundSize:"100%"}:this.cache.icon(e)}iconByName(e){return this.icon(O(e))}}class oe extends S{constructor(e){super(),this.baseData_={},this.mapNames_={},this.mapData_={},this.maps={},this.root=e;try{this.dataStore=new te.a("mapData"),this.nameStore=new te.a("mapNames")}catch(i){this.dataStore=null,this.nameStore=null}const t=[this.fetch("/api/images.dat",{type:"binary"}),this.fetch("/api/versions.json")];this.nameStore&&t.push(this.nameStore.json()),this.ready=Promise.all(t).then(e=>{let[t,i,r]=e;this.icons_=new Map;const n=new Uint32Array(t);for(let s=0;s<n.length;s+=2){const e=D(n.subarray(s,s+2));this.icons_.set(e,s/2+256e3)}this.versions=i.versions,r&&(this.maps=r,this.root.forceUpdate()),i.custom&&(this.custom={},this.customDesc={},Object.entries(i.custom).forEach(e=>{let[t,i]=e;this.maps[t]=i.name,this.custom[t]=i.data,this.customDesc[t]=i.desc}))})}metaRaw(){return this.fetch("/api/meta.gzx",{type:"binary",global:!0})}meta(){return this.meta_?this.meta_:this.meta_=this.metaRaw().then(e=>W(e))}isLocal(e){return!(!this.maps[e]||this.custom[e])}data(e){return this.maps[e]?this.mapData_[e]?this.mapData_[e]:this.custom&&this.custom[e]?this.mapData_[e]=this.fetch("/api/".concat(this.custom[e]),{type:"binary",global:!0}).then(e=>W(e)).then(t=>new ae(this,t,e,this.maps[e])):this.mapData_[e]=this.dataStore.get(e).then(e=>re(e)).then(e=>W(e)).then(t=>new ae(this,t,e,this.maps[e])).catch(e=>Promise.reject(Z(e.toString(),"danger"))):this.versions[e]?this.baseData_[e]?this.baseData_[e]:this.baseData_[e]=Promise.resolve(new ne(this,e,this.versions[e])):null}hasData(e){return!(!this.maps[e]&&!this.versions[e])}icon(e){const t=this.icons_.get(D(e));if(t){const e=t%16,i=(t/16|0)%16;return{backgroundImage:"url(/api/icons".concat(t/256|0,".png)"),backgroundPosition:"-".concat(16*e,"px -").concat(16*i,"px")}}return null}iconByName(e){return this.icon(O(e))}image(e,t){const i=D(se(e,!0));let r="/api/images/".concat(i);return t&&(r+="?tileset=".concat(t)),r}binary(e,t){const i=D(se(e,!0));let r="/api/files/".concat(i);return t&&(r+="?tileset=".concat(t)),r}loadMap(e){this.abortMap();const t=this.metaRaw();re(e).then(i=>{this.parser=new X,this.parser.onProgress=(e=>this.root.onMapProgress(e)),this.root.beginMapLoad(e.name),this.parser.parse(t,i).then(t=>{delete this.parser;let i=1;for(;this.maps.hasOwnProperty("map".concat(i));)i+=1;i="map".concat(i),this.dataStore&&Promise.all([this.nameStore.set(i,e.name),this.dataStore.set(i,new Blob([t],{type:"application/octet-stream"}))]).catch(()=>{this.nameStore.remove(i),this.dataStore.remove(i)}),this.maps={...this.maps,[i]:e.name},this.mapData_[i]=W(t).then(t=>new ae(this,t,i,e.name)).catch(e=>Promise.reject(Z(e.toString(),"danger"))),this.root.finishMapLoad(i)}).catch(e=>{delete this.parser,this.root.failMapLoad("string"===typeof e&&e),console.error(e)})})}abortMap(){this.parser&&(this.parser.terminate(),delete this.parser)}unloadMap(e){this.maps[e]&&window.confirm("Are you sure you want to unload ".concat(this.maps[e],"?"))&&(this.maps={...this.maps},delete this.maps[e],delete this.mapData_[e],this.dataStore&&(this.dataStore.remove(e),this.nameStore.remove(e)),this.root.forceUpdate())}}oe.Context=s.a.createContext(null),oe.DataContext=s.a.createContext(null),oe.MapsContext=s.a.createContext({});const le=s.a.createContext(null);class he extends s.a.PureComponent{constructor(){super(...arguments),this.children=[]}componentDidMount(){this.context&&(this.context.children.push(this),this.context.updateTitle())}componentDidUpdate(){this.updateTitle()}componentWillUnmount(){if(this.context){let e=this.context.children.indexOf(this);e>=0&&(this.context.children.splice(e,1),e>=this.context.children.length&&this.context.updateTitle())}}updateTitle(){let e=this;for(;e.context;)e=e.context;document.title=e.getTitle()}getTitle(e){let{title:t,combiner:i}=this.props;return e&&(t=i(e,t)),this.children.length&&(t=this.children[this.children.length-1].getTitle(t)),t}render(){const{children:e}=this.props;return e?s.a.createElement(le.Provider,{value:this},e):null}}he.contextType=le,he.defaultProps={combiner:(e,t)=>"".concat(e," - ").concat(t)};class ce extends s.a.Component{constructor(e){super(e);const t={};if(window.localStorage){const e=window.localStorage.getItem("options");if(e)try{Object.assign(t,JSON.parse(e))}catch(i){}}t.update=((e,t)=>this.setState({[e]:t})),this.state=t}componentDidUpdate(){if(window.localStorage){const e={...this.state};delete e.update,window.localStorage.setItem("options",JSON.stringify(e))}}render(){return s.a.createElement(ce.Context.Provider,{value:this.state},this.props.children)}}ce.Context=s.a.createContext({});i(261);var de=i(439),ue=i(237),me=i(138),fe=(i(262),{unit:"Units",item:"Items",destructible:"Destructibles",doodad:"Doodads",ability:"Abilities",buff:"Buffs/Effects",upgrade:"Upgrades"});const pe=e=>{let{match:{params:{build:t,type:i}}}=e;return s.a.createElement(de.a,{title:fe[i]||"Objects",active:null!=fe[i],id:"objects-menu"},Object.keys(fe).map(e=>s.a.createElement(de.a.Item,{key:e,href:"/".concat(t,"/").concat(e)},s.a.createElement(m.LinkContainer,{to:"/".concat(t,"/").concat(e)},s.a.createElement(ue.a,{"event-key":"objects.".concat(e)},s.a.createElement("span",{className:"ObjectIcon ".concat(e)}),fe[e])))))},Ee=()=>s.a.createElement(l.d,{path:"/:build/:type?",component:pe});var ge=()=>s.a.createElement(oe.DataContext.Consumer,null,e=>s.a.createElement(s.a.Fragment,null,s.a.createElement("ul",{className:"DataMenu"},s.a.createElement(m.LinkContainer,{className:"title",to:"/".concat(e.id),exact:!0},s.a.createElement("li",null,s.a.createElement(me.a,{"event-key":"build"},e.name))),s.a.createElement("li",null,s.a.createElement(m.LinkContainer,{to:"/".concat(e.id,"/files")},s.a.createElement(me.a,{"event-key":"files"},"Files"))),(!e.isMap||e.hasFile("objects.json"))&&s.a.createElement(s.a.Fragment,null,s.a.createElement("li",{className:"sep"}," | "),s.a.createElement("li",null," ",s.a.createElement(Ee,null))),!!e.isMap&&s.a.createElement(s.a.Fragment,null,s.a.createElement("li",{className:"sep"}," | "),s.a.createElement("li",null," ",s.a.createElement(m.LinkContainer,{to:"/".concat(e.id,"/map")},s.a.createElement(me.a,{"event-key":"map"},"Map")))),(e.hasFile("war3map.j")||e.hasFile("Scripts\\war3map.j"))&&s.a.createElement(s.a.Fragment,null,s.a.createElement("li",{className:"sep"}," | "),s.a.createElement("li",null," ",s.a.createElement(m.LinkContainer,{to:"/".concat(e.id,"/script")},s.a.createElement(me.a,{"event-key":"script"},"Script")))))));const Ae=s.a.createContext(!1),_e=(s.a.createContext(!0),s.a.createContext(0)),Te=s.a.createContext(""),ve=s.a.createContext(""),ye=s.a.createContext(void 0),we=e=>{let{object:t}=e;return s.a.createElement(oe.DataContext.Consumer,null,e=>{if(!t||null==t.icon)return null;const i=e.icon(t.icon);return s.a.createElement("span",{className:"Icon",style:i})})};function Se(e,t){if(t>=e.length)return-1;let i=!1;for(++t;t<e.length;++t)if('"'===e[t]&&(i=!i),","===e[t]&&!i)return t;return t}const Re={atdb:"Attack Dice Bonus - Base",atdm:"Attack Dice Bonus - Increment",levb:"Ability Level Bonus - Base",levm:"Ability Level Bonus - Increment",levc:"Ability Affected",hpxb:"Hit Point Bonus - Base",hpxm:"Hit Point Bonus - Increment",mnxb:"Mana Point Bonus - Base",mnxm:"Mana Point Bonus - Increment",mvxb:"Movement Speed Bonus - Base",mvxm:"Movement Speed Bonus - Increment",mnrb:"Mana Regeneration Bonus (%) - Base",mnrm:"Mana Regeneration Bonus (%) - Increment",hpob:"Hit Point Bonus (%) - Base",hpom:"Hit Point Bonus (%) - Increment",manb:"Mana Point Bonus (%) - Base",manm:"Mana Point Bonus (%) - Increment",movb:"Movement Speed Bonus (%) - Base",movm:"Movement Speed Bonus (%) - Increment",atxb:"Attack Damage Bonus - Base",atxm:"Attack Damage Bonus - Increment",lumb:"Lumber Harvest Bonus - Base",lumm:"Lumber Harvest Bonus - Increment",atrb:"Attack Range Bonus - Base",atrm:"Attack Range Bonus - Increment",atsb:"Attack Speed Bonus (%) - Base",atsm:"Attack Speed Bonus (%) - Increment",spib:"Spike Damage - Base",spim:"Spike Damage - Increment",hprb:"Hit Point Regeneration Bonus (%) - Base",hprm:"Hit Point Regeneration Bonus (%) - Increment",sigb:"Sight Range Bonus - Base",sigm:"Sight Range Bonus - Increment",atcb:"Attack Target Count Bonus - Base",atcm:"Attack Target Count Bonus - Increment",adlb:"Attack Damage Loss Bonus - Base",adlm:"Attack Damage Loss Bonus - Increment",minb:"Gold Harvest Bonus - Base",minm:"Gold Harvest Bonus - Increment",raib:"Raise Dead Duration Bonus - Base",raim:"Raise Dead Duration Bonus - Increment",entb:"Gold Harvest Bonus (Entangle) - Base",entm:"Gold Harvest Bonus (Entangle) - Increment",enwb:"Attacks to Enable",audb:"Aura Data Bonus - Base",audm:"Aura Data Bonus - Increment",asdb:"Attack Spill Distance Bonus - Base",asdm:"Attack Spill Distance Bonus - Increment",asrb:"Attack Spill Radius Bonus - Base",asrm:"Attack Spill Radius Bonus - Increment",roob:"Attacks to Enable (Rooted)",urob:"Attacks to Enable (Uprooted)",uart:"New Defense Type",utma:"New Availability",ttma:"Unit Type Affected"},be={A:"Ashenvale",B:"Barrens",K:"Black Citadel",Y:"Cityscape",X:"Dalaran",J:"Dalaran Ruins",D:"Dungeon",C:"Felwood",I:"Icecrown Glacier",F:"Lordaeron Fall",L:"Lordaeron Summer",W:"Lordaeron Winter",N:"Northrend",O:"Outland",Z:"Sunken Ruins",G:"Underground",V:"Village",Q:"Village Fall","*":"All"},Ie={D:"Trees/Destructibles",P:"Pathing Blockers",B:"Bridges/Ramps"},Le={O:"Props",S:"Structures",W:"Water",C:"Cliff/Terrain",E:"Environment",Z:"Cinematic"},Ne={HERO:"Any Hero",TALT:"Any Altar",TWN1:"Any Tier 1 Hall",TWN2:"Any Tier 2 Hall",TWN3:"Any Tier 3 Hall",TWN4:"Any Tier 4 Hall",TWN5:"Any Tier 5 Hall",TWN6:"Any Tier 6 Hall",TWN7:"Any Tier 7 Hall",TWN8:"Any Tier 8 Hall",TWN9:"Any Tier 9 Hall"};function xe(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1;const r=e.data[t.toLowerCase()]||"";if(i<0){const e=Se(r,-1);return e>=2&&e>=r.length&&'"'===r[0]&&'"'===r[e-1]?r.substr(1,e-2):r}{let e=-1,t=0,n=0;for(;(e=Se(r,e))>=0;){if(t===i)return e-n>=2&&'"'===r[n]&&'"'===r[e-1]?r.substr(n+1,e-n-2):r.substr(n,e-n);n=e+1,t++}return""}}function Pe(e,t,i,r){const n="item"===e.type?"unit":e.type,s=t.meta[n]||[],a=t=>(t=t.toLowerCase(),e.data[t]&&(parseInt(e.data[t],10)||0));let o=0,l=0;switch(e.type){case"unit":o=a("isbldg")?4:e.id.match(/^[A-Z]/)?2:1;break;case"item":o=8;break;case"ability":l=a("levels"),e.data.code&&r("code",i?"code":"Ability Code",e.data.code,{type:"abilCode"});break;case"doodad":l=a("numVar");break;case"upgrade":l=a("maxlevel")}const h=new Map;s.forEach(t=>h.set(t,(t=>{if("upgrade"!==e.type)return t.display;const i=t.field.match(/^(base|mod|code)(\d)$/);if(!i)return t.display;const r=(e.data["effect".concat(i[2])]||"").match(/^r([a-z][a-z][a-z])$/);if(!r)return null;const n=Re[r[1]+i[1][0]];return n?t.display.replace("%s",n):null})(t))),s.filter(e=>h.get(e)).sort((e,i)=>(16&e.flags)!==(16&i.flags)?(16&e.flags)-(16&i.flags):e.category!==i.category?t.categories[e.category].localeCompare(t.categories[i.category]):h.get(e).localeCompare(h.get(i))).forEach(n=>{if((n.flags&o)!==o)return;if(n.specific&&n.specific.indexOf("ability"===e.type?e.data.code:e.id)<0)return;if(16&n.flags&&!l)return;let s=n.field;if(n.data&&(s+=String.fromCharCode(65+n.data-1)),16&n.flags)for(let a=0;a<l;++a){let o=s;n.index<0&&(32&n.flags?a>0&&(o+=a):o+=a+1);const l=n.index<0?xe(e,o,-1):xe(e,s,a);r("".concat(s).concat(a),i?o:"Level ".concat(a+1," - ").concat(t.categories[n.category]," - ").concat(h.get(n)),l,n)}else{const a=xe(e,s,n.index);r("".concat(s).concat(n.index),i?s:"".concat(t.categories[n.category]," - ").concat(h.get(n)),a,n)}})}const Ce={};Ce.unit=[{name:e=>e.base?"Custom Units":"Standard Units",order:["Standard Units","Custom Units"]},{name:e=>{switch(e.data.race){case"human":return"Human";case"orc":return"Orc";case"undead":return"Undead";case"nightelf":return"Night Elf";case"naga":return"Neutral - Naga";default:return parseInt(e.data.hostilepal,10)?"Neutral Hostile":"Neutral Passive"}},order:["Human","Orc","Undead","Night Elf","Neutral - Naga","Neutral Hostile","Neutral Passive"]},{name:e=>parseInt(e.data.campaign,10)?"Campaign":"Melee",order:["Melee","Campaign"]},{name:e=>parseInt(e.data.special,10)?"Special":parseInt(e.data.isbldg,10)?"Buildings":e.id.match(/^[A-Z]/)?"Heroes":"Units",order:["Units","Buildings","Heroes","Special"]}],Ce.item=[{name:e=>e.base?"Custom Items":"Standard Items",order:["Standard Items","Custom Items"]},{name:e=>{switch(e.data.class){case"PowerUp":return"Power Up";default:return e.data.class}},order:["Permanent","Charged","Power Up","Artifact","Purchasable","Campaign","Miscellaneous"]}],Ce.destructible=[{name:e=>e.base?"Custom Destructibles":"Standard Destructibles",order:["Standard Destructibles","Custom Destructibles"]},{name:e=>{switch(e.data.category){case"D":return"Trees/Destructibles";case"P":return"Pathing Blockers";case"B":return"Bridges/Ramps";default:return"Others"}},order:["Trees/Destructibles","Pathing Blockers","Bridges/Ramps","Others"]}],Ce.doodad=[{name:e=>e.base?"Custom Doodads":"Standard Doodads",order:["Standard Doodads","Custom Doodads"]},{name:e=>{switch(e.data.category){case"O":return"Props";case"S":return"Structures";case"W":return"Water";case"C":return"Cliff/Terrain";case"E":return"Environment";case"Z":return"Cinematic";default:return"Others"}},order:["Props","Structures","Water","Cliff/Terrain","Environment","Cinematic","Others"]}],Ce.ability=[{name:e=>e.base?"Custom Abilities":"Standard Abilities",order:["Standard Abilities","Custom Abilities"]},{name:e=>{switch(e.data.race){case"human":return"Human";case"orc":return"Orc";case"undead":return"Undead";case"nightelf":return"Night Elf";case"creeps":return"Neutral Hostile";case"naga":case"demon":return"Neutral Passive";default:return"Special"}},order:["Human","Orc","Undead","Night Elf","Neutral Hostile","Neutral Passive","Special"]},{name:e=>parseInt(e.data.hero,10)?"Heroes":parseInt(e.data.item,10)?"Items":"Units",order:["Units","Heroes","Items"]}],Ce.buff=[{name:e=>e.base?"Custom Buffs/Effects":"Standard Buffs/Effects",order:["Standard Buffs/Effects","Custom Buffs/Effects"]},{name:e=>{switch(e.data.race){case"human":return"Human";case"orc":return"Orc";case"undead":return"Undead";case"nightelf":return"Night Elf";default:return"Special"}},order:["Human","Orc","Undead","Night Elf","Special"]},{name:e=>parseInt(e.data.isEffect,10)?"Effect":"Buff",order:["Buff","Effect"]}],Ce.upgrade=[{name:e=>e.base?"Custom Upgrades":"Standard Upgrades",order:["Standard Upgrades","Custom Upgrades"]},{name:e=>{switch(e.data.race){case"human":return"Human";case"orc":return"Orc";case"undead":return"Undead";case"nightelf":return"Night Elf";default:return"Special"}},order:["Human","Orc","Undead","Night Elf","Special"]}];var Ue=i(35),Oe=i.n(Ue),De=i(437),Me=i(18),Fe=i(436),Be=i(445),Ve=i(443);class ke{constructor(e,t,i){this.type=e,this.json=t,this.names=i,this.json?this.outJs={}:this.outLines=[]}onObject(e){this.json?(this.curJs={},this.outJs[e]=this.curJs):this.outLines.push("[".concat(e,"]"))}onValue(e,t){this.json?this.curJs[e]=t:this.outLines.push("".concat(e,"=").concat(t))}translateSub(e,t,i){let r=t.type;if("lightningList"===r&&(r="lightningEffect"),i.types[r])return e&&"_"!==e?i.types[r][e]||"value":"None";switch(r){case"bool":return parseInt(e,10)?"True":"False";case"string":return"_"===e?"":e;case"char":return e;case"int":return parseInt(e,10)||0;case"real":case"unreal":return(parseFloat(e)||0).toFixed(t.stringExt||2);case"destructableCategory":return Ie[e]||e;case"tilesetList":return be[e]||e;case"doodadCategory":return Le[e]||e;case"techList":if(Ne[e])return Ne[e];case"buffCode":case"buffList":case"effectCode":case"effectList":case"unitCode":case"unitList":case"abilCode":case"abilityList":case"heroAbilityList":case"itemCode":case"itemList":case"upgradeCode":case"upgradeList":if("_"===e)return"";const n=i.objects.find(t=>t.id===e);return n?n.name:e;default:return"_"!==e&&(e||"None")}}translate(e,t,i){if(t.type.indexOf("List")>=0)return"_"===e||""===e?"":e.split(",").map(e=>this.translateSub(e,t,i)).join(", ");if(t.type.indexOf("Flags")>=0){const r=parseInt(e,10);return[...Array(31)].map((e,t)=>t).filter(e=>0!==(1<<e&r)).map(e=>this.translateSub(e,t,i)).join(", ")}return"string"===t.type?"_"===e?"":e:this.translateSub(e,t,i)}processObject(e,t){this.onObject(e.id),this.names<2?Pe(e,t,1===this.names,(e,i,r,n)=>{0===this.names&&(r=this.translate(r,n,t)),this.onValue(i,r)}):Object.keys(e.data).sort().forEach(t=>this.onValue(t,e.data[t]))}process(e){e.objects.forEach(t=>{"all"!==this.type&&this.type!==t.type||this.processObject(t,e)})}processSingle(e){const t="all"===this.type?e.objects[0]:e.objects.find(e=>e.type===this.type);t&&this.processObject(t,e)}get output(){return 0===this.json?this.outLines.join("\r\n"):1===this.json?JSON.stringify(this.outJs).replace(/\n/g,"\r\n"):JSON.stringify(this.outJs,null,2).replace(/\n/g,"\r\n")}get preview(){let e;return 0===this.json?e=this.outLines.join("\n"):1===this.json?e=JSON.stringify(this.outJs):2===this.json&&(e=JSON.stringify(this.outJs,null,2)),e.slice(0,1e3)}}class Ge extends s.a.PureComponent{constructor(){super(...arguments),this.state={},this.setOption=((e,t)=>{const i={...this.options};i[e]=t,this.context.update("dataDownload",i)}),this.setType=(e=>this.setOption("type",e.target.value)),this.onDownload=(()=>{const{type:e,json:t,names:i}=this.options,r=new ke(e,t,i);r.process(this.props.data);const n=(new Y.a.TextEncoder).encode(r.output);P(new Blob([n],{type:"text/plain"}),e+".txt"),this.props.onHide()})}get options(){return this.context.dataDownload||Ge.defaultState}componentDidUpdate(){this.props.show!==this.state.show&&this.setState({show:this.props.show},()=>this.setOption("type",this.props.show))}render(){const{show:e,onHide:t}=this.props,{type:i,json:r,names:n}=this.options,a=new ke(i,r,n);return a.processSingle(this.props.data),s.a.createElement(d.a,{show:!!e,onHide:t},s.a.createElement(d.a.Header,{closeButton:!0},s.a.createElement(d.a.Title,null,"Download data")),s.a.createElement(d.a.Body,null,s.a.createElement("form",null,s.a.createElement(Fe.a,{controlId:"formType"},s.a.createElement(Be.a,null,"Object type"),s.a.createElement(De.a,{componentClass:"select",value:i,onChange:this.setType},Object.keys(fe).map(e=>s.a.createElement("option",{key:e,value:e},fe[e])),s.a.createElement("option",{value:"all"},"All (Combined)"))),s.a.createElement(Fe.a,null,s.a.createElement(Ve.a,{name:"json",inline:!0,checked:0===r,onChange:()=>this.setOption("json",0)},"Text")," ",s.a.createElement(Ve.a,{name:"json",inline:!0,checked:1===r,onChange:()=>this.setOption("json",1)},"JSON"),s.a.createElement(Ve.a,{name:"json",inline:!0,checked:2===r,onChange:()=>this.setOption("json",2)},"Indented JSON")),s.a.createElement(Fe.a,null,s.a.createElement(Ve.a,{name:"names",inline:!0,checked:0===n,onChange:()=>this.setOption("names",0)},"Editor names")," ",s.a.createElement(Ve.a,{name:"names",inline:!0,checked:1===n,onChange:()=>this.setOption("names",1)},"Code names"),s.a.createElement(Ve.a,{name:"names",inline:!0,checked:2===n,onChange:()=>this.setOption("names",2)},"Raw data"))),s.a.createElement("div",{className:"dataPreview"},a.preview)),s.a.createElement(d.a.Footer,null,s.a.createElement(u.a,{bsStyle:"info",onClick:this.onDownload},"Download"),s.a.createElement(u.a,{onClick:t},"Cancel")))}}Ge.contextType=ce.Context,Ge.defaultState={type:"all",json:0,names:0};i(273);const je=e=>{let{object:t}=e;return s.a.createElement(Ae.Consumer,null,e=>e?t.base?"".concat(t.id,":").concat(t.base," (").concat(t.name,")"):"".concat(t.id," (").concat(t.name,")"):t.name)},Ye=e=>{let{object:t}=e;return s.a.createElement(_e.Consumer,null,e=>s.a.createElement(Te.Consumer,null,i=>s.a.createElement(ve.Consumer,null,r=>s.a.createElement(h.Link,{to:"/".concat(e,"/").concat(i,"/").concat(t.id),className:_()("ObjectLink",{selected:r===t.id,searched:t.searched})},s.a.createElement(we,{object:t}),s.a.createElement("span",{className:"ObjectName"},s.a.createElement(je,{object:t}))))))};class He{constructor(e,t){this.height=1,this.object=e,this.object.parent=this,this.object.upVisit=(e=>{e(this.object),this.object.parent.upVisit(e)}),this.parent=t}upVisit(e){e(this),this.parent.upVisit(e)}downVisit(e){e(this),e(this.object)}render(){return s.a.createElement(Ye,{object:this.object})}renderLine(e){return this.render()}}class We{constructor(e,t,i,r){if(this.toggle=(()=>{this.expanded?this.collapse():this.expand()}),this.parent=i,this.level=i?i.level+1:0,this.count=e.length,this._title=r,r&&(this.title="".concat(r," (").concat(this.count,")")),t&&t.length){this.filter=t[0];const r={};e.forEach(e=>{const i=t[0].name(e);r[i]=r[i]||[],r[i].push(e)});const n=t.slice(1);this.childrenByName={},this.children=t[0].order.filter(e=>!i||r[e]).map(e=>this.childrenByName[e]=new We(r[e]||[],n,this,e))}else this.children=e.map(e=>new He(e,this)).sort((e,t)=>e.object.name.localeCompare(t.object.name));this.openHeight=i?1:0,this.children.forEach(e=>{e.top=this.openHeight,this.openHeight+=e.height}),i?this.level>1?this.expanded=!1:this.expanded=this.count>0:this.expanded=!0}upVisit(e){e(this),this.parent&&this.parent.upVisit(e)}downVisit(e){e(this),this.children.forEach(t=>t.downVisit(e))}modHeight(e,t){let i=t?this.children.indexOf(t):-1;if(i>=0)for(;++i<this.children.length;)this.children[i].top+=e;this.openHeight+=e,this.parent&&this.expanded?this.parent.modHeight(e,this):this.onResize&&this.onResize(this.height)}get height(){return this.expanded?this.openHeight:1}expandItem(e){if(this.filter){const t=this.filter.name(e),i=this.childrenByName[t];if(i)return i.expand(),i.expandItem(e)+i.top}else{const t=this.children.find(t=>t.object===e);if(t)return t.top}return 0}expand(){!this.expanded&&this.count>0&&(this.expanded=!0,this.parent&&this.parent.modHeight(this.openHeight-1,this))}collapse(){this.expanded&&this.parent&&(this.expanded=!1,this.parent.modHeight(1-this.openHeight,this))}render(){let e=0;return this.downVisit(t=>e+="ObjectItem"==t.__proto__.constructor.name&&t.searched?1:0),e&&(this.title="".concat(this._title," (").concat(e,"/").concat(this.count,")")),this.parent?s.a.createElement("div",{className:_()("ObjectGroup",{expanded:this.expanded,searched:this.searched})},s.a.createElement("span",{className:"toggle",onClick:this.toggle}),s.a.createElement("span",{onDoubleClick:this.toggle},s.a.createElement("span",{className:"Icon"}),s.a.createElement("span",{className:"title"},this.title))):null}firstLevelChild(e){if(this.expanded){let t=0,i=this.children.length-1;for(;t<i;){const r=t+i+1>>1;this.children[r].top>e?i=r-1:t=r}return this.children[t]}return null}renderLine(e){if(this.parent&&!e)return this.render();if(this.expanded){let t=0,i=this.children.length-1;for(;t<i;){const r=t+i+1>>1;this.children[r].top>e?i=r-1:t=r}const r=e-this.children[t].top,n=this.children[t].renderLine(r);let a=null;return t<this.children.length-1?a=0===r?"tLine":"line":0===r&&(a="halfLine"),this.parent?s.a.createElement("div",{className:_()("indent",a)},n):n}}}class Ke extends s.a.PureComponent{constructor(){super(...arguments),this.state={search:"",searchResults:null},this.onSearchKeyDown=(e=>{27===e.which&&(this.setState({search:"",searchResults:null}),this._list&&this._list.forceUpdateGrid())}),this.onSearch=(e=>{const{data:t,type:i}=this.props,r=e.target.value.trim();console.log(r);let n=0;if(this.group.downVisit(e=>{e.searched=!1}),r){const e=new RegExp("\\b"+r.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&"),"i"),s=t=>t.type===i&&(!(!this.context||!t.id.match(e))||(!!t.name.match(e)||(!(!t.data.propernames||!t.data.propernames.match(e))||-1!=t.name.indexOf(r))));t.objects.forEach(e=>{const t=s(e);t&&e.upVisit(e=>{e.searched=e.searched|t,e.searched&&n++})})}this._list&&this._list.forceUpdateGrid(),this.setState({search:e.target.value,searchResults:n})}),this.onResize=(()=>{this.forceUpdate()}),this.rowRenderer=(e=>{let{index:t,...i}=e;const{key:r,style:n}=i,a=this.group.firstLevelChild(t);return s.a.createElement("div",{className:_()("TreeRow",{searched:a&&a.searched}),key:r,style:n},this.group.renderLine(t))}),this.onDownload=(()=>{this.setState({showDownload:this.props.type})}),this.onCloseDownload=(()=>{this.setState({showDownload:!1})})}render(){const{data:e,type:t,id:i,className:r,...n}=this.props,{search:a,searchResults:o,showDownload:l}=this.state;if(!this.group||this.group._data!==e||this.group._type!==t){const i=Ce[t];if(!i)return null;this.group=new We(e.objects.filter(e=>e.type===t),i),this.group._data=e,this.group._type=t,this.group.onResize=this.onResize,setTimeout(()=>{this._list&&this._list.forceUpdateGrid()})}if(!o&&this.group._id!==i){const r=e.objects.find(e=>e.type===t&&e.id===i);if(r){this.group.onResize=null;const e=this.group.expandItem(r);this.group.onResize=this.onResize,this.group._id=i,setTimeout(()=>{this._list&&this._list.scrollToRow(e)})}}return s.a.createElement(Oe.a,Object.assign({className:_()(r,"ObjectList")},n),s.a.createElement(Ge,{data:e,show:l,onHide:this.onCloseDownload}),s.a.createElement("div",{className:"search-box"},s.a.createElement(De.a,{type:"text",value:a,placeholder:"Search",onKeyDown:this.onSearchKeyDown,onChange:this.onSearch}),s.a.createElement(u.a,{active:!!l,onClick:this.onDownload,size:"small"},s.a.createElement("span",{glyph:"download-alt"})),s.a.createElement(Ae.Consumer,null,e=>s.a.createElement(ye.Consumer,null,t=>s.a.createElement(u.a,{active:e,onClick:t,size:"small"},s.a.createElement("span",{glyph:"cog"}))))),s.a.createElement("div",{className:"ObjectListItems"},s.a.createElement(Me.a,null,e=>{let{width:t,height:i}=e;return s.a.createElement(Me.c,{className:"ObjectLines",ref:e=>this._list=e,width:t,height:i,rowCount:this.group.height,rowHeight:18,rowRenderer:this.rowRenderer})})))}}Ke.contextType=Ae;var ze=i(444);function qe(e,t){return i=>s.a.createElement("span",{style:{color:t},key:i},e)}function Xe(e,t){const i=[];let r=null,n=i;e=e.split("\n").join("|n");const a=/<(\w+),(\w+)(,%)?>|\|([rn])|\|c[0-9a-zA-Z]{2}([0-9a-zA-Z]{6})/gi;let o=0,l=null;for(;l=a.exec(e);){if(l.index>o&&n.push(e.substring(o,l.index)),l[1]){const e=t&&t.objects.find(e=>e.id===l[1]),i=l[2].toLowerCase();e&&e.data[i]?n.push(parseFloat(e.data[i])*(l[3]?100:1)):n.push(l[0])}else"n"===l[4]||"N"===l[4]?n.push(s.a.createElement("br",{key:n.length})):("r"===l[4]||"R"===l[4]||l[5])&&(r&&(i.push(r(i.length)),n=i,r=null),l[5]&&(r=qe(n=[],"#"+l[5])));o=l.index+l[0].length}return o<e.length&&n.push(e.substring(o)),r&&i.push(r(i.length)),i}const Je=e=>{let{objectId:t}=e;const[i,r]=Object(n.useState)(null);return Object(n.useEffect)(()=>{t&&async function(){r(t)}()},[t]),i?s.a.createElement("div",null,s.a.createElement(ze.a.Title,null,i.name),s.a.createElement(ze.a.Content,null,i.description||"No description available.",i.icon&&s.a.createElement("img",{src:oe.image(i.icon),alt:"".concat(i.name," Icon"),className:"object-icon"}))):s.a.createElement(ze.a.Title,null,"Loading...")};var Qe=e=>{let{objectId:t,children:i}=e;return s.a.createElement(R.a,{overlay:s.a.createElement(ze.a,{id:"objectId"},s.a.createElement(Je,{objectId:t}))},"string"===typeof i?s.a.createElement("span",null,i):i)};class $e{constructor(e){this.properties=new Map,this.sections=new Map,e&&this.load(e)}load(e){let t=this.properties,i=this.sections;for(let r of e.split(/\r\n?|\n/))if(r.length&&!r.startsWith("//")&&!r.startsWith(";")){let e=r.match(/^\[(.+?)\]/);if(e){let r=e[1].trim().toLowerCase();(t=i.get(r))||(t=new Map,i.set(r,t))}else(e=r.match(/^(.+?)=(.*?)$/))&&t.set(e[1].toLowerCase(),e[2])}}save(){let e=[];for(let[t,i]of this.properties)e.push("".concat(t,"=").concat(i));for(let[t,i]of this.sections){e.push("[".concat(t,"]"));for(let[t,r]of i)e.push("".concat(t,"=").concat(r))}return e.join("\r\n")}getSection(e){return this.sections.get(e.toLowerCase())}}var Ze={IniFile:$e};class et{constructor(e){this.rows=[],e&&this.load(e)}load(e){if(!e.startsWith("ID"))throw new Error("WrongMagicNumber");let t=this.rows,i=0,r=0;for(let n of e.split("\n"))if("B"!==n[0])for(let e of n.split(";")){let n,s=e[0],a=e.substring(1).trim();"X"===s?i=parseInt(a,10)-1:"Y"===s?r=parseInt(a,10)-1:"K"===s?(t[r]||(t[r]=[]),n='"'===a[0]?a.substring(1,a.length-1):"TRUE"===a||"FALSE"!==a&&parseFloat(a),t[r][i]=n):"A"===s&&(this.comments||(this.comments=[]),this.comments[r]||(this.comments[r]=[]),this.comments[r][i]=a)}this.cols=this.rows.reduce((e,t)=>Math.max(e,t.length),0)}}var tt={SlkFile:et};let it=new ArrayBuffer(8),rt=new Int8Array(it),nt=new Int16Array(it),st=new Int32Array(it),at=new Uint8Array(it),ot=new Uint16Array(it),lt=new Uint32Array(it),ht=new Float32Array(it),ct=new Float64Array(it);function dt(e){return at[0]=e,rt[0]}function ut(e,t){return at[0]=e,at[1]=t,nt[0]}function mt(e,t){return at[0]=e,at[1]=t,ot[0]}function ft(e,t,i){return at[0]=e,at[1]=t,at[2]=i,at[3]=0,lt[0]}function pt(e,t,i,r){return at[0]=e,at[1]=t,at[2]=i,at[3]=r,lt[0]}function Et(e,t,i,r){return at[0]=e,at[1]=t,at[2]=i,at[3]=r,ht[0]}function gt(e,t,i,r,n,s,a,o){return at[0]=e,at[1]=t,at[2]=i,at[3]=r,at[4]=n,at[5]=s,at[6]=a,at[7]=o,ct[0]}function At(e){return at[0]=e,rt[0]}function _t(e,t){return nt[0]=t,e[0]=at[0],e[1]=at[1],e}function Tt(e,t){return st[0]=t,e[0]=at[0],e[1]=at[1],e[2]=at[2],e[3]=at[3],e}function vt(e,t){return ot[0]=t,e[0]=at[0],e[1]=at[1],e}function yt(e,t){return lt[0]=t,e[0]=at[0],e[1]=at[1],e[2]=at[2],e[3]=at[3],e}function wt(e,t){return ht[0]=t,e[0]=at[0],e[1]=at[1],e[2]=at[2],e[3]=at[3],e}function St(e,t){return ct[0]=t,e[0]=at[0],e[1]=at[1],e[2]=at[2],e[3]=at[3],e[4]=at[4],e[5]=at[5],e[6]=at[6],e[7]=at[7],e}let Rt=new Uint8Array(8);class bt{constructor(e,t,i){if(ArrayBuffer.isView(e)&&(t=(e=e.buffer).byteOffset,i=e.byteLength),!(e instanceof ArrayBuffer))throw new TypeError("BinaryStream: expected ArrayBuffer or ArrayBufferView, got ".concat(e));this.buffer=e,this.uint8array=new Uint8Array(e,t,i),this.index=0,this.byteLength=e.byteLength}substream(e){return new bt(this.buffer,this.index,e)}remaining(){return this.byteLength-this.index}skip(e){this.index+=e}seek(e){this.index=e}tell(){return this.index}peek(e,t){let i=this.uint8array,r=this.index,n=[];if(r+e>i.length)throw new RangeError("BinaryStream: read outside of range");for(let s=0;s<e;s++){let e=i[r+s];(t||e>0)&&n.push(e)}return String.fromCharCode(...n)}read(e,t){e=e||this.remaining();let i=this.peek(e,t);return this.index+=e,i}peekUntilNull(){let e=this.uint8array,t=this.index,i=e[t],r=0;for(;0!==i&&t+r<e.length;)i=e[t+(r+=1)];return String.fromCharCode(...e.subarray(t,t+r))}readUntilNull(){let e=this.peekUntilNull();return this.index+=e.length+1,e}peekCharArray(e){let t=this.uint8array,i=this.index,r=[];if(i+e>t.length)throw new RangeError("BinaryStream: read outside of range");for(let n=0;n<e;n++)r[n]=String.fromCharCode(t[i+n]);return r}readCharArray(e){let t=this.peekCharArray(e);return this.index+=e,t}readInt8(){let e=this.index,t=this.uint8array;if(e+1>t.length)throw new RangeError("BinaryStream: read outside of range");let i=dt(t[e]);return this.index+=1,i}readInt16(){let e=this.index,t=this.uint8array;if(e+2>t.length)throw new RangeError("BinaryStream: read outside of range");let i=ut(t[e],t[e+1]);return this.index+=2,i}readInt32(){let e=this.index,t=this.uint8array;if(e+4>t.length)throw new RangeError("BinaryStream: read outside of range");let i=(r=t[e],n=t[e+1],s=t[e+2],a=t[e+3],at[0]=r,at[1]=n,at[2]=s,at[3]=a,st[0]);var r,n,s,a;return this.index+=4,i}readUint8(){if(this.index+1>this.uint8array.length)throw new RangeError("BinaryStream: read outside of range");let e=this.uint8array[this.index];return this.index+=1,e}readUint16(){let e=this.index,t=this.uint8array;if(e+2>t.length)throw new RangeError("BinaryStream: read outside of range");let i=mt(t[e],t[e+1]);return this.index+=2,i}readUint32(){let e=this.index,t=this.uint8array;if(e+4>t.length)throw new RangeError("BinaryStream: read outside of range");let i=pt(t[e],t[e+1],t[e+2],t[e+3]);return this.index+=4,i}readFloat32(){let e=this.index,t=this.uint8array;if(e+4>t.length)throw new RangeError("BinaryStream: read outside of range");let i=Et(t[e],t[e+1],t[e+2],t[e+3]);return this.index+=4,i}readFloat64(){let e=this.index,t=this.uint8array;if(e+8>t.length)throw new RangeError("BinaryStream: read outside of range");let i=gt(t[e],t[e+1],t[e+2],t[e+3],t[e+4],t[e+5],t[e+6],t[e+7]);return this.index+=8,i}readInt8Array(e){ArrayBuffer.isView(e)||(e=new Int8Array(e));let t=this.index,i=this.uint8array;if(t+e.byteLength>i.length)throw new RangeError("BinaryStream: read outside of range");for(let r=0,n=e.length;r<n;r++)e[r]=dt(i[t+r]);return this.index+=e.byteLength,e}readInt16Array(e){ArrayBuffer.isView(e)||(e=new Int16Array(e));let t=this.index,i=this.uint8array;if(t+e.byteLength>i.length)throw new RangeError("BinaryStream: read outside of range");for(let r=0,n=e.length;r<n;r++){let n=t+2*r;e[r]=ut(i[n],i[n+1])}return this.index+=e.byteLength,e}readInt32Array(e){ArrayBuffer.isView(e)||(e=new Int32Array(e));let t=this.index,i=this.uint8array;if(t+e.byteLength>i.length)throw new RangeError("BinaryStream: read outside of range");for(let r=0,n=e.length;r<n;r++){let n=t+4*r;e[r]=ut(i[n],i[n+1],i[n+2],i[n+3])}return this.index+=e.byteLength,e}readUint8Array(e){ArrayBuffer.isView(e)||(e=new Uint8Array(e));let t=this.index,i=this.uint8array;if(t+e.byteLength>i.length)throw new RangeError("BinaryStream: read outside of range");for(let r=0,n=e.length;r<n;r++)e[r]=i[t+r];return this.index+=e.byteLength,e}readUint16Array(e){ArrayBuffer.isView(e)||(e=new Uint16Array(e));let t=this.index,i=this.uint8array;if(t+e.byteLength>i.length)throw new RangeError("BinaryStream: read outside of range");for(let r=0,n=e.length;r<n;r++){let n=t+2*r;e[r]=mt(i[n],i[n+1])}return this.index+=e.byteLength,e}readUint32Array(e){ArrayBuffer.isView(e)||(e=new Uint32Array(e));let t=this.index,i=this.uint8array;if(t+e.byteLength>i.length)throw new RangeError("BinaryStream: read outside of range");for(let r=0,n=e.length;r<n;r++){let n=t+4*r;e[r]=pt(i[n],i[n+1],i[n+2],i[n+3])}return this.index+=e.byteLength,e}readFloat32Array(e){ArrayBuffer.isView(e)||(e=new Float32Array(e));let t=this.index,i=this.uint8array;if(t+e.byteLength>i.length)throw new RangeError("BinaryStream: read outside of range");for(let r=0,n=e.length;r<n;r++){let n=t+4*r;e[r]=Et(i[n],i[n+1],i[n+2],i[n+3])}return this.index+=e.byteLength,e}readFloat64Array(e){ArrayBuffer.isView(e)||(e=new Float64Array(e));let t=this.index,i=this.uint8array;if(t+e.byteLength>i.length)throw new RangeError("BinaryStream: read outside of range");for(let r=0,n=e.length;r<n;r++){let n=t+8*r;e[r]=gt(i[n],i[n+1],i[n+2],i[n+3],i[n+4],i[n+5],i[n+6],i[n+7])}return this.index+=e.byteLength,e}readTypedArray(e){let t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),i=this.index,r=this.uint8array;if(i+t.length>r.length)throw new RangeError("BinaryStream: read outside of range");for(let n=0,s=t.length;n<s;n++)t[n]=r[i+n];this.index+=t.length}write(e){let t=this.index,i=this.uint8array,r=e.length;for(let n=0;n<r;n++)i[t+n]=e.charCodeAt(n);this.index+=r}writeInt8(e){this.uint8array[this.index]=At(e),this.index+=1}writeInt16(e){let t=this.index,i=this.uint8array;_t(Rt,e),i[t]=Rt[0],i[t+1]=Rt[1],this.index+=2}writeInt32(e){let t=this.index,i=this.uint8array;Tt(Rt,e),i[t]=Rt[0],i[t+1]=Rt[1],i[t+2]=Rt[2],i[t+3]=Rt[3],this.index+=4}writeUint8(e){this.uint8array[this.index]=e,this.index+=1}writeUint16(e){let t=this.index,i=this.uint8array;vt(Rt,e),i[t]=Rt[0],i[t+1]=Rt[1],this.index+=2}writeUint32(e){let t=this.index,i=this.uint8array;yt(Rt,e),i[t]=Rt[0],i[t+1]=Rt[1],i[t+2]=Rt[2],i[t+3]=Rt[3],this.index+=4}writeFloat32(e){let t=this.index,i=this.uint8array;wt(Rt,e),i[t]=Rt[0],i[t+1]=Rt[1],i[t+2]=Rt[2],i[t+3]=Rt[3],this.index+=4}writeFloat64(e){let t=this.index,i=this.uint8array;St(Rt,e),i[t]=Rt[0],i[t+1]=Rt[1],i[t+2]=Rt[2],i[t+3]=Rt[3],i[t+4]=Rt[4],i[t+5]=Rt[5],i[t+6]=Rt[6],i[t+7]=Rt[7],this.index+=8}writeInt8Array(e){let t=this.index,i=this.uint8array;for(let r=0,n=e.length;r<n;r++)i[t+r]=At(e[r]);this.index+=e.byteLength}writeInt16Array(e){let t=this.index,i=this.uint8array;for(let r=0,n=e.length;r<n;r++){let n=t+2*r;_t(Rt,e[r]),i[n]=Rt[0],i[n+1]=Rt[1]}this.index+=e.byteLength}writeInt32Array(e){let t=this.index,i=this.uint8array;for(let r=0,n=e.length;r<n;r++){let n=t+4*r;Tt(Rt,e[r]),i[n]=Rt[0],i[n+1]=Rt[1],i[n+2]=Rt[2],i[n+3]=Rt[3]}this.index+=e.byteLength}writeUint8Array(e){let t=this.index,i=this.uint8array;for(let r=0,n=e.length;r<n;r++)i[t+r]=e[r];this.index+=e.byteLength}writeUint16Array(e){let t=this.index,i=this.uint8array;for(let r=0,n=e.length;r<n;r++){let n=t+2*r;vt(Rt,e[r]),i[n]=Rt[0],i[n+1]=Rt[1]}this.index+=e.byteLength}writeUint32Array(e){let t=this.index,i=this.uint8array;for(let r=0,n=e.length;r<n;r++){let n=t+4*r;yt(Rt,e[r]),i[n]=Rt[0],i[n+1]=Rt[1],i[n+2]=Rt[2],i[n+3]=Rt[3]}this.index+=e.byteLength}writeFloat32Array(e){let t=this.index,i=this.uint8array;for(let r=0,n=e.length;r<n;r++){let n=t+4*r;wt(Rt,e[r]),i[n]=Rt[0],i[n+1]=Rt[1],i[n+2]=Rt[2],i[n+3]=Rt[3]}this.index+=e.byteLength}writeFloat64Array(e){let t=this.index,i=this.uint8array;for(let r=0,n=e.length;r<n;r++){let n=t+8*r;St(Rt,e[r]),i[n]=Rt[0],i[n+1]=Rt[1],i[n+2]=Rt[2],i[n+3]=Rt[3],i[n+4]=Rt[4],i[n+5]=Rt[5],i[n+6]=Rt[6],i[n+7]=Rt[7]}this.index+=e.byteLength}writeTypedArray(e){let t=new Uint8Array(e.buffer),i=this.index,r=this.uint8array;for(let n=0,s=t.length;n<s;n++)r[i+n]=t[n]}}class It{constructor(){this.id="\0\0\0\0",this.chance=0}load(e){this.id=e.read(4,!0),this.chance=e.readInt32()}save(e){e.write(this.id),e.writeInt32(this.chance)}}class Lt{constructor(){this.items=[]}load(e){for(let t=0,i=e.readUint32();t<i;t++){let t=new It;t.load(e),this.items.push(t)}}save(e){e.writeUint32(this.items.length);for(let t of this.items)t.save(e)}getByteLength(){return 4+8*this.items.length}}class Nt{constructor(){this.id="\0\0\0\0",this.variation=0,this.location=new Float32Array(3),this.angle=0,this.scale=new Float32Array([1,1,1]),this.flags=0,this.life=0,this.itemTable=-1,this.itemSets=[],this.editorId=0,this.u1=new Uint8Array(8)}load(e,t){if(this.id=e.read(4,!0),this.variation=e.readInt32(),this.location=e.readFloat32Array(3),this.angle=e.readFloat32(),this.scale=e.readFloat32Array(3),this.flags=e.readUint8(),this.life=e.readUint8(),t>7){this.itemTable=e.readUint32();for(let t=0,i=e.readUint32();t<i;t++){let t=new Lt;t.load(e),this.itemSets.push(t)}}this.editorId=e.readInt32()}save(e,t){if(e.write(this.id),e.writeInt32(this.variation),e.writeFloat32Array(this.location),e.writeFloat32(this.angle),e.writeFloat32Array(this.scale),e.writeUint8(this.flags),e.writeUint8(this.life),t>7){e.writeUint32(this.itemTable),e.writeUint32(this.itemSets.length);for(let t of this.itemSets)t.save(e)}e.writeInt32(this.editorId)}getByteLength(e){let t=42;if(e>7){t+=8;for(let e of this.itemSets)t+=e.getByteLength()}return t}}class xt{constructor(){this.id="\0\0\0\0",this.variation=0,this.location=new Uint32Array(2)}load(e,t){this.id=e.read(4,!0),this.variation=e.readUint32(),this.location=e.readUint32Array(2)}save(e,t){e.write(this.id),e.writeUint32(this.variation),e.writeUint32Array(this.location)}}class Pt{constructor(e){this.version=0,this.u1=new Uint8Array(4),this.doodads=[],this.u2=new Uint8Array(4),this.terrainDoodads=[],e&&this.load(e)}load(e){let t=new bt(e);if("W3do"!==t.read(4))return!1;this.version=t.readInt32(),this.u1=t.readUint8Array(4);for(let i=0,r=t.readInt32();i<r;i++){let e=new Nt;e.load(t,this.version),this.doodads.push(e)}this.u2=t.readUint8Array(4);for(let i=0,r=t.readInt32();i<r;i++){let e=new xt;e.load(t,this.version),this.terrainDoodads.push(e)}return!0}save(){let e=new ArrayBuffer(this.getByteLength()),t=new bt(e);t.write("W3do"),t.writeInt32(this.version),t.writeUint8Array(this.u1),t.writeUint32(this.doodads.length);for(let i of this.doodads)i.save(t,this.version);t.writeUint8Array(this.u2),t.writeUint32(this.terrainDoodads.length);for(let i of this.terrainDoodads)i.save(t,this.version);return e}getByteLength(){let e=24+16*this.terrainDoodads.length;for(let t of this.doodads)e+=t.getByteLength(this.version);return e}}class Ct{constructor(){this.isCustom=0,this.name=""}load(e){this.isCustom=e.readUint8(),this.name=e.readUntilNull()}save(e){e.writeUint8(this.isCustom),e.write("".concat(this.name,"\0"))}getByteLength(){return 2+this.name.length}}class Ut{constructor(e){this.version=1,this.entries=new Map,e&&this.load(e)}load(e){let t=new bt(e);this.version=t.readUint32();for(let i=0,r=t.readUint32();i<r;i++){let e=new Ct;e.load(t),e.isCustom?this.entries.set(e.name,e):this.entries.set("war3mapimported\\".concat(e.name),e)}}save(){let e=new ArrayBuffer(this.getByteLength()),t=new bt(e);t.writeUint32(this.version),t.writeUint32(this.entries.size);for(let i of this.entries.values())i.save(t);return e}getByteLength(){let e=8;for(let t of this.entries.values())e+=t.getByteLength();return e}set(e){if(!this.entries.has(e)){let t=new Ct;return t.isCustom=10,t.path=e,this.entries.set(e,t),!0}return!1}has(e){return this.entries.has(e)}delete(e){return this.entries.delete(e)}rename(e,t){let i=this.entries.get(e);return!!i&&(i.isCustom=10,i.path=t,!0)}}class Ot{constructor(){this.id="\0\0\0\0",this.variableType=0,this.levelOrVariation=0,this.dataPointer=0,this.value=0,this.u1=0}load(e,t){if(this.id=e.read(4,!0),this.variableType=e.readInt32(),t&&(this.levelOrVariation=e.readInt32(),this.dataPointer=e.readInt32()),0===this.variableType)this.value=e.readInt32();else if(1===this.variableType||2===this.variableType)this.value=e.readFloat32();else{if(3!==this.variableType)throw new Error("Modification: unknown variable type ".concat(this.variableType));this.value=e.readUntilNull()}this.u1=e.readInt32()}save(e,t){if(e.write(this.id),e.writeInt32(this.variableType),t&&(e.writeInt32(this.levelOrVariation),e.writeInt32(this.dataPointer)),0===this.variableType)e.writeInt32(this.value);else if(1===this.variableType||2===this.variableType)e.writeFloat32(this.value);else{if(3!==this.variableType)throw new Error("Modification: unknown variable type ".concat(this.variableType));e.write("".concat(this.value,"\0"))}e.writeInt32(this.u1)}getByteLength(e){let t=12;return e&&(t+=8),3===this.variableType?t+=1+this.value.length:t+=4,t}}class Dt{constructor(){this.oldId="\0\0\0\0",this.newId="\0\0\0\0",this.modifications=[]}load(e,t){this.oldId=e.read(4,!0),this.newId=e.read(4,!0);for(let i=0,r=e.readUint32();i<r;i++){let r=new Ot;r.load(e,t),this.modifications[i]=r}}save(e,t){this.oldId?e.write(this.oldId):e.writeUint32(0),this.newId?e.write(this.newId):e.writeUint32(0),e.writeUint32(this.modifications.length);for(let i of this.modifications)i.save(e,t)}getByteLength(e){let t=12;for(let i of this.modifications)t+=i.getByteLength(e);return t}}class Mt{constructor(){this.objects=[]}load(e,t){for(let i=0,r=e.readUint32();i<r;i++){let r=new Dt;r.load(e,t),this.objects[i]=r}}save(e,t){e.writeUint32(this.objects.length);for(let i of this.objects)i.save(e,t)}getByteLength(e){let t=4;for(let i of this.objects)t+=i.getByteLength(e);return t}}class Ft{constructor(e){this.version=0,this.originalTable=new Mt,this.customTable=new Mt,e&&this.load(e)}load(e){let t=new bt(e);this.version=t.readInt32(),this.originalTable.load(t,!0),this.customTable.load(t,!0)}save(){let e=new ArrayBuffer(this.getByteLength()),t=new bt(e);return t.writeInt32(this.version),this.originalTable.save(t,!0),this.customTable.save(t,!0),e}getByteLength(){return 4+this.originalTable.getByteLength(!0)+this.customTable.getByteLength(!0)}}class Bt{constructor(){this.groundHeight=0,this.waterHeight=0,this.mapEdge=0,this.ramp=0,this.blight=0,this.water=0,this.boundary=0,this.groundTexture=0,this.cliffVariation=0,this.groundVariation=0,this.cliffTexture=0,this.layerHeight=0}load(e){this.groundHeight=(e.readInt16()-8192)/512;let t=e.readInt16();this.waterHeight=((16383&t)-8192)/512,this.mapEdge=16384&t;let i=e.readUint8();this.ramp=16&i,this.blight=32&i,this.water=64&i,this.boundary=128&i,this.groundTexture=15&i;let r=e.readUint8();this.cliffVariation=(224&r)>>>5,this.groundVariation=31&r;let n=e.readUint8();this.cliffTexture=(240&n)>>>4,this.layerHeight=15&n}save(e){e.writeInt16(512*this.groundHeight+8192),e.writeInt16(512*this.waterHeight+8192+this.mapEdge<<14),e.writeUint8(this.ramp<<4|this.blight<<5|this.water<<6|this.boundary<<7|this.groundTexture),e.writeUint8(this.cliffVariation<<5|this.groundVariation),e.writeUint8((this.cliffTexture<<4)+this.layerHeight)}}class Vt{constructor(e){this.version=0,this.tileset="A",this.haveCustomTileset=0,this.groundTilesets=[],this.cliffTilesets=[],this.mapSize=new Int32Array(2),this.centerOffset=new Float32Array(2),this.corners=[],e instanceof ArrayBuffer&&this.load(e)}load(e){let t=new bt(e);if("W3E!"!==t.read(4))return!1;this.version=t.readInt32(),this.tileset=t.read(1),this.haveCustomTileset=t.readInt32();for(let n=0,s=t.readInt32();n<s;n++)this.groundTilesets[n]=t.read(4);for(let n=0,s=t.readInt32();n<s;n++)this.cliffTilesets[n]=t.read(4);this.mapSize=t.readInt32Array(2),this.centerOffset=t.readFloat32Array(2);let[i,r]=this.mapSize;for(let n=0;n<r;n++){this.corners[n]=[];for(let e=0;e<i;e++){let i=new Bt;i.load(t),this.corners[n][e]=i}}return!0}save(){let e=new ArrayBuffer(this.getByteLength()),t=new bt(e);t.write("W3E!"),t.writeInt32(this.version),t.write(this.tileset),t.writeInt32(this.haveCustomTileset),t.writeUint32(this.groundTilesets.length);for(let i of this.groundTilesets)t.write(i);t.writeUint32(this.cliffTilesets.length);for(let i of this.cliffTilesets)t.write(i);t.writeInt32Array(this.mapSize),t.writeFloat32Array(this.centerOffset);for(let i of this.corners)for(let e of i)e.save(t);return e}getByteLength(){return 37+4*this.groundTilesets.length+4*this.cliffTilesets.length+this.mapSize[0]*this.mapSize[1]*7}}class kt{constructor(){this.id=0,this.type=0,this.race=0,this.isFixedStartPosition=0,this.name="",this.startLocation=new Float32Array(2),this.allyLowPriorities=0,this.allyHighPriorities=0}load(e){this.id=e.readInt32(),this.type=e.readInt32(),this.race=e.readInt32(),this.isFixedStartPosition=e.readInt32(),this.name=e.readUntilNull(),this.startLocation=e.readFloat32Array(2),this.allyLowPriorities=e.readUint32(),this.allyHighPriorities=e.readUint32()}save(e){e.writeInt32(this.id),e.writeInt32(this.type),e.writeInt32(this.race),e.writeInt32(this.isFixedStartPosition),e.write("".concat(this.name,"\0")),e.writeFloat32Array(this.startLocation),e.writeUint32(this.allyLowPriorities),e.writeUint32(this.allyHighPriorities)}getByteLength(){return 33+this.name.length}}class Gt{constructor(){this.flags=0,this.playerMasks=0,this.name=""}load(e){this.flags=e.readUint32(),this.playerMasks=e.readUint32(),this.name=e.readUntilNull()}save(e){e.writeUint32(this.flags),e.writeUint32(this.playerMasks),e.write("".concat(this.name,"\0"))}getByteLength(){return 9+this.name.length}}class jt{constructor(){this.playerFlags=0,this.id="\0\0\0\0",this.levelAffected=0,this.availability=0}load(e){this.playerFlags=e.readUint32(),this.id=e.read(4,!0),this.levelAffected=e.readInt32(),this.availability=e.readInt32()}save(e){e.writeUint32(this.playerFlags),e.write(this.id),e.writeInt32(this.levelAffected),e.writeInt32(this.availability)}}class Yt{constructor(){this.playerFlags=0,this.id="\0\0\0\0"}load(e){this.playerFlags=e.readUint32(),this.id=e.read(4,!0)}save(e){e.writeUint32(this.playerFlags),e.write(this.id)}}class Ht{constructor(){this.chance=0,this.ids=[]}load(e,t){this.chance=e.readInt32();for(let i=0;i<t;i++)this.ids[i]=e.read(4,!0)}save(e){e.writeInt32(this.chance);for(let t of this.ids)e.write(t)}}class Wt{constructor(){this.id=0,this.name="",this.positions=0,this.columnTypes=new Int32Array(1),this.units=[]}load(e){this.id=e.readInt32(),this.name=e.readUntilNull(),this.positions=e.readInt32(),this.columnTypes=e.readInt32Array(this.positions);for(let t=0,i=e.readUint32();t<i;t++){let i=new Ht;i.load(e,this.positions),this.units[t]=i}}save(e){e.writeInt32(this.id),e.write("".concat(this.name,"\0")),e.writeInt32(this.positions),e.writeInt32Array(this.columnTypes),e.writeUint32(this.units.length);for(let t of this.units)t.save(e)}getByteLength(){return 13+this.name.length+this.columnTypes.byteLength+this.units.length*(4+4*this.positions)}}class Kt{constructor(){this.chance=0,this.id="\0\0\0\0"}load(e){this.chance=e.readInt32(),this.id=e.read(4,!0)}save(e){e.writeInt32(this.chance),e.write(this.id)}}class zt{constructor(){this.items=[]}load(e){for(let t=0,i=e.readUint32();t<i;t++){let i=new Kt;i.load(e),this.items[t]=i}}save(e){e.writeUint32(this.items.length);for(let t of this.items)t.save(e)}getByteLength(){return 4+8*this.items.length}}class qt{constructor(){this.id=0,this.name="",this.sets=[]}load(e){this.id=e.readInt32(),this.name=e.readUntilNull();for(let t=0,i=e.readUint32();t<i;t++){let i=new zt;i.load(e),this.sets[t]=i}}save(e){e.writeInt32(this.id),e.write("".concat(this.name,"\0")),e.writeUint32(this.sets.length);for(let t of this.sets)t.save(e)}getByteLength(){let e=9+this.name.length;for(let t of this.sets)e+=t.getByteLength();return e}}class Xt{constructor(e){this.version=0,this.saves=0,this.editorVersion=0,this.name="",this.author="",this.description="",this.recommendedPlayers="",this.cameraBounds=new Float32Array(8),this.cameraBoundsComplements=new Int32Array(4),this.playableSize=new Int32Array(2),this.flags=0,this.tileset="\0",this.campaignBackground=0,this.loadingScreenModel="",this.loadingScreenText="",this.loadingScreenTitle="",this.loadingScreenSubtitle="",this.loadingScreen=0,this.prologueScreenModel="",this.prologueScreenText="",this.prologueScreenTitle="",this.prologueScreenSubtitle="",this.useTerrainFog=0,this.fogHeight=new Float32Array(2),this.fogDensity=0,this.fogColor=new Uint8Array(4),this.globalWeather=0,this.soundEnvironment="",this.lightEnvironmentTileset="\0",this.waterVertexColor=new Uint8Array(4),this.players=[],this.forces=[],this.upgradeAvailabilityChanges=[],this.techAvailabilityChanges=[],this.randomUnitTables=[],this.randomItemTables=[],e&&this.load(e)}load(e){let t=new bt(e);this.version=t.readInt32(),this.saves=t.readInt32(),this.editorVersion=t.readInt32(),this.version>=27&&(this.gameVersionMajor=t.readInt32(),this.gameVersionMinor=t.readInt32(),this.gameVersionPatch=t.readInt32(),this.gameVersionBuild=t.readInt32()),this.name=t.readUntilNull(),this.author=t.readUntilNull(),this.description=t.readUntilNull(),this.recommendedPlayers=t.readUntilNull(),this.cameraBounds=t.readFloat32Array(8),this.cameraBoundsComplements=t.readInt32Array(4),this.playableSize=t.readInt32Array(2),this.flags=t.readUint32(),this.tileset=t.read(1),this.campaignBackground=t.readInt32(),this.version>24&&(this.loadingScreenModel=t.readUntilNull()),this.loadingScreenText=t.readUntilNull(),this.loadingScreenTitle=t.readUntilNull(),this.loadingScreenSubtitle=t.readUntilNull(),this.loadingScreen=t.readInt32(),this.version>24&&(this.prologueScreenModel=t.readUntilNull()),this.prologueScreenText=t.readUntilNull(),this.prologueScreenTitle=t.readUntilNull(),this.prologueScreenSubtitle=t.readUntilNull(),this.version>24&&(this.useTerrainFog=t.readInt32(),this.fogHeight=t.readFloat32Array(2),this.fogDensity=t.readFloat32(),this.fogColor=t.readUint8Array(4),this.globalWeather=t.readInt32(),this.soundEnvironment=t.readUntilNull(),this.lightEnvironmentTileset=t.read(1,!0),this.waterVertexColor=t.readUint8Array(4)),this.version>=27&&(this.lua=t.readInt32());for(let i=0,r=t.readInt32();i<r;i++){let e=new kt;e.load(t),this.players[i]=e}for(let i=0,r=t.readInt32();i<r;i++){let e=new Gt;e.load(t),this.forces[i]=e}if(t.index!==t.byteLength-1){for(let e=0,i=t.readInt32();e<i;e++){let i=new jt;i.load(t),this.upgradeAvailabilityChanges[e]=i}if(!(t.index>=t.byteLength-1)){for(let e=0,i=t.readInt32();e<i;e++){let i=new Yt;i.load(t),this.techAvailabilityChanges[e]=i}for(let e=0,i=t.readInt32();e<i;e++){let i=new Wt;i.load(t),this.randomUnitTables[e]=i}if(this.version>24)for(let e=0,i=t.readInt32();e<i;e++){let i=new qt;i.load(t),this.randomItemTables[e]=i}}}}save(){let e=new ArrayBuffer(this.getByteLength()),t=new bt(e);t.writeInt32(this.version),t.writeInt32(this.saves),t.writeInt32(this.editorVersion),t.write("".concat(this.name,"\0")),t.write("".concat(this.author,"\0")),t.write("".concat(this.description,"\0")),t.write("".concat(this.recommendedPlayers,"\0")),t.writeFloat32Array(this.cameraBounds),t.writeInt32Array(this.cameraBoundsComplements),t.writeInt32Array(this.playableSize),t.writeUint32(this.flags),t.write(this.tileset),t.writeInt32(this.campaignBackground),this.version>24&&t.write("".concat(this.loadingScreenModel,"\0")),t.write("".concat(this.loadingScreenText,"\0")),t.write("".concat(this.loadingScreenTitle,"\0")),t.write("".concat(this.loadingScreenSubtitle,"\0")),t.writeInt32(this.loadingScreen),this.version>24&&t.write("".concat(this.prologueScreenModel,"\0")),t.write("".concat(this.prologueScreenText,"\0")),t.write("".concat(this.prologueScreenTitle,"\0")),t.write("".concat(this.prologueScreenSubtitle,"\0")),this.version>24&&(t.writeInt32(this.useTerrainFog),t.writeFloat32Array(this.fogHeight),t.writeFloat32(this.fogDensity),t.writeUint8Array(this.fogColor),t.writeInt32(this.globalWeather),t.write("".concat(this.soundEnvironment,"\0")),t.write(this.lightEnvironmentTileset),t.writeUint8Array(this.waterVertexColor)),t.writeUint32(this.players.length);for(let i of this.players)i.save(t);t.writeUint32(this.forces.length);for(let i of this.forces)i.save(t);t.writeUint32(this.upgradeAvailabilityChanges.length);for(let i of this.upgradeAvailabilityChanges)i.save(t);t.writeUint32(this.techAvailabilityChanges.length);for(let i of this.techAvailabilityChanges)i.save(t);t.writeUint32(this.randomUnitTables.length);for(let i of this.randomUnitTables)i.save(t);if(this.version>24){t.writeUint32(this.randomItemTables.length);for(let e of this.randomItemTables)e.save(t)}return e}getByteLength(){let e=111+this.name.length+this.author.length+this.description.length+this.recommendedPlayers.length+this.loadingScreenText.length+this.loadingScreenTitle.length+this.loadingScreenSubtitle.length+this.prologueScreenText.length+this.prologueScreenTitle.length+this.prologueScreenSubtitle.length;for(let t of this.players)e+=t.getByteLength();for(let t of this.forces)e+=t.getByteLength();e+=16*this.upgradeAvailabilityChanges.length,e+=8*this.techAvailabilityChanges.length;for(let t of this.randomUnitTables)e+=t.getByteLength();if(this.version>24){e+=36+this.loadingScreenModel.length+this.prologueScreenModel.length+this.soundEnvironment.length;for(let t of this.randomItemTables)e+=t.getByteLength()}return e}}class Jt{constructor(e){this.version=0,this.originalTable=new Mt,this.customTable=new Mt,e&&this.load(e)}load(e){let t=new bt(e);this.version=t.readInt32(),this.originalTable.load(t,!1),this.customTable.load(t,!1)}save(){let e=new ArrayBuffer(this.getByteLength()),t=new bt(e);return t.writeInt32(this.version),this.originalTable.save(t,!1),this.customTable.save(t,!1),e}getByteLength(){return 4+this.originalTable.getByteLength(!1)+this.customTable.getByteLength(!1)}}class Qt{constructor(){this.text=""}load(e){let t=e.readInt32();t&&(this.text=e.read(t-1),e.skip(1))}save(e){this.text.length?(e.writeInt32(this.text.length+1),e.write("".concat(this.text,"\0"))):e.writeInt32(0)}getByteLength(){let e=4;return this.text.length&&(e+=this.text.length+1),e}}class $t{constructor(e){this.version=0,this.comment="",this.trigger=null,this.triggers=[],e&&this.load(e)}load(e){let t=new bt(e);if(this.version=t.readInt32(),1===this.version){this.comment=t.readUntilNull();let e=new Qt;e.load(t),this.trigger=e}for(let i=0,r=t.readUint32();i<r;i++){let e=new Qt;e.load(t),this.triggers[i]=e}}save(){let e=new ArrayBuffer(this.getByteLength()),t=new bt(e);t.writeInt32(this.version),1===this.version&&(t.write("".concat(this.comment,"\0")),this.trigger.save(t)),t.writeUint32(this.triggers.length);for(let i of this.triggers)i.save(t);return e}getByteLength(){let e=8;1===this.version&&(e+=this.comment.length+1+this.trigger.getByteLength());for(let t of this.triggers)e+=t.getByteLength();return e}}class Zt{constructor(){this.id=0,this.name="",this.isComment=0}load(e,t){this.id=e.readInt32(),this.name=e.readUntilNull(),7===t&&(this.isComment=e.readInt32())}save(e,t){e.writeInt32(this.id),e.write("".concat(this.name,"\0")),7===t&&e.writeInt32(this.isComment)}getByteLength(e){let t=5+this.name.length;return 7===e&&(t+=4),t}}class ei{constructor(){this.name="",this.type="",this.u1=0,this.isArray=0,this.arraySize=0,this.isInitialized=0,this.initialValue=""}load(e,t){this.name=e.readUntilNull(),this.type=e.readUntilNull(),this.u1=e.readInt32(),this.isArray=e.readInt32(),7===t&&(this.arraySize=e.readInt32()),this.isInitialized=e.readInt32(),this.initialValue=e.readUntilNull()}save(e,t){e.write("".concat(this.name,"\0")),e.write("".concat(this.type,"\0")),e.writeInt32(this.u1),e.writeInt32(this.isArray),7===t&&e.writeInt32(this.arraySize),e.writeInt32(this.isInitialized),e.write("".concat(this.initialValue,"\0"))}getByteLength(e){let t=15+this.name.length+this.type.length+this.initialValue.length;return 7===e&&(t+=4),t}}class ti{constructor(){this.type=0,this.name="",this.beginParameters=0,this.parameters=[]}load(e,t,i){if(this.type=e.readInt32(),this.name=e.readUntilNull(),this.beginParameters=e.readInt32(),this.beginParameters){for(let r=0,n=i.getFunction(this.type,this.name).args.length;r<n;r++){let n=new ii;n.load(e,t,i),this.parameters[r]=n}}}save(e,t){e.writeInt32(this.type),e.write("".concat(this.name,"\0")),e.writeInt32(this.beginParameters);for(let i of this.parameters)i.save(e,t)}getByteLength(e){let t=9+this.name.length;if(this.parameters.length)for(let i of this.parameters)t+=i.getByteLength(e);return t}}class ii{constructor(){this.type=0,this.value="",this.subParameters=null,this.u1=0,this.isArray=0,this.arrayIndex=null}load(e,t,i){if(this.type=e.readInt32(),this.value=e.readUntilNull(),e.readInt32()){let r=new ti;r.load(e,t,i),this.subParameters=r}if((4===t&&2===this.type||7===t&&this.subParameters)&&(this.u1=e.readInt32()),(4===t&&2!==this.type||7===t)&&(this.isArray=e.readInt32()),this.isArray){let r=new ii;r.load(e,t,i),this.arrayIndex=r}}save(e,t){e.writeInt32(this.type),e.write("".concat(this.value,"\0")),this.subParameters?(e.writeInt32(1),this.subParameters.save(e,t)):e.writeInt32(0),(4===t&&2===this.type||7===t&&this.subParameters)&&e.writeInt32(this.u1),(4===t&&2!==this.type||7===t)&&e.writeInt32(this.isArray),this.isArray&&this.arrayIndex.save(e,t)}getByteLength(e){let t=9+this.value.length;return this.subParameters&&(t+=this.subParameters.getByteLength(e)),(4===e&&2===this.type||7===e&&this.subParameters)&&(t+=4),(4===e&&2!==this.type||7===e)&&(t+=4),this.isArray&&(t+=this.arrayIndex.getByteLength(e)),t}}class ri{constructor(){this.type=-1,this.group=-1,this.name="",this.isEnabled=0,this.parameters=[],this.ecas=[]}load(e,t,i,r){this.type=e.readInt32(),i&&(this.group=e.readUint32()),this.name=e.readUntilNull(),this.isEnabled=e.readInt32();for(let n=0,s=r.getFunction(this.type,this.name).args.length;n<s;n++){let i=new ii;i.load(e,t,r),this.parameters[n]=i}if(7===t)for(let n=0,s=e.readUint32();n<s;n++){let i=new ri;i.load(e,t,!0,r),this.ecas[n]=i}}save(e,t){e.writeInt32(this.type),-1!==this.group&&e.writeInt32(this.group),e.write("".concat(this.name,"\0")),e.writeInt32(this.isEnabled);for(let i of this.parameters)i.save(e,t);if(7===t){e.writeUint32(this.ecas.length);for(let i of this.ecas)i.save(e,t)}}getByteLength(e){let t=9+this.name.length;-1!==this.group&&(t+=4);for(let i of this.parameters)t+=i.getByteLength(e);if(7===e){t+=4;for(let i of this.ecas)t+=i.getByteLength(e)}return t}}class ni{constructor(){this.name="",this.description="",this.isComment=0,this.isEnabled=0,this.isCustom=0,this.isInitiallyOff=0,this.runOnInitialization=0,this.category=0,this.ecas=[]}load(e,t,i){this.name=e.readUntilNull(),this.description=e.readUntilNull(),7===t&&(this.isComment=e.readInt32()),this.isEnabled=e.readInt32(),this.isCustomText=e.readInt32(),this.isInitiallyOff=e.readInt32(),this.runOnInitialization=e.readInt32(),this.category=e.readInt32();for(let r=0,n=e.readUint32();r<n;r++){let n=new ri;n.load(e,t,!1,i),this.ecas[r]=n}}save(e,t){e.write("".concat(this.name,"\0")),e.write("".concat(this.description,"\0")),7===t&&e.writeInt32(this.isComment),e.writeInt32(this.isEnabled),e.writeInt32(this.isCustomText),e.writeInt32(this.isInitiallyOff),e.writeInt32(this.runOnInitialization),e.writeInt32(this.category),e.writeUint32(this.ecas.length);for(let i of this.ecas)i.save(e,t)}getByteLength(e){let t=26+this.name.length+this.description.length;7===e&&(t+=4);for(let i of this.ecas)t+=i.getByteLength(e);return t}}class si{constructor(e,t){this.version=0,this.categories=[],this.u1=0,this.variables=[],this.triggers=[],e&&this.load(e,t)}load(e,t){let i=new bt(e);if("WTG!"!==i.read(4))throw new Error("Not a WTG file");this.version=i.readInt32();for(let r=0,n=i.readUint32();r<n;r++){let e=new Zt;e.load(i,this.version),this.categories[r]=e}this.u1=i.readInt32();for(let r=0,n=i.readUint32();r<n;r++){let e=new ei;e.load(i,this.version),this.variables[r]=e}for(let r=0,n=i.readUint32();r<n;r++){let e=new ni;e.load(i,this.version,t),this.triggers[r]=e}}save(){let e=new ArrayBuffer(this.getByteLength()),t=new bt(e);t.write("WTG!"),t.writeInt32(this.version),t.writeUint32(this.categories.length);for(let i of this.categories)i.save(t,this.version);t.writeInt32(this.u1),t.writeUint32(this.variables.length);for(let i of this.variables)i.save(t,this.version);t.writeUint32(this.triggers.length);for(let i of this.triggers)i.save(t,this.version);return e}getByteLength(){let e=24;for(let t of this.categories)e+=t.getByteLength(this.version);for(let t of this.variables)e+=t.getByteLength(this.version);for(let t of this.triggers)e+=t.getByteLength(this.version);return e}}class ai{constructor(e){if(this.buffer=e||"",this.index=0,this.ident=0,this.fractionDigits=6,this.decoder=new TextDecoder("utf-8"),this.buffer instanceof ArrayBuffer){let t=new DataView(e);this.length=e.byteLength/4,this.accessPosition=(e=>t.getUint8(e))}else this.length=e.length,this.accessPosition=(t=>e[t])}readUntil(e,t){this.index=t;let i="",r=[];for(;this.index<this.length;){let t=this.accessPosition(this.index++),n=String.fromCharCode(t);if(n==e)return this.decoder.decode(new Uint8Array(r));i+=n,r.push(t)}return this.decoder.decode(new Uint8Array(r))}read(){let e=this.length,t=!1,i=!1,r="";for(;this.index<e;){let e=this.accessPosition(this.index++);if(e=String.fromCharCode(e),t)"\n"===e&&(t=!1);else if(i){if('"'===e)return r;r+=e}else if(" "===e||","===e||"\t"===e||"\n"===e||":"===e||"\r"===e){if(r.length)return r}else{if("{"===e||"}"===e)return r.length?(this.index--,r):e;if("/"===e&&"/"===this.accessPosition(this.index)){if(r.length)return this.index--,r;t=!0}else if('"'===e){if(r.length)return this.index--,r;i=!0}else r+=e}}}peek(){let e=this.index,t=this.read();return this.index=e,t}readInt(){return parseInt(this.read())}readFloat(){return parseFloat(this.read())}readKeyframe(e){1===e.length?e instanceof Float32Array?e[0]=this.readFloat():e[0]=this.readInt():this.readTypedArray(e)}readIntArray(e){this.read();for(let t=0,i=e.length;t<i;t++)e[t]=this.readInt();return this.read(),e}readFloatArray(e){this.read();for(let t=0,i=e.length;t<i;t++)e[t]=this.readFloat();return this.read(),e}readTypedArray(e){e instanceof Float32Array?this.readFloatArray(e):this.readIntArray(e)}readColor(e){this.read(),e[2]=this.readFloat(),e[1]=this.readFloat(),e[0]=this.readFloat(),this.read()}readVectorArray(e,t){this.read();for(let i=0,r=e.length/t;i<r;i++){this.read();for(let r=0;r<t;r++)e[i*t+r]=this.readFloat();this.read()}return this.read(),e}*readBlock(){this.read();let e=this.read();for(;"}"!==e;)yield e,e=this.read()}writeColor(e,t){this.writeLine("".concat(e," { ").concat(t[2],", ").concat(t[1],", ").concat(t[0]," },"))}writeFlag(e){this.writeLine("".concat(e,","))}writeAttrib(e,t){this.writeLine("".concat(e," ").concat(t,","))}writeFloatAttrib(e,t){this.writeLine("".concat(e," ").concat(this.formatFloat(t),","))}writeStringAttrib(e,t){this.writeLine("".concat(e,' "').concat(t,'",'))}writeArrayAttrib(e,t){this.writeLine("".concat(e," { ").concat(t.join(", ")," },"))}writeFloatArrayAttrib(e,t){this.writeLine("".concat(e," { ").concat(this.formatFloatArray(t)," },"))}writeTypedArrayAttrib(e,t){t instanceof Float32Array?this.writeFloatArrayAttrib(e,t):this.writeArrayAttrib(e,t)}writeKeyframe(e,t){1===t.length?t instanceof Float32Array?this.writeFloatAttrib(e,t[0]):this.writeAttrib(e,t[0]):this.writeTypedArrayAttrib(e,t)}writeArray(e){this.writeLine("{ ".concat(e.join(", ")," },"))}writeFloatArray(e){this.writeLine("{ ".concat(this.formatFloatArray(e)," },"))}writeVectorArray(e,t,i){this.startBlock(e,t.length/i);for(let r=0,n=t.length;r<n;r+=i)this.writeFloatArray(t.subarray(r,r+i));this.endBlock()}write(e){this.buffer+=e}writeLine(e){this.buffer+="".concat("\t".repeat(this.ident)).concat(e,"\n")}startBlock(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];t.length?this.writeLine("".concat(t.join(" ")," {")):this.writeLine("{"),this.ident+=1}startObjectBlock(e,t){this.writeLine("".concat(e,' "').concat(t,'" {')),this.ident+=1}endBlock(){this.ident-=1,this.writeLine("}")}endBlockComma(){this.ident-=1,this.writeLine("},")}indent(){this.ident+=1}unindent(){this.ident-=1}formatFloat(e){let t=e.toString(),i=e.toFixed(this.fractionDigits);return t.length>i.length?i:t}formatFloatArray(e){let t=[];for(let i=0,r=e.length;i<r;i++)t[i]=this.formatFloat(e[i]);return t.join(", ")}}class oi{constructor(e){this.stringMap=new Map,e&&this.load(e)}load(e){let t,i=new ai(e);for(i.index+=3;t=i.read();)if("STRING"===t){let e=i.readInt();i.read();let t=i.readUntil("}",i.index).trim();this.stringMap.set(e,t)}}save(){let e="\xef\xbb\xbf";for(let[t,i]of this.stringMap)e+="STRING ".concat(t,"\n{\n").concat(i,"\n}\n");return e}}class li{constructor(){this.id="\0\0\0\0",this.chance=0}load(e){this.id=e.read(4,!0),this.chance=e.readInt32()}save(e){e.write(this.id),e.writeInt32(this.chance)}}class hi{constructor(){this.items=[]}load(e){for(let t=0,i=e.readInt32();t<i;t++){let i=new li;i.load(e),this.items[t]=i}}save(e){e.writeInt32(this.items.length);for(let t of this.items)t.save(e)}getByteLength(){return 4+8*this.items.length}}class ci{constructor(){this.slot=0,this.id="\0\0\0\0"}load(e){this.slot=e.readInt32(),this.id=e.read(4,!0)}save(e){e.writeInt32(this.slot),e.write(this.id)}}class di{constructor(){this.id="\0\0\0\0",this.activeForAutocast=0,this.heroLevel=1}load(e){this.id=e.read(4,!0),this.activeForAutocast=e.readInt32(),this.heroLevel=e.readInt32()}save(e){e.write(this.id),e.writeInt32(this.activeForAutocast),e.writeInt32(this.heroLevel)}}class ui{constructor(){this.id="\0\0\0\0",this.chance=0}load(e){this.id=e.read(4,!0),this.chance=e.readInt32()}save(e){e.write(this.id),e.writeInt32(this.chance)}}class mi{constructor(){this.id="\0\0\0\0",this.variation=0,this.location=new Float32Array(3),this.angle=0,this.scale=new Float32Array([1,1,1]),this.flags=0,this.player=0,this.unknown=0,this.hitpoints=-1,this.mana=-1,this.droppedItemTable=-1,this.droppedItemSets=[],this.goldAmount=0,this.targetAcquisition=0,this.heroLevel=0,this.heroStrength=0,this.heroAgility=0,this.heroIntelligence=0,this.itemsInInventory=[],this.modifiedAbilities=[],this.randomFlag=0,this.level=new Uint8Array(3),this.itemClass=0,this.unitGroup=0,this.positionInGroup=0,this.randomUnitTables=[],this.customTeamColor=0,this.waygate=0,this.creationNumber=0}load(e,t){this.id=e.read(4,!0),this.variation=e.readInt32(),this.location=e.readFloat32Array(3),this.angle=e.readFloat32(),this.scale=e.readFloat32Array(3),this.flags=e.readUint8(),this.player=e.readInt32(),this.unknown=e.readUint16(),this.hitpoints=e.readInt32(),this.mana=e.readInt32(),t>7&&(this.droppedItemTable=e.readInt32());for(let i=0,r=e.readInt32();i<r;i++){let t=new hi;t.load(e),this.droppedItemSets[i]=t}this.goldAmount=e.readInt32(),this.targetAcquisition=e.readFloat32(),this.heroLevel=e.readInt32(),t>7&&(this.heroStrength=e.readInt32(),this.heroAgility=e.readInt32(),this.heroIntelligence=e.readInt32());for(let i=0,r=e.readInt32();i<r;i++){let t=new ci;t.load(e),this.itemsInInventory[i]=t}for(let i=0,r=e.readInt32();i<r;i++){let t=new di;t.load(e),this.modifiedAbilities[i]=t}if(this.randomFlag=e.readInt32(),0===this.randomFlag)this.level=e.readUint8Array(3),this.itemClass=e.readUint8();else if(1===this.randomFlag)this.unitGroup=e.readUint32(),this.positionInGroup=e.readUint32();else if(2===this.randomFlag)for(let i=0,r=e.readInt32();i<r;i++){let t=new ui;t.load(e),this.randomUnitTables[i]=t}this.customTeamColor=e.readInt32(),this.waygate=e.readInt32(),this.creationNumber=e.readInt32()}save(e,t){e.write(this.id),e.writeInt32(this.variation),e.writeFloat32Array(this.location),e.writeFloat32(this.angle),e.writeFloat32Array(this.scale),e.writeUint8(this.flags),e.writeInt32(this.player),e.writeUint16(this.unknown),e.writeInt32(this.hitpoints),e.writeInt32(this.mana),t>7&&e.writeInt32(this.droppedItemTable),e.writeInt32(this.droppedItemSets.length);for(let i of this.droppedItemSets)i.save(e);e.writeInt32(this.goldAmount),e.writeFloat32(this.targetAcquisition),e.writeInt32(this.heroLevel),t>7&&(e.writeInt32(this.heroStrength),e.writeInt32(this.heroAgility),e.writeInt32(this.heroIntelligence)),e.writeInt32(this.itemsInInventory.length);for(let i of this.itemsInInventory)i.save(e);e.writeInt32(this.modifiedAbilities.length);for(let i of this.modifiedAbilities)i.save(e);if(e.writeInt32(this.randomFlag),0===this.randomFlag)e.writeUint8Array(this.level),e.writeUint8(this.itemClass);else if(1===this.randomFlag)e.writeUint32(this.unitGroup),e.writeUint32(this.positionInGroup);else if(2===this.randomFlag){e.writeInt32(this.randomUnitTables.length);for(let t of this.randomUnitTables)t.save(e)}e.writeInt32(this.customTeamColor),e.writeInt32(this.waygate),e.writeInt32(this.creationNumber)}getByteLength(e){let t=91;e>7&&(t+=16);for(let i of this.droppedItemSets)t+=i.getByteLength();return t+=8*this.itemsInInventory.length,t+=12*this.modifiedAbilities.length,0===this.randomFlag?t+=4:1===this.randomFlag?t+=8:2===this.randomFlag&&(t+=4+8*this.randomUnitTables.length),t}}class fi{constructor(e){this.version=8,this.unknown=11,this.units=[],e&&this.load(e)}load(e){let t=new bt(e);if("W3do"!==t.read(4))return!1;this.version=t.readInt32(),this.unknown=t.readUint32();for(let r=0,n=t.readInt32();r<n;r++){let e=new mi;e.load(t,this.version),this.units[r]=e}let i=new Set;return this.units.forEach(e=>{e.droppedItemSets.forEach(e=>e.items.forEach(e=>i.add(e.id)))}),!0}save(){let e=new ArrayBuffer(this.getByteLength()),t=new bt(e);t.write("W3do"),t.writeInt32(this.version),t.writeUint32(this.unknown),t.writeInt32(this.units.length);for(let i of this.units)i.save(t,this.version);return e}getByteLength(){let e=16;for(let t of this.units)e+=t.getByteLength(this.version);return e}}const pi=new TextDecoder;class Ei{constructor(e,t){this.unknown=0,this.name="",this.flags=0,this.maxPlayers=0,this.imports=new Ut,this.readonly=!!t,e&&this.load(e)}load(e){return this.name=e.name,this.archive={getFileNames:()=>e.listFile().split("\n").filter(e=>e.length>0),get(t){const i=e.binary(t);return i?{name:t,arrayBuffer:()=>i.data.buffer,text:()=>pi.decode(i.data)}:i}},!0}save(){if(this.readonly)return null;this.setImportsFile();let e=this.archive.save(),t=new ArrayBuffer(512+e.byteLength),i=new Uint8Array(t),r=new bt(t);return r.write("HM3W"),r.writeUint32(this.u1),r.write("".concat(this.name,"\0")),r.writeUint32(this.flags),r.writeUint32(this.maxPlayers),i.set(new Uint8Array(e),512),t}getFileNames(){return this.archive.getFileNames()}getImportNames(){let e=[];for(let t of this.imports.entries.values()){let i=t.isCustom;10===i||13===i?e.push(t.name):e.push("war3mapImported\\".concat(t.name))}return e}setImportsFile(){return!this.readonly&&(this.imports.entries.size>0&&this.set("war3map.imp",this.imports.save()))}import(e,t){return!this.readonly&&(!!this.archive.set(e,t)&&(this.imports.set(e),!0))}set(e,t){return!this.readonly&&this.archive.set(e,t)}get(e){return this.archive.get(e)}getScript(){return(this.get("war3map.j")||this.get("scripts\\war3map.j")).text()}has(e){return this.archive.has(e)}delete(e){return!this.readonly&&(this.imports.delete(e),this.archive.delete(e))}rename(e,t){return!this.readonly&&(!!this.archive.rename(e,t)&&(this.imports.rename(e,t),!0))}readHelper(e,t){let i=this.archive.get(e);if(i){let e=i.arrayBuffer();return e?new t(e):null}}readImports(){let e=this.archive.get("war3map.imp");if(e){let t=e.arrayBuffer();t&&this.imports.load(t)}}readMapInformation(){return this.readHelper("war3map.w3i",Xt)}readEnvironment(){return this.readHelper("war3map.w3e",Vt)}readDoodads(){let e=this.archive.get("war3map.doo");if(e)return new Pt(e.arrayBuffer())}readUnits(){let e=this.archive.get("war3mapUnits.doo");if(e)return new fi(e.arrayBuffer())}readTriggers(e){let t=this.archive.get("war3map.wtg");if(t)return new si(t.arrayBuffer(),e)}readCustomTextTriggers(){let e=this.archive.get("war3map.wct");if(e)return new $t(e.arrayBuffer())}readStringTable(){let e=this.archive.get("war3map.wts");if(e)return new oi(e.text())}readModifications(){let e={},t=["w3u","w3t","w3b","w3d","w3a","w3h","w3q"],i=[!1,!1,!1,!0,!0,!1,!0];for(let r=0,n=t.length;r<n;r++){let n=this.archive.get("war3map.".concat(t[r]));if(n){let s,a=n.arrayBuffer();s=i[r]?new Ft(a):new Jt(a),e[t[r]]=s}}return e}}class gi{constructor(){this.type=0,this.location=new Int32Array(2),this.color=new Uint8Array(4)}load(e){this.type=e.readInt32(),this.location=e.readInt32Array(2),this.color=e.readUint8Array(4)}save(e){e.writeInt32(this.type),e.writeInt32Array(this.location),e.writeUint8Array(this.color)}}class Ai{constructor(){this.targetLocation=new Float32Array(3),this.rotation=0,this.angleOfAttack=0,this.distance=0,this.roll=0,this.fieldOfView=0,this.farClippingPlane=0,this.nearClippingPlane=0,this.cinematicName=""}load(e){this.targetLocation=e.readFloat32Array(3),this.rotation=e.readFloat32(),this.angleOfAttack=e.readFloat32(),this.distance=e.readFloat32(),this.roll=e.readFloat32(),this.fieldOfView=e.readFloat32(),this.farClippingPlane=e.readFloat32(),this.nearClippingPlane=e.readFloat32(),this.cinematicName=e.readUntilNull()}save(e){e.writeFloat32Array(this.targetLocation),e.writeFloat32(this.rotation),e.writeFloat32(this.angleOfAttack),e.writeFloat32(this.distance),e.writeFloat32(this.roll),e.writeFloat32(this.fieldOfView),e.writeFloat32(this.farClippingPlane),e.writeFloat32(this.nearClippingPlane),e.write("".concat(this.cinematicName,"\0"))}getByteLength(){return 41+this.cinematicName.length}}class _i{constructor(){this.left=0,this.right=0,this.bottom=0,this.top=0,this.name="",this.creationNumber=0,this.weatherEffectId="\0\0\0\0",this.ambientSound="",this.color=new Uint8Array(4)}load(e){this.left=e.readFloat32(),this.right=e.readFloat32(),this.bottom=e.readFloat32(),this.top=e.readFloat32(),this.name=e.readUntilNull(),this.creationNumber=e.readUint32(),this.weatherEffectId=e.read(4,!0),this.ambientSound=e.readUntilNull(),this.color=e.readUint8Array(4)}save(e){e.writeFloat32(this.left),e.writeFloat32(this.right),e.writeFloat32(this.bottom),e.writeFloat32(this.top),e.write("".concat(this.name,"\0")),e.writeUint32(this.creationNumber),this.weatherEffectId?e.write(this.weatherEffectId):e.writeUint32(0),e.write("".concat(this.ambientSound,"\0")),e.writeUint8Array(this.color)}getByteLength(){return 30+this.name.length+this.ambientSound.length}}class Ti{constructor(){this.name="",this.file="",this.eaxEffect="",this.flags=0,this.fadeInRate=0,this.fadeOutRate=0,this.volume=0,this.pitch=0,this.u1=0,this.u2=0,this.channel=0,this.minDistance=0,this.maxDistance=0,this.distanceCutoff=0,this.u3=0,this.u4=0,this.u5=0,this.u6=0,this.u7=0,this.u8=0}load(e){this.name=e.readUntilNull(),this.file=e.readUntilNull(),this.eaxEffect=e.readUntilNull(),this.flags=e.readUint32(),this.fadeInRate=e.readInt32(),this.fadeOutRate=e.readInt32(),this.volume=e.readInt32(),this.pitch=e.readFloat32(),this.u1=e.readFloat32(),this.u2=e.readInt32(),this.channel=e.readInt32(),this.minDistance=e.readFloat32(),this.maxDistance=e.readFloat32(),this.distanceCutoff=e.readFloat32(),this.u3=e.readFloat32(),this.u4=e.readFloat32(),this.u5=e.readInt32(),this.u6=e.readFloat32(),this.u7=e.readFloat32(),this.u8=e.readFloat32()}save(e){e.write("".concat(this.name,"\0")),e.write("".concat(this.file,"\0")),e.write("".concat(this.eaxEffect,"\0")),e.writeUint32(this.flags),e.writeUint32(this.fadeInRate),e.writeUint32(this.fadeOutRate),e.writeUint32(this.volume),e.writeFloat32(this.pitch),e.writeFloat32(this.u1),e.writeInt32(this.u2),e.writeInt32(this.channel),e.writeFloat32(this.minDistance),e.writeFloat32(this.maxDistance),e.writeFloat32(this.distanceCutoff),e.writeFloat32(this.u3),e.writeFloat32(this.u4),e.writeInt32(this.u5),e.writeFloat32(this.u6),e.writeFloat32(this.u7),e.writeFloat32(this.u8)}getByteLength(){return 71+this.name.length+this.file.length+this.eaxEffect.length}}class vi{constructor(){this.visible=0,this.chapterTitle="",this.mapTitle="",this.path=""}load(e){this.visible=e.readInt32(),this.chapterTitle=e.readUntilNull(),this.mapTitle=e.readUntilNull(),this.path=e.readUntilNull()}save(e){e.writeInt32(this.visible),e.write("".concat(this.chapterTitle,"\0")),e.write("".concat(this.mapTitle,"\0")),e.write("".concat(this.path,"\0"))}getByteLength(){return 7+this.chapterTitle.length+this.mapTitle.length+this.path.length}}class yi{constructor(){this.u1=0,this.path=""}load(e){this.u1=e.readInt8(),this.path=e.readUntilNull()}save(e){e.writeInt8(this.u1),e.write("".concat(this.path,"\0"))}getByteLength(){return 2+this.path.length}}var wi={Map:Ei,doo:{Doodad:Nt,TerrainDoodad:xt,File:Pt},imp:{Import:Ct,File:Ut},mmp:{MinimapIcon:gi,File:class{constructor(e){this.u1=0,this.icons=[],e&&this.load(e)}load(e){let t=new bt(e);this.u1=t.readInt32();for(let i=0,r=t.readInt32();i<r;i++){let e=new gi;e.load(t),this.icons[i]=e}}save(){let e=new ArrayBuffer(this.getByteLength()),t=new bt(e);t.writeInt32(this.u1),t.writeUint32(this.icons.length);for(let i of this.icons)i.save(t);return e}getByteLength(){return 8+16*this.icons.length}}},shd:{File:class{constructor(e,t,i){this.shadows=new Uint8Array(0),e&&this.load(e,t,i)}load(e,t,i){this.shadows=new Uint8Array(e.slice(0,t*i*16))}save(){return this.shadows.slice().buffer}getByteLength(){return this.shadows.length}}},w3c:{Camera:Ai,File:class{constructor(e){this.version=0,this.cameras=[],e&&this.load(e)}load(e){let t=new bt(e);this.version=t.readInt32();for(let i=0,r=t.readUint32();i<r;i++){let e=new Ai;e.load(t),this.cameras[i]=e}}save(){let e=new ArrayBuffer(this.getByteLength()),t=new bt(e);t.writeInt32(this.version),t.writeUint32(this.cameras.length);for(let i of this.cameras)i.save(t);return e}getByteLength(){let e=8;for(let t of this.cameras)e+=t.getByteLength();return e}}},w3d:{File:Ft},w3e:{Corner:Bt,File:Vt},w3i:{Player:kt,Force:Gt,UpgradeAvailabilityChange:jt,TechAvailabilityChange:Yt,RandomUnitTable:Wt,RandomUnit:Ht,RandomItemTable:qt,RandomItemSet:zt,RandomItem:Kt,File:Xt},w3o:{File:class{constructor(e){this.version=0,this.units=null,this.items=null,this.destructables=null,this.doodads=null,this.abilities=null,this.buffs=null,this.upgrades=null,e&&this.load(e)}load(e){let t=new bt(e);this.version=t.readInt32(),t.readInt32()&&(this.units=new Jt(t)),t.readInt32()&&(this.items=new Jt(t)),t.readInt32()&&(this.destructables=new Jt(t)),t.readInt32()&&(this.doodads=new Ft(t)),t.readInt32()&&(this.abilities=new Ft(t)),t.readInt32()&&(this.buffs=new Jt(t)),t.readInt32()&&(this.upgrades=new Ft(t))}save(){let e=new ArrayBuffer(this.getByteLength()),t=new bt(e);return t.writeInt32(this.version),this.units?(t.writeInt32(1),this.units.save(t)):t.writeInt32(0),this.items?(t.writeInt32(1),this.items.save(t)):t.writeInt32(0),this.destructables?(t.writeInt32(1),this.destructables.save(t)):t.writeInt32(0),this.doodads?(t.writeInt32(1),this.doodads.save(t)):t.writeInt32(0),this.abilities?(t.writeInt32(1),this.abilities.save(t)):t.writeInt32(0),this.buffs?(t.writeInt32(1),this.buffs.save(t)):t.writeInt32(0),this.upgrades?(t.writeInt32(1),this.upgrades.save(t)):t.writeInt32(0),e}getByteLength(){let e=32;return this.units&&(e+=this.units.getByteLength()),this.items&&(e+=this.items.getByteLength()),this.destructables&&(e+=this.destructables.getByteLength()),this.doodads&&(e+=this.doodads.getByteLength()),this.abilities&&(e+=this.abilities.getByteLength()),this.buffs&&(e+=this.buffs.getByteLength()),this.upgrades&&(e+=this.upgrades.getByteLength()),e}}},w3r:{Region:_i,File:class{constructor(e){this.version=0,this.regions=[],e&&this.load(e)}load(e){let t=new bt(e);this.version=t.readInt32();for(let i=0,r=t.readUint32();i<r;i++)this.regions[i]=new _i(t)}save(){let e=new ArrayBuffer(this.getByteLength()),t=new bt(e);t.writeInt32(this.version),t.writeUint32(this.regions.length);for(let i of this.regions)i.save(t);return e}getByteLength(){let e=8;for(let t of this.regions)e+=t.calcSize();return e}}},w3s:{Sound:Ti,File:class{constructor(e){this.version=0,this.sounds=[],e&&this.load(e)}load(e){let t=new bt(e);this.version=t.readInt32();for(let i=0,r=t.readUint32();i<r;i++){let e=new Ti;e.load(t),this.sounds[i]=e}}save(){let e=new ArrayBuffer(this.calcSize()),t=new bt(e);t.writeInt32(this.version),t.writeUint32(this.sounds.length);for(let i of this.sounds)i.save(t);return e}getByteLength(){let e=8;for(let t of this.sounds)e+=t.getByteLength();return e}}},w3u:{Modification:Ot,ModifiedObject:Dt,ModificationTable:Mt,File:Jt},wct:{CustomTextTrigger:Qt,File:$t},wpm:{File:class{constructor(e){this.version=0,this.size=new Int32Array(2),this.pathing=new Uint8Array(1),e&&this.load(e)}load(e){let t=new bt(e);return"MP3W"===t.read(4)&&(this.version=t.readInt32(),this.size=t.readInt32Array(2),this.pathing=t.readUint8Array(this.size[0]*this.size[1]),!0)}save(){let e=new ArrayBuffer(this.getByteLength()),t=new bt(e);return t.write("MP3W"),t.writeInt32(this.version),t.writeInt32Array(this.size),t.writeUint8Array(this.pathing),e}getByteLength(){return 16+this.size[0]*this.size[1]}}},wtg:{ECA:ri,Parameter:ii,SubParameters:ti,Trigger:ni,TriggerCategory:Zt,Variable:ei,File:si,TriggerData:class{constructor(){this.types={},this.functions=[{},{},{},{}],this.presets={},this.externalTypes={},this.externalFunctions=[{},{},{},{}],this.externalPresets={}}addTriggerData(e,t){let i=this.types,r=this.functions,n=this.presets;t&&(i=this.externalTypes,r=this.externalFunctions,n=this.externalPresets);let s=new $e;s.load(e),this.addTriggerTypes(i,s.getSection("TriggerTypes")),this.addTriggerDataFunctions(r[0],s.getSection("TriggerEvents"),1),this.addTriggerDataFunctions(r[1],s.getSection("TriggerConditions"),1),this.addTriggerDataFunctions(r[2],s.getSection("TriggerActions"),1),this.addTriggerDataFunctions(r[3],s.getSection("TriggerCalls"),3),this.addTriggerDataPresets(n,s.getSection("TriggerParams"))}addTriggerTypes(e,t){for(let[i,r]of t){let t=r.split(",");e[i]=t[4]||""}}addTriggerDataFunctions(e,t,i){for(let[r,n]of t)if("_"!==r[0]){let s=n.split(",").slice(i),a=[],o=t.get("_".concat(r,"_scriptname"))||null;for(let e of s)isNaN(e)&&"nothing"!==e&&""!==e&&a.push(e);e[r]={args:a,scriptName:o}}}addTriggerDataPresets(e,t){for(let[i,r]of t){let t=r.split(",");e[i]=t[2].replace(/"/g,"").replace(/`/g,'"')}}getBaseType(e){e=e.toLowerCase();let t=this.types[e];return void 0===t&&(t=this.externalTypes[e]),""===t||void 0===t?e:t}isBaseFunction(e,t){return t=t.toLowerCase(),!!this.functions[e][t]}getFunction(e,t){t=t.toLowerCase();let i=this.functions[e][t];if(!i&&!(i=this.externalFunctions[e][t]))throw new Error('Tried to get signature for unknown function "'.concat(t,'"'));return i}getPreset(e){e=e.toLowerCase();let t=this.presets[e];if(void 0===t&&void 0===(t=this.externalPresets[e]))throw new Error("Failed to find a preset: ".concat(e));return t}isCustomPreset(e){if(e=e.toLowerCase(),void 0!==this.presets[e])return!1;if(void 0!==this.externalPresets[e])return!0;throw new Error("Failed to find a preset: ".concat(e))}}},wts:{File:oi},unitsdoo:{DroppedItem:li,DroppedItemSet:hi,InventoryItem:ci,ModifiedAbility:di,RandomUnit:ui,Unit:mi,File:fi},w3f:{File:class{constructor(){this.version=0,this.campaignVersion=0,this.editorVersion=0,this.name="",this.difficulty="",this.author="",this.description="",this.mode=-1,this.backgroundScreen=-1,this.backgroundScreenPath="",this.minimapImagePath="",this.ambientSound=0,this.ambientSoundPath="",this.terrainFog=0,this.fogStartZ=0,this.fogEndZ=0,this.fogDensity=0,this.fogColor=new Uint8Array(4),this.userInterface=-1,this.mapTitles=[],this.mapOrders=[]}load(e){let t=new bt(e);this.version=t.readInt32(),this.campaignVersion=t.readInt32(),this.editorVersion=t.readInt32(),this.name=t.readUntilNull(),this.difficulty=t.readUntilNull(),this.author=t.readUntilNull(),this.description=t.readUntilNull(),this.mode=t.readInt32(),this.backgroundScreen=t.readInt32(),this.backgroundScreenPath=t.readUntilNull(),this.minimapImagePath=t.readUntilNull(),this.ambientSound=t.readInt32(),this.ambientSoundPath=t.readUntilNull(),this.terrainFog=t.readInt32(),this.fogStartZ=t.readFloat32(),this.fogEndZ=t.readFloat32(),this.fogDensity=t.readFloat32(),t.readUint8Array(this.fogColor),this.userInterface=t.readInt32();for(let i=0,r=t.readUint32();i<r;i++){let e=new vi;e.load(t),this.mapTitles[i]=e}for(let i=0,r=t.readUint32();i<r;i++){let e=new yi;e.load(t),this.mapOrders[i]=e}}save(){let e=new ArrayBuffer(this.getByteLength()),t=new bt(e);t.writeInt32(this.version),t.writeInt32(this.campaignVersion),t.writeInt32(this.editorVersion),t.write("".concat(this.name,"\0")),t.write("".concat(this.difficulty,"\0")),t.write("".concat(this.author,"\0")),t.write("".concat(this.description,"\0")),t.writeInt32(this.mode),t.writeInt32(this.backgroundScreen),t.write("".concat(this.backgroundScreenPath,"\0")),t.write("".concat(this.minimapImagePath,"\0")),t.writeInt32(this.ambientSound),t.write("".concat(this.ambientSoundPath,"\0")),t.writeInt32(this.terrainFog),t.writeFloat32(this.fogStartZ),t.writeFloat32(this.fogEndZ),t.writeFloat32(this.fogDensity),t.writeUint8Array(this.fogColor),t.writeInt32(this.userInterface),t.writeUint32(this.mapTitles.length);for(let i of this.mapTitles)i.save(t);t.writeUint32(this.mapOrders.length);for(let i of this.mapOrders)i.save(t);return e}getByteLength(){let e=63+this.name.length+this.difficulty.length+this.author.length+this.description.length+this.backgroundScreenPath.length+this.minimapImagePath.length+this.ambientSoundPath.length;for(let t of this.mapTitles)e+=t.getByteLength();for(let t of this.mapOrders)e+=t.getByteLength();return e}}}};class Si{constructor(){this.boundsRadius=0,this.min=new Float32Array(3),this.max=new Float32Array(3)}readMdx(e){this.boundsRadius=e.readFloat32(),e.readFloat32Array(this.min),e.readFloat32Array(this.max)}writeMdx(e){e.writeFloat32(this.boundsRadius),e.writeFloat32Array(this.min),e.writeFloat32Array(this.max)}writeMdl(e){0===this.min[0]&&0===this.min[1]&&0===this.min[2]||e.writeFloatArrayAttrib("MinimumExtent",this.min),0===this.max[0]&&0===this.max[1]&&0===this.max[2]||e.writeFloatArrayAttrib("MaximumExtent",this.max),0!==this.boundsRadius&&e.writeFloatAttrib("BoundsRadius",this.boundsRadius)}}class Ri{constructor(){this.name="",this.interval=new Uint32Array(2),this.moveSpeed=0,this.flags=0,this.rarity=0,this.syncPoint=0,this.extent=new Si}readMdx(e){this.name=e.read(80),e.readUint32Array(this.interval),this.moveSpeed=e.readFloat32(),this.flags=e.readUint32(),this.rarity=e.readFloat32(),this.syncPoint=e.readUint32(),this.extent.readMdx(e)}writeMdx(e){e.write(this.name),e.skip(80-this.name.length),e.writeUint32Array(this.interval),e.writeFloat32(this.moveSpeed),e.writeUint32(this.flags),e.writeFloat32(this.rarity),e.writeUint32(this.syncPoint),this.extent.writeMdx(e)}readMdl(e){this.name=e.read();for(let t of e.readBlock())if("Interval"===t)e.readIntArray(this.interval);else if("NonLooping"===t)this.flags=1;else if("MoveSpeed"===t)this.moveSpeed=e.readFloat();else if("Rarity"===t)this.rarity=e.readFloat();else if("MinimumExtent"===t)e.readFloatArray(this.extent.min);else if("MaximumExtent"===t)e.readFloatArray(this.extent.max);else{if("BoundsRadius"!==t)throw new Error('Unknown token in Sequence: "'.concat(t,'"'));this.extent.boundsRadius=e.readFloat()}}writeMdl(e){e.startObjectBlock("Anim",this.name),e.writeArrayAttrib("Interval",this.interval),1===this.flags&&e.writeFlag("NonLooping"),0!==this.moveSpeed&&e.writeFloatAttrib("MoveSpeed",this.moveSpeed),0!==this.rarity&&e.writeFloatAttrib("Rarity",this.rarity),this.extent.writeMdl(e),e.endBlock()}}const bi=(e,t)=>(class{constructor(){this.frame=0,this.value=new e(t),this.inTan=new e(t),this.outTan=new e(t)}readMdx(e,t){this.frame=e.readUint32(),e.readTypedArray(this.value),t>1&&(e.readTypedArray(this.inTan),e.readTypedArray(this.outTan))}writeMdx(e,t){e.writeUint32(this.frame),e.writeTypedArray(this.value),t>1&&(e.writeTypedArray(this.inTan),e.writeTypedArray(this.outTan))}readMdl(e,t){this.frame=e.readInt(),e.readKeyframe(this.value),t>1&&(e.read(),e.readKeyframe(this.inTan),e.read(),e.readKeyframe(this.outTan))}writeMdl(e,t){e.writeKeyframe("".concat(this.frame,":"),this.value),t>1&&(e.indent(),e.writeKeyframe("InTan",this.inTan),e.writeKeyframe("OutTan",this.outTan),e.unindent())}getByteLength(e){let t=this.value.byteLength,i=4+t;return e>1&&(i+=2*t),i}}),Ii=bi(Uint32Array,1),Li=bi(Float32Array,1),Ni=bi(Float32Array,3),xi=bi(Float32Array,4),Pi=e=>(class{constructor(){this.name="",this.interpolationType=0,this.globalSequenceId=-1,this.tracks=[]}readMdx(t,i){this.name=i;const r=t.readUint32();this.interpolationType=t.readUint32(),this.globalSequenceId=t.readInt32();for(let n=0;n<r;n++){const i=new e;i.readMdx(t,this.interpolationType),this.tracks.push(i)}}writeMdx(e){e.write(this.name),e.writeUint32(this.tracks.length),e.writeUint32(this.interpolationType),e.writeInt32(this.globalSequenceId);for(const t of this.tracks)t.writeMdx(e,this.interpolationType)}readMdl(t,i){this.name=i;const r=t.readInt();t.read();const n=t.read();"DontInterp"===n?this.interpolationType=0:"Linear"===n?this.interpolationType=1:"Hermite"===n?this.interpolationType=2:"Bezier"===n&&(this.interpolationType=3),"GlobalSeqId"===t.peek()&&(t.read(),this.globalSequenceId=t.readInt());for(let s=0;s<r;s++){const i=new e;i.readMdl(t,this.interpolationType),this.tracks[s]=i}t.read()}writeMdl(e,t){let i;e.startBlock(t,this.tracks.length),0===this.interpolationType?i="DontInterp":1===this.interpolationType?i="Linear":2===this.interpolationType?i="Hermite":3===this.interpolationType&&(i="Bezier"),e.writeFlag(i),-1!==this.globalSequenceId&&e.writeAttrib("GlobalSeqId",this.globalSequenceId);for(const r of this.tracks)r.writeMdl(e,this.interpolationType);e.endBlock()}getByteLength(){let e=this.tracks,t=16;return e.length&&(t+=e[0].getByteLength(this.interpolationType)*e.length),t}}),Ci=Pi(Ii),Ui=Pi(Li),Oi=Pi(Ni),Di=Pi(xi);var Mi={KMTF:["TextureId",Ci],KMTA:["Alpha",Ui],KTAT:["Translation",Oi],KTAR:["Rotation",Di],KTAS:["Scaling",Oi],KGAO:["Alpha",Ui],KGAC:["Color",Oi],KLAS:["AttenuationStart",Ui],KLAE:["AttenuationEnd",Ui],KLAC:["Color",Oi],KLAI:["Intensity",Ui],KLBI:["AmbientIntensity",Ui],KLBC:["AmbientColor",Oi],KLAV:["Visibility",Ui],KATV:["Visibility",Ui],KPEE:["EmissionRate",Ui],KPEG:["Gravity",Ui],KPLN:["Longitude",Ui],KPLT:["Latitude",Ui],KPEL:["LifeSpan",Ui],KPES:["Speed",Ui],KPEV:["Visibility",Ui],KP2S:["Speed",Ui],KP2R:["Variation",Ui],KP2L:["Latitude",Ui],KP2G:["Gravity",Ui],KP2E:["EmissionRate",Ui],KP2N:["Length",Ui],KP2W:["Width",Ui],KP2V:["Visibility",Ui],KRHA:["HeightAbove",Ui],KRHB:["HeightBelow",Ui],KRAL:["Alpha",Ui],KRCO:["Color",Oi],KRTX:["TextureSlot",Ci],KRVS:["Visibility",Ui],KCTR:["Translation",Oi],KTTR:["Translation",Oi],KCRL:["Rotation",Ci],KGTR:["Translation",Oi],KGRT:["Rotation",Di],KGSC:["Scaling",Oi]};class Fi{constructor(){this.animations=[]}readAnimations(e,t){for(;t>0;){let i=e.read(4,!0),r=new Mi[i][1];r.readMdx(e,i),t-=r.getByteLength(),this.animations.push(r)}}writeAnimations(e){for(let t of this.animations)t.writeMdx(e)}*readAnimatedBlock(e){for(let t of e.readBlock())"static"===t?yield"static ".concat(e.read()):yield t}readAnimation(e,t){let i=new Mi[t][1];i.readMdl(e,t),this.animations.push(i)}writeAnimation(e,t){for(let i of this.animations)if(i.name===t)return i.writeMdl(e,Mi[t][0]),!0;return!1}getByteLength(){let e=0;for(let t of this.animations)e+=t.getByteLength();return e}}let Bi={None:0,Transparent:1,Blend:2,Additive:3,AddAlpha:4,Modulate:5,Modulate2x:6},Vi={0:"None",1:"Transparent",2:"Blend",3:"Additive",4:"AddAlpha",5:"Modulate",6:"Modulate2x"};class ki extends Fi{constructor(){super(),this.filterMode=0,this.flags=0,this.textureId=-1,this.textureAnimationId=-1,this.coordId=0,this.alpha=1}readMdx(e){let t=e.readUint32();this.filterMode=e.readUint32(),this.flags=e.readUint32(),this.textureId=e.readInt32(),this.textureAnimationId=e.readInt32(),this.coordId=e.readUint32(),this.alpha=e.readFloat32(),this.readAnimations(e,t-28)}writeMdx(e){e.writeUint32(this.getByteLength()),e.writeUint32(this.filterMode),e.writeUint32(this.flags),e.writeInt32(this.textureId),e.writeInt32(this.textureAnimationId),e.writeUint32(this.coordId),e.writeFloat32(this.alpha),this.writeAnimations(e)}readMdl(e){for(let t of this.readAnimatedBlock(e))if("FilterMode"===t)this.filterMode=Bi[e.read()];else if("Unshaded"===t)this.flags|=1;else if("SphereEnvMap"===t)this.flags|=2;else if("TwoSided"===t)this.flags|=16;else if("Unfogged"===t)this.flags|=32;else if("NoDepthTest"===t)this.flags|=64;else if("NoDepthSet"===t)this.flags|=256;else if("static TextureID"===t)this.textureId=e.readInt();else if("TextureID"===t)this.readAnimation(e,"KMTF");else if("TVertexAnimId"===t)this.textureAnimationId=e.readInt();else if("CoordId"===t)this.coordId=e.readInt();else if("static Alpha"===t)this.alpha=e.readFloat();else{if("Alpha"!==t)throw new Error('Unknown token in Layer: "'.concat(t,'"'));this.readAnimation(e,"KMTA")}}writeMdl(e){e.startBlock("Layer"),e.writeAttrib("FilterMode",Vi[this.filterMode]),1&this.flags&&e.writeFlag("Unshaded"),2&this.flags&&e.writeFlag("SphereEnvMap"),16&this.flags&&e.writeFlag("TwoSided"),32&this.flags&&e.writeFlag("Unfogged"),64&this.flags&&e.writeFlag("NoDepthTest"),256&this.flags&&e.writeFlag("NoDepthSet"),this.writeAnimation(e,"KMTF")||e.writeAttrib("static TextureID",this.textureId),-1!==this.textureAnimationId&&e.writeAttrib("TVertexAnimId",this.textureAnimationId),0!==this.coordId&&e.writeAttrib("CoordId",this.coordId),this.writeAnimation(e,"KMTA")||1===this.alpha||e.writeFloatAttrib("static Alpha",this.alpha),e.endBlock()}getByteLength(){return 28+super.getByteLength()}}class Gi{constructor(){this.priorityPlane=0,this.flags=0,this.layers=[]}readMdx(e){e.readUint32(),this.priorityPlane=e.readUint32(),this.flags=e.readUint32(),e.skip(4);for(let t=0,i=e.readUint32();t<i;t++){let t=new ki;t.readMdx(e),this.layers.push(t)}}writeMdx(e){e.writeUint32(this.getByteLength()),e.writeUint32(this.priorityPlane),e.writeUint32(this.flags),e.write("LAYS"),e.writeUint32(this.layers.length);for(let t of this.layers)t.writeMdx(e)}readMdl(e){for(let t of e.readBlock())if("ConstantColor"===t)this.flags|=1;else if("SortPrimsNearZ"===t)this.flags|=8;else if("SortPrimsFarZ"===t)this.flags|=16;else if("FullResolution"===t)this.flags|=32;else if("PriorityPlane"===t)this.priorityPlane=e.readInt();else{if("Layer"!==t)throw new Error('Unknown token in Material: "'.concat(t,'"'));{let t=new ki;t.readMdl(e),this.layers.push(t)}}}writeMdl(e){e.startBlock("Material"),1&this.flags&&e.writeFlag("ConstantColor"),8&this.flags&&e.writeFlag("SortPrimsNearZ"),16&this.flags&&e.writeFlag("SortPrimsFarZ"),32&this.flags&&e.writeFlag("FullResolution"),0!==this.priorityPlane&&e.writeAttrib("PriorityPlane",this.priorityPlane);for(let t of this.layers)t.writeMdl(e);e.endBlock()}getByteLength(){let e=20;for(let t of this.layers)e+=t.getByteLength();return e}}class ji{constructor(){this.replaceableId=0,this.path="",this.flags=0}readMdx(e){this.replaceableId=e.readUint32(),this.path=e.read(260),this.flags=e.readUint32()}writeMdx(e){e.writeUint32(this.replaceableId),e.write(this.path),e.skip(260-this.path.length),e.writeUint32(this.flags)}readMdl(e){for(let t of e.readBlock())if("Image"===t)this.path=e.read();else if("ReplaceableId"===t)this.replaceableId=e.readInt();else if("WrapWidth"===t)this.flags|=1;else{if("WrapHeight"!==t)throw new Error('Unknown token in Texture: "'.concat(t,'"'));this.flags|=2}}writeMdl(e){e.startBlock("Bitmap"),e.writeStringAttrib("Image",this.path),0!==this.replaceableId&&e.writeAttrib("ReplaceableId",this.replaceableId),1&this.flags&&e.writeFlag("WrapWidth"),2&this.flags&&e.writeFlag("WrapHeight"),e.endBlock()}}class Yi extends Fi{readMdx(e){let t=e.readUint32();this.readAnimations(e,t-4)}writeMdx(e){e.writeUint32(this.getByteLength()),this.writeAnimations(e)}readMdl(e){for(let t of e.readBlock())if("Translation"===t)this.readAnimation(e,"KTAT");else if("Rotation"===t)this.readAnimation(e,"KTAR");else{if("Scaling"!==t)throw new Error('Unknown token in TextureAnimation: "'.concat(t,'"'));this.readAnimation(e,"KTAS")}}writeMdl(e){e.startBlock("TVertexAnim "),this.writeAnimation(e,"KTAT"),this.writeAnimation(e,"KTAR"),this.writeAnimation(e,"KTAS"),e.endBlock()}getByteLength(){return 4+super.getByteLength()}}class Hi{constructor(){this.vertices=new Float32Array(0),this.normals=new Float32Array(0),this.faceTypeGroups=new Uint32Array(0),this.faceGroups=new Uint32Array(0),this.faces=new Uint16Array(0),this.vertexGroups=new Uint8Array(0),this.matrixGroups=new Uint32Array(0),this.matrixIndices=new Uint32Array(0),this.materialId=0,this.selectionGroup=0,this.selectionFlags=0,this.extent=new Si,this.sequenceExtents=[],this.uvSets=[]}readMdx(e){e.readUint32(),e.skip(4),this.vertices=e.readFloat32Array(3*e.readUint32()),e.skip(4),this.normals=e.readFloat32Array(3*e.readUint32()),e.skip(4),this.faceTypeGroups=e.readUint32Array(e.readUint32()),e.skip(4),this.faceGroups=e.readUint32Array(e.readUint32()),e.skip(4),this.faces=e.readUint16Array(e.readUint32()),e.skip(4),this.vertexGroups=e.readUint8Array(e.readUint32()),e.skip(4),this.matrixGroups=e.readUint32Array(e.readUint32()),e.skip(4),this.matrixIndices=e.readUint32Array(e.readUint32()),this.materialId=e.readUint32(),this.selectionGroup=e.readUint32(),this.selectionFlags=e.readUint32(),this.extent.readMdx(e);for(let t=0,i=e.readUint32();t<i;t++){let t=new Si;t.readMdx(e),this.sequenceExtents.push(t)}e.skip(4);for(let t=0,i=e.readUint32();t<i;t++)e.skip(4),this.uvSets.push(e.readFloat32Array(2*e.readUint32()))}writeMdx(e){e.writeUint32(this.getByteLength()),e.write("VRTX"),e.writeUint32(this.vertices.length/3),e.writeFloat32Array(this.vertices),e.write("NRMS"),e.writeUint32(this.normals.length/3),e.writeFloat32Array(this.normals),e.write("PTYP"),e.writeUint32(this.faceTypeGroups.length),e.writeUint32Array(this.faceTypeGroups),e.write("PCNT"),e.writeUint32(this.faceGroups.length),e.writeUint32Array(this.faceGroups),e.write("PVTX"),e.writeUint32(this.faces.length),e.writeUint16Array(this.faces),e.write("GNDX"),e.writeUint32(this.vertexGroups.length),e.writeUint8Array(this.vertexGroups),e.write("MTGC"),e.writeUint32(this.matrixGroups.length),e.writeUint32Array(this.matrixGroups),e.write("MATS"),e.writeUint32(this.matrixIndices.length),e.writeUint32Array(this.matrixIndices),e.writeUint32(this.materialId),e.writeUint32(this.selectionGroup),e.writeUint32(this.selectionFlags),this.extent.writeMdx(e),e.writeUint32(this.sequenceExtents.length);for(let t of this.sequenceExtents)t.writeMdx(e);e.write("UVAS"),e.writeUint32(this.uvSets.length);for(let t of this.uvSets)e.write("UVBS"),e.writeUint32(t.length/2),e.writeFloat32Array(t)}readMdl(e){for(let t of e.readBlock())if("Vertices"===t)this.vertices=e.readVectorArray(new Float32Array(3*e.readInt()),3);else if("Normals"===t)this.normals=e.readVectorArray(new Float32Array(3*e.readInt()),3);else if("TVertices"===t)this.uvSets.push(e.readVectorArray(new Float32Array(2*e.readInt()),2));else if("VertexGroup"===t){let t=[];for(let i of e.readBlock())t.push(parseInt(i));this.vertexGroups=new Uint8Array(t)}else if("Faces"===t){this.faceTypeGroups=new Uint32Array([4]),e.readInt();let t=e.readInt();e.read(),e.read(),e.read(),this.faces=e.readIntArray(new Uint16Array(t)),e.read(),e.read()}else if("Groups"===t){let t=[],i=[];e.readInt(),e.readInt();for(let r of e.readBlock()){let r=0;for(let i of e.readBlock())t.push(parseInt(i)),r+=1;i.push(r)}this.matrixIndices=new Uint32Array(t),this.matrixGroups=new Uint32Array(i)}else if("MinimumExtent"===t)e.readFloatArray(this.extent.min);else if("MaximumExtent"===t)e.readFloatArray(this.extent.max);else if("BoundsRadius"===t)this.extent.boundsRadius=e.readFloat();else if("Anim"===t){let i=new Si;for(t of e.readBlock())"MinimumExtent"===t?e.readFloatArray(i.min):"MaximumExtent"===t?e.readFloatArray(i.max):"BoundsRadius"===t&&(i.boundsRadius=e.readFloat());this.sequenceExtents.push(i)}else if("MaterialID"===t)this.materialId=e.readInt();else if("SelectionGroup"===t)this.selectionGroup=e.readInt();else{if("Unselectable"!==t)throw new Error('Unknown token in Geoset: "'.concat(t,'"'));this.selectionFlags=4}}writeMdl(e){e.startBlock("Geoset"),e.writeVectorArray("Vertices",this.vertices,3),e.writeVectorArray("Normals",this.normals,3);for(let i of this.uvSets)e.writeVectorArray("TVertices",i,2);e.startBlock("VertexGroup");for(let i=0,r=this.vertexGroups.length;i<r;i++)e.writeLine("".concat(this.vertexGroups[i],","));e.endBlock(),e.startBlock("Faces",1,this.faces.length),e.startBlock("Triangles"),e.writeLine("{ ".concat(this.faces.join(", ")," },")),e.endBlock(),e.endBlock(),e.startBlock("Groups",this.matrixGroups.length,this.matrixIndices.length);let t=0;for(let i of this.matrixGroups)e.writeArrayAttrib("Matrices",this.matrixIndices.subarray(t,t+i)),t+=i;e.endBlock(),this.extent.writeMdl(e);for(let i of this.sequenceExtents)e.startBlock("Anim"),i.writeMdl(e),e.endBlock();e.writeAttrib("MaterialID",this.materialId),e.writeAttrib("SelectionGroup",this.selectionGroup),4===this.selectionFlags&&e.writeFlag("Unselectable"),e.endBlock()}getByteLength(){let e=120+this.vertices.byteLength+this.normals.byteLength+this.faceTypeGroups.byteLength+this.faceGroups.byteLength+this.faces.byteLength+this.vertexGroups.byteLength+this.matrixGroups.byteLength+this.matrixIndices.byteLength+28*this.sequenceExtents.length;for(let t of this.uvSets)e+=8+t.byteLength;return e}}class Wi extends Fi{constructor(){super(),this.alpha=1,this.flags=0,this.color=new Float32Array([1,1,1]),this.geosetId=-1,this.animations=[]}readMdx(e){let t=e.readUint32();this.alpha=e.readFloat32(),this.flags=e.readUint32(),e.readFloat32Array(this.color),this.geosetId=e.readInt32(),this.readAnimations(e,t-28)}writeMdx(e){e.writeUint32(this.getByteLength()),e.writeFloat32(this.alpha),e.writeUint32(this.flags),e.writeFloat32Array(this.color),e.writeInt32(this.geosetId),this.writeAnimations(e)}readMdl(e){for(let t of this.readAnimatedBlock(e))if("DropShadow"===t)this.flags|=1;else if("static Alpha"===t)this.alpha=e.readFloat();else if("Alpha"===t)this.readAnimation(e,"KGAO");else if("static Color"===t)this.flags|=2,e.readColor(this.color);else if("Color"===t)this.flags|=2,this.readAnimation(e,"KGAC");else{if("GeosetId"!==t)throw new Error('Unknown token in GeosetAnimation: "'.concat(t,'"'));this.geosetId=e.readInt()}}writeMdl(e){e.startBlock("GeosetAnim"),1&this.flags&&e.writeFlag("DropShadow"),this.writeAnimation(e,"KGAO")||e.writeFloatAttrib("static Alpha",this.alpha),2&this.flags&&(this.writeAnimation(e,"KGAC")||1===this.color[0]&&1===this.color[1]&&1===this.color[2]||e.writeColor("static Color ",this.color)),e.writeAttrib("GeosetId",this.geosetId),e.endBlock()}getByteLength(){return 28+super.getByteLength()}}class Ki extends Fi{constructor(e){super(),this.name="",this.objectId=-1,this.parentId=-1,this.flags=e||0}readMdx(e){let t=e.readUint32();this.name=e.read(80),this.objectId=e.readInt32(),this.parentId=e.readInt32(),this.flags=e.readUint32(),this.readAnimations(e,t-96)}writeMdx(e){e.writeUint32(this.getGenericByteLength()),e.write(this.name),e.skip(80-this.name.length),e.writeInt32(this.objectId),e.writeInt32(this.parentId),e.writeUint32(this.flags);for(let t of this.eachAnimation(!0))t.writeMdx(e)}writeNonGenericAnimationChunks(e){for(let t of this.eachAnimation(!1))t.writeMdx(e)}*readMdl(e){this.name=e.read();for(let t of this.readAnimatedBlock(e))if("ObjectId"===t)this.objectId=e.readInt();else if("Parent"===t)this.parentId=e.readInt();else if("BillboardedLockZ"===t)this.flags|=64;else if("BillboardedLockY"===t)this.flags|=32;else if("BillboardedLockX"===t)this.flags|=16;else if("Billboarded"===t)this.flags|=8;else if("CameraAnchored"===t)this.flags|=128;else if("DontInherit"===t)for(t of e.readBlock())"Rotation"===t?this.flags|=2:"Translation"===t?this.flags|=1:"Scaling"===t&&(this.flags|=4);else"Translation"===t?this.readAnimation(e,"KGTR"):"Rotation"===t?this.readAnimation(e,"KGRT"):"Scaling"===t?this.readAnimation(e,"KGSC"):yield t}writeGenericHeader(e){e.writeAttrib("ObjectId",this.objectId),-1!==this.parentId&&e.writeAttrib("Parent",this.parentId),64&this.flags&&e.writeFlag("BillboardedLockZ"),32&this.flags&&e.writeFlag("BillboardedLockY"),16&this.flags&&e.writeFlag("BillboardedLockX"),8&this.flags&&e.writeFlag("Billboarded"),128&this.flags&&e.writeFlag("CameraAnchored"),2&this.flags&&e.writeFlag("DontInherit { Rotation }"),1&this.flags&&e.writeFlag("DontInherit { Translation }"),4&this.flags&&e.writeFlag("DontInherit { Scaling }")}writeGenericAnimations(e){this.writeAnimation(e,"KGTR"),this.writeAnimation(e,"KGRT"),this.writeAnimation(e,"KGSC")}*eachAnimation(e){for(let t of this.animations){let i=t.name,r="KGTR"===i||"KGRT"===i||"KGSC"===i;(e&&r||!e&&!r)&&(yield t)}}getGenericByteLength(){let e=96;for(let t of this.eachAnimation(!0))e+=t.getByteLength();return e}getByteLength(){return 96+super.getByteLength()}}class zi extends Ki{constructor(){super(256),this.geosetId=-1,this.geosetAnimationId=-1}readMdx(e){super.readMdx(e),this.geosetId=e.readInt32(),this.geosetAnimationId=e.readInt32()}writeMdx(e){super.writeMdx(e),e.writeInt32(this.geosetId),e.writeInt32(this.geosetAnimationId)}readMdl(e){for(let t of super.readMdl(e))if("GeosetId"===t)t=e.read(),this.geosetId="Multiple"===t?-1:parseInt(t);else{if("GeosetAnimId"!==t)throw new Error("Unknown token in Bone ".concat(this.name,': "').concat(t,'"'));t=e.read(),this.geosetAnimationId="None"===t?-1:parseInt(t)}}writeMdl(e){e.startObjectBlock("Bone",this.name),this.writeGenericHeader(e);let t=this.geosetId,i=this.geosetAnimationId;-1===t&&(t="Multiple"),-1===i&&(i="None"),e.writeAttrib("GeosetId",t),e.writeAttrib("GeosetAnimId",i),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 8+super.getByteLength()}}class qi extends Ki{constructor(){super(512),this.type=-1,this.attenuation=new Float32Array(2),this.color=new Float32Array(3),this.intensity=0,this.ambientColor=new Float32Array(3),this.ambientIntensity=0}readMdx(e){let t=e.readUint32();super.readMdx(e),this.type=e.readUint32(),e.readFloat32Array(this.attenuation),e.readFloat32Array(this.color),this.intensity=e.readFloat32(),e.readFloat32Array(this.ambientColor),this.ambientIntensity=e.readFloat32(),this.readAnimations(e,t-this.getByteLength())}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeUint32(this.type),e.writeFloat32Array(this.attenuation),e.writeFloat32Array(this.color),e.writeFloat32(this.intensity),e.writeFloat32Array(this.ambientColor),e.writeFloat32(this.ambientIntensity),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(let t of super.readMdl(e))if("Omnidirectional"===t)this.type=0;else if("Directional"===t)this.type=1;else if("Ambient"===t)this.type=2;else if("static AttenuationStart"===t)this.attenuation[0]=e.readFloat();else if("AttenuationStart"===t)this.readAnimation(e,"KLAS");else if("static AttenuationEnd"===t)this.attenuation[1]=e.readFloat();else if("AttenuationEnd"===t)this.readAnimation(e,"KLAE");else if("static Intensity"===t)this.intensity=e.readFloat();else if("Intensity"===t)this.readAnimation(e,"KLAI");else if("static Color"===t)e.readColor(this.color);else if("Color"===t)this.readAnimation(e,"KLAC");else if("static AmbIntensity"===t)this.ambientIntensity=e.readFloat();else if("AmbIntensity"===t)this.readAnimation(e,"KLBI");else if("static AmbColor"===t)e.readColor(this.ambientColor);else if("AmbColor"===t)this.readAnimation(e,"KLBC");else{if("Visibility"!==t)throw new Error('Unknown token in Light: "'.concat(t,'"'));this.readAnimation(e,"KLAV")}}writeMdl(e){e.startObjectBlock("Light",this.name),this.writeGenericHeader(e),0===this.type?e.writeFlag("Omnidirectional"):1===this.type?e.writeFlag("Directional"):2===this.type&&e.writeFlag("Ambient"),this.writeAnimation(e,"KLAS")||e.writeFloatAttrib("static AttenuationStart",this.attenuation[0]),this.writeAnimation(e,"KLAE")||e.writeFloatAttrib("static AttenuationEnd",this.attenuation[1]),this.writeAnimation(e,"KLAI")||e.writeFloatAttrib("static Intensity",this.intensity),this.writeAnimation(e,"KLAC")||e.writeColor("static Color",this.color),this.writeAnimation(e,"KLBI")||e.writeFloatAttrib("static AmbIntensity",this.ambientIntensity),this.writeAnimation(e,"KLBC")||e.writeColor("static AmbColor",this.ambientColor),this.writeAnimation(e,"KLAV"),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 48+super.getByteLength()}}class Xi extends Ki{readMdl(e){for(let t of super.readMdl(e))throw new Error('Unknown token in Helper: "'.concat(t,'"'))}writeMdl(e){e.startObjectBlock("Helper",this.name),this.writeGenericHeader(e),this.writeGenericAnimations(e),e.endBlock()}}class Ji extends Ki{constructor(){super(2048),this.path="",this.attachmentId=0}readMdx(e){let t=e.readUint32();super.readMdx(e),this.path=e.read(260),this.attachmentId=e.readInt32(),this.readAnimations(e,t-this.getByteLength())}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.write(this.path),e.skip(260-this.path.length),e.writeInt32(this.attachmentId),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(let t of super.readMdl(e))if("AttachmentID"===t)this.attachmentId=e.readInt();else if("Path"===t)this.path=e.read();else{if("Visibility"!==t)throw new Error("Unknown token in Attachment ".concat(this.name,': "').concat(t,'"'));this.readAnimation(e,"KATV")}}writeMdl(e){e.startObjectBlock("Attachment",this.name),this.writeGenericHeader(e),e.writeAttrib("AttachmentID",this.attachmentId),this.path.length&&e.writeStringAttrib("Path",this.path),this.writeAnimation(e,"KATV"),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 268+super.getByteLength()}}class Qi extends Ki{constructor(){super(4096),this.emissionRate=0,this.gravity=0,this.longitude=0,this.latitude=0,this.path="",this.lifeSpan=0,this.speed=0}readMdx(e){let t=e.readUint32();super.readMdx(e),this.emissionRate=e.readFloat32(),this.gravity=e.readFloat32(),this.longitude=e.readFloat32(),this.latitude=e.readFloat32(),this.path=e.read(260),this.lifeSpan=e.readFloat32(),this.speed=e.readFloat32(),this.readAnimations(e,t-this.getByteLength())}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeFloat32(this.emissionRate),e.writeFloat32(this.gravity),e.writeFloat32(this.longitude),e.writeFloat32(this.latitude),e.write(this.path),e.skip(260-this.path.length),e.writeFloat32(this.lifeSpan),e.writeFloat32(this.speed),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(let t of super.readMdl(e))if("EmitterUsesMDL"===t)this.flags|=32768;else if("EmitterUsesTGA"===t)this.flags|=65536;else if("static EmissionRate"===t)this.emissionRate=e.readFloat();else if("EmissionRate"===t)this.readAnimation(e,"KPEE");else if("static Gravity"===t)this.gravity=e.readFloat();else if("Gravity"===t)this.readAnimation(e,"KPEG");else if("static Longitude"===t)this.longitude=e.readFloat();else if("Longitude"===t)this.readAnimation(e,"KPLN");else if("static Latitude"===t)this.latitude=e.readFloat();else if("Latitude"===t)this.readAnimation(e,"KPLT");else if("Visibility"===t)this.readAnimation(e,"KPEV");else{if("Particle"!==t)throw new Error('Unknown token in ParticleEmitter: "'.concat(t,'"'));for(t of this.readAnimatedBlock(e))"static LifeSpan"===t?this.lifeSpan=e.readFloat():"LifeSpan"===t?this.readAnimation(e,"KPEL"):"static InitVelocity"===t?this.speed=e.readFloat():"InitVelocity"===t?this.readAnimation(e,"KPES"):"Path"===t&&(this.path=e.read())}}writeMdl(e){e.startObjectBlock("ParticleEmitter",this.name),this.writeGenericHeader(e),32768&this.flags&&e.writeFlag("EmitterUsesMDL"),65536&this.flags&&e.writeFlag("EmitterUsesTGA"),this.writeAnimation(e,"KPEE")||e.writeFloatAttrib("static EmissionRate",this.emissionRate),this.writeAnimation(e,"KPEG")||e.writeFloatAttrib("static Gravity",this.gravity),this.writeAnimation(e,"KPLN")||e.writeFloatAttrib("static Longitude",this.longitude),this.writeAnimation(e,"KPLT")||e.writeFloatAttrib("static Latitude",this.latitude),this.writeAnimation(e,"KPEV"),e.startBlock("Particle"),this.writeAnimation(e,"KPEL")||e.writeFloatAttrib("static LifeSpan",this.lifeSpan),this.writeAnimation(e,"KPES")||e.writeFloatAttrib("static InitVelocity",this.speed),(32768&this.flags||65536&this.flags)&&e.writeAttrib("Path",this.path),e.endBlock(),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 288+super.getByteLength()}}class $i extends Ki{constructor(){super(),this.speed=0,this.variation=0,this.latitude=0,this.gravity=0,this.lifeSpan=0,this.emissionRate=0,this.length=0,this.width=0,this.filterMode=0,this.rows=0,this.columns=0,this.headOrTail=0,this.tailLength=0,this.timeMiddle=0,this.segmentColors=[new Float32Array(3),new Float32Array(3),new Float32Array(3)],this.segmentAlphas=new Uint8Array(3),this.segmentScaling=new Float32Array(3),this.headIntervals=[new Uint32Array(3),new Uint32Array(3)],this.tailIntervals=[new Uint32Array(3),new Uint32Array(3)],this.textureId=-1,this.squirt=0,this.priorityPlane=0,this.replaceableId=0}readMdx(e){const t=e.readUint32();super.readMdx(e),this.speed=e.readFloat32(),this.variation=e.readFloat32(),this.latitude=e.readFloat32(),this.gravity=e.readFloat32(),this.lifeSpan=e.readFloat32(),this.emissionRate=e.readFloat32(),this.length=e.readFloat32(),this.width=e.readFloat32(),this.filterMode=e.readUint32(),this.rows=e.readUint32(),this.columns=e.readUint32(),this.headOrTail=e.readUint32(),this.tailLength=e.readFloat32(),this.timeMiddle=e.readFloat32(),e.readFloat32Array(this.segmentColors[0]),e.readFloat32Array(this.segmentColors[1]),e.readFloat32Array(this.segmentColors[2]),e.readUint8Array(this.segmentAlphas),e.readFloat32Array(this.segmentScaling),e.readUint32Array(this.headIntervals[0]),e.readUint32Array(this.headIntervals[1]),e.readUint32Array(this.tailIntervals[0]),e.readUint32Array(this.tailIntervals[1]),this.textureId=e.readInt32(),this.squirt=e.readUint32(),this.priorityPlane=e.readInt32(),this.replaceableId=e.readUint32(),this.readAnimations(e,t-this.getByteLength())}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeFloat32(this.speed),e.writeFloat32(this.variation),e.writeFloat32(this.latitude),e.writeFloat32(this.gravity),e.writeFloat32(this.lifeSpan),e.writeFloat32(this.emissionRate),e.writeFloat32(this.length),e.writeFloat32(this.width),e.writeUint32(this.filterMode),e.writeUint32(this.rows),e.writeUint32(this.columns),e.writeUint32(this.headOrTail),e.writeFloat32(this.tailLength),e.writeFloat32(this.timeMiddle),e.writeFloat32Array(this.segmentColors[0]),e.writeFloat32Array(this.segmentColors[1]),e.writeFloat32Array(this.segmentColors[2]),e.writeUint8Array(this.segmentAlphas),e.writeFloat32Array(this.segmentScaling),e.writeUint32Array(this.headIntervals[0]),e.writeUint32Array(this.headIntervals[1]),e.writeUint32Array(this.tailIntervals[0]),e.writeUint32Array(this.tailIntervals[1]),e.writeInt32(this.textureId),e.writeUint32(this.squirt),e.writeInt32(this.priorityPlane),e.writeUint32(this.replaceableId),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(const t of super.readMdl(e))if("SortPrimsFarZ"===t)this.flags|=65536;else if("Unshaded"===t)this.flags|=32768;else if("LineEmitter"===t)this.flags|=131072;else if("Unfogged"===t)this.flags|=262144;else if("ModelSpace"===t)this.flags|=524288;else if("XYQuad"===t)this.flags|=1048576;else if("static Speed"===t)this.speed=e.readFloat();else if("Speed"===t)this.readAnimation(e,"KP2S");else if("static Variation"===t)this.variation=e.readFloat();else if("Variation"===t)this.readAnimation(e,"KP2R");else if("static Latitude"===t)this.latitude=e.readFloat();else if("Latitude"===t)this.readAnimation(e,"KP2L");else if("static Gravity"===t)this.gravity=e.readFloat();else if("Gravity"===t)this.readAnimation(e,"KP2G");else if("Visibility"===t)this.readAnimation(e,"KP2V");else if("Squirt"===t)this.squirt=1;else if("LifeSpan"===t)this.lifeSpan=e.readFloat();else if("static EmissionRate"===t)this.emissionRate=e.readFloat();else if("EmissionRate"===t)this.readAnimation(e,"KP2E");else if("static Width"===t)this.width=e.readFloat();else if("Width"===t)this.readAnimation(e,"KP2W");else if("static Length"===t)this.length=e.readFloat();else if("Length"===t)this.readAnimation(e,"KP2N");else if("Blend"===t)this.filterMode=0;else if("Additive"===t)this.filterMode=1;else if("Modulate"===t)this.filterMode=2;else if("Modulate2x"===t)this.filterMode=3;else if("AlphaKey"===t)this.filterMode=4;else if("Rows"===t)this.rows=e.readInt();else if("Columns"===t)this.columns=e.readInt();else if("Head"===t)this.headOrTail=0;else if("Tail"===t)this.headOrTail=1;else if("Both"===t)this.headOrTail=2;else if("TailLength"===t)this.tailLength=e.readFloat();else if("Time"===t)this.timeMiddle=e.readFloat();else if("SegmentColor"===t){e.read();for(let t=0;t<3;t++)e.read(),e.readColor(this.segmentColors[t]);e.read()}else if("Alpha"===t)e.readIntArray(this.segmentAlphas);else if("ParticleScaling"===t)e.readFloatArray(this.segmentScaling);else if("LifeSpanUVAnim"===t)e.readIntArray(this.headIntervals[0]);else if("DecayUVAnim"===t)e.readIntArray(this.headIntervals[1]);else if("TailUVAnim"===t)e.readIntArray(this.tailIntervals[0]);else if("TailDecayUVAnim"===t)e.readIntArray(this.tailIntervals[1]);else if("TextureID"===t)this.textureId=e.readInt();else if("ReplaceableId"===t)this.replaceableId=e.readInt();else{if("PriorityPlane"!==t)throw new Error('Unknown token in ParticleEmitter2: "'.concat(t,'"'));this.priorityPlane=e.readInt()}}writeMdl(e){e.startObjectBlock("ParticleEmitter2",this.name),this.writeGenericHeader(e),65536&this.flags&&e.writeFlag("SortPrimsFarZ"),32768&this.flags&&e.writeFlag("Unshaded"),131072&this.flags&&e.writeFlag("LineEmitter"),262144&this.flags&&e.writeFlag("Unfogged"),524288&this.flags&&e.writeFlag("ModelSpace"),1048576&this.flags&&e.writeFlag("XYQuad"),this.writeAnimation(e,"KP2S")||e.writeFloatAttrib("static Speed",this.speed),this.writeAnimation(e,"KP2R")||e.writeFloatAttrib("static Variation",this.variation),this.writeAnimation(e,"KP2L")||e.writeFloatAttrib("static Latitude",this.latitude),this.writeAnimation(e,"KP2G")||e.writeFloatAttrib("static Gravity",this.gravity),this.writeAnimation(e,"KP2V"),this.squirt&&e.writeFlag("Squirt"),e.writeFloatAttrib("LifeSpan",this.lifeSpan),this.writeAnimation(e,"KP2E")||e.writeFloatAttrib("static EmissionRate",this.emissionRate),this.writeAnimation(e,"KP2W")||e.writeFloatAttrib("static Width",this.width),this.writeAnimation(e,"KP2N")||e.writeFloatAttrib("static Length",this.length),0===this.filterMode?e.writeFlag("Blend"):1===this.filterMode?e.writeFlag("Additive"):2===this.filterMode?e.writeFlag("Modulate"):3===this.filterMode?e.writeFlag("Modulate2x"):4===this.filterMode&&e.writeFlag("AlphaKey"),e.writeAttrib("Rows",this.rows),e.writeAttrib("Columns",this.columns),0===this.headOrTail?e.writeFlag("Head"):1===this.headOrTail?e.writeFlag("Tail"):2===this.headOrTail&&e.writeFlag("Both"),e.writeFloatAttrib("TailLength",this.tailLength),e.writeFloatAttrib("Time",this.timeMiddle),e.startBlock("SegmentColor"),e.writeColor("Color",this.segmentColors[0]),e.writeColor("Color",this.segmentColors[1]),e.writeColor("Color",this.segmentColors[2]),e.endBlockComma(),e.writeArrayAttrib("Alpha",this.segmentAlphas),e.writeFloatArrayAttrib("ParticleScaling",this.segmentScaling),e.writeArrayAttrib("LifeSpanUVAnim",this.headIntervals[0]),e.writeArrayAttrib("DecayUVAnim",this.headIntervals[1]),e.writeArrayAttrib("TailUVAnim",this.tailIntervals[0]),e.writeArrayAttrib("TailDecayUVAnim",this.tailIntervals[1]),e.writeAttrib("TextureID",this.textureId),0!==this.replaceableId&&e.writeAttrib("ReplaceableId",this.replaceableId),0!==this.priorityPlane&&e.writeAttrib("PriorityPlane",this.priorityPlane),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 175+super.getByteLength()}}class Zi extends Ki{constructor(){super(16384),this.heightAbove=0,this.heightBelow=0,this.alpha=0,this.color=new Float32Array(3),this.lifeSpan=0,this.textureSlot=0,this.emissionRate=0,this.rows=0,this.columns=0,this.materialId=0,this.gravity=0}readMdx(e){let t=e.readUint32();super.readMdx(e),this.heightAbove=e.readFloat32(),this.heightBelow=e.readFloat32(),this.alpha=e.readFloat32(),e.readFloat32Array(this.color),this.lifeSpan=e.readFloat32(),this.textureSlot=e.readUint32(),this.emissionRate=e.readUint32(),this.rows=e.readUint32(),this.columns=e.readUint32(),this.materialId=e.readInt32(),this.gravity=e.readFloat32(),this.readAnimations(e,t-this.getByteLength())}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeFloat32(this.heightAbove),e.writeFloat32(this.heightBelow),e.writeFloat32(this.alpha),e.writeFloat32Array(this.color),e.writeFloat32(this.lifeSpan),e.writeUint32(this.textureSlot),e.writeUint32(this.emissionRate),e.writeUint32(this.rows),e.writeUint32(this.columns),e.writeInt32(this.materialId),e.writeFloat32(this.gravity),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(let t of super.readMdl(e))if("static HeightAbove"===t)this.heightAbove=e.readFloat();else if("HeightAbove"===t)this.readAnimation(e,"KRHA");else if("static HeightBelow"===t)this.heightBelow=e.readFloat();else if("HeightBelow"===t)this.readAnimation(e,"KRHB");else if("static Alpha"===t)this.alpha=e.readFloat();else if("Alpha"===t)this.readAnimation(e,"KRAL");else if("static Color"===t)e.readColor(this.color);else if("Color"===t)this.readAnimation(e,"KRCO");else if("static TextureSlot"===t)this.textureSlot=e.readInt();else if("TextureSlot"===t)this.readAnimation(e,"KRTX");else if("Visibility"===t)this.readAnimation(e,"KRVS");else if("EmissionRate"===t)this.emissionRate=e.readInt();else if("LifeSpan"===t)this.lifeSpan=e.readFloat();else if("Gravity"===t)this.gravity=e.readFloat();else if("Rows"===t)this.rows=e.readInt();else if("Columns"===t)this.columns=e.readInt();else{if("MaterialID"!==t)throw new Error('Unknown token in RibbonEmitter: "'.concat(t,'"'));this.materialId=e.readInt()}}writeMdl(e){e.startObjectBlock("RibbonEmitter",this.name),this.writeGenericHeader(e),this.writeAnimation(e,"KRHA")||e.writeFloatAttrib("static HeightAbove",this.heightAbove),this.writeAnimation(e,"KRHB")||e.writeFloatAttrib("static HeightBelow",this.heightBelow),this.writeAnimation(e,"KRAL")||e.writeFloatAttrib("static Alpha",this.alpha),this.writeAnimation(e,"KRCO")||e.writeColor("static Color",this.color),this.writeAnimation(e,"KRTX")||e.writeAttrib("static TextureSlot",this.textureSlot),this.writeAnimation(e,"KPEV"),e.writeAttrib("EmissionRate",this.emissionRate),e.writeFloatAttrib("LifeSpan",this.lifeSpan),0!==this.gravity&&e.writeFloatAttrib("Gravity",this.gravity),e.writeAttrib("Rows",this.rows),e.writeAttrib("Columns",this.columns),e.writeAttrib("MaterialID",this.materialId),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 56+super.getByteLength()}}class er extends Fi{constructor(){super(),this.name="",this.position=new Float32Array(3),this.fieldOfView=0,this.farClippingPlane=0,this.nearClippingPlane=0,this.targetPosition=new Float32Array(3)}readMdx(e){let t=e.readUint32();this.name=e.read(80),e.readFloat32Array(this.position),this.fieldOfView=e.readFloat32(),this.farClippingPlane=e.readFloat32(),this.nearClippingPlane=e.readFloat32(),e.readFloat32Array(this.targetPosition),this.readAnimations(e,t-120)}writeMdx(e){e.writeUint32(this.getByteLength()),e.write(this.name),e.skip(80-this.name.length),e.writeFloat32Array(this.position),e.writeFloat32(this.fieldOfView),e.writeFloat32(this.farClippingPlane),e.writeFloat32(this.nearClippingPlane),e.writeFloat32Array(this.targetPosition),this.writeAnimations(e)}readMdl(e){this.name=e.read();for(let t of e.readBlock())if("Position"===t)e.readFloatArray(this.position);else if("Translation"===t)this.readAnimation(e,"KCTR");else if("Rotation"===t)this.readAnimation(e,"KCRL");else if("FieldOfView"===t)this.fieldOfView=e.readFloat();else if("FarClip"===t)this.farClippingPlane=e.readFloat();else if("NearClip"===t)this.nearClippingPlane=e.readFloat();else{if("Target"!==t)throw new Error("Unknown token in Camera ".concat(this.name,': "').concat(t,'"'));for(t of e.readBlock())if("Position"===t)e.readFloatArray(this.targetPosition);else{if("Translation"!==t)throw new Error("Unknown token in Camera ".concat(this.name,"'s Target: \"").concat(t,'"'));this.readAnimation(e,"KTTR")}}}writeMdl(e){e.startObjectBlock("Camera",this.name),e.writeFloatArrayAttrib("Position",this.position),this.writeAnimation(e,"KCTR"),this.writeAnimation(e,"KCRL"),e.writeFloatAttrib("FieldOfView",this.fieldOfView),e.writeFloatAttrib("FarClip",this.farClippingPlane),e.writeFloatAttrib("NearClip",this.nearClippingPlane),e.startBlock("Target"),e.writeFloatArrayAttrib("Position",this.targetPosition),this.writeAnimation(e,"KTTR"),e.endBlock(),e.endBlock()}getByteLength(){return 120+super.getByteLength()}}class tr extends Ki{constructor(){super(1024),this.globalSequenceId=-1,this.tracks=new Uint32Array(1)}readMdx(e){super.readMdx(e),e.skip(4);let t=e.readUint32();this.globalSequenceId=e.readInt32(),this.tracks=e.readUint32Array(t)}writeMdx(e){super.writeMdx(e),e.write("KEVT"),e.writeUint32(this.tracks.length),e.writeInt32(this.globalSequenceId),e.writeUint32Array(this.tracks)}readMdl(e){for(let t of super.readMdl(e)){if("EventTrack"!==t)throw new Error('Unknown token in EventObject: "'.concat(t,'"'));this.tracks=e.readIntArray(new Uint32Array(e.readInt()))}}writeMdl(e){e.startObjectBlock("EventObject",this.name),this.writeGenericHeader(e),e.startBlock("EventTrack",this.tracks.length);for(let t of this.tracks)e.writeFlag(t);e.endBlock(),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 12+this.tracks.byteLength+super.getByteLength()}}class ir extends Ki{constructor(){super(8192),this.type=-1,this.vertices=[new Float32Array(3),new Float32Array(3)],this.boundsRadius=0}readMdx(e){super.readMdx(e),this.type=e.readUint32(),e.readFloat32Array(this.vertices[0]),2!==this.type&&e.readFloat32Array(this.vertices[1]),2!==this.type&&3!==this.type||(this.boundsRadius=e.readFloat32())}writeMdx(e){super.writeMdx(e),e.writeUint32(this.type),e.writeFloat32Array(this.vertices[0]),2!==this.type&&e.writeFloat32Array(this.vertices[1]),2!==this.type&&3!==this.type||e.writeFloat32(this.boundsRadius)}readMdl(e){for(let t of super.readMdl(e))if("Plane"===t)this.type=0;else if("Box"===t)this.type=1;else if("Sphere"===t)this.type=2;else if("Cylinder"===t)this.type=3;else if("Vertices"===t){let t=e.readInt();e.read(),e.readFloatArray(this.vertices[0]),2===t&&e.readFloatArray(this.vertices[1]),e.read()}else{if("BoundsRadius"!==t)throw new Error('Unknown token in CollisionShape: "'.concat(t,'"'));this.boundsRadius=e.readFloat()}}writeMdl(e){let t;e.startObjectBlock("CollisionShape",this.name),this.writeGenericHeader(e);let i=2,r=!1;0===this.type?t="Plane":1===this.type?t="Box":2===this.type?(t="Sphere",i=1,r=!0):3===this.type&&(t="Cylinder",r=!0),e.writeFlag(t),e.startBlock("Vertices",i),e.writeFloatArray(this.vertices[0]),2===i&&e.writeFloatArray(this.vertices[1]),e.endBlock(),r&&e.writeFloatAttrib("BoundsRadius",this.boundsRadius),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){let e=16+super.getByteLength();return 2!==this.type&&(e+=12),2!==this.type&&3!==this.type||(e+=4),e}}class rr{constructor(e,t,i){this.chunk=e.readUint8Array(new Uint8Array(t)),this.tag=i}getByteLength(){return this.chunk.byteLength}}class nr{constructor(e){this.version=800,this.name="",this.animationFile="",this.extent=new Si,this.blendTime=0,this.sequences=[],this.globalSequences=[],this.materials=[],this.textures=[],this.textureAnimations=[],this.geosets=[],this.geosetAnimations=[],this.bones=[],this.lights=[],this.helpers=[],this.attachments=[],this.pivotPoints=[],this.particleEmitters=[],this.particleEmitters2=[],this.ribbonEmitters=[],this.cameras=[],this.eventObjects=[],this.collisionShapes=[],this.unknownChunks=[],e&&this.load(e)}load(e){e instanceof ArrayBuffer?this.loadMdx(e):this.loadMdl(e)}loadMdx(e){let t=new bt(e);if("MDLX"!==t.read(4))throw new Error("WrongMagicNumber");for(;t.remaining()>0;){let e=t.read(4),i=t.readUint32();"VERS"===e?this.loadVersionChunk(t):"MODL"===e?this.loadModelChunk(t):"SEQS"===e?this.loadStaticObjects(this.sequences,Ri,t,i/132):"GLBS"===e?this.loadGlobalSequenceChunk(t,i):"MTLS"===e?this.loadDynamicObjects(this.materials,Gi,t,i):"TEXS"===e?this.loadStaticObjects(this.textures,ji,t,i/268):"TXAN"===e?this.loadDynamicObjects(this.textureAnimations,Yi,t,i):"GEOS"===e?this.loadDynamicObjects(this.geosets,Hi,t,i):"GEOA"===e?this.loadDynamicObjects(this.geosetAnimations,Wi,t,i):"BONE"===e?this.loadDynamicObjects(this.bones,zi,t,i):"LITE"===e?this.loadDynamicObjects(this.lights,qi,t,i):"HELP"===e?this.loadDynamicObjects(this.helpers,Xi,t,i):"ATCH"===e?this.loadDynamicObjects(this.attachments,Ji,t,i):"PIVT"===e?this.loadPivotPointChunk(t,i):"PREM"===e?this.loadDynamicObjects(this.particleEmitters,Qi,t,i):"PRE2"===e?this.loadDynamicObjects(this.particleEmitters2,$i,t,i):"RIBB"===e?this.loadDynamicObjects(this.ribbonEmitters,Zi,t,i):"CAMS"===e?this.loadDynamicObjects(this.cameras,er,t,i):"EVTS"===e?this.loadDynamicObjects(this.eventObjects,tr,t,i):"CLID"===e?this.loadDynamicObjects(this.collisionShapes,ir,t,i):this.unknownChunks.push(new rr(t,i,e))}}loadVersionChunk(e){this.version=e.readUint32()}loadModelChunk(e){this.name=e.read(80),this.animationFile=e.read(260),this.extent.readMdx(e),this.blendTime=e.readUint32()}loadStaticObjects(e,t,i,r){for(let n=0;n<r;n++){let r=new t;r.readMdx(i),e.push(r)}}loadGlobalSequenceChunk(e,t){for(let i=0,r=t/4;i<r;i++)this.globalSequences.push(e.readUint32())}loadDynamicObjects(e,t,i,r){let n=0;for(;n<r;){let r=new t;r.readMdx(i),n+=r.getByteLength(),e.push(r)}}loadPivotPointChunk(e,t){for(let i=0,r=t/12;i<r;i++)this.pivotPoints.push(e.readFloat32Array(new Float32Array(3)))}saveMdx(){let e=new ArrayBuffer(this.getByteLength()),t=new bt(e);return t.write("MDLX"),this.saveVersionChunk(t),this.saveModelChunk(t),this.saveStaticObjectChunk(t,"SEQS",this.sequences,132),this.saveGlobalSequenceChunk(t),this.saveDynamicObjectChunk(t,"MTLS",this.materials),this.saveStaticObjectChunk(t,"TEXS",this.textures,268),this.saveDynamicObjectChunk(t,"TXAN",this.textureAnimations),this.saveDynamicObjectChunk(t,"GEOS",this.geosets),this.saveDynamicObjectChunk(t,"GEOA",this.geosetAnimations),this.saveDynamicObjectChunk(t,"BONE",this.bones),this.saveDynamicObjectChunk(t,"LITE",this.lights),this.saveDynamicObjectChunk(t,"HELP",this.helpers),this.saveDynamicObjectChunk(t,"ATCH",this.attachments),this.savePivotPointChunk(t),this.saveDynamicObjectChunk(t,"PREM",this.particleEmitters),this.saveDynamicObjectChunk(t,"PRE2",this.particleEmitters2),this.saveDynamicObjectChunk(t,"RIBB",this.ribbonEmitters),this.saveDynamicObjectChunk(t,"CAMS",this.cameras),this.saveDynamicObjectChunk(t,"EVTS",this.eventObjects),this.saveDynamicObjectChunk(t,"CLID",this.collisionShapes),e}saveVersionChunk(e){e.write("VERS"),e.writeUint32(4),e.writeUint32(this.version)}saveModelChunk(e){e.write("MODL"),e.writeUint32(372),e.write(this.name),e.skip(80-this.name.length),e.write(this.animationFile),e.skip(260-this.animationFile.length),this.extent.writeMdx(e),e.writeUint32(this.blendTime)}saveStaticObjectChunk(e,t,i,r){if(i.length){e.write(t),e.writeUint32(i.length*r);for(let t of i)t.writeMdx(e)}}saveGlobalSequenceChunk(e){if(this.globalSequences.length){e.write("GLBS"),e.writeUint32(4*this.globalSequences.length);for(let t of this.globalSequences)e.writeUint32(t)}}saveDynamicObjectChunk(e,t,i){if(i.length){e.write(t),e.writeUint32(this.getObjectsByteLength(i));for(let t of i)t.writeMdx(e)}}savePivotPointChunk(e){if(this.pivotPoints.length){e.write("PIVT"),e.writeUint32(12*this.pivotPoints.length);for(let t of this.pivotPoints)e.writeFloat32Array(t)}}loadMdl(e){let t,i=new ai(e);for(;t=i.read();)if("Version"===t)this.loadVersionBlock(i);else if("Model"===t)this.loadModelBlock(i);else if("Sequences"===t)this.loadNumberedObjectBlock(this.sequences,Ri,"Anim",i);else if("GlobalSequences"===t)this.loadGlobalSequenceBlock(i);else if("Textures"===t)this.loadNumberedObjectBlock(this.textures,ji,"Bitmap",i);else if("Materials"===t)this.loadNumberedObjectBlock(this.materials,Gi,"Material",i);else if("TextureAnims"===t)this.loadNumberedObjectBlock(this.textureAnimations,Yi,"TVertexAnim",i);else if("Geoset"===t)this.loadObject(this.geosets,Hi,i);else if("GeosetAnim"===t)this.loadObject(this.geosetAnimations,Wi,i);else if("Bone"===t)this.loadObject(this.bones,zi,i);else if("Light"===t)this.loadObject(this.lights,qi,i);else if("Helper"===t)this.loadObject(this.helpers,Xi,i);else if("Attachment"===t)this.loadObject(this.attachments,Ji,i);else if("PivotPoints"===t)this.loadPivotPointBlock(i);else if("ParticleEmitter"===t)this.loadObject(this.particleEmitters,Qi,i);else if("ParticleEmitter2"===t)this.loadObject(this.particleEmitters2,$i,i);else if("RibbonEmitter"===t)this.loadObject(this.ribbonEmitters,Zi,i);else if("Camera"===t)this.loadObject(this.cameras,er,i);else if("EventObject"===t)this.loadObject(this.eventObjects,tr,i);else{if("CollisionShape"!==t)throw new Error("Unsupported block: ".concat(t));this.loadObject(this.collisionShapes,ir,i)}}loadVersionBlock(e){for(let t of e.readBlock()){if("FormatVersion"!==t)throw new Error('Unknown token in Version: "'.concat(t,'"'));this.version=e.readInt()}}loadModelBlock(e){this.name=e.read();for(let t of e.readBlock())if(t.startsWith("Num"))e.read();else if("BlendTime"===t)this.blendTime=e.readInt();else if("MinimumExtent"===t)e.readFloatArray(this.extent.min);else if("MaximumExtent"===t)e.readFloatArray(this.extent.max);else{if("BoundsRadius"!==t)throw new Error('Unknown token in Model: "'.concat(t,'"'));this.extent.boundsRadius=e.readFloat()}}loadNumberedObjectBlock(e,t,i,r){r.read();for(let n of r.readBlock()){if(n!==i)throw new Error("Unknown token in ".concat(i,': "').concat(n,'"'));{let i=new t;i.readMdl(r),e.push(i)}}}loadGlobalSequenceBlock(e){e.read();for(let t of e.readBlock()){if("Duration"!==t)throw new Error('Unknown token in GlobalSequences: "'.concat(t,'"'));this.globalSequences.push(e.readInt())}}loadObject(e,t,i){let r=new t;r.readMdl(i),e.push(r)}loadPivotPointBlock(e){let t=e.readInt();e.read();for(let i=0;i<t;i++)this.pivotPoints.push(e.readFloatArray(new Float32Array(3)));e.read()}saveMdl(){let e=new ai;return this.saveVersionBlock(e),this.saveModelBlock(e),this.saveStaticObjectsBlock(e,"Sequences",this.sequences),this.saveGlobalSequenceBlock(e),this.saveStaticObjectsBlock(e,"Textures",this.textures),this.saveStaticObjectsBlock(e,"Materials",this.materials),this.saveStaticObjectsBlock(e,"TextureAnims",this.textureAnimations),this.saveObjects(e,this.geosets),this.saveObjects(e,this.geosetAnimations),this.saveObjects(e,this.bones),this.saveObjects(e,this.lights),this.saveObjects(e,this.helpers),this.saveObjects(e,this.attachments),this.savePivotPointBlock(e),this.saveObjects(e,this.particleEmitters),this.saveObjects(e,this.particleEmitters2),this.saveObjects(e,this.ribbonEmitters),this.saveObjects(e,this.cameras),this.saveObjects(e,this.eventObjects),this.saveObjects(e,this.collisionShapes),e.buffer}saveVersionBlock(e){e.startBlock("Version"),e.writeAttrib("FormatVersion",this.version),e.endBlock()}saveModelBlock(e){e.startObjectBlock("Model",this.name),e.writeAttrib("BlendTime",this.blendTime),this.extent.writeMdl(e),e.endBlock()}saveStaticObjectsBlock(e,t,i){if(i.length){e.startBlock(t,i.length);for(let t of i)t.writeMdl(e);e.endBlock()}}saveGlobalSequenceBlock(e){if(this.globalSequences.length){e.startBlock("GlobalSequences",this.globalSequences.length);for(let t of this.globalSequences)e.writeAttrib("Duration",t);e.endBlock()}}saveObjects(e,t){for(let i of t)i.writeMdl(e)}savePivotPointBlock(e){if(this.pivotPoints.length){e.startBlock("PivotPoints",this.pivotPoints.length);for(let t of this.pivotPoints)e.writeFloatArray(t);e.endBlock()}}getByteLength(){let e=396;return e+=this.getStaticObjectsChunkByteLength(this.sequences,132),e+=this.getStaticObjectsChunkByteLength(this.globalSequences,4),e+=this.getDynamicObjectsChunkByteLength(this.materials),e+=this.getStaticObjectsChunkByteLength(this.textures,268),e+=this.getDynamicObjectsChunkByteLength(this.textureAnimations),e+=this.getDynamicObjectsChunkByteLength(this.geosets),e+=this.getDynamicObjectsChunkByteLength(this.geosetAnimations),e+=this.getDynamicObjectsChunkByteLength(this.bones),e+=this.getDynamicObjectsChunkByteLength(this.lights),e+=this.getDynamicObjectsChunkByteLength(this.helpers),e+=this.getDynamicObjectsChunkByteLength(this.attachments),e+=this.getStaticObjectsChunkByteLength(this.pivotPoints,12),e+=this.getDynamicObjectsChunkByteLength(this.particleEmitters),e+=this.getDynamicObjectsChunkByteLength(this.particleEmitters2),e+=this.getDynamicObjectsChunkByteLength(this.ribbonEmitters),e+=this.getDynamicObjectsChunkByteLength(this.cameras),e+=this.getDynamicObjectsChunkByteLength(this.eventObjects),e+=this.getDynamicObjectsChunkByteLength(this.collisionShapes),e+=8*this.unknownChunks.length+this.getDynamicObjectsChunkByteLength(this.unknownChunks)}getObjectsByteLength(e){let t=0;for(let i of e)t+=i.getByteLength();return t}getDynamicObjectsChunkByteLength(e){return e.length?8+this.getObjectsByteLength(e):0}getStaticObjectsChunkByteLength(e,t){return e.length?8+e.length*t:0}}var sr={mdlx:{Model:nr},slk:tt,w3x:wi,ini:Ze},ar=i(1),or=i(57),lr=i.n(or);function hr(e,t){return e+Math.random()*(t-e)}function cr(e,t,i){return e+i*(t-e)}function dr(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}let ur=document.createElement("canvas"),mr=ur.getContext("2d",{willReadFrequently:!0}),fr=document.createElement("canvas"),pr=fr.getContext("2d",{willReadFrequently:!0});function Er(e){let t=e.width,i=e.height,r=dr(t),n=dr(i);return t!==r||i!==n?function(e,t,i){let r=e.width,n=e.height;return e instanceof ImageData?(ur.width=r,ur.height=n,mr.putImageData(e,0,0),fr.width=t,fr.height=i,pr.drawImage(ur,0,0,t,i),pr.getImageData(0,0,t,i)):(ur.width=t,ur.height=i,mr.drawImage(e,0,0,t,i),mr.getImageData(0,0,t,i))}(e,r,n):e}async function gr(e,t){if("image"===t)return new Promise(t=>{let i=new Image;i.onload=(()=>{t({ok:!0,data:i})}),i.onerror=(e=>{t({ok:!1,error:"ImageError",data:e})}),i.src=e});{let r,n;try{r=await fetch(e)}catch(i){return{ok:!1,error:"NetworkError",data:i}}if(!r.ok)return{ok:!1,error:"HttpError",data:r};try{"text"===t?n=await r.text():"arrayBuffer"===t?n=await r.arrayBuffer():"blob"===t&&(n=await r.blob())}catch(i){return{ok:!1,error:"DataError",data:i}}return{ok:!0,data:n}}}function Ar(e){let t=0;for(let i=0,r=e.length;i<r;i++)t=31*t+e.charCodeAt(i),t&=t;return t}let _r=/:(\d+):/g;class Tr{constructor(e,t,i){let r=e.createShader(i);if(this.ok=!1,this.webglResource=r,this.src=t,this.shaderType=i,e.shaderSource(r,t),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS))this.ok=!0;else{let i=e.getShaderInfoLog(r),n=t.split("\n");console.error("Shader unit failed to compile!"),console.error(i);let s=_r.exec(i);for(;s;){let e=parseInt(s[1]);console.error(e+": "+n[e-1]),s=_r.exec(i)}}}}class vr{constructor(e,t,i){let r=e.createProgram(),n={},s={};if(this.ok=!1,this.webglResource=r,this.shaders=[t,i],this.uniforms=n,this.attribs=s,this.attribsCount=0,e.attachShader(r,t.webglResource),e.attachShader(r,i.webglResource),e.linkProgram(r),e.getProgramParameter(r,e.LINK_STATUS)){for(let t=0,i=e.getProgramParameter(r,e.ACTIVE_UNIFORMS);t<i;t++){let i=e.getActiveUniform(r,t);if(1===i.size)n[i.name]=e.getUniformLocation(r,i.name);else{let t=i.name.substr(0,i.name.length-3);for(let s=0;s<i.size;s++){let i=t+"["+s+"]";n[i]=e.getUniformLocation(r,i)}}}for(let t=0,i=e.getProgramParameter(r,e.ACTIVE_ATTRIBUTES);t<i;t++){let i=e.getActiveAttrib(r,t);if(this.attribsCount+=i.size,1===i.size)s[i.name]=e.getAttribLocation(r,i.name);else{let t=i.name.substr(0,i.name.length-3);for(let n=0;n<i.size;n++){let i=t+"["+n+"]";s[i]=e.getAttribLocation(r,i)}}}this.ok=!0}else console.error("Shader program failed to link!"),console.error(e.getProgramInfoLog(r))}}function yr(e){let t=e.split("_"),i=t[1];for(let r=2,n=t.length;r<n;r++)i+=t[r][0].toUpperCase()+t[r].substr(1);return i}class wr{constructor(e,t){let i=e.getContext("webgl2",t||{alpha:!1,antialias:!1});if(this.webgl2=!0,i||(i=e.getContext("webgl",t||{alpha:!1,antialias:!1}),this.webgl2=!1),i||(i=e.getContext("experimental-webgl",t||{alpha:!1,antialias:!1})),!i)throw new Error("WebGL: Failed to create a WebGL context!");let r={};for(let a of i.getSupportedExtensions())a.startsWith("MOZ_")||(r[yr(a)]=i.getExtension(a));if(!i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS))throw new Error("WebGL: No vertex shader texture support!");if(!this.webgl2&&!r.textureFloat)throw new Error("WebGL: No floating point texture support!");if(!this.webgl2&&!r.instancedArrays)throw new Error("WebGL: No instanced rendering support!");if(this.webgl2&&(r.instancedArrays={VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE:i.VERTEX_ATTRIB_ARRAY_DIVISOR,drawArraysInstancedANGLE:i.drawArraysInstanced.bind(i),drawElementsInstancedANGLE:i.drawElementsInstanced.bind(i),vertexAttribDivisorANGLE:i.vertexAttribDivisor.bind(i)}),!this.webgl2){const e=i.texImage2D;i.RED=i.ALPHA,i.RG=i.LUMINANCE_ALPHA,i.texImage2D=function(t,r,n){for(var s=arguments.length,a=new Array(s>3?s-3:0),o=3;o<s;o++)a[o-3]=arguments[o];return n=a.length>3?a[3]:a[0],e.call(i,t,r,n,...a)}}i.extensions=r,i.depthFunc(i.LEQUAL),i.enable(i.DEPTH_TEST),this.gl=i,this.extensions=r,this.shaderUnits=new Map,this.shaderPrograms=new Map,this.currentShaderProgram=null,this.floatPrecision="precision mediump float;\n",this.shaderDefines="",this.webgl2?this.shaderDefines+="#define COMP1D r\n":this.shaderDefines+="#define COMP1D a\n";let n=new ImageData(2,2);for(let a=0;a<4;a++)n.data[4*a+3]=255;let s=i.createTexture();i.bindTexture(i.TEXTURE_2D,s),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.REPEAT),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.REPEAT),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,n),this.emptyTexture=s}createShaderUnit(e,t){let i=Ar(e),r=this.shaderUnits;return r.has(i)||r.set(i,new Tr(this.gl,e,t)),r.get(i)}createShaderProgram(e,t){let i=this.gl,r=this.createShaderUnit(this.shaderDefines+e,i.VERTEX_SHADER),n=this.createShaderUnit(this.floatPrecision+this.shaderDefines+t,i.FRAGMENT_SHADER),s=this.shaderPrograms;if(r.ok&&n.ok){let a=Ar(e+t);s.has(a)||s.set(a,new vr(i,r,n));let o=s.get(a);if(o.ok)return o}}enableVertexAttribs(e,t){let i=this.gl;for(let r=e;r<t;r++)i.enableVertexAttribArray(r)}disableVertexAttribs(e,t){let i=this.gl;for(let r=e;r<t;r++)i.disableVertexAttribArray(r)}useShaderProgram(e){let t=this.currentShaderProgram;if(e&&e.ok&&e!==t){let i=0,r=e.attribsCount;t&&(i=t.attribsCount),this.gl.useProgram(e.webglResource),r>i?this.enableVertexAttribs(i,r):r<i&&this.disableVertexAttribs(r,i),this.currentShaderProgram=e}}bindTexture(e,t){let i=this.gl;i.activeTexture(i.TEXTURE0+t),e&&e.ok?i.bindTexture(i.TEXTURE_2D,e.webglResource):i.bindTexture(i.TEXTURE_2D,this.emptyTexture)}}class Sr extends lr.a{promise(){this.emit("loadstart",this)}resolve(){this.emit("loadend",this)}}let Rr=ar.vec3.fromValues(1,0,0),br=ar.vec3.fromValues(0,1,0),Ir=ar.vec3.fromValues(0,0,1),Lr=ar.vec3.create(),Nr=ar.vec3.fromValues(1,1,1),xr=(ar.quat.fromValues(0,0,0,0),ar.quat.create()),Pr=ar.vec4.create();function Cr(e,t,i,r){let n=2*(t[0]-r[0])/r[2]-1,s=1-2*(t[1]-r[1])/r[3],a=2*t[2]-1;return ar.vec4.set(Pr,n,s,a,1),ar.vec4.transformMat4(Pr,Pr,i),ar.vec3.set(e,Pr[0]/Pr[3],Pr[1]/Pr[3],Pr[2]/Pr[3]),e}function Ur(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]}function Or(e,t){let i=ar.vec3.len(t);e[0]=t[0]/i,e[1]=t[1]/i,e[2]=t[2]/i,e[3]=t[3]/i}ar.vec3.create();let Dr=ar.vec3.create(),Mr=ar.vec3.create(),Fr=ar.vec3.create(),Br=ar.quat.create(),Vr=ar.mat4.create();class kr{constructor(){this.rect=ar.vec4.create(),this.isPerspective=!0,this.fov=0,this.aspect=0,this.isOrtho=!1,this.leftClipPlane=0,this.rightClipPlane=0,this.bottomClipPlane=0,this.topClipPlane=0,this.nearClipPlane=0,this.farClipPlane=0,this.location=ar.vec3.create(),this.rotation=ar.quat.create(),this.inverseRotation=ar.quat.create(),this.worldMatrix=ar.mat4.create(),this.projectionMatrix=ar.mat4.create(),this.worldProjectionMatrix=ar.mat4.create(),this.inverseWorldMatrix=ar.mat4.create(),this.inverseRotationMatrix=ar.mat4.create(),this.inverseWorldProjectionMatrix=ar.mat4.create(),this.directionX=ar.vec3.create(),this.directionY=ar.vec3.create(),this.directionZ=ar.vec3.create(),this.vectors=[ar.vec3.fromValues(-1,-1,0),ar.vec3.fromValues(-1,1,0),ar.vec3.fromValues(1,1,0),ar.vec3.fromValues(1,-1,0),ar.vec3.fromValues(1,0,0),ar.vec3.fromValues(0,1,0),ar.vec3.fromValues(0,0,1)],this.billboardedVectors=[ar.vec3.create(),ar.vec3.create(),ar.vec3.create(),ar.vec3.create(),ar.vec3.create(),ar.vec3.create(),ar.vec3.create()],this.planes=[ar.vec4.create(),ar.vec4.create(),ar.vec4.create(),ar.vec4.create(),ar.vec4.create(),ar.vec4.create()],this.dirty=!0}perspective(e,t,i,r){this.isPerspective=!0,this.isOrtho=!1,this.fov=e,this.aspect=t,this.nearClipPlane=i,this.farClipPlane=r,this.dirty=!0}ortho(e,t,i,r,n,s){this.isPerspective=!1,this.isOrtho=!0,this.leftClipPlane=e,this.rightClipPlane=t,this.bottomClipPlane=i,this.topClipPlane=r,this.nearClipPlane=n,this.farClipPlane=s,this.dirty=!0}viewport(e){ar.vec4.copy(this.rect,e),this.aspect=e[2]/e[3],this.dirty=!0}setLocation(e){ar.vec3.copy(this.location,e),this.dirty=!0}move(e){ar.vec3.add(this.location,this.location,e),this.dirty=!0}setRotation(e){ar.quat.copy(this.rotation,e),this.dirty=!0}rotate(e){ar.quat.mul(this.rotation,this.rotation,e),this.dirty=!0}setRotationAngles(e,t){ar.quat.identity(this.rotation),this.rotateAngles(e,t)}rotateAround(e,t){this.rotate(e),ar.quat.conjugate(Br,Br),ar.vec3.sub(Dr,this.location,t),ar.vec3.transformQuat(Dr,Dr,e),ar.vec3.add(this.location,Dr,t)}setRotationAround(e,t,i){this.setRotation(e),null==i&&(i=ar.vec3.len(ar.vec3.sub(Dr,this.location,t))),ar.quat.conjugate(Br,Br),ar.vec3.copy(Dr,Ir),ar.vec3.transformQuat(Dr,Dr,Br),ar.vec3.scale(Dr,Dr,i),ar.vec3.add(this.location,Dr,t)}setRotationAroundAngles(e,t,i,r){ar.quat.identity(Br),ar.quat.rotateX(Br,Br,t),ar.quat.rotateZ(Br,Br,e),this.setRotationAround(Br,i,r)}face(e,t){ar.mat4.lookAt(Vr,this.location,e,t),ar.mat4.getRotation(this.rotation,Vr),this.dirty=!0}moveToAndFace(e,t,i){ar.vec3.copy(this.location,e),this.face(t,i)}reset(){ar.vec3.set(this.location,0,0,0),ar.quat.identity(this.rotation),this.dirty=!0}update(){if(this.dirty){this.dirty=!1;let e=this.location,t=this.rotation,i=this.inverseRotation,r=this.worldMatrix,n=this.projectionMatrix,s=this.worldProjectionMatrix,a=this.vectors,o=this.billboardedVectors;this.isPerspective?ar.mat4.perspective(n,this.fov,this.aspect,this.nearClipPlane,this.farClipPlane):ar.mat4.ortho(n,this.leftClipPlane,this.rightClipPlane,this.bottomClipPlane,this.topClipPlane,this.nearClipPlane,this.farClipPlane),ar.mat4.fromQuat(r,t),ar.mat4.translate(r,r,ar.vec3.negate(Dr,e)),ar.quat.conjugate(i,t),ar.mat4.mul(s,n,r),function(e,t){let i,r=t[0],n=t[4],s=t[8],a=t[12],o=t[1],l=t[5],h=t[9],c=t[13],d=t[2],u=t[6],m=t[10],f=t[14],p=t[3],E=t[7],g=t[11],A=t[15];(i=e[0])[0]=p+r,i[1]=E+n,i[2]=g+s,i[3]=A+a,(i=e[1])[0]=p-r,i[1]=E-n,i[2]=g-s,i[3]=A-a,(i=e[2])[0]=p-o,i[1]=E-l,i[2]=g-h,i[3]=A-c,(i=e[3])[0]=p+o,i[1]=E+l,i[2]=g+h,i[3]=A+c,(i=e[4])[0]=p+d,i[1]=E+u,i[2]=g+m,i[3]=A+f,(i=e[5])[0]=p-d,i[1]=E-u,i[2]=g-m,i[3]=A-f,Or(e[0],e[0]),Or(e[1],e[1]),Or(e[2],e[2]),Or(e[3],e[3]),Or(e[4],e[4]),Or(e[5],e[5])}(this.planes,s),ar.mat4.invert(this.inverseWorldMatrix,r),ar.vec3.transformQuat(this.directionX,Rr,i),ar.vec3.transformQuat(this.directionY,br,i),ar.vec3.transformQuat(this.directionZ,Ir,i),ar.mat4.invert(this.inverseWorldProjectionMatrix,s);for(let l=0;l<7;l++)ar.vec3.transformQuat(o[l],a[l],i)}}testSphere(e,t){for(let i of this.planes)if(Ur(i,e)<=-t)return!1;return!0}cameraToWorld(e,t){return ar.vec3.transformMat4(e,t,this.inverseWorldMatrix)}worldToCamera(e,t){return ar.vec3.transformMat4(e,t,this.worldMatrix)}worldToScreen(e,t){let i=this.rect;return ar.vec3.transformMat4(Dr,t,this.worldProjectionMatrix),e[0]=Math.round((Dr[0]+1)/2*i[2]),e[1]=Math.round((1-Dr[1])/2*i[3]),e}screenToWorldRay(e,t){let i=Dr,r=Mr,n=Fr,s=t[0],a=t[1],o=this.inverseWorldProjectionMatrix,l=this.rect;return Cr(i,ar.vec3.set(n,s,a,0),o,l),Cr(r,ar.vec3.set(n,s,a,1),o,l),e.set(i,0),e.set(r,3),e}}let Gr=ar.vec3.create(),jr=ar.quat.create(),Yr=ar.vec3.create(),Hr=e=>(class extends e{constructor(){super(),this.pivot=ar.vec3.create(),this.localLocation=ar.vec3.create(),this.localRotation=ar.quat.create(),this.localScale=ar.vec3.fromValues(1,1,1),this.worldLocation=ar.vec3.create(),this.worldRotation=ar.quat.create(),this.worldScale=ar.vec3.create(),this.inverseWorldLocation=ar.vec3.create(),this.inverseWorldRotation=ar.quat.create(),this.inverseWorldScale=ar.vec3.create(),this.localMatrix=ar.mat4.create(),this.worldMatrix=ar.mat4.create(),this.parent=null,this.children=[],this.dontInheritTranslation=!1,this.dontInheritRotation=!1,this.dontInheritScaling=!0,this.visible=!0,this.wasDirty=!1,this.dirty=!0}setPivot(e){return ar.vec3.copy(this.pivot,e),this.dirty=!0,this}setLocation(e){return ar.vec3.copy(this.localLocation,e),this.dirty=!0,this}setRotation(e){return ar.quat.copy(this.localRotation,e),this.dirty=!0,this}setScale(e){return ar.vec3.copy(this.localScale,e),this.dirty=!0,this}setUniformScale(e){return ar.vec3.set(this.localScale,e,e,e),this.dirty=!0,this}setTransformation(e,t,i){let r=this.localLocation,n=this.localRotation,s=this.localScale;return r[0]=e[0],r[1]=e[1],r[2]=e[2],n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],s[0]=i[0],s[1]=i[1],s[2]=i[2],this.dirty=!0,this}resetTransformation(){return ar.vec3.copy(this.pivot,Lr),ar.vec3.copy(this.localLocation,Lr),ar.quat.copy(this.localRotation,xr),ar.vec3.copy(this.localScale,Nr),this.dirty=!0,this}movePivot(e){return ar.vec3.add(this.pivot,this.pivot,e),this.dirty=!0,this}move(e){return ar.vec3.add(this.localLocation,this.localLocation,e),this.dirty=!0,this}rotate(e){return ar.quat.mul(this.localRotation,this.localRotation,e),this.dirty=!0,this}rotateLocal(e){return ar.quat.mul(this.localRotation,e,this.localRotation),this.dirty=!0,this}scale(e){return ar.vec3.mul(this.localScale,this.localScale,e),this.dirty=!0,this}uniformScale(e){return ar.vec3.scale(this.localScale,this.localScale,e),this.dirty=!0,this}setParent(e){if(this.parent){let e=this.parent.children,t=e.indexOf(this);-1!==t&&e.splice(t,1)}return this.parent=e,e&&e.children.push(this),this.dirty=!0,this}recalculateTransformation(){let e=this.dirty,t=this.parent;if(this.wasDirty=this.dirty,t&&(e=e||t.wasDirty),this.wasDirty=e,e){this.dirty=!1;let e=this.localMatrix,i=this.localLocation,r=this.localRotation,n=this.localScale,s=this.worldMatrix,a=this.worldLocation,o=this.worldRotation,l=this.worldScale,h=this.inverseWorldLocation,c=this.inverseWorldRotation,d=this.inverseWorldScale;if(t){let a,h,c=t.pivot;if((a=Gr)[0]=i[0]+c[0],a[1]=i[1]+c[1],a[2]=i[2]+c[2],this.dontInheritScaling){h=Yr;let e=t.inverseWorldScale;h[0]=e[0]*n[0],h[1]=e[1]*n[1],h[2]=e[2]*n[2],l[0]=n[0],l[1]=n[1],l[2]=n[2]}else{h=n;let e=t.worldScale;l[0]=e[0]*n[0],l[1]=e[1]*n[1],l[2]=e[2]*n[2]}ar.mat4.fromRotationTranslationScale(e,r,a,h),ar.mat4.mul(s,t.worldMatrix,e),ar.quat.mul(o,t.worldRotation,r)}else ar.mat4.fromRotationTranslationScale(e,r,i,n),s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[8]=e[8],s[9]=e[9],s[10]=e[10],s[11]=e[11],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15],o[0]=r[0],o[1]=r[1],o[2]=r[2],o[3]=r[3],l[0]=n[0],l[1]=n[1],l[2]=n[2];c[0]=-o[0],c[1]=-o[1],c[2]=-o[2],c[3]=o[3],d[0]=1/l[0],d[1]=1/l[1],d[2]=1/l[2],a[0]=s[12],a[1]=s[13],a[2]=s[14],h[0]=-a[0],h[1]=-a[1],h[2]=-a[2]}}update(e){this.dirty||this.parent&&this.parent.wasDirty?(this.dirty=!0,this.wasDirty=!0,this.recalculateTransformation()):this.wasDirty=!1,this.updateObject(e),this.updateChildren(e)}updateObject(e){}updateChildren(e){let t=this.children;for(let i=0,r=t.length;i<r;i++)t[i].update(e)}});class Wr extends(Hr(class{})){}class Kr extends(Hr(lr.a)){}class zr{constructor(e){this.pivot=e[0],this.localLocation=e[1],this.localRotation=e[2],this.localScale=e[3],this.worldLocation=e[4],this.worldRotation=e[5],this.worldScale=e[6],this.inverseWorldLocation=e[7],this.inverseWorldRotation=e[8],this.inverseWorldScale=e[9],this.localMatrix=e[10],this.worldMatrix=e[11],this.dontInheritTranslation=!1,this.dontInheritRotation=!1,this.dontInheritScaling=!1,this.children=[],this.visible=!0,this.wasDirty=!1,this.object=null,this.localRotation[3]=1,this.localScale.fill(1),this.localMatrix[0]=1,this.localMatrix[5]=1,this.localMatrix[10]=1,this.localMatrix[15]=1,this.dirty=!0,this.billboarded=!1,this.billboardedX=!1,this.billboardedY=!1,this.billboardedZ=!1}recalculateTransformation(e){let t,i,r=this.localMatrix,n=this.localRotation,s=this.localScale,a=this.worldMatrix,o=this.worldLocation,l=this.worldRotation,h=this.worldScale,c=this.pivot,d=this.inverseWorldLocation,u=this.inverseWorldRotation,m=this.inverseWorldScale,f=this.parent;if(this.dontInheritScaling){i=Yr;let e=f.inverseWorldScale;i[0]=e[0]*s[0],i[1]=e[1]*s[1],i[2]=e[2]*s[2],h[0]=s[0],h[1]=s[1],h[2]=s[2]}else{i=s;let e=f.worldScale;h[0]=e[0]*s[0],h[1]=e[1]*s[1],h[2]=e[2]*s[2]}this.billboarded?(t=jr,ar.quat.copy(t,f.inverseWorldRotation),ar.quat.mul(t,t,e.camera.inverseRotation),this.convertBasis(t)):t=n,ar.mat4.fromRotationTranslationScaleOrigin(r,t,this.localLocation,i,c),ar.mat4.mul(a,f.worldMatrix,r),ar.quat.mul(l,f.worldRotation,t),u[0]=-l[0],u[1]=-l[1],u[2]=-l[2],u[3]=l[3],m[0]=1/h[0],m[1]=1/h[1],m[2]=1/h[2];let p=c[0],E=c[1],g=c[2];o[0]=a[0]*p+a[4]*E+a[8]*g+a[12],o[1]=a[1]*p+a[5]*E+a[9]*g+a[13],o[2]=a[2]*p+a[6]*E+a[10]*g+a[14],d[0]=-o[0],d[1]=-o[1],d[2]=-o[2]}updateChildren(e){let t=this.children;for(let i=0,r=t.length;i<r;i++)t[i].update(e)}convertBasis(e){}}const qr=65;let Xr=new Float32Array(3);class Jr{constructor(e){let t=e.canvas;this.viewer=e,this.camera=new kr,this.instances=[],this.instanceSet=new Set,this.modelViews=[],this.modelViewSet=new Set,this.node=new Wr,this.rendered=!0,this.renderedInstances=0,this.renderedParticles=0,this.renderedBuckets=0,this.renderCalls=0,this.audioEnabled=!1,this.audioContext=null,this.node.recalculateTransformation(this),this.node.wasDirty=!1,this.camera.viewport([0,0,t.width,t.height]),this.camera.perspective(Math.PI/4,t.width/t.height,8,1e4)}configureOverheadPerspective(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100;this.camera.viewport([0,0,e.width,e.height]);this.camera.perspective(Math.PI/180*90,e.width/e.height,1,1e4),this.camera.setLocation([0,t,0]);const i=ar.quat.setAxisAngle(ar.quat.create(),[0,1,0],Math.PI);this.camera.setRotation(i)}async enableAudio(){return this.audioContext||(this.audioContext=new AudioContext),"suspended"!==this.audioContext.state&&await this.audioContext.resume(),this.audioEnabled="running"===this.audioContext.state,this.audioEnabled}disableAudio(){this.audioContext&&this.audioContext.suspend(),this.audioEnabled=!1}addInstance(e){let t=this.instanceSet;return!t.has(e)&&(t.add(e),this.instances.push(e),e.scene&&e.scene.removeInstance(e),e.modelView.sceneChanged(e,this),e.scene=this,e.parent||e.setParent(this.node),this.addView(e.modelView),!0)}addView(e){let t=this.modelViewSet;t.has(e)||(t.add(e),this.modelViews.push(e))}removeInstance(e){if(this.instanceSet.delete(e)){let t=this.instances;return t.splice(t.indexOf(e),1),e.modelView.sceneChanged(e,null),e.scene=null,e.parent===this.node&&e.setParent(null),this.removeView(e.modelView),!0}return!1}removeView(e){if(this.modelViewSet.delete(e)){let t=this.modelViews;t.splice(t.indexOf(e),1)}}clear(){this.instances.length=0,this.instanceSet.clear(),this.modelViews.length=0,this.modelViewSet.clear()}detach(){return!!this.viewer&&this.viewer.removeScene(this)}update(){if(this.rendered){this.node.updateChildren(this),this.renderedInstances=0,this.renderedParticles=0,this.renderedBuckets=0,this.renderCalls=0;for(let e of this.modelViews)e.update(this),this.renderedInstances+=e.renderedInstances,this.renderedParticles+=e.renderedParticles,this.renderedBuckets+=e.renderedBuckets,this.renderCalls+=e.renderCalls;if(this.audioContext){let[e,t,i]=this.camera.location;this.audioContext.listener.setPosition(-e,-t,-i)}this.camera.update()}}isVisible(e){let t=e.model.bounds;if(t){let i=t.center,r=e.worldLocation;return Xr[0]=r[0]+i[0],Xr[1]=r[1]+i[1],Xr[2]=r[2]+i[2],this.camera.testSphere(Xr,t.radius)}{let t=this.camera.worldProjectionMatrix;return ar.vec3.transformMat4(Xr,e.worldLocation,t),Xr[0]>=-1&&Xr[0]<=1&&Xr[1]>=-1&&Xr[1]<=1&&Xr[2]>=-1&&Xr[2]<=1}}renderOpaque(){if(this.rendered){this.viewport();for(let e of this.modelViews)e.renderOpaque(this)}}renderTranslucent(){if(this.rendered){this.viewport();for(let e of this.modelViews)e.renderTranslucent(this)}}viewport(){let e=this.camera.rect;this.viewer.gl.viewport(e[0],e[1],e[2],e[3])}clearEmittedObjects(){for(let e of this.instances)e.clearEmittedObjects()}}class Qr extends lr.a{constructor(e){let{viewer:t,handler:i,extension:r,pathSolver:n,fetchUrl:s="",path:a}=e;super(),this.viewer=t,this.handler=i||null,this.extension=r||"",this.pathSolver=n||null,this.fetchUrl=s,this.ok=!1,this.loadend=!1,this.path=a,this.setMaxListeners(0)}loadData(e){const t=()=>{this.loadend=!0,this.ok=!0,this.lateLoad(),this.emit("load",this),this.emit("loadend",this)};try{let r=this.load(e);r instanceof Promise?r.then(t):t()}catch(i){this.error("InvalidData",i)}}load(e){}detach(){return this.viewer.unload(this)}lateLoad(){}error(e,t){this.loadend=!0,console.info("[ResLoad] Failed on ",this.path,this.fetchUrl),this.emit("loadend",this)}whenLoaded(){return new Promise((e,t)=>{if(this.loadend)e(this);else{const i=setTimeout(()=>{t(new Error("Load timeout"))},2e4);this.once("loadend",()=>{clearTimeout(i),e(this)})}})}ready(e){if(this.loadend)return e(this);this.once("loadend",()=>{e(this)})}}class $r extends Qr{constructor(e){super(e),this.width=0,this.height=0,this.wrapS=!1,this.wrapT=!1}setParameters(e,t,i,r){const n=this.viewer.gl;n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,e),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,t),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,i),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,r)}bind(e){let t=this.viewer,i=this.viewer.gl;t.webgl.bindTexture(this,e),this.wrapS?i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.REPEAT):i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),this.wrapT?i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.REPEAT):i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE)}}class Zr extends $r{load(e){if(e instanceof HTMLImageElement||e instanceof HTMLVideoElement||e instanceof HTMLCanvasElement||e instanceof ImageData){let t=this.viewer.gl;e instanceof ImageData||(e=function(e){let t=e.width,i=e.height;return ur.width=t,ur.height=i,mr.drawImage(e,0,0),mr.getImageData(0,0,t,i)}(e)),this.originalData=e,e=Er(e);let i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),this.setParameters(t.REPEAT,t.REPEAT,t.LINEAR,t.LINEAR_MIPMAP_LINEAR),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.generateMipmap(t.TEXTURE_2D),this.imageData=e,this.width=e.width,this.height=e.height,this.webglResource=i}else e instanceof WebGLTexture&&(this.webglResource=e)}}var en={extensions:[[".png","image"],[".jpg","image"],[".gif","image"]],Constructor:Zr};class tn extends Qr{constructor(e){super(e),this.data=null}load(e){this.data=e}}const rn=!1,nn=!0,sn=8192,an=["player.neutral","PLAYER_NEUTRAL_PASSIVE",15],on=["player.neutral","PLAYER_NEUTRAL_AGGRESSIVE",12],ln=["playercolor","PLAYER_COLOR_RED",0],hn=["playercolor","PLAYER_COLOR_BLUE",1],cn=["playercolor","PLAYER_COLOR_CYAN",2],dn=["playercolor","PLAYER_COLOR_PURPLE",3],un=["playercolor","PLAYER_COLOR_YELLOW",4],mn=["playercolor","PLAYER_COLOR_ORANGE",5],fn=["playercolor","PLAYER_COLOR_GREEN",6],pn=["playercolor","PLAYER_COLOR_PINK",7],En=["playercolor","PLAYER_COLOR_LIGHT_GRAY",8],gn=["playercolor","PLAYER_COLOR_LIGHT_BLUE",9],An=["playercolor","PLAYER_COLOR_AQUA",10],_n=["playercolor","PLAYER_COLOR_BROWN",11],Tn=["race","RACE_HUMAN",1],vn=["race","RACE_ORC",2],yn=["race","RACE_UNDEAD",3],wn=["race","RACE_NIGHTELF",4],Sn=["race","RACE_DEMON",5],Rn=["race","RACE_OTHER",7],bn=["playergameresult","PLAYER_GAME_RESULT_VICTORY",0],In=["playergameresult","PLAYER_GAME_RESULT_DEFEAT",1],Ln=["playergameresult","PLAYER_GAME_RESULT_TIE",2],Nn=["playergameresult","PLAYER_GAME_RESULT_NEUTRAL",3],xn=["alliancetype","ALLIANCE_PASSIVE",0],Pn=["alliancetype","ALLIANCE_HELP_REQUEST",1],Cn=["alliancetype","ALLIANCE_HELP_RESPONSE",2],Un=["alliancetype","ALLIANCE_SHARED_XP",3],On=["alliancetype","ALLIANCE_SHARED_SPELLS",4],Dn=["alliancetype","ALLIANCE_SHARED_VISION",5],Mn=["alliancetype","ALLIANCE_SHARED_CONTROL",6],Fn=["alliancetype","ALLIANCE_SHARED_ADVANCED_CONTROL",7],Bn=["alliancetype","ALLIANCE_RESCUABLE",8],Vn=["alliancetype","ALLIANCE_SHARED_VISION_FORCED",9],kn=["version","VERSION_REIGN_OF_CHAOS",0],Gn=["version","VERSION_FROZEN_THRONE",1],jn=["attacktype","ATTACK_TYPE_NORMAL",0],Yn=["attacktype","ATTACK_TYPE_MELEE",1],Hn=["attacktype","ATTACK_TYPE_PIERCE",2],Wn=["attacktype","ATTACK_TYPE_SIEGE",3],Kn=["attacktype","ATTACK_TYPE_MAGIC",4],zn=["attacktype","ATTACK_TYPE_CHAOS",5],qn=["attacktype","ATTACK_TYPE_HERO",6],Xn=["damagetype","DAMAGE_TYPE_UNKNOWN",0],Jn=["damagetype","DAMAGE_TYPE_NORMAL",4],Qn=["damagetype","DAMAGE_TYPE_ENHANCED",5],$n=["damagetype","DAMAGE_TYPE_FIRE",8],Zn=["damagetype","DAMAGE_TYPE_COLD",9],es=["damagetype","DAMAGE_TYPE_LIGHTNING",10],ts=["damagetype","DAMAGE_TYPE_POISON",11],is=["damagetype","DAMAGE_TYPE_DISEASE",12],rs=["damagetype","DAMAGE_TYPE_DIVINE",13],ns=["damagetype","DAMAGE_TYPE_MAGIC",14],ss=["damagetype","DAMAGE_TYPE_SONIC",15],as=["damagetype","DAMAGE_TYPE_ACID",16],os=["damagetype","DAMAGE_TYPE_FORCE",17],ls=["damagetype","DAMAGE_TYPE_DEATH",18],hs=["damagetype","DAMAGE_TYPE_MIND",19],cs=["damagetype","DAMAGE_TYPE_PLANT",20],ds=["damagetype","DAMAGE_TYPE_DEFENSIVE",21],us=["damagetype","DAMAGE_TYPE_DEMOLITION",22],ms=["damagetype","DAMAGE_TYPE_SLOW_POISON",23],fs=["damagetype","DAMAGE_TYPE_SPIRIT_LINK",24],ps=["damagetype","DAMAGE_TYPE_SHADOW_STRIKE",25],Es=["damagetype","DAMAGE_TYPE_UNIVERSAL",26],gs=["weapontype","WEAPON_TYPE_WHOKNOWS",0],As=["weapontype","WEAPON_TYPE_METAL_LIGHT_CHOP",1],_s=["weapontype","WEAPON_TYPE_METAL_MEDIUM_CHOP",2],Ts=["weapontype","WEAPON_TYPE_METAL_HEAVY_CHOP",3],vs=["weapontype","WEAPON_TYPE_METAL_LIGHT_SLICE",4],ys=["weapontype","WEAPON_TYPE_METAL_MEDIUM_SLICE",5],ws=["weapontype","WEAPON_TYPE_METAL_HEAVY_SLICE",6],Ss=["weapontype","WEAPON_TYPE_METAL_MEDIUM_BASH",7],Rs=["weapontype","WEAPON_TYPE_METAL_HEAVY_BASH",8],bs=["weapontype","WEAPON_TYPE_METAL_MEDIUM_STAB",9],Is=["weapontype","WEAPON_TYPE_METAL_HEAVY_STAB",10],Ls=["weapontype","WEAPON_TYPE_WOOD_LIGHT_SLICE",11],Ns=["weapontype","WEAPON_TYPE_WOOD_MEDIUM_SLICE",12],xs=["weapontype","WEAPON_TYPE_WOOD_HEAVY_SLICE",13],Ps=["weapontype","WEAPON_TYPE_WOOD_LIGHT_BASH",14],Cs=["weapontype","WEAPON_TYPE_WOOD_MEDIUM_BASH",15],Us=["weapontype","WEAPON_TYPE_WOOD_HEAVY_BASH",16],Os=["weapontype","WEAPON_TYPE_WOOD_LIGHT_STAB",17],Ds=["weapontype","WEAPON_TYPE_WOOD_MEDIUM_STAB",18],Ms=["weapontype","WEAPON_TYPE_CLAW_LIGHT_SLICE",19],Fs=["weapontype","WEAPON_TYPE_CLAW_MEDIUM_SLICE",20],Bs=["weapontype","WEAPON_TYPE_CLAW_HEAVY_SLICE",21],Vs=["weapontype","WEAPON_TYPE_AXE_MEDIUM_CHOP",22],ks=["weapontype","WEAPON_TYPE_ROCK_HEAVY_BASH",23],Gs=["pathingtype","PATHING_TYPE_ANY",0],js=["pathingtype","PATHING_TYPE_WALKABILITY",1],Ys=["pathingtype","PATHING_TYPE_FLYABILITY",2],Hs=["pathingtype","PATHING_TYPE_BUILDABILITY",3],Ws=["pathingtype","PATHING_TYPE_PEONHARVESTPATHING",4],Ks=["pathingtype","PATHING_TYPE_BLIGHTPATHING",5],zs=["pathingtype","PATHING_TYPE_FLOATABILITY",6],qs=["pathingtype","PATHING_TYPE_AMPHIBIOUSPATHING",7],Xs=["mousebuttontype","MOUSE_BUTTON_TYPE_LEFT",1],Js=["mousebuttontype","MOUSE_BUTTON_TYPE_MIDDLE",2],Qs=["mousebuttontype","MOUSE_BUTTON_TYPE_RIGHT",3],$s=["racepreference","RACE_PREF_HUMAN",1],Zs=["racepreference","RACE_PREF_ORC",2],ea=["racepreference","RACE_PREF_NIGHTELF",4],ta=["racepreference","RACE_PREF_UNDEAD",8],ia=["racepreference","RACE_PREF_DEMON",16],ra=["racepreference","RACE_PREF_RANDOM",32],na=["racepreference","RACE_PREF_USER_SELECTABLE",64],sa=["mapcontrol","MAP_CONTROL_USER",0],aa=["mapcontrol","MAP_CONTROL_COMPUTER",1],oa=["mapcontrol","MAP_CONTROL_RESCUABLE",2],la=["mapcontrol","MAP_CONTROL_NEUTRAL",3],ha=["mapcontrol","MAP_CONTROL_CREEP",4],ca=["mapcontrol","MAP_CONTROL_NONE",5],da=["gametype","GAME_TYPE_MELEE",1],ua=["gametype","GAME_TYPE_FFA",2],ma=["gametype","GAME_TYPE_USE_MAP_SETTINGS",4],fa=["gametype","GAME_TYPE_BLIZ",8],pa=["gametype","GAME_TYPE_ONE_ON_ONE",16],Ea=["gametype","GAME_TYPE_TWO_TEAM_PLAY",32],ga=["gametype","GAME_TYPE_THREE_TEAM_PLAY",64],Aa=["gametype","GAME_TYPE_FOUR_TEAM_PLAY",128],_a=["mapflag","MAP_FOG_HIDE_TERRAIN",1],Ta=["mapflag","MAP_FOG_MAP_EXPLORED",2],va=["mapflag","MAP_FOG_ALWAYS_VISIBLE",4],ya=["mapflag","MAP_USE_HANDICAPS",8],wa=["mapflag","MAP_OBSERVERS",16],Sa=["mapflag","MAP_OBSERVERS_ON_DEATH",32],Ra=["mapflag","MAP_FIXED_COLORS",128],ba=["mapflag","MAP_LOCK_RESOURCE_TRADING",256],Ia=["mapflag","MAP_RESOURCE_TRADING_ALLIES_ONLY",512],La=["mapflag","MAP_LOCK_ALLIANCE_CHANGES",1024],Na=["mapflag","MAP_ALLIANCE_CHANGES_HIDDEN",2048],xa=["mapflag","MAP_CHEATS",4096],Pa=["mapflag","MAP_CHEATS_HIDDEN",8192],Ca=["mapflag","MAP_LOCK_SPEED",16384],Ua=["mapflag","MAP_LOCK_RANDOM_SEED",32768],Oa=["mapflag","MAP_SHARED_ADVANCED_CONTROL",65536],Da=["mapflag","MAP_RANDOM_HERO",131072],Ma=["mapflag","MAP_RANDOM_RACES",262144],Fa=["mapflag","MAP_RELOADED",524288],Ba=["placement","MAP_PLACEMENT_RANDOM",0],Va=["placement","MAP_PLACEMENT_FIXED",1],ka=["placement","MAP_PLACEMENT_USE_MAP_SETTINGS",2],Ga=["placement","MAP_PLACEMENT_TEAMS_TOGETHER",3],ja=["startlocprio","MAP_LOC_PRIO_LOW",0],Ya=["startlocprio","MAP_LOC_PRIO_HIGH",1],Ha=["startlocprio","MAP_LOC_PRIO_NOT",2],Wa=["mapdensity","MAP_DENSITY_NONE",0],Ka=["mapdensity","MAP_DENSITY_LIGHT",1],za=["mapdensity","MAP_DENSITY_MEDIUM",2],qa=["mapdensity","MAP_DENSITY_HEAVY",3],Xa=["gamedifficulty","MAP_DIFFICULTY_EASY",0],Ja=["gamedifficulty","MAP_DIFFICULTY_NORMAL",1],Qa=["gamedifficulty","MAP_DIFFICULTY_HARD",2],$a=["gamedifficulty","MAP_DIFFICULTY_INSANE",3],Za=["gamespeed","MAP_SPEED_SLOWEST",0],eo=["gamespeed","MAP_SPEED_SLOW",1],to=["gamespeed","MAP_SPEED_NORMAL",2],io=["gamespeed","MAP_SPEED_FAST",3],ro=["gamespeed","MAP_SPEED_FASTEST",4],no=["playerslotstate","PLAYER_SLOT_STATE_EMPTY",0],so=["playerslotstate","PLAYER_SLOT_STATE_PLAYING",1],ao=["playerslotstate","PLAYER_SLOT_STATE_LEFT",2],oo=["volumegroup","SOUND_VOLUMEGROUP_UNITMOVEMENT",0],lo=["volumegroup","SOUND_VOLUMEGROUP_UNITSOUNDS",1],ho=["volumegroup","SOUND_VOLUMEGROUP_COMBAT",2],co=["volumegroup","SOUND_VOLUMEGROUP_SPELLS",3],uo=["volumegroup","SOUND_VOLUMEGROUP_UI",4],mo=["volumegroup","SOUND_VOLUMEGROUP_MUSIC",5],fo=["volumegroup","SOUND_VOLUMEGROUP_AMBIENTSOUNDS",6],po=["volumegroup","SOUND_VOLUMEGROUP_FIRE",7],Eo=["igamestate","GAME_STATE_DIVINE_INTERVENTION",0],go=["igamestate","GAME_STATE_DISCONNECTED",1],Ao=["fgamestate","GAME_STATE_TIME_OF_DAY",2],_o=["playerstate","PLAYER_STATE_GAME_RESULT",0],To=["playerstate","PLAYER_STATE_RESOURCE_GOLD",1],vo=["playerstate","PLAYER_STATE_RESOURCE_LUMBER",2],yo=["playerstate","PLAYER_STATE_RESOURCE_HERO_TOKENS",3],wo=["playerstate","PLAYER_STATE_RESOURCE_FOOD_CAP",4],So=["playerstate","PLAYER_STATE_RESOURCE_FOOD_USED",5],Ro=["playerstate","PLAYER_STATE_FOOD_CAP_CEILING",6],bo=["playerstate","PLAYER_STATE_GIVES_BOUNTY",7],Io=["playerstate","PLAYER_STATE_ALLIED_VICTORY",8],Lo=["playerstate","PLAYER_STATE_PLACED",9],No=["playerstate","PLAYER_STATE_OBSERVER_ON_DEATH",10],xo=["playerstate","PLAYER_STATE_OBSERVER",11],Po=["playerstate","PLAYER_STATE_UNFOLLOWABLE",12],Co=["playerstate","PLAYER_STATE_GOLD_UPKEEP_RATE",13],Uo=["playerstate","PLAYER_STATE_LUMBER_UPKEEP_RATE",14],Oo=["playerstate","PLAYER_STATE_GOLD_GATHERED",15],Do=["playerstate","PLAYER_STATE_LUMBER_GATHERED",16],Mo=["playerstate","PLAYER_STATE_NO_CREEP_SLEEP",25],Fo=["unitstate","UNIT_STATE_LIFE",0],Bo=["unitstate","UNIT_STATE_MAX_LIFE",1],Vo=["unitstate","UNIT_STATE_MANA",2],ko=["unitstate","UNIT_STATE_MAX_MANA",3],Go=["aidifficulty","AI_DIFFICULTY_NEWBIE",0],jo=["aidifficulty","AI_DIFFICULTY_NORMAL",1],Yo=["aidifficulty","AI_DIFFICULTY_INSANE",2],Ho=["playerscore","PLAYER_SCORE_UNITS_TRAINED",0],Wo=["playerscore","PLAYER_SCORE_UNITS_KILLED",1],Ko=["playerscore","PLAYER_SCORE_STRUCT_BUILT",2],zo=["playerscore","PLAYER_SCORE_STRUCT_RAZED",3],qo=["playerscore","PLAYER_SCORE_TECH_PERCENT",4],Xo=["playerscore","PLAYER_SCORE_FOOD_MAXPROD",5],Jo=["playerscore","PLAYER_SCORE_FOOD_MAXUSED",6],Qo=["playerscore","PLAYER_SCORE_HEROES_KILLED",7],$o=["playerscore","PLAYER_SCORE_ITEMS_GAINED",8],Zo=["playerscore","PLAYER_SCORE_MERCS_HIRED",9],el=["playerscore","PLAYER_SCORE_GOLD_MINED_TOTAL",10],tl=["playerscore","PLAYER_SCORE_GOLD_MINED_UPKEEP",11],il=["playerscore","PLAYER_SCORE_GOLD_LOST_UPKEEP",12],rl=["playerscore","PLAYER_SCORE_GOLD_LOST_TAX",13],nl=["playerscore","PLAYER_SCORE_GOLD_GIVEN",14],sl=["playerscore","PLAYER_SCORE_GOLD_RECEIVED",15],al=["playerscore","PLAYER_SCORE_LUMBER_TOTAL",16],ol=["playerscore","PLAYER_SCORE_LUMBER_LOST_UPKEEP",17],ll=["playerscore","PLAYER_SCORE_LUMBER_LOST_TAX",18],hl=["playerscore","PLAYER_SCORE_LUMBER_GIVEN",19],cl=["playerscore","PLAYER_SCORE_LUMBER_RECEIVED",20],dl=["playerscore","PLAYER_SCORE_UNIT_TOTAL",21],ul=["playerscore","PLAYER_SCORE_HERO_TOTAL",22],ml=["playerscore","PLAYER_SCORE_RESOURCE_TOTAL",23],fl=["playerscore","PLAYER_SCORE_TOTAL",24],pl=["gameevent","EVENT_GAME_VICTORY",0],El=["gameevent","EVENT_GAME_END_LEVEL",1],gl=["gameevent","EVENT_GAME_VARIABLE_LIMIT",2],Al=["gameevent","EVENT_GAME_STATE_LIMIT",3],_l=["gameevent","EVENT_GAME_TIMER_EXPIRED",4],Tl=["gameevent","EVENT_GAME_ENTER_REGION",5],vl=["gameevent","EVENT_GAME_LEAVE_REGION",6],yl=["gameevent","EVENT_GAME_TRACKABLE_HIT",7],wl=["gameevent","EVENT_GAME_TRACKABLE_TRACK",8],Sl=["gameevent","EVENT_GAME_SHOW_SKILL",9],Rl=["gameevent","EVENT_GAME_BUILD_SUBMENU",10],bl=["playerevent","EVENT_PLAYER_STATE_LIMIT",11],Il=["playerevent","EVENT_PLAYER_ALLIANCE_CHANGED",12],Ll=["playerevent","EVENT_PLAYER_DEFEAT",13],Nl=["playerevent","EVENT_PLAYER_VICTORY",14],xl=["playerevent","EVENT_PLAYER_LEAVE",15],Pl=["playerevent","EVENT_PLAYER_CHAT",16],Cl=["playerevent","EVENT_PLAYER_END_CINEMATIC",17],Ul=["playerunitevent","EVENT_PLAYER_UNIT_ATTACKED",18],Ol=["playerunitevent","EVENT_PLAYER_UNIT_RESCUED",19],Dl=["playerunitevent","EVENT_PLAYER_UNIT_DEATH",20],Ml=["playerunitevent","EVENT_PLAYER_UNIT_DECAY",21],Fl=["playerunitevent","EVENT_PLAYER_UNIT_DETECTED",22],Bl=["playerunitevent","EVENT_PLAYER_UNIT_HIDDEN",23],Vl=["playerunitevent","EVENT_PLAYER_UNIT_SELECTED",24],kl=["playerunitevent","EVENT_PLAYER_UNIT_DESELECTED",25],Gl=["playerunitevent","EVENT_PLAYER_UNIT_CONSTRUCT_START",26],jl=["playerunitevent","EVENT_PLAYER_UNIT_CONSTRUCT_CANCEL",27],Yl=["playerunitevent","EVENT_PLAYER_UNIT_CONSTRUCT_FINISH",28],Hl=["playerunitevent","EVENT_PLAYER_UNIT_UPGRADE_START",29],Wl=["playerunitevent","EVENT_PLAYER_UNIT_UPGRADE_CANCEL",30],Kl=["playerunitevent","EVENT_PLAYER_UNIT_UPGRADE_FINISH",31],zl=["playerunitevent","EVENT_PLAYER_UNIT_TRAIN_START",32],ql=["playerunitevent","EVENT_PLAYER_UNIT_TRAIN_CANCEL",33],Xl=["playerunitevent","EVENT_PLAYER_UNIT_TRAIN_FINISH",34],Jl=["playerunitevent","EVENT_PLAYER_UNIT_RESEARCH_START",35],Ql=["playerunitevent","EVENT_PLAYER_UNIT_RESEARCH_CANCEL",36],$l=["playerunitevent","EVENT_PLAYER_UNIT_RESEARCH_FINISH",37],Zl=["playerunitevent","EVENT_PLAYER_UNIT_ISSUED_ORDER",38],eh=["playerunitevent","EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER",39],th=["playerunitevent","EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER",40],ih=["playerunitevent","EVENT_PLAYER_UNIT_ISSUED_UNIT_ORDER",40],rh=["playerunitevent","EVENT_PLAYER_HERO_LEVEL",41],nh=["playerunitevent","EVENT_PLAYER_HERO_SKILL",42],sh=["playerunitevent","EVENT_PLAYER_HERO_REVIVABLE",43],ah=["playerunitevent","EVENT_PLAYER_HERO_REVIVE_START",44],oh=["playerunitevent","EVENT_PLAYER_HERO_REVIVE_CANCEL",45],lh=["playerunitevent","EVENT_PLAYER_HERO_REVIVE_FINISH",46],hh=["playerunitevent","EVENT_PLAYER_UNIT_SUMMON",47],ch=["playerunitevent","EVENT_PLAYER_UNIT_DROP_ITEM",48],dh=["playerunitevent","EVENT_PLAYER_UNIT_PICKUP_ITEM",49],uh=["playerunitevent","EVENT_PLAYER_UNIT_USE_ITEM",50],mh=["playerunitevent","EVENT_PLAYER_UNIT_LOADED",51],fh=["unitevent","EVENT_UNIT_DAMAGED",52],ph=["unitevent","EVENT_UNIT_DEATH",53],Eh=["unitevent","EVENT_UNIT_DECAY",54],gh=["unitevent","EVENT_UNIT_DETECTED",55],Ah=["unitevent","EVENT_UNIT_HIDDEN",56],_h=["unitevent","EVENT_UNIT_SELECTED",57],Th=["unitevent","EVENT_UNIT_DESELECTED",58],vh=["unitevent","EVENT_UNIT_STATE_LIMIT",59],yh=["unitevent","EVENT_UNIT_ACQUIRED_TARGET",60],wh=["unitevent","EVENT_UNIT_TARGET_IN_RANGE",61],Sh=["unitevent","EVENT_UNIT_ATTACKED",62],Rh=["unitevent","EVENT_UNIT_RESCUED",63],bh=["unitevent","EVENT_UNIT_CONSTRUCT_CANCEL",64],Ih=["unitevent","EVENT_UNIT_CONSTRUCT_FINISH",65],Lh=["unitevent","EVENT_UNIT_UPGRADE_START",66],Nh=["unitevent","EVENT_UNIT_UPGRADE_CANCEL",67],xh=["unitevent","EVENT_UNIT_UPGRADE_FINISH",68],Ph=["unitevent","EVENT_UNIT_TRAIN_START",69],Ch=["unitevent","EVENT_UNIT_TRAIN_CANCEL",70],Uh=["unitevent","EVENT_UNIT_TRAIN_FINISH",71],Oh=["unitevent","EVENT_UNIT_RESEARCH_START",72],Dh=["unitevent","EVENT_UNIT_RESEARCH_CANCEL",73],Mh=["unitevent","EVENT_UNIT_RESEARCH_FINISH",74],Fh=["unitevent","EVENT_UNIT_ISSUED_ORDER",75],Bh=["unitevent","EVENT_UNIT_ISSUED_POINT_ORDER",76],Vh=["unitevent","EVENT_UNIT_ISSUED_TARGET_ORDER",77],kh=["unitevent","EVENT_UNIT_HERO_LEVEL",78],Gh=["unitevent","EVENT_UNIT_HERO_SKILL",79],jh=["unitevent","EVENT_UNIT_HERO_REVIVABLE",80],Yh=["unitevent","EVENT_UNIT_HERO_REVIVE_START",81],Hh=["unitevent","EVENT_UNIT_HERO_REVIVE_CANCEL",82],Wh=["unitevent","EVENT_UNIT_HERO_REVIVE_FINISH",83],Kh=["unitevent","EVENT_UNIT_SUMMON",84],zh=["unitevent","EVENT_UNIT_DROP_ITEM",85],qh=["unitevent","EVENT_UNIT_PICKUP_ITEM",86],Xh=["unitevent","EVENT_UNIT_USE_ITEM",87],Jh=["unitevent","EVENT_UNIT_LOADED",88],Qh=["widgetevent","EVENT_WIDGET_DEATH",89],$h=["dialogevent","EVENT_DIALOG_BUTTON_CLICK",90],Zh=["dialogevent","EVENT_DIALOG_CLICK",91],ec=["gameevent","EVENT_GAME_LOADED",256],tc=["gameevent","EVENT_GAME_TOURNAMENT_FINISH_SOON",257],ic=["gameevent","EVENT_GAME_TOURNAMENT_FINISH_NOW",258],rc=["gameevent","EVENT_GAME_SAVE",259],nc=["playerevent","EVENT_PLAYER_ARROW_LEFT_DOWN",261],sc=["playerevent","EVENT_PLAYER_ARROW_LEFT_UP",262],ac=["playerevent","EVENT_PLAYER_ARROW_RIGHT_DOWN",263],oc=["playerevent","EVENT_PLAYER_ARROW_RIGHT_UP",264],lc=["playerevent","EVENT_PLAYER_ARROW_DOWN_DOWN",265],hc=["playerevent","EVENT_PLAYER_ARROW_DOWN_UP",266],cc=["playerevent","EVENT_PLAYER_ARROW_UP_DOWN",267],dc=["playerevent","EVENT_PLAYER_ARROW_UP_UP",268],uc=["playerunitevent","EVENT_PLAYER_UNIT_SELL",269],mc=["playerunitevent","EVENT_PLAYER_UNIT_CHANGE_OWNER",270],fc=["playerunitevent","EVENT_PLAYER_UNIT_SELL_ITEM",271],pc=["playerunitevent","EVENT_PLAYER_UNIT_SPELL_CHANNEL",272],Ec=["playerunitevent","EVENT_PLAYER_UNIT_SPELL_CAST",273],gc=["playerunitevent","EVENT_PLAYER_UNIT_SPELL_EFFECT",274],Ac=["playerunitevent","EVENT_PLAYER_UNIT_SPELL_FINISH",275],_c=["playerunitevent","EVENT_PLAYER_UNIT_SPELL_ENDCAST",276],Tc=["playerunitevent","EVENT_PLAYER_UNIT_PAWN_ITEM",277],vc=["unitevent","EVENT_UNIT_SELL",286],yc=["unitevent","EVENT_UNIT_CHANGE_OWNER",287],wc=["unitevent","EVENT_UNIT_SELL_ITEM",288],Sc=["unitevent","EVENT_UNIT_SPELL_CHANNEL",289],Rc=["unitevent","EVENT_UNIT_SPELL_CAST",290],bc=["unitevent","EVENT_UNIT_SPELL_EFFECT",291],Ic=["unitevent","EVENT_UNIT_SPELL_FINISH",292],Lc=["unitevent","EVENT_UNIT_SPELL_ENDCAST",293],Nc=["unitevent","EVENT_UNIT_PAWN_ITEM",294],xc=["limitop","LESS_THAN",0],Pc=["limitop","LESS_THAN_OR_EQUAL",1],Cc=["limitop","EQUAL",2],Uc=["limitop","GREATER_THAN_OR_EQUAL",3],Oc=["limitop","GREATER_THAN",4],Dc=["limitop","NOT_EQUAL",5],Mc=["unittype","UNIT_TYPE_HERO",0],Fc=["unittype","UNIT_TYPE_DEAD",1],Bc=["unittype","UNIT_TYPE_STRUCTURE",2],Vc=["unittype","UNIT_TYPE_FLYING",3],kc=["unittype","UNIT_TYPE_GROUND",4],Gc=["unittype","UNIT_TYPE_ATTACKS_FLYING",5],jc=["unittype","UNIT_TYPE_ATTACKS_GROUND",6],Yc=["unittype","UNIT_TYPE_MELEE_ATTACKER",7],Hc=["unittype","UNIT_TYPE_RANGED_ATTACKER",8],Wc=["unittype","UNIT_TYPE_GIANT",9],Kc=["unittype","UNIT_TYPE_SUMMONED",10],zc=["unittype","UNIT_TYPE_STUNNED",11],qc=["unittype","UNIT_TYPE_PLAGUED",12],Xc=["unittype","UNIT_TYPE_SNARED",13],Jc=["unittype","UNIT_TYPE_UNDEAD",14],Qc=["unittype","UNIT_TYPE_MECHANICAL",15],$c=["unittype","UNIT_TYPE_PEON",16],Zc=["unittype","UNIT_TYPE_SAPPER",17],ed=["unittype","UNIT_TYPE_TOWNHALL",18],td=["unittype","UNIT_TYPE_ANCIENT",19],id=["unittype","UNIT_TYPE_TAUREN",20],rd=["unittype","UNIT_TYPE_POISONED",21],nd=["unittype","UNIT_TYPE_POLYMORPHED",22],sd=["unittype","UNIT_TYPE_SLEEPING",23],ad=["unittype","UNIT_TYPE_RESISTANT",24],od=["unittype","UNIT_TYPE_ETHEREAL",25],ld=["unittype","UNIT_TYPE_MAGIC_IMMUNE",26],hd=["itemtype","ITEM_TYPE_PERMANENT",0],cd=["itemtype","ITEM_TYPE_CHARGED",1],dd=["itemtype","ITEM_TYPE_POWERUP",2],ud=["itemtype","ITEM_TYPE_ARTIFACT",3],md=["itemtype","ITEM_TYPE_PURCHASABLE",4],fd=["itemtype","ITEM_TYPE_CAMPAIGN",5],pd=["itemtype","ITEM_TYPE_MISCELLANEOUS",6],Ed=["itemtype","ITEM_TYPE_UNKNOWN",7],gd=["itemtype","ITEM_TYPE_ANY",8],Ad=["itemtype","ITEM_TYPE_TOME",2],_d=["camerafield","CAMERA_FIELD_TARGET_DISTANCE",0],Td=["camerafield","CAMERA_FIELD_FARZ",1],vd=["camerafield","CAMERA_FIELD_ANGLE_OF_ATTACK",2],yd=["camerafield","CAMERA_FIELD_FIELD_OF_VIEW",3],wd=["camerafield","CAMERA_FIELD_ROLL",4],Sd=["camerafield","CAMERA_FIELD_ROTATION",5],Rd=["camerafield","CAMERA_FIELD_ZOFFSET",6],bd=["blendmode","BLEND_MODE_NONE",0],Id=["blendmode","BLEND_MODE_DONT_CARE",0],Ld=["blendmode","BLEND_MODE_KEYALPHA",1],Nd=["blendmode","BLEND_MODE_BLEND",2],xd=["blendmode","BLEND_MODE_ADDITIVE",3],Pd=["blendmode","BLEND_MODE_MODULATE",4],Cd=["blendmode","BLEND_MODE_MODULATE_2X",5],Ud=["raritycontrol","RARITY_FREQUENT",0],Od=["raritycontrol","RARITY_RARE",1],Dd=["texmapflags","TEXMAP_FLAG_NONE",0],Md=["texmapflags","TEXMAP_FLAG_WRAP_U",1],Fd=["texmapflags","TEXMAP_FLAG_WRAP_V",2],Bd=["texmapflags","TEXMAP_FLAG_WRAP_UV",3],Vd=["fogstate","FOG_OF_WAR_MASKED",1],kd=["fogstate","FOG_OF_WAR_FOGGED",2],Gd=["fogstate","FOG_OF_WAR_VISIBLE",4],jd=["camera.margin","CAMERA_MARGIN_LEFT",0],Yd=["camera.margin","CAMERA_MARGIN_RIGHT",1],Hd=["camera.margin","CAMERA_MARGIN_TOP",2],Wd=["camera.margin","CAMERA_MARGIN_BOTTOM",3],Kd=["effecttype","EFFECT_TYPE_EFFECT",0],zd=["effecttype","EFFECT_TYPE_TARGET",1],qd=["effecttype","EFFECT_TYPE_CASTER",2],Xd=["effecttype","EFFECT_TYPE_SPECIAL",3],Jd=["effecttype","EFFECT_TYPE_AREA_EFFECT",4],Qd=["effecttype","EFFECT_TYPE_MISSILE",5],$d=["effecttype","EFFECT_TYPE_LIGHTNING",6],Zd=["soundtype","SOUND_TYPE_EFFECT",0],eu=["soundtype","SOUND_TYPE_EFFECT_LOOPED",1],tu=["playercolor","race","playergameresult","alliancetype","version","attacktype","damagetype","weapontype","pathingtype","racepreference","racepref","mapcontrol","gametype","mapflag","placement","startlocprio","mapdensity","gamedifficulty","gamespeed","playerslotstate","volumegroup","igamestate","fgamestate","playerstate","unitstate","aidifficulty","playerscore","gameevent","playerevent","playerunitevent","unitevent","widgetevent","dialogevent","limitop","unittype","itemtype","camerafield","blendmode","raritycontrol","texmapflags","fogstate","effecttype","soundtype","mousebuttontype"];const iu=new class{get(e,t,i){return Reflect.get(e,t,i)}set(e,t,i,r){return void 0===e[t]&&this.allowSetProp&&(console.log("AccessProxiedMember","DEFINE",e.constructor.name,t),Object.defineProperty(e,t,{value:i,writable:!0,enumerable:!0})),Reflect.set(e,t,i,r)}},ru=function(e){return new Proxy(new e,iu)};class nu{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e=>e;this.d=[],this.d=new Array(e),this.transform=t}fill(e){this.d.fill(this.transform(new e))}getAt(e,t){if(e instanceof Array){let i=e[2];void 0==this.d[i]&&(this.d[i]=this.transform(t(i)));let r=this.d[i];return r[e[0]]=e[1],r}return void 0==this.d[e]&&(this.d[e]=this.transform(t(e))),this.d[e]}get(e){if(e instanceof Array){let t=e[2],i=this.d[t];return i[e[0]]=e[1],i}return this.d[e]}put(e,t){return this.d[e]=this.transform(t),t}remove(e){let t=this.d.indexOf(e);-1!=t?this.d.splice(t,1):console.log("E:removing none exist item",e)}add(e){this.d.push(this.transform(e))}contains(e){return this.d.includes(e)}has(e){return this.d.includes(e)}set(e,t){this.d[e]=this.transform(t)}clear(){this.d.length=0}forEach(e){this.d.forEach((t,i)=>e(t,i,this.d))}filter(e){return this.d.filter((t,i)=>e(t,i,this.d))}replace(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];this.d=this.transform(e)}any(e){for(let t=0;t<this.d.length;t++){if(e(this.d[t],t,this.d))return!0}return!1}size(){return this.d.length}}class su{constructor(){this.handle=0,this.periodic=!1,this.timeout=-1,this.timerExpire=!1,this.triggers=new nu,this.callT=0,this.beginT=0,this.resumeDelay=0}start(e,t,i){if(this.handle&&this.periodic)throw new Error("Timer already started");this.callT=performance.now(),this.beginT=performance.now(),this.periodic=t,this.timeout=1e3*e,this.handlerFunc=i,console.log("timer start:",this),this.handle=setTimeout(()=>this.handler(),this.timeout)}async handler(){if(this.callT=performance.now(),this.handlerFunc){var e;console.log("timer callback:",this.handlerFunc);let t=null===(e=this.handlerFunc)||void 0===e?void 0:e.call(null);t instanceof Promise&&await t}this.triggers.forEach(e=>e.execute()),this.periodic&&(this.handle=setTimeout(()=>this.handler(),this.timeout))}listenExpire(e){this.triggers.add(e)}destroy(){console.log("timer destroy:",this),this.periodic?clearInterval(this.handle):clearTimeout(this.handle),this.handle=0}getElapsed(){return performance.now()-this.callT}pause(){clearTimeout(this.handle),this.handle=0;let e=performance.now()-this.callT,t=this.timeout-e;this.resumeDelay=t}resume(){this.handle=setTimeout(this.handler,this.resumeDelay)}}const au=new nu,ou=(e,t,i)=>{let r=new su(e,t,i.execute);return au.add(r),r};class lu{}class hu{constructor(){this.players=new nu}}class cu{constructor(e){this.timer=e}evaluate(e){return this.timer.timerExpire}}let du=e=>{};class uu{constructor(){this.gameStateEvents=new nu,this.gameEvents=new nu,this.unitEvents=new nu,this.playerUnitEvents=new nu,this.timerExpireEvents=new nu,this.VariableEvents=new nu,this.actions=new nu}evaluate(e){return 0==this.gameStateEvents.size()+this.unitEvents.size()+this.playerUnitEvents.size()+this.timerExpireEvents.size()+this.gameEvents.size()||(this.gameStateEvents.any(t=>t.evaluate(e))||this.unitEvents.any(t=>t.evaluate(e))||this.playerUnitEvents.any(t=>t.evaluate(e))||this.playerUnitEvents.any(t=>t.evaluate(e)))}execute(){console.log("trigger execute actions",this.actions),this.actions.forEach(e=>e())}}class mu{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1;this.index=-1,this.color=-1,this.slotState=no,this.TechResearched=new nu,this.TechMaxAllowed=new Map,this.AlliancePlayers=new nu,this.Structures=new nu,this.TypedUnits=new nu,this.Units=new nu,this.index=e}}class fu{constructor(e,t,i){this.whichUnit=t,this.whichUnitEvent=i,this.whichTrigger=e}evaluate(e){return!1}}class pu{constructor(e,t,i,r){this.whichPlayer=t,this.whichPlayerUnitEvent=i,this.filter=r,this.whichTrigger=e}evaluate(e){return!1}}class Eu{constructor(e,t,i){this.whichState=e,this.opcode=t,this.limitval=i}evaluate(e){return!1}}class gu{constructor(e){this.listeners=new nu,this.watchTarget=e}set(e,t,i,r){if(e[t]&&e[t]!=i){Reflect.set(e,t,i,r),this.listeners.filter(e=>e.whichPropName==t).forEach(e=>e.filter({prop:t,value:i})&&e.execute())}return!0}get(e,t,i){return"eventListeners"==t?this.listeners:Reflect.get(e,t,i)}}const Au=e=>new Proxy(e,new gu(e)),_u=(e,t,i,r)=>{e&&e.eventListeners||console.error("invalid listenTarget",e),e.eventListeners.add({filter:r||(()=>!0),execute:i.execute,whichPropName:t})};class Tu{constructor(e){this.players=new nu(24,Au),this.startLocations=new nu(24),this.gameState=Au({compute(e,t){return void 0===this[e]&&(this[e]=t),this[e]},set(e,t){return this[e]=t},getNumber(e){return this[e]||0}}),this.logCalls=new nu,this.GameTypeSupported={},this.GameTypeSelected=pa,this.GamePlacement=0,this.GameSpeed=0,this.GameDifficulty=0,this.ResourceDensity=0,this.CreatureDensity=0,this.NbShops=new nu,this.fogMaskEnabled=!1,this.fogMaskEnabled=!1,this.midiSound={},this.app=e,this.triggerData=e.triggerData,this.gameState.startLocations=new nu(10),du=(e=>{this.logCalls.add(e.name)}),this.gameUI={frameDefs:new nu,loadedFdfs:new nu}}DefineStartLocation(e,t,i){e.startLoc=[t,i]}DefineStartLocationLoc(e,t){e.startLoc=t}SetStartLocPrioCount(e,t){return this.startLocations.get(e).priority=new Array(t)}SetStartLocPrio(e,t,i,r){this.startLocations.get(e).priority[t]={otherStartLocIndex:i,priority:r}}GetStartLocPrioSlot(e,t){return this.startLocations.get(e).priority[t]}GetStartLocPrio(e,t){return e.priority[t]}SetGameTypeSupported(e,t){this.GameTypeSupported[e[1]]=t}SetMapFlag(e,t){console.log("[------decl-only------]","SetMapFlag",arguments)}SetGamePlacement(e){this.GamePlacement=e}SetGameSpeed(e){this.GameSpeed=e}SetGameDifficulty(e){this.GameDifficulty=e}GetTeams(){console.log("[------decl-only------]","GetTeams",arguments)}GetPlayers(){console.log("[------decl-only------]","GetPlayers",arguments)}IsGameTypeSupported(e){console.log("[------decl-only------]","IsGameTypeSupported",arguments)}GetGameTypeSelected(){return this.GameTypeSelected}IsMapFlagSet(e){console.log("[------decl-only------]","IsMapFlagSet",arguments)}GetGamePlacement(){return this.GamePlacement}GetGameSpeed(){return this.GameSpeed}GetGameDifficulty(){return this.GameDifficulty}GetResourceDensity(){return this.ResourceDensity}GetCreatureDensity(){return this.CreatureDensity}GetStartLocationX(e){return this.startLocations.get(e)[0]}GetStartLocationY(e){return this.startLocations.get(e)[1]}GetStartLocationLoc(e){return this.startLocations.get(e)}SetPlayerTeam(e,t){e.team=e}SetPlayerStartLocation(e,t){let i=this.startLocations.get(t);e.startLoc=i}ForcePlayerStartLocation(e,t){let i=this.startLocations.get(t);e.startLoc=i}SetPlayerColor(e,t){e.color=t}SetPlayerAlliance(e,t,i,r){(e[i[1]]||(e[i[1]]=[]))[t.index]=r}SetPlayerTaxRate(e,t,i,r){console.log("[------decl-only------]","SetPlayerTaxRate",arguments)}SetPlayerController(e,t){e.contoller=t}SetPlayerName(e,t){e.name=t}GetPlayerTeam(e){return e.team}GetPlayerStartLocation(e){return e.startLoc}GetPlayerColor(e){return e.color}GetPlayerSelectable(e){return e.Selectable||!1}GetPlayerController(e){return e.contoller}GetPlayerSlotState(e){return e.slotState}DestroyTimer(e){e.destroy()}TimerStart(e,t,i,r){e.start(t,i,r)}TimerGetElapsed(e){return e.getElapsed()}TimerGetTimeout(e){return e.timeout}PauseTimer(e){e.pause()}ResumeTimer(e){e.resume()}CreateForce(){return ru(hu)}DestroyForce(e){}ForceAddPlayer(e,t){e.players.add(t)}ForceRemovePlayer(e,t){e.players.remove(t)}ForceClear(e){e.players.clear()}ForceEnumPlayers(e,t){null==t?e.players.replace(this.players.d):e.players.replace(this.players.filter(e=>t.func()))}ForceEnumPlayersCounted(e,t,i){let r=this.players.filter(t.func);r.length>i&&(r.length=i),e.players.replace(r)}ForceEnumAllies(e,t,i){let r=t.AlliancePlayers.filter(e=>i.func());e.AlliancePlayers.replace(r)}ForceEnumEnemies(e,t,i){}ForForce(e,t){e.players.forEach(e=>t(e))}Rect(e,t,i,r){return{minx:e,miny:t,maxx:i,maxy:r}}CreateTrigger(){return new uu}DestroyTrigger(e){e.distroy()}ResetTrigger(e){e.reset()}EnableTrigger(e){e.enabled=!0}DisableTrigger(e){e.enabled=!1}IsTriggerEnabled(e){return e.enabled}GetFilterUnit(){return this.FilterUnitIterator.current}GetEnumUnit(){return this.EnumUnitIterator.current}GetFilterItem(){return this.FilterItemIterator.current}GetEnumItem(){return this.EnumItemIterator.current}GetFilterPlayer(){return this.FilterPlayerIterator.current}GetEnumPlayer(){return this.EnumPlayerIterator.current}And(e,t){return e()&&t()}Or(e,t){return e()||t()}Not(e){return!e()}Filter(e){return e}DestroyFilter(e){}DestroyBoolExpr(e){}TriggerRegisterVariableEvent(e,t,i,r){let n=new Eu(t,i,r);_u(this.runtime,t,e=>n.evaluate(e)),e.VariableEvents.add(new{varName:t,opcode:i,limitval:r})}TriggerRegisterTimerEvent(e,t,i){let r=ou(t,i,e);e.TimerEvents.add({timeout:t,periodic:i,timer:r})}TriggerRegisterTimerExpireEvent(e,t){t.listenExpire(e),e.timerExpireEvents.add(new cu(t))}TriggerRegisterGameStateEvent(e,t,i,r){let n=new Eu(t,i,r);_u(this.gameState,t,e,e=>n.evaluate(e)),e.gameStateEvents.add(new Eu(t,i,r))}TriggerRegisterDialogButtonEvent(e,t){_u(this.dialog,t,e)}TriggerRegisterGameEvent(e,t){_u(this.gameState,t,e),e.gameEvents.add(t)}TriggerRegisterPlayerEvent(e,t,i){_u(t,i,e)}TriggerRegisterPlayerUnitEvent(e,t,i,r){_u(t,i,e,r),e.playerUnitEvents.add(new pu(e,t,i,r))}TriggerRegisterUnitEvent(e,t,i){_u(t,i,e),e.unitEvents.add(new fu(e,t,i))}TriggerAddAction(e,t){e.actions.add(t)}TriggerRemoveAction(e,t){e.actions.remove(t)}TriggerClearActions(e){e.actions.clear()}TriggerEvaluate(e){return du(this.TriggerEvaluate),e.evaluate(this.gameState)}TriggerExecute(e){return du(this.TriggerExecute),e.execute()}async CreateUnit(e,t,i,r,n){let s=await this.app.createUnit(t,i,r,n);return Au({type:"unit",creationArgs:[e,t,i,r,n],instance:s})}SetUnitState(e,t,i){e[t[1]]=i}SetUnitAcquireRange(e,t){e.AcquireRange=t}SetUnitCreepGuard(e,t){e.CreepGuard=t}GetUnitAcquireRange(e){return e.AcquireRange}GetUnitTurnSpeed(e){return e.TurnSpeed}GetUnitPropWindow(e){return e.PropWindow}GetUnitFlyHeight(e){return e.FlyHeight}GetUnitDefaultAcquireRange(e){return e.DefaultAcquireRange}GetUnitDefaultTurnSpeed(e){return e.DefaultTurnSpeed}GetUnitDefaultPropWindow(e){return e.DefaultPropWindow}GetUnitDefaultFlyHeight(e){return e.DefaultFlyHeight}SetUnitOwner(e,t,i){e.Owner=t,i&&(e.color=t.color)}SetUnitColor(e,t){e.color=t}SetUnitScale(e,t,i,r){e.Scale=[t,i,r]}SetUnitTimeScale(e,t){e.TimeScale=t}SetUnitBlendTime(e,t){e.BlendTime=t}SetUnitVertexColor(e,t,i,r,n){e.VertexColor=[t,i,r,n]}QueueUnitAnimation(e,t){console.log("[------decl-only------]","QueueUnitAnimation",arguments)}SetUnitAnimation(e,t){console.log("[------decl-only------]","SetUnitAnimation",arguments)}SetUnitAnimationByIndex(e,t){console.log("[------decl-only------]","SetUnitAnimationByIndex",arguments)}SetUnitAnimationWithRarity(e,t,i){console.log("[------decl-only------]","SetUnitAnimationWithRarity",arguments)}AddUnitAnimationProperties(e,t,i){console.log("[------decl-only------]","AddUnitAnimationProperties",arguments)}SetUnitLookAt(e,t,i,r,n,s){console.log("[------decl-only------]","SetUnitLookAt",arguments)}ResetUnitLookAt(e){console.log("[------decl-only------]","ResetUnitLookAt",arguments)}SetResourceAmount(e,t){e.ResourceAmount=t}AddItemToAllStock(e,t,i){this.NbShops.forEach(r=>r.items.set(e,{currentStock:t,stockMax:i}))}AddItemToStock(e,t,i,r){e.units.set(t,{currentStock:i,stockMax:r})}AddUnitToAllStock(e,t,i){this.NbShops.forEach(r=>r.units.set(e,{currentStock:t,stockMax:i}))}AddUnitToStock(e,t,i,r){e.units.set(t,{currentStock:i,stockMax:r})}RemoveItemFromAllStock(e){this.NbShops.forEach(t=>t.items.remove(e))}RemoveItemFromStock(e,t){e.items.remove(t)}RemoveUnitFromAllStock(e){this.NbShops.forEach(t=>t.units.remove(e))}RemoveUnitFromStock(e,t){e.units.remove(t)}SetAllItemTypeSlots(e){this.NbShops.forEach(t=>t.items=new nu(e))}SetAllUnitTypeSlots(e){this.NbShops.forEach(t=>t.units=new nu(e))}SetItemTypeSlots(e,t){e.items=new nu(t)}SetUnitTypeSlots(e,t){e.units=new nu(t)}GetUnitUserData(e){return e.data}SetUnitUserData(e,t){e.data=t}GetPlayerUnitCount(e,t){return e.Units.size()}GetPlayerTypedUnitCount(e,t,i,r){return e.TypedUnits.filter(e=>e.unitName==t).length}GetPlayerStructureCount(e,t){return e.Structures.size()}GetPlayerState(e,t){return e[t[1]]}GetPlayerScore(e,t){return e[t[1]]}GetPlayerAlliance(e,t,i){return e.AlliancePlayers.any(e=>e.player==t&&e.type==i[1])}GetPlayerHandicap(e){return e.Handicap}GetPlayerHandicapXP(e){return e.HandicapXP}SetPlayerHandicap(e,t){e.Handicap=t}SetPlayerHandicapXP(e,t){e.HandicapXP=t}SetPlayerTechMaxAllowed(e,t,i){e.TechMaxAllowed[t]=i}GetPlayerTechMaxAllowed(e,t){return e.TechMaxAllowed[t]||10}AddPlayerTechResearched(e,t,i){e.TechResearched.getAt(t,e=>new Map).set("levels",i)}SetPlayerTechResearched(e,t,i){e.TechResearched.get(t).set("levels",i)}GetPlayerTechResearched(e,t,i){return e.TechResearched.get(t)}GetPlayerTechCount(e,t,i){return e.TechResearched.get(t).entries.length}SetPlayerState(e,t,i){e[t[1]]=i}IsFogMaskEnabled(){return this.fogMaskEnabled}IsFogEnabled(){return this.fogEnabled}VersionGet(){return console.log("Use version","VERSION_FROZEN_THRONE"),Gn}SetFloatGameState(e,t){this.gameState.set(e[1],t)}GetFloatGameState(e){return this.gameState.getNumber(e[1])}SetIntegerGameState(e,t){this.gameState.set(e[1],t)}GetIntegerGameState(e){return this.gameState.getNumber(e[1])}SetTerrainFogEx(e,t,i,r,n,s,a){this.gameState.terrainFogEx={style:e,zstart:t,zend:i,density:r,red:n,green:s,blue:a}}SetDayNightModels(e,t){}CreateTimerDialog(e){let t={type:"timerdialog",creationArgs:[...arguments],execute:()=>{alert("timerDialog")}};return e&&e.listenExpire(t),t}DestroyTimerDialog(e){}TimerDialogSetTitle(e,t){e.title=t}TimerDialogSetTitleColor(e,t,i,r,n){e.titleColor=[t,i,r,n,"rgba"]}TimerDialogSetTimeColor(e,t,i,r,n){e.timeColor=[t,i,r,n,"rgba"]}TimerDialogSetSpeed(e,t){e.speedMultFactor=t}TimerDialogDisplay(e,t){this.app.showTimerDialog(e,t)}IsTimerDialogDisplayed(e){return e.displayed}TimerDialogSetRealTimeRemaining(e,t){e.timeRemaining=t}SetCameraBounds(e,t,i,r,n,s,a,o){this.gameState.cameraBounds={x1:e,y1:t,x2:i,y2:r,x3:n,y3:s,x4:a,y4:o}}GetCameraBoundMinX(){return this.app.camera.rect[0]}GetCameraBoundMinY(){return this.app.camera.rect[1]}GetCameraBoundMaxX(){return this.app.camera.rect[2]}GetCameraBoundMaxY(){return this.app.camera.rect[3]}NewSoundEnvironment(e){this.gameState.soundEnv={environmentName:e}}CreateSound(e,t,i,r,n,s,a){return{fileName:e,looping:t,is3D:i,stopwhenoutofrange:r,fadeInRate:n,fadeOutRate:s,eaxSetting:a}}CreateSoundFromLabel(e,t,i,r,n,s){return{soundLabel:e}}CreateMIDISound(e,t,i){this.midiSound.soundLabel={soundLabel:e,fadeInRate:t,fadeOutRate:i}}SetMapMusic(e,t,i){console.log("[------decl-only------]","SetMapMusic",arguments)}AddWeatherEffect(e,t){return{where:e,effectID:t}}EnableWeatherEffect(e,t){e.enabled=!0}Preloader(e){console.log("[------decl-only------]","Preloader",arguments)}GetPlayerId(e){return e.index}SetPlayerController(e,t){e.contoller=t[1]}SetPlayerRaceSelectable(e,t){e.raceSelectable=t}SetPlayerRacePreference(e,t){e.racePerf=t[1]}SetPlayerColor(e,t){e.color=t}SetPlayerStartLocation(e,t){e.startLoc=this.startLocations.get(t)}Player(e){return this.players.getAt(e,e=>new mu(e))}DefineStartLocation(e,t,i){this.startLocations.set(e,{x:t,y:i})}SetGamePlacement(e){this.gamePlacement=e[1]}GetCameraMargin(e){return this.app.cameraBounds}SetTeams(e){this.teams=new nu(e,Au)}SetPlayers(e){this.players=new nu(e,Au)}CreateTimer(){return new su}CreateGroup(){return new lu}SetMapName(e){var t,i;this.mapName=null===(t=this.app.map)||void 0===t?void 0:null===(i=t.wts)||void 0===i?void 0:i.getString(e)}SetMapDescription(e){var t,i;this.mapDescription=null===(t=this.app.map)||void 0===t?void 0:null===(i=t.wts)||void 0===i?void 0:i.getString(e)}GetPlayerNeutralPassive(){return an}GetPlayerNeutralAggressive(){return on}GetBJPlayerNeutralVictim(){return 1}GetBJPlayerNeutralExtra(){return 1}GetBJMaxPlayers(){return 24}GetBJMaxPlayerSlots(){return 24}}let vu=1e3;vu++,vu++,vu++,vu++,vu++,vu++,vu++,vu++,vu++,vu++,vu++,vu++,vu++,vu++,vu++,vu++,vu++,vu++,vu++,vu++,vu++,vu++,vu++;const yu={framepointtypeId:0,handleId:vu++,code:"FRAMEPOINT_TOPLEFT"},wu={framepointtypeId:1,handleId:vu++,code:"FRAMEPOINT_TOP"},Su={framepointtypeId:2,handleId:vu++,code:"FRAMEPOINT_TOPRIGHT"},Ru={framepointtypeId:3,handleId:vu++,code:"FRAMEPOINT_LEFT"},bu={framepointtypeId:4,handleId:vu++,code:"FRAMEPOINT_CENTER"},Iu={framepointtypeId:5,handleId:vu++,code:"FRAMEPOINT_RIGHT"},Lu={framepointtypeId:6,handleId:vu++,code:"FRAMEPOINT_BOTTOMLEFT"},Nu={framepointtypeId:7,handleId:vu++,code:"FRAMEPOINT_BOTTOM"},xu={framepointtypeId:8,handleId:vu++,code:"FRAMEPOINT_BOTTOMRIGHT"},Pu=(vu++,vu++,vu++,vu++,vu++,vu++,{frameeventtypeId:1,handleId:vu++,code:"FRAMEEVENT_CONTROL_CLICK"}),Cu={frameeventtypeId:2,handleId:vu++,code:"FRAMEEVENT_MOUSE_ENTER"},Uu={frameeventtypeId:3,handleId:vu++,code:"FRAMEEVENT_MOUSE_LEAVE"},Ou={frameeventtypeId:4,handleId:vu++,code:"FRAMEEVENT_MOUSE_UP"},Du={frameeventtypeId:5,handleId:vu++,code:"FRAMEEVENT_MOUSE_DOWN"},Mu={frameeventtypeId:6,handleId:vu++,code:"FRAMEEVENT_MOUSE_WHEEL"},Fu={frameeventtypeId:7,handleId:vu++,code:"FRAMEEVENT_CHECKBOX_CHECKED"},Bu={frameeventtypeId:8,handleId:vu++,code:"FRAMEEVENT_CHECKBOX_UNCHECKED"},Vu={frameeventtypeId:9,handleId:vu++,code:"FRAMEEVENT_EDITBOX_TEXT_CHANGED"},ku=(vu++,{frameeventtypeId:11,handleId:vu++,code:"FRAMEEVENT_MOUSE_DOUBLECLICK"}),Gu=(vu++,{frameeventtypeId:13,handleId:vu++,code:"FRAMEEVENT_SLIDER_VALUE_CHANGED"}),ju=(vu++,vu++,{frameeventtypeId:16,handleId:vu++,code:"FRAMEEVENT_EDITBOX_ENTER"}),Yu=new Map([[Pu,"click"],[Cu,"mouseenter"],[Uu,"mouseleave"],[Ou,"mouseup"],[Du,"mousedown"],[Mu,"wheel"],[Fu,"change"],[Bu,"change"],[Vu,"change"],[ku,"dblclick"],[Gu,"change"],[ju,"keypress"]]),Hu=new Map,Wu=new Map,Ku=new WeakMap,zu=new WeakMap,qu=(e,t)=>{if("object"!==typeof t)return;if(void 0==t.relative)return;let i=Ku.get(t.relative);i||(i=new Set,Ku.set(t.relative,i)),i.add(e);let r=zu.get(e);r||(r=new Set,zu.set(e,r)),r.add(i)},Xu=(e,t)=>{if(void 0!==t){if("number"===typeof t)return t;if(null==t.relative)return 1;if("string"===typeof t.relativeSide){qu(e,t);const{width:i}=$u(t.relative),r=em(t.relative,i);if(void 0===r)return;return r+("center"===t.relativeSide?(null!==i&&void 0!==i?i:0)/2:t.relativeSide.includes("right")&&null!==i&&void 0!==i?i:0)+t.xOffset*Qu(e)}}},Ju=(e,t)=>{if(void 0!==t){if("number"===typeof t)return t;if(null==t.relative)return.75;if("string"===typeof t.relativeSide){qu(e,t);const{height:i}=$u(t.relative),r=Zu(t.relative,i);if(void 0===r)return;return r-("center"===t.relativeSide?(null!==i&&void 0!==i?i:0)/2:t.relativeSide.includes("bottom")&&null!==i&&void 0!==i?i:0)+t.yOffset*Qu(e)}}},Qu=e=>e.scale*(e.parent?Qu(e.parent):1),$u=e=>{const t=void 0!==e.pos.left&&void 0!==e.pos.right?"points":e.width?"explicit":"implicit";let i;if("explicit"===t)i=e.width*Qu(e);else if("points"===t)i=Xu(e,e.pos.right)-Xu(e,e.pos.left);else if("implicit"===t){const t=Wu.get(e);if(t){const e=t.style.opacity,r=t.style.visibility;t.style.opacity="0",t.style.visibility="visible",i=rm(t.clientWidth),t.style.visibility=r,t.style.opacity=e}}const r=void 0!==e.pos.top&&void 0!==e.pos.bottom?"points":e.height?"explicit":"implicit";let n;if("explicit"===r)n=e.height*Qu(e);else if("points"===r)n=Ju(e,e.pos.top)-Ju(e,e.pos.bottom);else if("implicit"===r){const t=Wu.get(e);if(t){const e=t.style.opacity,i=t.style.visibility;t.style.opacity="0",t.style.visibility="visible",n=rm(t.clientHeight),t.style.visibility=i,t.style.opacity=e}}return{width:i,height:n,implicitWidth:"implicit"===t,implicitHeight:"implicit"===r}},Zu=(e,t)=>{let i;if(void 0!==e.pos.top&&(i=Ju(e,e.pos.top)),void 0!==i)return i;if(void 0!==e.pos.bottom&&void 0!==t){const i=Ju(e,e.pos.bottom);if(void 0!==i)return i+t}if(e.pos.center&&void 0!==t){if("y"in e.pos.center)return e.pos.center.y+t/2;if(e.parent){const i=Ju(e,e.pos.center);if(void 0!==i)return i+t/2}}if(void 0===e.pos.top&&void 0===e.pos.bottom&&(void 0!==e.pos.left||void 0!==e.pos.right)&&void 0!==t){const i="object"===typeof e.pos.left?e.pos.left.relative:"object"===typeof e.pos.right?e.pos.right.relative:void 0;if(i){const e=$u(i).height,r=Zu(i,e);if(void 0!==e&&void 0!==r)return r-e/2+t/2}}},em=(e,t)=>{let i;if(void 0!==e.pos.left&&(i=Xu(e,e.pos.left)),void 0!==i)return i;if(void 0!==e.pos.right&&void 0!==t){const i=Xu(e,e.pos.right);if(void 0!==i)return i-t}if(e.pos.center&&void 0!==t){if("x"in e.pos.center)return e.pos.center.x-t/2;if(e.parent){const i=Xu(e,e.pos.center);if(void 0!==i)return i-t/2}}if(void 0===e.pos.left&&void 0===e.pos.right&&(void 0!==e.pos.top||void 0!==e.pos.bottom)&&void 0!==t){const i="object"===typeof e.pos.top?e.pos.top.relative:"object"===typeof e.pos.bottom?e.pos.bottom.relative:void 0;if(i){const e=$u(i).width,r=em(i,e);if(void 0!==e&&void 0!==r)return r+e/2-t/2}}},tm=()=>1.25*window.innerWidth,im=e=>e*tm(),rm=e=>e/tm(),nm=e=>im(.6-e)+(window.innerHeight-.75*window.innerWidth)/2,sm=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Set;if(t.has(e))return;t.add(e);const i=zu.get(e);i&&(i.forEach(t=>t.delete(e)),i.clear());const{width:r,height:n,implicitWidth:s,implicitHeight:a}=$u(e),{x:o,y:l}=((e,t,i)=>({x:em(e,t),y:Zu(e,i)}))(e,r,n),h=Wu.get(e);h.style.left=void 0!==o?(e=>im(e)+0)(o)+"px":"0",h.style.top=void 0!==l?nm(l)+"px":void 0!==o?"":"0",void 0===r||s||(h.style.width=im(r)+"px"),void 0===n||a||(h.style.height=im(n)+"px"),new Set(Ku.get(e)).forEach(e=>sm(e,t))};class am{constructor(){this.createNode=void 0,this.selectAll=void 0,this.markOrigin=void 0,this.setTooltip=void 0,this.update=void 0,this.addFrameListener=void 0,this.addListener=void 0,this.remove=void 0,this.urlRewriter=void 0,this.createNode=((e,t)=>{const i=document.createElement("span");if(Hu.set(i,e),Wu.set(e,i),i.style.position=e.def.SetAllPoints?"relative":"absolute",i.onmouseover=function(t){i.style.border="1px dashed purple";let r=1,n=setInterval(()=>{i.style.border=r/2==0?"1px dashed white":"1px dashed purple",r++},300),s=((e,t)=>{let i=document.createElement("SPAN");return i.style.backgroundColor="black",i.style.color="white",i.innerText=t,i.style.position="absolute",i.style.left="0",i.style.top="0",i.id="frame-tip-"+e,i})(e.handleId,e.def.name);i.appendChild(s),i.onmouseleave=function(e){i.removeChild(s),clearTimeout(n)}},i.dataset.def=JSON.stringify(e.def.properties),Reflect.set(i,"frame",e),i.setAttribute("frame",e.handleId.toString()),i.setAttribute("name",e.def.name),t){const e=Wu.get(t);e&&e.appendChild(i)}else document.body.appendChild(i);return this.update(e),i}),this.selectAll=function(){return Array.from(document.querySelectorAll(...arguments)).filter(e=>e instanceof HTMLElement).map(e=>Hu.get(e)).filter(e=>!!e)},this.markOrigin=((e,t)=>{const i=Wu.get(e);null===i||void 0===i||i.classList.add("origin-".concat(t.originframetypeId)),i&&document.body.appendChild(i)}),this.setTooltip=((e,t,i)=>{e.BlzFrameSetVisible(i,!1);const r=Wu.get(t);r&&(r.addEventListener("mouseenter",()=>e.BlzFrameSetVisible(i,!0)),r.addEventListener("mouseleave",()=>e.BlzFrameSetVisible(i,!1)))}),this.urlRewriter=(e=>"url(".concat(e,")")),this.update=(e=>{const t=Wu.get(e);if(!t)return;if("string"===typeof e.text){const i=e.text.replace(/\|cff([0-9a-fA-F]{6})/g,'<div style="color: #$1">').replace(/\|r/g,"</div>").replace(/\|n/g,"<br/>");t.setHTML(i),"number"===typeof e.fontSize&&(t.style.fontSize=im(e.fontSize)+"px")}"string"===typeof e.image&&(t.style.backgroundImage=this.urlRewriter(e.image),t.style.backgroundSize="cover");const i=e.visible!==("hidden"!==t.style.visibility);i&&(t.style.visibility=e.visible?"":"hidden"),"number"===typeof e.alpha&&(t.style.opacity=(e.alpha/255).toString());const r=new Set,n=t.style.left,s=t.style.top;sm(e,r),i&&e.children.forEach(e=>sm(e,r)),t.style.left&&im(parseFloat(t.style.left.slice(0,-2)))<0?t.style.left="0px":n&&(t.style.left=n),t.style.top&&im(parseFloat(t.style.top.slice(0,-2)))<0?t.style.top="0px":s&&(t.style.top=s)}),this.addFrameListener=((e,t,i)=>{const r=Wu.get(e);if(!r)return;const n=Yu.get(t);if(!n)throw new Error("BlzTriggerRegisterFrameEvent with ".concat(JSON.stringify(t),"}"));r.addEventListener(n,i)}),this.addListener=function(){return window.addEventListener(...arguments)},this.remove=(e=>{const t=Wu.get(e);t&&t.remove()})}}const om=()=>({top:0,bottom:0,left:0,right:0,center:void 0}),lm=e=>({top:{relative:e,relativeSide:"top",xOffset:0,yOffset:0},bottom:{relative:e,relativeSide:"bottom",xOffset:0,yOffset:0},left:{relative:e,relativeSide:"left",xOffset:0,yOffset:0},right:{relative:e,relativeSide:"right",xOffset:0,yOffset:0},center:void 0}),hm=(e,t,i,r)=>{"function"===typeof i&&(r=i,i=0);const n=null===e||void 0===e?void 0:e[i];"string"===typeof n?r(n):console.warn("Expected string for ".concat(t,", got: ").concat(JSON.stringify(n)," (index ").concat(i,") in ").concat(JSON.stringify(e)))},cm=(e,t,i,r)=>{"function"===typeof i&&(r=i,i=0);const n=null===e||void 0===e?void 0:e[i];"number"===typeof n?r(n):console.warn("Expected number for ".concat(t,", got: ").concat(JSON.stringify(n)," (index ").concat(i,") in ").concat(JSON.stringify(e)))};class dm{constructor(e,t){this.createFrame=void 0,this.BlzCreateFrame=void 0,this.BlzCreateSimpleFrame=void 0,this.BlzCreateFrameByType=void 0,this.BlzDestroyFrame=void 0,this.BlzFrameSetPoint=void 0,this.BlzFrameSetAbsPoint=void 0,this.BlzFrameClearAllPoints=void 0,this.BlzFrameSetAllPoints=void 0,this.BlzFrameSetVisible=void 0,this.BlzFrameIsVisible=void 0,this.BlzGetFrameByName=void 0,this.BlzFrameGetName=void 0,this.BlzFrameClick=void 0,this.BlzFrameSetText=void 0,this.BlzFrameGetText=void 0,this.BlzFrameAddText=void 0,this.BlzFrameSetTextSizeLimit=void 0,this.BlzFrameGetTextSizeLimit=void 0,this.BlzFrameSetTextColor=void 0,this.BlzFrameSetFocus=void 0,this.BlzFrameSetModel=void 0,this.BlzFrameSetEnable=void 0,this.BlzFrameGetEnable=void 0,this.BlzFrameSetAlpha=void 0,this.BlzFrameGetAlpha=void 0,this.BlzFrameSetSpriteAnimate=void 0,this.BlzFrameSetTexture=void 0,this.BlzFrameSetScale=void 0,this.BlzFrameSetTooltip=void 0,this.BlzFrameCageMouse=void 0,this.BlzFrameSetValue=void 0,this.BlzFrameGetValue=void 0,this.BlzFrameSetMinMaxValue=void 0,this.BlzFrameSetStepSize=void 0,this.BlzFrameSetSize=void 0,this.BlzFrameSetVertexColor=void 0,this.BlzFrameSetLevel=void 0,this.BlzFrameSetParent=void 0,this.BlzFrameGetParent=void 0,this.BlzFrameGetHeight=void 0,this.BlzFrameGetWidth=void 0,this.BlzFrameSetFont=void 0,this.BlzFrameSetTextAlignment=void 0,this.BlzTriggerRegisterFrameEvent=void 0,this.BlzGetTriggerFrame=void 0,this.BlzGetTriggerFrameEvent=void 0,this.BlzGetTriggerFrameValue=void 0,this.BlzGetTriggerFrameText=void 0,this.BlzFrameGetChildrenCount=void 0,this.BlzFrameGetChild=void 0,this.frameDefs=void 0,this.BlzGetOriginFrame=void 0,this.BlzEnableUIAutoPosition=void 0,this.BlzHideOriginFrames=void 0,this.BlzConvertColor=void 0,this.idNext=1e4,this.frameDefs=e,this.BlzGetOriginFrame=((e,i)=>t.selectAll(".origin-"+e.originframetypeId)[i]);this.BlzEnableUIAutoPosition=(e=>{}),this.BlzHideOriginFrames=(e=>{}),this.BlzConvertColor=((e,t,i,r)=>e*255**3+65025*t+255*i+r),this.createFrame=((e,i)=>{var r;const n=((e,t,i)=>{return{handleId:t,framehandleId:t,parent:i,def:e,node:null,width:0,height:0,pos:e.setAllPoints||!i?om():lm(i),children:[],visible:!0,scale:1}})(e,this.idNext++,i);null===i||void 0===i||i.children.push(n);const s=this.frameDefs[null!==(r=e.inherits)&&void 0!==r?r:e.name];let a=!1;const o=new Set;if(s)for(const t of null!==(l=s.properties)&&void 0!==l?l:[]){var l;const e=t.args;switch(t.name){case"SetAllPoints":n.pos={left:0,right:0,bottom:0,top:0,center:void 0};break;case"DecorateFileNames":a=!0;break;case"ButtonText":hm(e,"ButtonText",e=>o.add(e));break;case"Text":hm(e,"Text",e=>n.text=e);break;case"Width":cm(e,"Width",e=>n.width=e);break;case"Height":cm(e,"Height",e=>n.height=e);break;case"ControlStyle":hm(e,"ControlStyle",e=>n.controlStyles=e.split("|"));break;case"ButtonPushedTextOffset":break;case"FrameFont":cm(e,"FrameFont",1,e=>n.fontSize=e);break;default:console.warn("Unhandled fdf property ".concat(t.name))}}if(n.node=t.createNode(n,i),s)for(const t of null!==(h=s.children)&&void 0!==h?h:[]){var h;this.createFrame(t,n)}return n}),this.BlzCreateFrame=((e,t,i,r)=>{let n=this.frameDefs[e];if(null==n)throw new Error("FrameNotFound");return this.createFrame(n,t)}),this.BlzCreateSimpleFrame=((e,t,i)=>{let r=this.frameDefs[e];if(null==r)throw new Error("FrameNotFound");return this.createFrame(r,t)}),this.BlzCreateFrameByType=((e,t,i,r,n)=>{let s=this.frameDefs[t];if(null==s)throw new Error("FrameNotFound");return this.createFrame(s,i)}),this.BlzDestroyFrame=(e=>{t.remove(e)}),this.BlzFrameSetPoint=((e,i,r,n,s,a)=>{const o=Em.get(n);if(!o)return console.warn("Unknown relativePoint passed to BlzFrameSetPoint: "+n.framepointtypeId);um.includes(i)&&(e.pos.left={relative:r,relativeSide:o,xOffset:s,yOffset:0}),mm.includes(i)&&(e.pos.right={relative:r,relativeSide:o,xOffset:s,yOffset:0}),fm.includes(i)&&(e.pos.top={relative:r,relativeSide:o,xOffset:0,yOffset:a}),pm.includes(i)&&(e.pos.bottom={relative:r,relativeSide:o,xOffset:0,yOffset:a}),i===bu&&(e.pos.center={relative:r,relativeSide:o,xOffset:s,yOffset:a}),t.update(e)}),this.BlzFrameSetAbsPoint=((e,i,r,n)=>{um.includes(i)&&(e.pos.left=r),mm.includes(i)&&(e.pos.right=r),fm.includes(i)&&(e.pos.top=n),pm.includes(i)&&(e.pos.bottom=n),i===bu&&(e.pos.center={x:r,y:n}),t.update(e)}),this.BlzFrameClearAllPoints=(e=>{e.pos={left:void 0,right:void 0,bottom:void 0,top:void 0,center:void 0}}),this.BlzFrameSetAllPoints=((e,i)=>{e.pos={top:{relative:i,relativeSide:"top",xOffset:0,yOffset:0},bottom:{relative:i,relativeSide:"bottom",xOffset:0,yOffset:0},left:{relative:i,relativeSide:"left",xOffset:0,yOffset:0},right:{relative:i,relativeSide:"right",xOffset:0,yOffset:0},center:void 0},t.update(e)}),this.BlzFrameSetVisible=((e,i)=>{e&&(e.visible=i,t.update(e))}),this.BlzFrameIsVisible=(e=>(console.log("Declared BlzFrameIsVisible"),!1)),this.BlzGetFrameByName=((e,i)=>t.selectAll("[name=".concat(e,"]"))[i]),this.BlzFrameGetName=(e=>(console.log("Declared BlzFrameGetName"),"")),this.BlzFrameClick=(e=>{}),this.BlzFrameSetText=((e,i)=>{e.text=i,t.update(e)}),this.BlzFrameGetText=(e=>e.text),this.BlzFrameAddText=((e,i)=>{var r;e.text=(null!==(r=e.text)&&void 0!==r?r:"")+i,t.update(e)}),this.BlzFrameSetTextSizeLimit=((e,t)=>{}),this.BlzFrameGetTextSizeLimit=(e=>(console.log("Declared BlzFrameGetTextSizeLimit"),0)),this.BlzFrameSetTextColor=((e,t)=>{}),this.BlzFrameSetFocus=((e,t)=>{}),this.BlzFrameSetModel=((e,t,i)=>{}),this.BlzFrameSetEnable=((e,t)=>{}),this.BlzFrameGetEnable=(e=>(console.log("Declared BlzFrameGetEnable"),!1)),this.BlzFrameSetAlpha=((e,i)=>{e.alpha=i,t.update(e)}),this.BlzFrameGetAlpha=(e=>{var t;return null!==(t=e.alpha)&&void 0!==t?t:255}),this.BlzFrameSetSpriteAnimate=((e,t,i)=>{}),this.BlzFrameSetTexture=((e,i,r,n)=>{e.image=i,t.update(e)}),this.BlzFrameSetScale=((e,i)=>{e.scale=i,t.update(e)}),this.BlzFrameSetTooltip=((e,i)=>{t.setTooltip(this,e,i)}),this.BlzFrameCageMouse=((e,t)=>{}),this.BlzFrameSetValue=((e,t)=>{}),this.BlzFrameGetValue=(e=>(console.log("Declared BlzFrameGetValue"),0)),this.BlzFrameSetMinMaxValue=((e,t,i)=>{}),this.BlzFrameSetStepSize=((e,t)=>{}),this.BlzFrameSetSize=((e,i,r)=>{e.width=i,e.height=r,t.update(e)}),this.BlzFrameSetVertexColor=((e,t)=>{}),this.BlzFrameSetLevel=((e,t)=>{}),this.BlzFrameSetParent=((e,t)=>{}),this.BlzFrameGetParent=(e=>e.parent),this.BlzFrameGetHeight=(e=>(console.log("Declared BlzFrameGetHeight"),0)),this.BlzFrameGetWidth=(e=>(console.log("Declared BlzFrameGetWidth"),0)),this.BlzFrameSetFont=((e,t,i,r)=>{}),this.BlzFrameSetTextAlignment=((e,t,i)=>{}),this.BlzTriggerRegisterFrameEvent=((e,i,r)=>{const n={handleId:r.handleId,eventId:r,type:r,agentId:e.agentId};return e.events.push(n),t.addFrameListener(i,r,()=>{e.evaluate()&&e.execute()}),n}),this.BlzGetTriggerFrame=(()=>(console.log("Declared BlzGetTriggerFrame"),null)),this.BlzGetTriggerFrameEvent=(()=>(console.log("Declared BlzGetTriggerFrameEvent"),null)),this.BlzGetTriggerFrameValue=(()=>(console.log("Declared BlzGetTriggerFrameValue"),0)),this.BlzGetTriggerFrameText=(()=>(console.log("Declared BlzGetTriggerFrameText"),"")),this.BlzFrameGetChildrenCount=(e=>e.children.length),this.BlzFrameGetChild=((e,t)=>e.children[t])}}const um=[yu,Ru,Lu],mm=[Su,Iu,xu],fm=[Su,wu,yu],pm=[xu,Nu,Lu],Em=new Map([[yu,"topleft"],[wu,"top"],[Su,"topright"],[Ru,"left"],[bu,"center"],[Iu,"right"],[Lu,"bottomleft"],[Nu,"bottom"],[xu,"bottomright"]]),gm=e=>{let t=new am,i=new dm(e,t);const r=i.BlzCreateFrame("Loading",null,0,0);i.BlzFrameSetAllPoints(r,null),i.BlzFrameSetAbsPoint(r,Lu,0,0),i.BlzFrameSetSize(r,.8,.6)},Am=e=>{const t=[];let i=0;const r=(r,n)=>{n.lastIndex=i;const s=n.exec(e);return!!s&&("whitespace"!==r&&t.push({type:r,content:s[0],index:i}),i+=s[0].length,!0)};for(;i<e.length;)if(!r("newline",/(?:\r?\n)+/y)&&!r("string",/"[^"]*"/y)&&!r("id",/[A-Za-z][A-Za-z0-9_]*/y)&&!r("whitespace",/[ \t]+/y)&&!r("lcurl",/\{/y)&&!r("rcurl",/\}/y)&&!r("comma",/\,/y)&&!r("number",/-?(?:\d+(?:\.\d*)?|\.\d+)f?/y)&&!r("comment",/(?:\/\*[\s\S]*?\*\/|\/\/.*)/y))throw new Error("Unknown part: ".concat(e.slice(i,i+100)));return t},_m=e=>e.tokens[e.index],Tm=(e,t)=>{const i=_m(e);if(i.type===t)return e.tokens[e.index++];throw new Error("Expected ".concat(t,", got ").concat(JSON.stringify(i)))},vm=e=>{const t=[],i={name:Tm(e,"id").content};for(;"newline"!==_m(e).type;){const i=e.tokens[e.index++];if("string"===i.type)t.push(i.content.slice(1,-1));else if("id"===i.type)t.push({type:"FdfId",name:i.content});else if("number"===i.type)t.push(parseFloat(i.content));else if("comma"!=i.type&&"comment"!==i.type)throw new Error("Unexpected token when parsing property: ".concat(JSON.stringify(i)))}return t.length&&(i.args=t),i},ym=e=>{for(;e.index<e.tokens.length&&["comment","newline"].includes(_m(e).type);)Tm(e,_m(e).type)},wm=e=>{const t=(e=>{const t=Tm(e,"id");return"Frame"===t.content?{type:Tm(e,"string").content.slice(1,-1),name:Tm(e,"string").content.slice(1,-1)}:{type:t.content.toUpperCase(),name:"string"===_m(e).type?Tm(e,"string").content.slice(1,-1):""}})(e);"id"===_m(e).type&&"INHERITS"===_m(e).content&&(Tm(e,"id"),"id"===_m(e).type&&"WITHCHILDREN"===_m(e).content&&(t.inheritsChildren=!0,Tm(e,"id")),t.inherits=Tm(e,"string").content.slice(1,-1));const[i,r]=(e=>{const t=[],i=[];for(Tm(e,"lcurl");"rcurl"!==_m(e).type;){ym(e);const r=_m(e);if("rcurl"===r.type)break;"id"===r.type&&["Frame","Texture","String","Layer"].includes(r.content)?i.push(wm(e)):t.push(vm(e))}return Tm(e,"rcurl"),[t,i]})(e);return i.length&&(t.properties=i),r.length&&(t.children=r),t},Sm=e=>{Tm(e,"id");const t=Tm(e,"string").content.slice(1,-1);return Tm(e,"comma"),t},Rm=e=>{Tm(e,"id");const t={};for(Tm(e,"lcurl");"rcurl"!==_m(e).type&&(ym(e),"rcurl"!==_m(e).type);)t[Tm(e,"id").content]=Tm(e,"string").content.slice(1,-1),Tm(e,"comma");return Tm(e,"rcurl"),t},bm=e=>{const t=[],i=[],r={},n={index:0,tokens:Am(e)};for(;n.index<n.tokens.length&&(ym(n),n.index!==n.tokens.length);){const e=_m(n);if(["Frame","Texture","String","Layer"].includes(e.content))t.push(wm(n));else if("IncludeFile"===e.content)i.push(Sm(n));else{if("StringList"!==e.content)throw new Error("Expected Frame or IncludeFile, got ".concat(JSON.stringify(e)));Object.assign(r,Rm(n))}}return{frames:t,includes:i,strings:r}};var Im={extensions:[[".toc","text"]],fdfHandler:{extensions:[[".fdf","text"]],Constructor:class extends Qr{constructor(e){super(e),this.tocDocument=void 0,this.tocDocument=e.viewer.tocDocument}load(e){const{frames:t,includes:i,strings:r}=bm(e);return Object.assign(this.tocDocument.frameDefs,Object.fromEntries(t.map(e=>[e.name,e]))),Object.assign(this.tocDocument.strings,r),Promise.all(i.map(e=>this.tocDocument.loadFdf(e)))}}},install(e){return e.addHandler(this.fdfHandler),!0},Constructor:class extends Qr{constructor(e){super(e),this.loadingFdfs=new nu,this.frameDefs={},this.strings={},e.viewer.tocDocument=this}load(e){const t=e.split(/[\r\n]/).filter(e=>e.length>0);return Promise.all(t.map(e=>this.loadFdf(e)))}loadFdf(e){if(!this.loadingFdfs.has(e.toLowerCase()))return this.loadingFdfs.add(e.toLowerCase()),this.viewer.load(e).whenLoaded()}lateLoad(){gm(this.frameDefs)}},resolveToc:e=>[e,".toc",!0]},Lm=i(178);const{JassParser:Nm}=i(178),xm=(new Nm).getBaseCstVisitorConstructorWithDefaults(),Pm="\n",Cm="\n\n",Um=function(e,t){const i=t-e.length;if(i>=0){return e+new Array(i).map(e=>" ").join(" ")}return e};let Om=[],Dm=0;class Mm{constructor(e,t){this.pad="  ",this.autoID=Dm++,this.ctx=e,this.$symbol={},this._jass2js=this.jass2js,this.jass2js=function(e,t){this.parentNode=Om.length>0?Om[Om.length-1]:null,Om.push(this);let i=this._jass2js(...arguments);return Om.pop(),i}}convertToJs(e,t,i){return i=i||"",t instanceof Array?0==t.length?"":t.map(t=>this.convertToJs(e,t,i)).join(", "):this.checkJs(t.jass2js(e,i))}convertToTs(e,t,i){return i=i||"",t instanceof Array?0==t.length?"":t.map(t=>this.convertToTs(e,t,i)).join(", "):this.checkJs(t.jass2ts(e,i))}checkJs(e){if(null==e||void 0==e)throw new Error("notImplemented");const t=e.toString();if(-1!=t.indexOf("NaN"))throw new Error("notImplemented");if(-1!=t.indexOf("undefined")||-1!=t.indexOf("[object"))throw new Error("notImplemented");return e}jass2js(e,t){throw new Error("notImplemented")}lock(e){if(null==e)throw new Error("invalid call");return this.stack=e.slice(),e.push(this),this}fill(e){for(const t in e)Object.hasOwnProperty.call(e,t)&&(this[t]=e[t]);return this}locateInStack(e){return this.stack.find(t=>t.constructor.name==e.name)}}class Fm extends Mm{constructor(){super(...arguments),this.$symbol={localVars:[],paramVars:[],resolvingVars:{},resolvingFunctions:{}}}jass2js(e,t){t=t||"";let i="";return e.jass2js_debug&&(i=t+"/* native_decl */\n"),i+=t+"// "+this.name+"(",this.params&&(i+=this.convertToTs(e,this.params)),i+="){\n",i+=t+'// console.log("[NotImplemented]","'+this.name+'",arguments)\n',i+=t+"// }",e.$symbol.functionDecls[this.name]={type:"function",native:!0,name:this.name,paramList:this.params?this.convertToJs(e,this.params):"nothing"},i}}class Bm extends Mm{jass2js(e,t){t=t||"";return this.extendFrom?e.jass2js_debug?this.type+"/*type_def_extend_"+this.extendFrom+"*/":this.type:e.jass2js_debug?this.type+"/*type_def*/":this.type}}class Vm extends Mm{constructor(){super(...arguments),this.pad="  ",this.$symbol={globalVars:[],functions:[]}}jass2js(e,t){let i="";i+=(t=t||"")+"// Auto-generated-source, lang=js\n",i+=t+"// input source: "+e.jassfile+"\n",i+=t+"// jass2js version "+e.version+"\n",i+=Pm,i+="function ".concat(e.jassfile,"(){\n"),i+=t+"    if(this.constructor.name !== 'JassRuntime')\n",i+=t+"        throw new Error('Generated code must runs in JassRuntime.run!');\n",i+=t+this.pad+"let rt = this;\n",i+=t+this.pad+'let fileName = "'+e.jassfile+'";\n',i+=t+this.pad+"rt.loadStart(fileName);"+Cm,i+=t+this.pad+"// delcare native functions"+Pm,i+=this.natives.map((i,r)=>i.jass2js(e,t+this.pad,r)).join("\n"+t)+Pm,i+=t+this.pad+"// global variables"+Pm,i+=this.globals.map(i=>i.jass2js(e,t+this.pad)).join("\n"+t+this.pad),i+=t+this.pad+"// function decls"+Pm,i+=this.functions.map((i,r)=>i.jass2js(e,t+this.pad,r)).join("\n"+t)+Pm;let r=e.$symbol.functionDecls;i+=Pm;let n=Object.keys(e.$symbol.functionDecls).map(e=>Object.keys(r[e].resolvingFunctions||{})).reduce((e,t)=>e.concat(t),[]);e.$symbol.resolvingFunctions=[...new Set(n)];let s=Object.keys(e.$symbol.functionDecls).map(t=>Object.keys(e.$symbol.functionDecls[t].resolvingVars||{})).reduce((e,t)=>e.concat(t),[]);e.$symbol.resolvingVars=[...new Set(s)];let a=e.$symbol.resolvingVars.map(e=>JSON.stringify(e)).join(", \n    "+t+this.pad);i+=t+this.pad+"rt.resolveVars([",i+=a,i+="]);",i+=Cm;let o=e.$symbol.resolvingFunctions.map(e=>JSON.stringify(e)).join(", \n    "+t+this.pad);return i+=t+this.pad+"rt.resolveFunctions([",i+=o,i+="]);",i+=Pm,i+=t+this.pad+"rt.loaded(fileName);"+Cm,i+="}"}}class km extends Mm{jass2js(e,t){return t=t||"",this.call.jass2js(e,t)}}class Gm extends Mm{jass2js(e,t){let i="";i+=t=t||"";let r=this.variable.id;return this.variable.arrayAccess&&(r+=this.variable.arrayAccess.jass2js(e)),this.locateInStack(uf).$symbol.localVars.find(e=>e.name==this.variable.id)?i+=r:i+="this."+r,i+=" = "+this.value[0].jass2js(e),e.jass2js_debug?i+"/*set*/":i}}class jm extends Mm{constructor(){super(...arguments),this.pad="    "}jass2js(e,t){let i="";i+=(t=t||"")+"else if";let r=this.condition.jass2js(e);return this.condition instanceof Xm?i+=r:i+="("+r+")",i+="{\n",i+=t+this.pad+this.convertToJs(e,this.statements)+Pm,i+=t+"}",e.jass2js_debug?i+"/*end_elseif*/":i}}class Ym extends Mm{constructor(){super(...arguments),this.pad="    "}jass2js(e,t){let i=(t=t||"")+"else{\n";return i+=this.convertToJs(e,this.statements,t+this.pad)+Pm,i+=t+"}",e.jass2js_debug?i+"/*end_else*/":i}}class Hm extends Mm{constructor(){super(...arguments),this.pad="    "}jass2js(e,t){let i="";i+=(t=t||"")+"if";let r=this.condition.jass2js(e);return this.condition instanceof Xm?i+=r:i+="("+r+")",i+="/*start_of_statements_".concat(this.autoID,"*/{"),this.statements.length?(i+=Pm,i+=this.convertToJs(e,this.statements,t+this.pad)+Pm,i+=t+"}"):i+="}/*empty_statements*/",this.elseIfStatement&&(i+=Pm,i+=this.elseIfStatement.jass2js(e,t)),this.elseStatement&&(i+=Pm,i+=this.elseStatement.jass2js(e,t)),e.jass2js_debug?i+"/*end_if*/":i}}class Wm extends Mm{jass2js(e,t){return t=t||"",this.code}}class Km extends Mm{jass2js(e,t){return t=t||"","STRING"===this.type&&this.value&&(this.value=this.value.replace(/\n/g,"\\n")),this.checkJs(this.code||this.value)}}class zm extends Mm{jass2js(e,t){return t=t||"",this.params.map(t=>t.jass2js(e,"")).join(", ")}jass2ts(e,t){return t=t||"",this.params.map(t=>t.jass2ts(e,"")).join(", ")}}class qm extends Mm{jass2js(e,t){return t=t||"",this.convertToJs(e,this.expressions,t)}}class Xm extends Mm{jass2js(e,t){return t=t||"","("+this.expression.jass2js(e)+")"}}class Jm extends Mm{jass2js(e,t){let i=t=t||"";return this.nothing||!this.expression?i+="return;":i+="return "+this.expression.jass2js(e),i}}class Qm extends Mm{constructor(){super(...arguments),this.code="nothing"}jass2js(e,t){return t=t||"",this.code||this.value}jass2ts(e,t){return t=t||"","/*void*/"}}class $m extends Mm{jass2js(e,t){return t=t||"",(this.locateInStack(uf)||this.locateInStack(Fm)).$symbol.paramVars.push({name:this.name,type:this.convertToJs(e,this.type)}),e.jass2js_debug?this.name+"/*jass_param "+this.convertToJs(e,this.type)+" */":this.name}jass2ts(e,t){return t=t||"",(this.locateInStack(uf)||this.locateInStack(Fm)).$symbol.paramVars.push({name:this.name,type:this.convertToTs(e,this.type)}),this.name+":"+this.convertToTs(e,this.type)}}class Zm extends Mm{constructor(){super(...arguments),this.code="null"}jass2js(e,t){return t=t||"",this.code||this.value}}class ef extends Mm{jass2js(e,t){t=t||"";let i="this."+this.name;if("FUNCTION"==this.type)return e.jass2js_debug&&(e.$symbol.functionDecls[this.name]?i="await "+i+"/*ref*/":i+="/*?ref*/"),i;throw new Error("notImplemented")}}class tf extends Mm{jass2js(e,t){if(t=t||"",this.type="NEG")return"-"+this.expression.jass2js(e);throw new Error("notImplemented")}}class rf extends Mm{jass2js(e,t){return t=t||"",null!=this.right?this.checkJs(this.left.jass2js(e))+" "+this.checkJs(this.op.jass2js(e))+" "+this.checkJs(this.right.jass2js(e)):this.left.jass2js(e)}}class nf extends Mm{jass2js(e,t){t=t||"";let i="["+this.convertToJs(e,this.expression)+"]";return e.jass2js_debug?i+"/*arr_access*/":i}}class sf extends Mm{jass2js(e,t){this.locateInStack(Vm);const i=this.locateInStack(uf),r=(i?i.$symbol.localVars.concat(i.$symbol.paramVars):[]).find(e=>e.name==this.target);e.$symbol.globalVarDecls[this.target]||r||!i||e.runtime[this.target]||(i.$symbol.resolvingVars[this.target]=this.target),t=t||"";let n="";return r||(n+="this."),n+=this.target,this.array&&(n+=this.array.jass2js(e)),e.jass2js_debug?n+"/*jassvar*/":n}}class af extends Mm{jass2js(e,t){let i="";return i+=(t=t||"")+"while(true){"+Pm,i+=this.statements.map(i=>this.convertToJs(e,i,t+this.pad)).join(";"+Pm)+Pm,i+=t+"}"}}class of extends Mm{jass2js(e,t){t=t||"";let i="";if(this.expression.length>1)throw new Error("notImplemented");return i+=t+"if("+this.expression[0].jass2js(e,t)+"){"+Pm,i+=t+this.pad+"break;"+Pm,i+=t+"}"}}class lf extends Mm{jass2js(e,t){let i=(t=t||"")+"let ",r="global"==this.scope?30:20;this.type.jass2js(e),this.type.isArrayType(),this.name;if("global"==this.scope)e.$symbol.globalVarDecls[this.name]={name:this.name,type:this.type.jass2js(e)},null==this.value?(i=t+"this."+this.name.padEnd(30),this.type.isArrayType()&&(i+="= []")):i=this.name.startsWith("CAMERA_MARGIN")?t+"this."+this.name.padEnd(30)+'= ["camera.margin","'+this.name+'",'+this.value[0].jass2js(e)+"]":this.name.startsWith("PLAYER_NEUTRAL")?t+"this."+this.name.padEnd(30)+'= ["player.neutral","'+this.name+'",'+this.value[0].jass2js(e)+"]":t+"this."+this.name.padEnd(30)+"= "+this.value[0].jass2js(e);else{this.locateInStack(uf).$symbol.localVars.push({name:this.name,type:this.type.jass2js(e)}),null==this.value?(i+=Um(this.name,t+r)+" ",this.type.isArrayType()&&(i+="= []")):i+=Um(this.name,t+r)+" = "+this.value[0].jass2js(e)}return e.jass2js_debug?i+"/* var_decl of "+this.type.jass2js(e)+"*/ ":i}}class hf extends Mm{jass2js(e,t){if(t=t||"","identifier"==this.type.type)return this.ctx.ARRAY?this.type.value+"[]":this.type.value;throw new Error("notImplemented")}isArrayType(){return this.ctx.ARRAY}}class cf extends Mm{jass2js(e,t){t=t||"";return this.declaration.map(i=>i.jass2js(e,t)).join("\n")+Pm}}class df extends Mm{jass2js(e,t){t=t||"";this.locateInStack(uf);void 0==e.$symbol.functionDecls[this.name.image]&&(e.$symbol.resolvingFunctions[this.name.image]={type:"function",name:this.name.image,args:this.args?this.convertToJs(e,this.args):"nothing"});let i="/*call ".concat(this.name.image," */"),r=t,n=this.stack[this.stack.length-2]instanceof lf;if(this.args){let t=this.convertToJs(e,this.args);if(this.name.image.startsWith("Convert")&&n){let i=this.stack[this.stack.length-2].name,n=this.stack[3].type.value;e.$symbol.enums[i]=t,r+='["'.concat(n,'","').concat(i,'",').concat(t,"]")}else e.runtime.isPromisedFunction(this.name.image)?r+='await this.call2("'+this.name.image+'", ['+t+"])":r+='this.call("'+this.name.image+'", ['+t+"])"}else e.runtime.isPromisedFunction(this.name.image)?r+='await this.call2("'+this.name.image+'")':r+='this.call("'+this.name.image+'")';return e.jass2js_debug?r+i:r}}class uf extends Mm{constructor(){super(...arguments),this.pad=Um("",4),this.$symbol={localVars:[],paramVars:[],resolvingVars:{},resolvingFunctions:{}}}jass2js(e,t,i){let r="";return r+=(t=t||"")+"// offset="+i+Pm,r+=t+"this.",r+=this.name+"=async",1==this.paramList.params.length&&"nothing"==this.paramList.params[0].code?r+="()=>":(r+="(",r+=this.paramList.jass2js(e,t),r+=")=>"),r+="{",this.vardecls.length>0&&(r+=Pm,r+=t+this.pad+"// local variables\n",r+=this.vardecls.map(i=>i.jass2js(e,t+this.pad)).join(Pm)+Cm),this.statements.length>0&&(r+=Pm,r+=this.statements.map(i=>i.jass2js(e,t+this.pad)).join(Pm)+Pm),r.endsWith(")=>{")?r+="}":r+=t+"}",e.$symbol.functionDecls[this.name]=this.$symbol,r}}class mf extends Mm{jass2js(e,t){t=t||"";let i=e.$symbol.resolvingTypes[this.value];return i||(i=e.$symbol.resolvingTypes[this.value]={usages:[]}),i.usages.push(this.stack),t+this.value}jass2ts(e,t){t=t||"";let i=e.$symbol.resolvingTypes[this.value];return i||(i=e.$symbol.resolvingTypes[this.value]={usages:[]}),i.usages.push(this.stack),"integer"==this.value||"real"==this.value?t+"number":t+this.value}}class ff extends xm{constructor(e,t,i){super(),this.$symbol={functionDecls:{},globalVarDecls:{},resolvingTypes:{},resolvingFunctions:{},enums:{}},this.version="0.8.2",this.validateVisitor(),this.runtime=e,this.natives=i,this.jassfile=t,this.jass2js_debug=1}addResolvingSymbol(e){this.resovingSymbols.find(t=>t.name==e.name&&t.type==e.type)||this.resovingSymbols.push(e)}locateInStack(e,t){return e.find(e=>e.constructor.name==t.name)}visit(e,t){if(null==t)throw new Error("invalid call.");if(e instanceof Array)return e.map(e=>this.visit(e,t.slice()));if(e.image){const i=this.visitImage(e,t);this.locateInStack(t,uf);return i}{const i=super.visit.call(this,e,t);if(void 0==i)throw i=super.visit.call(this,e,t),new Error("notImplemented");return i}}visitImage(e,t){const i=e.tokenType.name;if("NULL"===i)return new Zm(e).lock(t);if("INTEGER"==i)return new Km(e).lock(t).fill({type:e.tokenType.name,value:parseInt(e.image)}).lock(t);if("TRUE"==i)return new Km(e).lock(t).fill({type:"BOOLEAN",value:!0}).lock(t);if("FALSE"==i)return new Km(e).lock(t).fill({type:"BOOLEAN",value:!1}).lock(t);if("IDLITERAL"==i)return new Km(e).lock(t).fill({type:"STRING",value:e.image}).lock(t);if("STRINGLITERAL"==i)return new Km(e).lock(t).fill({type:"STRING",value:e.image}).lock(t);if("REAL"==i)return new Km(e).lock(t).fill({type:"REAL",value:parseFloat(e.image)}).lock(t);if("EQUALSEQUALS"==i)return new Wm(e).lock(t).fill({code:"=="}).lock(t);if("NOTEQUALS"==i)return new Wm(e).lock(t).fill({code:"!="}).lock(t);if("AND"==i)return new Wm(e).lock(t).fill({code:"&&"}).lock(t);if("OR"==i)return new Wm(e).lock(t).fill({code:"||"}).lock(t);if("PLUS"==i)return new Wm(e).lock(t).fill({code:"+"}).lock(t);if("MINUS"==i)return new Wm(e).lock(t).fill({code:"-"}).lock(t);if("MULT"==i)return new Wm(e).lock(t).fill({code:"*"}).lock(t);if("DIV"==i)return new Wm(e).lock(t).fill({code:"/"}).lock(t);if("GREATER"==i)return new Wm(e).lock(t).fill({code:">"}).lock(t);if("LESS"==i)return new Wm(e).lock(t).fill({code:"<"}).lock(t);if("GREATEROREQUALS"==i)return new Wm(e).lock(t).fill({code:">="}).lock(t);if("LESSOREQUALS"==i)return new Wm(e).lock(t).fill({code:"<="}).lock(t);throw new Error("notImplemented")}FunctionReferenceExpression(e,t){return new ef(e).lock(t).fill({type:"FUNCTION",name:e.ID[0].image})}NegateExpression(e,t){return new tf(e).lock(t).fill({type:"NEG",expression:this.visit(e.expression,t.slice())[0]})}NotExpression(e,t){return new tf(e).lock(t).fill({type:"NOT",expression:this.visit(e.expression,t.slice())[0]})}functionCallExpression(e,t){return new df(e).lock(t).fill({name:e.ID[0],args:e.argList?e.argList.map(e=>this.visit(e,t.slice())):[]})}argList(e,t){return new qm(e).lock(t).fill({expressions:this.visit(e.expression,t.slice())})}ParentheticalExpression(e,t){return new Xm(e).lock(t).fill({expression:this.visit(e.expression,t.slice())[0]})}type(e,t){return e.NOTHING?new Qm(e).lock(t):e.ID?new mf(e).lock(t).fill({type:"identifier",value:e.ID[0].image}):new Qm(e).lock(t)}program(e,t){return e=e.children,new Vm(e).lock(t).fill({functions:e.functionBlock?e.functionBlock.map(e=>this.visit(e,t.slice())):[],globals:e.globalsBlock?e.globalsBlock.map(e=>this.visit(e,t.slice())):[],types:e.typeDefinition?e.typeDefinition.map(e=>this.visit(e,t.slice())):[],natives:e.nativeBlock?e.nativeBlock.map(e=>this.visit(e,t.slice())):[]})}nativeBlock(e,t){return new Fm(e).lock(t).fill({constant:!!e.CONSTANT,name:e.ID[0].image,params:this.visit(e.paramList,t.slice()),returnType:this.visit(e.returnType,t.slice())})}typeDefinition(e,t){if(e.EXTENDS)return new Bm(e).lock(t).fill({type:e.ID[0].image,extendFrom:e.ID[1].image})}statement(e,t){return e.statements.map(i=>this.visit(e.statements,t.slice()))}callStatement(e,t){return new km(e).lock(t).fill({call:this.visit(e.functionCallExpression,t.slice())[0],type:"callstatement"})}arrayAccess(e,t){return new nf(e).lock(t).fill({expression:this.visit(e.expression,t.slice())[0]})}setStatement(e,t){return e.arrayAccess?new Gm(e).lock(t).fill({variable:{id:e.ID[0].image,arrayAccess:e.arrayAccess.map(e=>this.visit(e,t))[0]},value:this.visit(e.expression,t.slice())}):new Gm(e).lock(t).fill({variable:{id:e.ID[0].image},value:this.visit(e.expression,t.slice())})}ifStatement(e,t){return new Hm(e).lock(t).fill({condition:this.visit(e.condition[0],t.slice()),statements:e.statements?e.statements.map(e=>this.visit(e,t.slice()))[0]:[],elseStatement:e.elseStatement?this.visit(e.elseStatement,t.slice())[0]:null,elseIfStatement:e.elseIfStatement?this.visit(e.elseIfStatement,t.slice())[0]:null})}elseIfStatement(e,t){return new jm(e).lock(t).fill({condition:this.visit(e.condition[0],t.slice()),statements:e.statements?e.statements.map(e=>this.visit(e,t.slice()))[0]:[]})}elseStatement(e,t){return new Ym(e).lock(t).fill({statements:e.statements?e.statements.map(e=>this.visit(e,t.slice()))[0]:[]})}left(e,t){return this.createJassExpression(e,t)}right(e,t){return this.createJassExpression(e,t)}expression(e,t){if(e.right)return new rf(e).lock(t).fill({left:this.visit(e.left,t.slice())[0],op:this.visit(e.op,t.slice())[0],right:this.visit(e.right,t)[0]});if(e.left)return this.visit(e.left,t)[0];throw new Error("notImplemented")}createJassExpression(e,t){if("null"===e.image)return new Zm(e).lock(t).fill({type:"NULL",value:null});if(e.NULL)return new Zm(e).lock(t).fill({type:"NULL",value:null});if(e.INTEGER)return new Km(e).lock(t).fill({type:"INTEGER",value:parseInt(e.INTEGER[0].image)});if(e.TRUE)return new Km(e).lock(t).fill({type:"BOOLEAN",value:!0});if(e.FALSE)return new Km(e).lock(t).fill({type:"BOOLEAN",value:!1});if(e.EQUALSEQUALS)return new tf(e).lock(t);if(e.ParentheticalExpression){let i=new tf(e).lock(t),r=e.ParentheticalExpression[0].children.expression;return i.expressions=r.map(e=>this.visit(e,t.slice())),i}if(e.jassValueOf)return this.visit(e.jassValueOf[0],t.slice());throw new Error("notImplemented")}jassValueOf(e,t){return e.argList?new df(e).lock(t).fill({type:"FUNCTION",name:e.ID[0],args:e.argList.map(e=>this.visit(e,t.slice()))}):e.LPAREN?new df(e).lock(t).fill({type:"FUNCTION",name:e.ID[0]}):e.arrayAccess?new sf(e).lock(t).fill({type:"VAR",target:e.ID[0].image,array:this.visit(e.arrayAccess[0],t.slice())}):new sf(e).lock(t).fill({type:"VAR",target:e.ID[0].image})}functionBlock(e,t){let i=[],r=[],n=new uf(e).lock(t);return e.statement&&(i=e.statement.map(e=>this.visit(e,t.slice())[0][0])),e.localvardeclaration&&(r=e.localvardeclaration.map(e=>this.visit(e,t.slice()))),n.fill({name:e.functionName[0].image,paramList:this.visit(e.paramList[0],t.slice()),returnType:this.visit(e.returnType[0],t.slice()),statements:i,vardecls:r})}returnStatement(e,t){return new Jm(e).lock(t).fill({nothing:e.nothing?new Qm(e).lock(t):null,expression:e.expression?this.visit(e.expression[0],t.slice()):null})}paramList(e,t){return e.nothing?new zm(e).lock(t).fill({params:[]}):new zm(e).lock(t).fill({params:e.param.map(e=>this.visit(e,t.slice()))})}param(e,t){return e.NOTHING?new Qm(e).lock(t):new $m(e).lock(t).fill({type:this.visit(e.type[0],t.slice()),name:e.ID[0].image})}exitWhenStatement(e,t){return new of(e).lock(t).fill({type:"exitwhen",expression:this.visit(e.expression,t.slice())})}loopStatement(e,t){let i=[];return e.statement&&(i=e.statement.map(e=>this.visit(e,t.slice()))),new af(e).lock(t).fill({type:"loopstatement",statements:i})}globalVar(e,t){return new lf(e).lock(t).fill({scope:"global",type:new hf(e.type[0].children).lock(t).fill({type:this.visit(e.type[0],t.slice())}),name:e.label[0].image,value:e.expression?this.visit(e.expression,t.slice()):null})}localVars(e,t){this.locateInStack(t,uf);return new lf(e).lock(t).fill({scope:"local",type:new hf(e.type[0].children).lock(t).fill({type:this.visit(e.type[0],t.slice())}),name:e.label[0].image,value:e.expression?this.visit(e.expression,t.slice()):null})}globalsBlock(e,t){return new cf(e).lock(t).fill({scope:"global",declaration:e.globalVars.map(e=>this.visit(e,t.slice()))})}}const pf=function(e,t,i){const r=new ff(e,i.jassfile,i.api),n=i.rule||"program",s=Object(Lm.parse)(t,n,i.debugParser);return r[n]("program"==n?s:s.children,[]).jass2js(r)};class Ef{constructor(e){this.fileSymbols=[],this.unresolved=[],this.enums={},this.gameTypes=[],this.constants={},this.scripts={},this.converted=[],this.promised=["CreateUnit","Preloader","Filter"],this.gameTypes=tu,this.constants=r,this.natives=new Tu(e),this.app=e,this.triggerData=e.triggerData}load(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"program";t="GAMESCRIPT_"+t.replaceAll(/[./\\]/g,"_");let r=pf(this,e,{jassfile:t,rule:i});const n=new Blob([r],{type:"text/javascript"}),s=URL.createObjectURL(n),a=document.createElement("script");a.type=n.type,a.async=!0,a.src=s,a.id=t,document.head.appendChild(a),this.scripts[t]=a;let o=this;return new Promise((e,r)=>{a.onload=(()=>{try{"program"==i&&globalThis[t].call(o),e()}catch(n){r(n)}})})}loadStart(e){console.log("loadStart",e)}loaded(e){console.log("loaded",e)}enum(e,t,i){return this.enums[i]||(this.enums[i]=this.enums[i]||{},this.enums[i][e]=t,this.enums[i][t]=e,this.enums["convert"+i.toLowerCase()]=function(e){return this.enums[i][e]}),e}call(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(this[e]instanceof Function)return this.natives[e]instanceof Function&&console.warn("W","duplicate implementation of",e),this[e](...t);if(e.startsWith("Convert")&&1==t.length){if(this.gameTypes.includes(e.substring(7).toLowerCase()))return this.directConvert(t[0]);if(this.triggerData.triggerParams.filter(t=>t.variableType==e.substring(7).toLowerCase()).length)return this.directConvert(t[0])}if(this.natives[e]instanceof Function){let i=this.natives[e](...t);return this.natives.logCalls.contains(e)?console.log("[------LOG------]",e,t||[],", returns",void 0===i?"nothing":i):console.log("[LOG]",e,t||[],", returns",void 0===i?"nothing":[i]),i}return console.info("[NotDeclared]",e,t||[])}directConvert(e){return e}async config(){}async main(){}checkNative(e){return!0}resolveFunctions(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];if(e.filter(e=>!this.natives[e]).length)throw new Error("assert: unresolved functions:");e.map(e=>e+"(){\ndebugger\n}").join("\n")}resolveVars(){const e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).filter(e=>void 0===this.constants[e]);e.length&&console.log("assert: unresolved vars:",e);e.map(e=>"this."+e+"=null;").join("\n")}isPromisedFunction(e){return!!this.promised.includes(e)||void 0==this.natives[e]}async call2(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=this.call(e,t);return i instanceof Promise&&await i,i}}var gf={extensions:[[".j","text"]],Constructor:class extends Qr{constructor(e){super(e),this.vm=void 0,this.vm=this.viewer.vm||(this.viewer.vm=new Ef(this.viewer))}async load(e){await this.viewer.vm.load(e,this.path),this.path.endsWith("war3map.j")&&(console.log("jassvm","Enter vm::config."),await this.vm.config(),console.log("jassvm","Exit vm::config."),console.log("jassvm","Enter vm::main."),await this.vm.main(),console.log("jassvm","Exit vm::main."))}}};const Af=e=>{let t=[];for(let i of e)i&&i.whenLoaded&&t.push(i.whenLoaded());return Promise.all(t)};class _f extends lr.a{constructor(e,t){super(),this.appendParam=((e,t)=>{if(!e.startsWith("blob:")&&t)for(const i in t)t[i]&&(e+=-1===e.indexOf("?")?"?":"&",e+=i,e+="=",e+=t[i]);return e}),this.resourcesMap=new Map,this.resources=[],this.frameTime=1e3/60,this.canvas=e,this.webgl=new wr(e,t),this.gl=this.webgl.gl,this.shaderMap=new Map,this.handlers=new Set,this.scenes=[],this.resourcesLoading=new Set,this.on("loadstart",e=>{this.resourcesLoading.add(e)}),this.on("loadend",e=>{this.resourcesLoading.delete(e),0===this.resourcesLoading.size&&setTimeout(()=>this.emit("idle"),0)}),this.noCulling=!1,this.noUpdating=!1,this.textureAtlases={},this.batchSize=8,this.renderedInstances=0,this.renderedParticles=0,this.renderedBuckets=0,this.renderedScenes=0,this.renderCalls=0,this.enableAudio=!1,this.addHandler(en),this.addHandler(Im),this.addHandler(gf)}addHandler(e){if(e){let t=this.handlers;if(e.handler&&(e=e.handler),!t.has(e))return e.install&&!e.install(this)?(this.emit("error",this,"InvalidHandler","FailedToLoad"),!1):(t.add(e),!0)}return!1}addScene(){let e=new Jr(this);return this.scenes.push(e),e}removeScene(e){let t=this.scenes,i=t.indexOf(e);return-1!==i&&(t.splice(i,1),!0)}clear(){let e=this.scenes;for(let t=e.length;t--;)this.removeScene(e[t])}findHandler(e){for(let t of this.handlers)for(let i of t.extensions)if(e===i[0])return[t,i[1]]}load(e,t){if(e){let i,r,n="string"===typeof e?e:null;e instanceof HTMLImageElement||e instanceof HTMLVideoElement||e instanceof HTMLCanvasElement||e instanceof ImageData||e instanceof WebGLTexture?(i=".png",r=!1,t=null):[e,i,r]=t(e);let s=this.findHandler(i.toLowerCase());if(s){let a=this.resourcesMap.get(e);if(a)return a;let o=s[0];if(a=new o.Constructor({viewer:this,handler:o,extension:i,pathSolver:t,fetchUrl:r?e:"",path:n}),this.resources.push(a),this.resourcesMap.set(e,a),this.registerEvents(a),a.emit("loadstart",a),r){let t=s[1];gr(e=this.appendParam(e,{src:n}),t).then(e=>{let t=e.data;e.ok?a.loadData(t):a.error("FailedToFetch")})}else a.loadData(e);return a}return this.emit("error",this,"MissingHandler",[e,i,r]),null}}exists(e){return this.resourcesMap.has(e)}loadGeneric(e,t,i,r){let n=this.resourcesMap.get(e);if(n)return n;function s(e){i&&(e=i(e))instanceof Promise?e.then(e=>n.loadData(e)):n.loadData(e)}return n=new tn({viewer:this,handler:i,fetchUrl:e,path:r}),this.resources.push(n),this.resourcesMap.set(e,n),this.registerEvents(n),n.emit("loadstart",n),e instanceof ArrayBuffer?s(e):gr(e=this.appendParam(e,{dataType:t,src:r}),t).then(e=>{let t=e.data;e.ok?s(t):(n.error("FailedToFetch"),this.emit("error",n,e.error,t))}),n}unload(e){for(let[t,i]of this.resourcesMap)if(i===e)return this.resourcesMap.delete(t),this.resources.splice(this.resources.indexOf(e),1),!0;return!1}loadShader(e,t,i){let r=this.shaderMap;return r.has(e)||r.set(e,this.webgl.createShaderProgram(t,i)),r.get(e)}loadTextureAtlas(e,t){let i=this.textureAtlases;if(!i[e]){let r={texture:new Zr({viewer:this}),columns:0,rows:0},n=this.promise();Af(t).then(e=>{for(let i of e)if(!i.ok)return void n.resolve();let t=function(e){let t=e[0].width,i=e[0].height,r=dr(Math.ceil(Math.sqrt(e.length))),n=dr(Math.ceil(e.length/r));ur.width=t*r,ur.height=i*n;for(let s=0,a=e.length;s<a;s++)mr.putImageData(e[s],s%r*t,Math.floor(s/r)*i);return{imageData:mr.getImageData(0,0,ur.width,ur.height),columns:r,rows:n}}(e.map(e=>e.imageData));r.texture.loadData(t.imageData),r.columns=t.columns,r.rows=t.rows,n.resolve()}),i[e]=r}return i[e]}getTextureAtlas(e){let t=this.textureAtlases[e];return t?t.texture:null}promise(){let e=new Sr;return this.registerEvents(e),e.promise(),e}whenAllLoaded(){return new Promise((e,t)=>{0===this.resourcesLoading.size?e(this):this.once("idle",()=>e(this))})}toBlob(){return new Promise(e=>this.canvas.toBlob(t=>e(t)))}updateAndRender(){this.update(),this.startFrame(),this.render()}update(){let e=this.scenes;this.renderedInstances=0,this.renderedParticles=0,this.renderedBuckets=0,this.renderedScenes=0,this.renderCalls=0;for(let t=0,i=e.length;t<i;t++){let i=e[t];i.rendered&&(i.update(),this.renderedInstances+=i.renderedInstances,this.renderedParticles+=i.renderedParticles,this.renderedBuckets+=i.renderedBuckets,this.renderedScenes+=1,this.renderCalls+=i.renderCalls)}}startFrame(){let e=this.gl;e.depthMask(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}render(){this.renderOpaque(),this.renderTranslucent()}renderOpaque(){for(let e of this.scenes)e.renderOpaque()}renderTranslucent(){for(let e of this.scenes)e.renderTranslucent()}registerEvents(e){var t=this;["loadstart","load","error","loadend"].map(i=>e.on(i,function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t.emit(i,...r)}))}clearEmittedObjects(){for(let e of this.scenes)e.clearEmittedObjects()}}class Tf{constructor(e){this.model=e,this.instanceSet=new Set,this.sceneData=new Map,this.renderedInstances=0,this.renderedParticles=0,this.renderedBuckets=0,this.renderCalls=0}getShallowCopy(){return null}applyShallowCopy(e){}equals(e){return!0}lateLoad(){for(let e of this.instanceSet)this.addSceneData(e,e.scene)}addSceneData(e,t){if(this.model.ok&&t){let i=this.sceneData,r=i.get(t);r||(r=this.createSceneData(t),i.set(t,r)),r.instances.push(e)}}addInstance(e){let t=this.instanceSet;if(!t.has(e)){let i=e.modelView;return i&&i.removeInstance(e),t.add(e),e.modelView=this,this.addSceneData(e,e.scene),!0}return!1}createSceneData(e){return{scene:e,modelView:this,baseIndex:0,instances:[],buckets:[],usedBuckets:0}}removeInstance(e){let t=this.instanceSet;if(t.delete(e)){let i=this.sceneData,r=e.scene;if(r){let t=i.get(r),n=t.instances,s=t.buckets;n.splice(n.indexOf(e),1);let a=Math.ceil(n.length/this.model.batchSize);a<s.length&&(s.length=a)}return e.modelView=null,0===t.size&&this.model.removeView(this),!0}return!1}sceneChanged(e,t){if(this.model.ok){let i=this.sceneData,r=e.scene;if(r){let t=i.get(r),n=t.instances,s=t.buckets;n.splice(n.indexOf(e),1);let a=Math.ceil(n.length/this.model.batchSize);a<s.length&&(s.length=a)}t&&this.addSceneData(e,t)}}clear(){}detach(){}update(e){if(this.model.ok){let t=this.sceneData.get(e);if(t){let e=t.instances.length,i=t.buckets;for(t.baseIndex=0,t.usedBuckets=0;t.baseIndex<e;)t.usedBuckets===i.length&&(i[t.usedBuckets]=new this.model.handler.Bucket(this)),t.baseIndex=i[t.usedBuckets].fill(t),t.usedBuckets+=1;return t}}return null}renderOpaque(e){let t=this.sceneData.get(e);t&&t.baseIndex&&this.model.renderOpaque(t)}renderTranslucent(e){let t=this.sceneData.get(e);t&&t.baseIndex&&this.model.renderTranslucent(t)}}class vf extends Tf{constructor(e){super(e),this.textures=new Map}getShallowCopy(){return{textures:new Map(this.textures)}}applyShallowCopy(e){let t=this.textures;for(let[i,r]of e.textures)t.set(i,r)}equals(e){let t=this.textures,i=e.textures;if(t.length!==i.length)return!1;for(let[r,n]of i)if(t.get(r)!==n)return!1;return!0}}class yf extends Qr{constructor(e){super(e),this.batchSize=e.viewer.batchSize,this.instances=[],this.views=[]}addInstance(){let e=this.views,t=new this.handler.Instance(this);return this.instances.push(t),0===e.length&&this.addView(),e[0].addInstance(t),this.ok&&t.load(),t}renderOpaque(e,t,i){}renderTranslucent(e,t,i){}addView(){let e=new this.handler.View(this);return this.views.push(e),e}removeView(e){let t=this.views;t.splice(t.indexOf(e),1)}viewChanged(e,t){for(let r of this.views)if(r.equals(t))return void r.addInstance(e);let i=this.addView();i.applyShallowCopy(t),i.addInstance(e),e.scene&&e.scene.addView(i)}lateLoad(){for(let e of this.instances)e.load();for(let e of this.views)e.lateLoad()}}class wf extends yf{bindTexture(e,t,i){let r=this.viewer,n=i.textures;n.has(e)&&(e=n.get(e)),e?e.bind(t):r.webgl.bindTexture(null,t)}}class Sf extends wf{load(e){const t=this.viewer.gl;let i=e.geometry,r=e.material,n=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,i.vertices,t.STATIC_DRAW);let s=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,s),t.bufferData(t.ARRAY_BUFFER,i.uvs,t.STATIC_DRAW);let a=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a),t.bufferData(t.ELEMENT_ARRAY_BUFFER,i.faces,t.STATIC_DRAW);let o=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,o),t.bufferData(t.ELEMENT_ARRAY_BUFFER,i.edges,t.STATIC_DRAW),this.boundingRadius=i.boundingRadius,this.vertexArray=i.vertices,this.uvArray=i.uvs,this.faceArray=i.faces,this.edgeArray=i.edges,this.vertexBuffer=n,this.uvBuffer=s,this.faceBuffer=a,this.edgeBuffer=o;let l=i.faces.BYTES_PER_ELEMENT;this.faceIndexType=1===l?t.UNSIGNED_BYTE:2===l?t.UNSIGNED_SHORT:t.UNSIGNED_INT,l=i.edges.BYTES_PER_ELEMENT,this.edgeIndexType=1===l?t.UNSIGNED_BYTE:2===l?t.UNSIGNED_SHORT:t.UNSIGNED_INT,this.texture=r.texture,this.twoSided=r.twoSided||!1,this.noDepthTest=r.noDepthSet||!1,this.noDepthSet=r.noDepthSet||!1,this.uvScale=r.uvScale||new Float32Array([1,1]),this.uvOffset=r.uvOffset||new Float32Array(2),this.vertexColor=r.vertexColor||new Float32Array([255,255,255,255]),this.edgeColor=r.edgeColor||new Float32Array([255,255,255,255]),this.renderMode=0,r.renderMode>0&&(this.renderMode=r.renderMode),this.isBGR=r.isBGR||!1,this.isBlended=r.isBlended||!1,this.isBlended?this.translucent=!0:this.opaque=!0}render(e,t,i){let r=this.viewer.webgl,n=this.viewer.gl,s=r.extensions.instancedArrays,a=this.viewer.shaderMap.get("GeoStandardShader"),o=a.uniforms,l=a.attribs;r.useShaderProgram(a),n.uniformMatrix4fv(o.u_mvp,!1,t.camera.worldProjectionMatrix),n.activeTexture(n.TEXTURE15),n.bindTexture(n.TEXTURE_2D,e.boneTexture),n.uniform1i(o.u_boneMap,15),n.uniform1f(o.u_vectorSize,e.vectorSize),n.uniform1f(o.u_rowSize,e.rowSize);let h=l.a_InstanceID;n.bindBuffer(n.ARRAY_BUFFER,e.instanceIdBuffer),n.vertexAttribPointer(h,1,n.UNSIGNED_SHORT,!1,2,0),s.vertexAttribDivisorANGLE(h,1),n.bindBuffer(n.ARRAY_BUFFER,this.vertexBuffer),n.vertexAttribPointer(l.a_position,3,n.FLOAT,!1,12,0),n.bindBuffer(n.ARRAY_BUFFER,this.uvBuffer),n.vertexAttribPointer(l.a_uv,2,n.FLOAT,!1,8,0),this.twoSided?n.disable(n.CULL_FACE):n.enable(n.CULL_FACE),this.noDepthTest?n.disable(n.DEPTH_TEST):n.enable(n.DEPTH_TEST),this.noDepthSet?n.depthMask(0):n.depthMask(1),this.isBlended?(n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA)):n.disable(n.BLEND),n.uniform1i(o.u_texture,0);let c=l.a_color;if(s.vertexAttribDivisorANGLE(c,1),0===this.renderMode||2===this.renderMode){let t=i.textures.get(null)||this.texture;r.bindTexture(t,0);let a=o.u_hasTexture;t?n.uniform1f(a,1):n.uniform1f(a,0),n.uniform1f(o.u_isEdge,0),n.uniform2fv(o.u_uvScale,this.uvScale),n.uniform2fv(o.u_uvOffset,this.uvOffset),n.uniform1f(o.u_isBGR,this.isBGR),n.uniform1f(o.u_alphaMod,this.alpha),n.bindBuffer(n.ARRAY_BUFFER,e.vertexColorBuffer),n.vertexAttribPointer(c,4,n.UNSIGNED_BYTE,!0,0,0),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this.faceBuffer),s.drawElementsInstancedANGLE(n.TRIANGLES,this.faceArray.length,this.faceIndexType,0,e.count)}1!==this.renderMode&&2!==this.renderMode||(n.uniform1f(o.u_isEdge,1),n.bindBuffer(n.ARRAY_BUFFER,e.edgeColorBuffer),n.vertexAttribPointer(c,4,n.UNSIGNED_BYTE,!0,0,0),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this.edgeBuffer),s.drawElementsInstancedANGLE(n.LINES,this.edgeArray.length,this.edgeIndexType,0,e.count)),s.vertexAttribDivisorANGLE(h,0),s.vertexAttribDivisorANGLE(c,0)}renderBuckets(e){let t=e.scene,i=e.buckets,r=e.modelView;for(let n=0,s=e.usedBuckets;n<s;n++)this.render(i[n],t,r)}renderOpaque(e){this.opaque&&this.renderBuckets(e)}renderTranslucent(e){this.translucent&&this.renderBuckets(e)}}class Rf{constructor(e){let t=e.model,i=t.viewer.gl;this.modelView=e,this.model=t,this.count=0,this.instanceIdBuffer=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,this.instanceIdBuffer),i.bufferData(i.ARRAY_BUFFER,new Uint16Array(t.batchSize).map((e,t,i)=>t),i.STATIC_DRAW)}fill(e,t,i){return e.instances.length}}class bf extends Rf{constructor(e){super(e);const t=this.model.viewer.gl;this.gl=t;let i=this.model.batchSize;this.boneArrayInstanceSize=16,this.boneArray=new Float32Array(this.boneArrayInstanceSize*i),this.boneTexture=t.createTexture(),this.boneTextureWidth=4,this.boneTextureHeight=i,this.vectorSize=1/this.boneTextureWidth,this.rowSize=1/this.boneTextureHeight,t.activeTexture(t.TEXTURE15),t.bindTexture(t.TEXTURE_2D,this.boneTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA32F,this.boneTextureWidth,this.boneTextureHeight,0,t.RGBA,t.FLOAT,this.boneArray),this.vertexColorArray=new Uint8Array(4*i),this.vertexColorBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.vertexColorBuffer),t.bufferData(t.ARRAY_BUFFER,this.vertexColorArray,t.DYNAMIC_DRAW),this.edgeColorArray=new Uint8Array(4*i),this.edgeColorBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.edgeColorBuffer),t.bufferData(t.ARRAY_BUFFER,this.edgeColorArray,t.DYNAMIC_DRAW)}fill(e){let t=e.baseIndex,i=this.model,r=i.viewer.gl,n=i.batchSize,s=this.boneArray,a=this.vertexColorArray,o=this.edgeColorArray,l=0,h=e.instances;for(let c=h.length;t<c&&l<n;t++){let e=h[t];if(e.rendered&&!e.culled){let t=e.worldMatrix,i=e.vertexColor,r=e.edgeColor,n=16*l;s[n]=t[0],s[n+1]=t[1],s[n+2]=t[2],s[n+3]=t[3],s[n+4]=t[4],s[n+5]=t[5],s[n+6]=t[6],s[n+7]=t[7],s[n+8]=t[8],s[n+9]=t[9],s[n+10]=t[10],s[n+11]=t[11],s[n+12]=t[12],s[n+13]=t[13],s[n+14]=t[14],s[n+15]=t[15],a[4*l]=i[0],a[4*l+1]=i[1],a[4*l+2]=i[2],a[4*l+3]=i[3],o[4*l]=r[0],o[4*l+1]=r[1],o[4*l+2]=r[2],o[4*l+3]=r[3],l+=1}}return this.count=l,l&&(r.activeTexture(r.TEXTURE15),r.bindTexture(r.TEXTURE_2D,this.boneTexture),r.texSubImage2D(r.TEXTURE_2D,0,0,0,this.boneTextureWidth,l,r.RGBA,r.FLOAT,s),r.bindBuffer(r.ARRAY_BUFFER,this.vertexColorBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,this.vertexColorArray),r.bindBuffer(r.ARRAY_BUFFER,this.edgeColorBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,this.edgeColorArray)),t}}class If extends Kr{constructor(e){super(),this.modelView=null,this.model=e,this.paused=!1,this.rendered=!0,this.culled=!1,this.noCulling=!1,this.bounds=null}show(){this.rendered=!0}hide(){this.rendered=!1}shown(){return this.rendered}hidden(){return!this.rendered}detach(){return!!this.scene&&this.scene.removeInstance(this)}load(e){}updateTimers(){}updateAnimations(){}clearEmittedObjects(){}updateObject(e){if(!this.paused&&this.model.ok&&(this.updateTimers(),this.rendered)){let t=e.isVisible(this)||this.noCulling||this.model.viewer.noCulling;this.culled=!t,t&&this.updateAnimations()}}setScene(e){return e.addInstance(this)}}class Lf extends If{setTexture(e,t){let i=this.modelView.getShallowCopy();i.textures.set(e,t),this.model.viewChanged(this,i)}}class Nf extends Lf{constructor(e){super(e),this.vertexColor=new Uint8Array(4),this.edgeColor=new Uint8Array(4)}load(){this.setVertexColor(this.model.vertexColor),this.setEdgeColor(this.model.edgeColor)}setVertexColor(e){return this.vertexColor.set(e),this}setEdgeColor(e){return this.edgeColor.set(e),this}}var xf="\n    attribute float a_InstanceID;\n  ",Pf="\n    uniform sampler2D u_boneMap;\n    uniform float u_vectorSize;\n    uniform float u_rowSize;\n\n    mat4 fetchMatrix(float column, float row) {\n      column *= u_vectorSize * 4.0;\n      row *= u_rowSize;\n      // Add in half texel to sample in the middle of the texel.\n      // Otherwise, since the sample is directly on the boundry, small floating point errors can cause the sample to get the wrong pixel.\n      // This is mostly noticable with NPOT textures, which the bone maps are.\n      column += 0.5 * u_vectorSize;\n      row += 0.5 * u_rowSize;\n\n      return mat4(texture2D(u_boneMap, vec2(column, row)),\n                  texture2D(u_boneMap, vec2(column + u_vectorSize, row)),\n                  texture2D(u_boneMap, vec2(column + u_vectorSize * 2.0, row)),\n                  texture2D(u_boneMap, vec2(column + u_vectorSize * 3.0, row)));\n    }\n  ",Cf="\n    vec2 decodeFloat2(float f) {\n      vec2 v;\n\n      v[1] = floor(f / 256.0);\n      v[0] = floor(f - v[1] * 256.0);\n\n      return v;\n    }\n\n    vec3 decodeFloat3(float f) {\n      vec3 v;\n\n      v[2] = floor(f / 65536.0);\n      v[1] = floor((f - v[2] * 65536.0) / 256.0);\n      v[0] = floor(f - v[2] * 65536.0 - v[1] * 256.0);\n\n      return v;\n    }\n\n    vec4 decodeFloat4(float v) {\n      vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n      enc = fract(enc);\n      enc -= enc.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n      return enc;\n    }\n  ",Uf="\n    // A 2D quaternion*vector.\n    // q is the zw components of the original quaternion.\n    vec2 quat_transform(vec2 q, vec2 v) {\n      vec2 uv = vec2(-q.x * v.y, q.x * v.x);\n      vec2 uuv = vec2(-q.x * uv.y, q.x * uv.x);\n\n      return v + 2.0 * (uv * q.y + uuv);\n    }\n\n    // A 2D quaternion*vector.\n    // q is the zw components of the original quaternion.\n    vec3 quat_transform(vec2 q, vec3 v) {\n      return vec3(quat_transform(q, v.xy), v.z);\n    }\n  ",Of={vs:"\n    ".concat(xf,"\n    ").concat(Pf,"\n    uniform mat4 u_mvp;\n    uniform vec2 u_uvOffset;\n    uniform vec2 u_uvScale;\n\n    attribute vec3 a_position;\n    attribute vec2 a_uv;\n    attribute vec2 a_uvScale;\n    attribute vec4 a_color;\n\n    varying vec2 v_uv;\n    varying vec4 v_color;\n\n    void main() {\n      v_uv = a_uv * u_uvScale + u_uvOffset;\n      v_color = a_color;\n\n      gl_Position = u_mvp * fetchMatrix(0.0, a_InstanceID) * vec4(a_position, 1.0);\n    }\n  "),ps:"\n    uniform sampler2D u_diffuseMap;\n    uniform float u_alphaMod;\n    uniform bool u_isEdge;\n    uniform bool u_hasTexture;\n    uniform bool u_isBGR;\n\n    varying vec2 v_uv;\n    varying vec4 v_color;\n\n    void main() {\n      gl_FragColor = v_color;\n\n      if (u_hasTexture && !u_isEdge) {\n        vec4 texel = texture2D(u_diffuseMap, v_uv);\n\n        if (u_isBGR) {\n          texel = texel.bgra;\n        }\n\n        gl_FragColor *= texel;\n      } \n    }\n  "},Df={install:e=>e.loadShader("GeoStandardShader",Of.vs,Of.ps).ok,extensions:[[".geo"]],Constructor:Sf,View:class extends vf{update(e){let t=super.update(e);if(t){let e=2===this.model.renderMode?2:1,i=t.buckets,r=0,n=0,s=0;for(let a=0,o=t.usedBuckets;a<o;a++)r+=i[a].count,n+=1,s+=e;this.renderedInstances=r,this.renderedBuckets=n,this.renderCalls=s}}},Bucket:bf,Instance:Nf},Mf={handler:Df,Model:Sf,ModelInstance:Nf,Bucket:bf};const Ff=e=>(class{constructor(e,t,i,r,n){let s=e.defval;this.sd=e,this.start=t,this.end=i,this.keyframes=[],n&&r[0].frame>i&&this.keyframes.push(r[0]);for(let o=0,l=r.length;o<l;o++){let e=r[o],n=e.frame;n>=t&&n<=i&&this.keyframes.push(e)}let a=this.keyframes.length;if(0===a)this.constant=!0,this.keyframes.push({frame:t,value:s,inTan:s,outTan:s});else if(1===a)this.constant=!0;else{let e=!0,r=this.keyframes[0].value;for(let t=1,i=this.keyframes.length;t<i;t++){let i=this.keyframes[t].value;if(i.length>0){for(let t=0,n=i.length;t<n;t++)if(r[t]!==i[t]){e=!1;break}}else if(i!==r){e=!1;break}}e?this.constant=!0:(this.constant=!1,this.keyframes[0].frame!==t&&this.keyframes.unshift({frame:t,value:s,inTan:s,outTan:s}),this.keyframes[this.keyframes.length-1].frame!==i&&this.keyframes.push({frame:i,value:this.keyframes[0].value,inTan:this.keyframes[0].outTan,outTan:this.keyframes[0].inTan}))}}getValue(t,i){let r=this.keyframes,n=this.getKeyframe(i),s=r.length;if(-1===n)return t.set(r[0].value),0;if(n===s)return t.set(r[s-1].value),s-1;{let s=r[n-1],h=r[n],c=(a=(i-s.frame)/(h.frame-s.frame),o=0,l=1,Math.min(Math.max(a,o),l));return e(t,s.value,s.outTan,h.inTan,h.value,c,this.sd.interpolationType),n}var a,o,l}getKeyframe(e){if(this.constant)return-1;{let t=this.keyframes,i=t.length;if(e<this.start)return-1;if(e>=this.end)return i;for(let r=1;r<i;r++){if(t[r].frame>e)return r}}}}),Bf={KLAV:0,KATV:0,KPEV:0,KP2V:0,KRVS:0},Vf={KMTF:[0],KMTA:[1],KTAT:[0,0,0],KTAR:[0,0,0,1],KTAS:[1,1,1],KGAO:[1],KGAC:[0,0,0],KLAS:[0],KLAE:[0],KLAC:[0,0,0],KLAI:[0],KLBI:[0],KLBC:[0,0,0],KLAV:[1],KATV:[1],KPEE:[0],KPEG:[0],KPLN:[0],KPLT:[0],KPEL:[0],KPES:[0],KPEV:[1],KP2S:[0],KP2R:[0],KP2L:[0],KP2G:[0],KP2E:[0],KP2N:[0],KP2W:[0],KP2V:[1],KRHA:[0],KRHB:[0],KRAL:[1],KRCO:[0,0,0],KRTX:[0],KRVS:[1],KCTR:[0,0,0],KTTR:[0,0,0],KCRL:[0],KGTR:[0,0,0],KGRT:[0,0,0,1],KGSC:[1,1,1]},kf=e=>(class{constructor(t,i){let r=t.globalSequences,n=i.globalSequenceId,s=i.tracks,a=Bf[i.name];if(this.model=t,this.name=i.name,this.defval=Vf[i.name],this.globalSequence=null,this.sequences=[],this.interpolationType=void 0!==a?a:i.interpolationType,-1!==n&&r)this.globalSequence=new e(this,0,r[n],s,!0);else for(let o of t.sequences)this.sequences.push(new e(this,...o.interval,s,!1))}getValue(e,t){return this.globalSequence?this.globalSequence.getValue(e,t.counter%this.globalSequence.end):-1!==t.sequence?this.sequences[t.sequence].getValue(e,t.frame):(e.set(this.defval),-1)}isVariant(e){return this.globalSequence?!this.globalSequence.constant:!this.sequences[e].constant}getValues(){if(this.globalSequence)return this.globalSequence.keyframes.map(e=>e.value);{let e=[];for(let t of this.sequences)e.push(...t.keyframes.map(e=>e.value));return e}}}),Gf=kf(Ff(function(e,t,i,r,n,s,a){return 0===a?e[0]=t[0]:1===a?e[0]=cr(t[0],n[0],s):2===a?e[0]=function(e,t,i,r,n){let s=n*n;return e*(s*(2*n-3)+1)+t*(s*(n-2)+n)+i*(s*(n-1))+r*(s*(3-2*n))}(t[0],i[0],r[0],n[0],s):3===a&&(e[0]=function(e,t,i,r,n){let s=1-n,a=n*n,o=s*s;return e*(o*s)+t*(3*n*o)+i*(3*a*s)+r*(a*n)}(t[0],i[0],r[0],n[0],s)),e})),jf=kf(Ff(function(e,t,i,r,n,s,a){return 0===a?ar.vec3.copy(e,t):1===a?ar.vec3.lerp(e,t,n,s):2===a?ar.vec3.hermite(e,t,i,r,n,s):3===a&&ar.vec3.bezier(e,t,i,r,n,s),e})),Yf=kf(Ff(function(e,t,i,r,n,s,a){return 0===a?ar.quat.copy(e,t):1===a?ar.quat.slerp(e,t,n,s):2!==a&&3!==a||ar.quat.sqlerp(e,t,i,r,n,s),e}));function Hf(e,t){let i;return t instanceof Ci||t instanceof Ui?i=Gf:t instanceof Oi?i=jf:t instanceof Di&&(i=Yf),new i(e,t)}class Wf{constructor(e,t){this.model=e,this.animations={};for(let i of t.animations)this.animations[i.name]=Hf(e,i)}getValues(e){let t=this.animations[e];return t?t.getValues():[]}getUintValue(e,t,i,r){let n=this.animations[t];return n?n.getValue(e,i):(e[0]=r,-1)}getFloatValue(e,t,i,r){let n=this.animations[t];return n?n.getValue(e,i):(e[0]=r,-1)}getVector3Value(e,t,i,r){let n=this.animations[t];return n?n.getValue(e,i):(ar.vec3.copy(e,r),-1)}getVector4Value(e,t,i,r){let n=this.animations[t];return n?n.getValue(e,i):(ar.quat.copy(e,r),-1)}isVariant(e,t){let i=this.animations[e];return!!i&&i.isVariant(t)}}class Kf extends Wf{getTranslation(e,t){return this.getVector3Value(e,"KTAT",t,Lr)}getRotation(e,t){return this.getVector4Value(e,"KTAR",t,xr)}getScale(e,t){return this.getVector3Value(e,"KTAS",t,Nr)}isTranslationVariant(e){return this.isVariant("KTAT",e)}isRotationVariant(e){return this.isVariant("KTAR",e)}isScaleVariant(e){return this.isVariant("KTAS",e)}}function zf(e){return e.reverse().filter((e,t,i)=>-1===i.indexOf(e,t+1)).reverse()}function qf(e,t){return 0===e?[t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA]:1===e?[t.SRC_ALPHA,t.ONE]:2===e?[t.ZERO,t.SRC_COLOR]:3===e?[t.DEST_COLOR,t.SRC_COLOR]:4===e?[t.SRC_ALPHA,t.ONE]:void 0}class Xf extends Wf{constructor(e,t,i,r){let n=t.filterMode,s=t.textureAnimationId,a=e.viewer.gl;super(e,t),this.index=i,this.priorityPlane=r,this.filterMode=n,this.textureId=t.textureId,this.coordId=t.coordId,this.alpha=t.alpha;let o=t.flags;if(this.unshaded=1&o,this.sphereEnvironmentMap=2&o,this.twoSided=16&o,this.unfogged=32&o,this.noDepthTest=64&o,this.noDepthSet=128&o,this.depthMaskValue=0===n||1===n?1:0,this.alphaTestValue=1===n?1:0,this.blendSrc=0,this.blendDst=0,this.blended=n>1,this.blended&&([this.blendSrc,this.blendDst]=function(e,t){return 2===e?[t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA]:3===e?[t.ONE,t.ONE]:4===e?[t.SRC_ALPHA,t.ONE]:5===e?[t.ZERO,t.SRC_COLOR]:6===e?[t.DST_COLOR,t.SRC_COLOR]:[0,0]}(n,a)),this.uvDivisor=new Float32Array([1,1]),-1!==s){let t=e.textureAnimations[s];t&&(this.textureAnimation=t)}let l={alpha:[],slot:[],translation:[],rotation:[],scale:[]},h=!1,c=!1,d=!1,u=!1;for(let m=0,f=e.sequences.length;m<f;m++){let e=this.isAlphaVariant(m),t=this.isTextureIdVariant(m),i=this.isTranslationVariant(m),r=this.isRotationVariant(m),n=this.isScaleVariant(m);l.alpha[m]=e,l.slot[m]=t,l.translation[m]=i,l.rotation[m]=r,l.scale[m]=n,h=h||t,c=c||i,d=d||r,u=u||n}if(this.variants=l,this.hasSlotAnim=h,this.hasTranslationAnim=c,this.hasRotationAnim=d,this.hasScaleAnim=u,this.animations.KMTF){let t=zf(this.animations.KMTF.getValues());if(t.length>1){let i=Ar(t.join("")),r=[];for(let s=0,a=t.length;s<a;s++)r[s]=e.textures[t[s]];let n=e.viewer.loadTextureAtlas(i,r);n.texture.whenLoaded().then(()=>{let t=n.texture;t.wrapS=!0,t.wrapT=!0,e.textures.push(t),this.textureId=e.textures.length-1,this.uvDivisor.set([n.columns,n.rows])})}}}bind(e){let t=this.model.viewer.gl;t.uniform1f(e.uniforms.u_alphaTest,this.alphaTestValue),this.blended?(t.enable(t.BLEND),t.blendFunc(this.blendSrc,this.blendDst)):t.disable(t.BLEND),this.twoSided?t.disable(t.CULL_FACE):t.enable(t.CULL_FACE),this.noDepthTest?t.disable(t.DEPTH_TEST):t.enable(t.DEPTH_TEST),this.noDepthSet?t.depthMask(0):t.depthMask(this.depthMaskValue)}getAlpha(e,t){return this.getFloatValue(e,"KMTA",t,this.alpha)}getTextureId(e,t){return this.getUintValue(e,"KMTF",t,this.textureId)}getTranslation(e,t){return this.textureAnimation?this.textureAnimation.getTranslation(e,t):(ar.vec3.copy(e,Lr),-1)}getRotation(e,t){return this.textureAnimation?this.textureAnimation.getRotation(e,t):(ar.quat.copy(e,xr),-1)}getScale(e,t){return this.textureAnimation?this.textureAnimation.getScale(e,t):(ar.vec3.copy(e,Nr),-1)}isAlphaVariant(e){return this.isVariant("KMTA",e)}isTextureIdVariant(e){return this.isVariant("KMTF",e)}isTranslationVariant(e){return this.textureAnimation&&this.textureAnimation.isTranslationVariant(e)}isRotationVariant(e){return this.textureAnimation&&this.textureAnimation.isRotationVariant(e)}isScaleVariant(e){return this.textureAnimation&&this.textureAnimation.isScaleVariant(e)}}class Jf extends Wf{constructor(e,t){super(e,t),this.alpha=t.alpha,this.color=[...t.color].reverse(),this.geosetId=t.geosetId}getAlpha(e,t){return this.getFloatValue(e,"KGAO",t,1)}getColor(e,t){return this.getVector3Value(e,"KGAC",t,this.color)}isAlphaVariant(e){return this.isVariant("KGAO",e)}isColorVariant(e){return this.isVariant("KGAC",e)}}class Qf{constructor(e,t,i,r){this.model=e,this.offsets=t,this.uvSetSize=i,this.elements=r}bind(e,t){let i=this.model.viewer.gl,r=this.offsets,n=e.attribs;i.vertexAttribPointer(n.a_position,3,i.FLOAT,!1,12,r[0]),i.vertexAttribPointer(n.a_normal,3,i.FLOAT,!1,12,r[1]),i.vertexAttribPointer(n.a_uv,2,i.FLOAT,!1,8,r[2]+t*this.uvSetSize),i.vertexAttribPointer(n.a_bones,4,i.UNSIGNED_BYTE,!1,4,r[3]),i.vertexAttribPointer(n.a_boneNumber,1,i.UNSIGNED_BYTE,!1,4,r[4])}render(e){let t=this.model.viewer.gl;t.extensions.instancedArrays.drawElementsInstancedANGLE(t.TRIANGLES,this.elements,t.UNSIGNED_SHORT,this.offsets[5],e)}}class $f{constructor(e,t,i){let r,n=t.vertices,s=t.normals,a=t.uvSets,o=a[0].length,l=n.length/3,h=new Uint8Array(4*l),c=new Uint32Array(l),d=t.vertexGroups,u=t.matrixGroups,m=t.matrixIndices,f=[];if(a.length>1){r=new Float32Array(a.length*o);for(let e=0,t=a.length;e<t;e++)r.set(a[e],e*o)}else r=a[0];for(let A=0,_=u.length,T=0;A<_;A++)f.push(m.subarray(T,T+u[A])),T+=u[A];for(let A=0;A<l;A++){if(f[d[A]]){let e=f[d[A]],t=Math.min(e.length,4);for(let i=0;i<t;i++)h[4*A+i]=e[i]+1;c[A]=t}}this.index=i,this.materialId=t.materialId,this.locationArray=n,this.normalArray=s,this.uvsArray=r,this.boneIndexArray=h,this.boneNumberArray=c,this.faceArray=t.faces,this.uvSetSize=4*o;let p=e.geosetAnimations;for(let A=0,_=p.length;A<_;A++)p[A].geosetId===i&&(this.geosetAnimation=p[A]);let E={alpha:[],color:[]},g=!1;for(let A=0,_=e.sequences.length;A<_;A++){let e=this.isAlphaVariant(A),t=this.isColorVariant(A);(e||t)&&(g=!0),E.alpha[A]=e,E.color[A]=t}this.variants=E,this.hasAnim=g}getAlpha(e,t){return this.geosetAnimation?this.geosetAnimation.getAlpha(e,t):(e[0]=1,-1)}getColor(e,t){return this.geosetAnimation?this.geosetAnimation.getColor(e,t):(ar.vec3.copy(e,Nr),-1)}isAlphaVariant(e){return this.geosetAnimation&&this.geosetAnimation.isAlphaVariant(e)}isColorVariant(e){return this.geosetAnimation&&this.geosetAnimation.isColorVariant(e)}}class Zf{constructor(e,t,i){this.index=e,this.layer=t,this.geoset=i}}var ep={1:"TeamColor/TeamColor00",2:"TeamGlow/TeamGlow00",11:"Cliff/Cliff0",21:"",31:"LordaeronTree/LordaeronSummerTree",32:"AshenvaleTree/AshenTree",33:"BarrensTree/BarrensTree",34:"NorthrendTree/NorthTree",35:"Mushroom/MushroomTree",36:"RuinsTree/RuinsTree",37:"OutlandMushroomTree/MushroomTree"};class tp extends Wf{constructor(e,t,i){super(e,t),this.index=i,this.name=t.name,this.objectId=t.objectId,this.parentId=t.parentId,this.pivot=e.pivotPoints[t.objectId]||ar.vec3.create();let r=t.flags;this.dontInheritTranslation=1&r,this.dontInheritRotation=2&r,this.dontInheritScaling=4&r,this.billboarded=8&r,this.billboardedX=16&r,this.billboardedY=32&r,this.billboardedZ=64&r,this.cameraAnchored=128&r,this.bone=256&r,this.light=512&r,this.eventObject=1024&r,this.attachment=2048&r,this.particleEmitter=4096&r,this.collisionShape=8192&r,this.ribbonEmitter=16384&r,this.emitterUsesMdlOrUnshaded=32768&r,this.emitterUsesTgaOrSortPrimitivesFarZ=65536&r,this.lineEmitter=131072&r,this.unfogged=262144&r,this.modelSpace=524288&r,this.xYQuad=1048576&r,this.anyBillboarding=this.billboarded||this.billboardedX||this.billboardedY||this.billboardedZ,t.objectId===t.parentId&&(this.parentId=-1);let n={translation:[],rotation:[],scale:[],generic:[]};for(let s=0,a=e.sequences.length;s<a;s++){let e=this.isTranslationVariant(s),t=this.isRotationVariant(s),i=this.isScaleVariant(s);n.translation[s]=e,n.rotation[s]=t,n.scale[s]=i,n.generic[s]=e||t||i}this.variants=n}getVisibility(e,t){return e[0]=1,-1}getTranslation(e,t){return this.getVector3Value(e,"KGTR",t,Lr)}getRotation(e,t){return this.getVector4Value(e,"KGRT",t,xr)}getScale(e,t){return this.getVector3Value(e,"KGSC",t,Nr)}isTranslationVariant(e){return this.isVariant("KGTR",e)}isRotationVariant(e){return this.isVariant("KGRT",e)}isScaleVariant(e){return this.isVariant("KGSC",e)}}class ip extends tp{constructor(e,t,i){super(e,t,i),this.geosetAnimation=e.geosetAnimations[t.geosetAnimationId]}getVisibility(e,t){return this.geosetAnimation?this.geosetAnimation.getAlpha(e,t):(e[0]=1,-1)}}class rp extends tp{constructor(e,t,i){super(e,t,i),this.type=t.type,this.attenuation=t.attenuation,this.color=t.color,this.intensity=t.intensity,this.ambientColor=t.ambientColor,this.ambientIntensity=t.ambientIntensity}getAttenuationStart(e,t){return this.getFloatValue(e,"KLAS",t,this.attenuation[0])}getAttenuationEnd(e,t){return this.getFloatValue(e,"KLAE",t,this.attenuation[1])}getIntensity(e,t){return this.getFloatValue(e,"KLAI",t,this.intensity)}getColor(e,t){return this.getVector3Value(e,"KLAC",t,this.color)}getAmbientIntensity(e,t){return this.getFloatValue(e,"KLBI",t,this.ambientIntensity)}getAmbientColor(e,t){return this.getVector3Value(e,"KLBC",t,this.ambientColor)}}class np extends tp{}class sp extends tp{constructor(e,t,i){super(e,t,i);let r=t.path.replace(/\\/g,"/").toLowerCase().replace(".mdl",".mdx");this.path=r,this.attachmentId=t.attachmentId,""!==r&&-1!==r.indexOf(".mdx")&&(this.internalModel=e.viewer.load(r,e.pathSolver))}getVisibility(e,t){return this.getFloatValue(e,"KATV",t,1)}}class ap extends tp{constructor(e,t,i){super(e,t,i),this.internalResource=e.viewer.load(t.path.replace(/\\/g,"/").toLowerCase().replace(".mdl",".mdx"),e.pathSolver),this.speed=t.speed,this.latitude=t.latitude,this.longitude=t.longitude,this.lifeSpan=t.lifeSpan,this.gravity=t.gravity,this.emissionRate=t.emissionRate}getSpeed(e,t){return this.getFloatValue(e,"KPES",t,this.speed)}getLatitude(e,t){return this.getFloatValue(e,"KPLTV",t,this.latitude)}getLongitude(e,t){return this.getFloatValue(e,"KPLN",t,this.longitude)}getLifeSpan(e,t){return this.getFloatValue(e,"KPEL",t,this.lifeSpan)}getGravity(e,t){return this.getFloatValue(e,"KPEG",t,this.gravity)}getEmissionRate(e,t){return this.getFloatValue(e,"KPEE",t,this.emissionRate)}getVisibility(e,t){return this.getFloatValue(e,"KPEV",t,1)}}class op extends tp{constructor(e,t,i){super(e,t,i),this.width=t.width,this.length=t.length,this.speed=t.speed,this.latitude=t.latitude,this.gravity=t.gravity,this.emissionRate=t.emissionRate,this.squirt=t.squirt,this.lifeSpan=t.lifeSpan,this.variation=t.variation,this.tailLength=t.tailLength,this.timeMiddle=t.timeMiddle;let r=t.replaceableId;this.dimensions=[t.columns,t.rows],this.teamColored=!1,0===r?this.internalResource=e.textures[t.textureId]:1===r?(this.internalResource=e.viewer.getTextureAtlas("teamColors"),this.dimensions.fill(4),this.teamColored=!0):2===r?(this.internalResource=e.viewer.getTextureAtlas("teamGlows"),this.dimensions.fill(4),this.teamColored=!0):this.internalResource=e.viewer.load("ReplaceableTextures\\"+ep[r]+".blp",e.pathSolver),this.replaceableId=t.replaceableId;let n=t.headOrTail;this.head=0===n||2===n,this.tail=1===n||2===n,this.cellWidth=1/t.columns,this.cellHeight=1/t.rows,this.colors=[];let s=t.segmentColors,a=t.segmentAlphas;for(let o=0;o<3;o++)this.colors[o]=new Uint8Array([255*Math.min(s[o][0],1),255*Math.min(s[o][1],1),255*Math.min(s[o][2],1),a[o]]);this.scaling=t.segmentScaling,this.intervals=[...t.headIntervals,...t.tailIntervals],this.lineEmitter=131072&t.flags,this.modelSpace=524288&t.flags,this.xYQuad=1048576&t.flags,[this.blendSrc,this.blendDst]=qf(t.filterMode,this.model.viewer.gl),this.priorityPlane=t.priorityPlane}getWidth(e,t){return this.getFloatValue(e,"KP2W",t,this.width)}getLength(e,t){return this.getFloatValue(e,"KP2N",t,this.length)}getSpeed(e,t){return this.getFloatValue(e,"KP2S",t,this.speed)}getLatitude(e,t){return this.getFloatValue(e,"KP2L",t,this.latitude)}getGravity(e,t){return this.getFloatValue(e,"KP2G",t,this.gravity)}getEmissionRate(e,t){return this.getFloatValue(e,"KP2E",t,this.emissionRate)}getVisibility(e,t){return this.getFloatValue(e,"KP2V",t,1)}getVariation(e,t){return this.getFloatValue(e,"KP2R",t,this.variation)}}class lp extends tp{constructor(e,t,i){super(e,t,i),this.layer=e.materials[t.materialId][0],this.texture=e.textures[this.layer.textureId],this.heightAbove=t.heightAbove,this.heightBelow=t.heightBelow,this.alpha=t.alpha,this.color=t.color,this.lifeSpan=t.lifeSpan,this.textureSlot=t.textureSlot,this.emissionRate=t.emissionRate,this.gravity=t.gravity,this.dimensions=[t.columns,t.rows],this.cellWidth=1/t.columns,this.cellHeight=1/t.rows}getHeightBelow(e,t){return this.getFloatValue(e,"KRHB",t,this.heightBelow)}getHeightAbove(e,t){return this.getFloatValue(e,"KRHA",t,this.heightAbove)}getTextureSlot(e,t){return this.getUintValue(e,"KRTX",t,0)}getColor(e,t){return this.getVector3Value(e,"KRCO",t,this.color)}getAlpha(e,t){return this.getFloatValue(e,"KRAL",t,this.alpha)}getVisibility(e,t){return this.getFloatValue(e,"KRVS",t,1)}}const hp=ar.vec3.create();class cp extends tp{constructor(e,t,i){super(e,t,i),this.name=t.name,this.position=t.position,this.fieldOfView=t.fieldOfView,this.farClippingPlane=t.farClippingPlane,this.nearClippingPlane=t.nearClippingPlane,this.targetPosition=t.targetPosition}getPositionTranslation(e,t){const i=this.getVector3Value(e,"KCTR",t,hp);return ar.vec3.add(e,e,this.position),i}getTargetTranslation(e,t){const i=this.getVector3Value(e,"KTTR",t,hp);return ar.vec3.add(e,e,this.targetPosition),i}getRotation(e,t){return this.getFloatValue(e,"KCRL",t,0)}}class dp{constructor(e){this.map={},this.load(e)}load(e){if(e)if(e instanceof ArrayBuffer){const t=new TextDecoder("utf-8");let i=new Uint8Array(e);this.loadText(t.decode(i))}else this.loadText(e)}loadText(e){if(e.startsWith("ID;")){let t=new et(e).rows,i=t[0],r=this.map;for(let e=1,n=t.length;e<n;e++){let n=t[e],s=n[0];if(s){r[s=s.toLowerCase()]||(r[s]={});let e=r[s];for(let t=0,r=i.length;t<r;t++){let r=i[t];void 0===r&&(r="column".concat(t)),e[r]=n[t]}}}}else{let t=new $e(e).sections,i=this.map;for(let[e,r]of t.entries()){i[e]||(i[e]={});let t=i[e];for(let[e,i]of r)t[e]=i}}}getRow(e){return this.map[e.toLowerCase()]}getProperty(e,t){return this.map[e.toLowerCase()][t]}setRow(e,t){this.map[e.toLowerCase()]=t}}let up=new OfflineAudioContext(1,1,48e3);let mp=e=>new dp(e),fp=e=>(function(e){return up.decodeAudioData(e)})(e);class pp extends tp{constructor(e,t,i){super(e,t,i);let r=e.viewer,n=t.name,s=n.substring(0,3),a=n.substring(4);"FPT"===s&&(s="SPL"),this.ok=!1,this.type=s,this.id=a,this.internalResource=null,this.decodedBuffers=[],this.tracks=t.tracks,this.ok=!1,this.globalSequence=null,this.defval=ar.vec2.create();let o=t.globalSequenceId;-1!==o&&(this.globalSequence=e.globalSequences[o]);let l=[],h=e.pathSolver;if("SPN"===s)l[0]=r.loadGeneric(h("Splats\\SpawnData.slk")[0],"text",mp);else if("SPL"===s)l[0]=r.loadGeneric(h("Splats\\SplatData.slk")[0],"text",mp);else if("UBR"===s)l[0]=r.loadGeneric(h("Splats\\UberSplatData.slk")[0],"text",mp);else{if("SND"!==s)return;l[0]=r.loadGeneric(h("UI\\SoundInfo\\AnimLookups.slk")[0],"text",mp),l[1]=r.loadGeneric(h("UI\\SoundInfo\\AnimSounds.slk")[0],"text",mp)}let c=r.promise();Af(l).then(e=>{this.load(e),c.resolve()})}load(e){if(!e[0].ok)return;let t=this.type,i=this.model,r=i.viewer,n=i.pathSolver,s=e[0].data.getRow(this.id);if(s){if("SPN"===t)this.internalResource=r.load(s.Model.replace(".mdl",".mdx"),n);else if("SPL"===t||"UBR"===t)this.internalResource=r.load("replaceabletextures/splats/"+s.file+".blp",n),this.colors=[[s.StartR,s.StartG,s.StartB,s.StartA],[s.MiddleR,s.MiddleG,s.MiddleB,s.MiddleA],[s.EndR,s.EndG,s.EndB,s.EndA]],this.scale=s.Scale,"SPL"===t?(this.dimensions=[s.Columns,s.Rows],this.intervals=[[s.UVLifespanStart,s.UVLifespanEnd,s.LifespanRepeat],[s.UVDecayStart,s.UVDecayEnd,s.DecayRepeat]],this.intervalTimes=[s.Lifespan,s.Decay],this.lifespan=s.Lifespan+s.Decay):(this.dimensions=[1,1],this.intervalTimes=[s.BirthTime,s.PauseTime,s.Decay],this.lifespan=s.BirthTime+s.PauseTime+s.Decay),[this.blendSrc,this.blendDst]=qf(s.BlendMode,r.gl);else if("SND"===t&&r.enableAudio){if(!e[1].ok)return;if(s=e[1].data.getRow(s.SoundLabel)){this.distanceCutoff=s.DistanceCutoff,this.maxDistance=s.MaxDistance,this.minDistance=s.MinDistance,this.pitch=s.Pitch,this.pitchVariance=s.PitchVariance,this.volume=s.Volume;let e=s.FileNames.split(",");Af(e.map(e=>r.loadGeneric(n(s.DirectoryBase+e)[0],"arrayBuffer",fp))).then(e=>{for(let t of e)this.decodedBuffers.push(t.data);this.ok=!0})}}this.internalResource&&this.internalResource.whenLoaded().then(()=>this.ok=!0)}else console.warn("Unknown event object ID",t,this.id)}getValue(e,t){if(this.globalSequence){let i=this.globalSequence;return this.getValueAtTime(e,t.counter%i,0,i)}if(-1!==t.sequence){let i=this.model.sequences[t.sequence].interval;return this.getValueAtTime(e,t.frame,i[0],i[1])}{let t=this.defval;return e[0]=t[0],e[1]=t[1],e}}getValueAtTime(e,t,i,r){let n=this.tracks;if(t<i||t>r)return e[0]=0,e[1]=0,e;for(let s=n.length-1;s>-1;s--){if(n[s]<i)return e[0]=0,e[1]=s,e;if(n[s]<=t)return e[0]=1,e[1]=s,e}return e[0]=0,e[1]=0,e}}class Ep extends tp{}class gp extends wf{constructor(e){super(e),this.parser=null,this.name="",this.extent=null,this.bounds=null,this.sequences=[],this.globalSequences=[],this.materials=[],this.layers=[],this.textures=[],this.textureAnimations=[],this.geosets=[],this.geosetAnimations=[],this.bones=[],this.lights=[],this.helpers=[],this.attachments=[],this.pivotPoints=[],this.particleEmitters=[],this.particleEmitters2=[],this.ribbonEmitters=[],this.cameras=[],this.eventObjects=[],this.collisionShapes=[],this.hasLayerAnims=!1,this.hasGeosetAnims=!1,this.batches=[],this.opaqueBatches=[],this.translucentBatches=[],this.genericObjects=[],this.sortedGenericObjects=[],this.hierarchy=[],this.replaceables=[]}load(e){let t=new nr;t.load(e),this.parser=t,this.name=t.name;let i=t.extent;this.bounds=function(e,t){let i=e[0],r=e[1],n=e[2],s=t[0],a=t[1],o=t[2],l=s-i,h=a-r,c=o-n;return{center:new Float32Array([(i+s)/2,(r+a)/2,(n+o)/2]),radius:Math.sqrt(l*l+h*h+c*c)/2}}(i.min,i.max),this.extent=i;for(let a of t.sequences)this.sequences.push(a);for(let a of t.globalSequences)this.globalSequences.push(a);let r=!1;for(let a of t.textures){let e=a.path,t=a.replaceableId,i=a.flags;if(0!==t&&(e="ReplaceableTextures\\".concat(ep[t],".blp"),1!==t&&2!==t||(r=!0)),!e.endsWith(".blp")&&!e.endsWith(".tga")){let t=e.indexOf(".blp");-1===t&&(t=e.indexOf(".tga")),-1!==t&&(e=e.slice(0,t+4))}this.replaceables.push(t);let n=this.viewer.load(e,this.pathSolver);n.wrapS=!!(1&i),n.wrapT=!!(2&i),this.textures.push(n)}r&&this.loadTeamTextures();for(let a of t.textureAnimations)this.textureAnimations.push(new Kf(this,a));let n=0;for(let a of t.materials){let e=[];for(let t of a.layers){let i=new Xf(this,t,n++,a.priorityPlane);e.push(i),this.layers.push(i),i.hasAnim&&(this.hasLayerAnims=!0)}this.materials.push(e)}for(let a of t.geosetAnimations)this.geosetAnimations.push(new Jf(this,a));if(t.geosets.length){let e=0,i=0,r=[],n=[];for(let s of t.geosets){let t=new $f(this,s,e++);t.hasAnim&&(this.hasGeosetAnims=!0),this.geosets.push(t);for(let e of this.materials[s.materialId]){let s=new Zf(i++,e,t);e.filterMode<2?r.push(s):n.push(s)}}n.sort((e,t)=>e.layer.priorityPlane-t.layer.priorityPlane),this.opaqueBatches.push(...r),this.translucentBatches.push(...n),this.batches.push(...r,...n),this.setupGeosets()}this.pivotPoints=t.pivotPoints;let s=0;for(let a of t.bones)this.bones.push(new ip(this,a,s++));for(let a of t.lights)this.lights.push(new rp(this,a,s++));for(let a of t.helpers)this.helpers.push(new np(this,a,s++));for(let a of t.attachments)this.attachments.push(new sp(this,a,s++));for(let a of t.particleEmitters)this.particleEmitters.push(new ap(this,a,s++));for(let a of t.particleEmitters2)this.particleEmitters2.push(new op(this,a,s++));this.particleEmitters2.sort((e,t)=>e.priorityPlane-t.priorityPlane);for(let a of t.ribbonEmitters)this.ribbonEmitters.push(new lp(this,a,s++));for(let a of t.cameras)this.cameras.push(new cp(this,a,s++));for(let a of t.eventObjects)this.eventObjects.push(new pp(this,a,s++));for(let a of t.collisionShapes)this.collisionShapes.push(new Ep(this,a,s++));this.genericObjects.push(...this.bones,...this.lights,...this.helpers,...this.attachments,...this.particleEmitters,...this.particleEmitters2,...this.ribbonEmitters,...this.cameras,...this.eventObjects,...this.collisionShapes),this.setupHierarchy(-1);for(let a=0,o=this.genericObjects.length;a<o;a++)this.sortedGenericObjects[a]=this.genericObjects[this.hierarchy[a]];this.setupVariants()}loadTeamTextures(){let e=this.viewer;if(!e.getTextureAtlas("teamColors")){let t=this.pathSolver,i=[],r=[];for(let n=0;n<15;n++){let s=(""+n).padStart(2,"0");i[n]=e.load("ReplaceableTextures\\TeamColor\\TeamColor".concat(s,".blp"),t),r[n]=e.load("ReplaceableTextures\\TeamGlow\\TeamGlow".concat(s,".blp"),t)}e.loadTextureAtlas("teamColors",i),e.loadTextureAtlas("teamGlows",r)}}isVariant(e){let t=this.genericObjects;for(let i=0,r=t.length;i<r;i++)if(t[i].variants.generic[e])return!0;return!1}setupVariants(){let e=[];for(let t=0,i=this.sequences.length;t<i;t++)e[t]=this.isVariant(t);this.variants=e}setupGeosets(){let e=this.geosets;if(e.length>0){let t=this.viewer.gl,i=[],r=[],n=0,s=[],a=0;for(let h=0,c=e.length;h<c;h++){let t=e[h],o=t.locationArray,l=t.normalArray,c=t.uvsArray,d=t.boneIndexArray,u=t.boneNumberArray,m=t.faceArray,f=n,p=f+o.byteLength,E=p+l.byteLength,g=E+c.byteLength,A=g+d.byteLength;i[h]=new Qf(this,[f,p,E,g,A,a],t.uvSetSize,m.length),r.push([f,o]),r.push([p,l]),r.push([E,c]),r.push([g,d]),r.push([A,u]),s.push([a,m]),n=A+u.byteLength,a+=m.byteLength}let o=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,o),t.bufferData(t.ARRAY_BUFFER,n,t.STATIC_DRAW);for(let e=0,h=r.length;e<h;e++)t.bufferSubData(t.ARRAY_BUFFER,r[e][0],r[e][1]);let l=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,l),t.bufferData(t.ELEMENT_ARRAY_BUFFER,a,t.STATIC_DRAW);for(let e=0,h=s.length;e<h;e++)t.bufferSubData(t.ELEMENT_ARRAY_BUFFER,s[e][0],s[e][1]);this.__webglArrayBuffer=o,this.__webglElementBuffer=l,this.shallowGeosets=i}}setupHierarchy(e){for(let t=0,i=this.genericObjects.length;t<i;t++){let i=this.genericObjects[t];i.parentId===e&&(this.hierarchy.push(t),this.setupHierarchy(i.objectId))}}bind(e,t){const i=this.viewer.webgl;let r=this.viewer.gl,n=this.viewer.shaderMap.get("MdxStandardShader");i.useShaderProgram(n),this.shader=n;const s=r.extensions.instancedArrays,a=n.attribs,o=n.uniforms;r.uniformMatrix4fv(o.u_mvp,!1,t.camera.worldProjectionMatrix),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this.__webglElementBuffer),r.uniform1i(o.u_texture,0);let l=a.a_teamColor,h=a.a_vertexColor;r.bindBuffer(r.ARRAY_BUFFER,e.colorBuffer),r.vertexAttribPointer(l,1,r.UNSIGNED_BYTE,!1,5,0),r.vertexAttribPointer(h,4,r.UNSIGNED_BYTE,!0,5,1),r.activeTexture(r.TEXTURE15),r.bindTexture(r.TEXTURE_2D,e.boneTexture),r.uniform1i(o.u_boneMap,15),r.uniform1f(o.u_vectorSize,e.vectorSize),r.uniform1f(o.u_rowSize,e.rowSize);let c=a.a_InstanceID;r.bindBuffer(r.ARRAY_BUFFER,e.instanceIdBuffer),r.vertexAttribPointer(c,1,r.UNSIGNED_SHORT,!1,0,0),s.vertexAttribDivisorANGLE(l,1),s.vertexAttribDivisorANGLE(h,1),s.vertexAttribDivisorANGLE(c,1)}unbind(){let e=this.viewer.gl,t=e.extensions.instancedArrays,i=this.shader.attribs;e.depthMask(1),e.disable(e.BLEND),e.enable(e.CULL_FACE),e.enable(e.DEPTH_TEST),t.vertexAttribDivisorANGLE(i.a_teamColor,0),t.vertexAttribDivisorANGLE(i.a_vertexColor,0),t.vertexAttribDivisorANGLE(i.a_InstanceID,0),t.vertexAttribDivisorANGLE(i.a_geosetColor,0),t.vertexAttribDivisorANGLE(i.a_layerAlpha,0),t.vertexAttribDivisorANGLE(i.uvTransRot,0),t.vertexAttribDivisorANGLE(i.uvScaleSprite,0)}renderBatch(e,t){let i,r=this.viewer.gl,n=r.extensions.instancedArrays,s=this.shader,a=this.shader.attribs,o=s.uniforms,l=t.geoset,h=t.layer,c=this.shallowGeosets[l.index],d=this.replaceables[h.textureId];h.bind(s);let u=!1;1===d?(i=this.viewer.getTextureAtlas("teamColors"),u=!0):2===d?(i=this.viewer.getTextureAtlas("teamGlows"),u=!0):i=this.textures[h.textureId],r.uniform1f(o.u_isTeamColor,u),r.uniform1f(o.u_hasSlotAnim,h.hasSlotAnim),r.uniform1f(o.u_hasTranslationAnim,h.hasTranslationAnim),r.uniform1f(o.u_hasRotationAnim,h.hasRotationAnim),r.uniform1f(o.u_hasScaleAnim,h.hasScaleAnim),r.uniform2f(o.u_uvScale,1/h.uvDivisor[0],1/h.uvDivisor[1]),this.bindTexture(i,0,e.modelView);let m=a.a_geosetColor,f=a.a_uvTransRot,p=a.a_uvScaleSprite,E=a.a_layerAlpha;n.vertexAttribDivisorANGLE(m,1),n.vertexAttribDivisorANGLE(f,1),n.vertexAttribDivisorANGLE(p,1),n.vertexAttribDivisorANGLE(E,1),r.bindBuffer(r.ARRAY_BUFFER,e.geosetColorsBuffer),r.vertexAttribPointer(m,4,r.UNSIGNED_BYTE,!0,4,this.batchSize*l.index*4),r.bindBuffer(r.ARRAY_BUFFER,e.layersBuffer),r.vertexAttribPointer(f,4,r.FLOAT,!1,28,7*this.batchSize*h.index*4),r.vertexAttribPointer(p,3,r.FLOAT,!1,28,7*this.batchSize*h.index*4+16),r.vertexAttribPointer(E,1,r.UNSIGNED_BYTE,!0,1,e.layerAlphasData.byteOffset+this.batchSize*h.index),r.bindBuffer(r.ARRAY_BUFFER,this.__webglArrayBuffer),c.bind(s,h.coordId),c.render(e.count)}renderBatches(e,t,i){if(i&&i.length){this.bind(e,t);for(let t=0,r=i.length;t<r;t++)this.renderBatch(e,i[t]);this.unbind()}}renderOpaque(e){let t=e.scene,i=e.buckets;for(let r=0,n=e.usedBuckets;r<n;r++)this.renderBatches(i[r],t,this.opaqueBatches)}renderTranslucent(e){let t=e.scene,i=e.modelView,r=e.buckets,n=e.particleEmitters2,s=e.ribbonEmitters,a=e.eventObjectEmitters;for(let o=0,l=e.usedBuckets;o<l;o++)this.renderBatches(r[o],t,this.translucentBatches);if(n.length||a.length||s.length){let e=this.viewer.webgl,r=this.viewer.gl;r.depthMask(0),r.enable(r.BLEND),r.disable(r.CULL_FACE),r.enable(r.DEPTH_TEST);let o=this.viewer.shaderMap.get("MdxParticleShader");e.useShaderProgram(o),r.uniformMatrix4fv(o.uniforms.u_mvp,!1,t.camera.worldProjectionMatrix),r.uniform1i(o.uniforms.u_texture,0),r.uniform1f(o.uniforms.u_isRibbonEmitter,!1);for(let t=0,s=n.length;t<s;t++)n[t].render(i,o);for(let t=0,n=a.length;t<n;t++)a[t].render(i,o);r.uniform1f(o.uniforms.u_isRibbonEmitter,!0);for(let t=0,n=s.length;t<n;t++)s[t].render(i,o)}}}class Ap{constructor(e){this.modelObject=e,this.objects=[],this.alive=0}emitObject(e,t){let i=this.objects;this.alive===i.length&&i.push(this.createObject());let r=i[this.alive];return this.alive+=1,r.reset(e,t),r}update(){let e=this.objects;for(let t=0;t<this.alive;t++){let i=e[t];i.update(),i.health<=0&&(this.alive-=1,t!==this.alive&&(e[t]=e[this.alive],e[this.alive]=i,t-=1))}this.updateData()}fill(e){let t=e.currentEmission;if(t>=1)for(let i=0;i<t;i+=1,e.currentEmission--)this.emit(e)}updateData(){}render(e,t){}clear(e){for(let t of this.objects)e===t.emitterView.instance&&(t.health=0)}}let _p=ar.quat.create(),Tp=ar.vec3.create(),vp=new Float32Array(1),yp=new Float32Array(1),wp=new Float32Array(1),Sp=new Float32Array(1);class Rp{constructor(e){this.emitter=e,this.emitterView=null,this.internalInstance=e.modelObject.internalResource.addInstance(),this.velocity=ar.vec3.create(),this.gravity=0}reset(e){let t=e.instance,i=t.nodes[this.emitter.modelObject.index],r=this.internalInstance,n=i.worldScale,s=this.velocity;e.getLatitude(vp),e.getLifeSpan(yp),e.getGravity(wp),e.getSpeed(Sp),this.emitterView=e,this.node=i,this.health=yp[0],this.gravity=wp[0]*n[2],ar.quat.identity(_p),ar.quat.rotateZ(_p,_p,hr(-Math.PI,Math.PI)),ar.quat.rotateY(_p,_p,hr(-vp[0],vp[0])),ar.vec3.transformQuat(s,Ir,_p),ar.vec3.transformQuat(s,s,i.worldRotation),ar.vec3.scale(s,s,Sp[0]),ar.vec3.mul(s,s,n),t.scene.addInstance(r),r.setTransformation(i.worldLocation,ar.quat.setAxisAngle(_p,Ir,hr(0,2*Math.PI)),i.worldScale),r.setSequence(0),r.show()}update(){let e=this.internalInstance,t=this.velocity,i=.001*e.model.viewer.frameTime;e.paused=!1,this.health-=i,t[2]-=this.gravity*i,e.move(ar.vec3.scale(Tp,t,i)),this.health<=0&&this.internalInstance.hide()}}class bp extends Ap{emit(e){this.emitObject(e)}createObject(){return new Rp(this)}}class Ip extends Ap{constructor(e){super(e),this.data=new Float32Array(0),this.buffer=e.model.viewer.gl.createBuffer(),this.bufferSize=0}emitObject(e,t){return super.emitObject(e,t)}updateData(){let e=this.objects,t=this.alive,i=t*this.elementsPerEmit;if(this.data.length<i){this.data=new Float32Array(dr(i));let e=this.modelObject.model.viewer.gl;e.bindBuffer(e.ARRAY_BUFFER,this.buffer),e.bufferData(e.ARRAY_BUFFER,this.data.byteLength,e.DYNAMIC_DRAW)}let r=this.data;for(let n=0,s=0;n<t;n+=1,s+=30){let t=e[n],i=t.vertices,a=t.lta,o=t.lba,l=t.rta,h=t.rba,c=t.rgb;r[s+0]=i[0],r[s+1]=i[1],r[s+2]=i[2],r[s+3]=a,r[s+4]=c,r[s+5]=i[3],r[s+6]=i[4],r[s+7]=i[5],r[s+8]=o,r[s+9]=c,r[s+10]=i[6],r[s+11]=i[7],r[s+12]=i[8],r[s+13]=h,r[s+14]=c,r[s+15]=i[0],r[s+16]=i[1],r[s+17]=i[2],r[s+18]=a,r[s+19]=c,r[s+20]=i[6],r[s+21]=i[7],r[s+22]=i[8],r[s+23]=h,r[s+24]=c,r[s+25]=i[9],r[s+26]=i[10],r[s+27]=i[11],r[s+28]=l,r[s+29]=c}}render(e,t){let i=this.modelObject,r=this.alive;if(i.internalResource&&r>0){let n=i.model,s=n.viewer.gl;s.blendFunc(i.blendSrc,i.blendDst),s.uniform2fv(t.uniforms.u_dimensions,i.dimensions),n.bindTexture(i.internalResource,0,e),s.bindBuffer(s.ARRAY_BUFFER,this.buffer),s.bufferSubData(s.ARRAY_BUFFER,0,this.data.subarray(0,30*r)),s.vertexAttribPointer(t.attribs.a_position,3,s.FLOAT,!1,20,0),s.vertexAttribPointer(t.attribs.a_uva_rgb,2,s.FLOAT,!1,20,12),s.drawArrays(s.TRIANGLES,0,6*r)}}}let Lp=ar.quat.create(),Np=ar.vec3.create(),xp=new Uint8Array(4),Pp=new Float32Array(1),Cp=new Float32Array(1),Up=new Float32Array(1),Op=new Float32Array(1),Dp=new Float32Array(1),Mp=new Float32Array(1),Fp=[ar.vec3.create(),ar.vec3.create(),ar.vec3.create(),ar.vec3.create(),ar.vec3.create(),ar.vec3.create()];class Bp{constructor(e){this.emitter=e,this.emitterView=null,this.health=0,this.head=!0,this.location=ar.vec3.create(),this.velocity=ar.vec3.create(),this.gravity=0,this.nodeScale=ar.vec3.create(),this.vertices=new Float32Array(12),this.lta=0,this.lba=0,this.rta=0,this.rba=0,this.rgb=0}reset(e,t){e.getWidth(Pp),e.getLength(Cp),e.getLatitude(Up),e.getVariation(Op),e.getSpeed(Dp),e.getGravity(Mp);let i=this.emitter.modelObject,r=e.instance.nodes[i.index],n=r.pivot,s=r.worldScale,a=.5*Pp[0],o=.5*Cp[0],l=Up[0]*(Math.PI/180);let h=Op[0],c=Dp[0],d=this.location,u=this.velocity;this.emitterView=e,this.node=r,this.health=i.lifeSpan,this.head=t,this.gravity=Mp[0]*s[2],ar.vec3.copy(this.nodeScale,s),d[0]=n[0]+hr(-a,a),d[1]=n[1]+hr(-o,o),d[2]=n[2],i.modelSpace||ar.vec3.transformMat4(d,d,r.worldMatrix),ar.quat.identity(Lp),ar.quat.rotateZ(Lp,Lp,Math.PI/2),ar.quat.rotateY(Lp,Lp,hr(-l,l)),i.lineEmitter||ar.quat.rotateX(Lp,Lp,hr(-l,l)),i.modelSpace||ar.quat.mul(Lp,r.worldRotation,Lp),ar.vec3.transformQuat(u,Ir,Lp),ar.vec3.scale(u,u,c+hr(-h,h)),ar.vec3.mul(u,u,s)}update(){let e=this.emitter.modelObject,t=.001*e.model.viewer.frameTime,i=this.location,r=Np,n=this.velocity;this.health-=t,n[2]-=this.gravity*t,ar.vec3.scaleAndAdd(i,i,n,t),ar.vec3.copy(r,i);let s,a,o,l=(e.lifeSpan-this.health)/e.lifeSpan,h=e.timeMiddle,c=e.intervals,d=this.head;l<h?(s=l/h,a=0,o=d?c[0]:c[2]):(s=(l-h)/(1-h),a=1,o=d?c[1]:c[3]),s=Math.min(s,1);let u,m,f,p,E=o[0],g=o[1],A=o[2],_=e.scaling,T=e.colors,v=cr(_[a],_[a+1],s),y=this.emitterView.instance;if(e.teamColored){let e=y.teamColor;f=(u=e%4)+1,p=(m=e/4|0)+1}else{let t=e.dimensions[0],i=0,r=g-E;r&&(i=E+Math.floor(r*A*s)%r),f=(u=i%t)+1,p=(m=i/t|0)+1}ar.vec4.lerp(xp,T[a],T[a+1],s);let w=xp[3];this.lta=ft(f,p,w),this.lba=ft(u,p,w),this.rta=ft(f,m,w),this.rba=ft(u,m,w),this.rgb=ft(xp[0],xp[1],xp[2]),y.scene;let S,R=y.scene.camera;S=e.xYQuad?R.vectors:R.billboardedVectors;let b=this.vertices,I=this.nodeScale,L=v*I[0],N=v*I[1],x=v*I[2];if(d){e.modelSpace&&ar.vec3.transformMat4(r,r,this.node.worldMatrix);let t=r[0],i=r[1],s=r[2];if(e.xYQuad){let e=Fp[4],t=Fp[5];e[0]=n[0],e[1]=n[1],e[2]=0,ar.vec3.normalize(e,e),t[0]=-e[1],t[1]=e[0],t[2]=0,ar.vec3.add(Fp[2],e,t),ar.vec3.sub(Fp[1],t,e),ar.vec3.negate(Fp[0],Fp[2]),ar.vec3.negate(Fp[3],Fp[1]),S=Fp}let a=S[0],o=S[1],l=S[2],h=S[3];b[0]=t+a[0]*L,b[1]=i+a[1]*N,b[2]=s+a[2]*x,b[3]=t+o[0]*L,b[4]=i+o[1]*N,b[5]=s+o[2]*x,b[6]=t+l[0]*L,b[7]=i+l[1]*N,b[8]=s+l[2]*x,b[9]=t+h[0]*L,b[10]=i+h[1]*N,b[11]=s+h[2]*x}else{let t=e.tailLength,i=t*n[0]*1,s=t*n[1]*1,a=t*n[2]*1,o=[r[0]-i,r[1]-s,r[2]-a],l=[r[0],r[1],r[2]];e.modelSpace&&(ar.vec3.transformMat4(o,o,this.node.worldMatrix),ar.vec3.transformMat4(l,l,this.node.worldMatrix));let h=o[0],c=o[1],d=o[2],u=l[0],m=l[1],f=l[2],p=[u-h,m-c,f-d];ar.vec3.normalize(p,p);let E=ar.vec3.cross([],R.billboardedVectors[6],p);ar.vec3.normalize(E,E);let g=E[0]*L,A=E[1]*N,_=E[2]*x;b[0]=h-g,b[1]=c-A,b[2]=d-_,b[6]=u+g,b[7]=m+A,b[8]=f+_,b[3]=u-g,b[4]=m-A,b[5]=f-_,b[9]=h+g,b[10]=c+A,b[11]=d+_}}}class Vp extends Ip{constructor(e){super(e),this.elementsPerEmit=30*(2===e.headOrTail?2:1)}emit(e){this.modelObject.head&&this.emitObject(e,!0),this.modelObject.tail&&this.emitObject(e,!1)}createObject(){return new Bp(this)}}let kp=ar.vec3.create(),Gp=ar.vec3.create(),jp=ar.vec3.create(),Yp=new Float32Array(1),Hp=new Float32Array(1);class Wp{constructor(e){this.emitter=e,this.health=0,this.emitterView=null,this.vertices=new Float32Array(12),this.lta=0,this.lba=0,this.rta=0,this.rba=0,this.rgb=0}reset(e){let t=this.emitter,i=this.vertices;this.index=e.currentRibbon++,e.ribbonCount++,this.emitterView=e,this.health=t.modelObject.lifeSpan;let r=e.lastEmit;if(r&&r.health>0){let n=e.instance.nodes[t.modelObject.index],s=n.pivot;e.getHeightBelow(kp),e.getHeightAbove(Gp),ar.vec3.set(kp,s[0],s[1]-kp[0],s[2]),ar.vec3.transformMat4(kp,kp,n.worldMatrix),ar.vec3.set(Gp,s[0],s[1]+Gp[0],s[2]),ar.vec3.transformMat4(Gp,Gp,n.worldMatrix);let a=r.vertices;i[0]=Gp[0],i[1]=Gp[1],i[2]=Gp[2],i[3]=kp[0],i[4]=kp[1],i[5]=kp[2],i[6]=a[3],i[7]=a[4],i[8]=a[5],i[9]=a[0],i[10]=a[1],i[11]=a[2]}else i[0]=0,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=0,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=0,i[11]=0}update(){let e=this.emitterView;e.getColor(jp),e.getAlpha(Yp),e.getTextureSlot(Hp);let t=this.emitter.modelObject,i=.001*t.model.viewer.frameTime,r=t.gravity*i*i,n=this.vertices,s=Yp[0],a=Hp[0],o=1/e.ribbonCount,l=e.currentRibbon-this.index-1;if(this.health-=i,n[1]-=r,n[4]-=r,n[7]-=r,n[10]-=r,this.health<=0)e.ribbonCount--;else{let e=t.dimensions[0],i=a%e+l*o,r=a/e|0,n=i+o,h=r+1;i=255*i|0,r=255*r|0,n=255*n|0,h*=255,s=255*s|0,this.lta=ft(i,r,s),this.lba=ft(i,h,s),this.rta=ft(n,r,s),this.rba=ft(n,h,s),this.rgb=ft(255*jp[0]|0,255*jp[1]|0,255*jp[2]|0)}}}class Kp extends Ip{constructor(e){super(e),this.elementsPerEmit=30}emit(e){e.lastEmit=this.emitObject(e)}createObject(){return new Wp(this)}fill(e){e.currentEmission>=1&&(this.emit(e),e.currentEmission--)}render(e,t){let i=this.alive;if(i>0){let r=this.modelObject,n=r.model,s=n.viewer.gl;r.layer.bind(t),s.uniform2fv(t.uniforms.u_dimensions,r.dimensions),n.bindTexture(r.texture,0,e),s.bindBuffer(s.ARRAY_BUFFER,this.buffer),s.bufferSubData(s.ARRAY_BUFFER,0,this.data.subarray(0,30*i)),s.vertexAttribPointer(t.attribs.a_position,3,s.FLOAT,!1,20,0),s.vertexAttribPointer(t.attribs.a_uva_rgb,2,s.FLOAT,!1,20,12),s.drawArrays(s.TRIANGLES,0,6*i)}}}class zp{constructor(e){this.emitter=e,this.emitterView=null,this.health=0,this.internalResource=e.modelObject.internalResource.addInstance()}reset(e){let t=this.internalResource,i=e.instance.nodes[this.emitter.modelObject.index];this.emitterView=e,t.setSequence(0),t.setTransformation(i.worldLocation,i.worldRotation,i.worldScale),t.show(),e.instance.scene.addInstance(t),this.health=1}update(){let e=this.internalResource;e.frame>=e.model.sequences[0].interval[1]&&(this.health=0,e.hide())}}class qp extends Ap{constructor(e){super(e),this.type="SPN"}emit(e){this.modelObject.ok&&this.emitObject(e)}createObject(){return new zp(this)}}class Xp{constructor(e){this.emitter=e,this.emitterView=null,this.health=0,this.color=new Uint8Array(4),this.vertices=new Float32Array(12),this.lta=0,this.lba=0,this.rta=0,this.rba=0,this.rgb=0}reset(e){let t,i=this.emitter.modelObject,r=this.vertices,n=i.scale,s=e.instance.nodes[i.index].worldMatrix;this.emitterView=e,t=r.subarray(0,2),ar.vec3.transformMat4(t,[-n,-n,0],s),t=r.subarray(3,5),ar.vec3.transformMat4(t,[-n,n,0],s),t=r.subarray(6,8),ar.vec3.transformMat4(t,[n,n,0],s),t=r.subarray(9,11),ar.vec3.transformMat4(t,[n,-n,0],s),this.health=i.lifespan}update(){let e,t,i,r,n=this.emitter.modelObject,s=n.dimensions[0],a=n.intervalTimes,o=n.intervals,l=a[0],h=a[1],c=n.colors,d=this.color;this.health-=.001*n.model.viewer.frameTime;let u=n.lifespan-this.health;u<l?(e=u/l,t=o[0],i=0):(e=(u-l)/h,t=o[1],i=1),ar.vec4.lerp(d,c[i],c[i+1],e);let m=(r=Math.floor(cr(t[0],t[1],e)))%s,f=Math.floor(r/s),p=m+1,E=f+1,g=d[3];this.lta=ft(p,E,g),this.lba=ft(m,E,g),this.rta=ft(p,f,g),this.rba=ft(m,f,g),this.rgb=ft(d[0],d[1],d[2])}}class Jp extends Ip{constructor(e){super(e),this.type="SPL",this.elementsPerEmit=30}emit(e){this.modelObject.ok&&this.emitObject(e)}createObject(){return new Xp(this)}}class Qp{constructor(e){this.emitter=e,this.emitterView=null,this.health=0,this.color=new Uint8Array(4),this.vertices=new Float32Array(12),this.lta=0,this.lba=0,this.rta=0,this.rba=0,this.rgb=0}reset(e){let t,i=this.emitter.modelObject,r=this.vertices,n=i.scale,s=e.instance.nodes[i.index].worldMatrix;this.emitterView=e,t=r.subarray(0,2),ar.vec3.transformMat4(t,[-n,-n,0],s),t=r.subarray(3,5),ar.vec3.transformMat4(t,[-n,n,0],s),t=r.subarray(6,8),ar.vec3.transformMat4(t,[n,n,0],s),t=r.subarray(9,11),ar.vec3.transformMat4(t,[n,-n,0],s),this.health=i.lifespan}update(){let e=this.emitter.modelObject,t=e.intervalTimes,i=t[0],r=t[1],n=t[2],s=e.colors,a=this.color;this.health-=.001*e.model.viewer.frameTime;let o=e.lifespan-this.health;o<i?ar.vec4.lerp(a,s[0],s[1],o/i):o<i+r?ar.vec4.copy(a,e.colors[1]):ar.vec4.lerp(a,s[1],s[2],(o-i-r)/n);let l=a[3];this.lta=ft(1,0,l),this.lba=ft(0,0,l),this.rta=ft(1,1,l),this.rba=ft(0,1,l),this.rgb=ft(a[0],a[1],a[2])}}class $p extends Ip{constructor(e){super(e),this.type="UBR",this.elementsPerEmit=30}emit(e){this.modelObject.ok&&this.emitObject(e)}createObject(){return new Qp(this)}}class Zp{constructor(e){this.modelObject=e,this.type="SND"}emit(e){if(this.modelObject.ok){let t=this.modelObject.model.viewer,i=e.instance.scene;if(t.enableAudio&&i.audioEnabled){let t=i.audioContext,r=e.emitter,n=r.decodedBuffers,s=t.createPanner(),a=t.createBufferSource();s.setPosition(...e.instance.nodes[r.objectId].worldLocation),s.maxDistance=r.distanceCutoff,s.refDistance=r.minDistance,s.connect(t.destination),a.buffer=n[Math.random()*n.length|0],a.connect(s),a.start(0)}}}update(){}fill(e){let t=e.currentEmission;if(t>=1)for(let i=0;i<t;i+=1,e.currentEmission--)this.emit(e)}render(e,t){}clear(e){}}var eE=class extends Rf{constructor(e){super(e);let t=this.model,i=t.batchSize,r=t.viewer.gl,n=t.bones.length+1;this.boneArrayInstanceSize=16*n,this.boneArray=new Float32Array(this.boneArrayInstanceSize*i),this.boneTexture=r.createTexture(),this.boneTextureWidth=4*n,this.boneTextureHeight=i,this.vectorSize=1/this.boneTextureWidth,this.rowSize=1/this.boneTextureHeight,r.activeTexture(r.TEXTURE15),r.bindTexture(r.TEXTURE_2D,this.boneTexture),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texImage2D(r.TEXTURE_2D,0,r.RGBA32F,this.boneTextureWidth,this.boneTextureHeight,0,r.RGBA,r.FLOAT,this.boneArray),this.colorData=new Uint8Array(5*i),this.colorBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.colorBuffer),r.bufferData(r.ARRAY_BUFFER,this.colorData.byteLength,r.DYNAMIC_DRAW),t.batches.length>0&&(this.geosetColorsData=new Uint8Array(i*t.geosets.length*4),this.geosetColorsBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.geosetColorsBuffer),r.bufferData(r.ARRAY_BUFFER,this.geosetColorsData.byteLength,r.DYNAMIC_DRAW),this.layersData=new ArrayBuffer(i*t.layers.length*29),this.uvTransformsData=new Float32Array(this.layersData,0,i*t.layers.length*7),this.layerAlphasData=new Uint8Array(this.layersData,i*t.layers.length*28,i*t.layers.length),this.layersBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.layersBuffer),r.bufferData(r.ARRAY_BUFFER,this.layersData.byteLength,r.DYNAMIC_DRAW))}fill(e){let t=e.baseIndex,i=this.model,r=i.viewer.gl,n=i.batchSize,s=i.geosets.length,a=i.layers.length,o=i.bones.length,l=this.boneArray,h=this.colorData,c=this.geosetColorsData,d=this.layerAlphasData,u=this.uvTransformsData,m=0,f=e.instances,p=e.particleEmitters,E=e.particleEmitters2,g=e.ribbonEmitters,A=e.eventObjectEmitters;for(let _=f.length;t<_&&m<n;t++){let e=f[t];if(e.rendered&&!e.culled){let t=e.vertexColor,r=e.worldMatrices,f=e.geosetColors,_=e.layerAlphas,T=e.uvOffsets,v=e.uvScales,y=e.uvRots,w=16+m*(16+16*o),S=e.particleEmitters,R=e.particleEmitters2,b=e.ribbonEmitters,I=e.eventObjectEmitters,L=4*m,N=5*m,x=7*m;for(let e=0,i=16*o;e<i;e++)l[w+e]=r[e];h[N]=e.teamColor,h[N+1]=t[0],h[N+2]=t[1],h[N+3]=t[2],h[N+4]=t[3];for(let e=0;e<s;e++){let t=4*e,i=n*t+L;c[i]=f[t],c[i+1]=f[t+1],c[i+2]=f[t+2],c[i+3]=f[t+3]}if(i.batches.length>0)for(let e=0;e<a;e++){let t=4*e,i=n*e*7+x;d[n*e+m]=_[e],u[i]=T[t],u[i+1]=T[t+1],u[i+2]=y[2*e],u[i+3]=y[2*e+1],u[i+4]=v[e],u[i+5]=T[t+2],u[i+6]=T[t+3]}for(let e=0,i=p.length;e<i;e++)p[e].fill(S[e]);for(let e=0,i=E.length;e<i;e++)E[e].fill(R[e]);for(let e=0,i=g.length;e<i;e++)g[e].fill(b[e]);for(let e=0,i=A.length;e<i;e++)A[e].fill(I[e]);m+=1}}return this.count=m,m&&(r.activeTexture(r.TEXTURE15),r.bindTexture(r.TEXTURE_2D,this.boneTexture),r.texSubImage2D(r.TEXTURE_2D,0,0,0,this.boneTextureWidth,m,r.RGBA,r.FLOAT,l),r.bindBuffer(r.ARRAY_BUFFER,this.colorBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,h),s&&(r.bindBuffer(r.ARRAY_BUFFER,this.geosetColorsBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,c)),a&&i.batches.length>0&&(r.bindBuffer(r.ARRAY_BUFFER,this.layersBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,this.layersData))),t}};class tE extends zr{convertBasis(e){ar.quat.rotateY(e,e,-Math.PI/2)}}let iE=new Float32Array(1);class rE{constructor(e,t){let i=t.internalModel.addInstance();i.setSequenceLoopMode(2),i.dontInheritScale=!1,i.hide(),i.setParent(e.nodes[t.objectId]),this.instance=e,this.attachment=t,this.internalInstance=i}update(){let e=this.internalInstance;e.model.ok&&(this.attachment.getVisibility(iE,this.instance),iE[0]>.1?(this.instance.scene.addInstance(e),e.hidden()&&(e.show(),e.setSequence(0))):e.hide())}}let nE=new Float32Array(1);class sE{constructor(e,t){this.instance=e,this.emitter=t,this.currentEmission=0}update(){this.instance.allowParticleSpawn&&(this.getEmissionRate(nE),this.currentEmission+=nE[0]*this.instance.model.viewer.frameTime*.001)}getSpeed(e){return this.emitter.getSpeed(e,this.instance)}getLatitude(e){return this.emitter.getLatitude(e,this.instance)}getLongitude(e){return this.emitter.getLongitude(e,this.instance)}getLifeSpan(e){return this.emitter.getLifeSpan(e,this.instance)}getGravity(e){return this.emitter.getGravity(e,this.instance)}getEmissionRate(e){return this.emitter.getEmissionRate(e,this.instance)}getVisibility(e){return this.emitter.getVisibility(e,this.instance)}}let aE=new Float32Array(1);class oE{constructor(e,t){this.instance=e,this.emitter=t,this.currentEmission=0,this.lastEmissionKey=-1}update(){if(this.instance.allowParticleSpawn){let e=this.getEmissionRate(aE);this.emitter.squirt?(e!==this.lastEmissionKey&&(this.currentEmission+=aE[0]),this.lastEmissionKey=e):this.currentEmission+=aE[0]*this.instance.model.viewer.frameTime*.001}}getWidth(e){return this.emitter.getWidth(e,this.instance)}getLength(e){return this.emitter.getLength(e,this.instance)}getSpeed(e){return this.emitter.getSpeed(e,this.instance)}getLatitude(e){return this.emitter.getLatitude(e,this.instance)}getGravity(e){return this.emitter.getGravity(e,this.instance)}getEmissionRate(e){return this.emitter.getEmissionRate(e,this.instance)}getVisibility(e){return this.emitter.getVisibility(e,this.instance)}getVariation(e){return this.emitter.getVariation(e,this.instance)}}class lE{constructor(e,t){this.instance=e,this.emitter=t,this.currentEmission=0,this.lastEmit=null,this.currentRibbon=-1,this.ribbonCount=0}update(){this.instance.allowParticleSpawn&&(this.currentEmission+=this.emitter.emissionRate*this.instance.model.viewer.frameTime*.001)}getHeightBelow(e){return this.emitter.getHeightBelow(e,this.instance)}getHeightAbove(e){return this.emitter.getHeightAbove(e,this.instance)}getTextureSlot(e){return this.emitter.getTextureSlot(e,this.instance)}getColor(e){return this.emitter.getColor(e,this.instance)}getAlpha(e){return this.emitter.getAlpha(e,this.instance)}getVisibility(e){return this.emitter.getVisibility(e,this.instance)}}let hE=ar.vec2.create();class cE{constructor(e,t){this.instance=e,this.emitter=t,this.lastTrack=new Uint16Array(2),this.currentEmission=0}reset(){this.lastTrack.fill(0)}update(){if(this.instance.allowParticleSpawn){let e=this.emitter,t=this.lastTrack;e.getValue(hE,this.instance),1!==hE[0]||hE[0]===t[0]&&hE[1]===t[1]||(this.currentEmission+=1),t[0]=hE[0],t[1]=hE[1]}}}let dE=new Float32Array(1),uE=ar.vec3.create(),mE=ar.quat.create(),fE=ar.vec3.create(),pE=new Float32Array(3),EE=new Float32Array(1),gE=new Float32Array(1);class AE extends Lf{constructor(e){super(e),this.attachments=[],this.particleEmitters=[],this.particleEmitters2=[],this.ribbonEmitters=[],this.eventObjectEmitters=[],this.nodes=[],this.sortedNodes=[],this.frame=0,this.counter=0,this.sequence=-1,this.sequenceLoopMode=0,this.teamColor=0,this.vertexColor=new Uint8Array([255,255,255,255]),this.allowParticleSpawn=!1,this.forced=!0}load(){let e=this.model,t=e.geosets.length,i=e.layers.length;this.geosetColors=new Uint8Array(4*t),this.layerAlphas=new Uint8Array(i),this.uvOffsets=new Float32Array(4*i),this.uvScales=new Float32Array(i),this.uvRots=new Float32Array(2*i);let r=function(e,t){let i=new Float32Array(e*qr),r=[],n=0,s=3*e,a=4*e,o=16*e;t=t||zr;let l=i.subarray(n,n+s);n+=s;let h=i.subarray(n,n+s);n+=s;let c=i.subarray(n,n+a);n+=a;let d=i.subarray(n,n+s);n+=s;let u=i.subarray(n,n+s);n+=s;let m=i.subarray(n,n+a);n+=a;let f=i.subarray(n,n+s);n+=s;let p=i.subarray(n,n+s);n+=s;let E=i.subarray(n,n+a);n+=a;let g=i.subarray(n,n+s);n+=s;let A=i.subarray(n,n+o);n+=o;let _=i.subarray(n,n+o);for(let T=0;T<e;T++){let e=3*T,i=e+3,n=4*T,s=n+4,a=16*T,o=a+16;r[T]=new t([l.subarray(e,i),h.subarray(e,i),c.subarray(n,s),d.subarray(e,i),u.subarray(e,i),m.subarray(n,s),f.subarray(e,i),p.subarray(e,i),E.subarray(n,s),g.subarray(e,i),A.subarray(a,o),_.subarray(a,o)])}return{data:i,nodes:r,pivots:l,localLocations:h,localRotations:c,localScales:d,worldLocations:u,worldRotations:m,worldScales:f,inverseWorldLocations:p,invereseWorldRotations:E,inverseWorldScales:g,localMatrices:A,worldMatrices:_}}(e.genericObjects.length,tE),n=r.nodes,s=0;this.nodes.push(...n),this.worldMatrices=r.worldMatrices;for(let o of e.bones)this.initNode(n,n[s++],o);for(let o of e.lights)this.initNode(n,n[s++],o);for(let o of e.helpers)this.initNode(n,n[s++],o);for(let o of e.attachments){let e;o.internalModel&&(e=new rE(this,o),this.attachments.push(e)),this.initNode(n,n[s++],o,e)}for(let o of e.particleEmitters){let e=new sE(this,o);this.particleEmitters.push(e),this.initNode(n,n[s++],o,e)}for(let o of e.particleEmitters2){let e=new oE(this,o);this.particleEmitters2.push(e),this.initNode(n,n[s++],o,e)}for(let o of e.ribbonEmitters){let e=new lE(this,o);this.ribbonEmitters.push(e),this.initNode(n,n[s++],o,e)}for(let o of e.cameras)this.initNode(n,n[s++],o);for(let o of e.eventObjects){let e=new cE(this,o);this.eventObjectEmitters.push(e),this.initNode(n,n[s++],o,e)}for(let o of e.collisionShapes)this.initNode(n,n[s++],o);let a=e.hierarchy;for(let o=0,l=n.length;o<l;o++)this.sortedNodes[o]=n[a[o]];this.setSequence(this.sequence)}clearEmittedObjects(){if(this.modelView)for(let e of this.modelView.sceneData.values()){for(let t of e.particleEmitters)t.clear(this);for(let t of e.particleEmitters2)t.clear(this);for(let t of e.ribbonEmitters)t.clear(this);for(let t of e.eventObjectEmitters)t.clear(this)}}initNode(e,t,i,r){t.pivot.set(i.pivot),t.name=i.name,t.gen=i,-1===i.parentId?t.parent=this:t.parent=e[i.parentId],i.billboarded?t.billboarded=!0:i.billboardedX?t.billboardedX=!0:i.billboardedY?t.billboardedY=!0:i.billboardedZ&&(t.billboardedZ=!0),r&&(t.object=r)}hide(){super.hide();for(let e of this.attachments)e.internalInstance.hide()}show(){super.show();for(let e of this.attachments)e.internalInstance.show()}updateTimers(){if(-1!==this.sequence){let e=this.model,t=e.sequences[this.sequence],i=t.interval,r=e.viewer.frameTime;this.frame+=r,this.counter+=r,this.allowParticleSpawn=!0,this.frame>=i[1]&&(2===this.sequenceLoopMode||0===this.sequenceLoopMode&&0===t.flags?(this.frame=i[0],this.resetEventEmitters()):(this.frame=i[1],this.counter-=r,this.allowParticleSpawn=!1),this.emit("seqend",this))}}updateNodes(e){let t=this.sortedNodes,i=this.sequence,r=this.model.sortedGenericObjects,n=this.scene;for(let s=0,a=t.length;s<a;s++){let a=r[s],o=t[s],l=o.parent;a.getVisibility(dE,this);let h=dE[0]>=.75,c=e||l.visible&&h;if(o.visible=c,c){let t=!1,r=a.variants,s=o.localLocation,c=o.localRotation,d=o.localScale;(e||r.generic[i])&&(t=!0,(e||r.translation[i])&&(a.getTranslation(uE,this),s[0]=uE[0],s[1]=uE[1],s[2]=uE[2]),(e||r.rotation[i])&&(a.getRotation(mE,this),c[0]=mE[0],c[1]=mE[1],c[2]=mE[2],c[3]=mE[3]),(e||r.scale[i])&&(a.getScale(fE,this),d[0]=fE[0],d[1]=fE[1],d[2]=fE[2]));let u=e||t||l.wasDirty||a.anyBillboarding;o.wasDirty=u,u&&o.recalculateTransformation(n);let m=o.object;m&&h&&m.update(),o.updateChildren(n)}}}updateBatches(e){let t=this.model,i=t.geosets,r=t.layers,n=this.geosetColors,s=this.layerAlphas,a=this.uvOffsets,o=this.uvScales,l=this.uvRots,h=this.sequence;for(let c=0,d=i.length;c<d;c++){let t=i[c],r=4*c;(e||t.variants.color[h])&&(t.getColor(pE,this),n[r]=255*pE[0],n[r+1]=255*pE[1],n[r+2]=255*pE[2]),(e||t.variants.alpha[h])&&(t.getAlpha(EE,this),n[r+3]=255*EE[0])}for(let c=0,d=r.length;c<d;c++){let t=r[c],i=2*c,n=4*c;if((e||t.variants.alpha[h])&&(t.getAlpha(EE,this),s[c]=255*EE[0]),(e||t.variants.translation[h])&&(t.getTranslation(uE,this),a[n]=uE[0],a[n+1]=uE[1]),(e||t.variants.rotation[h])&&(t.getRotation(mE,this),l[i]=mE[2],l[i+1]=mE[3]),(e||t.variants.scale[h])&&(t.getScale(fE,this),o[c]=fE[0]),e||t.variants.slot[h]){t.getTextureId(gE,this);let e=t.uvDivisor,i=gE[0];a[n+2]=i%e[0],a[n+3]=i/e[1]|0}}}updateAnimations(){let e=this.forced;(e||-1!==this.sequence&&!this.model.viewer.noUpdating)&&(this.forced=!1,this.updateNodes(e),this.updateBatches(e))}setTeamColor(e){return this.teamColor=e,this}setVertexColor(e){return this.vertexColor.set(e),this}setSequence(e){if(this.sequence=e,this.model.ok){let t=this.model.sequences;e<0||e>t.length-1?(this.sequence=-1,this.frame=0,this.allowParticleSpawn=!1):this.frame=t[e].interval[0],this.resetEventEmitters(),this.forced=!0}return this}setSequenceLoopMode(e){return this.sequenceLoopMode=e,this}getAttachment(e){let t=this.model.attachments[e];if(t)return this.nodes[t.index]}resetEventEmitters(){for(let e of this.eventObjectEmitters)e.reset()}}var _E={vs:"\n    ".concat(xf,"\n    ").concat(Pf,"\n    uniform mat4 u_mvp;\n\n    attribute vec3 a_position;\n    attribute vec3 a_normal;\n    attribute vec2 a_uv;\n    attribute vec4 a_bones;\n    attribute float a_boneNumber;\n    attribute float a_teamColor;\n    attribute vec4 a_vertexColor;\n    attribute vec4 a_geosetColor;\n    attribute float a_layerAlpha;\n    attribute vec4 a_uvTransRot;\n    attribute vec3 a_uvScaleSprite;\n\n    varying vec3 v_normal;\n    varying vec2 v_uv;\n    varying float v_teamColor;\n    varying vec4 v_vertexColor;\n    varying vec4 v_geosetColor;\n    varying vec4 v_uvTransRot;\n    varying vec3 v_uvScaleSprite;\n\n    void transform(inout vec3 position, inout vec3 normal, float boneNumber, vec4 bones) {\n      // For the broken models out there, since the game supports this.\n      if (boneNumber > 0.0) {\n        mat4 b0 = fetchMatrix(bones[0], a_InstanceID);\n        mat4 b1 = fetchMatrix(bones[1], a_InstanceID);\n        mat4 b2 = fetchMatrix(bones[2], a_InstanceID);\n        mat4 b3 = fetchMatrix(bones[3], a_InstanceID);\n        vec4 p = vec4(position, 1);\n        vec4 n = vec4(normal, 0);\n\n        position = vec3(b0 * p + b1 * p + b2 * p + b3 * p) / boneNumber;\n        normal = normalize(vec3(b0 * n + b1 * n + b2 * n + b3 * n));\n      }\n    }\n\n    void main() {\n      vec2 uv = a_uv;\n      vec3 position = a_position;\n      vec3 normal = a_normal;\n\n      transform(position, normal, a_boneNumber, a_bones);\n\n      v_uv = a_uv;\n      v_uvTransRot = a_uvTransRot;\n      v_uvScaleSprite = a_uvScaleSprite;\n\n      v_normal = normal;\n      v_teamColor = a_teamColor;\n      v_vertexColor = a_vertexColor;\n\n      // Is the alpha here even correct?\n      v_geosetColor = vec4(a_geosetColor.rgb, a_layerAlpha);\n\n      // Definitely not correct, but the best I could figure so far.\n      if (a_geosetColor.a < 0.75 || a_layerAlpha < 0.1) {\n        gl_Position = vec4(0.0);\n      } else {\n        gl_Position = u_mvp * vec4(position, 1);\n      }\n    }\n  "),fs:"\n    uniform sampler2D u_texture;\n    uniform bool u_alphaTest;\n    // uniform bool u_unshaded;\n    uniform bool u_isTeamColor;\n    uniform vec2 u_uvScale;\n    uniform bool u_hasSlotAnim;\n    uniform bool u_hasTranslationAnim;\n    uniform bool u_hasRotationAnim;\n    uniform bool u_hasScaleAnim;\n\n    varying vec3 v_normal;\n    varying vec2 v_uv;\n    varying float v_teamColor;\n    varying vec4 v_vertexColor;\n    varying vec4 v_geosetColor;\n    varying vec4 v_uvTransRot;\n    varying vec3 v_uvScaleSprite;\n\n    // const vec3 lightDirection = normalize(vec3(-0.3, -0.3, 0.25));\n\n    ".concat(Uf,"\n\n    void main() {\n      vec2 uv;\n\n      if (u_isTeamColor) {\n        // 4 is the amount of columns and rows in the team colors/glows texture.\n        uv = (vec2(mod((v_teamColor + 0.5), 8.0) - 0.5, floor((v_teamColor + 0.5) / 8.0)) + v_uv) / vec2(8.0, 4.0);\n      } else {\n        uv = v_uv;\n\n        // Translation animation\n        if (u_hasTranslationAnim) {\n          uv += v_uvTransRot.xy;\n        }\n\n        // Rotation animation\n        if (u_hasRotationAnim) {\n          uv = quat_transform(v_uvTransRot.zw, uv - 0.5) + 0.5;\n        }\n\n        // Scale animation\n        if (u_hasScaleAnim) {\n          uv = v_uvScaleSprite.x * (uv - 0.5) + 0.5;\n        }\n\n        // Sprite animation\n        if (u_hasSlotAnim) {\n          uv = (v_uvScaleSprite.yz + fract(uv)) * u_uvScale;\n        }\n      }\n\n      vec4 texel = texture2D(u_texture, uv).rgba;\n\n      // 1bit Alpha\n      if (u_alphaTest && texel.a < 0.75) {\n        discard;\n      }\n\n      vec4 color = texel * v_geosetColor.bgra * v_vertexColor;\n\n      // if (!u_unshaded) {\n      //   color *= clamp(dot(v_normal, lightDirection) + 0.45, 0.0, 1.0);\n      // }\n\n      gl_FragColor = color;\n    }\n  "),vsParticles:"\n    ".concat(Cf,"\n    uniform mat4 u_mvp;\n    uniform vec2 u_dimensions;\n    uniform bool u_isRibbonEmitter;\n\n    attribute vec3 a_position;\n    attribute vec2 a_uva_rgb;\n\n    varying vec2 v_uv;\n    varying vec4 v_color;\n\n    void main() {\n      vec3 uva = decodeFloat3(a_uva_rgb[0]);\n      vec3 rgb = decodeFloat3(a_uva_rgb[1]);\n      vec2 uv = uva.xy;\n\n      if (u_isRibbonEmitter) {\n        uv /= 255.0;\n      }\n\n      v_uv = uv / u_dimensions;\n      v_color = vec4(rgb, uva.z) / 255.0;\n\n      gl_Position = u_mvp * vec4(a_position, 1);\n    }\n  "),fsParticles:"\n    uniform sampler2D u_texture;\n    uniform bool u_alphaTest;\n    uniform bool u_isRibbonEmitter;\n\n    varying vec2 v_uv;\n    varying vec4 v_color;\n\n    void main() {\n      vec4 texel = texture2D(u_texture, v_uv).rgba;\n\n      // 1bit Alpha, used by ribbon emitters\n      if (u_isRibbonEmitter && u_alphaTest && texel.a < 0.75) {\n        discard;\n      }\n\n      gl_FragColor = texel * v_color;\n    }\n  "},TE={install(e){e.addHandler(en);let t=e.loadShader("MdxStandardShader",_E.vs,_E.fs),i=e.loadShader("MdxParticleShader",_E.vsParticles,_E.fsParticles);return t.ok&&i.ok},extensions:[[".mdx","arrayBuffer"],[".mdl","text"]],Constructor:gp,View:class extends vf{createSceneData(e){let t=this.model,i=super.createSceneData(e),r=[],n=[],s=[],a=[];for(let o of t.particleEmitters)r.push(new bp(o));for(let o of t.particleEmitters2)n.push(new Vp(o));for(let o of t.ribbonEmitters)s.push(new Kp(o));for(let o of t.eventObjects){let e=o.type;"SPN"===e?a.push(new qp(o)):"SPL"===e?a.push(new Jp(o)):"UBR"===e?a.push(new $p(o)):"SND"===e&&a.push(new Zp(o))}return{...i,particleEmitters:r,particleEmitters2:n,ribbonEmitters:s,eventObjectEmitters:a}}update(e){let t=super.update(e);if(t){let e=this.model.batches.length,i=t.buckets,r=0,n=0,s=0,a=0;for(let o=0,l=t.usedBuckets;o<l;o++)r+=i[o].count,s+=1,a+=e;for(let o of t.particleEmitters){o.update();let e=o.alive;e&&(n+=e,a+=1)}for(let o of t.particleEmitters2){o.update();let e=o.alive;e&&(n+=e,a+=1)}for(let o of t.ribbonEmitters){o.update();let e=o.alive;e&&(n+=e,a+=1)}for(let o of t.eventObjectEmitters)if(o.update(),"SND"!==o.type){let e=o.alive;e&&(n+=e,a+=1)}this.renderedInstances=r,this.renderedParticles=n,this.renderedBuckets=s,this.renderCalls=a}}},Bucket:eE,Instance:AE},vE={handler:TE,Model:gp,ModelInstance:AE,Bucket:eE},yE={handler:en,Texture:Zr},wE={vsGround:"\n    uniform mat4 u_mvp;\n    uniform sampler2D u_heightMap;\n    uniform sampler2D u_heightMap0;\n    uniform vec2 u_size;\n    uniform vec2 u_offset;\n    uniform float u_tilesetHeight;\n    uniform float u_tilesetCount;\n    uniform vec2 u_pixel;\n\n    attribute vec2 a_position;\n    ".concat(xf,"\n    attribute vec4 a_textures;\n    attribute vec4 a_variations;\n\n    varying vec2 v_uv[4];\n    varying vec2 v_suv;\n    varying vec3 v_normal;\n\n    vec4 getCell(float tileset, float variation) {\n      float x = variation * 0.03125;\n      float y = tileset * u_tilesetHeight;\n\n      return vec4(x, y, x + 0.03125, y + u_tilesetHeight);\n    }\n    \n    vec2 getUV(vec2 position, float tileset, float variation) {\n      vec2 uv = vec2(position.x, 1.0 - position.y);\n      vec4 cell = getCell(tileset, variation);\n      vec2 cellSize = vec2(1.0 / 32.0, 1.0 / u_tilesetCount);\n      vec2 pixelSize = vec2(2.0 / 2048.0, 2.0 / (64.0 * u_tilesetCount));\n\n      return clamp(cell.xy + uv * cellSize, cell.xy + pixelSize, cell.zw - pixelSize);\n    }\n\n    const float normalDist = 1.0;\n\n    void main() {\n      if (a_textures[0] > 0.5) {\n        v_uv[0] = getUV(a_position, a_textures[0], a_variations[0]);\n        v_uv[1] = getUV(a_position, a_textures[1], a_variations[1]);\n        v_uv[2] = getUV(a_position, a_textures[2], a_variations[2]);\n        v_uv[3] = getUV(a_position, a_textures[3], a_variations[3]);\n\n        vec2 halfPixel = vec2(0.5, 0.5) * u_pixel;\n        vec2 corner = vec2(mod(a_InstanceID, u_size.x), floor(a_InstanceID / u_size.x));\n        vec2 base = floor(corner + a_position);\n        float height = texture2D(u_heightMap, base * u_pixel + halfPixel).COMP1D;\n\n        float hL = texture2D(u_heightMap0, vec2(base - vec2(normalDist, 0.0)) * u_pixel + halfPixel).COMP1D;\n        float hR = texture2D(u_heightMap0, vec2(base + vec2(normalDist, 0.0)) * u_pixel + halfPixel).COMP1D;\n        float hD = texture2D(u_heightMap0, vec2(base - vec2(0.0, normalDist)) * u_pixel + halfPixel).COMP1D;\n        float hU = texture2D(u_heightMap0, vec2(base + vec2(0.0, normalDist)) * u_pixel + halfPixel).COMP1D;\n\n        v_normal = normalize(vec3(hL - hR, hD - hU, normalDist * 2.0));\n\n        v_suv = base / u_size;\n        gl_Position = u_mvp * vec4(base * 128.0 + u_offset, height * 128.0, 1.0);\n      } else {\n        v_uv[0] = vec2(0.0);\n        v_uv[1] = vec2(0.0);\n        v_uv[2] = vec2(0.0);\n        v_uv[3] = vec2(0.0);\n        v_suv = vec2(0.0);\n\n        v_normal = vec3(0.0);\n\n        gl_Position = vec4(0.0);\n      }\n    }\n  "),fsGround:"\n    uniform sampler2D u_tilesets;\n    uniform sampler2D u_shadowMap;\n\n    varying vec2 v_uv[4];\n    varying vec2 v_suv;\n    varying vec3 v_normal;\n\n    const vec3 lightDirection = normalize(vec3(-0.3, -0.3, 0.25));\n\n    vec4 blend(vec4 color, vec2 uv) {\n      vec4 texel = texture2D(u_tilesets, uv).rgba;\n\n      return mix(color, texel, texel.a);\n    }\n\n    void main() {\n      vec4 color = texture2D(u_tilesets, v_uv[0]).rgba;\n      color = blend(color, v_uv[1]);\n      color = blend(color, v_uv[2]);\n      color = blend(color, v_uv[3]);\n\n      float shadow = texture2D(u_shadowMap, v_suv).COMP1D;\n      color.xyz *= clamp(dot(v_normal, lightDirection) + 0.45, 0.0, 1.0);\n      color.xyz *= 1.0 - shadow;\n\n      gl_FragColor = color;\n    }\n  ",vsWater:"\n    uniform mat4 u_mvp;\n    uniform sampler2D u_heightMap;\n    uniform sampler2D u_waterHeightMap;\n    uniform vec2 u_size;\n    uniform vec2 u_pixel;\n    uniform vec2 u_offset;\n    uniform float u_offsetHeight;\n    uniform float u_tileIndex;\n    uniform vec4 u_minDeepColor;\n    uniform vec4 u_maxDeepColor;\n    uniform vec4 u_minShallowColor;\n    uniform vec4 u_maxShallowColor;\n\n    attribute vec2 a_position;\n    ".concat(xf,"\n    attribute float a_isWater;\n\n    varying vec2 v_uv;\n    varying vec2 v_position;\n    varying vec4 v_color;\n\n    const float minDepth = 10.0 / 128.0;\n    const float deepLevel = 64.0 / 128.0;\n    const float maxDepth = 72.0 / 128.0;\n\n    void main() {\n      if (a_isWater > 0.5) {\n        vec2 corner = vec2(mod(a_InstanceID, u_size.x), floor(a_InstanceID / u_size.x));\n        vec2 texPosition = (mod(corner, 2.0) + a_position) * 0.5;\n        v_uv = (vec2(mod(u_tileIndex, 16.0), floor(u_tileIndex / 16.0)) + texPosition) / vec2(16.0, 3.0);\n\n        vec2 halfPixel = vec2(0.5, 0.5) * u_pixel;\n        vec2 base = corner + a_position;\n        float height = texture2D(u_heightMap, base * u_pixel + halfPixel).COMP1D;\n        float waterHeight = texture2D(u_waterHeightMap, base * u_pixel + halfPixel).COMP1D + u_offsetHeight;\n        float value = clamp(waterHeight - height, 0.0, 1.0);\n\n        if (value <= deepLevel) {\n          value = max(0.0, value - minDepth) / (deepLevel - minDepth);\n          v_color = mix(u_minShallowColor, u_maxShallowColor, value) / 255.0;\n        } else {\n          value = clamp(value - deepLevel, 0.0, maxDepth - deepLevel) / (maxDepth - deepLevel);\n          v_color = mix(u_minDeepColor, u_maxDeepColor, value) / 255.0;\n        }\n\n        v_position = base * 128.0 + u_offset;\n        gl_Position = u_mvp * vec4(v_position, waterHeight * 128.0, 1.0);\n      } else {\n        v_uv = vec2(0.0);\n        v_color = vec4(0.0);\n\n        gl_Position = vec4(0.0);\n      }\n    }\n  "),fsWater:"\n    uniform sampler2D u_waterMap;\n\n    uniform vec4 u_mapBounds;\n\n    varying vec2 v_position;\n    varying vec2 v_uv;\n    varying vec4 v_color;\n\n    void main() {\n      vec2 d2 = min(v_position - u_mapBounds.xy, u_mapBounds.zw - v_position);\n      float d1 = clamp(min(d2.x, d2.y) / 64.0 + 1.0, 0.0, 1.0) * 0.8 + 0.2;\n      gl_FragColor = texture2D(u_waterMap, v_uv).rgba * vec4(v_color.rgb * d1, v_color.a);\n    }\n  ",vsCliffs:"\n    uniform mat4 u_mvp;\n    uniform sampler2D u_heightMap;\n    uniform vec2 u_pixel;\n    uniform vec2 u_size;\n    uniform vec2 u_centerOffset;\n\n    attribute vec3 a_position;\n    attribute vec3 a_normal;\n    attribute vec2 a_uv1;\n    attribute vec2 a_uv2;\n    attribute vec3 a_instancePosition;\n    attribute float a_instanceTexture;\n\n    varying vec3 v_normal1;\n    varying vec3 v_normal2;\n    varying float v_height;\n    varying vec2 v_uv1;\n    varying vec2 v_uv2;\n    varying vec2 v_suv;\n    varying float v_texture;\n\n    const float normalDist = 1.0;\n\n    void main() {\n      // Half of a pixel in the cliff height map.\n      vec2 halfPixel = u_pixel * 0.5;\n\n      vec3 position = vec3(a_position.y, -a_position.x, a_position.z);\n\n      // The bottom left corner of the map tile this vertex is on.\n      vec2 corner = ((a_instancePosition.xy - u_centerOffset.xy + position.xy) / 128.0);\n\n      float height = texture2D(u_heightMap, corner * u_pixel + halfPixel).COMP1D;\n\n      float hL = texture2D(u_heightMap, vec2(corner - vec2(normalDist, 0.0)) * u_pixel + halfPixel).COMP1D;\n      float hR = texture2D(u_heightMap, vec2(corner + vec2(normalDist, 0.0)) * u_pixel + halfPixel).COMP1D;\n      float hD = texture2D(u_heightMap, vec2(corner - vec2(0.0, normalDist)) * u_pixel + halfPixel).COMP1D;\n      float hU = texture2D(u_heightMap, vec2(corner + vec2(0.0, normalDist)) * u_pixel + halfPixel).COMP1D;\n\n      v_normal1 = normalize(vec3(hL - hR, hD - hU, normalDist * 2.0));\n      v_normal2 = vec3(a_normal.y, -a_normal.x, a_normal.z);\n      v_height = position.z / 128.0;\n\n      v_uv1 = a_uv1;\n      v_uv2 = a_uv2;\n      v_suv = corner / u_size;\n      v_texture = a_instanceTexture;\n\n      gl_Position = u_mvp * vec4(position + vec3(a_instancePosition.xy, a_instancePosition.z + height * 128.0), 1.0);\n    }\n  ",fsCliffs:"\n    uniform sampler2D u_texture1;\n    uniform sampler2D u_texture2;\n    uniform sampler2D u_shadowMap;\n\n    varying vec3 v_normal1;\n    varying vec3 v_normal2;\n    varying float v_height;\n    varying vec2 v_uv1;\n    varying vec2 v_uv2;\n    varying vec2 v_suv;\n    varying float v_texture;\n\n    const vec3 lightDirection = normalize(vec3(-0.3, -0.3, 0.25));\n\n    vec4 sample(int texture) {\n      if (texture == 0) {\n        return texture2D(u_texture1, v_uv1);\n      } else if (texture == 1) {\n        return texture2D(u_texture2, v_uv1);\n      } else {\n        vec4 c1 = texture2D(u_texture1, v_uv1).rgba;\n        vec4 c2 = texture2D(u_texture2, v_uv2).rgba;\n        return mix(c1, c2, c2.a);\n      }\n    }\n\n    void main() {\n      vec4 color = sample(int(v_texture+0.01)).rgba;\n\n      float height = 2.0 * (fract(v_height) - 0.5);\n      height = height * height;\n      vec3 normal = normalize(mix(v_normal2, v_normal1, height));\n\n      float shadow = texture2D(u_shadowMap, v_suv).COMP1D;\n      color.xyz *= clamp(dot(normal, lightDirection) + 0.45, 0.1, 1.0);\n      color.xyz *= 1.0 - shadow;\n\n      gl_FragColor = color;\n    }\n  ",vsUberSplat:"\n    uniform mat4 u_mvp;\n    uniform sampler2D u_heightMap;\n    uniform vec2 u_pixel;\n    uniform vec2 u_size;\n    uniform vec2 u_shadowPixel;\n    uniform vec2 u_centerOffset;\n\n    attribute vec3 a_position;\n    attribute vec2 a_uv;\n\n    varying vec2 v_uv;\n    varying vec2 v_suv;\n    varying vec3 v_normal;\n\n    const float normalDist = 0.25;\n\n    void main() {\n      vec2 halfPixel = u_pixel * 0.5;\n\n      vec2 base = (a_position.xy - u_centerOffset) / 128.0;\n      float height = texture2D(u_heightMap, base * u_pixel + halfPixel).COMP1D;\n\n      float hL = texture2D(u_heightMap, vec2(base - vec2(normalDist, 0.0)) * u_pixel + halfPixel).COMP1D;\n      float hR = texture2D(u_heightMap, vec2(base + vec2(normalDist, 0.0)) * u_pixel + halfPixel).COMP1D;\n      float hD = texture2D(u_heightMap, vec2(base - vec2(0.0, normalDist)) * u_pixel + halfPixel).COMP1D;\n      float hU = texture2D(u_heightMap, vec2(base + vec2(0.0, normalDist)) * u_pixel + halfPixel).COMP1D;\n\n      v_normal = normalize(vec3(hL - hR, hD - hU, normalDist * 2.0));\n      v_uv = a_uv;\n      v_suv = base / u_size;\n\n      gl_Position = u_mvp * vec4(a_position.xy, height * 128.0 + a_position.z, 1.0);\n    }\n  ",fsUberSplat:"\n    uniform sampler2D u_texture;\n    uniform sampler2D u_shadowMap;\n    uniform vec4 u_color;\n\n    varying vec2 v_uv;\n    varying vec2 v_suv;\n    varying vec3 v_normal;\n\n    const vec3 lightDirection = normalize(vec3(-0.3, -0.3, 0.25));\n\n    void main() {\n      if (any(bvec4(lessThan(v_uv, vec2(0.0)), greaterThan(v_uv, vec2(1.0))))) {\n        discard;\n      }\n      vec4 color = texture2D(u_texture, clamp(v_uv, 0.0, 1.0)).rgba * u_color;\n\n      float shadow = texture2D(u_shadowMap, v_suv).COMP1D;\n      color.xyz *= clamp(dot(v_normal, lightDirection) + 0.45, 0.0, 1.0);\n      color.xyz *= 1.0 - shadow;\n\n      gl_FragColor = color;\n    }\n  ",vsSimpleModel:"\n    uniform mat4 u_mvp;\n\n    attribute vec3 a_position;\n    attribute vec3 a_normal;\n    attribute vec2 a_uv;\n    attribute vec3 a_instancePosition;\n    attribute vec2 a_instanceRotation;\n    attribute float a_instanceScale;\n\n    varying vec3 v_normal;\n    varying vec2 v_uv;\n\n    ".concat(Uf,"\n\n    void main() {\n      v_normal = quat_transform(a_instanceRotation, a_normal);\n      v_uv = a_uv;\n\n      gl_Position = u_mvp * vec4(quat_transform(a_instanceRotation, a_position) * a_instanceScale + a_instancePosition, 1.0);\n    }\n  "),fsSimpleModel:"\n    uniform sampler2D u_texture;\n    uniform bool u_alphaTest;\n    uniform bool u_unshaded;\n\n    varying vec3 v_normal;\n    varying vec2 v_uv;\n\n    const vec3 lightDirection = normalize(vec3(-0.3, -0.3, 0.25));\n\n    void main() {\n      vec4 color = texture2D(u_texture, v_uv).rgba;\n\n      // 1bit Alpha\n      if (u_alphaTest && color.a < 0.75) {\n        discard;\n      }\n\n      if (!u_unshaded) {\n        color *= clamp(dot(v_normal, lightDirection) + 0.45, 0.1, 1.0);\n      }\n\n      gl_FragColor = color;\n    }\n  "};const SE={AAAB:1,AAAC:1,AABA:1,AABB:2,AABC:0,AACA:1,AACB:0,AACC:1,ABAA:1,ABAB:1,ABAC:0,ABBA:2,ABBB:1,ABBC:0,ABCA:0,ABCB:0,ABCC:0,ACAA:1,ACAB:0,ACAC:1,ACBA:0,ACBB:0,ACBC:0,ACCA:1,ACCB:0,ACCC:1,BAAA:1,BAAB:1,BAAC:0,BABA:1,BABB:1,BABC:0,BACA:0,BACB:0,BACC:0,BBAA:1,BBAB:1,BBAC:0,BBBA:1,BBCA:0,BCAA:0,BCAB:0,BCAC:0,BCBA:0,BCCA:0,CAAA:1,CAAB:0,CAAC:1,CABA:0,CABB:0,CABC:0,CACA:1,CACB:0,CACC:1,CBAA:0,CBAB:0,CBAC:0,CBBA:0,CBCA:0,CCAA:1,CCAB:0,CCAC:1,CCBA:0,CCCA:1},RE={AAAB:2,AAAC:1,AABA:1,AABB:3,AABC:0,AACA:1,AACB:0,AACC:3,ABAA:1,ABAB:2,ABAC:0,ABBA:3,ABBB:0,ABBC:0,ABCA:0,ABCB:0,ABCC:0,ACAA:1,ACAB:0,ACAC:2,ACBA:0,ACBB:0,ACBC:0,ACCA:3,ACCB:0,ACCC:1,BAAA:1,BAAB:3,BAAC:0,BABA:2,BABB:0,BABC:0,BACA:0,BACB:0,BACC:0,BBAA:3,BBAB:1,BBAC:0,BBBA:1,BBCA:0,BCAA:0,BCAB:0,BCAC:0,BCBA:0,BCCA:0,CAAA:1,CAAB:0,CAAC:3,CABA:0,CABB:0,CABC:0,CACA:2,CACB:0,CACC:1,CBAA:0,CBAB:0,CBAC:0,CBBA:0,CBCA:0,CCAA:3,CCAB:0,CCAC:1,CCBA:0,CCCA:1};function bE(e,t,i){return"Cliffs"===e?Math.min(i,SE[t]):Math.min(i,RE[t])}class IE{constructor(e,t,i,r,n){let s=new nr(t),a=s.geosets[0],o=a.vertices,l=a.normals,h=a.uvSets[0],c=a.uvSets[1],d=a.faces,u=o.byteLength,m=u+l.byteLength,f=m+h.byteLength,p=f+(c?c.byteLength:0);c||(f=m);let E=i.length/3;if(!r&&(this.textures=s.textures.map(e=>e.path?n.load(e.path):null),r=new Uint8Array(E),c&&s.textures.length>=2))for(let v=0;v<E;++v)r[v]=2;let g=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,g),e.bufferData(e.ARRAY_BUFFER,p,e.STATIC_DRAW),e.bufferSubData(e.ARRAY_BUFFER,0,o),e.bufferSubData(e.ARRAY_BUFFER,u,l),e.bufferSubData(e.ARRAY_BUFFER,m,h),c&&e.bufferSubData(e.ARRAY_BUFFER,f,c);let A=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,A),e.bufferData(e.ELEMENT_ARRAY_BUFFER,d,e.STATIC_DRAW);let _=4*i.length,T=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,T),e.bufferData(e.ARRAY_BUFFER,_+E,e.STATIC_DRAW),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(i)),e.bufferSubData(e.ARRAY_BUFFER,_,new Uint8Array(r)),this.vertexBuffer=g,this.faceBuffer=A,this.normalsOffset=u,this.uvsOffset=m,this.uvs2Offset=f,this.elements=d.length,this.locationAndTextureBuffer=T,this.texturesOffset=_,this.instances=E}render(e,t,i,r){if(this.textures)for(let n=0;n<this.textures.length&&n<2;++n)if(e.activeTexture(e.TEXTURE1+n),this.textures[n]){if(!this.textures[n].webglResource)return;e.bindTexture(e.TEXTURE_2D,this.textures[n].webglResource),this.disabledMips||(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),this.disabledMips=!0)}else e.bindTexture(e.TEXTURE_2D,r[n].webglResource);e.bindBuffer(e.ARRAY_BUFFER,this.locationAndTextureBuffer),e.vertexAttribPointer(i.a_instancePosition,3,e.FLOAT,!1,12,0),e.vertexAttribPointer(i.a_instanceTexture,1,e.UNSIGNED_BYTE,!1,1,this.texturesOffset),e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer),e.vertexAttribPointer(i.a_position,3,e.FLOAT,!1,12,0),e.vertexAttribPointer(i.a_normal,3,e.FLOAT,!1,12,this.normalsOffset),e.vertexAttribPointer(i.a_uv1,2,e.FLOAT,!1,8,this.uvsOffset),e.vertexAttribPointer(i.a_uv2,2,e.FLOAT,!1,8,this.uvs2Offset),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.faceBuffer),t.drawElementsInstancedANGLE(e.TRIANGLES,this.elements,e.UNSIGNED_SHORT,0,this.instances)}}class LE{constructor(e,t,i,r,n){this.texture=i,this.batches=[],this.path=t,this.color=[1,1,1,1],this.locations=r;let s=[],a=[],o=[],l=r.length/5;for(let h=0;h<l;++h){let[t,i,l,c,d]=r.slice(5*h,5*h+5),u=Math.floor((t-n[0])/128),m=Math.ceil((l-n[0])/128),f=Math.floor((i-n[1])/128),p=Math.ceil((c-n[1])/128),E=(p-f+1)*(m-u+1);if(E>65e3)continue;let g=s.length/3,A=m-u+1;g+E>65e3&&(this.addBatch(e,s,a,o),s.length=0,a.length=0,o.length=0,g=0);for(let e=f;e<=p;++e){let r=128*e+n[1];for(let e=u;e<=m;++e){let o=128*e+n[0];s.push(o,r,d),a.push((o-t)/(l-t),1-(r-i)/(c-i))}}for(let e=0;e<p-f;++e)for(let t=0;t<m-u;++t){let i=g+e*A+t;o.push(i,i+1,i+A,i+1,i+A+1,i+A)}}o.length&&this.addBatch(e,s,a,o)}addBatch(e,t,i,r){let n=4*t.length,s=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,n+4*i.length,e.STATIC_DRAW),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(t)),e.bufferSubData(e.ARRAY_BUFFER,n,new Float32Array(i));let a=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,a),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(r),e.STATIC_DRAW),this.batches.push({uvsOffset:n,vertexBuffer:s,faceBuffer:a,elements:r.length})}render(e,t,i){e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.texture.webglResource),e.uniform4fv(t.u_color,this.color);for(let r of this.batches)e.bindBuffer(e.ARRAY_BUFFER,r.vertexBuffer),e.vertexAttribPointer(i.a_position,3,e.FLOAT,!1,12,0),e.vertexAttribPointer(i.a_uv,2,e.FLOAT,!1,8,r.uvsOffset),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,r.faceBuffer),e.drawElements(e.TRIANGLES,r.elements,e.UNSIGNED_SHORT,0)}}function NE(e,t){return e.sequence.rarity<t.sequence.rarity}function xE(e,t){let i=t.toLowerCase().split(/[- ]/).map(e=>e.trim());return e.every(e=>i.includes(e))}function PE(e,t,i){let r=i?i.split(",").filter(e=>e.length).map(e=>e.toLowerCase()):[],n=function(e,t,i){let r=[];for(let n=0,s=t.length;n<s;n++){let s=t[n];s.name.split("-")[0].replace(/\d/g,"").trim().toLowerCase()===e&&xE(i,s.name)&&r.push({sequence:s,index:n})}return r}(e,t,r);if(!n.length){r.push(e);let i=t.findIndex(e=>xE(r,e.name));i>=0&&n.push({sequence:t[i],index:i})}n.sort(NE);for(var s=0,a=n.length;s<a;s++){let e=n[s].sequence.rarity;if(0===e)break;if(10*Math.random()>e)return n[s]}let o=n.length-s;return n[s+Math.floor(Math.random()*o)]}function CE(e,t){let i=PE("stand",e.model.sequences,t);i&&e.setSequence(i.index)}function UE(e,t){e.model.whenLoaded().then(i=>{CE(e,t),e.on("seqend",()=>CE(e,t))})}let OE=ar.vec3.create(),DE=ar.vec3.create();let ME=(new class{constructor(){this.cache=new oe(this)}beginMapLoad(e){}onMapProgress(e){}finishMapLoad(e){}failMapLoad(e){}forceUpdate(){}}).cache;var FE={MapViewer:class extends _f{constructor(e,t,i){super(e),this.vm=new Ef(this),this.batchSize=256,this.on("error",(e,t,i)=>console.error(e,t,i)),this.addHandler(Df),this.addHandler(TE),this.addHandler(Im),this.wc3PathSolver=t,this.groundShader=this.loadShader("Ground",wE.vsGround,wE.fsGround),this.waterShader=this.loadShader("Water",wE.vsWater,wE.fsWater),this.cliffShader=this.loadShader("Cliffs",wE.vsCliffs,wE.fsCliffs),this.simpleModelShader=this.loadShader("SimpleModel",wE.vsSimpleModel,wE.fsSimpleModel),this.uberSplatShader=this.loadShader("UberSplats",wE.vsUberSplat,wE.fsUberSplat),this.scene=this.addScene(),this.camera=this.scene.camera,this.units=[],this.waterIndex=0,this.waterIncreasePerFrame=0,this.anyReady=!1,this.terrainCliffsAndWaterLoaded=!1,this.terrainData=new dp,this.cliffTypesData=new dp,this.waterData=new dp,this.terrainReady=!1,this.cliffsReady=!1,this.shadowsReady=!1;const r=i.objects();Promise.all([r,...["TerrainArt\\Terrain.slk","TerrainArt\\CliffTypes.slk","TerrainArt\\Water.slk"].map(e=>this.loadGeneric(t(e)[0],"text",void 0,e).whenLoaded())]).then(e=>{let[t,i,r,n]=e;this.terrainObjects=t.objects,this.terrainCliffsAndWaterLoaded=!0,this.terrainData.load(i.data),this.cliffTypesData.load(r.data),this.waterData.load(n.data),this.emit("terrainloaded")}),this.doodadsAndDestructiblesLoaded=!1,this.doodadsData=new dp,this.doodadMetaData=new dp,this.destructableMetaData=new dp,this.doodads=[],this.terrainDoodads=[],this.doodadsReady=!1,this.uberSplats=[],this.uberSplatsReady=!1,r.then(e=>{this.doodadsAndDestructiblesLoaded=!0,this.doodadsData=e.objects,this.emit("doodadsloaded")}),this.unitsAndItemsLoaded=!1,this.unitsData=new dp,this.unitMetaData=new dp,this.uberSplatData=new dp,this.units=[],this.unitsReady=!1,Promise.all([r,this.loadGeneric(t("Splats\\UberSplatData.slk")[0],"text",void 0,"Splats\\UberSplatData.slk")]).then(e=>{let[t,i]=e;this.unitsAndItemsLoaded=!0,this.unitsData=t.objects,this.uberSplatData.load(i.data),this.emit("unitsloaded")});let n=this.gl,s=n.createTexture();n.bindTexture(n.TEXTURE_2D,s),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texImage2D(n.TEXTURE_2D,0,n.R8,4,4,0,n.RED,n.UNSIGNED_BYTE,new Uint8Array(16)),this.shadowMap=s,this.tocDocument=null}renderGround(){if(this.terrainReady){let e=this.gl,t=this.webgl,i=t.extensions.instancedArrays,r=this.groundShader,n=r.uniforms,s=r.attribs,{columns:a,rows:o,centerOffset:l,vertexBuffer:h,faceBuffer:c,heightMap:d,cliffHeightMap:u,instanceBuffer:m,instanceCount:f,textureBuffer:p,variationBuffer:E,heightMapSize:g}=this.terrainRenderData,A=this.tilesetTextures,_=s.a_InstanceID,T=s.a_position,v=s.a_textures,y=s.a_variations;e.disable(e.BLEND),t.useShaderProgram(r),e.uniformMatrix4fv(n.u_mvp,!1,this.camera.worldProjectionMatrix),e.uniform2fv(n.u_offset,l),e.uniform2f(n.u_size,a-1,o-1),e.uniform2fv(n.u_pixel,g),e.uniform1i(n.u_heightMap,0),e.uniform1i(n.u_tilesets,1),e.uniform1i(n.u_shadowMap,2),e.uniform1i(n.u_heightMap0,3),e.uniform1f(n.u_tilesetHeight,1/(A.length+1)),e.uniform1f(n.u_tilesetCount,A.length+1),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,d),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.tilesetsTexture),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,this.shadowMap),e.activeTexture(e.TEXTURE3),e.bindTexture(e.TEXTURE_2D,u),e.bindBuffer(e.ARRAY_BUFFER,h),e.vertexAttribPointer(T,2,e.FLOAT,!1,8,0),e.bindBuffer(e.ARRAY_BUFFER,m),e.vertexAttribPointer(_,1,e.FLOAT,!1,4,0),i.vertexAttribDivisorANGLE(_,1),e.bindBuffer(e.ARRAY_BUFFER,p),e.vertexAttribPointer(v,4,e.UNSIGNED_BYTE,!1,4,0),i.vertexAttribDivisorANGLE(v,1),e.bindBuffer(e.ARRAY_BUFFER,E),e.vertexAttribPointer(y,4,e.UNSIGNED_BYTE,!1,4,0),i.vertexAttribDivisorANGLE(y,1),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,c),i.drawElementsInstancedANGLE(e.TRIANGLES,6,e.UNSIGNED_BYTE,0,f),i.vertexAttribDivisorANGLE(v,0),i.vertexAttribDivisorANGLE(y,0),i.vertexAttribDivisorANGLE(_,0)}}renderWater(){if(this.terrainReady){let e=this.gl,t=this.webgl,i=t.extensions.instancedArrays,r=this.waterShader,n=r.uniforms,s=r.attribs,a=this.mapBounds,{columns:o,rows:l,centerOffset:h,vertexBuffer:c,faceBuffer:d,heightMap:u,instanceBuffer:m,instanceCount:f,waterHeightMap:p,waterBuffer:E,heightMapSize:g}=this.terrainRenderData,A=s.a_InstanceID,_=s.a_position,T=s.a_isWater;e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),t.useShaderProgram(r),e.uniformMatrix4fv(n.u_mvp,!1,this.camera.worldProjectionMatrix),e.uniform2fv(n.u_offset,h),e.uniform2f(n.u_size,o-1,l-1),e.uniform2fv(n.u_pixel,g),e.uniform1i(n.u_heightMap,0),e.uniform1i(n.u_waterHeightMap,1),e.uniform1i(n.u_waterMap,2),e.uniform1f(n.u_offsetHeight,this.waterHeightOffset),e.uniform1f(n.u_tileIndex,0|this.waterIndex),e.uniform4fv(n.u_maxDeepColor,this.maxDeepColor),e.uniform4fv(n.u_minDeepColor,this.minDeepColor),e.uniform4fv(n.u_maxShallowColor,this.maxShallowColor),e.uniform4f(n.u_mapBounds,128*a[0]+h[0],128*a[2]+h[1],128*(o-a[1]-1)+h[0],128*(l-a[3]-1)+h[1]),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,u),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,p),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,this.waterTexture),e.bindBuffer(e.ARRAY_BUFFER,c),e.vertexAttribPointer(_,2,e.FLOAT,!1,8,0),e.bindBuffer(e.ARRAY_BUFFER,m),e.vertexAttribPointer(A,1,e.FLOAT,!1,4,0),i.vertexAttribDivisorANGLE(A,1),e.bindBuffer(e.ARRAY_BUFFER,E),e.vertexAttribPointer(T,1,e.UNSIGNED_BYTE,!1,1,0),i.vertexAttribDivisorANGLE(T,1),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,d),i.drawElementsInstancedANGLE(e.TRIANGLES,6,e.UNSIGNED_BYTE,0,f),i.vertexAttribDivisorANGLE(T,0),i.vertexAttribDivisorANGLE(A,0)}}renderCliffs(){if(this.cliffsReady){let e=this.gl,t=e.extensions.instancedArrays,i=this.webgl,r=this.cliffShader,n=r.attribs,s=r.uniforms,{columns:a,rows:o,centerOffset:l,cliffHeightMap:h,heightMapSize:c}=this.terrainRenderData;e.disable(e.BLEND),i.useShaderProgram(r),e.uniformMatrix4fv(s.u_mvp,!1,this.camera.worldProjectionMatrix),e.uniform1i(s.u_heightMap,0),e.uniform2f(s.u_size,a-1,o-1),e.uniform2fv(s.u_pixel,c),e.uniform2fv(s.u_centerOffset,l),e.uniform1i(s.u_texture1,1),e.uniform1i(s.u_texture2,2),e.uniform1i(s.u_shadowMap,3),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,h),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.cliffTextures[0].webglResource),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),this.cliffTextures.length>1&&(e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,this.cliffTextures[1].webglResource),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR)),e.activeTexture(e.TEXTURE3),e.bindTexture(e.TEXTURE_2D,this.shadowMap),t.vertexAttribDivisorANGLE(n.a_instancePosition,1),t.vertexAttribDivisorANGLE(n.a_instanceTexture,1);for(let d of this.cliffModels)d.render(e,t,n,this.cliffTextures);t.vertexAttribDivisorANGLE(n.a_instancePosition,0),t.vertexAttribDivisorANGLE(n.a_instanceTexture,0)}}renderUberSplats(){if(this.terrainReady&&this.uberSplatsReady){let e=this.gl,t=this.webgl,i=this.uberSplatShader,r=i.attribs,n=i.uniforms,{columns:s,rows:a,centerOffset:o,heightMap:l,heightMapSize:h}=this.terrainRenderData;e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.blendEquation(e.FUNC_ADD),t.useShaderProgram(i),e.uniformMatrix4fv(n.u_mvp,!1,this.camera.worldProjectionMatrix),e.uniform1i(n.u_heightMap,0),e.uniform2f(n.u_size,s-1,a-1),e.uniform2fv(n.u_pixel,h),e.uniform2fv(n.u_centerOffset,o),e.uniform1i(n.u_texture,1),e.uniform1i(n.u_shadowMap,2),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,l),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,this.shadowMap);for(let c of this.uberSplatModels)c.render(e,n,r)}}render(){this.anyReady&&(this.gl.viewport(...this.camera.rect),this.renderGround(),this.renderCliffs(),super.renderOpaque(),this.renderUberSplats(),this.renderWater(),super.renderTranslucent())}update(){this.anyReady&&(this.waterTextures&&(this.waterIndex+=this.waterIncreasePerFrame,this.waterIndex>=this.waterTextures.length&&(this.waterIndex=0)),super.update())}async loadMap(e){this.mapMpq=new Ei(e,!0);let t=this.wc3PathSolver,i=new Xt(this.mapMpq.get("war3map.w3i").arrayBuffer());this.w3i=i,this.tileset=i.tileset,this.editorVersion=i.editorVersion,this.mapBounds=i.cameraBoundsComplements,this.mapFlags=i.flags,this.emit("maploaded"),this.mapPathSolver=(e=>t(e,this.tileset));let r=new Vt(this.mapMpq.get("war3map.w3e").arrayBuffer());this.corners=r.corners,this.centerOffset=r.centerOffset,this.mapSize=r.mapSize,this.calculateRamps();const n=this.mapMpq.get("war3map.doo");if(!n)return;let s,a;this.doodads=new Pt(n.arrayBuffer()),this.emit("tilesetloaded"),this.terrainCliffsAndWaterLoaded?this.loadTerrainCliffsAndWater(r):this.once("terrainloaded",()=>this.loadTerrainCliffsAndWater(r)),this.shadows=[],this.shadowTextures={},this.doodadsAndDestructiblesLoaded?(this.loadDoodadsAndDestructibles(),s=Promise.resolve()):s=new Promise((e,t)=>{this.once("doodadsloaded",()=>{this.loadDoodadsAndDestructibles(),e()})}),this.unitsAndItemsLoaded?(this.loadUnitsAndItems(),a=Promise.resolve()):a=new Promise((e,t)=>{this.once("unitsloaded",()=>{this.loadUnitsAndItems(),e()})}),this.loadGameUI()}async loadGameScripts(){return await Promise.all(["Scripts\\common.j","Scripts\\Blizzard.j"].map(e=>this.load(e).whenLoaded()))}async loadGameUI(){return await Promise.all(["UI\\FrameDef\\FrameDef.toc"].map(e=>this.load(e).whenLoaded()))}async runMapScript(){}async loadPlain(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"text";const i=await fetch(ME.binary(e));return await(i.ok?i[t]():Promise.reject())}loadDoodadsAndDestructibles(){let e=this.scene,t=this.doodads;for(let i of t.doodads){let t=this.doodadsData.find(e=>e.id===i.id);if(!t)continue;let r=t.type,n=(t=t.data).file,s=parseInt(t.numvar||"0");n.endsWith(".mdl")&&(n=n.slice(0,-4));let a=n;n+=".mdx",s>1&&(a+=Math.min(i.variation,s-1)),a+=".mdx";let o=[255,255,255];"destructible"===r&&(o[0]=parseInt(t.colorr),o[1]=parseInt(t.colorg),o[2]=parseInt(t.colorb)),"destructible"===r&&t.shadow&&"_"!==t.shadow&&this.addShadow(t.shadow,i.location[0],i.location[1]);let l,h=this.mapMpq.get(a)||this.mapMpq.get(n);(l=h?this.load(h.name):this.load(a)).whenLoaded().then(()=>{let r=l.addInstance();if(t.texfile){const e=l.replaceables.indexOf(parseInt(t.texid||"0"));if(e>=0){let i=t.texfile;i.lastIndexOf(".")<=Math.max(i.lastIndexOf("/"),i.lastIndexOf("\\"))&&(i+=".blp"),r.setTexture(l.textures[e],this.load(i))}}r.move(i.location),r.rotateLocal(ar.quat.setAxisAngle(ar.quat.create(),Ir,i.angle)),r.scale(i.scale),r.setScene(e),this.inPlayableArea(i.location[0],i.location[1])||(o[0]=Math.round(51*o[0]/255),o[1]=Math.round(51*o[1]/255),o[2]=Math.round(51*o[2]/255)),r.setVertexColor(o),UE(r)})}this.doodadsReady=!0,this.anyReady=!0}loadUnitsAndItems(e){const t=this.mapMpq.get("war3mapUnits.doo");if(!t)return;let i=new fi(t.arrayBuffer()),r=this.scene,n={};for(let s of i.units){let e,t=s.location,i=s.scale,a=s.player,o="";this.editorVersion<6056&&a>=12&&(a+=12);let l=null,h=[255,255,255];if("sloc"===s.id)e="Objects\\StartLocation\\StartLocation.mdx";else{if(!(l=this.unitsData.find(e=>e.id===s.id)))continue;const r=l.type;(e=(l=l.data).file).endsWith(".mdl")&&(e=e.slice(0,-4)),i=ar.vec3.clone(s.scale),ar.vec3.scale(i,i,l.modelscale);let c=l.teamcolor&&parseInt(l.teamcolor);l.teamcolor&&c>=0&&(a=c),"unit"===r?(h[0]=parseInt(l.red),h[1]=parseInt(l.green),h[2]=parseInt(l.blue)):"item"===r&&(h[0]=parseInt(l.colorr),h[1]=parseInt(l.colorg),h[2]=parseInt(l.colorb));let d=l.moveheight&&parseFloat(l.moveheight);d&&((t=ar.vec3.clone(s.location))[2]+=d),e+=".mdx";let u=l.ubersplat&&this.uberSplatData.getRow(l.ubersplat);if(u){let e="".concat(u.Dir,"\\").concat(u.file,".blp");n[e]||(n[e]={locations:[],opacity:1});let t=s.location[0],i=s.location[1],r=u.Scale;n[e].locations.push(t-r,i-r,t+r,i+r,1)}if(l.unitshadow&&"_"!==l.unitshadow){let e="ReplaceableTextures\\Shadows\\".concat(l.unitshadow,".blp"),t=parseFloat(l.shadowx||"0"),i=parseFloat(l.shadowy||"0"),r=parseFloat(l.shadoww||"0"),a=parseFloat(l.shadowh||"0");n[e]||(n[e]={locations:[],opacity:.5});let o=s.location[0]-t,h=s.location[1]-i;n[e].locations.push(o,h,o+r,h+a,3)}l.buildingshadow&&"_"!==l.buildingshadow&&this.addShadow(l.buildingshadow,s.location[0],s.location[1]),o=l.animprops}if(e){let n=this.load(e).addInstance();n.move(t),n.rotateLocal(ar.quat.setAxisAngle(ar.quat.create(),Ir,s.angle)),n.scale(i),n.setTeamColor(a),n.setScene(r),this.inPlayableArea(t[0],t[1])||(h[0]=Math.round(51*h[0]/255),h[1]=Math.round(51*h[1]/255),h[2]=Math.round(51*h[2]/255)),n.setVertexColor(h),l&&this.units.push({unit:s,instance:n,location:t,radius:36*parseFloat(l.scale||"0")}),UE(n,o)}else console.log("Unknown unit ID",s.id,s)}this.unitsReady=!0,this.anyReady=!0,this.createUberSplatModes(n)}createUberSplatModes(e){let t=Object.entries(e).map(e=>{let t=e[0],{locations:i,opacity:r}=e[1];return this.load(t).whenLoaded().then(e=>{let n=new LE(this.gl,t,e,i,this.centerOffset);return n.color[3]=r,n})});Promise.all(t).then(e=>{this.uberSplatModels=e,this.uberSplatsReady=!0})}createUnit(e,t,i,r){const n=this.mapMpq.get("war3mapUnits.doo");if(!n)return;let s=new fi(n.arrayBuffer()),a=this.scene,o=this.splats||{},l={};for(let h of s.units){if(h.id!==e)continue;let r,n=ar.vec3.fromValues(t,i,h.location.z),s=h.scale,c=h.player,d="";this.editorVersion<6056&&c>=12&&(c+=12);let u=null,m=[255,255,255];if("sloc"===h.id)r="Objects\\StartLocation\\StartLocation.mdx";else{if(!(u=this.unitsData.find(e=>e.id===h.id)))continue;const e=u.type;(r=(u=u.data).file).endsWith(".mdl")&&(r=r.slice(0,-4)),s=ar.vec3.clone(h.scale),ar.vec3.scale(s,s,u.modelscale);let t=u.teamcolor&&parseInt(u.teamcolor);u.teamcolor&&t>=0&&(c=t),"unit"===e?(m[0]=parseInt(u.red),m[1]=parseInt(u.green),m[2]=parseInt(u.blue)):"item"===e&&(m[0]=parseInt(u.colorr),m[1]=parseInt(u.colorg),m[2]=parseInt(u.colorb));let i=u.moveheight&&parseFloat(u.moveheight);i&&((n=ar.vec3.clone(h.location))[2]+=i),r+=".mdx";let a=u.ubersplat&&this.uberSplatData.getRow(u.ubersplat);if(a){let e="".concat(a.Dir,"\\").concat(a.file,".blp");o[e]||(o[e]={locations:[],opacity:1});let t=h.location[0],i=h.location[1],r=a.Scale;o[e].locations.push(t-r,i-r,t+r,i+r,1)}if(u.unitshadow&&"_"!==u.unitshadow){let e="ReplaceableTextures\\Shadows\\".concat(u.unitshadow,".blp"),t=parseFloat(u.shadowx||"0"),i=parseFloat(u.shadowy||"0"),r=parseFloat(u.shadoww||"0"),n=parseFloat(u.shadowh||"0");o[e]||(o[e]={locations:[],opacity:.5});let s=h.location[0]-t,a=h.location[1]-i;o[e].locations.push(s,a,s+r,a+n,3)}u.buildingshadow&&"_"!==u.buildingshadow&&this.addShadow(u.buildingshadow,h.location[0],h.location[1]),d=u.animprops}if(r){let e=this.load(r).addInstance();e.move(n),e.rotateLocal(ar.quat.setAxisAngle(ar.quat.create(),Ir,h.angle)),e.scale(s),e.setTeamColor(c),e.setScene(a),this.inPlayableArea(n[0],n[1])||(m[0]=Math.round(51*m[0]/255),m[1]=Math.round(51*m[1]/255),m[2]=Math.round(51*m[2]/255)),e.setVertexColor(m),u&&(l={unit:h,instance:e,location:n,radius:36*parseFloat(u.scale||"0")},this.units.push(l)),UE(e,d)}else console.log("Unknown unit ID",h.id,h)}return l&&(this.anyReady=!0),l}async loadTerrainCliffsAndWater(e){let t=e.tileset;this.tilesets=[],this.tilesetTextures=[];for(let N of e.groundTilesets){let e=this.terrainData.getRow(N);e&&(this.tilesets.push(e),this.tilesetTextures.push(this.load("".concat(e.dir,"\\").concat(e.file,".blp"))))}this.blightTextureIndex=this.tilesetTextures.length,this.tilesetTextures.push(this.load("TerrainArt\\Blight\\".concat({A:"Ashen",B:"Barrens",C:"Felwood",D:"Cave",F:"Lordf",G:"Dungeon",I:"Ice",J:"DRuins",K:"Citadel",L:"Lords",N:"North",O:"Outland",Q:"VillageFall",V:"Village",W:"Lordw",X:"Village",Y:"Village",Z:"Ruins"}[t],"_Blight.blp"))),this.cliffTilesets=[],this.cliffTextures=[];for(let N of e.cliffTilesets){let e=this.cliffTypesData.getRow(N);e&&(this.cliffTilesets.push(e),this.cliffTextures.push(this.load("".concat(e.texDir,"\\").concat(e.texFile,".blp"))))}let i=this.waterData.getRow("".concat(t,"Sha"));this.waterHeightOffset=i.height,this.waterIncreasePerFrame=i.texRate/60,this.waterTextures=[],this.maxDeepColor=new Float32Array([i.Dmax_R,i.Dmax_G,i.Dmax_B,i.Dmax_A]),this.minDeepColor=new Float32Array([i.Dmin_R,i.Dmin_G,i.Dmin_B,i.Dmin_A]),this.maxShallowColor=new Float32Array([i.Smax_R,i.Smax_G,i.Smax_B,i.Smax_A]),this.minShallowColor=new Float32Array([i.Smin_R,i.Smin_G,i.Smin_B,i.Smin_A]);for(let N=0,x=i.numTex;N<x;N++)this.waterTextures.push(this.load("".concat(i.texFile).concat(N<10?"0":"").concat(N,".blp")));await Af([...this.tilesetTextures,...this.waterTextures]);let r=this.gl;this.createTilesetsAndWaterTextures();let n=e.corners,[s,a]=this.mapSize,o=this.centerOffset,l=(s-1)*(a-1),h=new Float32Array(s*a),c=new Float32Array(s*a),d=new Float32Array(s*a),u=new Uint8Array(4*l),m=new Uint8Array(4*l),f=new Uint8Array(l),p=0,E={};this.columns=s-1,this.rows=a-1;let g={};for(let N of this.doodads.terrainDoodads){let e=this.terrainObjects.find(e=>e.id===N.id);e&&(g[(e=e.data).pathtex]||(g[e.pathtex]=this.load(e.pathtex)))}await Af(Object.values(g));for(let N of this.doodads.terrainDoodads){let e=this.terrainObjects.find(e=>e.id===N.id);if(!e)continue;let t=g[(e=e.data).pathtex];if(!t||!t.imageData)continue;let i=e.file+".mdx";E[i]||(E[i]={locations:[]});let[r,s]=N.location,a=t.originalData.width>>2,l=t.originalData.height>>2;for(let o=0;o<l;++o)for(let e=0;e<a;++e)n[s+o][r+e].rampType=-1;E[i].locations.push(128*(r+a/2)+o[0],128*(s+l/2)+o[1],128*(n[s][r].layerHeight-2))}for(let N=0;N<a;N++)for(let e=0;e<s;e++){let t=n[N][e],i=N*s+e;if(h[i]=t.groundHeight,c[i]=t.groundHeight+t.layerHeight+(t.rampAdjust||0)-2,d[i]=t.waterHeight,t.depth=t.water?this.waterHeightOffset+t.waterHeight-c[i]:0,N<a-1&&e<s-1){if(f[p]=this.isWater(e,N),t.rampType){if(t.rampType>0){let i=t.cliffTexture;15===i&&(i=1);let r=this.cliffTilesets[i].rampModelDir,s="Doodads\\Terrain\\".concat(r,"\\").concat(r).concat(t.rampName,"0.mdx"),a=t.layerHeight;a=1===t.cliffType?Math.min(a,n[N+2][e].layerHeight,n[N][e+1].layerHeight,n[N+2][e+1].layerHeight):Math.min(a,n[N+1][e].layerHeight,n[N][e+2].layerHeight,n[N+1][e+2].layerHeight),E[s]||(E[s]={locations:[],textures:[]}),E[s].locations.push(128*e+o[0],128*N+o[1],128*(a-2)),E[s].textures.push(i)}}else if(this.isCliff(e,N)){let i=t.layerHeight,r=n[N][e+1].layerHeight,s=n[N+1][e].layerHeight,a=n[N+1][e+1].layerHeight,l=Math.min(i,r,s,a),h=this.cliffFileName(i,r,s,a,l);if("AAAA"!==h){let i=t.cliffTexture;15===i&&(i=1);let r=this.cliffTilesets[i].cliffModelDir,n="Doodads\\Terrain\\".concat(r,"\\").concat(r).concat(h).concat(bE(r,h,t.cliffVariation),".mdx");E[n]||(E[n]={locations:[],textures:[]}),E[n].locations.push(128*e+o[0],128*N+o[1],128*(l-2)),E[n].textures.push(i)}}else{let i=this.cornerTexture(e,N),r=this.cornerTexture(e+1,N),n=this.cornerTexture(e,N+1),s=this.cornerTexture(e+1,N+1),a=zf([i,r,n,s]).sort();u[4*p]=a[0]+1,m[4*p]=this.getVariation(a[0],t.groundVariation),a.shift();for(let e=0,t=a.length;e<t;e++){let t=a[e],o=0;r===t&&(o|=1),i===t&&(o|=2),s===t&&(o|=4),n===t&&(o|=8),u[4*p+1+e]=t+1,m[4*p+1+e]=o}}p+=1}}let A=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,A),r.bufferData(r.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,1,1]),r.STATIC_DRAW);let _=r.createBuffer();r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,_),r.bufferData(r.ELEMENT_ARRAY_BUFFER,new Uint8Array([0,1,2,1,3,2]),r.STATIC_DRAW);let T=r.createTexture();r.bindTexture(r.TEXTURE_2D,T),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texImage2D(r.TEXTURE_2D,0,r.R32F,s,a,0,r.RED,r.FLOAT,h);let v=r.createTexture();r.bindTexture(r.TEXTURE_2D,v),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texImage2D(r.TEXTURE_2D,0,r.R32F,s,a,0,r.RED,r.FLOAT,c);let y=r.createTexture();r.bindTexture(r.TEXTURE_2D,y),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texImage2D(r.TEXTURE_2D,0,r.R32F,s,a,0,r.RED,r.FLOAT,d);let w=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,w),r.bufferData(r.ARRAY_BUFFER,new Float32Array(l).map((e,t,i)=>t),r.STATIC_DRAW);let S=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,S),r.bufferData(r.ARRAY_BUFFER,u,r.STATIC_DRAW);let R=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,R),r.bufferData(r.ARRAY_BUFFER,m,r.STATIC_DRAW);let b=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,b),r.bufferData(r.ARRAY_BUFFER,f,r.STATIC_DRAW);let I=new Float32Array([1/s,1/a]);this.terrainRenderData={rows:a,columns:s,centerOffset:o,vertexBuffer:A,faceBuffer:_,heightMap:v,instanceBuffer:w,instanceCount:l,cornerTextures:u,textureBuffer:S,variationBuffer:R,heightMapSize:I,cliffHeightMap:T,waterHeightMap:y,waterBuffer:b},this.terrainReady=!0,this.anyReady=!0,this.createWaves();let L=Object.entries(E).map(e=>{let t=e[0],{locations:i,textures:n}=e[1];return this.loadGeneric(this.mapPathSolver(t)[0],"arrayBuffer",void 0,t).whenLoaded().then(e=>new IE(r,e.data,i,n,this))});this.cliffModels=await Promise.all(L),this.cliffModels.sort((e,t)=>!e.textures>!t.textures),this.cliffsReady=!0}calculateRamps(){let e=this.corners,[t,i]=this.mapSize,r=["AAHL","AALH","ABHL","AHLA","ALHA","ALHB","BALH","BHLA","HAAL","HBAL","HLAA","HLAB","LAAH","LABH","LHAA","LHBA"];for(let n=1;n<i-1;++n)for(let i=1;i<t-1;++i){let t=e[n][i];if(!t.ramp)continue;let r=e[n-1][i-1],s=e[n][i-1],a=e[n+1][i-1],o=e[n+1][i],l=e[n+1][i+1],h=e[n][i+1],c=e[n-1][i+1],d=e[n-1][i],u=t.layerHeight;if(s.ramp&&h.ramp||o.ramp&&d.ramp){let e=0;s.ramp&&h.ramp&&(e=Math.max(e,(s.layerHeight+h.layerHeight)/2-u)),o.ramp&&d.ramp&&(e=Math.max(e,(o.layerHeight+d.layerHeight)/2-u)),r.ramp&&l.ramp&&(e=Math.max(e,((r.layerHeight+l.layerHeight)/2-u)/2)),a.ramp&&c.ramp&&(e=Math.max(e,((a.layerHeight+c.layerHeight)/2-u)/2)),t.rampAdjust=e}}for(let n=0;n<i-1;++n)for(let s=0;s<t-1;++s){let a=e[n][s],o=e[n+1][s],l=e[n][s+1],h=e[n+1][s+1];if(!a.rampType&&n<i-2){let t=e[n+2][s],i=e[n+2][s+1],c=Math.min(a.layerHeight,t.layerHeight),d=Math.min(l.layerHeight,i.layerHeight);if(o.layerHeight===c&&h.layerHeight===d){let e=Math.min(c,d);if(a.ramp===o.ramp&&a.ramp===t.ramp&&l.ramp===h.ramp&&l.ramp===i.ramp&&a.ramp!==l.ramp){let n=this.rampFileName(t,i,l,a,e);r.includes(n)&&(a.rampName=n,a.rampType=1,o.rampType=-1)}}}if(!a.rampType&&s<t-2){let t=e[n][s+2],i=e[n+1][s+2],c=Math.min(a.layerHeight,t.layerHeight),d=Math.min(o.layerHeight,i.layerHeight);if(l.layerHeight===c&&h.layerHeight===d){let e=Math.min(c,d);if(a.ramp===l.ramp&&a.ramp===t.ramp&&o.ramp===h.ramp&&o.ramp===i.ramp&&a.ramp!==o.ramp){let n=this.rampFileName(o,i,t,a,e);r.includes(n)&&(a.rampName=n,a.rampType=2,l.rampType=-1)}}}}for(let n=0;n<i-1;++n)for(let i=0;i<t-1;++i){let t=e[n][i],r=e[n+1][i],s=e[n][i+1],a=e[n+1][i+1];if(t.rampAdjust||r.rampAdjust||s.rampAdjust||a.rampAdjust)continue;let o=t.layerHeight;r.layerHeight===o&&s.layerHeight===o&&a.layerHeight===o||(t.cliff=!0)}for(let n=0;n<i-1;++n)for(let r=0;r<t-1;++r){let s,a=e[n][r];if(a.rampType&&a.rampType>0){let o=r+1,l=n+1;1===a.rampType?(s=e[n+1][r],l=n+2):(s=e[n][r+1],o=r+2);let h=Math.max(0,r-1),c=Math.max(0,n-1);o=Math.min(o,t-1),l=Math.min(l,i-1);let d=null;for(let t=c;t<=l&&null==d;++t)for(let i=h;i<=o;++i){let r=e[t][i];if(r.cliff&&!r.rampType){d=r.cliffTexture;break}}null!=d&&(a.cliffTexture=s.cliffTexture=d)}}}cliffFileName(e,t,i,r,n){return String.fromCharCode(65+i-n)+String.fromCharCode(65+r-n)+String.fromCharCode(65+t-n)+String.fromCharCode(65+e-n)}rampFileName(e,t,i,r,n){let s=e.layerHeight-n,a=t.layerHeight-n,o=i.layerHeight-n,l=r.layerHeight-n;return s>2||a>2||o>2||l>2?"":(e.ramp?"LHX":"ABC")[s]+(t.ramp?"LHX":"ABC")[a]+(i.ramp?"LHX":"ABC")[o]+(r.ramp?"LHX":"ABC")[l]}createTilesetsAndWaterTextures(){let e=this.tilesetTextures,t=e.length,i=document.createElement("canvas"),r=i.getContext("2d");i.width=2048,i.height=64*(t+1);for(let l=0;l<t;l++){let t=e[l].imageData;if(t){for(let e=0;e<16;e++){let i=e%4*64,n=64*(e/4|0);r.putImageData(t,64*e-i,64*(l+1)-n,i,n,64,64)}if(512===t.width)for(let e=0;e<16;e++){let i=256+e%4*64,n=64*(e/4|0);r.putImageData(t,1024+64*e-i,64*(l+1)-n,i,n,64,64)}}}let n=this.gl,s=n.createTexture();n.bindTexture(n.TEXTURE_2D,s),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,i),this.tilesetsTexture=s,i.height=384;let a=this.waterTextures;for(let l=0,h=a.length;l<h;l++){let e=l%16,t=l/16|0;r.putImageData(a[l].imageData,128*e,128*t)}let o=n.createTexture();n.bindTexture(n.TEXTURE_2D,o),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,i),this.waterTexture=o}getVariation(e,t){let i=this.tilesetTextures[e];return i.width>i.height?t<16?16+t:16===t?15:0:0===t?0:15}isCliff(e,t){return!!this.corners[t][e].cliff}isWater(e,t){let i=this.corners;return i[t][e].water||i[t][e+1].water||i[t+1][e].water||i[t+1][e+1].water}cliffGroundIndex(e){let t=this.cliffTilesets[e].groundTile,i=this.tilesets;for(let r=0,n=i.length;r<n;r++)if(i[r].tileID===t)return r}cornerTexture(e,t){let i=this.corners,r=this.columns,n=this.rows;for(let a=-1;a<1;a++)for(let s=-1;s<1;s++)if(e+s>0&&e+s<r-1&&t+a>0&&t+a<n-1){let r=i[t+a][e+s];if(this.isCliff(e+s,t+a)||r.rampType){let e=r.cliffTexture;return 15===e&&(e=1),this.cliffGroundIndex(e)}}let s=i[t][e];return s.blight?this.blightTextureIndex:s.groundTexture}load(e){return super.load(e,this.mapPathSolver)}applyModificationFile(e,t,i){i&&(this.applyModificationTable(e,t,i.originalTable),this.applyModificationTable(e,t,i.customTable))}applyModificationTable(e,t,i){for(let r of i.objects){let i=e.getRow(r.oldId),n=r.newId;""===r.newId||e.getRow(n)||e.setRow(r.newId,i={...i});for(let e of r.modifications){let r=t.getRow(e.id);r?i[r.field]=e.value:console.warn("Unknown modification ID",e.id)}}}groundNormal(e,t,i){let r=this.centerOffset,n=this.mapSize,s=0|(t=(t-r[0])/128),a=0|(i=(i-r[1])/128);if(s>=0&&s<n[0]-1&&a>=0&&a<n[1]-1){let r=this.corners,n=r[a][s].groundHeight,o=r[a][s+1].groundHeight,l=r[a+1][s].groundHeight,h=r[a+1][s+1].groundHeight;t-s+(i-a)<1?(ar.vec3.set(OE,1,0,o-n),ar.vec3.set(DE,0,1,l-n)):(ar.vec3.set(OE,-1,0,h-l),ar.vec3.set(DE,0,1,h-o)),ar.vec3.normalize(e,ar.vec3.cross(e,OE,DE))}else ar.vec3.set(e,0,0,1);return e}heightAt(e,t){let i=this.centerOffset,r=this.mapSize,n=0|(e=(e-i[0])/128),s=0|(t=(t-i[1])/128);if(n>=0&&n<r[0]-1&&s>=0&&s<r[1]-1){let i=this.corners;const r=e=>e.groundHeight+e.layerHeight-2;let a,o=r(i[s][n]),l=r(i[s][n+1]),h=r(i[s+1][n]),c=r(i[s+1][n+1]),d=e-n,u=t-s;return 128*(a=d+u<1?o+(l-o)*d+(h-o)*u:c+(l-c)*(1-u)+(h-c)*(1-d))}return 0}inPlayableArea(e,t){return e=(e-this.centerOffset[0])/128,t=(t-this.centerOffset[1])/128,!(e<this.mapBounds[0])&&!(e>=this.mapSize[0]-this.mapBounds[1]-1)&&!(t<this.mapBounds[2])&&!(t>=this.mapSize[1]-this.mapBounds[3]-1)&&!this.corners[Math.floor(t)][Math.floor(e)].boundary}addShadow(e,t,i){if(!this.shadows[e]){let t="ReplaceableTextures\\Shadows\\".concat(e,".blp");this.shadows[e]=[],this.shadowTextures[e]=this.load(t)}this.shadows[e].push({x:t,y:i})}async initShadows(){await Af(Object.values(this.shadowTextures));let e=this.gl,t=this.centerOffset,[i,r]=this.mapSize;const n=(i=4*(i-1))*(r=4*(r-1)),s=new Uint8Array(i*r),a=this.mapMpq.get("war3map.shd");if(a){let e=a.arrayBuffer();if(e.byteLength>=n){e=new Uint8Array(e);for(let t=0;t<n;++t)s[t]=e[t]/2}}for(let[u,m]of Object.entries(this.shadowTextures)){if(!m.originalData)continue;let{data:e,width:n,height:a}=m.originalData,o=Math.round(.3*n),l=Math.round(.7*a);for(let h of this.shadows[u]){let c=Math.floor((h.x-t[0])/32)-o,d=Math.floor((h.y-t[1])/32)+l;for(let t=0;t<a;++t)if(!(d-t<0||d-t>=r))for(let r=0;r<n;++r)c+r<0||c+r>=i||e[4*(t*n+r)+3]&&(s[(d-t)*i+c+r]=128)}}let o=4*this.mapBounds[0],l=4*(this.mapSize[0]-this.mapBounds[1]-1),h=4*this.mapBounds[2],c=4*(this.mapSize[1]-this.mapBounds[3]-1);for(let u=h;u<c;++u)for(let e=o;e<l;++e)this.corners[u>>2][e>>2].boundary&&(s[u*i+e]=204);for(let u=0;u<r;++u){for(let e=0;e<o;++e)s[u*i+e]=204;for(let e=l;e<i;++e)s[u*i+e]=204}for(let u=o;u<l;++u){for(let e=0;e<h;++e)s[e*i+u]=204;for(let e=c;e<r;++e)s[e*i+u]=204}let d=e.createTexture();e.bindTexture(e.TEXTURE_2D,d),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.R8,i,r,0,e.RED,e.UNSIGNED_BYTE,s),this.shadowMap=d,this.shadowsReady=!0}createWaves(){let[e,t]=this.mapSize,i=this.corners,r=this.centerOffset,n=this.waterData.getRow("".concat(this.tileset,"Sha")),s=2048&this.mapFlags,a=4096&this.mapFlags,o="".concat(n.shoreDir,"\\").concat(n.shoreSFile,"\\").concat(n.shoreSFile,"0.mdx"),l="".concat(n.shoreDir,"\\").concat(n.shoreOCFile,"\\").concat(n.shoreOCFile,"0.mdx"),h="".concat(n.shoreDir,"\\").concat(n.shoreICFile,"\\").concat(n.shoreICFile,"0.mdx"),c=(e,t,i)=>e?-3*Math.PI/4:t?-Math.PI/4:i?Math.PI/4:3*Math.PI/4,d=(e,t,i,r)=>e&&t?-Math.PI/2:t&&i?0:i&&r?Math.PI/2:e&&r?Math.PI:null,u=new Float32Array(3),m={},f=(e,t)=>{m[e]||(m[e]=this.load(e));let i=m[e].addInstance();i.move(u),i.rotateLocal(ar.quat.setAxisAngle(ar.quat.create(),Ir,t)),i.setScene(this.scene),this.inPlayableArea(u[0],u[1])||i.setVertexColor([51,51,51]),UE(i)};for(let p=0;p<t-1;++p)for(let t=0;t<e-1;++t){let e=i[p][t],n=i[p][t+1],m=i[p+1][t+1],E=i[p+1][t];if(e.water||n.water||m.water||m.water){let i=e.layerHeight!==n.layerHeight||e.layerHeight!==m.layerHeight||e.layerHeight!==E.layerHeight;if(i&&!s)continue;if(!i&&!a)continue;let g=e.depth>25/128?1:0,A=n.depth>25/128?1:0,_=m.depth>25/128?1:0,T=E.depth>25/128?1:0,v=g+A+_+T;if(u[0]=128*t+r[0]+64,u[1]=128*p+r[1]+64,u[2]=128*((e.waterHeight+n.waterHeight+m.waterHeight+E.waterHeight)/4+this.waterHeightOffset)+1,1===v)f(h,c(g,A,_));else if(2===v){let e=d(g,A,_,T);null!=e&&f(o,e)}else 3===v&&f(l,c(!g,!A,!_)+Math.PI)}}}deselect(){this.selModels&&this.selModels.length&&(this.selModels.forEach(e=>{let t=this.uberSplatModels.indexOf(e);t>=0&&this.uberSplatModels.splice(t,1)}),this.selModels=[]),this.selected=[]}doSelectUnits(e){if(this.deselect(),!e.length)return;let t={};this.selected=e.filter(e=>{let{unit:i}=e,r=this.unitsData.find(e=>e.id===i.id);if(!r)return!1;r=r.data;let n=parseFloat(r.scale||"0");if(!n)return!1;let s,a=36*n;a<100&&(s="ReplaceableTextures\\Selection\\SelectionCircleSmall.blp"),t[s=a<300?"ReplaceableTextures\\Selection\\SelectionCircleMed.blp":"ReplaceableTextures\\Selection\\SelectionCircleLarge.blp"]||(t[s]=[]);let[o,l]=i.location,h=parseFloat(r.selZ||"0");return t[s].push(o-a,l-a,o+a,l+a,h+5),!0});let i=this.selModels=[];Object.entries(t).forEach(e=>{let[t,r]=e;this.load(t).whenLoaded().then(e=>{if(this.selModels!==i)return;let n=new LE(this.gl,t,e,r,this.centerOffset);n.color=[0,1,0,1],this.selModels.push(n),this.uberSplatModels.push(n)})})}selectUnit(e,t,i){let r=new Float32Array(6);this.camera.screenToWorldRay(r,[e,t]);let n=OE;n[0]=r[3]-r[0],n[1]=r[4]-r[1],n[2]=r[5]-r[2],ar.vec3.normalize(n,n);let s=ar.vec3.create(),a=ar.vec3.create(),o=ar.vec3.create(),l=null,h=1e6;this.units.forEach(e=>{let{location:t,radius:i}=e;ar.vec3.set(s,0,0,i/2),ar.vec3.set(a,i,i,i),ar.vec3.add(s,s,t),ar.vec3.sub(s,s,r),ar.vec3.div(s,s,a),ar.vec3.div(o,n,a);let c=ar.vec3.sqrLen(o),d=Math.max(0,ar.vec3.dot(o,s))/c;d>h||(ar.vec3.scale(o,o,d),ar.vec3.sqrDist(o,s)<1&&(l=e,h=d))});let c=[];if(l)if(i){const e=(c=this.selected.slice()).indexOf(l);e>=0?c.splice(e,1):c.push(l)}else c=[l];return this.doSelectUnits(c),c}selectUnits(e,t,i,r){let n=new Float32Array(2),s=this.units.filter(s=>{let{unit:a}=s,o=this.unitsData.find(e=>e.id===a.id);if(!o)return!1;o=o.data;let[l,h]=a.location,c=parseFloat(o.selZ||"0")+this.heightAt(l,h);return this.camera.worldToScreen(n,[l,h,c]),n[0]>=e&&n[0]<i&&n[1]>=t&&n[1]<r});return this.doSelectUnits(s),s}}},BE={version:"4.5.8",parsers:sr,viewer:{glMatrix:ar,ModelViewer:_f,Scene:Jr,Camera:kr,handlers:{geo:Mf,mdx:vE,imagetexture:yE,w3x:FE,toc:Im,jass:gf}}};const VE=ar.vec3.create(),kE=ar.vec3.create(),GE=ar.vec3.create(),jE=ar.vec3.create(),YE=ar.mat4.create(),HE=new Float32Array(1),WE=["Red","Blue","Teal","Purple","Yellow","Orange","Green","Pink","Gray","Light Blue","Dark Green","Brown","Maroon","Navy","Turquoise","Violet","Wheat","Peach","Mint","Lavender","Coal","Snow","Emerald","Peanut","Black"];class KE extends s.a.PureComponent{constructor(){super(...arguments),this.state={objects:[],errors:[],current:0,teamColor:0},this.yaw=-Math.PI/2,this.pitch=-Math.PI/4,this.distance=400,this.center=ar.vec3.create(),this.minDistance=8,this.maxDistance=3e3,this.onMouseDown=(e=>{document.addEventListener("mousemove",this.onMouseMove,!0),document.addEventListener("mouseup",this.onMouseUp,!0),this.dragPos={x:e.clientX,y:e.clientY},e.preventDefault()}),this.onMouseMove=(e=>{if(this.dragPos&&this.canvas){const t=e.clientX-this.dragPos.x,i=e.clientY-this.dragPos.y,r=(this.canvas.width+this.canvas.height)/2;for(this.yaw+=2*t*Math.PI/r,this.pitch+=2*i*Math.PI/r;this.yaw>Math.PI;)this.yaw-=2*Math.PI;for(;this.yaw<-Math.PI;)this.yaw+=2*Math.PI;this.pitch=Math.min(this.pitch,0),this.pitch=Math.max(this.pitch,-Math.PI),this.dragPos={x:e.clientX,y:e.clientY},this.setCamera({target:{value:-1}})}e.preventDefault()}),this.onMouseUp=(e=>{delete this.dragPos,this.removeEvents(),e.preventDefault()}),this.onMouseWheel=(e=>{e.deltaY>0?this.distance=Math.min(1.2*this.distance,this.maxDistance):this.distance=Math.max(this.distance/1.2,this.minDistance),this.setCamera({target:{value:-1}})}),this.setObject=(e=>{let t=parseInt(e.target.value,10);isNaN(t)&&(t=0),this.setState(e=>{if(t!==e.current&&e.objects[t])return this.scene.removeInstance(e.objects[e.current].instance),this.scene.addInstance(e.objects[t].instance),{current:t}})}),this.setSequence=(e=>{let t=parseInt(e.target.value,10);isNaN(t)&&(t=-1),this.setState(e=>{const i=e.objects[e.current];if(i&&i.sequence!==t){i.instance.setSequence(t);const r=e.objects.slice();return r[e.current]={...i,sequence:t},{objects:r}}})}),this.setCamera=(e=>{let t=parseInt(e.target.value,10);isNaN(t)&&(t=-1),this.setState(e=>{const i=e.objects[e.current];if(i&&i.camera!==t){const r=e.objects.slice();return r[e.current]={...i,camera:t},{objects:r}}})}),this.setTeamColor=(e=>{let t=parseInt(e.target.value,10);isNaN(t)&&(t=0),this.setState({teamColor:t},()=>{this.state.objects.forEach(e=>e.instance.setTeamColor(t))})}),this.animate=(e=>{this.frame=requestAnimationFrame(this.animate),this.scene.camera.viewport([0,0,this.canvas.width,this.canvas.height]);const t=this.state.objects[this.state.current],i=t&&t.model.cameras[t.camera];if(i){i.getPositionTranslation(VE,t.instance),i.getTargetTranslation(kE,t.instance),i.getRotation(HE,t.instance),ar.vec3.sub(jE,kE,VE),ar.vec3.normalize(jE,jE),ar.mat4.fromRotation(YE,HE[0],jE),ar.vec3.set(GE,0,0,1),ar.vec3.transformMat4(GE,GE,YE);const e=this.canvas.width/this.canvas.height,r=2*Math.atan(Math.tan(i.fieldOfView/2)/e);this.scene.camera.perspective(r,e,i.nearClippingPlane,i.farClippingPlane),this.scene.camera.moveToAndFace(VE,kE,GE)}else this.scene.camera.perspective(Math.PI/4,this.canvas.width/this.canvas.height,this.minDistance,this.maxDistance),this.freeCamera();this.viewer.updateAndRender()})}freeCamera(){this.scene&&this.scene.camera.setRotationAroundAngles(this.yaw,this.pitch,this.center,this.distance)}componentWillUnmount(){this.frame&&(cancelAnimationFrame(this.frame),delete this.frame),this.removeEvents()}removeEvents(){document.removeEventListener("mousemove",this.onMouseMove,!0),document.removeEventListener("mouseup",this.onMouseUp,!0)}modelLoaded(e,t){e.ok&&this.setState(i=>{const r=e.addInstance();(t=Math.min(t,i.objects.length))===i.current&&(i.objects[t]&&this.scene.removeInstance(i.objects[t].instance),this.scene.addInstance(r),e.bounds&&e.bounds.radius>.05&&(this.minDistance=Math.min(500,.2*e.bounds.radius),this.maxDistance=1e3*this.minDistance,this.distance=10*this.minDistance)),r.setTeamColor(i.teamColor),e.sequences.length>0&&r.setSequence(0),r.setSequenceLoopMode(2);const n=[...i.objects];return n.splice(t,0,{model:e,instance:r,sequence:e.sequences.length?0:-1,camera:e.cameras.length?0:-1}),{objects:n}})}componentDidMount(){if(!this.canvas)return;const e=this.canvas;this.viewer=new BE.viewer.ModelViewer(e),this.viewer.gl.clearColor(.3,.3,.3,1),this.viewer.on("error",(e,t,i)=>{if("FailedToFetch"===t){if(e.isPortrait)return;this.setState(t=>{let{errors:i}=t;return{errors:[...i,"Failed to load ".concat(e.path)]}})}}),this.scene=this.viewer.addScene(),this.viewer.addHandler(BE.viewer.handlers.mdx);const t=this.context,i=this.props.path?O(this.props.path):this.props.id,r=e=>{const i="string"===typeof e?e.substr(e.lastIndexOf(".")).toLowerCase():".mdx";if([".blp",".dds",".gif",".jpg",".jpeg",".png",".tga"].indexOf(i)>=0)return[t.image(e),".png",!0];{const r=t.binary(e);return r?[r.data.buffer,i,!1]:[t.cache.binary(e),i,!0]}};if(this.viewer.load(i,r).then(e=>this.modelLoaded(e,0)),this.props.path){const e=this.props.path.replace(/\.mdx$/i,"_portrait.mdx"),t=this.viewer.load(e,r);t.isPortrait=!0,t.then(e=>this.modelLoaded(e,1))}this.frame=requestAnimationFrame(this.animate)}render(){const{errors:e,objects:t,current:i,teamColor:r}=this.state,n=t[i];return s.a.createElement("div",{className:"FileModel"},s.a.createElement(Me.a,null,e=>{let{width:t,height:i}=e;return s.a.createElement("canvas",{onMouseDown:this.onMouseDown,onWheel:this.onMouseWheel,ref:e=>this.canvas=e,width:Math.max(t,100),height:Math.max(i,100)})}),s.a.createElement("ul",{className:"log"},e.map((e,t)=>s.a.createElement("li",{key:t,className:"error"},e))),s.a.createElement("div",{className:"credits"},"Model viewer by ",s.a.createElement("a",{href:"https://github.com/flowtsohg/mdx-m3-viewer"},"flowtsohg@github")),t.length>0&&s.a.createElement("div",{className:"controls"},t.length>1&&s.a.createElement("label",null,"Model:",s.a.createElement("select",{value:i,onChange:this.setObject},t.map((e,t)=>s.a.createElement("option",{key:t,value:t},e.model.name)))),null!=n&&s.a.createElement("label",null,"Animation:",s.a.createElement("select",{value:n.sequence,onChange:this.setSequence},s.a.createElement("option",{value:-1},"None"),n.model.sequences.map((e,t)=>s.a.createElement("option",{key:t,value:t},e.name)))),null!=n&&n.model.cameras.length>0&&s.a.createElement("label",null,"Camera:",s.a.createElement("select",{value:n.camera,onChange:this.setCamera},s.a.createElement("option",{value:-1},"Free"),n.model.cameras.map((e,t)=>s.a.createElement("option",{key:t,value:t},e.name)))),s.a.createElement("label",null,"Team Color:",s.a.createElement("select",{value:r,onChange:this.setTeamColor},WE.map((e,t)=>s.a.createElement("option",{key:t,value:t},e))))))}}KE.contextType=oe.DataContext;class zE extends s.a.Component{constructor(){super(...arguments),this.state={show:!1},this.show=(e=>{this.setState({show:!0}),e.preventDefault()}),this.setPopup=(e=>{this.popup=e,e?document.addEventListener("keydown",this.onKeyDown,!0):document.removeEventListener("keydown",this.onKeyDown,!0)}),this.onKeyDown=(e=>{switch(e.which){case v.a.codes.esc:this.setState({show:!1})}}),this.onMouseDown=(e=>{e.target===this.popup&&this.setState({show:!1})})}componentWillUnmount(){document.removeEventListener("keydown",this.onKeyDown,!0)}render(){let e=this.props.path;const t=this.context;if(""===e||"_"===e||"-"===e)return e;const i=e.match(/^(.*)(\.\w+)$/);i?".mdx"!==i[2]&&(e=i[1]+".mdx"):e+=".mdx";const r=D(O(e));return s.a.createElement(s.a.Fragment,null,this.state.show&&o.a.createPortal(s.a.createElement("div",{className:"ObjectModel",onMouseDown:this.onMouseDown,ref:this.setPopup},s.a.createElement("div",null,s.a.createElement(KE,{path:e}))),document.body),s.a.createElement("a",{href:"/".concat(t.id,"/files/").concat(r),onClick:this.show},e))}}zE.contextType=oe.DataContext;const qE=e=>{let{object:t}=e;return s.a.createElement(_e.Consumer,null,e=>s.a.createElement(Qe,{id:t.id},s.a.createElement(h.Link,{to:"/".concat(e,"/").concat(t.type,"/").concat(t.id)},s.a.createElement(we,{object:t}),t.name)))},XE=e=>{let{object:t}=e;return s.a.createElement(_e.Consumer,null,e=>s.a.createElement(Qe,{id:t.id},s.a.createElement(h.Link,{to:"/".concat(e,"/").concat(t.type,"/").concat(t.id)},t.id)))};class JE extends s.a.PureComponent{constructor(){super(...arguments),this.state={popup:null},this.onMouseOver=(e=>{const t=e.target.getBoundingClientRect(),i=Math.max(document.documentElement.clientHeight,window.innerHeight||0);t.top+t.bottom>i?this.setState({popup:"top"}):this.setState({popup:"bottom"})}),this.onMouseOut=(()=>{this.setState({popup:null})})}render(){const{children:e,tooltip:t}=this.props,{popup:i}=this.state;return i?s.a.createElement("td",{className:_()("popupStringCell",i),onMouseEnter:this.onMouseOver,onMouseLeave:this.onMouseOut},t,e):s.a.createElement("td",{onMouseEnter:this.onMouseOver,onMouseLeave:this.onMouseOut},e)}}class QE extends s.a.PureComponent{constructor(){super(...arguments),this.state={popup:!1},this.onMouseOver=(e=>{if(e.target.scrollWidth>=e.target.offsetWidth){if(e.target.closest(".ObjectModel"))return;this.setState({popup:!0})}}),this.onMouseOut=(()=>{this.setState({popup:!1})})}render(){const{children:e}=this.props,{popup:t}=this.state;return t?s.a.createElement("td",{className:"popupCell",onMouseEnter:this.onMouseOver,onMouseLeave:this.onMouseOut},s.a.createElement("div",null,e),"#"):s.a.createElement("td",{onMouseEnter:this.onMouseOver,onMouseLeave:this.onMouseOut},e)}}const $E=e=>{let{value:t,data:i}=e;const r=Xe(t,i);return s.a.createElement("div",null,r)};class ZE extends s.a.Component{constructor(){super(...arguments),this.state={visible:!1},this.onLoad=(()=>this.setState({visible:!0}))}render(){const{path:e,cache:t,className:i,...r}=this.props,n=t.image(e);return null==n?null:s.a.createElement(ze.a,Object.assign({id:"icon-preview"},r,{className:_()(i,{loading:!this.state.visible})}),s.a.createElement("img",{src:n,onLoad:this.onLoad,alt:"icon"}))}}const eg=e=>{let{path:t}=e;return s.a.createElement(oe.DataContext.Consumer,null,e=>{const i=e.iconByName(t);return s.a.createElement(R.a,{placement:"top",overlay:s.a.createElement(ZE,{path:t,cache:e})},s.a.createElement("span",null,null!=i&&s.a.createElement("span",{className:"Icon",style:i}),t))})},tg=e=>{let{value:t,meta:i,data:r}=e;i.type.indexOf("Flags");let n=i.type;if("lightningList"===n&&(n="lightningEffect"),r.types[n])return t&&"_"!==t?r.types[n][t]||"value":"None";switch(n){case"bool":return parseInt(t,10)?"True":"False";case"string":return"_"===t?"":t;case"char":return t;case"int":return parseInt(t,10)||0;case"real":case"unreal":return(parseFloat(t)||0).toFixed(i.stringExt||2);case"destructableCategory":return Ie[t]||t;case"tilesetList":return be[t]||t;case"doodadCategory":return Le[t]||t;case"techList":if(Ne[t])return Ne[t];case"buffCode":case"buffList":case"effectCode":case"effectList":case"unitCode":case"unitList":case"abilCode":case"abilityList":case"heroAbilityList":case"itemCode":case"itemList":case"upgradeCode":case"upgradeList":if("_"===t)return"";const e=r.objects.find(e=>e.id===t);return e?s.a.createElement(qE,{object:e}):t;case"icon":return s.a.createElement(eg,{path:t});case"model":return s.a.createElement(zE,{path:t});default:return"_"!==t&&(t||"None")}},ig=e=>{let{value:t,meta:i,data:r}=e;switch(i.type){case"int":return parseInt(t,10)||0;case"real":case"unreal":return(parseFloat(t)||0).toFixed(i.stringExt||2);case"techList":case"buffCode":case"buffList":case"effectCode":case"effectList":case"unitCode":case"unitList":case"abilCode":case"abilityList":case"heroAbilityList":case"itemCode":case"itemList":case"upgradeCode":case"upgradeList":const e=r.objects.find(e=>e.id===t);return e?s.a.createElement(XE,{object:e}):t;default:return t}},rg=e=>{let{value:t,meta:i,data:r,rawNames:n}=e;const a=n?ig:tg;if(i.type.indexOf("List")>=0){if("_"===t)return s.a.createElement(QE,null,n?t:"");if(""===t)return s.a.createElement(QE,null);const e=[];return t.split(",").forEach((t,o)=>{e.length&&e.push(n?",":", "),e.push(s.a.createElement(a,{value:t,meta:i,data:r,key:o}))}),s.a.createElement(QE,null,e)}if(i.type.indexOf("Flags")>=0&&!n){const e=[],o=parseInt(t,10);for(let t=0;t<31&&1<<t<=o;++t)1<<t&o&&(e.length&&e.push(n?",":", "),e.push(s.a.createElement(a,{value:t,meta:i,data:r,key:t})));return s.a.createElement(QE,null,e)}return"string"===i.type?(n||"_"!==t||(t=""),function(e,t){return e.match(/<.*>|\|[crn]/i)?s.a.createElement(JE,{tooltip:s.a.createElement($E,{value:e,data:t})},e):s.a.createElement(QE,null,e)}(t,r)):s.a.createElement(QE,null,s.a.createElement(a,{value:t,meta:i,data:r}))},ng=e=>{let{object:t,data:i,rawNames:r}=e;const n=[];return Pe(t,i,r,(e,t,a,o)=>{n.push(s.a.createElement("tr",{key:e},s.a.createElement(QE,null,t),s.a.createElement(rg,{value:a,meta:o,data:i,rawNames:r})))}),s.a.createElement("tbody",null,n)},sg=e=>s.a.createElement(Ae.Consumer,null,t=>s.a.createElement(ng,Object.assign({},e,{rawNames:t})));class ag extends s.a.Component{constructor(){super(...arguments),this.state={},this.onMouseDown=(e=>{this.setState({dragPos:e.clientX-this.props.pos}),document.addEventListener("mousemove",this.onMouseMove,!0),document.addEventListener("mouseup",this.onMouseUp,!0),e.preventDefault(),e.stopPropagation()}),this.onMouseMove=(e=>{const{dragPos:t}=this.state;1&e.buttons&&null!=t?(this.props.onChange(e.clientX-t),e.preventDefault(),e.stopPropagation()):this.onMouseUp(e)}),this.onMouseUp=(e=>{this.setState({dragPos:null}),this.removeListeners(),e.preventDefault(),e.stopPropagation()})}removeListeners(){document.removeEventListener("mousemove",this.onMouseMove,!0),document.removeEventListener("mouseup",this.onMouseUp,!0)}componentWillUnmount(){this.removeListeners()}render(){const{pos:e}=this.props;return s.a.createElement("div",{className:"drag-handle",style:{left:e},onMouseDown:this.onMouseDown})}}class og extends s.a.Component{constructor(){super(...arguments),this.state={sliderPos:300},this.setSliderPos=(e=>(e=Math.max(50,e),this.table_&&(e=Math.min(this.table_.offsetWidth-50,e)),this.setState({sliderPos:e}),e)),this.setRef=(e=>this.table_=e)}render(){const{data:e,className:t,...i}=this.props,{sliderPos:r}=this.state,n=this.context,a=e.objects.find(e=>e.id===n);return a?s.a.createElement(Oe.a,Object.assign({className:_()(t,"ObjectData")},i),s.a.createElement(ag,{pos:r,onChange:this.setSliderPos}),s.a.createElement(he,{title:a.name}),s.a.createElement("div",{className:"nonscrollable"},s.a.createElement("table",null,s.a.createElement("thead",null,s.a.createElement("tr",null,s.a.createElement("th",{width:r},"Name"),s.a.createElement("th",null,"Value"))))),s.a.createElement("div",{className:"scrollable"},s.a.createElement("table",{ref:this.setRef},s.a.createElement("thead",null,s.a.createElement("tr",null,s.a.createElement("th",{width:r},"Name"),s.a.createElement("th",null,"Value"))),s.a.createElement(sg,{object:a,data:e})))):s.a.createElement(Oe.a,Object.assign({className:_()(t,"ObjectData")},i),s.a.createElement("div",null,s.a.createElement("span",{className:"no-results"},n?"Object not found.":"Select an object from the list.")))}}og.contextType=ve;i(426);class lg extends s.a.Component{constructor(){super(...arguments),this.setRawNames=(()=>this.context.update("rawNames",!this.context.rawNames))}render(){const{match:{params:{build:e,type:t,id:i}},data:r}=this.props;return s.a.createElement(Ae.Provider,{value:!!this.context.rawNames},s.a.createElement(ye.Provider,{value:this.setRawNames},s.a.createElement(_e.Provider,{value:e},s.a.createElement(Te.Provider,{value:t},s.a.createElement(ve.Provider,{value:i},s.a.createElement("div",{className:"ObjectView"},s.a.createElement(Oe.a,{cols:!0},s.a.createElement(Ke,{size:300,minSize:100,resizable:!0,className:"LeftPanel",data:r,type:t,id:i,key:t}),s.a.createElement(og,{minSize:100,className:"RightPanel",data:r}))))))))}}lg.contextType=ce.Context;const hg=w({data:(e,t)=>{let{match:i}=e;return t.objects()}},lg,void 0,void 0);hg.contextType=oe.DataContext;const cg=()=>s.a.createElement(l.d,{path:"/:build/:type/:id?",component:hg}),dg=s.a.createContext(null),ug=(e,t)=>{const i={name:"",dirs:{},files:[]};e.split("\n").filter(e=>e.length>0).forEach(e=>{const r=e.split(/[\\/:]/);let n=i;for(let t=0;t<r.length-1;++t){const e=r[t].toLowerCase();n.dirs[e]||(n.dirs[e]={name:r[t],dirs:{},files:[]}),n=n.dirs[e]}const s=e.match(/^Unknown\\([0-9A-F]{16})/),a=e.match(/\.(\w{1,3})$/);n.files.push({name:r[r.length-1],path:e,key:s?M(s[1]):O(e,t),ext:a?a[1].toLowerCase():"unknown"})});const r=[],n=(e,t)=>e.name.toLowerCase().localeCompare(t.name.toLowerCase()),s=e=>{e.dirs=Object.values(e.dirs).sort(n),e.dirs.forEach(e=>s(e)),e.files.sort(n),r.push(...e.files)};return s(i),{root:i,files:r}},mg=e=>{let{file:t}=e;return s.a.createElement(oe.DataContext.Consumer,null,e=>s.a.createElement(dg.Consumer,null,i=>s.a.createElement(h.Link,{to:"/".concat(e.id,"/files/").concat(D(t.key)),className:_()("ObjectLink",{searched:t.searched,selected:F(i,t.key)})},s.a.createElement("span",{className:"Icon file-icon file-"+t.ext}),s.a.createElement("span",{className:"ObjectName"},t.name))))};class fg{constructor(e,t){this.height=1,this.file=e,this.file.parent=this,this.parent=t,this.file.upSearchVisit=(e=>{e(this.file),this.upSearchVisit(e)})}render(){return s.a.createElement(mg,{file:this.file})}renderLine(e){return this.render()}upSearchVisit(e){e(this),this.parent&&this.parent.upSearchVisit(e)}downSearchVisit(e){e(this),e(this.file)}}class pg{constructor(e,t){this.toggle=(()=>{this.expanded?this.collapse():this.expand()}),this.parent=t,this.level=t?t.level+1:0,this.title=e.name||"__ROOT__",this.count=e.files.length,this.dirs={},this.children=[],e.dirs.forEach(e=>{const t=new pg(e,this);this.children.push(t),this.dirs[e.name.toLowerCase()]=t,this.count+=t.count}),e.files.forEach(e=>{this.children.push(new fg(e,this))}),this.openHeight=t?1:0,this.children.forEach(e=>{e.top=this.openHeight,this.openHeight+=e.height}),this.expanded=!t,this.searched=!1}upSearchVisit(e){e(this),this.parent&&this.parent.upSearchVisit(e)}downSearchVisit(e){e(this),this.children.forEach(t=>t.downSearchVisit(e))}modHeight(e,t){let i=t?this.children.indexOf(t):-1;if(i>=0)for(;++i<this.children.length;)this.children[i].top+=e;this.openHeight+=e,this.parent&&this.expanded?this.parent.modHeight(e,this):this.onResize&&this.onResize(this.height)}get height(){return this.expanded?this.openHeight:1}expandFile(e,t){if(t||(t=e.path.split(/[\\/]/)),t.length>1){const i=t[0].toLowerCase(),r=this.dirs[i];if(r)return r.expand(),r.expandFile(e,t.slice(1))+r.top}else{const t=this.children.find(t=>t.file===e);if(t)return t.top}return 0}expand(){!this.expanded&&this.count>0&&(this.expanded=!0,this.parent&&this.parent.modHeight(this.openHeight-1,this))}collapse(){this.expanded&&this.parent&&(this.expanded=!1,this.parent.modHeight(1-this.openHeight,this))}render(){return this.parent?s.a.createElement("div",{onClick:this.preSelect,className:_()("ObjectGroup",{expanded:this.expanded,searched:this.searched})},s.a.createElement("span",{className:"toggle",onClick:this.toggle}),s.a.createElement("span",{onDoubleClick:this.toggle},s.a.createElement("span",{className:"Icon"}),s.a.createElement("span",{className:"title"},this.title))):s.a.createElement("span",null,"no-parent-dir")}firstLevelNode(e){if(this.expanded){let t=0,i=this.children.length-1;for(;t<i;){const r=t+i+1>>1;this.children[r].top>e?i=r-1:t=r}return this.children[t]}return null}renderLine(e){if(this.parent&&!e)return this.render();if(this.expanded){let t=0,i=this.children.length-1;for(;t<i;){const r=t+i+1>>1;this.children[r].top>e?i=r-1:t=r}const r=this.children[t],n=e-this.children[t].top,a=this.children[t].renderLine(n);let o=null;return this.parent&&(t<this.children.length-1?o=0===n?"tLine":"line":0===n&&(o="halfLine")),s.a.createElement("div",{className:_()("indent",o,{searched:r.searched})},a)}}}class Eg extends s.a.PureComponent{constructor(e){super(e),this.state={search:"",searchResults:null,searched:!1},this.onSearchKeyDown=(e=>{27===e.which&&(this.setState({search:"",searchResults:null}),this.stateChanged=!0)}),this.onSearch=(e=>{const t=e.target.value.trim();let i=[],r=!1;if(this.root.downSearchVisit(e=>e.searched=!1),""!==t&&this.files){const n=new RegExp(t.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&"),"i");this.files.forEach((e,t)=>{let i=!!e.path.match(n);e.upSearchVisit(e=>{e.searched=e.searched||i,e.searched&&(r=!0)})}),this.setState({search:e.target.value,searchResults:i,searched:r})}else this.root.downSearchVisit(e=>e.searched=!1),this.setState({search:e.target.value,searchResults:null,searched:r});this._list&&this._list.forceUpdateGrid(),this.stateChanged=!0}),this.onResize=(()=>{this.forceUpdate()}),this.rowRenderer=(e=>{let{index:t,...i}=e;const{key:r,style:n}=i,a=this.root.firstLevelNode(t);return s.a.createElement("div",{className:_()("TreeRow",{searched:a&&a.searched}),key:r,style:n},this.root.renderLine(t))}),this.rowRendererSearch=(e=>{let{index:t,...i}=e;const{key:r}=i;return s.a.createElement("div",{className:"TreeRow",key:r},this.root.renderLine(t))});const t=ug(e.listFile,!e.isMap);this.files=t.files,this.root=new pg(t.root),this.root.onResize=this.onResize}render(){const{listFile:e,id:t,className:i,isMap:r,...n}=this.props,{search:a,searchResults:o,searched:l}=this.state;if(!this.root)return null;if(!o&&!F(this.root._id,t)){const e=this.files&&this.files.find(e=>F(e.key,t));if(e){this.root.onResize=null;const i=this.root.expandFile(e);this.root.onResize=this.onResize,this.root._id=t,setTimeout(()=>{this._list&&this._list.scrollToRow(i)})}}return s.a.createElement(Oe.a,Object.assign({ref:e=>this._panel=e,className:_()(i,"ObjectList")},n),s.a.createElement("div",{className:"search-box"},s.a.createElement(De.a,{type:"text",value:a,placeholder:"Search",onKeyDown:this.onSearchKeyDown,onChange:this.onSearch})),s.a.createElement("div",{className:_()("ObjectListItems",l)},s.a.createElement(Me.a,null,e=>{let{width:t,height:i}=e;return s.a.createElement(Me.c,{className:"ObjectLines",ref:e=>this._list=e,width:t,height:i,rowCount:this.root.height,rowHeight:18,rowRenderer:this.rowRenderer})})))}}const gg=e=>{let{id:t,listFile:i,className:r,...n}=e;return s.a.createElement(Oe.a,Object.assign({className:_()(r,"ObjectList")},n))},Ag=w({listFile:e=>{let{data:t}=e;return t.listFile()}},e=>{let{data:t,...i}=e;return s.a.createElement(Eg,Object.assign({key:t.id,isMap:t.isMap},i))},gg,gg);var _g=i(240);i(427);const Tg=e=>{let{value:t,comment:i}=e;i=i&&i.replace("\x1b","\n");const r=null==t||""===t?"":t.toString();return s.a.createElement("div",{title:i||r},r)};class vg extends s.a.PureComponent{constructor(){super(...arguments),this.rowGetter=(e=>{let{index:t}=e;return this.props.data.rows[t]}),this.getColumnWidth=(e=>{let{index:t}=e;return 500})}renderColumns(){const{data:e}=this.props;return Array.from({length:e.cols},(t,i)=>s.a.createElement(Me.b,{className:"col-"+i,key:i,width:this.getColumnWidth({index:i}),dataKey:String(i),cellRenderer:t=>{let{cellData:r,rowIndex:n}=t;return s.a.createElement(Tg,{value:r,comment:e.comments&&e.comments[n]&&e.comments[n][i]})}}))}render(){const{data:e,style:t}=this.props;if(!e||!e.rows||!Number.isInteger(e.cols)||e.cols<=0)return null;const i=50*e.cols;return s.a.createElement("div",{className:"FileSlk"},s.a.createElement(Me.a,null,r=>{let{width:n,height:a}=r;return s.a.createElement(Me.d,{style:t,width:i,height:a-22,rowHeight:23,rowGetter:this.rowGetter,rowCount:e.rows.length,overscanRowCount:5},this.renderColumns())}))}}class yg extends s.a.PureComponent{constructor(){super(...arguments),this.state={foo:parseInt("foo",10),bar:void 0},this.onSearch=((e,t)=>this._list?this._list.search(e,t):null),this.rowRenderer=(e=>{let{index:t,...i}=e;const{key:r,style:n}=i,a=16*t,o=this.digits,l=[...this.props.data.subarray(a,a+16)],h=".".charCodeAt(0);return s.a.createElement("div",{className:"HexRow",key:r,style:n},s.a.createElement("span",{className:"offset"},a.toString(16).padStart(o,"0")),s.a.createElement("span",{className:"hex"},l.map((e,t)=>s.a.createElement("span",{key:t},e.toString(16).padStart(2,"0"))),l.length<16&&[...Array(16-l.length)].map((e,t)=>s.a.createElement("span",{key:t,className:"padding"},"  "))),s.a.createElement("span",{className:"ascii"},String.fromCharCode(...l.map(e=>e>=32&&e<=126?e:h))))})}get digits(){const e=this.props.data.length;let t=4;for(;1<<4*t<=e;)++t;return t}render(){const{data:e}=this.props;return s.a.createElement(Me.a,null,t=>{let{width:i,height:r}=t;return s.a.createElement(Me.c,{className:"HexLines",width:i,height:r,rowCount:Math.ceil(e.length/16),rowHeight:19,rowRenderer:this.rowRenderer})})}}i(428);function wg(e,t){for(let i=0;i<e.childNodes.length;++i)if(e.childNodes[i]===t)return i;return-1}function Sg(e,t){if(t>=e.childNodes.length)return e.textContent.length;let i=0;for(let r=0;r<t;++r)i+=e.childNodes[r].textContent.length;return i}function Rg(e,t,i){let r=0;for(r=t.childNodes.length?Sg(t,i):i;t&&t!==e;){const e=t.parentElement||t.parentNode;r+=Sg(e,wg(e,t)),t=e}return t!==e?0:r}function bg(e,t,i){const r=[];let n=0;return t.forEach(t=>{const a=Math.max(t.index-i,0),o=Math.min(t.index+t.length-i,e.length);o<=a||(a>n&&r.push(e.substring(n,a)),r.push(s.a.createElement("span",{className:t.className,key:t.index},e.substring(a,o))),n=o)}),n<e.length&&r.push(e.substring(n)),1===r.length?r[0]:r}class Ig extends s.a.Component{constructor(){super(...arguments),this.state={searchText:"",searchMatches:[]},this.selection={},this.onCopy=(()=>{if(!this._node)return;const e=window.getSelection(),t=[],i=this.selection,r=this.nodeToPos2(e.anchorNode,e.anchorOffset),n=this.nodeToPos2(e.focusNode,e.focusOffset);if(i.anchorPos&&i.focusPos&&r&&n){const s=i.anchorPos.line<i.focusPos.line?i.anchorPos:i.focusPos,a=i.anchorPos.line<i.focusPos.line?i.focusPos:i.anchorPos,o=r.line<n.line?e.anchorNode:e.focusNode,l=r.line<n.line?r:n,h=r.line<n.line?e.focusNode:e.anchorNode,c=r.line<n.line?n:r,d=this.props.lines;if(s.line<l.line&&1===o.nodeType){const e=[];for(let t=s.line;t<=l.line;++t){let i=d[t];i&&(t===s.line?i=i.substr(s.offset):t===l.line&&(i=i.substr(0,l.offset)),e.push(i))}const i=e.join("\n");if(i.length){const e=document.createElement("span");e.style.position="absolute",e.style.left="-10000px",e.style.top="-10000px",e.style.fontSize="0",e.style.whiteSpace="pre",e.innerText=i,t.push(e),o.appendChild(e)}}if(a.line>c.line&&1===h.nodeType){const e=[];for(let t=c.line+1;t<=a.line;++t){let i=d[t];i&&(t===c.line?i=i.substr(c.offset):t===a.line&&(i=i.substr(0,a.offset)),e.push(i))}const i=e.join("\n");if(i.length){const e=document.createElement("span");e.style.position="absolute",e.style.left="-10000px",e.style.top="-10000px",e.style.fontSize="0",e.style.whiteSpace="pre",e.innerText=i,t.push(e),h.parentElement.insertBefore(e,h)}}}t.length&&window.setTimeout(()=>{t.forEach(e=>e.parentNode.removeChild(e))},100)}),this.onSelect=(()=>{if(this.suppressSelect||!this.selection||!this._node)return;const e=window.getSelection(),t=this.selection,i=e=>{let t=e;for(;t&&t!==this._node&&t!==this._firstLine&&t!==this._lastLine&&(!t.classList||!t.classList.contains("TextLine"));)t=t.parentElement||t.parentNode;return t!==this._firstLine&&t!==this._lastLine&&(!t.classList||!t.classList.contains("TextLine"))};if(e.anchorNode&&this._node.contains(e.anchorNode)){if(!i(e.anchorNode)){const i=this.posToNode(t.anchorPos),r=this.nodeToPos(i),n=this.nodeToPos2(e.anchorNode,e.anchorOffset);r&&n&&r.line===n.line&&r.offset===n.offset?e.setBaseAndExtent(i.node,i.offset,e.focusNode,e.focusOffset):(t.anchorPos=n,t.searchPos=n)}}else t.anchorPos=null;if(e.focusNode&&this._node.contains(e.focusNode)){if(!i(e.focusNode)){const i=this.nodeToPos(this.posToNode(t.focusPos)),r=this.nodeToPos2(e.focusNode,e.focusOffset);i&&r&&i.line===r.line&&i.offset===r.offset||(t.focusPos=r)}}else t.focusPos=null}),this.onScroll=(e=>{let{scrollTop:t}=e;const i=this.selection;i&&i.anchorPos&&i.focusPos&&(this.suppressSelect=!0,this.selectRange(i.anchorPos,i.focusPos),this.unsuppress&&clearTimeout(this.unsuppress),this.unsuppress=setTimeout(()=>{this.suppressSelect=!1,delete this.unsuppress},100))}),this.cellRangeRenderer=(e=>{const t=Object(Me.e)(e);return t.unshift(s.a.createElement("div",{key:"first-line",className:"fake-line",ref:e=>this._firstLine=e},s.a.createElement("span",null))),t.push(s.a.createElement("div",{key:"last-line",className:"fake-line",ref:e=>this._lastLine=e},s.a.createElement("span",null))),t}),this.rowRenderer=(e=>{let{index:t,key:i,style:r}=e;const{highlightExpr:n,highlightFunc:a}=this.props;if(this.props.padding){if(0===t||t>this.props.lines.length)return null;t-=1}const o=this.state.searchRegex;let l=this.props.lines[t];const h=o&&function(e,t,i,r){let n;const s=[];for(;n=t.exec(e);)s.push({index:n.index,length:n[0].length,className:i&&i.line===r&&i.offset===n.index?"match-current":"match"});return s}(l,o,this.state.searchMatch,t);return n&&a?l=function(e,t,i,r){const n=[];let a,o=0;r||(r=((t,i)=>e.substring(t,i)));const l=e=>{null!=e&&("string"===typeof e&&n.length&&"string"===typeof n[n.length-1]?n[n.length-1]+=e:n.push(e))};for(;a=t.exec(e);){a.index>o&&l(r(o,a.index));const e=i(a);s.a.isValidElement(e)?l(s.a.cloneElement(e,{key:a.index})):l(e),o=a.index+a[0].length}return o<e.length&&l(r(o,e.length)),n}(l,n,e=>{let t=e[0];return h&&(t=bg(e[0],h,e.index)),a(t,e)},(e,t)=>{let i=l.substring(e,t);return h&&(i=bg(i,h,e)),i}):h&&(l=bg(l,h,0)),s.a.createElement("div",{className:"TextLine",key:i,style:r},s.a.createElement("span",{className:"line","data-line-number":t+1}),l,"\n",s.a.createElement("span",{className:"eol"}))}),this.rowMeasure=(e=>{let{index:t}=e;if(this.props.padding){if(0===t||t>this.props.lines.length)return this.props.padding;t-=1}return this.props.heights[t]}),this.setScroll=(e=>{this._list?this._list.scrollToPosition(e):this._scrollTop=e}),this.setList=(e=>{this._list=e,this._node=o.a.findDOMNode(e),null!=this._scrollTop&&(this._list.scrollToPosition(this._scrollTop),delete this._scrollTop)})}componentDidMount(){document.addEventListener("copy",this.onCopy),document.addEventListener("selectionchange",this.onSelect)}componentWillUnmount(){document.removeEventListener("copy",this.onCopy),document.removeEventListener("selectionchange",this.onSelect)}search(e,t){const i=this.state.searchMatch;let r=[],n=null,s=null,a=null;if(e.trim()){if(e===this.state.searchText)r=this.state.searchMatches;else{const t=e.toLowerCase();this.props.lines.forEach((e,i)=>{let n,s=0;const a=e.toLowerCase();for(;-1!==(n=a.indexOf(t,s));)r.push({line:i,offset:n}),s=n+t.length})}let o=-1;if(-1!==t){const e=1===t&&i?{line:i.line,offset:i.offset+1}:this.selection.searchPos||{line:0,offset:0};(o=r.findIndex(t=>t.line>e.line||t.line===e.line&&t.offset>=e.offset))<0&&r.length&&(o=0)}else{const e=i?{line:i.line,offset:i.offset-1}:this.selection.searchPos||{line:0,offset:0};r.forEach((t,i)=>{t.line>e.line||t.line===e.line&&t.offset>e.offset||(o=i)}),o<0&&r.length&&(o=r.length-1)}n=r[o],s=n&&n.line,a={pos:o,count:r.length}}var o;return this._list&&this._list.forceUpdateGrid(),this.setState({searchText:e,searchMatch:n,searchRegex:e&&e.trim()?(o=e,o=o.replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&"),new RegExp("("+o+")","ig")):null,searchMatches:r},()=>{s&&this._list&&this._list.scrollToRow(s)}),a}nodeToPos2(e,t){return this.nodeToPos({node:e,offset:t})}nodeToPos(e){if(!e||!this._node)return;const{node:t,offset:i}=e;if(!this._node.contains(t))return;if(t===this._firstLine){const e=this._node.querySelectorAll(".line");if(!e.length)return;return{line:parseInt(e[0].getAttribute("data-line-number"),10)-1,offset:0}}if(t===this._lastLine){const e=this._node.querySelectorAll(".line");if(!e.length)return;return{line:parseInt(e[e.length-1].getAttribute("data-line-number"),10)-1,offset:e[e.length-1].parentElement.textContent.length-1}}let r=t;for(;r&&r!==this._node&&(!r.classList||!r.classList.contains("TextLine"));)r=r.parentElement||r.parentNode;if(!r||!r.classList||!r.classList.contains("TextLine"))return;const n=r.querySelector(".line");return n?{line:parseInt(n.getAttribute("data-line-number"),10)-1,offset:Rg(r,t,i)}:void 0}posToNode2(e,t){return this.posToNode({line:e,offset:t})}posToNode(e){if(!e||!this._node)return;const{line:t,offset:i}=e;let r=this._node.querySelector('.line[data-line-number="'.concat(t+1,'"]'));if(!r){const e=this._node.querySelectorAll(".line");if(!e.length)return;return t<parseInt(e[0].getAttribute("data-line-number"),10)-1&&this._firstLine?{node:this._firstLine,offset:0}:t>parseInt(e[e.length-1].getAttribute("data-line-number"),10)-1&&this._lastLine?{node:this._lastLine,offset:0}:void 0}return function e(t,i){if(!t.childNodes.length)return{node:t,offset:Math.min(t.textContent.length,i)};for(let r=0;r<t.childNodes.length;++r){const n=t.childNodes[r].textContent.length;if(i<n||r===t.childNodes.length-1)return e(t.childNodes[r],i);i-=n}return{node:t,offset:0}}(r=r.parentElement,i)}selectRange(e,t){const i=window.getSelection(),r=this.posToNode(e),n=this.posToNode(t);i.setBaseAndExtent(r?r.node:i.anchorNode,r?r.offset:i.anchorOffset,n?n.node:i.focusNode,n?n.offset:i.focusOffset),this.selection.anchorPos=e,this.selection.searchPos=e,this.selection.focusPos=t}componentDidUpdate(){this._lines!==this.props.lines&&(this._list.recomputeRowHeights(),this._lines=this.props.lines,this.selection={})}render(){const{className:e,onScroll:t,heights:i,lines:r,highlightExpr:n,highlightFunc:a,padding:o,...l}=this.props;let h=r.length+(o?2:0);return this._heights!==i&&(this._heights=i,this._avgHeight=i.reduce((e,t)=>e+t,2*(o||0))/h),s.a.createElement(Me.c,Object.assign({className:_()(e,"TextView"),ref:this.setList,rowCount:h,estimatedRowSize:this._avgHeight,onScroll:g(this.onScroll,t),cellRangeRenderer:this.cellRangeRenderer,rowHeight:this.rowMeasure,rowRenderer:this.rowRenderer},l))}}class Lg extends s.a.PureComponent{constructor(){super(...arguments),this.onSearch=((e,t)=>this._list?this._list.search(e,t):null)}render(){const{lines:e,heights:t}=this.props;return s.a.createElement(s.a.Fragment,null,s.a.createElement(y,{onSearch:this.onSearch}),s.a.createElement(Me.a,null,i=>{let{width:r,height:n}=i;return s.a.createElement(Ig,{ref:e=>this._list=e,width:r,height:n,lines:e,heights:t,padding:6})}))}}const Ng=e=>{const t=new DataView(e.buffer,e.byteOffset,e.byteLength);if(1112297521===t.getUint32(0,!1))return{format:"BLP",width:t.getUint32(12,!0),height:t.getUint32(16,!0)};if(1112297522===t.getUint32(0,!1))return{format:"BLP v2",width:t.getUint32(12,!0),height:t.getUint32(16,!0)};if(1145328416===t.getUint32(0,!1))return{format:"DDS",width:t.getUint32(16,!0),height:t.getUint32(12,!0)};if(1195984440!==t.getUint32(0,!1)||55!==e[4]&&57!==e[4]||97!==e[5])return 2303741511===t.getUint32(0,!1)&&218765834===t.getUint32(4,!1)?{format:"PNG",width:t.getUint32(16,!1),height:t.getUint32(20,!1)}:255===e[0]&&216===e[1]&&255===e[2]&&255===e[e.length-2]&&217===e[e.length-1]?{format:"JPG",width:"?",height:"?"}:{format:"TGA",width:t.getInt16(12,!0),height:t.getInt16(14,!0)};{const i=13+3*(8&e[10]);return{format:"GIF",width:t.getInt16(i+5,!0),height:t.getInt16(i+7,!0)}}};class xg extends s.a.PureComponent{render(){const{data:e,image:t,name:i}=this.props,r=e&&Ng(e);return s.a.createElement("div",null,null!=r&&s.a.createElement("div",null,r.width,"x",r.height," (",r.format,")"),s.a.createElement("div",null,s.a.createElement("img",{src:t,alt:i||"Extracted"})))}}class Pg extends s.a.PureComponent{render(){const{audio:e}=this.props;return s.a.createElement("div",null,s.a.createElement("audio",{controls:!0,controlsList:"nodownload",src:e}))}}function Cg(e){const t={globals:"jkey",endglobals:"jkey",local:"jkey",type:"jkey",constant:"jkey",native:"jkey",function:"jkey",takes:"jkey",returns:"jkey",endfunction:"jkey",return:"jkey",set:"jkey",call:"jkey",if:"jkey",then:"jkey",endif:"jkey",else:"jkey",elseif:"jkey",loop:"jkey",endloop:"jkey",exitwhen:"jkey",or:"jkey",and:"jkey",not:"jkey",array:"jtyp",integer:"jtyp",real:"jtyp",string:"jtyp",boolean:"jtyp",code:"jtyp",handle:"jtyp",nothing:"jtyp",null:"jcon"},i=(e.loadFile("Scripts\\common.j")||"").split(/[\r\n]/),r=/^\s*(?:constant\s+)?(\w+)\s+(?:array\s+)?(\w+)\b/;i.forEach(e=>{const i=e.match(r);i&&("native"===i[1]?t[i[2]]="jnat":"type"===i[1]?t[i[2]]="jtyp":t[i[2]]="jcon")});const n=(e.loadFile("Scripts\\Blizzard.j")||"").split(/[\r\n]/);let s=!1,a=!1;return n.forEach(e=>{let i;s?e.match(/^\s*endfunction\b/)&&(s=!1):(i=e.match(/^\s*(globals|endglobals)\b/))?a="globals"===i[1]:a?(i=e.match(/^\s*(?:constant\s+)?\w+\s+(?:array\s+)?(\w+)\b/))&&(t[i[1]]="jcon"):(i=e.match(/^\s*(?:constant\s+)?function\s+(\w+)\b/))&&(t[i[1]]="jbjf")}),t}const Ug=/([a-z_]\w*)|(0x[0-9a-z]+|\d+\.?|\d*\.\d+)|('[^'\\]*(?:\\.[^'\\]*)*')|("[^"\\]*(?:\\.[^"\\]*)*")|(\/\/.*)/gi,Og=16;const Dg=w({meta:(e,t)=>t.meta()},class extends s.a.PureComponent{constructor(e){super(e),this.onSearch=((e,t)=>this._list?this._list.search(e,t):null),this.tokenFunc=((e,t)=>{let[i,r,n,a,o,l]=t;if(r){const t=this.keywords[r];return t?s.a.createElement("span",{className:t},e):e}return n?s.a.createElement("span",{className:"jnum"},e):a?s.a.createElement("span",{className:"jchr"},e):o?s.a.createElement("span",{className:"jstr"},e):l?s.a.createElement("span",{className:"jcom"},e):e}),this.keywords=Cg(e.meta)}render(){const{lines:e}=this.props,t=e.map(e=>e.split("\n").length*Og);return s.a.createElement(s.a.Fragment,null,s.a.createElement(y,{onSearch:this.onSearch}),s.a.createElement(Me.a,null,i=>{let{width:r,height:n}=i;return s.a.createElement(Ig,{ref:e=>this._list=e,className:"JassColors",width:r,height:n,lines:e,heights:t,highlightExpr:Ug,highlightFunc:this.tokenFunc})}))}},void 0,void 0);Dg.contextType=oe.Context;var Mg=Dg;i(183);const Fg={"war3map.doo":wi.doo.File,"war3map.imp":wi.imp.File,"war3map.mmp":wi.mmp.File,"war3map.shd":wi.shd.File,"war3mapUnits.doo":wi.unitsdoo.File,"war3map.w3c":wi.w3c.File,"war3map.w3d":wi.w3d.File,"war3map.w3e":wi.w3e.File,"war3map.w3f":wi.w3f.File,"war3map.w3i":wi.w3i.File,"war3map.w3o":wi.w3o.File,"war3map.w3r":wi.w3r.File,"war3map.w3s":wi.w3s.File,"war3map.w3u":wi.w3u.File,"war3map.wct":wi.wct.File,"war3map.wpm":wi.wpm.File,"war3map.wtg":wi.wtg.File,"war3map.wts":wi.wts.File};class Bg extends s.a.Component{constructor(e){super(e),this.onDownload=(()=>{P(new Blob([this.binary],{type:"application/octet-stream"}),this.getName())});const{id:t,data:i}=this.props,r={panel:"hex"},n=i&&i.archive&&i.archive.loadBinary(t);if(n){if(this.binary=n.data,this.flags=n.flags,1&this.flags){const e=(new Y.a.TextDecoder).decode(this.binary),t=e.split(/\r\n?|\n/);if(this.isJass())this.jass=t,r.panel="jass";else{this.text=[];const i=2048;t.forEach(e=>{if(e.length>i)for(let t=0;t<e.length;t+=i)this.text.push(e.substr(t,i));else this.text.push(e)}),this.textHeights=this.text.map(()=>16),r.panel="text";try{this.slk=new et(e),r.panel="slk"}catch(s){}}}if(6&this.flags){const e=new Blob([this.binary],{type:4&this.flags?"audio/mpeg":"audio/wav"});this.audio=URL.createObjectURL(e),r.panel="audio"}8&this.flags&&(r.panel="model"),this.image=i.archive.loadImage(t),this.image&&(r.panel="image");const e=this.getName();if(Fg[e])try{this.data=new Fg[e](this.binary.buffer),r.panel="data"}catch(s){console.error(e,"Unable to decoding map content. ",s)}}this.state=r}makePanel(e,t){return s.a.createElement("li",{key:e,className:_()("tab-button",{active:this.state.panel===e}),onClick:()=>this.setState({panel:e})},t)}renderPane(){const{panel:e}=this.state;switch(e){case"hex":return s.a.createElement(yg,{data:this.binary});case"slk":return s.a.createElement(vg,{data:this.slk});case"text":return s.a.createElement(Lg,{lines:this.text,heights:this.textHeights});case"jass":return s.a.createElement(Mg,{lines:this.jass});case"audio":return s.a.createElement(Pg,{audio:this.audio});case"model":return s.a.createElement(KE,{id:this.props.id});case"image":return s.a.createElement(xg,{data:this.binary,image:this.image});case"data":return console.log(this.data),s.a.createElement(_g.a,{expandLevel:1,data:this.data});default:return null}}getName(){let{data:e,id:t}=this.props;if(this.name)return this.name;const i=e.file("listfile.txt");if(i){const e=i.split("\n").filter(e=>e.length>0).find(e=>{const i=e.match(/^Unknown\\([0-9A-F]{16})/);return F(i?M(i[1]):O(e),t)});if(null!=e){const t=e.split(/[\\/]/);return this.name=t[t.length-1]}}return this.name=D(t)}isJass(){const e=this.getName();if(e&&e.match(/\.j$/i))return!0;const t=this.props.id;return F(O("war3map.j"),t)||F(O("Scripts/war3map.j"),t)}render(){return this.binary?s.a.createElement("div",{className:"FileData"},s.a.createElement(he,{title:this.getName()}),s.a.createElement("ul",{className:"tab-line"},s.a.createElement("li",{key:"dl",className:"tab-xbutton",onClick:this.onDownload},"Download ",s.a.createElement("span",{glyph:"download-alt"})),this.makePanel("hex","Hex"),null!=this.text&&this.makePanel("text","Text"),null!=this.jass&&this.makePanel("jass","JASS"),null!=this.slk&&this.makePanel("slk","SLK"),null!=this.audio&&this.makePanel("audio","Audio"),0!==(8&this.flags)&&this.makePanel("model","Model"),null!=this.image&&this.makePanel("image","Image"),null!=this.data&&this.makePanel("data","Data")),s.a.createElement("div",{className:_()("tab-pane",this.state.panel)},this.renderPane())):null}}const Vg=e=>{let{type:t,value:i,comment:r}=e;return r=r&&r.replace("\x1b","\n"),null==i||""==i?s.a.createElement(t,{title:r},"\xa0"):s.a.createElement(t,{title:r},i.toString())};class kg extends s.a.PureComponent{render(){const{data:e}=this.props,t=[...Array(e.cols)].map((e,t)=>t),i=[...e.rows].map((e,t)=>t);return s.a.createElement("div",{className:"FileSlk"},s.a.createElement("table",null,e.rows.length>=1&&s.a.createElement("thead",null,s.a.createElement("tr",null,t.map(t=>s.a.createElement(Vg,{type:"th",key:t,value:e.rows[0][t]||"",comment:e.comments&&e.comments[0]&&e.comments[0][t]})))),s.a.createElement("tbody",null,i.filter(e=>e>0).map(i=>s.a.createElement("tr",{key:i},t.map(t=>s.a.createElement(Vg,{type:"td",key:t,value:e.rows[i]?e.rows[i][t]:void 0,comment:e.comments&&e.comments[i]&&e.comments[i][t]})))))))}}const Gg=e=>{let{image:t,name:i}=e;return s.a.createElement("div",{className:"FileData"},s.a.createElement("ul",{className:"tab-line"},s.a.createElement("li",{className:"tab-button active"},"Image")),s.a.createElement("div",{className:"tab-pane image"},s.a.createElement(xg,{image:t,name:i})))};const jg=w({data:e=>{let{data:t}=e;return t}},class extends s.a.Component{constructor(e){super(e),this.onDownload=(()=>{P(new Blob([this.props.data],{type:"application/octet-stream"}),this.props.name)});const{name:t,data:i}=e,r={panel:"hex"},n=t.substr(t.lastIndexOf(".")).toLowerCase();if(".mdx"===n)this.model=!0,r.panel="model";else if(".j"===n){const e=(new Y.a.TextDecoder).decode(i);this.jass=e.split(/\r\n?|\n/),r.panel="jass"}else if(".txt"===n||".slk"===n||".fdf"==n||".toc"==n){const e=(new Y.a.TextDecoder).decode(i),t=e.split(/\r\n?|\n/);this.text=[];const a=2048;if(t.forEach(e=>{if(e.length>a)for(let t=0;t<e.length;t+=a)this.text.push(e.substr(t,a));else this.text.push(e)}),this.textHeights=this.text.map(()=>16),r.panel="text",".slk"===n)try{this.slk=new et(e),r.panel="slk"}catch(s){}}this.state=r}makePanel(e,t){return s.a.createElement("li",{key:e,className:_()("tab-button",{active:this.state.panel===e}),onClick:()=>this.setState({panel:e})},t)}renderPane(){const{panel:e}=this.state;switch(e){case"hex":return s.a.createElement(yg,{data:this.props.data});case"text":return s.a.createElement(Lg,{lines:this.text,heights:this.textHeights});case"jass":return s.a.createElement(Mg,{lines:this.jass});case"model":return s.a.createElement(KE,{id:this.props.id});case"slk":return s.a.createElement(kg,{data:this.slk});default:return null}}render(){return s.a.createElement("div",{className:"FileData"},s.a.createElement(he,{title:this.props.name}),s.a.createElement("ul",{className:"tab-line"},s.a.createElement("li",{key:"dl",className:"tab-xbutton",onClick:this.onDownload},"Download ",s.a.createElement("span",{glyph:"download-alt"})),this.makePanel("hex","Hex"),null!=this.text&&this.makePanel("text","Text"),null!=this.jass&&this.makePanel("jass","JASS"),null!=this.slk&&this.makePanel("slk","SLK"),!!this.model&&this.makePanel("model","Model")),s.a.createElement("div",{className:_()("tab-pane",this.state.panel)},this.renderPane()))}},void 0,void 0);const Yg=w({listFile:e=>{let{data:t}=e;return t.listFile()}},class extends s.a.PureComponent{constructor(e){super(e);const{id:t,data:i,listFile:r}=this.props,n=r.split("\n").filter(e=>e.length>0);if(this.name=n.find(e=>{const i=e.match(/^Unknown\\([0-9A-F]{16})/);return F(i?M(i[1]):O(e,!0),t)}),null!=this.name){this.name=this.name.split(/[\\/]/).pop();const e=this.name.substr(this.name.lastIndexOf(".")).toLowerCase();[".blp",".dds",".gif",".jpg",".jpeg",".png",".tga"].indexOf(e)>=0?this.image=i.image(t):this.data=fetch(i.cache.binary(t)).then(e=>e.ok?e.arrayBuffer():Promise.reject()).then(e=>new Uint8Array(e))}}render(){const{data:e,id:t}=this.props;return this.image?s.a.createElement(Gg,{image:this.image,name:this.name}):this.data?s.a.createElement(jg,{data:this.data,name:this.name,id:t}):s.a.createElement("span",{className:"message"},"File not found")}},void 0,void 0);i(429);class Hg extends s.a.Component{render(){const e=this.context,t=this.props.match.params.id,i=null==t?null:M(t);return s.a.createElement(dg.Provider,{value:i},s.a.createElement("div",{className:"FileView"},s.a.createElement(Oe.a,{cols:!0},s.a.createElement(Ag,{size:300,minSize:100,resizable:!0,className:"LeftPanel",data:e,id:i}),s.a.createElement(Oe.a,{className:"RightPanel",minSize:100},null==i?s.a.createElement("span",{className:"message"},"Select a file to view its contents"):e.hasFile(i)?s.a.createElement(Bg,{data:e,id:i,key:t}):e.archive?s.a.createElement("span",{className:"message"},"File not found"):s.a.createElement(Yg,{data:e,id:i,key:t})))))}}Hg.contextType=oe.DataContext;const Wg=()=>s.a.createElement(l.d,{path:"/:build/files/:id?",component:Hg});class Kg extends s.a.Component{render(){const e=this.context;let t=e.file("info.json");t&&(t=JSON.parse(t));let i=null;return e.archive&&((i=e.archive.loadImage("war3mapPreview.tga"))||(i=e.archive.loadImage("war3mapMap.blp"))),s.a.createElement("div",{className:"HomePage"},s.a.createElement("h3",null,e.core?"Warcraft III Patch ":"",e.name),null!=t&&s.a.createElement("ul",{className:"mapInfo"},s.a.createElement("li",null,s.a.createElement("b",null,"Name:")," ",s.a.createElement("span",null,Xe(t.name))),s.a.createElement("li",null,s.a.createElement("b",null,"Suggested Players:")," ",s.a.createElement("span",null,Xe(t.players))),s.a.createElement("li",null,s.a.createElement("b",null,"Description:")," ",s.a.createElement("span",null,Xe(t.description))),s.a.createElement("li",null,s.a.createElement("b",null,"Author:")," ",s.a.createElement("span",null,Xe(t.author))),s.a.createElement("li",null,null!=i&&s.a.createElement("img",{src:i,alt:"Map preview"}))))}}Kg.contextType=oe.DataContext;var zg=i(442);i(430);const qg=/([a-z_]\w*)|(0x[0-9a-z]+|\d+\.?|\d*\.\d+)|('[^'\\]*(?:\\.[^'\\]*)*')|("[^"\\]*(?:\\.[^"\\]*)*")|(\/\/.*)/gi,Xg=16,Jg=e=>{let{options:t,setOption:i,...r}=e;const n=e=>s.a.createElement("input",{type:"checkbox",checked:!!t[e],onChange:t=>i(e,t.target.checked?1:0)}),a=e=>s.a.createElement("input",{type:"number",min:1,max:10,step:1,value:t[e],onChange:t=>((e,t,i)=>{const r=parseInt(i.target.value,10);isNaN(r)||e(t,r)})(i,e,t)});return s.a.createElement(ze.a,Object.assign({id:"jass-options"},r),s.a.createElement("form",null,s.a.createElement("label",null,n("indentFlag")," Auto Indent"),!!t.indentFlag&&s.a.createElement("label",{className:"indent"},"Amount ",a("indent")),s.a.createElement("label",null,n("restoreInt")," Restore numbers"),s.a.createElement("label",null,n("restoreId")," Restore object IDs"),s.a.createElement("label",null,n("insertLines")," Insert blank lines"),s.a.createElement("label",null,n("restoreStrings")," Restore trigger strings"),s.a.createElement("label",null,n("renameFunctionsFlag")," Rename functions"),!!t.renameFunctionsFlag&&s.a.createElement("label",{className:"indent"},"Max length ",a("renameFunctions")),s.a.createElement("label",null,n("renameGlobalsFlag")," Rename globals"),!!t.renameGlobalsFlag&&s.a.createElement("label",{className:"indent"},"Max length ",a("renameGlobals")),s.a.createElement("label",null,n("renameLocalsFlag")," Rename locals"),!!t.renameLocalsFlag&&s.a.createElement("label",{className:"indent"},"Max length ",a("renameLocals")),s.a.createElement("label",null,n("inlineFunctions")," Inline one-line functions"),s.a.createElement("label",null,n("getObjectName")," Restore getObjectName strings")))};const Qg=w({objects:e=>{let{data:t}=e;return t.objects()}},class extends s.a.Component{constructor(){super(...arguments),this.state={searchResults:null,searchText:""},this.findPrev=(()=>this.search(this.state.searchText,-1)),this.findNext=(()=>this.search(this.state.searchText,1)),this.onSearchChange=(e=>this.search(e.target.value,0)),this.onSearchKeyDown=(e=>{switch(e.which){case v.a.codes.enter:this.search(this.state.searchText,1),e.preventDefault();break;case v.a.codes.esc:this.search("",0),e.preventDefault()}}),this.onKeyDown=(e=>{const{searchText:t}=this.state;switch(e.which){case v.a.codes.f3:e.shiftKey?this.search(t,-1):this.search(t,1),this._search&&(this._search.focus(),this._search.select()),e.preventDefault();break;case v.a.codes.f:e.ctrlKey&&this._search&&(this._search.focus(),this._search.select(),e.preventDefault())}}),this.tokenFunc=((e,t)=>{let[i,r,n,a,o,l]=t;const{data:c,keywords:d,objects:u}=this.props;if(r){const t=d[r];return t?s.a.createElement("span",{className:t},e):e}if(n)return s.a.createElement("span",{className:"jnum"},e);if(a){const t=a.match(/^'(.*)'$/),i=t&&u.objects.find(e=>e.id===t[1]),r=s.a.createElement("span",{className:"jchr"},e);return i?s.a.createElement(h.Link,{to:"/".concat(c.id,"/").concat(i.type,"/").concat(i.id),title:i.name},r):r}return o?s.a.createElement("span",{className:"jstr"},e):l?s.a.createElement("span",{className:"jcom"},e):e}),this.onDownload=(()=>{const e=this.props.lines.join("\n").replace("\n","\r\n"),t=(new Y.a.TextEncoder).encode(e);P(new Blob([t],{type:"text/plain"}),"war3map.j")}),this.setScroll=(e=>{this._list?this._list.setScroll(e):this._scrollTop=e}),this.setList=(e=>{this._list=e,null!=this._scrollTop&&(this._list.setScroll(this._scrollTop),delete this._scrollTop)})}search(e,t){this.setState({searchText:e,searchResults:this._list?this._list.search(e,t):null})}render(){const{lines:e,heights:t,options:i,setOption:r}=this.props,{searchResults:n,searchText:a}=this.state,o=n&&n.count;return s.a.createElement("div",{className:"JassView",onKeyDown:this.onKeyDown},s.a.createElement(c.a,{fluid:"true",className:"JassHeader"},s.a.createElement(zg.a,null,s.a.createElement(ue.a,{"event-key":"source",onClick:this.onDownload},"Download ",s.a.createElement("span",{glyph:"download-alt"})),s.a.createElement(I,{trigger:"click",rootClose:!0,placement:"bottom",overlay:s.a.createElement(Jg,{options:i,setOption:r})},s.a.createElement(ue.a,{"event-key":"format"},"Formatting"))),s.a.createElement(c.a.Form,{pullLeft:!0},s.a.createElement(Fe.a,null,s.a.createElement("div",{className:"form-control"},s.a.createElement("input",{type:"text",placeholder:"Search",ref:e=>this._search=e,value:a,onChange:this.onSearchChange,onKeyDown:this.onSearchKeyDown}),!!n&&s.a.createElement("span",{className:"search-tag"},n.pos+1+"/"+n.count),s.a.createElement("button",{disabled:!o,onClick:this.findPrev,title:"Previous"},s.a.createElement("span",{glyph:"chevron-up"})),s.a.createElement("button",{disabled:!o,onClick:this.findNext,title:"Next"},s.a.createElement("span",{glyph:"chevron-down"})))))),s.a.createElement(x,{onRef:e=>this._saver=e,callback:this.setScroll}),s.a.createElement("div",{className:"JassSource",ref:e=>this._node=e},s.a.createElement(Me.a,null,i=>{let{width:r,height:n}=i;return s.a.createElement(Ig,{className:"JassLines",ref:this.setList,width:r,height:n,lines:e,heights:t,onScroll:this.onScroll,highlightExpr:qg,highlightFunc:this.tokenFunc})})))}},void 0,void 0);class $g extends s.a.PureComponent{render(){const{options:e,setOption:t,meta:i}=this.props,r=this.context,{indentFlag:n,renameGlobalsFlag:a,renameFunctionsFlag:o,renameLocalsFlag:l,...h}=e;n||(h.indent=0),a||(h.renameGlobals=0),o||(h.renameFunctions=0),l||(h.renameLocals=0);const c=r.jass(h),d=c.map(e=>e.split("\n").length*Xg),u=Cg(i);return s.a.createElement(Qg,{keywords:u,data:r,lines:c,heights:d,options:e,setOption:t})}}$g.contextType=oe.DataContext;class Zg extends s.a.Component{constructor(){super(...arguments),this.setOption=((e,t)=>{const i={...this.options};i[e]=t,this.context.update("jassFormatting",i)})}get options(){return this.context.jassFormatting||Zg.defaultState}render(){return s.a.createElement($g,{meta:this.props.meta,options:this.options,setOption:this.setOption})}}Zg.defaultState={indentFlag:!0,indent:2,restoreInt:1,restoreId:1,insertLines:1,restoreStrings:1,renameGlobalsFlag:!0,renameGlobals:5,renameFunctionsFlag:!0,renameFunctions:5,renameLocalsFlag:!0,renameLocals:5,inlineFunctions:1,getObjectName:1},Zg.contextType=ce.Context;const eA=w({meta:(e,t)=>t.meta()},Zg,void 0,void 0);eA.contextType=oe.Context;var tA=eA;const iA={i:"Permanent",n:"Campaign",o:"Miscellaneous",m:"Purchasable",l:"Artifact",k:"PowerUp",j:"Charged"};function rA(e,t){const i=[];function r(e){let{items:r}=e;const n=[];r.forEach(e=>{let{id:i,chance:r}=e;return function e(i,r){const s=t.unitsData.find(e=>e.id===i);if(s&&"item"===s.type)n.push({item:s,chance:r});else{if("\0\0\0\0"===i)return;if("Q"===i[3]){const n=i.charCodeAt(1)+256*i.charCodeAt(2),s=i.charCodeAt(0),a=t.w3i.randomUnitTables.find(e=>e.id===n);a&&a.units.forEach(t=>{let{chance:i,ids:n}=t;n[s]&&e(n[s],r*i/100)})}else if("Y"===i[0]&&"I"===i[2]){const e=iA[i[1]],s="/"===i[3]?-1:parseInt(i[3]),a=t.unitsData.filter(t=>"item"===t.type&&!(s>=0&&parseInt(t.data.level)!==s)&&(!e||t.data.class===e));n.push({name:"Random ".concat(s>=0?"Level "+s:"Any Level"," ").concat(e?"PowerUp"===e?"Power Up Item":e+" Item":"Item"),chance:r,items:a})}}}(i,r)}),i.push(n)}if(e.droppedItemTable>=0){const i=t.w3i.randomItemTables.find(t=>t.id===e.droppedItemTable);i&&i.sets.forEach(e=>r(e))}return e.droppedItemSets.forEach(e=>r(e)),i}const nA=e=>{let{item:t}=e;const[i,r]=s.a.useState(!1),n=s.a.useContext(oe.DataContext);return s.a.createElement("li",null,s.a.createElement(Qe,{id:t.item&&t.item.id},t.item?s.a.createElement("a",{href:"/".concat(n.id,"/").concat(t.item.type,"/").concat(t.item.id),target:"_blank"},s.a.createElement(we,{object:t.item}),t.chance.toFixed(0),"% - ",t.item.name):s.a.createElement("span",null,s.a.createElement(we,{object:{icon:O("ReplaceableTextures\\WorldEditUI\\Editor-Random-Item.blp")}}),t.chance.toFixed(0),"% - ",t.name,null!=t.items&&t.items.length>0&&s.a.createElement("span",{className:"listToggle",onClick:()=>r(!i)},i?"(hide list)":"(".concat(t.items.length," items)")))),null!=t.items&&i&&s.a.createElement("ul",{className:"ItemDrop"},t.items.map(e=>s.a.createElement("li",{key:e.id},s.a.createElement(Qe,{id:e.id},s.a.createElement("a",{href:"/".concat(n.id,"/").concat(e.type,"/").concat(e.id),target:"_blank"},s.a.createElement(we,{object:e})," ",e.name))))))};class sA extends s.a.Component{constructor(){super(...arguments),this.coords={x:50,y:50},this.onMouseDown=(e=>{this.pressed={x:e.clientX,y:e.clientY},document.addEventListener("mousemove",this.onMouseMove,!0),document.addEventListener("mouseup",this.onMouseUp,!0)}),this.onMouseMove=(e=>{const t=e.clientX-this.pressed.x,i=e.clientY-this.pressed.y;this.coords.x+=t,this.coords.y+=i,this.element&&(this.element.style.left=this.coords.x+"px",this.element.style.top=this.coords.y+"px"),this.pressed={x:e.clientX,y:e.clientY}}),this.onMouseUp=(()=>{delete this.pressed,this.unregisterEvents()})}unregisterEvents(){document.removeEventListener("mousemove",this.onMouseMove,!0),document.removeEventListener("mouseup",this.onMouseUp,!0)}componentWillUnmount(){this.unregisterEvents()}render(){const{gameData:e,units:t,viewer:i,deselect:r}=this.props,n=this.context,a={left:this.coords.x,top:this.coords.y};t.length||(a.display="none");const o=e.getSection("Misc"),l=(h=o.get("grantnormalxp").split(",").map(e=>parseInt(e)),c=parseInt(o.get("grantnormalxpformulaa")),d=parseInt(o.get("grantnormalxpformulab")),u=parseInt(o.get("grantnormalxpformulac")),function e(t){return t<=0?0:t<=h.length?h[t-1]:c*e(t-1)+d*t+u});var h,c,d,u;let m=0;const f=s.a.createElement("ul",{className:"Body"},t.map(e=>{let{unit:t}=e;const r=i.unitsData.find(e=>e.id===t.id);if(!r)return null;let a=null;const o=rA(t,i);if(o){const e=e=>s.a.createElement("ul",{className:"ItemDrop"},e.map(e=>s.a.createElement(nA,{key:e.name,item:e})));o.length>1?a=s.a.createElement("ul",{className:"ItemDrops"},o.map((t,i)=>s.a.createElement("li",null,s.a.createElement("span",null,"Dropped Item Set ",i+1," (Total Chance: ",t.reduce((e,t)=>{let{chance:i}=t;return e+i},0).toFixed(0),"%)"),e(t)))):o.length&&(a=e(o[0]))}let h=null;const c=parseInt(r.data.level);if(!isNaN(c)){const e=l(c);m+=e,h=s.a.createElement("span",null,"\xa0(",e," XP)")}return s.a.createElement("li",{key:t.id},s.a.createElement(Qe,{id:t.id},s.a.createElement("a",{href:"/".concat(n.id,"/").concat(r.type,"/").concat(r.id),target:"_blank"},s.a.createElement(we,{object:r}),s.a.createElement("span",{className:"name"},r.name)," ",h)),a)}));return s.a.createElement("div",{className:"Selection",style:a,ref:e=>this.element=e},s.a.createElement("div",{className:"Heading",onMouseDown:this.onMouseDown},"Selection",m>0?" (".concat(m," Total XP)"):""),f)}}sA.contextType=oe.DataContext;const aA=w({gameData:e=>{let{gameData:t}=e;return t}},sA);class oA extends s.a.Component{constructor(e,t){super(e,t),this.state={notifications:[],selection:[]},this.yaw=0,this.pitch=-Math.PI/4,this.distance=2e3,this.center=ar.vec3.create(),this.minDistance=500,this.maxDistance=2e4,this.onContextMenu=(e=>{e.preventDefault()}),this.onMouseDown=(e=>{document.addEventListener("mousemove",this.onMouseMove,!0),document.addEventListener("mouseup",this.onMouseUp,!0),this.dragStart=this.dragPos={x:e.clientX,y:e.clientY},this.dragButton=e.ctrlKey?2:e.shiftKey?1:0,e.preventDefault()}),this.onMouseMove=(e=>{if(this.dragPos&&this.canvas){const t=e.clientX-this.dragPos.x,i=e.clientY-this.dragPos.y,r=(this.canvas.width+this.canvas.height)/2;if(2===this.dragButton){for(this.yaw+=2*t*Math.PI/r,this.pitch+=2*i*Math.PI/r;this.yaw>Math.PI;)this.yaw-=2*Math.PI;for(;this.yaw<-Math.PI;)this.yaw+=2*Math.PI;this.pitch=Math.min(this.pitch,0),this.pitch=Math.max(this.pitch,-Math.PI/2+.05)}else if(1===this.dragButton){let e=this.canvas.getBoundingClientRect(),t=Math.min(this.dragStart.x,this.dragPos.x)-e.left,i=Math.min(this.dragStart.y,this.dragPos.y)-e.top,r=Math.max(this.dragStart.x,this.dragPos.x)-e.left,n=Math.max(this.dragStart.y,this.dragPos.y)-e.top;this.viewer&&(this.dragSelection=this.viewer.selectUnits(t,i,r,n)),this.selrect&&(this.selrect.style.display="block",this.selrect.style.left="".concat(t,"px"),this.selrect.style.top="".concat(i,"px"),this.selrect.style.width="".concat(r-t,"px"),this.selrect.style.height="".concat(n-i,"px"))}else if(0===this.dragButton){const e=ar.vec3.fromValues(-Math.cos(this.yaw),Math.sin(this.yaw),0),n=ar.vec3.fromValues(e[1],-e[0],0),s=this.distance/r;ar.vec3.scaleAndAdd(this.center,this.center,e,t*s),ar.vec3.scaleAndAdd(this.center,this.center,n,i*s)}this.dragPos={x:e.clientX,y:e.clientY}}e.preventDefault()}),this.onMouseUp=(e=>{if(this.dragPos&&this.viewer){if(this.dragButton<2&&Math.abs(this.dragPos.x-this.dragStart.x)<5&&Math.abs(this.dragPos.y-this.dragStart.y)<5){let t=this.canvas.getBoundingClientRect(),i=this.viewer.selectUnit(e.clientX-t.left,e.clientY-t.top,this.dragButton);this.setState({selection:i})}delete this.dragPos}this.dragSelection&&(this.setState({selection:this.dragSelection}),delete this.dragSelection),this.selrect&&(this.selrect.style.display="none"),this.removeEvents(),e.preventDefault()}),this.onMouseWheel=(e=>{e.deltaY>0?this.distance=Math.min(1.2*this.distance,this.maxDistance):this.distance=Math.max(this.distance/1.2,this.minDistance)}),this.animate=(e=>{if(this.prevTs=e,this.frame=requestAnimationFrame(this.animate),this.scene.camera.viewport([0,0,this.canvas.width,this.canvas.height]),this.viewer.mapSize){const e=this.viewer.mapSize,t=this.viewer.centerOffset;if(this.center[0]=Math.max(t[0],Math.min(this.center[0],128*e[0]+t[0])),this.center[1]=Math.max(t[1],Math.min(this.center[1],128*e[1]+t[1])),!this.rOffsets){this.rOffsets=[];for(let e=0;e<32;++e){const e=Math.random()*Math.PI*2,t=Math.random();this.rOffsets.push([Math.cos(e)*t,Math.sin(e)*t])}}this.center[2]=0,this.rOffsets.forEach(e=>{let[t,i]=e;this.center[2]+=this.viewer.heightAt(this.center[0]+t*this.distance/4,this.center[1]+i*this.distance/4)}),this.center[2]/=this.rOffsets.length}this.scene.camera.perspective(Math.PI/4,this.canvas.width/this.canvas.height,this.minDistance/4,2*this.maxDistance),this.scene.camera.setRotationAroundAngles(this.yaw,this.pitch,this.center,this.distance),this.viewer.updateAndRender()}),this.deselect=(()=>{this.viewer&&this.viewer.deselect(),this.setState({selection:[]})});const i="Units\\MiscGame.txt";t.hasFile(i)?this.gameData=Promise.resolve(t.file(i)):this.gameData=fetch(t.cache.binary(i)).then(e=>e.text()),this.gameData=this.gameData.then(e=>new BE.parsers.ini.IniFile(e))}componentWillUnmount(){this.frame&&(cancelAnimationFrame(this.frame),delete this.frame),this.removeEvents()}removeEvents(){document.removeEventListener("mousemove",this.onMouseMove,!0),document.removeEventListener("mouseup",this.onMouseUp,!0)}componentWillUnmount(){this.frame&&(cancelAnimationFrame(this.frame),delete this.frame),this.unmounted=!0}addNotification(e,t,i){this.setState(r=>{let{notifications:n}=r,s={text:e,type:t};return n=[...n,s],i>1e3?setTimeout(()=>{this.unmounted||this.setState(e=>{let{notifications:t}=e,i=t.indexOf(s);return i>=0&&(t=t.slice(),s={...s,expiring:!0},t[i]=s),{notifications:t}})},i-1e3):s.expiring=!0,setTimeout(()=>{this.unmounted||this.setState(e=>{let{notifications:t}=e,i=t.indexOf(s);return i>=0&&(t=t.slice()).splice(i,1),{notifications:t}})},i),{notifications:n}})}componentDidMount(){if(!this.canvas)return;const e=this.canvas,t=this.context;this.viewer=new BE.viewer.handlers.w3x.MapViewer(e,(e,i)=>{const r="string"===typeof e?e.substr(e.lastIndexOf(".")).toLowerCase():".mdx";if([".blp",".dds",".gif",".jpg",".jpeg",".png",".tga"].indexOf(r)>=0)return[t.image(e,i),".png",!0];{const n=t.binary(e);return n?[n.data.buffer,r,!1]:[t.cache.binary(e,i),r,!0]}},t),this.viewer.gl.clearColor(0,0,0,1),this.viewer.on("error",(e,t,i)=>{"FailedToFetch"===t&&this.addNotification("Failed to load ".concat(e.path),"error",5e3)}),this.viewer.on("idle",()=>{this.addNotification("Loading complete!","success",5e3)}),this.scene=this.viewer.scene,this.viewer.loadMap(t),this.frame=requestAnimationFrame(this.animate)}render(){const{notifications:e,selection:t}=this.state;return s.a.createElement("div",{className:"ModelPage"},s.a.createElement("div",{className:"FileModel"},s.a.createElement(Me.a,null,e=>{let{width:t,height:i}=e;return s.a.createElement("canvas",{onMouseDown:this.onMouseDown,onContextMenu:this.onContextMenu,onWheel:this.onMouseWheel,ref:e=>this.canvas=e,width:Math.max(t,100),height:Math.max(i,100)})}),s.a.createElement("div",{className:"selRect",ref:e=>this.selrect=e}),s.a.createElement("ul",{className:"log"},e.map((e,t)=>{let{text:i,type:r,expiring:n}=e;return s.a.createElement("li",{key:t,className:r+(n?" expiring":"")},i)})),s.a.createElement("div",{className:"credits"},"Model viewer by ",s.a.createElement("a",{href:"https://github.com/flowtsohg/mdx-m3-viewer",target:"_blank"},"flowtsohg@github")),s.a.createElement(aA,{gameData:this.gameData,units:t,viewer:this.viewer,deselect:this.deselect})))}}oA.contextType=oe.DataContext;var lA=()=>s.a.createElement(oe.DataContext.Consumer,null,e=>{let t=s.a.createElement(l.g,null,s.a.createElement(l.d,{path:"/:build/(".concat(Object.keys(fe).join("|"),")"),component:cg}),s.a.createElement(l.d,{path:"/:build/script",component:tA}),s.a.createElement(l.d,{path:"/:build/map",component:oA}),s.a.createElement(l.d,{path:"/:build/files",component:Wg}),s.a.createElement(l.d,{path:"/:build",exact:!0,component:Kg}));return e.isMap?s.a.createElement(he,{title:e.name},t):t}),hA=(i(431),i(241));const cA=e=>{let{id:t,name:i,desc:r}=e;return i=i&&i.replace(/\|(c[0-9a-fA-F]{6,8}|r)/g,""),(r=r&&r.replace(/\|(c[0-9a-fA-F]{6,8}|r)/g,""))?s.a.createElement(h.Link,{to:"/".concat(t)},i," ",s.a.createElement("span",{className:"desc"},r)):s.a.createElement(h.Link,{to:"/".concat(t)},i)};class dA extends s.a.Component{constructor(){super(...arguments),this.state={collapsed:!0},this.toggle=(()=>{this.setState(e=>{let{collapsed:t}=e;return{collapsed:!t}})})}render(){const{level:e=0,name:t,items:i,paths:r,descs:n,Comp:a="div"}=this.props,{collapsed:o}=this.state,l=e?"h4":"h3",h={},c=[];return Object.keys(i).forEach(t=>{let n=r[t];n&&0===n.indexOf("maps/")&&((n=n.substr(5).split("~")).length>e+1?(h[n[e]]=h[n[e]]||{},h[n[e]][t]=i[t]):c.push(t))}),c.sort((e,t)=>i[e].localeCompare(i[t])),s.a.createElement(a,{className:o?"collapsed map-list":"map-list"},s.a.createElement(l,{onClick:this.toggle},s.a.createElement("span",{glyph:o?"chevron-right":"chevron-down"})," ",t),s.a.createElement("ul",null,Object.keys(h).sort().map(t=>s.a.createElement(dA,{Comp:"li",key:t,level:e+1,name:t,items:h[t],paths:r,descs:n})),c.map(e=>s.a.createElement("li",{key:e},s.a.createElement(cA,{id:e,name:i[e],desc:r[e].match(/campaign/i)?n[e]:null})))))}}class uA extends s.a.Component{constructor(){super(...arguments),this.state={message:null,messageType:"info"},this.parseFile=(e=>{const t=e.target.files;t.length>0&&this.context.loadMap(t[0])})}setNotification(e,t){this.setState({message:e,messageType:t})}componentDidMount(){$(this)}componentWillUnmount(){$(null)}render(){const e=this.context;return e.custom=e.custom||{},s.a.createElement("div",{className:"HomePage"},null!=this.state.message&&s.a.createElement("div",{bsStyle:this.state.messageType},this.state.message),s.a.createElement("h3",null,"Warcraft III Data"),s.a.createElement("ul",null,Object.entries(e.versions).sort((e,t)=>parseInt(t[0],10)-parseInt(e[0],10)).map(e=>{let[t,i]=e;return s.a.createElement("li",{key:t},s.a.createElement(h.Link,{to:"/".concat(t)},"Patch ",i))})),s.a.createElement(oe.MapsContext.Consumer,null,t=>s.a.createElement(dA,{name:"Standard Maps",items:t,paths:e.custom||{},descs:e.customDesc||{}})),s.a.createElement("h3",null,"Custom Maps"),s.a.createElement(oe.MapsContext.Consumer,null,t=>s.a.createElement("ul",null,Object.entries(t).filter(t=>{let[i]=t;return!e.custom[i]||!e.custom[i].match(/^maps\//)}).sort((e,t)=>e[1].localeCompare(e[2])).map(t=>{let[i,r]=t,n=null;return e.isLocal(i)&&(n=s.a.createElement("span",{className:"unload",onClick:()=>e.unloadMap(i)},"(unload)")),s.a.createElement("li",{key:i},s.a.createElement(h.Link,{to:"/".concat(i)},r),n)}))),s.a.createElement("form",null,s.a.createElement(Fe.a,{controlId:"loadFile"},s.a.createElement(hA.a,{className:"linkLike"},"Load a custom Warcraft III map"),s.a.createElement(De.a,{style:{display:"none"},type:"file",onChange:this.parseFile,accept:".w3x,.w3m,.mpq",multiple:!1,value:""}),s.a.createElement("div",null,s.a.createElement("p",null,"Or simply drop the map file onto the page"),s.a.createElement("p",null,"The map will be parsed in your browser, and the data will be stored in browser cache. Nothing is sent to the server.")))))}}uA.contextType=oe.Context;const mA=()=>s.a.createElement("div",{className:"Spinner"}),fA=w({data:(e,t)=>{let{id:i}=e;return t.data(i)}},e=>{let{data:t,children:i}=e;return s.a.createElement(oe.DataContext.Provider,{value:t},i)},void 0,()=>s.a.createElement(l.c,{to:"/"}));fA.contextType=oe.Context;class pA extends s.a.PureComponent{constructor(){super(...arguments),this.state={loading:0,dropping:0},this.onLoading=(e=>{this.setState({loading:e})}),this.onDrop=(e=>{const t=function(e){if(e.dataTransfer.items)for(let t=0;t<e.dataTransfer.items.length;++t)if("file"===e.dataTransfer.items[t].kind)return e.dataTransfer.items[t].getAsFile();if(e.dataTransfer.files.length)return e.dataTransfer.files[0]}(e);t&&(e.preventDefault(),this.context.loadMap(t)),this.setState({dropping:0})}),this.onDragEnter=(e=>{e.preventDefault(),this.setDropping(1)}),this.onDragOver=(e=>{(function(e){if(e.dataTransfer.items)for(let t=0;t<e.dataTransfer.items.length;++t)if("file"===e.dataTransfer.items[t].kind)return!0;return!!e.dataTransfer.files.length})(e)&&e.preventDefault()}),this.onDragLeave=(e=>{this.setDropping(-1)})}get build(){return this.props.match.params.build}componentDidMount(){this.context.subscribe(this.onLoading),document.addEventListener("drop",this.onDrop,!0),document.addEventListener("dragover",this.onDragOver,!0),document.addEventListener("dragenter",this.onDragEnter,!0),document.addEventListener("dragleave",this.onDragLeave,!0)}componentWillUnmount(){this.context.unsubscribe(this.onLoading),document.removeEventListener("drop",this.onDrop,!0),document.removeEventListener("dragover",this.onDragOver,!0),document.removeEventListener("dragenter",this.onDragEnter,!0),document.removeEventListener("dragleave",this.onDragLeave,!0)}setDropping(e){this.setState(t=>{let{dropping:i}=t;return{dropping:Math.max(i+e,0)}})}render(){const e=this.build;return e&&!this.context.hasData(e)?(Z("No data for ".concat(e),"warning"),s.a.createElement(l.c,{to:"/"})):s.a.createElement(s.a.Fragment,null,this.state.dropping>0&&s.a.createElement("div",{className:"DropFrame"}),s.a.createElement(c.a,{className:"app-navbar",fluid:"true"},s.a.createElement(c.a.Brand,null,s.a.createElement(h.Link,{to:"/"},s.a.createElement("span",{className:"AppIcon"})," ",e?s.a.createElement("span",null):s.a.createElement("span",{style:{padding:"5px 10px"}},"WC3 Data"))),!!e&&s.a.createElement(fA,{id:e},s.a.createElement(ge,null))),e?s.a.createElement(fA,{id:e},s.a.createElement(lA,null)):s.a.createElement(uA,null),this.state.loading>0&&s.a.createElement(mA,null))}}pA.contextType=oe.Context;const EA=w({ready:(e,t)=>t.ready},pA,void 0,void 0);EA.contextType=oe.Context;class gA extends s.a.Component{renderStep(e,t){const{progress:i,status:r}=this.props;return i>=e||null!=r&&!1!==r?s.a.createElement("li",{className:"success"},s.a.createElement("span",{glyph:"success"}),t):null!=r?s.a.createElement("li",{className:"failure"},s.a.createElement("span",{glyph:"remove"}),t):i===e-1?s.a.createElement("li",{className:"working"},s.a.createElement("span",{glyph:"success"}),t,"..."):s.a.createElement("li",{className:"pending"},s.a.createElement("span",{glyph:"success"}),t)}render(){const{name:e,status:t,error:i,onHide:r}=this.props;return s.a.createElement(d.a,{dialogClassName:"MapDialog",show:null!=e,onHide:r},s.a.createElement(d.a.Header,{closeButton:!0},s.a.createElement(d.a.Title,null,"Processing ",e)),s.a.createElement(d.a.Body,null,s.a.createElement("ul",{className:"load-progress"},this.renderStep(0,"Downloading meta data"),this.renderStep(1,"Loading objects"),this.renderStep(2,"Writing objects"),this.renderStep(3,"Identifying files"),this.renderStep(4,"Copying files"),this.renderStep(5,"Finishing")),null!=i&&s.a.createElement(h.Link,{bsStyle:"danger"},i)),s.a.createElement(d.a.Footer,null,null==t&&s.a.createElement(u.a,{bsStyle:"warning",onClick:r},"Cancel"),null!=t&&!1!==t&&s.a.createElement(m.LinkContainer,{to:"/".concat(t)},s.a.createElement(u.a,{bsStyle:"info",onClick:r},"Open")),null!=t&&s.a.createElement(u.a,{bsStyle:"info",onClick:r},"Ok")))}}var AA=class extends s.a.Component{constructor(){super(...arguments),this.cache=new oe(this),this.state={mapLoadName:null,mapLoadProgress:-1,mapLoadStatus:null,mapLoadError:null},this.onCloseMapDialog=(()=>{this.cache.abortMap(),this.setState({mapLoadName:null,mapLoadProgress:-1,mapLoadStatus:null,mapLoadError:null})})}navigateTo(e){this.router&&this.router.history.push(e)}beginMapLoad(e){this.setState({mapLoadName:e,mapLoadProgress:-1,mapLoadStatus:null,mapLoadError:null})}onMapProgress(e){this.setState({mapLoadProgress:e})}finishMapLoad(e){this.setState({mapLoadStatus:e}),window.cache=this.cache}failMapLoad(e){this.setState({mapLoadStatus:!1,mapLoadError:e})}render(){const{mapLoadName:e,mapLoadProgress:t,mapLoadStatus:i,mapLoadError:r}=this.state;return s.a.createElement(h.BrowserRouter,{basename:"/",ref:e=>this.router=e},s.a.createElement(he,{title:"WC3 Data"},s.a.createElement(ce,null,s.a.createElement(oe.Context.Provider,{value:this.cache},s.a.createElement(oe.MapsContext.Provider,{value:this.cache.maps},s.a.createElement("div",{className:"App"},s.a.createElement(gA,{name:e,status:i,progress:t,error:r,onHide:this.onCloseMapDialog}),s.a.createElement(l.d,{path:"/:build?",component:EA})))))))}};o.a.render(s.a.createElement(AA,null),document.getElementById("root"))}},[[242,1,2]]]);
//# sourceMappingURL=main.081d426a.chunk.js.map